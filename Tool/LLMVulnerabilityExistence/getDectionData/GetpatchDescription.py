import requests
import os
import time

proxy_url = 'http://127.0.0.1'
proxy_port = '10809'
os.environ['http_proxy'] = f'{proxy_url}:{proxy_port}'
os.environ['https_proxy'] = f'{proxy_url}:{proxy_port}'

current_path = os.path.dirname(os.path.abspath(__file__))

cve_des_path = os.path.join(current_path,"data","cve_des")
cve_id_set = set(os.listdir(cve_des_path))
cve_html_path = os.path.join(current_path,"data","CVE_html")
cve_html_set = set(os.listdir(cve_html_path))

import re
def extract_vulnerability_description(html_content):
    pattern = r'<p data-testid="vuln-description">(.*?)</p>'
    match = re.search(pattern, html_content, re.DOTALL)
    if match:
        return match.group(1).strip()
    else:
        print("没有匹配到漏洞描述")
        return None



def Cvedes(cveid):
    if cveid in cve_id_set:
        with open(os.path.join(cve_des_path, cveid), "r", encoding="utf-8") as f:
            description = f.read().strip()
            return description
    if cveid in cve_html_set:
        with open(os.path.join(cve_html_path, cveid), "r", encoding="utf-8") as f:
            cve_html = f.read()
            print(cveid)
            description = extract_vulnerability_description(cve_html)

        if description:
            return description

    api_key = 'c3ee9e8a-f715-482d-8025-13024dffc1eb'
    base_url = 'https://services.nvd.nist.gov/rest/json/cves/2.0'
    headers = {
        'apiKey': api_key
    }
    params = {
        'cveId': cveid
    }

    max_retries = 5
    delay = 1

    for attempt in range(max_retries):
        response = requests.get(base_url, headers=headers, params=params)

        if response.status_code == 200:
            response_data = response.json()
            vulnerabilities = response_data['vulnerabilities']
            if vulnerabilities:
                cve_id = vulnerabilities[0]['cve']['id']
                description = vulnerabilities[0]['cve']['descriptions'][0]['value']
                return description
            else:
                print("没有找到漏洞信息。")
                return
        elif response.status_code == 503:
            time.sleep(delay)
        else:
            return

def get_cve_des(cveid):
    if cveid in cve_id_set:
        return
    print(cveid)
    description = Cvedes(cveid)
    if description:
        with open(os.path.join(cve_des_path,cveid), "w", encoding="utf-8") as f:
            print(cveid)
            f.write(description)


if __name__ == '__main__':
    # b=Cvedes("CVE-2020-15118")
    # print(b)
    import pandas as pd
    csv_file = r'F:\python_project\all_vul\vul_patch_人工二次寻找.csv'
    data = pd.read_csv(csv_file, encoding="gbk")
    cve_ids = data.iloc[:, 0]
    from concurrent.futures import ThreadPoolExecutor
    with ThreadPoolExecutor(max_workers=100) as executor:
        for x in cve_ids:
            executor.submit(get_cve_des, x)



