import csv

from GetpatchCode import GetpatchCode
from GetdetectionCode import analyze_results
from GetpatchDescription import Cvedes
import pandas as pd
import os
import json

proxy_url = 'http://127.0.0.1'
proxy_port = '10809'
os.environ['http_proxy'] = f'{proxy_url}:{proxy_port}'
os.environ['https_proxy'] = f'{proxy_url}:{proxy_port}'

vul_comfile_path = r'./data/cve_affected_com.json'
vul_dict = json.load(open(vul_comfile_path))
allvul4_com_map = {}
for cve_name in vul_dict:
    if cve_name == "other":
        continue
    for comname in vul_dict[cve_name]['PySecaffected']:
        if comname['package']['ecosystem'] != 'PyPI':
            continue
        if 'versions' not in comname:
            continue

        name = comname['package']['name']
        for version in comname['versions']:
            if cve_name not in allvul4_com_map:
                allvul4_com_map[cve_name] = []
            allvul4_com_map[cve_name].append(name + '@' + version)
    for comname in vul_dict[cve_name]['googleaffected']:

        if comname['package']['ecosystem'] != 'PyPI':
            continue
        if 'versions' not in comname:
            continue

        name = comname['package']['name']
        for version in comname['versions']:
            if cve_name not in allvul4_com_map:
                allvul4_com_map[cve_name] = []
            allvul4_com_map[cve_name].append(name + '@' + version)
for x in allvul4_com_map:
    allvul4_com_map[x] = list(set(allvul4_com_map[x]))

vul_com_map = allvul4_com_map




com_folder_path = r'./data/compondent'

all_com_set = set(os.listdir(com_folder_path))

csv_file = r'./data/VUL_patch.csv'
cve_commit_url_dict = {}

with open(csv_file, mode='r', encoding='gbk') as f:
    reader = csv.reader(f)
    for row in reader:
        if len(row) >= 2:  # 确保有至少两列数据
            key = row[0].strip()  # 第一列作为键，去除首尾空格
            values = [v.strip() for v in row[1].split('\n') if v.strip()]  # 按\n分割并清理空值
            cve_commit_url_dict[key] = values

from collections import Counter


def get_llm_ans_con_from_cve(Cve_id):
    if Cve_id not in cve_commit_url_dict:
        return

    save_path = os.path.join(r'output', Cve_id)

    if not os.path.exists(save_path):
        os.mkdir(save_path)
    have_analyze_set = set(os.listdir(save_path))
    commit_hash = Counter(x.split("@")[0] for x in have_analyze_set).most_common(1)[0][0] if have_analyze_set else None

    if Cve_id in cve_commit_url_dict:
        if not commit_hash:
            urls = cve_commit_url_dict[Cve_id]
            if not urls:
                return
            urls = urls[0]
            if not type(urls) == str:
                return
            # print(urls)
            commit_hash = urls.split("/")[-1]

    else:
        return
    json_file = os.path.join(
        r"./data/patch", commit_hash)
    patch = GetpatchCode(Cve_id)
    Cve_des = Cvedes(Cve_id)

    com_list = vul_com_map[Cve_id]
    com_set = set()

    need_ans_list = set()
    for com_name in com_list:
        com_set.add(com_name.split('@')[0])
    for com_name in all_com_set:
        for com_name2 in com_set:
            if com_name.startswith(com_name2 + "@"):
                need_ans_list.add(com_name)

    for item in need_ans_list:
        # if item not in need_ans_list[Cve_id]:
        #     continue

        if os.path.isdir(os.path.join(com_folder_path, item)):
            savefilename = commit_hash + "@" + item
            savefile_path = os.path.join(save_path, savefilename)

            if savefilename in have_analyze_set:
                continue

            item_path = os.path.join(com_folder_path, item)
            if not patch or commit_hash not in patch:
                continue

            detection_Code, file_list = analyze_results(json_file, item_path, commit_hash=commit_hash)

            print(savefile_path)
            patchstr = patch[commit_hash]
            file_content = "漏洞描述：" + str(Cve_des) + "\n补丁代码：\n" + patchstr + "\n待检测代码：\n"
            detail_str = ""
            flag = ""
            for file_path, id_list in detection_Code.items():
                print("处理文件:", file_path)
                for entry in id_list:
                    if 'details' in entry:
                        detail_str += file_path + "\n" + "Functionname: " + entry["name"].split('#')[
                            0] + ":  " + entry["details"] + "\n"

            if detail_str == flag:
                if file_list == []:
                    file_content += "空" + "\n"
                for file_path in file_list:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        file_content += file_path + "\n"
                        file_content += f.read() + "\n"

            else:
                file_content += detail_str + "\n"
        else:
            continue

        with open(savefile_path, 'w', encoding='utf-8') as f:
            f.write(file_content)


from concurrent.futures import ThreadPoolExecutor

if __name__ == "__main__":
    Cve_id = "CVE-2018-1000656"
    get_llm_ans_con_from_cve(Cve_id)

    # 1 a.csv 漏洞编号 patch号 补丁代码
    # 2 下载漏洞组件所有版本 解压放到一个文件夹
    # 3 根据patchdict定位文件 根据parse_modified_ranges和hits定位函数
    # 4 getcode找到并提取
    # 5 综合信息形成问题
    # 6 gpt
