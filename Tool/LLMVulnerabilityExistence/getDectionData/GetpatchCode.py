import requests
import re
import os
import pandas as pd

proxy_url = 'http://127.0.0.1'
proxy_port = '10809'
os.environ['http_proxy'] = f'{proxy_url}:{proxy_port}'
os.environ['https_proxy'] = f'{proxy_url}:{proxy_port}'

current_path = os.path.dirname(os.path.abspath(__file__))

csv_file = os.path.join(current_path, "data", 'VUL_patch.csv')
data = pd.read_csv(csv_file, encoding='ISO-8859-1')
cve_id = data.iloc[:, 0]
cve_url = data.iloc[:, 1]

patch_file = os.path.join(current_path, "data", 'patch')
patch_file_set = os.listdir(patch_file)
import chardet
def detect_chardet(chardet_file_path):
    with open(chardet_file_path, 'rb') as f:
        rawdata = f.read()
        encoding = chardet.detect(rawdata)['encoding']
    return encoding

def GetpatchCode(inputcve):

    result={}
    if inputcve in cve_id.values:
        index = cve_id[cve_id == inputcve].index[0]
        urls = cve_url.iloc[index]
        if pd.isna(urls):
            return
        url_list = str(urls).split('\n')
        for url in url_list:
            url = url.strip()

            patch_commit_id =url.split('/')[-1]
            commit_file_path = os.path.join(patch_file, patch_commit_id)
            if patch_commit_id in patch_file_set:
                encoding = detect_chardet(commit_file_path)
                with open(commit_file_path, 'r',encoding=encoding,errors='ignore') as f:
                    result[patch_commit_id] = f.read()
                    continue
            if url:
                if '/pull/' in url:
                    url = re.sub(r'/pull/\d+/', r'/', url)
                    url = re.sub(r'/commits/', r'/commit/', url)
                if "github" not in url or "commit" not in url:
                    continue
                response = requests.get(f"{url}.patch")
                if response.status_code == 200:
                    patch_data = response.text
                    result[patch_commit_id]=patch_data
                    with open(commit_file_path, 'w',encoding='utf-8') as f:
                        f.write(patch_data)
    return result


if __name__ == '__main__':
    from concurrent.futures import ThreadPoolExecutor
    with ThreadPoolExecutor(max_workers=15) as executor:
        for _cve_id in cve_id:
            executor.submit(GetpatchCode, _cve_id)
            # print(GetpatchCode(_cve_id))
