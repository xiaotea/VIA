import ast
import os

from setuptools import find_packages


def find_file_in_folder(folder_path, target_file):
    for root, dirs, files in os.walk(folder_path):
        if target_file in files:
            return os.path.join(root, target_file)

    return None


def find_deploy_packages_with_fun(file_path):
    packages_list = []
    setup_file_path = find_file_in_folder(file_path, 'setup.py')
    with open(setup_file_path,'r',encoding='utf-8') as setup_file:
        if 'find_packages' in  setup_file.read():
            file_path = os.path.dirname(setup_file_path)
            if os.path.exists(os.path.join(file_path, 'src')):
                file_path = os.path.join(file_path, 'src')
            pre_packages_list = find_packages(file_path,exclude=["tests", "tests.*"])

            if not pre_packages_list:
                return packages_list
            for package in pre_packages_list:
                if package.split('.')[0] not in packages_list:
                    packages_list.append(package.split('.')[0])

    return packages_list


def extract_packages_variable(file_path):
    with open(file_path, "r") as file:
        content = file.read()
    tree = ast.parse(content)
    packages = None
    for node in ast.walk(tree):
        if isinstance(node, ast.Call) and isinstance(node.func, ast.Name) and node.func.id == "setup":
            for keyword in node.keywords:
                if keyword.arg == "packages" and isinstance(keyword.value, ast.List):
                    packages = [elt.s for elt in keyword.value.elts]

    return packages

def find_file_in_folder(folder_path, target_file):
    file_list = []
    for root, dirs, files in os.walk(folder_path):
        if target_file in files:
            file_list.append(os.path.join(root, target_file))

    return file_list


filepath = r'D:\个人文件\开源软件供应链安全\python漏洞影响性分析实验\知识图谱创建\PathFind'
print(os.path.dirname(filepath))
# file_list = find_file_in_folder(filepath,'top_level.txt')
# for file in file_list:
#     with open(file,'r',encoding='utf-8') as f:
#         print(file)
#         print(f.read())

