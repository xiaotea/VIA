import csv
import json
import os
import re


def write_to_csv(file_path, data):
    with open(file_path, 'a', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(data)


patch_path = 'D:\D\个人文件\开源软件供应链安全\python漏洞影响性分析实验\知识图谱创建\整理好的\patchDictNew'


def findAllFileName(folder_path=None):
    # 获取当前文件夹路径
    folder_path = folder_path or patch_path
    file_list = []
    # 遍历当前文件夹并打印所有文件名
    for filename in os.listdir(folder_path):
        if os.path.isfile(os.path.join(folder_path, filename)):
            file_list.append(filename)
    return file_list


def main():
    commit_dict = {}
    file_list = findAllFileName()
    with open(r'F:\python_project\all_vul\vul_patch_人工二次寻找.csv', 'r',
              encoding='latin-1') as file:
        reader = csv.reader(file)
        for row in reader:
            commit = row[1].split('\n')
            commit = [x for x in commit if 'github' in x]
            commit_dict[row[0]] = commit
            # print(commit)
    funDict = {}
    add_funcutionList = []
    commitlist = []
    cveList = []
    nullList = []
    all_funcutionNum = 0
    for cvename in commit_dict:
        funDict[cvename] = []
        fun_list = []
        # if commit_dict[cvename]!=[]:
        # print(cvename)
        for commit in commit_dict[cvename]:
            # print(commit)
            commit_url = commit
            if '/pull/' in commit_url:
                commit_url = re.sub(r'/pull/\d+/', r'/', commit_url)
                commit_url = re.sub(r'/commits/', r'/commit/', commit_url)
            # print(commit_url)
            commit_id = re.search(r"commit/(.+)", commit_url).group(1)
            if commit_id in file_list:
                # print(cvename)
                commitlist.append(commit_id)

                commit_file_path = os.path.join(patch_path, commit_id)
                with open(commit_file_path, 'r') as f:
                    patchDict = json.loads(f.read())
                    for fileName in patchDict:
                        # print(fileName,fileName[:-3])
                        add_funcutionList = add_funcutionList + patchDict[fileName]['addLocation']

                        fun_list.extend(patchDict[fileName]['addLocation'])

                        for line in patchDict[fileName]['dele_reviseLocation']:
                            try:
                                patchDict[fileName]['dele_reviseLocation'][line]
                            except:
                                continue
                            if patchDict[fileName]['dele_reviseLocation'][line] != []:

                                fun_list.append(
                                    fileName[:-3] + '.' + '.'.join(patchDict[fileName]['dele_reviseLocation'][line]))

                            else:
                                # print(commit_url)
                                nullList.append(commit_id)
        fun_list = list(set(fun_list))
        all_funcutionNum = all_funcutionNum + len(fun_list)
        cveList.append(cvename)
        funDict[cvename] = fun_list

    commitlist = list(set(commitlist))
    nullList = list(set(nullList))
    cveList = list(set(cveList))

    # for x in funcutionList:
    #     print(x)
    print("", len(nullList))
    print("补丁数量", len(commitlist))
    print("漏洞数量", len(cveList))
    print("新增", len(add_funcutionList))

    print("所有", all_funcutionNum)

    # for eve_cve in funDict:
    #     fun_list = funDict[eve_cve]
    #     fun_str = ';'.join(fun_list)
    #     # fun_str = fun_str.replace('/','.')
    #     if fun_str != '':
    #         write_to_csv('D:\个人文件\开源软件供应链安全\python漏洞影响性分析实验\知识图谱创建\整理好的\VUL_FUNs_1.csv',
    #                      [eve_cve, fun_str])
    # print(json.dumps(funDict))

    return funDict


def find_google_fun():
    vul_dict = {}
    folder_path = r'D:\D\个人文件\开源软件供应链安全\python漏洞影响性分析实验\知识图谱创建\data\Pypi'
    for file in findAllFileName(folder_path=folder_path):
        with open(os.path.join(folder_path, file), 'r', encoding='utf-8') as f:
            vuldict = json.loads(f.read())
        # print('\n------')
        for x in vuldict['affected']:
            if 'ecosystem_specific' not in x.keys():
                continue
            if 'affected_functions' not in x['ecosystem_specific']:
                continue
            print(x)
            cve_name = ''
            cve_name_list = vuldict.get('aliases', [])
            for _cve_name in cve_name_list:
                if _cve_name.startswith('CVE-'):
                    cve_name = _cve_name
            if cve_name == '' or cve_name == "CVE-2023-41050":
                print('"' + file[:-5] + '":')
                print('["' + '","'.join(x['ecosystem_specific']['affected_functions']) + '"]')
                continue

            if cve_name in vul_dict:
                for _fun in x['ecosystem_specific']['affected_functions']:
                    if _fun not in vul_dict[cve_name]:
                        vul_dict[cve_name].append(_fun)
            else:
                vul_dict[cve_name] = x['ecosystem_specific']['affected_functions']
    with open(
            r'D:\D\个人文件\开源软件供应链安全\python漏洞影响性分析实验\知识图谱创建\整理好的\Google漏洞位置数据.json',
            'w', encoding='utf-8') as f:
        f.write(json.dumps(vul_dict, indent=4, ensure_ascii=False))
    # print(vul_dict)


# find_google_fun()
# exit()
#
def read_google_fun():
    with open(
            r'D:\D\个人文件\开源软件供应链安全\python漏洞影响性分析实验\知识图谱创建\整理好的\Google漏洞位置数据.json',
            'r', encoding='utf-8') as f:
        return json.loads(f.read())


if __name__ == "__main__":
    funDict = main()
    all_dict = {key: value for key, value in funDict.items() if value != []}
    print('我的数据集', len(all_dict))
    my_loc_num = sum(len(value) for value in all_dict.values())
    print('我的数据集漏洞位置个数', my_loc_num)
    # find_google_fun()
    google_dict = read_google_fun()
    google_num = sum(len(value) for value in google_dict.values())
    print('google数据集', len(google_dict))
    print('google数据集漏洞位置个数', google_num)
    for _cve_name in google_dict:
        if _cve_name in all_dict:
            _fun_list = [_fun.replace('/', '.') for _fun in all_dict[_cve_name]]
            for _fun in google_dict[_cve_name]:
                if _fun in _fun_list:
                    continue
                all_dict[_cve_name].append(_fun)

        else:
            all_dict[_cve_name] = google_dict[_cve_name]

    all_num = sum(len(value) for value in all_dict.values())
    print('合并数据集', len(all_dict))
    print('合并数据集漏洞位置个数', all_num)
    # print(all_dict)

    to_remove = set()

    for cve_name in all_dict:
        for _fun in all_dict[cve_name]:
            if ('version' in _fun.lower() or '__date__' in _fun.lower()) and not 'subversion' in _fun.lower():
                to_remove.add(_fun)
                continue
            if 'tests/' in _fun or 'tests.' in _fun:
                to_remove.add(_fun)

    for cve_name in all_dict:
        all_dict[cve_name] = [x for x in all_dict[cve_name].copy() if x not in to_remove]

    all_dict = {key: value for key, value in all_dict.items() if value != []}
    all_num = sum(len(value) for value in all_dict.values())
    print('清理数据集处理后', len(all_dict))
    print('清理数据集处理后漏洞位置个数', all_num)
    for eve_cve in all_dict:
        fun_list = all_dict[eve_cve]
        fun_str = ';'.join(fun_list)
        # fun_str = fun_str.replace('/','.')
        if fun_str != '':
            write_to_csv(
                'D:\D\个人文件\开源软件供应链安全\python漏洞影响性分析实验\知识图谱创建\整理好的\VUL_FUNs_2.csv',
                [eve_cve, fun_str])
