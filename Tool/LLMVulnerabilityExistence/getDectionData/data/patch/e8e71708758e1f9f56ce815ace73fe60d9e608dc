{
    "src/sentry/api/endpoints/rule_snooze.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " import datetime"
            },
            "1": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 2,
                "PatchRowcode": "+from typing import Literal"
            },
            "2": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " from django.contrib.auth.models import AnonymousUser"
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from rest_framework import serializers, status"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from rest_framework.exceptions import PermissionDenied"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from rest_framework.exceptions import NotFound, PermissionDenied"
            },
            "7": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from rest_framework.request import Request"
            },
            "8": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from rest_framework.response import Response"
            },
            "9": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " from sentry.models.rulesnooze import RuleSnooze"
            },
            "11": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " "
            },
            "12": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class RuleSnoozeValidator(CamelSnakeSerializer):"
            },
            "14": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    target = serializers.CharField(required=True, allow_null=False)"
            },
            "15": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    until = serializers.DateTimeField(required=False, allow_null=True)"
            },
            "16": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "17": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "18": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-@register(RuleSnooze)"
            },
            "19": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class RuleSnoozeSerializer(Serializer):"
            },
            "20": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def serialize(self, obj, attrs, user, **kwargs):"
            },
            "21": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        result = {"
            },
            "22": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"ownerId\": obj.owner_id,"
            },
            "23": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"userId\": obj.user_id or \"everyone\","
            },
            "24": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"until\": obj.until or \"forever\","
            },
            "25": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"dateAdded\": obj.date_added,"
            },
            "26": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"ruleId\": obj.rule_id,"
            },
            "27": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"alertRuleId\": obj.alert_rule_id,"
            },
            "28": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        }"
            },
            "29": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return result"
            },
            "30": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "31": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "32": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " def can_edit_alert_rule(organization, request):"
            },
            "33": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 27,
                "PatchRowcode": "     mute_for_user = request.data.get(\"target\") == \"me\""
            },
            "34": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 28,
                "PatchRowcode": "     user = request.user"
            },
            "35": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "     return True"
            },
            "36": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 55,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 56,
                "PatchRowcode": " "
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+class RuleSnoozeValidator(CamelSnakeSerializer):"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+    target = serializers.CharField(required=True, allow_null=False)"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+    until = serializers.DateTimeField(required=False, allow_null=True)"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+@register(RuleSnooze)"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+class RuleSnoozeSerializer(Serializer):"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+    def serialize(self, obj, attrs, user, **kwargs):"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+        result = {"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+            \"ownerId\": obj.owner_id,"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+            \"userId\": obj.user_id or \"everyone\","
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+            \"until\": obj.until or \"forever\","
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+            \"dateAdded\": obj.date_added,"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+            \"ruleId\": obj.rule_id,"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+            \"alertRuleId\": obj.alert_rule_id,"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+        }"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+        return result"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+"
            },
            "57": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 76,
                "PatchRowcode": " @region_silo_endpoint"
            },
            "58": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 77,
                "PatchRowcode": " class BaseRuleSnoozeEndpoint(ProjectEndpoint):"
            },
            "59": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "     permission_classes = (ProjectAlertRulePermission,)"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+    rule_model = type[Rule] | type[AlertRule]"
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 80,
                "PatchRowcode": "+    rule_field = Literal[\"rule\", \"alert_rule\"]"
            },
            "62": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 81,
                "PatchRowcode": " "
            },
            "63": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def get_rule(self, rule_id):"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+    def convert_args(self, request: Request, rule_id: int, *args, **kwargs):"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+        (args, kwargs) = super().convert_args(request, *args, **kwargs)"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        project = kwargs[\"project\"]"
            },
            "67": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 85,
                "PatchRowcode": "         try:"
            },
            "68": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            rule = self.rule_model.objects.get(id=rule_id)"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+            if self.rule_model is AlertRule:"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+                queryset = self.rule_model.objects.fetch_for_project(project)"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+            else:"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+                queryset = self.rule_model.objects.filter(project=project)"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+            rule = queryset.get(id=rule_id)"
            },
            "74": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "         except self.rule_model.DoesNotExist:"
            },
            "75": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise serializers.ValidationError(\"Rule does not exist\")"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+            raise NotFound(detail=\"Rule does not exist\")"
            },
            "77": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 93,
                "PatchRowcode": " "
            },
            "78": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return rule"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+        kwargs[\"rule\"] = rule"
            },
            "80": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 95,
                "PatchRowcode": " "
            },
            "81": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def post(self, request: Request, project: Project, rule_id) -> Response:"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+        return (args, kwargs)"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+    def post(self, request: Request, project: Project, rule: Rule | AlertRule) -> Response:"
            },
            "85": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "         serializer = RuleSnoozeValidator(data=request.data)"
            },
            "86": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         if not serializer.is_valid():"
            },
            "87": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "             return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)"
            },
            "88": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 102,
                "PatchRowcode": " "
            },
            "89": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 103,
                "PatchRowcode": "         data = serializer.validated_data"
            },
            "90": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        rule = self.get_rule(rule_id)"
            },
            "91": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 104,
                "PatchRowcode": " "
            },
            "92": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "         if not can_edit_alert_rule(project.organization, request):"
            },
            "93": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "             raise PermissionDenied("
            },
            "94": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": 143,
                "PatchRowcode": "             user_id=request.user.id,"
            },
            "95": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 144,
                "PatchRowcode": "             organization_id=project.organization_id,"
            },
            "96": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 145,
                "PatchRowcode": "             project_id=project.id,"
            },
            "97": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            rule_id=rule_id,"
            },
            "98": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+            rule_id=rule.id,"
            },
            "99": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "             rule_type=self.rule_field,"
            },
            "100": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": 148,
                "PatchRowcode": "             target=data.get(\"target\"),"
            },
            "101": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 149,
                "PatchRowcode": "             until=data.get(\"until\"),"
            },
            "102": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": 154,
                "PatchRowcode": "             status=status.HTTP_201_CREATED,"
            },
            "103": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": 155,
                "PatchRowcode": "         )"
            },
            "104": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": 156,
                "PatchRowcode": " "
            },
            "105": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def delete(self, request: Request, project: Project, rule_id) -> Response:"
            },
            "106": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        rule = self.get_rule(rule_id)"
            },
            "107": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "108": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+    def delete(self, request: Request, project: Project, rule: Rule | AlertRule) -> Response:"
            },
            "109": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 158,
                "PatchRowcode": "         # find if there is a mute for all that I can remove"
            },
            "110": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 159,
                "PatchRowcode": "         shared_snooze = None"
            },
            "111": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": 160,
                "PatchRowcode": "         deletion_type = None"
            },
            "112": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 188,
                "PatchRowcode": "                 user_id=request.user.id,"
            },
            "113": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 189,
                "PatchRowcode": "                 organization_id=project.organization_id,"
            },
            "114": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": 190,
                "PatchRowcode": "                 project_id=project.id,"
            },
            "115": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                rule_id=rule_id,"
            },
            "116": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 191,
                "PatchRowcode": "+                rule_id=rule.id,"
            },
            "117": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": 192,
                "PatchRowcode": "                 rule_type=self.rule_field,"
            },
            "118": {
                "beforePatchRowNumber": 185,
                "afterPatchRowNumber": 193,
                "PatchRowcode": "                 target=deletion_type,"
            },
            "119": {
                "beforePatchRowNumber": 186,
                "afterPatchRowNumber": 194,
                "PatchRowcode": "             )"
            }
        },
        "frontPatchFile": [
            "import datetime",
            "",
            "from django.contrib.auth.models import AnonymousUser",
            "from rest_framework import serializers, status",
            "from rest_framework.exceptions import PermissionDenied",
            "from rest_framework.request import Request",
            "from rest_framework.response import Response",
            "",
            "from sentry import analytics, audit_log",
            "from sentry.api.api_owners import ApiOwner",
            "from sentry.api.api_publish_status import ApiPublishStatus",
            "from sentry.api.base import region_silo_endpoint",
            "from sentry.api.bases.project import ProjectAlertRulePermission, ProjectEndpoint",
            "from sentry.api.exceptions import BadRequest",
            "from sentry.api.serializers import Serializer, register, serialize",
            "from sentry.api.serializers.rest_framework.base import CamelSnakeSerializer",
            "from sentry.incidents.models.alert_rule import AlertRule",
            "from sentry.models.organization import Organization",
            "from sentry.models.organizationmember import OrganizationMember",
            "from sentry.models.project import Project",
            "from sentry.models.rule import Rule",
            "from sentry.models.rulesnooze import RuleSnooze",
            "",
            "",
            "class RuleSnoozeValidator(CamelSnakeSerializer):",
            "    target = serializers.CharField(required=True, allow_null=False)",
            "    until = serializers.DateTimeField(required=False, allow_null=True)",
            "",
            "",
            "@register(RuleSnooze)",
            "class RuleSnoozeSerializer(Serializer):",
            "    def serialize(self, obj, attrs, user, **kwargs):",
            "        result = {",
            "            \"ownerId\": obj.owner_id,",
            "            \"userId\": obj.user_id or \"everyone\",",
            "            \"until\": obj.until or \"forever\",",
            "            \"dateAdded\": obj.date_added,",
            "            \"ruleId\": obj.rule_id,",
            "            \"alertRuleId\": obj.alert_rule_id,",
            "        }",
            "        return result",
            "",
            "",
            "def can_edit_alert_rule(organization, request):",
            "    mute_for_user = request.data.get(\"target\") == \"me\"",
            "    user = request.user",
            "",
            "    # Skip scope and user validation if using token authentication, excluding",
            "    # user tokens.",
            "    if request.auth and (isinstance(user, AnonymousUser) or user.is_sentry_app):",
            "        # Raise an exception if the user is anonymous, but the request is to mute for the user.",
            "        if mute_for_user:",
            "            raise BadRequest(",
            "                {",
            "                    \"detail\": \"Cannot mute for the request user because the user is anonymous.\",",
            "                }",
            "            )",
            "        return True",
            "",
            "    # Ensure that the user has the 'alerts:write' scope.",
            "    try:",
            "        org_member = OrganizationMember.objects.get(organization=organization, user_id=user.id)",
            "        if \"alerts:write\" not in org_member.get_scopes():",
            "            return False",
            "    except OrganizationMember.DoesNotExist:",
            "        pass",
            "    # if the goal is to mute the rule just for the user, ensure they belong to the organization",
            "    if mute_for_user:",
            "        return organization in Organization.objects.get_for_user(user)",
            "    # if the rule is owned by a team, allow edit (same permission as delete)",
            "    # if the rule is unassigned, anyone can edit it",
            "    return True",
            "",
            "",
            "@region_silo_endpoint",
            "class BaseRuleSnoozeEndpoint(ProjectEndpoint):",
            "    permission_classes = (ProjectAlertRulePermission,)",
            "",
            "    def get_rule(self, rule_id):",
            "        try:",
            "            rule = self.rule_model.objects.get(id=rule_id)",
            "        except self.rule_model.DoesNotExist:",
            "            raise serializers.ValidationError(\"Rule does not exist\")",
            "",
            "        return rule",
            "",
            "    def post(self, request: Request, project: Project, rule_id) -> Response:",
            "        serializer = RuleSnoozeValidator(data=request.data)",
            "        if not serializer.is_valid():",
            "            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)",
            "",
            "        data = serializer.validated_data",
            "        rule = self.get_rule(rule_id)",
            "",
            "        if not can_edit_alert_rule(project.organization, request):",
            "            raise PermissionDenied(",
            "                detail=\"Requesting user cannot mute this rule.\", code=status.HTTP_403_FORBIDDEN",
            "            )",
            "",
            "        kwargs = {self.rule_field: rule}",
            "",
            "        user_id = request.user.id if data.get(\"target\") == \"me\" else None",
            "        rule_snooze, created = RuleSnooze.objects.get_or_create(",
            "            user_id=user_id,",
            "            defaults={",
            "                \"owner_id\": request.user.id,",
            "                \"until\": data.get(\"until\"),",
            "                \"date_added\": datetime.datetime.now(datetime.UTC),",
            "            },",
            "            **kwargs,",
            "        )",
            "        # don't allow editing of a rulesnooze object for a given rule and user (or no user)",
            "        if not created:",
            "            return Response(",
            "                {\"detail\": \"RuleSnooze already exists for this rule and scope.\"},",
            "                status=status.HTTP_410_GONE,",
            "            )",
            "",
            "        if not user_id:",
            "            # create an audit log entry if the rule is snoozed for everyone",
            "            audit_log_event = \"RULE_SNOOZE\" if self.rule_model == Rule else \"ALERT_RULE_SNOOZE\"",
            "",
            "            self.create_audit_entry(",
            "                request=request,",
            "                organization=project.organization,",
            "                target_object=rule.id,",
            "                event=audit_log.get_event_id(audit_log_event),",
            "                data=rule.get_audit_log_data(),",
            "            )",
            "",
            "        analytics.record(",
            "            \"rule.snoozed\",",
            "            user_id=request.user.id,",
            "            organization_id=project.organization_id,",
            "            project_id=project.id,",
            "            rule_id=rule_id,",
            "            rule_type=self.rule_field,",
            "            target=data.get(\"target\"),",
            "            until=data.get(\"until\"),",
            "        )",
            "",
            "        return Response(",
            "            serialize(rule_snooze, request.user, RuleSnoozeSerializer()),",
            "            status=status.HTTP_201_CREATED,",
            "        )",
            "",
            "    def delete(self, request: Request, project: Project, rule_id) -> Response:",
            "        rule = self.get_rule(rule_id)",
            "",
            "        # find if there is a mute for all that I can remove",
            "        shared_snooze = None",
            "        deletion_type = None",
            "        kwargs = {self.rule_field: rule, \"user_id\": None}",
            "        try:",
            "            shared_snooze = RuleSnooze.objects.get(**kwargs)",
            "        except RuleSnooze.DoesNotExist:",
            "            pass",
            "",
            "        # if user can edit then delete it",
            "        if shared_snooze and can_edit_alert_rule(project.organization, request):",
            "            shared_snooze.delete()",
            "            deletion_type = \"everyone\"",
            "",
            "        # next check if there is a mute for me that I can remove",
            "        kwargs = {self.rule_field: rule, \"user_id\": request.user.id}",
            "        my_snooze = None",
            "        try:",
            "            my_snooze = RuleSnooze.objects.get(**kwargs)",
            "        except RuleSnooze.DoesNotExist:",
            "            pass",
            "        else:",
            "            my_snooze.delete()",
            "            # everyone takes priority over me",
            "            if not deletion_type:",
            "                deletion_type = \"me\"",
            "",
            "        if deletion_type:",
            "            analytics.record(",
            "                \"rule.unsnoozed\",",
            "                user_id=request.user.id,",
            "                organization_id=project.organization_id,",
            "                project_id=project.id,",
            "                rule_id=rule_id,",
            "                rule_type=self.rule_field,",
            "                target=deletion_type,",
            "            )",
            "            return Response(status=status.HTTP_204_NO_CONTENT)",
            "",
            "        # didn't find a match but there is a shared snooze",
            "        if shared_snooze:",
            "            raise PermissionDenied(",
            "                detail=\"Requesting user cannot unmute this rule.\", code=status.HTTP_403_FORBIDDEN",
            "            )",
            "        # no snooze at all found",
            "        return Response(",
            "            {\"detail\": \"This rulesnooze object doesn't exist.\"},",
            "            status=status.HTTP_404_NOT_FOUND,",
            "        )",
            "",
            "",
            "@region_silo_endpoint",
            "class RuleSnoozeEndpoint(BaseRuleSnoozeEndpoint):",
            "    owner = ApiOwner.ISSUES",
            "    publish_status = {",
            "        \"DELETE\": ApiPublishStatus.UNKNOWN,",
            "        \"POST\": ApiPublishStatus.UNKNOWN,",
            "    }",
            "    rule_model = Rule",
            "    rule_field = \"rule\"",
            "",
            "",
            "@region_silo_endpoint",
            "class MetricRuleSnoozeEndpoint(BaseRuleSnoozeEndpoint):",
            "    owner = ApiOwner.ISSUES",
            "    publish_status = {",
            "        \"DELETE\": ApiPublishStatus.UNKNOWN,",
            "        \"POST\": ApiPublishStatus.UNKNOWN,",
            "    }",
            "    rule_model = AlertRule",
            "    rule_field = \"alert_rule\""
        ],
        "afterPatchFile": [
            "import datetime",
            "from typing import Literal",
            "",
            "from django.contrib.auth.models import AnonymousUser",
            "from rest_framework import serializers, status",
            "from rest_framework.exceptions import NotFound, PermissionDenied",
            "from rest_framework.request import Request",
            "from rest_framework.response import Response",
            "",
            "from sentry import analytics, audit_log",
            "from sentry.api.api_owners import ApiOwner",
            "from sentry.api.api_publish_status import ApiPublishStatus",
            "from sentry.api.base import region_silo_endpoint",
            "from sentry.api.bases.project import ProjectAlertRulePermission, ProjectEndpoint",
            "from sentry.api.exceptions import BadRequest",
            "from sentry.api.serializers import Serializer, register, serialize",
            "from sentry.api.serializers.rest_framework.base import CamelSnakeSerializer",
            "from sentry.incidents.models.alert_rule import AlertRule",
            "from sentry.models.organization import Organization",
            "from sentry.models.organizationmember import OrganizationMember",
            "from sentry.models.project import Project",
            "from sentry.models.rule import Rule",
            "from sentry.models.rulesnooze import RuleSnooze",
            "",
            "",
            "def can_edit_alert_rule(organization, request):",
            "    mute_for_user = request.data.get(\"target\") == \"me\"",
            "    user = request.user",
            "",
            "    # Skip scope and user validation if using token authentication, excluding",
            "    # user tokens.",
            "    if request.auth and (isinstance(user, AnonymousUser) or user.is_sentry_app):",
            "        # Raise an exception if the user is anonymous, but the request is to mute for the user.",
            "        if mute_for_user:",
            "            raise BadRequest(",
            "                {",
            "                    \"detail\": \"Cannot mute for the request user because the user is anonymous.\",",
            "                }",
            "            )",
            "        return True",
            "",
            "    # Ensure that the user has the 'alerts:write' scope.",
            "    try:",
            "        org_member = OrganizationMember.objects.get(organization=organization, user_id=user.id)",
            "        if \"alerts:write\" not in org_member.get_scopes():",
            "            return False",
            "    except OrganizationMember.DoesNotExist:",
            "        pass",
            "    # if the goal is to mute the rule just for the user, ensure they belong to the organization",
            "    if mute_for_user:",
            "        return organization in Organization.objects.get_for_user(user)",
            "    # if the rule is owned by a team, allow edit (same permission as delete)",
            "    # if the rule is unassigned, anyone can edit it",
            "    return True",
            "",
            "",
            "class RuleSnoozeValidator(CamelSnakeSerializer):",
            "    target = serializers.CharField(required=True, allow_null=False)",
            "    until = serializers.DateTimeField(required=False, allow_null=True)",
            "",
            "",
            "@register(RuleSnooze)",
            "class RuleSnoozeSerializer(Serializer):",
            "    def serialize(self, obj, attrs, user, **kwargs):",
            "        result = {",
            "            \"ownerId\": obj.owner_id,",
            "            \"userId\": obj.user_id or \"everyone\",",
            "            \"until\": obj.until or \"forever\",",
            "            \"dateAdded\": obj.date_added,",
            "            \"ruleId\": obj.rule_id,",
            "            \"alertRuleId\": obj.alert_rule_id,",
            "        }",
            "        return result",
            "",
            "",
            "@region_silo_endpoint",
            "class BaseRuleSnoozeEndpoint(ProjectEndpoint):",
            "    permission_classes = (ProjectAlertRulePermission,)",
            "    rule_model = type[Rule] | type[AlertRule]",
            "    rule_field = Literal[\"rule\", \"alert_rule\"]",
            "",
            "    def convert_args(self, request: Request, rule_id: int, *args, **kwargs):",
            "        (args, kwargs) = super().convert_args(request, *args, **kwargs)",
            "        project = kwargs[\"project\"]",
            "        try:",
            "            if self.rule_model is AlertRule:",
            "                queryset = self.rule_model.objects.fetch_for_project(project)",
            "            else:",
            "                queryset = self.rule_model.objects.filter(project=project)",
            "            rule = queryset.get(id=rule_id)",
            "        except self.rule_model.DoesNotExist:",
            "            raise NotFound(detail=\"Rule does not exist\")",
            "",
            "        kwargs[\"rule\"] = rule",
            "",
            "        return (args, kwargs)",
            "",
            "    def post(self, request: Request, project: Project, rule: Rule | AlertRule) -> Response:",
            "        serializer = RuleSnoozeValidator(data=request.data)",
            "        if not serializer.is_valid():",
            "            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)",
            "",
            "        data = serializer.validated_data",
            "",
            "        if not can_edit_alert_rule(project.organization, request):",
            "            raise PermissionDenied(",
            "                detail=\"Requesting user cannot mute this rule.\", code=status.HTTP_403_FORBIDDEN",
            "            )",
            "",
            "        kwargs = {self.rule_field: rule}",
            "",
            "        user_id = request.user.id if data.get(\"target\") == \"me\" else None",
            "        rule_snooze, created = RuleSnooze.objects.get_or_create(",
            "            user_id=user_id,",
            "            defaults={",
            "                \"owner_id\": request.user.id,",
            "                \"until\": data.get(\"until\"),",
            "                \"date_added\": datetime.datetime.now(datetime.UTC),",
            "            },",
            "            **kwargs,",
            "        )",
            "        # don't allow editing of a rulesnooze object for a given rule and user (or no user)",
            "        if not created:",
            "            return Response(",
            "                {\"detail\": \"RuleSnooze already exists for this rule and scope.\"},",
            "                status=status.HTTP_410_GONE,",
            "            )",
            "",
            "        if not user_id:",
            "            # create an audit log entry if the rule is snoozed for everyone",
            "            audit_log_event = \"RULE_SNOOZE\" if self.rule_model == Rule else \"ALERT_RULE_SNOOZE\"",
            "",
            "            self.create_audit_entry(",
            "                request=request,",
            "                organization=project.organization,",
            "                target_object=rule.id,",
            "                event=audit_log.get_event_id(audit_log_event),",
            "                data=rule.get_audit_log_data(),",
            "            )",
            "",
            "        analytics.record(",
            "            \"rule.snoozed\",",
            "            user_id=request.user.id,",
            "            organization_id=project.organization_id,",
            "            project_id=project.id,",
            "            rule_id=rule.id,",
            "            rule_type=self.rule_field,",
            "            target=data.get(\"target\"),",
            "            until=data.get(\"until\"),",
            "        )",
            "",
            "        return Response(",
            "            serialize(rule_snooze, request.user, RuleSnoozeSerializer()),",
            "            status=status.HTTP_201_CREATED,",
            "        )",
            "",
            "    def delete(self, request: Request, project: Project, rule: Rule | AlertRule) -> Response:",
            "        # find if there is a mute for all that I can remove",
            "        shared_snooze = None",
            "        deletion_type = None",
            "        kwargs = {self.rule_field: rule, \"user_id\": None}",
            "        try:",
            "            shared_snooze = RuleSnooze.objects.get(**kwargs)",
            "        except RuleSnooze.DoesNotExist:",
            "            pass",
            "",
            "        # if user can edit then delete it",
            "        if shared_snooze and can_edit_alert_rule(project.organization, request):",
            "            shared_snooze.delete()",
            "            deletion_type = \"everyone\"",
            "",
            "        # next check if there is a mute for me that I can remove",
            "        kwargs = {self.rule_field: rule, \"user_id\": request.user.id}",
            "        my_snooze = None",
            "        try:",
            "            my_snooze = RuleSnooze.objects.get(**kwargs)",
            "        except RuleSnooze.DoesNotExist:",
            "            pass",
            "        else:",
            "            my_snooze.delete()",
            "            # everyone takes priority over me",
            "            if not deletion_type:",
            "                deletion_type = \"me\"",
            "",
            "        if deletion_type:",
            "            analytics.record(",
            "                \"rule.unsnoozed\",",
            "                user_id=request.user.id,",
            "                organization_id=project.organization_id,",
            "                project_id=project.id,",
            "                rule_id=rule.id,",
            "                rule_type=self.rule_field,",
            "                target=deletion_type,",
            "            )",
            "            return Response(status=status.HTTP_204_NO_CONTENT)",
            "",
            "        # didn't find a match but there is a shared snooze",
            "        if shared_snooze:",
            "            raise PermissionDenied(",
            "                detail=\"Requesting user cannot unmute this rule.\", code=status.HTTP_403_FORBIDDEN",
            "            )",
            "        # no snooze at all found",
            "        return Response(",
            "            {\"detail\": \"This rulesnooze object doesn't exist.\"},",
            "            status=status.HTTP_404_NOT_FOUND,",
            "        )",
            "",
            "",
            "@region_silo_endpoint",
            "class RuleSnoozeEndpoint(BaseRuleSnoozeEndpoint):",
            "    owner = ApiOwner.ISSUES",
            "    publish_status = {",
            "        \"DELETE\": ApiPublishStatus.UNKNOWN,",
            "        \"POST\": ApiPublishStatus.UNKNOWN,",
            "    }",
            "    rule_model = Rule",
            "    rule_field = \"rule\"",
            "",
            "",
            "@region_silo_endpoint",
            "class MetricRuleSnoozeEndpoint(BaseRuleSnoozeEndpoint):",
            "    owner = ApiOwner.ISSUES",
            "    publish_status = {",
            "        \"DELETE\": ApiPublishStatus.UNKNOWN,",
            "        \"POST\": ApiPublishStatus.UNKNOWN,",
            "    }",
            "    rule_model = AlertRule",
            "    rule_field = \"alert_rule\""
        ],
        "action": [
            "0",
            "-1",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "5": [],
            "25": [
                "RuleSnoozeValidator"
            ],
            "26": [
                "RuleSnoozeValidator"
            ],
            "27": [
                "RuleSnoozeValidator"
            ],
            "28": [],
            "29": [],
            "30": [],
            "31": [
                "RuleSnoozeSerializer"
            ],
            "32": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "33": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "34": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "35": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "36": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "37": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "38": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "39": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "40": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "41": [
                "RuleSnoozeSerializer",
                "serialize"
            ],
            "42": [],
            "43": [],
            "79": [
                "BaseRuleSnoozeEndpoint",
                "get_rule"
            ],
            "81": [
                "BaseRuleSnoozeEndpoint",
                "get_rule"
            ],
            "83": [
                "BaseRuleSnoozeEndpoint",
                "get_rule"
            ],
            "85": [
                "BaseRuleSnoozeEndpoint",
                "get_rule"
            ],
            "87": [
                "BaseRuleSnoozeEndpoint",
                "post"
            ],
            "93": [
                "BaseRuleSnoozeEndpoint",
                "post"
            ],
            "136": [
                "BaseRuleSnoozeEndpoint",
                "post"
            ],
            "147": [
                "BaseRuleSnoozeEndpoint",
                "delete"
            ],
            "148": [
                "BaseRuleSnoozeEndpoint",
                "delete"
            ],
            "149": [
                "BaseRuleSnoozeEndpoint",
                "delete"
            ],
            "183": [
                "BaseRuleSnoozeEndpoint",
                "delete"
            ]
        },
        "addLocation": []
    }
}