{
    "src/wagtail_2fa/middleware.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " class VerifyUserMiddleware(_OTPMiddleware):"
            },
            "2": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": "     _allowed_url_names = ["
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+        \"wagtail_2fa_auth\","
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+        \"wagtailadmin_login\","
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+        \"wagtailadmin_logout\","
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 16,
                "PatchRowcode": "+    ]"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 17,
                "PatchRowcode": "+    _allowed_url_names_no_device = ["
            },
            "8": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 18,
                "PatchRowcode": "         \"wagtail_2fa_auth\","
            },
            "9": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 19,
                "PatchRowcode": "         \"wagtail_2fa_device_list\","
            },
            "10": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 20,
                "PatchRowcode": "         \"wagtail_2fa_device_new\","
            },
            "11": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "             return False"
            },
            "12": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 72,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "         # Allow the user to a fixed number of paths when not verified"
            },
            "14": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if request.path in self._allowed_paths:"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+        user_has_device = django_otp.user_has_device(user, confirmed=True)"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+        if request.path in self._get_allowed_paths(user_has_device):"
            },
            "17": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "             return False"
            },
            "18": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 77,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "         # For all other cases require that the user is verfied via otp"
            },
            "20": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "         return True"
            },
            "21": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 80,
                "PatchRowcode": " "
            },
            "22": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @property"
            },
            "23": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def _allowed_paths(self):"
            },
            "24": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\"Return the paths the user may visit when not verified via otp"
            },
            "25": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "26": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        This result cannot be cached since we want to be compatible with the"
            },
            "27": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        django-hosts package. Django-hosts alters the urlconf based on the"
            },
            "28": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        hostname in the request, so the urls might exist for admin.<domain> but"
            },
            "29": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        not for www.<domain>."
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+    def _get_allowed_paths(self, has_device):"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+        \"\"\"Return the paths the user may visit when not verified via otp."
            },
            "32": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 83,
                "PatchRowcode": " "
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        If the user already has a registered device, return a limited set of"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+        paths to prevent them from adding or listing devices to prevent them"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+        from adding or listing devices."
            },
            "36": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "         \"\"\""
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+        allowed_url_names = self._allowed_url_names"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+        if not has_device:"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+            allowed_url_names = self._allowed_url_names_no_device"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+"
            },
            "41": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "         results = []"
            },
            "42": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for route_name in self._allowed_url_names:"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        for route_name in allowed_url_names:"
            },
            "44": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "             try:"
            },
            "45": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "                 results.append(settings.WAGTAIL_MOUNT_PATH + reverse(route_name))"
            },
            "46": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "             except NoReverseMatch:"
            }
        },
        "frontPatchFile": [
            "from functools import partial",
            "",
            "import django_otp",
            "from django.conf import settings",
            "from django.contrib.auth.views import redirect_to_login",
            "from django.urls import NoReverseMatch, reverse",
            "from django.utils.functional import SimpleLazyObject",
            "from django_otp.middleware import OTPMiddleware as _OTPMiddleware",
            "",
            "",
            "class VerifyUserMiddleware(_OTPMiddleware):",
            "    _allowed_url_names = [",
            "        \"wagtail_2fa_auth\",",
            "        \"wagtail_2fa_device_list\",",
            "        \"wagtail_2fa_device_new\",",
            "        \"wagtail_2fa_device_qrcode\",",
            "        \"wagtailadmin_login\",",
            "        \"wagtailadmin_logout\",",
            "    ]",
            "",
            "    def __call__(self, request):",
            "        if hasattr(self, 'process_request'):",
            "            response = self.process_request(request)",
            "        if not response:",
            "            response = self.get_response(request)",
            "        if hasattr(self, 'process_response'):",
            "            response = self.process_response(request, response)",
            "        return response",
            "",
            "    def process_request(self, request):",
            "        if request.user:",
            "            request.user = SimpleLazyObject(partial(self._verify_user, request, request.user))",
            "        user = request.user",
            "        if self._require_verified_user(request):",
            "            user_has_device = django_otp.user_has_device(user, confirmed=True)",
            "",
            "            if user_has_device and not user.is_verified():",
            "                return redirect_to_login(",
            "                    request.get_full_path(), login_url=reverse(\"wagtail_2fa_auth\")",
            "                )",
            "",
            "            elif not user_has_device and settings.WAGTAIL_2FA_REQUIRED:",
            "                # only allow the user to visit the admin index page and the",
            "                # admin setup page",
            "                return redirect_to_login(",
            "                    request.get_full_path(), login_url=reverse(\"wagtail_2fa_device_new\")",
            "                )",
            "",
            "    def _require_verified_user(self, request):",
            "        user = request.user",
            "",
            "        if not settings.WAGTAIL_2FA_REQUIRED:",
            "            # If two factor authentication is disabled in the settings",
            "            return False",
            "",
            "        if not user.is_authenticated:",
            "            return False",
            "",
            "        # If the user has no access to the admin anyway then don't require a",
            "        # verified user here",
            "        if not (",
            "            user.is_staff",
            "            or user.is_superuser",
            "            or user.has_perms([\"wagtailadmin.access_admin\"])",
            "        ):",
            "            return False",
            "",
            "        # Allow the user to a fixed number of paths when not verified",
            "        if request.path in self._allowed_paths:",
            "            return False",
            "",
            "        # For all other cases require that the user is verfied via otp",
            "        return True",
            "",
            "    @property",
            "    def _allowed_paths(self):",
            "        \"\"\"Return the paths the user may visit when not verified via otp",
            "",
            "        This result cannot be cached since we want to be compatible with the",
            "        django-hosts package. Django-hosts alters the urlconf based on the",
            "        hostname in the request, so the urls might exist for admin.<domain> but",
            "        not for www.<domain>.",
            "",
            "        \"\"\"",
            "        results = []",
            "        for route_name in self._allowed_url_names:",
            "            try:",
            "                results.append(settings.WAGTAIL_MOUNT_PATH + reverse(route_name))",
            "            except NoReverseMatch:",
            "                pass",
            "        return results"
        ],
        "afterPatchFile": [
            "from functools import partial",
            "",
            "import django_otp",
            "from django.conf import settings",
            "from django.contrib.auth.views import redirect_to_login",
            "from django.urls import NoReverseMatch, reverse",
            "from django.utils.functional import SimpleLazyObject",
            "from django_otp.middleware import OTPMiddleware as _OTPMiddleware",
            "",
            "",
            "class VerifyUserMiddleware(_OTPMiddleware):",
            "    _allowed_url_names = [",
            "        \"wagtail_2fa_auth\",",
            "        \"wagtailadmin_login\",",
            "        \"wagtailadmin_logout\",",
            "    ]",
            "    _allowed_url_names_no_device = [",
            "        \"wagtail_2fa_auth\",",
            "        \"wagtail_2fa_device_list\",",
            "        \"wagtail_2fa_device_new\",",
            "        \"wagtail_2fa_device_qrcode\",",
            "        \"wagtailadmin_login\",",
            "        \"wagtailadmin_logout\",",
            "    ]",
            "",
            "    def __call__(self, request):",
            "        if hasattr(self, 'process_request'):",
            "            response = self.process_request(request)",
            "        if not response:",
            "            response = self.get_response(request)",
            "        if hasattr(self, 'process_response'):",
            "            response = self.process_response(request, response)",
            "        return response",
            "",
            "    def process_request(self, request):",
            "        if request.user:",
            "            request.user = SimpleLazyObject(partial(self._verify_user, request, request.user))",
            "        user = request.user",
            "        if self._require_verified_user(request):",
            "            user_has_device = django_otp.user_has_device(user, confirmed=True)",
            "",
            "            if user_has_device and not user.is_verified():",
            "                return redirect_to_login(",
            "                    request.get_full_path(), login_url=reverse(\"wagtail_2fa_auth\")",
            "                )",
            "",
            "            elif not user_has_device and settings.WAGTAIL_2FA_REQUIRED:",
            "                # only allow the user to visit the admin index page and the",
            "                # admin setup page",
            "                return redirect_to_login(",
            "                    request.get_full_path(), login_url=reverse(\"wagtail_2fa_device_new\")",
            "                )",
            "",
            "    def _require_verified_user(self, request):",
            "        user = request.user",
            "",
            "        if not settings.WAGTAIL_2FA_REQUIRED:",
            "            # If two factor authentication is disabled in the settings",
            "            return False",
            "",
            "        if not user.is_authenticated:",
            "            return False",
            "",
            "        # If the user has no access to the admin anyway then don't require a",
            "        # verified user here",
            "        if not (",
            "            user.is_staff",
            "            or user.is_superuser",
            "            or user.has_perms([\"wagtailadmin.access_admin\"])",
            "        ):",
            "            return False",
            "",
            "        # Allow the user to a fixed number of paths when not verified",
            "        user_has_device = django_otp.user_has_device(user, confirmed=True)",
            "        if request.path in self._get_allowed_paths(user_has_device):",
            "            return False",
            "",
            "        # For all other cases require that the user is verfied via otp",
            "        return True",
            "",
            "    def _get_allowed_paths(self, has_device):",
            "        \"\"\"Return the paths the user may visit when not verified via otp.",
            "",
            "        If the user already has a registered device, return a limited set of",
            "        paths to prevent them from adding or listing devices to prevent them",
            "        from adding or listing devices.",
            "        \"\"\"",
            "        allowed_url_names = self._allowed_url_names",
            "        if not has_device:",
            "            allowed_url_names = self._allowed_url_names_no_device",
            "",
            "        results = []",
            "        for route_name in allowed_url_names:",
            "            try:",
            "                results.append(settings.WAGTAIL_MOUNT_PATH + reverse(route_name))",
            "            except NoReverseMatch:",
            "                pass",
            "        return results"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "69": [
                "VerifyUserMiddleware",
                "_require_verified_user"
            ],
            "75": [
                "VerifyUserMiddleware"
            ],
            "76": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ],
            "77": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ],
            "78": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ],
            "79": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ],
            "80": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ],
            "81": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ],
            "82": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ],
            "86": [
                "VerifyUserMiddleware",
                "_allowed_paths"
            ]
        },
        "addLocation": [
            "src.wagtail_2fa.middleware.VerifyUserMiddleware.self",
            "src.wagtail_2fa.middleware.VerifyUserMiddleware._allowed_url_names"
        ]
    }
}