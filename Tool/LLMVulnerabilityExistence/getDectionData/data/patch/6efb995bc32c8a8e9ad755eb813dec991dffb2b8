{
    "rdiffweb/controller/api.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "     userobj = UserObject.get_user(username)"
            },
            "1": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "     if userobj is not None:"
            },
            "2": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "         # Verify if the password matches a token."
            },
            "3": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if userobj.validate_access_token(password):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+        access_token = userobj.validate_access_token(password)"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        if access_token:"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+            access_token.accessed()"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+            access_token.commit()"
            },
            "8": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "             return True"
            },
            "9": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "         # Disable password authentication for MFA"
            },
            "10": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "         if userobj.mfa == UserObject.ENABLED_MFA:"
            },
            "11": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "     @cherrypy.expose"
            },
            "12": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "     def default(self):"
            },
            "13": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "         u = self.app.currentuser"
            },
            "14": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        u.refresh_repos()"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        if u.refresh_repos():"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+            u.commit()"
            },
            "17": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 86,
                "PatchRowcode": "         return {"
            },
            "18": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "             \"email\": u.email,"
            },
            "19": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "             \"username\": u.username,"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "# Define the logger",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "",
            "from rdiffweb.controller import Controller",
            "from rdiffweb.core.librdiff import RdiffTime",
            "from rdiffweb.core.model import UserObject",
            "",
            "try:",
            "    import simplejson as json",
            "except ImportError:",
            "    import json",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def json_handler(*args, **kwargs):",
            "    \"\"\"Custom json handle to convert RdiffDate to str.\"\"\"",
            "    value = cherrypy.serving.request._json_inner_handler(*args, **kwargs)",
            "",
            "    def default(o):",
            "        if isinstance(o, RdiffTime):",
            "            return str(o)",
            "        raise TypeError(repr(o) + \" is not JSON serializable\")",
            "",
            "    encode = json.JSONEncoder(default=default, ensure_ascii=False).iterencode",
            "    for chunk in encode(value):",
            "        yield chunk.encode('utf-8')",
            "",
            "",
            "def _checkpassword(realm, username, password):",
            "    \"\"\"",
            "    Check basic authentication.",
            "    \"\"\"",
            "    # Validate username",
            "    userobj = UserObject.get_user(username)",
            "    if userobj is not None:",
            "        # Verify if the password matches a token.",
            "        if userobj.validate_access_token(password):",
            "            return True",
            "        # Disable password authentication for MFA",
            "        if userobj.mfa == UserObject.ENABLED_MFA:",
            "            cherrypy.tools.ratelimit.hit()",
            "            return False",
            "    # Otherwise validate username password",
            "    valid = any(cherrypy.engine.publish('login', username, password))",
            "    if not valid:",
            "        # When invalid, we need to increase the rate limit.",
            "        cherrypy.tools.ratelimit.hit()",
            "    return valid",
            "",
            "",
            "class ApiCurrentUser(Controller):",
            "    @cherrypy.expose",
            "    def default(self):",
            "        u = self.app.currentuser",
            "        u.refresh_repos()",
            "        return {",
            "            \"email\": u.email,",
            "            \"username\": u.username,",
            "            \"repos\": [",
            "                {",
            "                    # Database fields.",
            "                    \"name\": repo_obj.name,",
            "                    \"maxage\": repo_obj.maxage,",
            "                    \"keepdays\": repo_obj.keepdays,",
            "                    # Repository fields.",
            "                    \"display_name\": repo_obj.display_name,",
            "                    \"last_backup_date\": repo_obj.last_backup_date,",
            "                    \"status\": repo_obj.status[0],",
            "                    \"encoding\": repo_obj.encoding,",
            "                }",
            "                for repo_obj in u.repo_objs",
            "            ],",
            "        }",
            "",
            "",
            "@cherrypy.tools.json_out(handler=json_handler)",
            "@cherrypy.config(**{'error_page.default': False})",
            "@cherrypy.tools.auth_basic(realm='rdiffweb', checkpassword=_checkpassword, priority=70)",
            "@cherrypy.tools.auth_form(on=False)",
            "@cherrypy.tools.auth_mfa(on=False)",
            "@cherrypy.tools.i18n(on=False)",
            "@cherrypy.tools.ratelimit(scope='rdiffweb-api', hit=0, priority=69)",
            "@cherrypy.tools.sessions(on=False)",
            "class ApiPage(Controller):",
            "    \"\"\"",
            "    This class provide a restful API to access some of the rdiffweb resources.",
            "    \"\"\"",
            "",
            "    currentuser = ApiCurrentUser()",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        return {",
            "            \"version\": self.app.version,",
            "        }"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "# Define the logger",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "",
            "from rdiffweb.controller import Controller",
            "from rdiffweb.core.librdiff import RdiffTime",
            "from rdiffweb.core.model import UserObject",
            "",
            "try:",
            "    import simplejson as json",
            "except ImportError:",
            "    import json",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def json_handler(*args, **kwargs):",
            "    \"\"\"Custom json handle to convert RdiffDate to str.\"\"\"",
            "    value = cherrypy.serving.request._json_inner_handler(*args, **kwargs)",
            "",
            "    def default(o):",
            "        if isinstance(o, RdiffTime):",
            "            return str(o)",
            "        raise TypeError(repr(o) + \" is not JSON serializable\")",
            "",
            "    encode = json.JSONEncoder(default=default, ensure_ascii=False).iterencode",
            "    for chunk in encode(value):",
            "        yield chunk.encode('utf-8')",
            "",
            "",
            "def _checkpassword(realm, username, password):",
            "    \"\"\"",
            "    Check basic authentication.",
            "    \"\"\"",
            "    # Validate username",
            "    userobj = UserObject.get_user(username)",
            "    if userobj is not None:",
            "        # Verify if the password matches a token.",
            "        access_token = userobj.validate_access_token(password)",
            "        if access_token:",
            "            access_token.accessed()",
            "            access_token.commit()",
            "            return True",
            "        # Disable password authentication for MFA",
            "        if userobj.mfa == UserObject.ENABLED_MFA:",
            "            cherrypy.tools.ratelimit.hit()",
            "            return False",
            "    # Otherwise validate username password",
            "    valid = any(cherrypy.engine.publish('login', username, password))",
            "    if not valid:",
            "        # When invalid, we need to increase the rate limit.",
            "        cherrypy.tools.ratelimit.hit()",
            "    return valid",
            "",
            "",
            "class ApiCurrentUser(Controller):",
            "    @cherrypy.expose",
            "    def default(self):",
            "        u = self.app.currentuser",
            "        if u.refresh_repos():",
            "            u.commit()",
            "        return {",
            "            \"email\": u.email,",
            "            \"username\": u.username,",
            "            \"repos\": [",
            "                {",
            "                    # Database fields.",
            "                    \"name\": repo_obj.name,",
            "                    \"maxage\": repo_obj.maxage,",
            "                    \"keepdays\": repo_obj.keepdays,",
            "                    # Repository fields.",
            "                    \"display_name\": repo_obj.display_name,",
            "                    \"last_backup_date\": repo_obj.last_backup_date,",
            "                    \"status\": repo_obj.status[0],",
            "                    \"encoding\": repo_obj.encoding,",
            "                }",
            "                for repo_obj in u.repo_objs",
            "            ],",
            "        }",
            "",
            "",
            "@cherrypy.tools.json_out(handler=json_handler)",
            "@cherrypy.config(**{'error_page.default': False})",
            "@cherrypy.tools.auth_basic(realm='rdiffweb', checkpassword=_checkpassword, priority=70)",
            "@cherrypy.tools.auth_form(on=False)",
            "@cherrypy.tools.auth_mfa(on=False)",
            "@cherrypy.tools.i18n(on=False)",
            "@cherrypy.tools.ratelimit(scope='rdiffweb-api', hit=0, priority=69)",
            "@cherrypy.tools.sessions(on=False)",
            "class ApiPage(Controller):",
            "    \"\"\"",
            "    This class provide a restful API to access some of the rdiffweb resources.",
            "    \"\"\"",
            "",
            "    currentuser = ApiCurrentUser()",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        return {",
            "            \"version\": self.app.version,",
            "        }"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "63": [
                "_checkpassword"
            ],
            "81": [
                "ApiCurrentUser",
                "default"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_admin_session.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "                     flash(_('You cannot revoke your current session.'), level='warning')"
            },
            "1": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "                 else:"
            },
            "2": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "                     session.delete()"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+                    session.commit()"
            },
            "4": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "                     flash(_('The session was successfully revoked.'), level='success')"
            },
            "5": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "             else:"
            },
            "6": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "                 flash(form.error_message, level='error')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminSessionPage(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(SessionObject.number == form.number.data).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter().all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"admin_session.html\", active_sessions=active_sessions)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminSessionPage(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(SessionObject.number == form.number.data).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    session.commit()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter().all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"admin_session.html\", active_sessions=active_sessions)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/page_admin_users.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": 182,
                "PatchRowcode": "             # Setting quota will silently fail. Check if quota was updated."
            },
            "1": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "             if userobj.disk_quota != new_quota:"
            },
            "2": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": 184,
                "PatchRowcode": "                 flash(_(\"Setting user's quota is not supported\"), level='warning')"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 185,
                "PatchRowcode": "+        userobj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 185,
                "afterPatchRowNumber": 186,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 186,
                "afterPatchRowNumber": 187,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 187,
                "afterPatchRowNumber": 188,
                "PatchRowcode": " class EditUserForm(UserForm):"
            },
            "7": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": 215,
                "PatchRowcode": "                 user = UserObject.get_user(form.username.data)"
            },
            "8": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": 216,
                "PatchRowcode": "                 if user:"
            },
            "9": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": 217,
                "PatchRowcode": "                     user.delete()"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 218,
                "PatchRowcode": "+                    user.commit()"
            },
            "11": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": 219,
                "PatchRowcode": "                     flash(_(\"User account removed.\"))"
            },
            "12": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": 220,
                "PatchRowcode": "                 else:"
            },
            "13": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": 221,
                "PatchRowcode": "                     flash(_(\"User doesn't exists!\"), level='warning')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "            validators.length(min=3, message=_('Username too short.')),",
            "            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "        description=_('To create an LDAP user, you must leave the password empty.'),",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "        render_kw={'data-beta': 1},",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValueError(_('Cannot change your own two-factor authentication settings.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data)",
            "        userobj.role = self.role.data",
            "        userobj.fullname = self.fullname.data or ''",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if self.mfa.data and not userobj.email:",
            "            flash(_(\"User email is required to enabled Two-Factor Authentication\"), level='error')",
            "        else:",
            "            userobj.mfa = self.mfa.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        else:",
            "            userobj.refresh_repos(delete=True)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = UserObject.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    @cherrypy.expose",
            "    def default(self, username=None, action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = UserObject.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = UserObject.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"users\": UserObject.query.all(),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "            validators.length(min=3, message=_('Username too short.')),",
            "            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "        description=_('To create an LDAP user, you must leave the password empty.'),",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "        render_kw={'data-beta': 1},",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValueError(_('Cannot change your own two-factor authentication settings.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data)",
            "        userobj.role = self.role.data",
            "        userobj.fullname = self.fullname.data or ''",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if self.mfa.data and not userobj.email:",
            "            flash(_(\"User email is required to enabled Two-Factor Authentication\"), level='error')",
            "        else:",
            "            userobj.mfa = self.mfa.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        else:",
            "            userobj.refresh_repos(delete=True)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "        userobj.commit()",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = UserObject.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    user.commit()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    @cherrypy.expose",
            "    def default(self, username=None, action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = UserObject.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = UserObject.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"users\": UserObject.query.all(),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.page_admin_users.AdminUsersPage.default",
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/page_delete.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " _logger = logging.getLogger(__name__)\r"
            },
            "1": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 41,
                "PatchRowcode": " \r"
            },
            "2": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 42,
                "PatchRowcode": " \r"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+def delete_repo(repoobj, path):\r"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+    repoobj.delete(path)\r"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+    repoobj.commit()\r"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+\r"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+\r"
            },
            "8": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 48,
                "PatchRowcode": " class DeleteRepoForm(CherryForm):\r"
            },
            "9": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "     confirm = StringField(_('Confirmation'), validators=[DataRequired()])\r"
            },
            "10": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 50,
                "PatchRowcode": " \r"
            },
            "11": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "         if form.is_submitted():\r"
            },
            "12": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "             if form.validate():\r"
            },
            "13": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "                 RepoObject.session.expunge(repo)\r"
            },
            "14": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                cherrypy.engine.publish('schedule_task', repo.delete, path)\r"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 80,
                "PatchRowcode": "+                cherrypy.engine.publish('schedule_task', delete_repo, repo, path)\r"
            },
            "16": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "                 # Redirect to parent folder or to root if repo get deleted\r"
            },
            "17": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "                 if path_obj.isroot:\r"
            },
            "18": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "                     raise cherrypy.HTTPRedirect(url_for('/'))\r"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "'''\r",
            "Created on Apr. 5, 2021\r",
            "\r",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>\r",
            "'''\r",
            "# Define the logger\r",
            "\r",
            "import logging\r",
            "import os\r",
            "\r",
            "import cherrypy\r",
            "from wtforms.fields.core import StringField\r",
            "from wtforms.validators import DataRequired, ValidationError\r",
            "\r",
            "from rdiffweb.controller import Controller\r",
            "from rdiffweb.controller.dispatch import poppath\r",
            "from rdiffweb.controller.filter_authorization import is_maintainer\r",
            "from rdiffweb.controller.form import CherryForm\r",
            "from rdiffweb.core.librdiff import AccessDeniedError, DoesNotExistError\r",
            "from rdiffweb.core.model import RepoObject\r",
            "from rdiffweb.core.rdw_templating import url_for\r",
            "from rdiffweb.tools.i18n import gettext_lazy as _\r",
            "\r",
            "_logger = logging.getLogger(__name__)\r",
            "\r",
            "\r",
            "class DeleteRepoForm(CherryForm):\r",
            "    confirm = StringField(_('Confirmation'), validators=[DataRequired()])\r",
            "\r",
            "    def validate_confirm(self, field):\r",
            "        if self.confirm.data != self.expected_confirm:\r",
            "            raise ValidationError(_('Invalid value, must be: %s') % self.expected_confirm)\r",
            "\r",
            "\r",
            "@poppath()\r",
            "class DeletePage(Controller):\r",
            "    @cherrypy.expose\r",
            "    @cherrypy.tools.errors(\r",
            "        error_table={\r",
            "            DoesNotExistError: 404,\r",
            "            AccessDeniedError: 403,\r",
            "        }\r",
            "    )\r",
            "    def default(self, path=b\"\", **kwargs):\r",
            "        # Check permissions on path/repo\r",
            "        repo, path = RepoObject.get_repo_path(path)\r",
            "        # Check if path exists with fstats\r",
            "        path_obj = repo.fstat(path)\r",
            "        # Check user's permissions\r",
            "        is_maintainer()\r",
            "\r",
            "        # validate form\r",
            "        form = DeleteRepoForm()\r",
            "\r",
            "        form.expected_confirm = path_obj.display_name\r",
            "        if form.is_submitted():\r",
            "            if form.validate():\r",
            "                RepoObject.session.expunge(repo)\r",
            "                cherrypy.engine.publish('schedule_task', repo.delete, path)\r",
            "                # Redirect to parent folder or to root if repo get deleted\r",
            "                if path_obj.isroot:\r",
            "                    raise cherrypy.HTTPRedirect(url_for('/'))\r",
            "                else:\r",
            "                    parent_path = repo.fstat(os.path.dirname(path_obj.path))\r",
            "                    raise cherrypy.HTTPRedirect(url_for('browse', repo, parent_path))\r",
            "            else:\r",
            "                raise cherrypy.HTTPError(400, form.error_message)\r",
            "        else:\r",
            "            raise cherrypy.HTTPError(405)\r"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "'''\r",
            "Created on Apr. 5, 2021\r",
            "\r",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>\r",
            "'''\r",
            "# Define the logger\r",
            "\r",
            "import logging\r",
            "import os\r",
            "\r",
            "import cherrypy\r",
            "from wtforms.fields.core import StringField\r",
            "from wtforms.validators import DataRequired, ValidationError\r",
            "\r",
            "from rdiffweb.controller import Controller\r",
            "from rdiffweb.controller.dispatch import poppath\r",
            "from rdiffweb.controller.filter_authorization import is_maintainer\r",
            "from rdiffweb.controller.form import CherryForm\r",
            "from rdiffweb.core.librdiff import AccessDeniedError, DoesNotExistError\r",
            "from rdiffweb.core.model import RepoObject\r",
            "from rdiffweb.core.rdw_templating import url_for\r",
            "from rdiffweb.tools.i18n import gettext_lazy as _\r",
            "\r",
            "_logger = logging.getLogger(__name__)\r",
            "\r",
            "\r",
            "def delete_repo(repoobj, path):\r",
            "    repoobj.delete(path)\r",
            "    repoobj.commit()\r",
            "\r",
            "\r",
            "class DeleteRepoForm(CherryForm):\r",
            "    confirm = StringField(_('Confirmation'), validators=[DataRequired()])\r",
            "\r",
            "    def validate_confirm(self, field):\r",
            "        if self.confirm.data != self.expected_confirm:\r",
            "            raise ValidationError(_('Invalid value, must be: %s') % self.expected_confirm)\r",
            "\r",
            "\r",
            "@poppath()\r",
            "class DeletePage(Controller):\r",
            "    @cherrypy.expose\r",
            "    @cherrypy.tools.errors(\r",
            "        error_table={\r",
            "            DoesNotExistError: 404,\r",
            "            AccessDeniedError: 403,\r",
            "        }\r",
            "    )\r",
            "    def default(self, path=b\"\", **kwargs):\r",
            "        # Check permissions on path/repo\r",
            "        repo, path = RepoObject.get_repo_path(path)\r",
            "        # Check if path exists with fstats\r",
            "        path_obj = repo.fstat(path)\r",
            "        # Check user's permissions\r",
            "        is_maintainer()\r",
            "\r",
            "        # validate form\r",
            "        form = DeleteRepoForm()\r",
            "\r",
            "        form.expected_confirm = path_obj.display_name\r",
            "        if form.is_submitted():\r",
            "            if form.validate():\r",
            "                RepoObject.session.expunge(repo)\r",
            "                cherrypy.engine.publish('schedule_task', delete_repo, repo, path)\r",
            "                # Redirect to parent folder or to root if repo get deleted\r",
            "                if path_obj.isroot:\r",
            "                    raise cherrypy.HTTPRedirect(url_for('/'))\r",
            "                else:\r",
            "                    parent_path = repo.fstat(os.path.dirname(path_obj.path))\r",
            "                    raise cherrypy.HTTPRedirect(url_for('browse', repo, parent_path))\r",
            "            else:\r",
            "                raise cherrypy.HTTPError(400, form.error_message)\r",
            "        else:\r",
            "            raise cherrypy.HTTPError(405)\r"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "75": [
                "DeletePage",
                "default"
            ]
        },
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/page_locations.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "     @cherrypy.expose"
            },
            "1": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "     def index(self):"
            },
            "2": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "         # Get page params"
            },
            "3": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.app.currentuser.refresh_repos()"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+        if self.app.currentuser.refresh_repos():"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+            self.app.currentuser.commit()"
            },
            "6": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "         params = {"
            },
            "7": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "             \"repos\": self.app.currentuser.repo_objs,"
            },
            "8": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 41,
                "PatchRowcode": "             \"disk_usage\": self.app.currentuser.disk_usage,"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "",
            "from rdiffweb.controller import Controller",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LocationsPage(Controller):",
            "    \"\"\"",
            "    Shows the repository page. Will show all available destination",
            "    backup directories. This is the root (/) page.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        # Get page params",
            "        self.app.currentuser.refresh_repos()",
            "        params = {",
            "            \"repos\": self.app.currentuser.repo_objs,",
            "            \"disk_usage\": self.app.currentuser.disk_usage,",
            "            \"disk_quota\": self.app.currentuser.disk_quota,",
            "        }",
            "        # Render the page.",
            "        return self._compile_template(\"locations.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "",
            "from rdiffweb.controller import Controller",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LocationsPage(Controller):",
            "    \"\"\"",
            "    Shows the repository page. Will show all available destination",
            "    backup directories. This is the root (/) page.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        # Get page params",
            "        if self.app.currentuser.refresh_repos():",
            "            self.app.currentuser.commit()",
            "        params = {",
            "            \"repos\": self.app.currentuser.repo_objs,",
            "            \"disk_usage\": self.app.currentuser.disk_usage,",
            "            \"disk_quota\": self.app.currentuser.disk_quota,",
            "        }",
            "        # Render the page.",
            "        return self._compile_template(\"locations.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "37": [
                "LocationsPage",
                "index"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_pref_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 58,
                "PatchRowcode": "     def populate_obj(self, user):"
            },
            "1": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 59,
                "PatchRowcode": "         user.fullname = self.fullname.data"
            },
            "2": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "         user.email = self.email.data"
            },
            "3": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        user.add()"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+        user.commit()"
            },
            "5": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 62,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 63,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 64,
                "PatchRowcode": " class UserPasswordForm(CherryForm):"
            },
            "8": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "             return False"
            },
            "9": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         try:"
            },
            "10": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "             user.set_password(self.new.data)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+            user.commit()"
            },
            "12": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 103,
                "PatchRowcode": "             return True"
            },
            "13": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 104,
                "PatchRowcode": "         except ValueError as e:"
            },
            "14": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "             self.new.errors = [str(e)]"
            },
            "15": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 121,
                "PatchRowcode": " "
            },
            "16": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 122,
                "PatchRowcode": "     def populate_obj(self, user):"
            },
            "17": {
                "beforePatchRowNumber": 122,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "         try:"
            },
            "18": {
                "beforePatchRowNumber": 123,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            user.refresh_repos(delete=True)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 124,
                "PatchRowcode": "+            if user.refresh_repos(delete=True):"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+                user.commit()"
            },
            "21": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "             flash(_(\"Repositories successfully updated\"), level='success')"
            },
            "22": {
                "beforePatchRowNumber": 125,
                "afterPatchRowNumber": 127,
                "PatchRowcode": "         except ValueError as e:"
            },
            "23": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 128,
                "PatchRowcode": "             flash(str(e), level='warning')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def validate_new(self, field):",
            "        \"\"\"",
            "        Make sure new password if not equals to old password.",
            "        \"\"\"",
            "        if self.new.data and self.new.data == self.current.data:",
            "            raise ValueError(_('The new password must be different from the current password.'))",
            "",
            "    def populate_obj(self, user):",
            "        # Check if current password is \"valid\" if Not, rate limit the",
            "        # number of attempts and logout user after too many invalid attempts.",
            "        if not user.validate_password(self.current.data):",
            "            self.current.errors = [_(\"Wrong current password.\")]",
            "            return False",
            "        try:",
            "            user.set_password(self.new.data)",
            "            return True",
            "        except ValueError as e:",
            "            self.new.errors = [str(e)]",
            "            return False",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    @cherrypy.tools.ratelimit(methods=['POST'], logout=True)",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "                raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                if password_form.populate_obj(self.app.currentuser):",
            "                    flash(_(\"Password updated successfully.\"), level='success')",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.commit()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def validate_new(self, field):",
            "        \"\"\"",
            "        Make sure new password if not equals to old password.",
            "        \"\"\"",
            "        if self.new.data and self.new.data == self.current.data:",
            "            raise ValueError(_('The new password must be different from the current password.'))",
            "",
            "    def populate_obj(self, user):",
            "        # Check if current password is \"valid\" if Not, rate limit the",
            "        # number of attempts and logout user after too many invalid attempts.",
            "        if not user.validate_password(self.current.data):",
            "            self.current.errors = [_(\"Wrong current password.\")]",
            "            return False",
            "        try:",
            "            user.set_password(self.new.data)",
            "            user.commit()",
            "            return True",
            "        except ValueError as e:",
            "            self.new.errors = [str(e)]",
            "            return False",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            if user.refresh_repos(delete=True):",
            "                user.commit()",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    @cherrypy.tools.ratelimit(methods=['POST'], logout=True)",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "                raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                if password_form.populate_obj(self.app.currentuser):",
            "                    flash(_(\"Password updated successfully.\"), level='success')",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "61": [
                "UserProfileForm",
                "populate_obj"
            ],
            "123": [
                "RefreshForm",
                "populate_obj"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_pref_mfa.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "         # Enable or disable MFA only when a code is provided."
            },
            "1": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "         if self.enable_mfa.data:"
            },
            "2": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "             userobj.mfa = UserObject.ENABLED_MFA"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+            userobj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "             flash(_(\"Two-Factor authentication enabled successfully.\"), level='success')"
            },
            "5": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "         elif self.disable_mfa.data:"
            },
            "6": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "             userobj.mfa = UserObject.DISABLED_MFA"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+            userobj.commit()"
            },
            "8": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 86,
                "PatchRowcode": "             flash(_(\"Two-Factor authentication disabled successfully.\"), level='success')"
            },
            "9": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 87,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "     def validate_code(self, field):"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms.fields import SelectField, StringField, SubmitField",
            "from wtforms.widgets import HiddenInput",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class AbstractMfaForm(CherryForm):",
            "    def __init__(self, obj, **kwargs):",
            "        assert obj",
            "        super().__init__(obj=obj, **kwargs)",
            "        # Keep only one of the enable or disable button",
            "        if obj.mfa:",
            "            self.enable_mfa.widget = HiddenInput()",
            "            self.enable_mfa.data = ''",
            "        else:",
            "            self.disable_mfa.widget = HiddenInput()",
            "            self.disable_mfa.data = ''",
            "",
            "",
            "class MfaStatusForm(AbstractMfaForm):",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA) Status'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        render_kw={'readonly': True, 'disabled': True, 'data-beta': '1'},",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "",
            "",
            "class MfaToggleForm(AbstractMfaForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        render_kw={",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link\"},",
            "    )",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def populate_obj(self, userobj):",
            "        # Enable or disable MFA only when a code is provided.",
            "        if self.enable_mfa.data:",
            "            userobj.mfa = UserObject.ENABLED_MFA",
            "            flash(_(\"Two-Factor authentication enabled successfully.\"), level='success')",
            "        elif self.disable_mfa.data:",
            "            userobj.mfa = UserObject.DISABLED_MFA",
            "            flash(_(\"Two-Factor authentication disabled successfully.\"), level='success')",
            "",
            "    def validate_code(self, field):",
            "        # Code is required for enable_mfa and disable_mfa",
            "        if self.enable_mfa.data or self.disable_mfa.data:",
            "            if not self.code.data:",
            "                raise ValueError(_(\"Enter the verification code to continue.\"))",
            "            # Validate code",
            "            if not cherrypy.tools.auth_mfa.verify_code(self.code.data, False):",
            "                raise ValueError(_(\"Invalid verification code.\"))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.enable_mfa.data or self.disable_mfa.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class PagePrefMfa(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        form = MfaToggleForm(obj=self.app.currentuser)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.resend_code.data:",
            "                    self.send_code()",
            "                elif form.enable_mfa.data or form.disable_mfa.data:",
            "                    form.populate_obj(self.app.currentuser)",
            "                    form = MfaStatusForm(obj=self.app.currentuser)",
            "            # Send verification code if previous code expired.",
            "            elif cherrypy.tools.auth_mfa.is_code_expired():",
            "                self.send_code()",
            "        else:",
            "            form = MfaStatusForm(obj=self.app.currentuser)",
            "        params = {",
            "            'form': form,",
            "        }",
            "        return self._compile_template(\"prefs_mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        userobj = self.app.currentuser",
            "        if not userobj.email:",
            "            flash(_(\"To continue, you must set up an email address for your account.\"), level='warning')",
            "            return",
            "        code = cherrypy.tools.auth_mfa.generate_code()",
            "        body = self.app.templates.compile_template(",
            "            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "        )",
            "        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "        flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms.fields import SelectField, StringField, SubmitField",
            "from wtforms.widgets import HiddenInput",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class AbstractMfaForm(CherryForm):",
            "    def __init__(self, obj, **kwargs):",
            "        assert obj",
            "        super().__init__(obj=obj, **kwargs)",
            "        # Keep only one of the enable or disable button",
            "        if obj.mfa:",
            "            self.enable_mfa.widget = HiddenInput()",
            "            self.enable_mfa.data = ''",
            "        else:",
            "            self.disable_mfa.widget = HiddenInput()",
            "            self.disable_mfa.data = ''",
            "",
            "",
            "class MfaStatusForm(AbstractMfaForm):",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA) Status'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        render_kw={'readonly': True, 'disabled': True, 'data-beta': '1'},",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "",
            "",
            "class MfaToggleForm(AbstractMfaForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        render_kw={",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link\"},",
            "    )",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def populate_obj(self, userobj):",
            "        # Enable or disable MFA only when a code is provided.",
            "        if self.enable_mfa.data:",
            "            userobj.mfa = UserObject.ENABLED_MFA",
            "            userobj.commit()",
            "            flash(_(\"Two-Factor authentication enabled successfully.\"), level='success')",
            "        elif self.disable_mfa.data:",
            "            userobj.mfa = UserObject.DISABLED_MFA",
            "            userobj.commit()",
            "            flash(_(\"Two-Factor authentication disabled successfully.\"), level='success')",
            "",
            "    def validate_code(self, field):",
            "        # Code is required for enable_mfa and disable_mfa",
            "        if self.enable_mfa.data or self.disable_mfa.data:",
            "            if not self.code.data:",
            "                raise ValueError(_(\"Enter the verification code to continue.\"))",
            "            # Validate code",
            "            if not cherrypy.tools.auth_mfa.verify_code(self.code.data, False):",
            "                raise ValueError(_(\"Invalid verification code.\"))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.enable_mfa.data or self.disable_mfa.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class PagePrefMfa(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        form = MfaToggleForm(obj=self.app.currentuser)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.resend_code.data:",
            "                    self.send_code()",
            "                elif form.enable_mfa.data or form.disable_mfa.data:",
            "                    form.populate_obj(self.app.currentuser)",
            "                    form = MfaStatusForm(obj=self.app.currentuser)",
            "            # Send verification code if previous code expired.",
            "            elif cherrypy.tools.auth_mfa.is_code_expired():",
            "                self.send_code()",
            "        else:",
            "            form = MfaStatusForm(obj=self.app.currentuser)",
            "        params = {",
            "            'form': form,",
            "        }",
            "        return self._compile_template(\"prefs_mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        userobj = self.app.currentuser",
            "        if not userobj.email:",
            "            flash(_(\"To continue, you must set up an email address for your account.\"), level='warning')",
            "            return",
            "        code = cherrypy.tools.auth_mfa.generate_code()",
            "        body = self.app.templates.compile_template(",
            "            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "        )",
            "        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "        flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job",
            "rdiffweb.controller.page_pref_mfa.PagePrefMfa.default"
        ]
    },
    "rdiffweb/controller/page_pref_notification.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "             if repo.display_name in self:\r"
            },
            "1": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "                 # Update the maxage\r"
            },
            "2": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "                 repo.maxage = self[repo.display_name].data\r"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+        userobj.commit()\r"
            },
            "4": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 80,
                "PatchRowcode": " \r"
            },
            "5": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 81,
                "PatchRowcode": " \r"
            },
            "6": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 82,
                "PatchRowcode": " class PagePrefNotification(Controller):\r"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\"\"\"\r",
            "Plugin used to send email to users when their repository is getting too old.\r",
            "User can control the notification period.\r",
            "\"\"\"\r",
            "\r",
            "\r",
            "import cherrypy\r",
            "from wtforms.fields import HiddenField, SelectField, SubmitField\r",
            "\r",
            "from rdiffweb.controller import Controller, flash\r",
            "from rdiffweb.controller.form import CherryForm\r",
            "from rdiffweb.tools.i18n import ugettext as _\r",
            "\r",
            "\r",
            "class MaxAgeField(SelectField):\r",
            "    def __init__(self, *args, **kwargs):\r",
            "        super().__init__(\r",
            "            *args,\r",
            "            choices=[\r",
            "                (0, _('disabled')),\r",
            "                (1, _('1 day')),\r",
            "                (2, _('2 days')),\r",
            "                (3, _('3 days')),\r",
            "                (4, _('4 days')),\r",
            "                (5, _('5 days')),\r",
            "                (6, _('6 days')),\r",
            "                (7, _('1 week')),\r",
            "                (14, _('2 weeks')),\r",
            "                (21, _('3 weeks')),\r",
            "                (28, _('4 weeks')),\r",
            "                (31, _('1 month')),\r",
            "            ],\r",
            "            coerce=int,\r",
            "            **kwargs\r",
            "        )\r",
            "\r",
            "\r",
            "class NotificationForm(CherryForm):\r",
            "    action = HiddenField(default=\"set_notification_info\")\r",
            "\r",
            "    @classmethod\r",
            "    def create_form(cls, userobj):\r",
            "        # Create dynamic list of fields\r",
            "        data = {}\r",
            "        extends = {}\r",
            "        for repo in userobj.repo_objs:\r",
            "            extends[repo.display_name] = MaxAgeField(label=repo.display_name)\r",
            "            data[repo.display_name] = repo.maxage\r",
            "        extends['submit'] = SubmitField(label=_('Save changes'))\r",
            "        # Create class\r",
            "        sub_form = type('SubForm', (cls,), extends)\r",
            "        return sub_form(data=data)\r",
            "\r",
            "    def is_submitted(self):\r",
            "        return self.action.data == 'set_notification_info' and super().is_submitted()\r",
            "\r",
            "    def populate_obj(self, userobj):\r",
            "        # Loop trough user repo and update max age.\r",
            "        for repo in userobj.repo_objs:\r",
            "            if repo.display_name in self:\r",
            "                # Update the maxage\r",
            "                repo.maxage = self[repo.display_name].data\r",
            "\r",
            "\r",
            "class PagePrefNotification(Controller):\r",
            "    @cherrypy.expose\r",
            "    def default(self, action=None, **kwargs):\r",
            "        # Process the parameters.\r",
            "        form = NotificationForm.create_form(self.app.currentuser)\r",
            "        if form.validate_on_submit():\r",
            "            form.populate_obj(self.app.currentuser)\r",
            "            flash(_('Notification settings updated successfully.'), level='success')\r",
            "\r",
            "        params = {\r",
            "            'email': self.app.currentuser.email,\r",
            "            'form': form,\r",
            "        }\r",
            "        return self._compile_template(\"prefs_notification.html\", **params)\r"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\"\"\"\r",
            "Plugin used to send email to users when their repository is getting too old.\r",
            "User can control the notification period.\r",
            "\"\"\"\r",
            "\r",
            "\r",
            "import cherrypy\r",
            "from wtforms.fields import HiddenField, SelectField, SubmitField\r",
            "\r",
            "from rdiffweb.controller import Controller, flash\r",
            "from rdiffweb.controller.form import CherryForm\r",
            "from rdiffweb.tools.i18n import ugettext as _\r",
            "\r",
            "\r",
            "class MaxAgeField(SelectField):\r",
            "    def __init__(self, *args, **kwargs):\r",
            "        super().__init__(\r",
            "            *args,\r",
            "            choices=[\r",
            "                (0, _('disabled')),\r",
            "                (1, _('1 day')),\r",
            "                (2, _('2 days')),\r",
            "                (3, _('3 days')),\r",
            "                (4, _('4 days')),\r",
            "                (5, _('5 days')),\r",
            "                (6, _('6 days')),\r",
            "                (7, _('1 week')),\r",
            "                (14, _('2 weeks')),\r",
            "                (21, _('3 weeks')),\r",
            "                (28, _('4 weeks')),\r",
            "                (31, _('1 month')),\r",
            "            ],\r",
            "            coerce=int,\r",
            "            **kwargs\r",
            "        )\r",
            "\r",
            "\r",
            "class NotificationForm(CherryForm):\r",
            "    action = HiddenField(default=\"set_notification_info\")\r",
            "\r",
            "    @classmethod\r",
            "    def create_form(cls, userobj):\r",
            "        # Create dynamic list of fields\r",
            "        data = {}\r",
            "        extends = {}\r",
            "        for repo in userobj.repo_objs:\r",
            "            extends[repo.display_name] = MaxAgeField(label=repo.display_name)\r",
            "            data[repo.display_name] = repo.maxage\r",
            "        extends['submit'] = SubmitField(label=_('Save changes'))\r",
            "        # Create class\r",
            "        sub_form = type('SubForm', (cls,), extends)\r",
            "        return sub_form(data=data)\r",
            "\r",
            "    def is_submitted(self):\r",
            "        return self.action.data == 'set_notification_info' and super().is_submitted()\r",
            "\r",
            "    def populate_obj(self, userobj):\r",
            "        # Loop trough user repo and update max age.\r",
            "        for repo in userobj.repo_objs:\r",
            "            if repo.display_name in self:\r",
            "                # Update the maxage\r",
            "                repo.maxage = self[repo.display_name].data\r",
            "        userobj.commit()\r",
            "\r",
            "\r",
            "class PagePrefNotification(Controller):\r",
            "    @cherrypy.expose\r",
            "    def default(self, action=None, **kwargs):\r",
            "        # Process the parameters.\r",
            "        form = NotificationForm.create_form(self.app.currentuser)\r",
            "        if form.validate_on_submit():\r",
            "            form.populate_obj(self.app.currentuser)\r",
            "            flash(_('Notification settings updated successfully.'), level='success')\r",
            "\r",
            "        params = {\r",
            "            'email': self.app.currentuser.email,\r",
            "            'form': form,\r",
            "        }\r",
            "        return self._compile_template(\"prefs_notification.html\", **params)\r"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/page_pref_session.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "                     flash(_('You cannot revoke your current session.'), level='warning')"
            },
            "1": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "                 else:"
            },
            "2": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "                     session.delete()"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+                    session.commit()"
            },
            "4": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "                     flash(_('The session was successfully revoked.'), level='success')"
            },
            "5": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "             else:"
            },
            "6": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "                 flash(form.error_message, level='error')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "",
            "class PagePrefSession(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(",
            "                    SessionObject.username == self.app.currentuser.username, SessionObject.number == form.number.data",
            "                ).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter(SessionObject.username == self.app.currentuser.username).all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"prefs_session.html\", active_sessions=active_sessions)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "",
            "class PagePrefSession(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(",
            "                    SessionObject.username == self.app.currentuser.username, SessionObject.number == form.number.data",
            "                ).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    session.commit()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter(SessionObject.username == self.app.currentuser.username).all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"prefs_session.html\", active_sessions=active_sessions)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/page_pref_sshkeys.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "     def populate_obj(self, userobj):"
            },
            "1": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "         try:"
            },
            "2": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "             userobj.add_authorizedkey(key=self.key.data, comment=self.title.data)"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+            userobj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "         except DuplicateSSHKeyError as e:"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+            userobj.rollback()"
            },
            "6": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "             flash(str(e), level='error')"
            },
            "7": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "         except Exception:"
            },
            "8": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "             flash(_(\"Unknown error while adding the SSH Key\"), level='error')"
            },
            "9": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "         is_maintainer()"
            },
            "10": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "         try:"
            },
            "11": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 90,
                "PatchRowcode": "             userobj.delete_authorizedkey(self.fingerprint.data)"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+            userobj.commit()"
            },
            "13": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "         except Exception:"
            },
            "14": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "             flash(_(\"Unknown error while removing the SSH Key\"), level='error')"
            },
            "15": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "             _logger.warning(\"error removing ssh key\", exc_info=1)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugins to allows users to configure the SSH keys using the web",
            "interface. Basically it's a UI for `~/.ssh/authorized_keys`. For this",
            "plugin to work properly, the users home directory need to match a real",
            "user home.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields.core import StringField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets.core import TextArea",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.dispatch import restapi",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "_logger = logging.getLogger(__name__)",
            "",
            "",
            "def validate_key(unused_form, field):",
            "    \"\"\"Custom validator to check the SSH Key.\"\"\"",
            "    try:",
            "        authorizedkeys.check_publickey(field.data)",
            "    except ValueError:",
            "        raise ValidationError(_(\"Invalid SSH key.\"))",
            "",
            "",
            "class SshForm(CherryForm):",
            "    title = StringField(",
            "        _('Title'),",
            "        description=_('The title is an optional description to identify the key. e.g.: bob@thinkpad-t530'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(",
            "                max=256,",
            "                message=_('Title too long.'),",
            "            ),",
            "        ],",
            "    )",
            "    key = StringField(",
            "        _('Key'),",
            "        widget=TextArea(),",
            "        description=_(",
            "            \"Enter a SSH public key. It should start with 'ssh-dss', 'ssh-ed25519', 'ssh-rsa', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384' or 'ecdsa-sha2-nistp521'.\"",
            "        ),",
            "        validators=[validators.data_required(), validate_key],",
            "    )",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            userobj.add_authorizedkey(key=self.key.data, comment=self.title.data)",
            "        except DuplicateSSHKeyError as e:",
            "            flash(str(e), level='error')",
            "        except Exception:",
            "            flash(_(\"Unknown error while adding the SSH Key\"), level='error')",
            "            _logger.warning(\"error adding ssh key\", exc_info=1)",
            "",
            "",
            "class DeleteSshForm(CherryForm):",
            "    fingerprint = StringField('Fingerprint', validators=[validators.data_required()])",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_authorizedkey(self.fingerprint.data)",
            "        except Exception:",
            "            flash(_(\"Unknown error while removing the SSH Key\"), level='error')",
            "            _logger.warning(\"error removing ssh key\", exc_info=1)",
            "",
            "",
            "class PagePrefSshKeys(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "",
            "        # Handle action",
            "        form = SshForm()",
            "        delete_form = DeleteSshForm()",
            "        if not self.app.cfg.disable_ssh_keys:",
            "            if action == 'add' and form.is_submitted():",
            "                if form.validate():",
            "                    form.populate_obj(self.app.currentuser)",
            "                else:",
            "                    flash(form.error_message, level='warning')",
            "            elif action == 'delete' and delete_form.is_submitted():",
            "                if delete_form.validate():",
            "                    delete_form.populate_obj(self.app.currentuser)",
            "                else:",
            "                    flash(delete_form.error_message, level='warning')",
            "",
            "        # Get SSH keys if file exists.",
            "        params = {",
            "            'disable_ssh_keys': self.app.cfg.disable_ssh_keys,",
            "            'form': form,",
            "        }",
            "        try:",
            "            params[\"sshkeys\"] = [",
            "                {'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys",
            "            ]",
            "        except IOError:",
            "            params[\"sshkeys\"] = []",
            "            flash(_(\"Failed to get SSH keys\"), level='error')",
            "            _logger.warning(\"error reading SSH keys\", exc_info=1)",
            "",
            "        return self._compile_template(\"prefs_sshkeys.html\", **params)",
            "",
            "",
            "@restapi()",
            "@cherrypy.tools.json_out()",
            "class ApiSshKeys(Controller):",
            "    @cherrypy.expose",
            "    def list(self):",
            "        return [{'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys]",
            "",
            "    @cherrypy.expose",
            "    def get(self, fingerprint):",
            "        for key in self.app.currentuser.authorizedkeys:",
            "            if key.fingerprint == fingerprint:",
            "                return {'title': key.comment, 'fingerprint': key.fingerprint}",
            "        raise cherrypy.HTTPError(404)",
            "",
            "    @cherrypy.expose",
            "    def delete(self, fingerprint):",
            "        form = DeleteSshForm(fingerprint=fingerprint)",
            "        if form.validate():",
            "            form.populate_obj(self.app.currentuser)",
            "            return {}",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)",
            "",
            "    @cherrypy.expose",
            "    def post(self, **kwargs):",
            "        form = SshForm()",
            "        if form.validate():",
            "            form.populate_obj(self.app.currentuser)",
            "            return kwargs",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugins to allows users to configure the SSH keys using the web",
            "interface. Basically it's a UI for `~/.ssh/authorized_keys`. For this",
            "plugin to work properly, the users home directory need to match a real",
            "user home.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields.core import StringField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets.core import TextArea",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.dispatch import restapi",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "_logger = logging.getLogger(__name__)",
            "",
            "",
            "def validate_key(unused_form, field):",
            "    \"\"\"Custom validator to check the SSH Key.\"\"\"",
            "    try:",
            "        authorizedkeys.check_publickey(field.data)",
            "    except ValueError:",
            "        raise ValidationError(_(\"Invalid SSH key.\"))",
            "",
            "",
            "class SshForm(CherryForm):",
            "    title = StringField(",
            "        _('Title'),",
            "        description=_('The title is an optional description to identify the key. e.g.: bob@thinkpad-t530'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(",
            "                max=256,",
            "                message=_('Title too long.'),",
            "            ),",
            "        ],",
            "    )",
            "    key = StringField(",
            "        _('Key'),",
            "        widget=TextArea(),",
            "        description=_(",
            "            \"Enter a SSH public key. It should start with 'ssh-dss', 'ssh-ed25519', 'ssh-rsa', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384' or 'ecdsa-sha2-nistp521'.\"",
            "        ),",
            "        validators=[validators.data_required(), validate_key],",
            "    )",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            userobj.add_authorizedkey(key=self.key.data, comment=self.title.data)",
            "            userobj.commit()",
            "        except DuplicateSSHKeyError as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='error')",
            "        except Exception:",
            "            flash(_(\"Unknown error while adding the SSH Key\"), level='error')",
            "            _logger.warning(\"error adding ssh key\", exc_info=1)",
            "",
            "",
            "class DeleteSshForm(CherryForm):",
            "    fingerprint = StringField('Fingerprint', validators=[validators.data_required()])",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_authorizedkey(self.fingerprint.data)",
            "            userobj.commit()",
            "        except Exception:",
            "            flash(_(\"Unknown error while removing the SSH Key\"), level='error')",
            "            _logger.warning(\"error removing ssh key\", exc_info=1)",
            "",
            "",
            "class PagePrefSshKeys(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "",
            "        # Handle action",
            "        form = SshForm()",
            "        delete_form = DeleteSshForm()",
            "        if not self.app.cfg.disable_ssh_keys:",
            "            if action == 'add' and form.is_submitted():",
            "                if form.validate():",
            "                    form.populate_obj(self.app.currentuser)",
            "                else:",
            "                    flash(form.error_message, level='warning')",
            "            elif action == 'delete' and delete_form.is_submitted():",
            "                if delete_form.validate():",
            "                    delete_form.populate_obj(self.app.currentuser)",
            "                else:",
            "                    flash(delete_form.error_message, level='warning')",
            "",
            "        # Get SSH keys if file exists.",
            "        params = {",
            "            'disable_ssh_keys': self.app.cfg.disable_ssh_keys,",
            "            'form': form,",
            "        }",
            "        try:",
            "            params[\"sshkeys\"] = [",
            "                {'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys",
            "            ]",
            "        except IOError:",
            "            params[\"sshkeys\"] = []",
            "            flash(_(\"Failed to get SSH keys\"), level='error')",
            "            _logger.warning(\"error reading SSH keys\", exc_info=1)",
            "",
            "        return self._compile_template(\"prefs_sshkeys.html\", **params)",
            "",
            "",
            "@restapi()",
            "@cherrypy.tools.json_out()",
            "class ApiSshKeys(Controller):",
            "    @cherrypy.expose",
            "    def list(self):",
            "        return [{'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys]",
            "",
            "    @cherrypy.expose",
            "    def get(self, fingerprint):",
            "        for key in self.app.currentuser.authorizedkeys:",
            "            if key.fingerprint == fingerprint:",
            "                return {'title': key.comment, 'fingerprint': key.fingerprint}",
            "        raise cherrypy.HTTPError(404)",
            "",
            "    @cherrypy.expose",
            "    def delete(self, fingerprint):",
            "        form = DeleteSshForm(fingerprint=fingerprint)",
            "        if form.validate():",
            "            form.populate_obj(self.app.currentuser)",
            "            return {}",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)",
            "",
            "    @cherrypy.expose",
            "    def post(self, **kwargs):",
            "        form = SshForm()",
            "        if form.validate():",
            "            form.populate_obj(self.app.currentuser)",
            "            return kwargs",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job",
            "rdiffweb.controller.page_pref_sshkeys.ApiSshKeys.delete",
            "rdiffweb.controller.page_pref_sshkeys.PagePrefSshKeys.default",
            "rdiffweb.controller.page_pref_sshkeys.ApiSshKeys.post"
        ]
    },
    "rdiffweb/controller/page_pref_tokens.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "     def populate_obj(self, userobj):"
            },
            "1": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "         try:"
            },
            "2": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "             token = userobj.add_access_token(self.name.data, self.expiration.data)"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+            userobj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "             flash("
            },
            "5": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "                 _("
            },
            "6": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "                     \"Your new personal access token has been created.\\n\""
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import DateField, HiddenField, StringField, SubmitField",
            "from wtforms.validators import DataRequired, Length, Optional",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import Token",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class TokenForm(CherryForm):",
            "    action = HiddenField(default='add_access_token')",
            "    name = StringField(",
            "        _('Token name'),",
            "        description=_(",
            "            'Used only to identify the purpose of the token. For example, the application that uses the token.'",
            "        ),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_('Token name too long')),",
            "        ],",
            "    )",
            "    expiration = DateField(",
            "        _('Expiration date'),",
            "        description=_(",
            "            'Allows the creation of a temporary token by defining an expiration date. Leave empty to keep the token forever.'",
            "        ),",
            "        render_kw={",
            "            \"placeholder\": _('YYYY-MM-DD'),",
            "        },",
            "        validators=[Optional()],",
            "    )",
            "    submit = SubmitField(_('Create access token'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'add_access_token'",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            token = userobj.add_access_token(self.name.data, self.expiration.data)",
            "            flash(",
            "                _(",
            "                    \"Your new personal access token has been created.\\n\"",
            "                    \"Make sure to save it - you won't be able to access it again.\\n\"",
            "                    \"%s\"",
            "                )",
            "                % token,",
            "                level='info',",
            "            )",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "        except Exception:",
            "            logger.exception(\"error adding access token: %s, %s\" % (self.name.data, self.expiration.data))",
            "            flash(_(\"Unknown error while adding the access token.\"), level='error')",
            "",
            "",
            "class DeleteTokenForm(CherryForm):",
            "    action = HiddenField(default='delete_access_token')",
            "    name = StringField(validators=[DataRequired()])",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'delete_access_token'",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_access_token(self.name.data)",
            "            flash(_('The access token has been successfully deleted.'), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "        except Exception:",
            "            logger.exception(\"error removing access token: %s\" % self.name.data)",
            "            flash(_(\"Unknown error while removing the access token.\"), level='error')",
            "",
            "",
            "class PagePrefTokens(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        form = TokenForm()",
            "        delete_form = DeleteTokenForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif delete_form.is_submitted():",
            "            if delete_form.validate():",
            "                delete_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(delete_form.error_message, level='error')",
            "        params = {",
            "            'form': form,",
            "            'tokens': Token.query.filter(Token.userid == self.app.currentuser.userid),",
            "        }",
            "        return self._compile_template(\"prefs_tokens.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import DateField, HiddenField, StringField, SubmitField",
            "from wtforms.validators import DataRequired, Length, Optional",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import Token",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class TokenForm(CherryForm):",
            "    action = HiddenField(default='add_access_token')",
            "    name = StringField(",
            "        _('Token name'),",
            "        description=_(",
            "            'Used only to identify the purpose of the token. For example, the application that uses the token.'",
            "        ),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_('Token name too long')),",
            "        ],",
            "    )",
            "    expiration = DateField(",
            "        _('Expiration date'),",
            "        description=_(",
            "            'Allows the creation of a temporary token by defining an expiration date. Leave empty to keep the token forever.'",
            "        ),",
            "        render_kw={",
            "            \"placeholder\": _('YYYY-MM-DD'),",
            "        },",
            "        validators=[Optional()],",
            "    )",
            "    submit = SubmitField(_('Create access token'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'add_access_token'",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            token = userobj.add_access_token(self.name.data, self.expiration.data)",
            "            userobj.commit()",
            "            flash(",
            "                _(",
            "                    \"Your new personal access token has been created.\\n\"",
            "                    \"Make sure to save it - you won't be able to access it again.\\n\"",
            "                    \"%s\"",
            "                )",
            "                % token,",
            "                level='info',",
            "            )",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "        except Exception:",
            "            logger.exception(\"error adding access token: %s, %s\" % (self.name.data, self.expiration.data))",
            "            flash(_(\"Unknown error while adding the access token.\"), level='error')",
            "",
            "",
            "class DeleteTokenForm(CherryForm):",
            "    action = HiddenField(default='delete_access_token')",
            "    name = StringField(validators=[DataRequired()])",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'delete_access_token'",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_access_token(self.name.data)",
            "            flash(_('The access token has been successfully deleted.'), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "        except Exception:",
            "            logger.exception(\"error removing access token: %s\" % self.name.data)",
            "            flash(_(\"Unknown error while removing the access token.\"), level='error')",
            "",
            "",
            "class PagePrefTokens(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        form = TokenForm()",
            "        delete_form = DeleteTokenForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif delete_form.is_submitted():",
            "            if delete_form.validate():",
            "                delete_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(delete_form.error_message, level='error')",
            "        params = {",
            "            'form': form,",
            "            'tokens': Token.query.filter(Token.userid == self.app.currentuser.userid),",
            "        }",
            "        return self._compile_template(\"prefs_tokens.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.page_pref_tokens.PagePrefTokens.default",
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/tests/test_api.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "         # Given a user with an access token"
            },
            "1": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "         userobj = UserObject.get_user(self.USERNAME)"
            },
            "2": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 103,
                "PatchRowcode": "         token = userobj.add_access_token('test').encode('ascii')"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+        userobj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "         # When using this token to authenticated with /api"
            },
            "5": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "         self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\" + token).decode('ascii'))])"
            },
            "6": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 107,
                "PatchRowcode": "         # Then authentication is successful"
            },
            "7": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "         # Given a user with MFA enabled"
            },
            "8": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "         userobj = UserObject.get_user(self.USERNAME)"
            },
            "9": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 113,
                "PatchRowcode": "         userobj.mfa = UserObject.ENABLED_MFA"
            },
            "10": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        userobj.add()"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+        userobj.commit()"
            },
            "12": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 115,
                "PatchRowcode": "         # When authenticating with /api/"
            },
            "13": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 116,
                "PatchRowcode": "         self.getPage('/api/', headers=self.headers)"
            },
            "14": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "         # Then access is refused"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "",
            "from base64 import b64encode",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class APITest(rdiffweb.test.WebCase):",
            "",
            "    headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))]",
            "",
            "    def test_get_index(self):",
            "        data = self.getJson('/api/', headers=self.headers)",
            "        self.assertIsNotNone(data.get('version'))",
            "",
            "    def test_get_currentuser(self):",
            "        data = self.getJson('/api/currentuser/', headers=self.headers)",
            "        self.assertEqual(data.get('username'), 'admin')",
            "        self.assertEqual(data.get('email'), '')",
            "        # This value change on every execution.",
            "        self.assertEqual(2, len(data.get('repos')))",
            "        repo = data.get('repos')[1]",
            "        self.assertEqual(repo.get('keepdays'), -1)",
            "        self.assertEqual(repo.get('last_backup_date'), '2016-02-02T16:30:40-05:00')",
            "        self.assertEqual(repo.get('status'), 'ok')",
            "        self.assertEqual(repo.get('display_name'), 'testcases')",
            "        self.assertEqual(repo.get('encoding'), 'utf-8')",
            "        self.assertEqual(repo.get('name'), 'testcases')",
            "        self.assertEqual(repo.get('maxage'), 0)",
            "",
            "    def test_getapi_without_authorization(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/')",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_without_username(self):",
            "        \"\"\"",
            "        Check if error 401 is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\":admin123\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_empty_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_invalid_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_authorization(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getapi_with_session(self):",
            "        # Given an authenticate user",
            "        b = {'login': self.USERNAME, 'password': self.PASSWORD}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        # When querying the API",
            "        self.getPage('/api/')",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_auth_with_access_token(self):",
            "        # Given a user with an access token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test').encode('ascii')",
            "        # When using this token to authenticated with /api",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\" + token).decode('ascii'))])",
            "        # Then authentication is successful",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_auth_failed_with_mfa_enabled(self):",
            "        # Given a user with MFA enabled",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.mfa = UserObject.ENABLED_MFA",
            "        userobj.add()",
            "        # When authenticating with /api/",
            "        self.getPage('/api/', headers=self.headers)",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "",
            "class APIRatelimitTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given invalid credentials sent to API",
            "        headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))]",
            "        for i in range(1, 5):",
            "            self.getPage('/api/', headers=headers)",
            "            self.assertStatus(401)",
            "        # Then the 6th request is refused",
            "        self.getPage('/api/', headers=headers)",
            "        self.assertStatus(429)",
            "        # Next request is also refused event if credentials are valid.",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus(429)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "",
            "from base64 import b64encode",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class APITest(rdiffweb.test.WebCase):",
            "",
            "    headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))]",
            "",
            "    def test_get_index(self):",
            "        data = self.getJson('/api/', headers=self.headers)",
            "        self.assertIsNotNone(data.get('version'))",
            "",
            "    def test_get_currentuser(self):",
            "        data = self.getJson('/api/currentuser/', headers=self.headers)",
            "        self.assertEqual(data.get('username'), 'admin')",
            "        self.assertEqual(data.get('email'), '')",
            "        # This value change on every execution.",
            "        self.assertEqual(2, len(data.get('repos')))",
            "        repo = data.get('repos')[1]",
            "        self.assertEqual(repo.get('keepdays'), -1)",
            "        self.assertEqual(repo.get('last_backup_date'), '2016-02-02T16:30:40-05:00')",
            "        self.assertEqual(repo.get('status'), 'ok')",
            "        self.assertEqual(repo.get('display_name'), 'testcases')",
            "        self.assertEqual(repo.get('encoding'), 'utf-8')",
            "        self.assertEqual(repo.get('name'), 'testcases')",
            "        self.assertEqual(repo.get('maxage'), 0)",
            "",
            "    def test_getapi_without_authorization(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/')",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_without_username(self):",
            "        \"\"\"",
            "        Check if error 401 is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\":admin123\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_empty_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_invalid_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_authorization(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getapi_with_session(self):",
            "        # Given an authenticate user",
            "        b = {'login': self.USERNAME, 'password': self.PASSWORD}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        # When querying the API",
            "        self.getPage('/api/')",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_auth_with_access_token(self):",
            "        # Given a user with an access token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test').encode('ascii')",
            "        userobj.commit()",
            "        # When using this token to authenticated with /api",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\" + token).decode('ascii'))])",
            "        # Then authentication is successful",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_auth_failed_with_mfa_enabled(self):",
            "        # Given a user with MFA enabled",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.mfa = UserObject.ENABLED_MFA",
            "        userobj.commit()",
            "        # When authenticating with /api/",
            "        self.getPage('/api/', headers=self.headers)",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "",
            "class APIRatelimitTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given invalid credentials sent to API",
            "        headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))]",
            "        for i in range(1, 5):",
            "            self.getPage('/api/', headers=headers)",
            "            self.assertStatus(401)",
            "        # Then the 6th request is refused",
            "        self.getPage('/api/', headers=headers)",
            "        self.assertStatus(429)",
            "        # Next request is also refused event if credentials are valid.",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus(429)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "113": [
                "APITest",
                "test_auth_failed_with_mfa_enabled"
            ]
        },
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/tests/test_controller.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": 178,
                "PatchRowcode": "         # When this session get old"
            },
            "1": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 179,
                "PatchRowcode": "         data = SessionObject.query.filter(SessionObject.id == self.session_id).first()"
            },
            "2": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 180,
                "PatchRowcode": "         data.expiration_time = datetime.datetime.now() - datetime.timedelta(seconds=1)"
            },
            "3": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        data.add()"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 181,
                "PatchRowcode": "+        data.commit()"
            },
            "5": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": 182,
                "PatchRowcode": "         session = DbSession(id=self.session_id)"
            },
            "6": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "         # Then the session get deleted by clean_up process"
            },
            "7": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": 184,
                "PatchRowcode": "         session.clean_up()"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Mar 13, 2019",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "import datetime",
            "",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import DbSession, SessionObject",
            "",
            "",
            "class ControllerTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    default_config = {'HeaderName': 'MyTest'}",
            "",
            "    def test_headername(self):",
            "        \"\"\"",
            "        Check if the headername is used in the page.",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('MyTest')",
            "",
            "    def test_proxy(self):",
            "        \"\"\"",
            "        Check if the headername is used in the page.",
            "        \"\"\"",
            "        self.getPage(\"/\", headers=[('Host', 'this.is.a.test.com')])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('http://this.is.a.test.com/favicon.ico')",
            "",
            "    def test_proxy_https(self):",
            "        \"\"\"",
            "        Check if the headername is used in the page.",
            "        \"\"\"",
            "        self.getPage(\"/\", headers=[('Host', 'this.is.a.test.com'), ('X-Forwarded-Proto', 'https')])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('https://this.is.a.test.com/favicon.ico')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            '/favicon.ico',",
            "            '/static/blue.css',",
            "            '/static/css/bootstrap.min.css',",
            "            '/static/css/font-awesome.min.css',",
            "            '/static/css/jquery.dataTables.min.css',",
            "            '/static/default.css',",
            "            '/static/js/bootstrap.bundle.min.js',",
            "            '/static/js/jquery.dataTables.min.js',",
            "            '/static/js/jquery.min.js',",
            "            '/static/js/rdiffweb.js',",
            "            '/static/orange.css',",
            "        ]",
            "    )",
            "    def test_static_files(self, path):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage('/logout')",
            "        self.getPage(path)",
            "        self.assertStatus(200)",
            "",
            "    def test_static_invalid_method(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/static/default.css\", method=\"POST\")",
            "        self.assertStatus(400)",
            "",
            "    def test_static_invalid_file(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/static/invalid.css\")",
            "        self.assertStatus(400)",
            "",
            "    def test_path_traversal(self):",
            "        self.getPage('/static//../../test.txt')",
            "        self.assertStatus(403)",
            "",
            "",
            "class ControllerOrangeThemeTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    default_config = {'DefaultTheme': 'orange'}",
            "",
            "    def test_static(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('/static/orange.css')",
            "",
            "",
            "class ControllerBlueThemeTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    default_config = {'DefaultTheme': 'blue'}",
            "",
            "    def test_theme(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertInBody('/static/blue.css')",
            "",
            "",
            "class ControllerSession(rdiffweb.test.WebCase):",
            "    def test_enrich_session_anonymous(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage('/', headers=[('User-Agent', 'test')])",
            "        # Then a session object is enriched",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNotNone(session.get('ip_address'))",
            "        self.assertIsNotNone(session.get('user_agent'))",
            "        self.assertIsNotNone(session.get('access_time'))",
            "",
            "    def test_enrich_session_authenticated(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage(",
            "            '/login/',",
            "            method='POST',",
            "            headers=[('User-Agent', 'test')],",
            "            body={'login': self.USERNAME, 'password': self.PASSWORD},",
            "        )",
            "        # Then a session object is enriched",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNotNone(session.get('ip_address'))",
            "        self.assertIsNotNone(session.get('user_agent'))",
            "        self.assertIsNotNone(session.get('access_time'))",
            "",
            "    def test_create_session(self):",
            "        # Given a server with no session.",
            "        self.assertEqual(0, len(SessionObject.query.all()))",
            "        # When querying a new page",
            "        self.getPage('/')",
            "        self.assertStatus(303)",
            "        # Then a new session get created",
            "        self.assertEqual(1, len(SessionObject.query.all()))",
            "        session = SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        self.assertIsNotNone(session)",
            "",
            "    def test_clean_up_session(self):",
            "        # Given a server with a session",
            "        self.getPage('/')",
            "        self.assertStatus(303)",
            "        self.assertEqual(1, len(SessionObject.query.all()))",
            "        # When this session get old",
            "        data = SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        data.expiration_time = datetime.datetime.now() - datetime.timedelta(seconds=1)",
            "        data.add()",
            "        session = DbSession(id=self.session_id)",
            "        # Then the session get deleted by clean_up process",
            "        session.clean_up()",
            "        # Then session is deleted",
            "        data = SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        self.assertIsNone(data)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Mar 13, 2019",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "import datetime",
            "",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import DbSession, SessionObject",
            "",
            "",
            "class ControllerTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    default_config = {'HeaderName': 'MyTest'}",
            "",
            "    def test_headername(self):",
            "        \"\"\"",
            "        Check if the headername is used in the page.",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('MyTest')",
            "",
            "    def test_proxy(self):",
            "        \"\"\"",
            "        Check if the headername is used in the page.",
            "        \"\"\"",
            "        self.getPage(\"/\", headers=[('Host', 'this.is.a.test.com')])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('http://this.is.a.test.com/favicon.ico')",
            "",
            "    def test_proxy_https(self):",
            "        \"\"\"",
            "        Check if the headername is used in the page.",
            "        \"\"\"",
            "        self.getPage(\"/\", headers=[('Host', 'this.is.a.test.com'), ('X-Forwarded-Proto', 'https')])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('https://this.is.a.test.com/favicon.ico')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            '/favicon.ico',",
            "            '/static/blue.css',",
            "            '/static/css/bootstrap.min.css',",
            "            '/static/css/font-awesome.min.css',",
            "            '/static/css/jquery.dataTables.min.css',",
            "            '/static/default.css',",
            "            '/static/js/bootstrap.bundle.min.js',",
            "            '/static/js/jquery.dataTables.min.js',",
            "            '/static/js/jquery.min.js',",
            "            '/static/js/rdiffweb.js',",
            "            '/static/orange.css',",
            "        ]",
            "    )",
            "    def test_static_files(self, path):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage('/logout')",
            "        self.getPage(path)",
            "        self.assertStatus(200)",
            "",
            "    def test_static_invalid_method(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/static/default.css\", method=\"POST\")",
            "        self.assertStatus(400)",
            "",
            "    def test_static_invalid_file(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/static/invalid.css\")",
            "        self.assertStatus(400)",
            "",
            "    def test_path_traversal(self):",
            "        self.getPage('/static//../../test.txt')",
            "        self.assertStatus(403)",
            "",
            "",
            "class ControllerOrangeThemeTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    default_config = {'DefaultTheme': 'orange'}",
            "",
            "    def test_static(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('/static/orange.css')",
            "",
            "",
            "class ControllerBlueThemeTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    default_config = {'DefaultTheme': 'blue'}",
            "",
            "    def test_theme(self):",
            "        \"\"\"",
            "        Check if the theme is properly configure.",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertInBody('/static/blue.css')",
            "",
            "",
            "class ControllerSession(rdiffweb.test.WebCase):",
            "    def test_enrich_session_anonymous(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage('/', headers=[('User-Agent', 'test')])",
            "        # Then a session object is enriched",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNotNone(session.get('ip_address'))",
            "        self.assertIsNotNone(session.get('user_agent'))",
            "        self.assertIsNotNone(session.get('access_time'))",
            "",
            "    def test_enrich_session_authenticated(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage(",
            "            '/login/',",
            "            method='POST',",
            "            headers=[('User-Agent', 'test')],",
            "            body={'login': self.USERNAME, 'password': self.PASSWORD},",
            "        )",
            "        # Then a session object is enriched",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNotNone(session.get('ip_address'))",
            "        self.assertIsNotNone(session.get('user_agent'))",
            "        self.assertIsNotNone(session.get('access_time'))",
            "",
            "    def test_create_session(self):",
            "        # Given a server with no session.",
            "        self.assertEqual(0, len(SessionObject.query.all()))",
            "        # When querying a new page",
            "        self.getPage('/')",
            "        self.assertStatus(303)",
            "        # Then a new session get created",
            "        self.assertEqual(1, len(SessionObject.query.all()))",
            "        session = SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        self.assertIsNotNone(session)",
            "",
            "    def test_clean_up_session(self):",
            "        # Given a server with a session",
            "        self.getPage('/')",
            "        self.assertStatus(303)",
            "        self.assertEqual(1, len(SessionObject.query.all()))",
            "        # When this session get old",
            "        data = SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        data.expiration_time = datetime.datetime.now() - datetime.timedelta(seconds=1)",
            "        data.commit()",
            "        session = DbSession(id=self.session_id)",
            "        # Then the session get deleted by clean_up process",
            "        session.clean_up()",
            "        # Then session is deleted",
            "        data = SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        self.assertIsNone(data)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "181": [
                "ControllerSession",
                "test_clean_up_session"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_admin.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": "     def setUp(self):"
            },
            "1": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": "         super().setUp()"
            },
            "2": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": "         # Add test user"
            },
            "3": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        UserObject.add_user('test', 'test123')"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+        userobj = UserObject.add_user('test', 'test123')"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+        userobj.commit()"
            },
            "6": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 28,
                "PatchRowcode": "         self._login('test', 'test123')"
            },
            "7": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "     @parameterized.expand("
            }
        },
        "frontPatchFile": [
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class AdminPagesAsUser(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        # Add test user",
            "        UserObject.add_user('test', 'test123')",
            "        self._login('test', 'test123')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            \"/admin\",",
            "            \"/admin/users\",",
            "            \"/admin/repos\",",
            "            \"/admin/session\",",
            "            \"/admin/sysinfo\",",
            "            \"/admin/logs\",",
            "        ]",
            "    )",
            "    def test_forbidden_access(self, value):",
            "        self.getPage(value)",
            "        self.assertStatus(403)"
        ],
        "afterPatchFile": [
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class AdminPagesAsUser(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        # Add test user",
            "        userobj = UserObject.add_user('test', 'test123')",
            "        userobj.commit()",
            "        self._login('test', 'test123')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            \"/admin\",",
            "            \"/admin/users\",",
            "            \"/admin/repos\",",
            "            \"/admin/session\",",
            "            \"/admin/sysinfo\",",
            "            \"/admin/logs\",",
            "        ]",
            "    )",
            "    def test_forbidden_access(self, value):",
            "        self.getPage(value)",
            "        self.assertStatus(403)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "26": [
                "AdminPagesAsUser",
                "setUp"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_admin_users.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 337,
                "afterPatchRowNumber": 337,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 338,
                "afterPatchRowNumber": 338,
                "PatchRowcode": "     def test_delete_user_method_get(self):"
            },
            "2": {
                "beforePatchRowNumber": 339,
                "afterPatchRowNumber": 339,
                "PatchRowcode": "         # Given a user"
            },
            "3": {
                "beforePatchRowNumber": 340,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        UserObject.add_user('newuser')"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 340,
                "PatchRowcode": "+        user = UserObject.add_user('newuser')"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 341,
                "PatchRowcode": "+        user.commit()"
            },
            "6": {
                "beforePatchRowNumber": 341,
                "afterPatchRowNumber": 342,
                "PatchRowcode": "         # When trying to delete this user using method GET"
            },
            "7": {
                "beforePatchRowNumber": 342,
                "afterPatchRowNumber": 343,
                "PatchRowcode": "         self.getPage(\"/admin/users/?action=delete&username=newuser\", method='GET')"
            },
            "8": {
                "beforePatchRowNumber": 343,
                "afterPatchRowNumber": 344,
                "PatchRowcode": "         # Then page return without error"
            },
            "9": {
                "beforePatchRowNumber": 370,
                "afterPatchRowNumber": 371,
                "PatchRowcode": "         \"\"\""
            },
            "10": {
                "beforePatchRowNumber": 371,
                "afterPatchRowNumber": 372,
                "PatchRowcode": "         Verify failure trying to update user with invalid path."
            },
            "11": {
                "beforePatchRowNumber": 372,
                "afterPatchRowNumber": 373,
                "PatchRowcode": "         \"\"\""
            },
            "12": {
                "beforePatchRowNumber": 373,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        UserObject.add_user('test1')"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 374,
                "PatchRowcode": "+        userobj = UserObject.add_user('test1')"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 375,
                "PatchRowcode": "+        userobj.commit()"
            },
            "15": {
                "beforePatchRowNumber": 374,
                "afterPatchRowNumber": 376,
                "PatchRowcode": "         self._edit_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)"
            },
            "16": {
                "beforePatchRowNumber": 375,
                "afterPatchRowNumber": 377,
                "PatchRowcode": "         self.assertNotInBody(\"User added successfully.\")"
            },
            "17": {
                "beforePatchRowNumber": 376,
                "afterPatchRowNumber": 378,
                "PatchRowcode": "         self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")"
            },
            "18": {
                "beforePatchRowNumber": 397,
                "afterPatchRowNumber": 399,
                "PatchRowcode": "         # Delete all user's"
            },
            "19": {
                "beforePatchRowNumber": 398,
                "afterPatchRowNumber": 400,
                "PatchRowcode": "         for user in UserObject.query.all():"
            },
            "20": {
                "beforePatchRowNumber": 399,
                "afterPatchRowNumber": 401,
                "PatchRowcode": "             if user.username != self.USERNAME:"
            },
            "21": {
                "beforePatchRowNumber": 400,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                user.delete()"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 402,
                "PatchRowcode": "+                user.delete().commit()"
            },
            "23": {
                "beforePatchRowNumber": 401,
                "afterPatchRowNumber": 403,
                "PatchRowcode": "         # Change the user's root"
            },
            "24": {
                "beforePatchRowNumber": 402,
                "afterPatchRowNumber": 404,
                "PatchRowcode": "         user = UserObject.get_user('admin')"
            },
            "25": {
                "beforePatchRowNumber": 403,
                "afterPatchRowNumber": 405,
                "PatchRowcode": "         user.user_root = \"/invalid\""
            },
            "26": {
                "beforePatchRowNumber": 404,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        user.add()"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 406,
                "PatchRowcode": "+        user.commit()"
            },
            "28": {
                "beforePatchRowNumber": 405,
                "afterPatchRowNumber": 407,
                "PatchRowcode": "         self.getPage(\"/admin/users\")"
            },
            "29": {
                "beforePatchRowNumber": 406,
                "afterPatchRowNumber": 408,
                "PatchRowcode": "         self.assertInBody(\"Root directory not accessible!\")"
            },
            "30": {
                "beforePatchRowNumber": 407,
                "afterPatchRowNumber": 409,
                "PatchRowcode": " "
            },
            "31": {
                "beforePatchRowNumber": 408,
                "afterPatchRowNumber": 410,
                "PatchRowcode": "         # Query the page by default"
            },
            "32": {
                "beforePatchRowNumber": 409,
                "afterPatchRowNumber": 411,
                "PatchRowcode": "         user = UserObject.get_user('admin')"
            },
            "33": {
                "beforePatchRowNumber": 410,
                "afterPatchRowNumber": 412,
                "PatchRowcode": "         user.user_root = \"/tmp/\""
            },
            "34": {
                "beforePatchRowNumber": 411,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        user.add()"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 413,
                "PatchRowcode": "+        user.commit()"
            },
            "36": {
                "beforePatchRowNumber": 412,
                "afterPatchRowNumber": 414,
                "PatchRowcode": "         self.getPage(\"/admin/users\")"
            },
            "37": {
                "beforePatchRowNumber": 413,
                "afterPatchRowNumber": 415,
                "PatchRowcode": "         self.assertNotInBody(\"Root directory not accessible!\")"
            },
            "38": {
                "beforePatchRowNumber": 414,
                "afterPatchRowNumber": 416,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "from unittest.mock import ANY, MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class AbstractAdminTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self._quota = {}",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        self.listener.get_disk_quota.side_effect = self._load_quota",
            "        cherrypy.engine.subscribe('get_disk_quota', self.listener.get_disk_quota, priority=40)",
            "        self.listener.get_disk_usage.return_value = 0",
            "        cherrypy.engine.subscribe('get_disk_usage', self.listener.get_disk_usage, priority=40)",
            "        self.listener.set_disk_quota.side_effect = self._store_quota",
            "        cherrypy.engine.subscribe('set_disk_quota', self.listener.set_disk_quota, priority=40)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        cherrypy.engine.unsubscribe('get_disk_quota', self.listener.get_disk_quota)",
            "        cherrypy.engine.unsubscribe('get_disk_usage', self.listener.get_disk_usage)",
            "        cherrypy.engine.unsubscribe('set_disk_quota', self.listener.set_disk_quota)",
            "        return super().tearDown()",
            "",
            "    def _store_quota(self, userobj, value):",
            "        self._quota[userobj.username] = value",
            "",
            "    def _load_quota(self, userobj):",
            "        return self._quota.get(userobj.username, 0)",
            "",
            "    def _add_user(self, username=None, email=None, password=None, user_root=None, role=None, mfa=None, fullname=None):",
            "        b = {}",
            "        b['action'] = 'add'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        if fullname is not None:",
            "            b['fullname'] = str(fullname)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _edit_user(",
            "        self, username=None, email=None, password=None, user_root=None, role=None, disk_quota=None, mfa=None",
            "    ):",
            "        b = {}",
            "        b['action'] = 'edit'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if disk_quota is not None:",
            "            b['disk_quota'] = disk_quota",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _delete_user(self, username='test1'):",
            "        b = {'action': 'delete', 'username': username}",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def test_add_user_with_role_admin(self):",
            "        # When trying to create a new user with role admin",
            "        self._add_user(\"admin_role\", \"admin_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.ADMIN_ROLE)",
            "        # Then page return success",
            "        self.assertStatus(200)",
            "        # Then database is updated",
            "        userobj = UserObject.get_user('admin_role')",
            "        self.assertEqual(UserObject.ADMIN_ROLE, userobj.role)",
            "        # Then notification was raised",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_with_role_maintainer(self):",
            "        self._add_user(\"maintainer_role\", \"maintainer_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.MAINTAINER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.MAINTAINER_ROLE, UserObject.get_user('maintainer_role').role)",
            "",
            "    def test_add_user_with_role_user(self):",
            "        self._add_user(\"user_role\", \"user_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.USER_ROLE, UserObject.get_user('user_role').role)",
            "",
            "    def test_add_user_with_invalid_role(self):",
            "        # When trying to create a new user with an invalid role (admin instead of 0)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", 'admin')",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('Role: Invalid Choice: could not coerce')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "        # When trying to create a new user with an invalid role (-1)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", -1)",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('User Role: Not a valid choice')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_edit_delete(self):",
            "        #  Add user to be listed",
            "        self.listener.user_password_changed.reset_mock()",
            "        self._add_user(",
            "            \"test2\", \"test2@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE, mfa=UserObject.DISABLED_MFA",
            "        )",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"test2@test.com\")",
            "        self.listener.user_added.assert_called_once()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.listener.user_password_changed.reset_mock()",
            "        #  Update user",
            "        self._edit_user(",
            "            \"test2\", \"chaned@test.com\", \"new-password\", \"/tmp/\", UserObject.ADMIN_ROLE, mfa=UserObject.ENABLED_MFA",
            "        )",
            "        self.listener.user_attr_changed.assert_called()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"chaned@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "",
            "        self._delete_user(\"test2\")",
            "        self.listener.user_deleted.assert_called()",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"test2\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('evil.com', False),",
            "            ('http://test', False),",
            "            ('email@test.test', False),",
            "            ('/test/', False),",
            "            # Valid",
            "            ('My fullname', True),",
            "            ('Test Test', True),",
            "            ('\u00c9ric Terrien-Pascal', True),",
            "            (\"Tel'c\", True),",
            "        ]",
            "    )",
            "    def test_edit_fullname_with_special_character(self, new_fullname, expected_valid):",
            "        # Given an existing user",
            "        # When updating the user's fullname",
            "        self.getPage(",
            "            \"/admin/users/\",",
            "            method='POST',",
            "            body={'action': 'edit', 'username': self.USERNAME, 'fullname': new_fullname},",
            "        )",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"User information modified successfully.\")",
            "            self.assertNotInBody(\"Fullname: Must not contain any special characters.\")",
            "        else:",
            "            self.assertNotInBody(\"User information modified successfully.\")",
            "            self.assertInBody(\"Fullname: Must not contain any special characters.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('http://username', False),",
            "            ('username@test.test', False),",
            "            ('/username/', False),",
            "            # Valid",
            "            ('username.com', True),",
            "            ('admin_user', True),",
            "            ('test.test', True),",
            "            ('test-test', True),",
            "        ]",
            "    )",
            "    def test_add_user_with_special_character(self, new_username, expected_valid):",
            "        self._add_user(new_username, \"eric@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"User added successfully.\")",
            "            self.assertNotInBody(\"Username: Must not contain any special characters.\")",
            "        else:",
            "            self.assertNotInBody(\"User added successfully.\")",
            "            self.assertInBody(\"Username: Must not contain any special characters.\")",
            "",
            "    def test_add_user_with_empty_username(self):",
            "        \"\"\"",
            "        Verify failure trying to create user without username.",
            "        \"\"\"",
            "        self._add_user(\"\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username: This field is required.\")",
            "",
            "    def test_add_user_with_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to add the same user.",
            "        \"\"\"",
            "        # Given a user named `test1`",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # When trying to create a new user with the same name",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message.",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User test1 already exists.\")",
            "",
            "    def test_add_user_with_invalid_root_directory(self):",
            "        \"\"\"",
            "        Verify failure to add a user with invalid root directory.",
            "        \"\"\"",
            "        try:",
            "            self._delete_user(\"test5\")",
            "        except Exception:",
            "            pass",
            "        self._add_user(\"test5\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_add_without_email(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "    def test_add_without_user_root(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test6\", None, \"pr3j5Dwi\", None, UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "        user = UserObject.get_user('test6')",
            "        self.assertEqual('', user.user_root)",
            "",
            "    def test_add_with_username_too_long(self):",
            "        # Given a too long username",
            "        username = \"test2\" * 52",
            "        # When trying to create the user",
            "        self._add_user(username, None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username too long.\")",
            "",
            "    def test_add_with_email_too_long(self):",
            "        # Given a too long username",
            "        email = (\"test2\" * 50) + \"@test.com\"",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", email, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_add_with_user_root_too_long(self):",
            "        # Given a too long user root",
            "        user_root = \"/temp/\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", user_root, UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Root directory too long.\")",
            "",
            "    def test_add_with_fullname_too_long(self):",
            "        # Given a too long user root",
            "        fullname = \"fullname\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE, fullname=fullname)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Fullname too long.\")",
            "",
            "    def test_delete_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure to delete invalid username.",
            "        \"\"\"",
            "        self._delete_user(\"test3\")",
            "        self.assertInBody(\"User doesn&#39;t exists!\")",
            "",
            "    def test_delete_our_self(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        self._delete_user(self.USERNAME)",
            "        self.assertInBody(\"You cannot remove your own account!\")",
            "",
            "    def test_delete_user_admin(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        # Create another admin user",
            "        self._add_user('admin2', '', 'pr3j5Dwi', '', UserObject.ADMIN_ROLE)",
            "        self.getPage(\"/logout\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        self._login('admin2', 'pr3j5Dwi')",
            "",
            "        # Try deleting admin user",
            "        self._delete_user(self.USERNAME)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"can&#39;t delete admin user\")",
            "",
            "    def test_delete_user_method_get(self):",
            "        # Given a user",
            "        UserObject.add_user('newuser')",
            "        # When trying to delete this user using method GET",
            "        self.getPage(\"/admin/users/?action=delete&username=newuser\", method='GET')",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then user is not deleted",
            "        self.assertIsNotNone(UserObject.get_user('newuser'))",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._edit_user(self.USERNAME, password='short')",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._edit_user(self.USERNAME, password=new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_admin_password(self):",
            "        # Given rdiffweb is configured with admin-password option",
            "        self.app.cfg.admin_password = 'hardcoded'",
            "        try:",
            "            # When trying to update admin password",
            "            self._edit_user('admin', password='new-password')",
            "            # Then the form is refused with 200 OK with an error message.",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"can&#39;t update admin-password defined in configuration file\")",
            "        finally:",
            "            self.app.cfg.admin_password = None",
            "",
            "    def test_edit_user_with_invalid_path(self):",
            "        \"\"\"",
            "        Verify failure trying to update user with invalid path.",
            "        \"\"\"",
            "        UserObject.add_user('test1')",
            "        self._edit_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertNotInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_list(self):",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertInBody(\"Users\")",
            "        self.assertInBody(\"User management\")",
            "        self.assertInBody(\"Add user\")",
            "",
            "    def test_edit_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to update invalid user.",
            "        \"\"\"",
            "        # Given an invalid username",
            "        username = 'invalid'",
            "        # When trying to edit the user",
            "        self._edit_user(username, \"test1@test.com\", \"test\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit user `invalid`: user doesn&#39;t exists\")",
            "",
            "    def test_user_invalid_root(self):",
            "        # Delete all user's",
            "        for user in UserObject.query.all():",
            "            if user.username != self.USERNAME:",
            "                user.delete()",
            "        # Change the user's root",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/invalid\"",
            "        user.add()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertInBody(\"Root directory not accessible!\")",
            "",
            "        # Query the page by default",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/tmp/\"",
            "        user.add()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertNotInBody(\"Root directory not accessible!\")",
            "",
            "    def test_get_quota(self):",
            "        # Mock a quota.",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 654321",
            "        # When querying the user list",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertStatus(200)",
            "        # Then get_disk_quota listenre is called",
            "        self.listener.get_disk_quota.assert_called()",
            "        # Then the quota value is displayed in human readable format",
            "        self.assertInBody(\"638.99 KiB\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota(self):",
            "        # When updating user quota.",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then listenr get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_gib(self):",
            "        # When updating user quota",
            "        self._edit_user(\"admin\", disk_quota='1GiB')",
            "        # Then listern get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1073741824)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_comma(self):",
            "        # When updating quota with comma value",
            "        self._edit_user(\"admin\", disk_quota='1,5 GiB')",
            "        # Then listner get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1610612736)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_leading_dot(self):",
            "        # When updating quota with leading dot",
            "        self._edit_user(\"admin\", disk_quota='.5 GiB')",
            "        # Then listener get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 536870912)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_empty(self):",
            "        # When quota is not defined",
            "        self._edit_user(\"admin\", disk_quota='')",
            "        # Then listener is not called.",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_same_value(self):",
            "        # Given an exiting quota",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 1234567890",
            "        # When setting the quota value to the same value",
            "        self._edit_user(\"admin\", disk_quota='1.15 GiB')",
            "        #  Then listener is not called",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_unsupported(self):",
            "        # Given setting quota is not supported",
            "        self.listener.set_disk_quota.side_effect = None",
            "        self.listener.set_disk_quota.return_value = None",
            "        # When updating the quota",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        self.assertInBody(\"Setting user&#39;s quota is not supported\")",
            "        self.assertStatus(200)",
            "",
            "    def test_edit_own_role(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, role=UserObject.MAINTAINER_ROLE)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit your own role.\")",
            "",
            "    def test_edit_own_mfa(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, mfa=UserObject.ENABLED_MFA)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot change your own two-factor authentication settings.\")"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "from unittest.mock import ANY, MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class AbstractAdminTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self._quota = {}",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        self.listener.get_disk_quota.side_effect = self._load_quota",
            "        cherrypy.engine.subscribe('get_disk_quota', self.listener.get_disk_quota, priority=40)",
            "        self.listener.get_disk_usage.return_value = 0",
            "        cherrypy.engine.subscribe('get_disk_usage', self.listener.get_disk_usage, priority=40)",
            "        self.listener.set_disk_quota.side_effect = self._store_quota",
            "        cherrypy.engine.subscribe('set_disk_quota', self.listener.set_disk_quota, priority=40)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        cherrypy.engine.unsubscribe('get_disk_quota', self.listener.get_disk_quota)",
            "        cherrypy.engine.unsubscribe('get_disk_usage', self.listener.get_disk_usage)",
            "        cherrypy.engine.unsubscribe('set_disk_quota', self.listener.set_disk_quota)",
            "        return super().tearDown()",
            "",
            "    def _store_quota(self, userobj, value):",
            "        self._quota[userobj.username] = value",
            "",
            "    def _load_quota(self, userobj):",
            "        return self._quota.get(userobj.username, 0)",
            "",
            "    def _add_user(self, username=None, email=None, password=None, user_root=None, role=None, mfa=None, fullname=None):",
            "        b = {}",
            "        b['action'] = 'add'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        if fullname is not None:",
            "            b['fullname'] = str(fullname)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _edit_user(",
            "        self, username=None, email=None, password=None, user_root=None, role=None, disk_quota=None, mfa=None",
            "    ):",
            "        b = {}",
            "        b['action'] = 'edit'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if disk_quota is not None:",
            "            b['disk_quota'] = disk_quota",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _delete_user(self, username='test1'):",
            "        b = {'action': 'delete', 'username': username}",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def test_add_user_with_role_admin(self):",
            "        # When trying to create a new user with role admin",
            "        self._add_user(\"admin_role\", \"admin_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.ADMIN_ROLE)",
            "        # Then page return success",
            "        self.assertStatus(200)",
            "        # Then database is updated",
            "        userobj = UserObject.get_user('admin_role')",
            "        self.assertEqual(UserObject.ADMIN_ROLE, userobj.role)",
            "        # Then notification was raised",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_with_role_maintainer(self):",
            "        self._add_user(\"maintainer_role\", \"maintainer_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.MAINTAINER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.MAINTAINER_ROLE, UserObject.get_user('maintainer_role').role)",
            "",
            "    def test_add_user_with_role_user(self):",
            "        self._add_user(\"user_role\", \"user_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.USER_ROLE, UserObject.get_user('user_role').role)",
            "",
            "    def test_add_user_with_invalid_role(self):",
            "        # When trying to create a new user with an invalid role (admin instead of 0)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", 'admin')",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('Role: Invalid Choice: could not coerce')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "        # When trying to create a new user with an invalid role (-1)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", -1)",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('User Role: Not a valid choice')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_edit_delete(self):",
            "        #  Add user to be listed",
            "        self.listener.user_password_changed.reset_mock()",
            "        self._add_user(",
            "            \"test2\", \"test2@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE, mfa=UserObject.DISABLED_MFA",
            "        )",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"test2@test.com\")",
            "        self.listener.user_added.assert_called_once()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.listener.user_password_changed.reset_mock()",
            "        #  Update user",
            "        self._edit_user(",
            "            \"test2\", \"chaned@test.com\", \"new-password\", \"/tmp/\", UserObject.ADMIN_ROLE, mfa=UserObject.ENABLED_MFA",
            "        )",
            "        self.listener.user_attr_changed.assert_called()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"chaned@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "",
            "        self._delete_user(\"test2\")",
            "        self.listener.user_deleted.assert_called()",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"test2\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('evil.com', False),",
            "            ('http://test', False),",
            "            ('email@test.test', False),",
            "            ('/test/', False),",
            "            # Valid",
            "            ('My fullname', True),",
            "            ('Test Test', True),",
            "            ('\u00c9ric Terrien-Pascal', True),",
            "            (\"Tel'c\", True),",
            "        ]",
            "    )",
            "    def test_edit_fullname_with_special_character(self, new_fullname, expected_valid):",
            "        # Given an existing user",
            "        # When updating the user's fullname",
            "        self.getPage(",
            "            \"/admin/users/\",",
            "            method='POST',",
            "            body={'action': 'edit', 'username': self.USERNAME, 'fullname': new_fullname},",
            "        )",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"User information modified successfully.\")",
            "            self.assertNotInBody(\"Fullname: Must not contain any special characters.\")",
            "        else:",
            "            self.assertNotInBody(\"User information modified successfully.\")",
            "            self.assertInBody(\"Fullname: Must not contain any special characters.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('http://username', False),",
            "            ('username@test.test', False),",
            "            ('/username/', False),",
            "            # Valid",
            "            ('username.com', True),",
            "            ('admin_user', True),",
            "            ('test.test', True),",
            "            ('test-test', True),",
            "        ]",
            "    )",
            "    def test_add_user_with_special_character(self, new_username, expected_valid):",
            "        self._add_user(new_username, \"eric@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"User added successfully.\")",
            "            self.assertNotInBody(\"Username: Must not contain any special characters.\")",
            "        else:",
            "            self.assertNotInBody(\"User added successfully.\")",
            "            self.assertInBody(\"Username: Must not contain any special characters.\")",
            "",
            "    def test_add_user_with_empty_username(self):",
            "        \"\"\"",
            "        Verify failure trying to create user without username.",
            "        \"\"\"",
            "        self._add_user(\"\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username: This field is required.\")",
            "",
            "    def test_add_user_with_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to add the same user.",
            "        \"\"\"",
            "        # Given a user named `test1`",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # When trying to create a new user with the same name",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message.",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User test1 already exists.\")",
            "",
            "    def test_add_user_with_invalid_root_directory(self):",
            "        \"\"\"",
            "        Verify failure to add a user with invalid root directory.",
            "        \"\"\"",
            "        try:",
            "            self._delete_user(\"test5\")",
            "        except Exception:",
            "            pass",
            "        self._add_user(\"test5\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_add_without_email(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "    def test_add_without_user_root(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test6\", None, \"pr3j5Dwi\", None, UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "        user = UserObject.get_user('test6')",
            "        self.assertEqual('', user.user_root)",
            "",
            "    def test_add_with_username_too_long(self):",
            "        # Given a too long username",
            "        username = \"test2\" * 52",
            "        # When trying to create the user",
            "        self._add_user(username, None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username too long.\")",
            "",
            "    def test_add_with_email_too_long(self):",
            "        # Given a too long username",
            "        email = (\"test2\" * 50) + \"@test.com\"",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", email, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_add_with_user_root_too_long(self):",
            "        # Given a too long user root",
            "        user_root = \"/temp/\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", user_root, UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Root directory too long.\")",
            "",
            "    def test_add_with_fullname_too_long(self):",
            "        # Given a too long user root",
            "        fullname = \"fullname\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE, fullname=fullname)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Fullname too long.\")",
            "",
            "    def test_delete_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure to delete invalid username.",
            "        \"\"\"",
            "        self._delete_user(\"test3\")",
            "        self.assertInBody(\"User doesn&#39;t exists!\")",
            "",
            "    def test_delete_our_self(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        self._delete_user(self.USERNAME)",
            "        self.assertInBody(\"You cannot remove your own account!\")",
            "",
            "    def test_delete_user_admin(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        # Create another admin user",
            "        self._add_user('admin2', '', 'pr3j5Dwi', '', UserObject.ADMIN_ROLE)",
            "        self.getPage(\"/logout\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        self._login('admin2', 'pr3j5Dwi')",
            "",
            "        # Try deleting admin user",
            "        self._delete_user(self.USERNAME)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"can&#39;t delete admin user\")",
            "",
            "    def test_delete_user_method_get(self):",
            "        # Given a user",
            "        user = UserObject.add_user('newuser')",
            "        user.commit()",
            "        # When trying to delete this user using method GET",
            "        self.getPage(\"/admin/users/?action=delete&username=newuser\", method='GET')",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then user is not deleted",
            "        self.assertIsNotNone(UserObject.get_user('newuser'))",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._edit_user(self.USERNAME, password='short')",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._edit_user(self.USERNAME, password=new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_admin_password(self):",
            "        # Given rdiffweb is configured with admin-password option",
            "        self.app.cfg.admin_password = 'hardcoded'",
            "        try:",
            "            # When trying to update admin password",
            "            self._edit_user('admin', password='new-password')",
            "            # Then the form is refused with 200 OK with an error message.",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"can&#39;t update admin-password defined in configuration file\")",
            "        finally:",
            "            self.app.cfg.admin_password = None",
            "",
            "    def test_edit_user_with_invalid_path(self):",
            "        \"\"\"",
            "        Verify failure trying to update user with invalid path.",
            "        \"\"\"",
            "        userobj = UserObject.add_user('test1')",
            "        userobj.commit()",
            "        self._edit_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertNotInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_list(self):",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertInBody(\"Users\")",
            "        self.assertInBody(\"User management\")",
            "        self.assertInBody(\"Add user\")",
            "",
            "    def test_edit_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to update invalid user.",
            "        \"\"\"",
            "        # Given an invalid username",
            "        username = 'invalid'",
            "        # When trying to edit the user",
            "        self._edit_user(username, \"test1@test.com\", \"test\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit user `invalid`: user doesn&#39;t exists\")",
            "",
            "    def test_user_invalid_root(self):",
            "        # Delete all user's",
            "        for user in UserObject.query.all():",
            "            if user.username != self.USERNAME:",
            "                user.delete().commit()",
            "        # Change the user's root",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/invalid\"",
            "        user.commit()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertInBody(\"Root directory not accessible!\")",
            "",
            "        # Query the page by default",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/tmp/\"",
            "        user.commit()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertNotInBody(\"Root directory not accessible!\")",
            "",
            "    def test_get_quota(self):",
            "        # Mock a quota.",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 654321",
            "        # When querying the user list",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertStatus(200)",
            "        # Then get_disk_quota listenre is called",
            "        self.listener.get_disk_quota.assert_called()",
            "        # Then the quota value is displayed in human readable format",
            "        self.assertInBody(\"638.99 KiB\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota(self):",
            "        # When updating user quota.",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then listenr get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_gib(self):",
            "        # When updating user quota",
            "        self._edit_user(\"admin\", disk_quota='1GiB')",
            "        # Then listern get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1073741824)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_comma(self):",
            "        # When updating quota with comma value",
            "        self._edit_user(\"admin\", disk_quota='1,5 GiB')",
            "        # Then listner get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1610612736)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_leading_dot(self):",
            "        # When updating quota with leading dot",
            "        self._edit_user(\"admin\", disk_quota='.5 GiB')",
            "        # Then listener get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 536870912)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_empty(self):",
            "        # When quota is not defined",
            "        self._edit_user(\"admin\", disk_quota='')",
            "        # Then listener is not called.",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_same_value(self):",
            "        # Given an exiting quota",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 1234567890",
            "        # When setting the quota value to the same value",
            "        self._edit_user(\"admin\", disk_quota='1.15 GiB')",
            "        #  Then listener is not called",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_unsupported(self):",
            "        # Given setting quota is not supported",
            "        self.listener.set_disk_quota.side_effect = None",
            "        self.listener.set_disk_quota.return_value = None",
            "        # When updating the quota",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        self.assertInBody(\"Setting user&#39;s quota is not supported\")",
            "        self.assertStatus(200)",
            "",
            "    def test_edit_own_role(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, role=UserObject.MAINTAINER_ROLE)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit your own role.\")",
            "",
            "    def test_edit_own_mfa(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, mfa=UserObject.ENABLED_MFA)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot change your own two-factor authentication settings.\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "340": [
                "AbstractAdminTest",
                "test_delete_user_method_get"
            ],
            "373": [
                "AbstractAdminTest",
                "test_edit_user_with_invalid_path"
            ],
            "400": [
                "AbstractAdminTest",
                "test_user_invalid_root"
            ],
            "404": [
                "AbstractAdminTest",
                "test_user_invalid_root"
            ],
            "411": [
                "AbstractAdminTest",
                "test_user_invalid_root"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_browse.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 49,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "     def test_locations_with_broken_tree(self):"
            },
            "2": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         userobj = UserObject.get_user(self.USERNAME)"
            },
            "3": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        RepoObject(userid=userobj.userid, repopath='testcases/broker-repo').add()"
            },
            "4": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        RepoObject(userid=userobj.userid, repopath='testcases/testcases').add()"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+        RepoObject(userid=userobj.userid, repopath='testcases/broker-repo').add().commit()"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+        RepoObject(userid=userobj.userid, repopath='testcases/testcases').add().commit()"
            },
            "7": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "         self.getPage(\"/\")"
            },
            "8": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 55,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "     def test_WithRelativePath(self):"
            },
            "10": {
                "beforePatchRowNumber": 229,
                "afterPatchRowNumber": 229,
                "PatchRowcode": "         user = UserObject.get_user(self.USERNAME)"
            },
            "11": {
                "beforePatchRowNumber": 230,
                "afterPatchRowNumber": 230,
                "PatchRowcode": "         user.user_root = os.path.join(self.testcases, 'testcases')"
            },
            "12": {
                "beforePatchRowNumber": 231,
                "afterPatchRowNumber": 231,
                "PatchRowcode": "         user.refresh_repos()"
            },
            "13": {
                "beforePatchRowNumber": 232,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        user.add()"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 232,
                "PatchRowcode": "+        user.commit()"
            },
            "15": {
                "beforePatchRowNumber": 233,
                "afterPatchRowNumber": 233,
                "PatchRowcode": "         self.assertEqual(['', 'broker-repo', 'testcases'], [r.name for r in user.repo_objs])"
            },
            "16": {
                "beforePatchRowNumber": 234,
                "afterPatchRowNumber": 234,
                "PatchRowcode": "         # Check if listing locations is working"
            },
            "17": {
                "beforePatchRowNumber": 235,
                "afterPatchRowNumber": 235,
                "PatchRowcode": "         self.getPage('/')"
            },
            "18": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": 249,
                "PatchRowcode": "         user_obj = UserObject.add_user('anotheruser', 'password')"
            },
            "19": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": 250,
                "PatchRowcode": "         user_obj.user_root = self.testcases"
            },
            "20": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": 251,
                "PatchRowcode": "         user_obj.refresh_repos()"
            },
            "21": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        user_obj.add()"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+        user_obj.commit()"
            },
            "23": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": 253,
                "PatchRowcode": "         self.getPage('/browse/admin')"
            },
            "24": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": 254,
                "PatchRowcode": "         self.assertStatus('404 Not Found')"
            },
            "25": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": 255,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": 265,
                "PatchRowcode": "         # Remove admin role."
            },
            "27": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": 266,
                "PatchRowcode": "         admin = UserObject.get_user('admin')"
            },
            "28": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": 267,
                "PatchRowcode": "         admin.role = UserObject.USER_ROLE"
            },
            "29": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        admin.add()"
            },
            "30": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": 268,
                "PatchRowcode": "         admin.refresh_repos()"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 269,
                "PatchRowcode": "+        admin.commit()"
            },
            "32": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 270,
                "PatchRowcode": " "
            },
            "33": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": 271,
                "PatchRowcode": "         # Browse other user's repos"
            },
            "34": {
                "beforePatchRowNumber": 272,
                "afterPatchRowNumber": 272,
                "PatchRowcode": "         self.getPage('/browse/anotheruser/testcases')"
            },
            "35": {
                "beforePatchRowNumber": 278,
                "afterPatchRowNumber": 278,
                "PatchRowcode": "         # Given a failed repo"
            },
            "36": {
                "beforePatchRowNumber": 279,
                "afterPatchRowNumber": 279,
                "PatchRowcode": "         admin = UserObject.get_user('admin')"
            },
            "37": {
                "beforePatchRowNumber": 280,
                "afterPatchRowNumber": 280,
                "PatchRowcode": "         admin.user_root = 'invalid'"
            },
            "38": {
                "beforePatchRowNumber": 281,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        admin.add()"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 281,
                "PatchRowcode": "+        admin.commit()"
            },
            "40": {
                "beforePatchRowNumber": 282,
                "afterPatchRowNumber": 282,
                "PatchRowcode": "         # When querying the logs"
            },
            "41": {
                "beforePatchRowNumber": 283,
                "afterPatchRowNumber": 283,
                "PatchRowcode": "         self._browse(self.USERNAME, self.REPO, '')"
            },
            "42": {
                "beforePatchRowNumber": 284,
                "afterPatchRowNumber": 284,
                "PatchRowcode": "         # Then the page is return with an error message"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "import os",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class BrowsePageTest(rdiffweb.test.WebCase):",
            "    \"\"\"Basic python call to page_browse\"\"\"",
            "",
            "    login = True",
            "",
            "    def tearDown(self):",
            "        super().tearDown()",
            "",
            "    def _browse(self, user, repo, path):",
            "        url = \"/browse/\" + user + \"/\" + repo + \"/\" + path",
            "        self.getPage(url)",
            "",
            "    def test_locations(self):",
            "        \"\"\"",
            "        Check page_locations",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertInBody(self.REPO)",
            "        self.assertInBody('testcases')",
            "",
            "    def test_locations_with_broken_tree(self):",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='testcases/broker-repo').add()",
            "        RepoObject(userid=userobj.userid, repopath='testcases/testcases').add()",
            "        self.getPage(\"/\")",
            "",
            "    def test_WithRelativePath(self):",
            "        \"\"\"",
            "        Check if relative path are resolved.",
            "        \"\"\"",
            "        self._browse(",
            "            self.USERNAME,",
            "            self.REPO,",
            "            \"../%s/Revisions/../../%s/\"",
            "            % (",
            "                self.REPO,",
            "                self.REPO,",
            "            ),",
            "        )",
            "        self.assertInBody(\"\")",
            "",
            "    def test_root(self):",
            "        \"\"\"",
            "        Browse repository root.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"\")",
            "        #  Fichier @ <root>",
            "        self.assertInBody(\"Fichier @ &lt;root&gt;\")",
            "        self.assertInBody(\"/Fichier%20%40%20%3Croot%3E?date=\")",
            "        #  R\u00e9pertoire (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial",
            "        self.assertInBody(\"R\u00e9pertoire (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial\")",
            "        self.assertInBody(",
            "            \"/R%C3%A9pertoire%20%28%40vec%29%20%7Bc%C3%A0ra%C3%A7t%23%C3%A8r%C3%AB%7D%20%24%C3%A9p%C3%AAcial\"",
            "        )",
            "        #  test\\test",
            "        self.assertInBody(\"test\\\\test\")",
            "        self.assertInBody(\"/test%5Ctest\")",
            "        #  <F!ch\u00efer> (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial",
            "        self.assertInBody(\"&lt;F!ch\u00efer&gt; (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial\")",
            "        self.assertInBody(",
            "            \"/%3CF%21ch%C3%AFer%3E%20%28%40vec%29%20%7Bc%C3%A0ra%C3%A7t%23%C3%A8r%C3%AB%7D%20%24%C3%A9p%C3%AAcial?date=\"",
            "        )",
            "        #  R\u00e9pertoire Existant",
            "        self.assertInBody(\"R\u00e9pertoire Existant\")",
            "        self.assertInBody(\"/R%C3%A9pertoire%20Existant\")",
            "        #  R\u00e9pertoire Supprim\u00e9",
            "        self.assertInBody(\"R\u00e9pertoire Supprim\u00e9\")",
            "        self.assertInBody(\"/R%C3%A9pertoire%20Supprim%C3%A9\")",
            "        #  Quoted folder",
            "        self.assertInBody(\"Char Z to quote\")",
            "        self.assertInBody(\"/Char%20%3B090%20to%20quote\")",
            "        #  Invalid encoding",
            "        self.assertInBody(\"Fichier avec non asci char \ufffdvelyne M\ufffdre.txt\")",
            "        self.assertInBody(\"/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt\")",
            "        #  Make sure \"rdiff-backup-data\" is not listed",
            "        self.assertNotInBody(\"rdiff-backup-data\")",
            "",
            "    def test_loop_symlink(self):",
            "        \"\"\"",
            "        Browse a symlink.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"Subdirectory/LoopSymlink\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "        self._browse(self.USERNAME, self.REPO, \"Subdirectory/LoopSymlink/LoopSymlink/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "        self._browse(self.USERNAME, self.REPO, \"Subdirectory/LoopSymlink/LoopSymlink/LoopSymlink\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "",
            "    def test_subdir_symlink(self):",
            "        self._browse(self.USERNAME, self.REPO, \"SymlinkToSubdirectory\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "        self._browse(self.USERNAME, self.REPO, \"SymlinkToSubdirectory/LoopSymlink\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "",
            "    def test_sub_directory_deleted(self):",
            "        \"\"\"",
            "        Browse to a sub directory being deleted.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"R%C3%A9pertoire%20Supprim%C3%A9/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Untitled Empty Text File\")",
            "        self.assertInBody(\"Untitled Empty Text File 2\")",
            "        self.assertInBody(\"Untitled Empty Text File 3\")",
            "        #  Also check if the filesize are properly retrieve.",
            "        self.assertInBody(\"21 bytes\")",
            "        self.assertInBody(\"14 bytes\")",
            "        self.assertInBody(\"0 bytes\")",
            "        #  Also check dates",
            "        self.assertInBody(\"data-order=\\\"1414871475\\\"\")",
            "",
            "    def test_sub_directory_exists(self):",
            "        \"\"\"",
            "        Browse to a sub directory.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"R%C3%A9pertoire%20Existant/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Fichier supprim\u00e9\")",
            "        self.assertInBody(\"Untitled Empty Text File\")",
            "        self.assertInBody(\"Untitled Empty Text File 2\")",
            "",
            "    def test_sub_directory_with_special_chars(self):",
            "        \"\"\"",
            "        Browse to a sub directory containing special chars.",
            "        \"\"\"",
            "        self._browse(",
            "            self.USERNAME,",
            "            self.REPO,",
            "            \"R%C3%A9pertoire%20%28%40vec%29%20%7Bc%C3%A0ra%C3%A7t%23%C3%A8r%C3%AB%7D%20%24%C3%A9p%C3%AAcial/\",",
            "        )",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Untitled Testcase.doc\")",
            "",
            "    def test_sub_directory_with_encoding(self):",
            "        \"\"\"",
            "        Browse to sub directory with non-ascii.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"R%C3%A9pertoire%20Existant/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"R\u00e9pertoire Existant\")",
            "",
            "    def test_quoted_path(self):",
            "        \"\"\"",
            "        Browse to a directory with quoted path ';090'.",
            "        \"\"\"",
            "        #  Char ;090 to quote",
            "        #  Char Z to quote",
            "        self._browse(self.USERNAME, self.REPO, \"Char%20%3B090%20to%20quote/\")",
            "        self.assertStatus(200)",
            "        #  browser location",
            "        self.assertInBody(\"Char Z to quote\")",
            "        #  Content of the folder",
            "        self.assertInBody(\"Untitled Testcase.doc\")",
            "        self.assertInBody(\"Data\")",
            "        #  Check size",
            "        self.assertInBody('data-order=\"21\"')",
            "        self.assertInBody('data-order=\"14848\"')",
            "",
            "    def test_invalid_repo(self):",
            "        \"\"\"",
            "        Browse to an invalid repository.",
            "        \"\"\"",
            "        self.getPage('/browse/invalid')",
            "        self.assertStatus(404)",
            "",
            "        self.getPage('/browse/invalid/')",
            "        self.assertStatus(404)",
            "",
            "        self.getPage('/browse/admin/invalid/')",
            "        self.assertStatus(404)",
            "",
            "    def test_invalid_path(self):",
            "        \"\"\"",
            "        Browse to an invalid path.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_with_rdiffbackupdata(self):",
            "        \"\"\"",
            "        Verify if rdiff-backup-data is not accessible.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"rdiff-backup-data/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_with_single_repo(self):",
            "        \"\"\"",
            "        Verify if browsing '/browse/' for a single repository is working.",
            "        \"\"\"",
            "        # Change the user setting to match single repo.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.user_root = os.path.join(self.testcases, 'testcases')",
            "        user.refresh_repos()",
            "        user.add()",
            "        self.assertEqual(['', 'broker-repo', 'testcases'], [r.name for r in user.repo_objs])",
            "        # Check if listing locations is working",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('testcases')",
            "        # Check if browsing is working.",
            "        self.getPage('/browse/admin')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Files')",
            "        # Check sub directory browsing",
            "        self.getPage('/browse/admin/Revisions/')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Files')",
            "",
            "    def test_browse_with_permissions(self):",
            "        # Create an another user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "        user_obj.add()",
            "        self.getPage('/browse/admin')",
            "        self.assertStatus('404 Not Found')",
            "",
            "        # Browse other user's repos",
            "        self.getPage('/browse/anotheruser')",
            "        self.assertStatus('404 Not Found')",
            "        self.getPage('/browse/anotheruser/testcases')",
            "        self.assertStatus('200 OK')",
            "        self.getPage('/browse/anotheruser/testcases/Revisions/')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_browse_without_permissions(self):",
            "        # Remove admin role.",
            "        admin = UserObject.get_user('admin')",
            "        admin.role = UserObject.USER_ROLE",
            "        admin.add()",
            "        admin.refresh_repos()",
            "",
            "        # Browse other user's repos",
            "        self.getPage('/browse/anotheruser/testcases')",
            "        self.assertStatus('403 Forbidden')",
            "        self.getPage('/browse/anotheruser/testcases/Revisions/')",
            "        self.assertStatus('403 Forbidden')",
            "",
            "    def test_browser_with_failed_repo(self):",
            "        # Given a failed repo",
            "        admin = UserObject.get_user('admin')",
            "        admin.user_root = 'invalid'",
            "        admin.add()",
            "        # When querying the logs",
            "        self._browse(self.USERNAME, self.REPO, '')",
            "        # Then the page is return with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "import os",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class BrowsePageTest(rdiffweb.test.WebCase):",
            "    \"\"\"Basic python call to page_browse\"\"\"",
            "",
            "    login = True",
            "",
            "    def tearDown(self):",
            "        super().tearDown()",
            "",
            "    def _browse(self, user, repo, path):",
            "        url = \"/browse/\" + user + \"/\" + repo + \"/\" + path",
            "        self.getPage(url)",
            "",
            "    def test_locations(self):",
            "        \"\"\"",
            "        Check page_locations",
            "        \"\"\"",
            "        self.getPage(\"/\")",
            "        self.assertInBody(self.REPO)",
            "        self.assertInBody('testcases')",
            "",
            "    def test_locations_with_broken_tree(self):",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='testcases/broker-repo').add().commit()",
            "        RepoObject(userid=userobj.userid, repopath='testcases/testcases').add().commit()",
            "        self.getPage(\"/\")",
            "",
            "    def test_WithRelativePath(self):",
            "        \"\"\"",
            "        Check if relative path are resolved.",
            "        \"\"\"",
            "        self._browse(",
            "            self.USERNAME,",
            "            self.REPO,",
            "            \"../%s/Revisions/../../%s/\"",
            "            % (",
            "                self.REPO,",
            "                self.REPO,",
            "            ),",
            "        )",
            "        self.assertInBody(\"\")",
            "",
            "    def test_root(self):",
            "        \"\"\"",
            "        Browse repository root.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"\")",
            "        #  Fichier @ <root>",
            "        self.assertInBody(\"Fichier @ &lt;root&gt;\")",
            "        self.assertInBody(\"/Fichier%20%40%20%3Croot%3E?date=\")",
            "        #  R\u00e9pertoire (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial",
            "        self.assertInBody(\"R\u00e9pertoire (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial\")",
            "        self.assertInBody(",
            "            \"/R%C3%A9pertoire%20%28%40vec%29%20%7Bc%C3%A0ra%C3%A7t%23%C3%A8r%C3%AB%7D%20%24%C3%A9p%C3%AAcial\"",
            "        )",
            "        #  test\\test",
            "        self.assertInBody(\"test\\\\test\")",
            "        self.assertInBody(\"/test%5Ctest\")",
            "        #  <F!ch\u00efer> (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial",
            "        self.assertInBody(\"&lt;F!ch\u00efer&gt; (@vec) {c\u00e0ra\u00e7t#\u00e8r\u00eb} $\u00e9p\u00eacial\")",
            "        self.assertInBody(",
            "            \"/%3CF%21ch%C3%AFer%3E%20%28%40vec%29%20%7Bc%C3%A0ra%C3%A7t%23%C3%A8r%C3%AB%7D%20%24%C3%A9p%C3%AAcial?date=\"",
            "        )",
            "        #  R\u00e9pertoire Existant",
            "        self.assertInBody(\"R\u00e9pertoire Existant\")",
            "        self.assertInBody(\"/R%C3%A9pertoire%20Existant\")",
            "        #  R\u00e9pertoire Supprim\u00e9",
            "        self.assertInBody(\"R\u00e9pertoire Supprim\u00e9\")",
            "        self.assertInBody(\"/R%C3%A9pertoire%20Supprim%C3%A9\")",
            "        #  Quoted folder",
            "        self.assertInBody(\"Char Z to quote\")",
            "        self.assertInBody(\"/Char%20%3B090%20to%20quote\")",
            "        #  Invalid encoding",
            "        self.assertInBody(\"Fichier avec non asci char \ufffdvelyne M\ufffdre.txt\")",
            "        self.assertInBody(\"/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt\")",
            "        #  Make sure \"rdiff-backup-data\" is not listed",
            "        self.assertNotInBody(\"rdiff-backup-data\")",
            "",
            "    def test_loop_symlink(self):",
            "        \"\"\"",
            "        Browse a symlink.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"Subdirectory/LoopSymlink\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "        self._browse(self.USERNAME, self.REPO, \"Subdirectory/LoopSymlink/LoopSymlink/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "        self._browse(self.USERNAME, self.REPO, \"Subdirectory/LoopSymlink/LoopSymlink/LoopSymlink\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "",
            "    def test_subdir_symlink(self):",
            "        self._browse(self.USERNAME, self.REPO, \"SymlinkToSubdirectory\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "        self._browse(self.USERNAME, self.REPO, \"SymlinkToSubdirectory/LoopSymlink\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"LoopSymlink\")",
            "        self.assertInBody(\"Fold\u00e8r with \u00e9ncod\u00efng\")",
            "",
            "    def test_sub_directory_deleted(self):",
            "        \"\"\"",
            "        Browse to a sub directory being deleted.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"R%C3%A9pertoire%20Supprim%C3%A9/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Untitled Empty Text File\")",
            "        self.assertInBody(\"Untitled Empty Text File 2\")",
            "        self.assertInBody(\"Untitled Empty Text File 3\")",
            "        #  Also check if the filesize are properly retrieve.",
            "        self.assertInBody(\"21 bytes\")",
            "        self.assertInBody(\"14 bytes\")",
            "        self.assertInBody(\"0 bytes\")",
            "        #  Also check dates",
            "        self.assertInBody(\"data-order=\\\"1414871475\\\"\")",
            "",
            "    def test_sub_directory_exists(self):",
            "        \"\"\"",
            "        Browse to a sub directory.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"R%C3%A9pertoire%20Existant/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Fichier supprim\u00e9\")",
            "        self.assertInBody(\"Untitled Empty Text File\")",
            "        self.assertInBody(\"Untitled Empty Text File 2\")",
            "",
            "    def test_sub_directory_with_special_chars(self):",
            "        \"\"\"",
            "        Browse to a sub directory containing special chars.",
            "        \"\"\"",
            "        self._browse(",
            "            self.USERNAME,",
            "            self.REPO,",
            "            \"R%C3%A9pertoire%20%28%40vec%29%20%7Bc%C3%A0ra%C3%A7t%23%C3%A8r%C3%AB%7D%20%24%C3%A9p%C3%AAcial/\",",
            "        )",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Untitled Testcase.doc\")",
            "",
            "    def test_sub_directory_with_encoding(self):",
            "        \"\"\"",
            "        Browse to sub directory with non-ascii.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"R%C3%A9pertoire%20Existant/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"R\u00e9pertoire Existant\")",
            "",
            "    def test_quoted_path(self):",
            "        \"\"\"",
            "        Browse to a directory with quoted path ';090'.",
            "        \"\"\"",
            "        #  Char ;090 to quote",
            "        #  Char Z to quote",
            "        self._browse(self.USERNAME, self.REPO, \"Char%20%3B090%20to%20quote/\")",
            "        self.assertStatus(200)",
            "        #  browser location",
            "        self.assertInBody(\"Char Z to quote\")",
            "        #  Content of the folder",
            "        self.assertInBody(\"Untitled Testcase.doc\")",
            "        self.assertInBody(\"Data\")",
            "        #  Check size",
            "        self.assertInBody('data-order=\"21\"')",
            "        self.assertInBody('data-order=\"14848\"')",
            "",
            "    def test_invalid_repo(self):",
            "        \"\"\"",
            "        Browse to an invalid repository.",
            "        \"\"\"",
            "        self.getPage('/browse/invalid')",
            "        self.assertStatus(404)",
            "",
            "        self.getPage('/browse/invalid/')",
            "        self.assertStatus(404)",
            "",
            "        self.getPage('/browse/admin/invalid/')",
            "        self.assertStatus(404)",
            "",
            "    def test_invalid_path(self):",
            "        \"\"\"",
            "        Browse to an invalid path.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_with_rdiffbackupdata(self):",
            "        \"\"\"",
            "        Verify if rdiff-backup-data is not accessible.",
            "        \"\"\"",
            "        self._browse(self.USERNAME, self.REPO, \"rdiff-backup-data/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_with_single_repo(self):",
            "        \"\"\"",
            "        Verify if browsing '/browse/' for a single repository is working.",
            "        \"\"\"",
            "        # Change the user setting to match single repo.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.user_root = os.path.join(self.testcases, 'testcases')",
            "        user.refresh_repos()",
            "        user.commit()",
            "        self.assertEqual(['', 'broker-repo', 'testcases'], [r.name for r in user.repo_objs])",
            "        # Check if listing locations is working",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('testcases')",
            "        # Check if browsing is working.",
            "        self.getPage('/browse/admin')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Files')",
            "        # Check sub directory browsing",
            "        self.getPage('/browse/admin/Revisions/')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Files')",
            "",
            "    def test_browse_with_permissions(self):",
            "        # Create an another user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "        user_obj.commit()",
            "        self.getPage('/browse/admin')",
            "        self.assertStatus('404 Not Found')",
            "",
            "        # Browse other user's repos",
            "        self.getPage('/browse/anotheruser')",
            "        self.assertStatus('404 Not Found')",
            "        self.getPage('/browse/anotheruser/testcases')",
            "        self.assertStatus('200 OK')",
            "        self.getPage('/browse/anotheruser/testcases/Revisions/')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_browse_without_permissions(self):",
            "        # Remove admin role.",
            "        admin = UserObject.get_user('admin')",
            "        admin.role = UserObject.USER_ROLE",
            "        admin.refresh_repos()",
            "        admin.commit()",
            "",
            "        # Browse other user's repos",
            "        self.getPage('/browse/anotheruser/testcases')",
            "        self.assertStatus('403 Forbidden')",
            "        self.getPage('/browse/anotheruser/testcases/Revisions/')",
            "        self.assertStatus('403 Forbidden')",
            "",
            "    def test_browser_with_failed_repo(self):",
            "        # Given a failed repo",
            "        admin = UserObject.get_user('admin')",
            "        admin.user_root = 'invalid'",
            "        admin.commit()",
            "        # When querying the logs",
            "        self._browse(self.USERNAME, self.REPO, '')",
            "        # Then the page is return with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "52": [
                "BrowsePageTest",
                "test_locations_with_broken_tree"
            ],
            "53": [
                "BrowsePageTest",
                "test_locations_with_broken_tree"
            ],
            "232": [
                "BrowsePageTest",
                "test_with_single_repo"
            ],
            "252": [
                "BrowsePageTest",
                "test_browse_with_permissions"
            ],
            "268": [
                "BrowsePageTest",
                "test_browse_without_permissions"
            ],
            "281": [
                "BrowsePageTest",
                "test_browser_with_failed_repo"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_delete.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 158,
                "afterPatchRowNumber": 158,
                "PatchRowcode": "         user_obj = UserObject.add_user('anotheruser', 'password')"
            },
            "1": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": 159,
                "PatchRowcode": "         user_obj.user_root = self.testcases"
            },
            "2": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 160,
                "PatchRowcode": "         user_obj.refresh_repos()"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+        user_obj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 162,
                "PatchRowcode": "         self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])"
            },
            "5": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": 163,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": 164,
                "PatchRowcode": "         self._delete('anotheruser', 'testcases', 'testcases')"
            },
            "7": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": 179,
                "PatchRowcode": "         user_obj.user_root = self.testcases"
            },
            "8": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 180,
                "PatchRowcode": "         user_obj.role = UserObject.MAINTAINER_ROLE"
            },
            "9": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 181,
                "PatchRowcode": "         user_obj.refresh_repos()"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+        user_obj.commit()"
            },
            "11": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "         self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])"
            },
            "12": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": 184,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": 185,
                "PatchRowcode": "         # Login as maintainer"
            },
            "14": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": 202,
                "PatchRowcode": "         user_obj.user_root = self.testcases"
            },
            "15": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": 203,
                "PatchRowcode": "         user_obj.role = UserObject.USER_ROLE"
            },
            "16": {
                "beforePatchRowNumber": 202,
                "afterPatchRowNumber": 204,
                "PatchRowcode": "         user_obj.refresh_repos()"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 205,
                "PatchRowcode": "+        user_obj.commit()"
            },
            "18": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": 206,
                "PatchRowcode": "         self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])"
            },
            "19": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": 207,
                "PatchRowcode": " "
            },
            "20": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": 208,
                "PatchRowcode": "         # Login as maintainer"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Apr 10, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "",
            "import os",
            "from time import sleep",
            "from unittest.case import skipIf",
            "",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.librdiff import rdiff_backup_version",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class DeleteRepoTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def _delete(self, user, repo, confirm):",
            "        body = {}",
            "        if confirm is not None:",
            "            body.update({'confirm': confirm})",
            "        self.getPage(\"/delete/\" + user + \"/\" + repo + \"/\", method=\"POST\", body=body)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            (\"with_dir\", 'admin', '/testcases/Revisions', 'Revisions', 303, 404, '/browse/admin/testcases'),",
            "            (\"with_dir_wrong_confirmation\", 'admin', '/testcases/Revisions', 'invalid', 400, 200),",
            "            (\"with_file\", 'admin', '/testcases/Revisions/Data', 'Data', 303, 404, '/browse/admin/testcases/Revisions'),",
            "            (\"with_file_wrong_confirmation\", 'admin', '/testcases/Revisions/Data', 'invalid', 400, 200),",
            "            (\"with_invalid\", 'admin', '/testcases/invalid', 'invalid', 404, 404),",
            "            (",
            "                \"with_broken_symlink\",",
            "                'admin',",
            "                '/testcases/BrokenSymlink',",
            "                'BrokenSymlink',",
            "                303,",
            "                404,",
            "                '/browse/admin/testcases',",
            "            ),",
            "            (",
            "                \"with_utf8\",",
            "                'admin',",
            "                '/testcases/R%C3%A9pertoire%20Existant',",
            "                'R\u00e9pertoire Existant',",
            "                303,",
            "                404,",
            "                '/browse/admin/testcases',",
            "            ),",
            "            (\"with_rdiff_backup_data\", 'admin', '/testcases/rdiff-backup-data', 'rdiff-backup-data', 404, 404),",
            "            (",
            "                \"with_quoted_path\",",
            "                'admin',",
            "                '/testcases/Char%20%3B090%20to%20quote',",
            "                'Char Z to quote',",
            "                303,",
            "                404,",
            "                '/browse/admin/testcases',",
            "            ),",
            "        ]",
            "    )",
            "    @skipIf(rdiff_backup_version() < (2, 0, 1), \"rdiff-backup-delete is available since 2.0.1\")",
            "    def test_delete_path(",
            "        self, unused, username, path, confirmation, expected_status, expected_history_status, expected_redirect=None",
            "    ):",
            "        # When trying to delete a file or a folder with a confirmation",
            "        self._delete(username, path, confirmation)",
            "        # Then a status is returned",
            "        self.assertStatus(expected_status)",
            "        if expected_redirect:",
            "            self.assertHeaderItemValue('Location', self.baseurl + expected_redirect)",
            "        # Check filesystem",
            "        sleep(1)",
            "        self.getPage(\"/history/\" + username + \"/\" + path)",
            "        self.assertStatus(expected_history_status)",
            "",
            "    def test_delete_repo(self):",
            "        \"\"\"",
            "        Check to delete a repo.",
            "        \"\"\"",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Delete repo",
            "        self._delete(self.USERNAME, self.REPO, 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Check filesystem",
            "        sleep(1)",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in userobj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_with_slash(self):",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Then delete it.",
            "        self._delete(self.USERNAME, self.REPO, 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Check filesystem",
            "        sleep(1)",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in userobj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_wrong_confirm(self):",
            "        \"\"\"",
            "        Check failure to delete a repo with wrong confirmation.",
            "        \"\"\"",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Delete repo with wrong confirmation.",
            "        self._delete(self.USERNAME, self.REPO, 'wrong')",
            "        # TODO Make sure the repository is not delete",
            "        userobj.expire()",
            "        self.assertStatus(400)",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "",
            "    def test_delete_repo_without_confirm(self):",
            "        \"\"\"",
            "        Check failure to delete a repo with wrong confirmation.",
            "        \"\"\"",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Delete repo without confirmation.",
            "        self._delete(self.USERNAME, self.REPO, None)",
            "        # Make sure the repository is not delete",
            "        self.assertStatus(400)",
            "        self.assertInBody('Confirmation: This field is required')",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "",
            "    def test_delete_repo_as_admin(self):",
            "        # Create a another user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "",
            "        self._delete('anotheruser', 'testcases', 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "        # Check filesystem",
            "        sleep(1)",
            "        user_obj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in user_obj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_as_maintainer(self):",
            "        self.assertTrue(os.path.isdir(self.testcases))",
            "",
            "        # Create a another user with maintainer right",
            "        user_obj = UserObject.add_user('maintainer', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.role = UserObject.MAINTAINER_ROLE",
            "        user_obj.refresh_repos()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "",
            "        # Login as maintainer",
            "        self._login('maintainer', 'password')",
            "",
            "        # Try to delete your own repo",
            "        self._delete('maintainer', 'testcases', 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "        # Check filesystem",
            "        sleep(1)",
            "        user_obj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in user_obj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_as_user(self):",
            "        # Create a another user with maintainer right",
            "        user_obj = UserObject.add_user('user', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.role = UserObject.USER_ROLE",
            "        user_obj.refresh_repos()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "",
            "        # Login as maintainer",
            "        self._login('user', 'password')",
            "",
            "        # Try to delete own own repo",
            "        self._delete('user', 'testcases', 'testcases')",
            "        self.assertStatus(403)",
            "",
            "        # Check database don't change",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "        self.assertTrue(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_does_not_exists(self):",
            "        # Given an invalid repo",
            "        repo = 'invalid'",
            "        # When trying to delete this repo",
            "        self._delete(self.USERNAME, repo, repo)",
            "        # Then a 404 is return to the user",
            "        self.assertStatus(404)",
            "",
            "    def test_delete_method_get(self):",
            "        # Given a user with repo",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in UserObject.get_user('admin').repo_objs])",
            "        # When trying to deleted repo with GET method",
            "        self.getPage(\"/delete/\" + self.USERNAME + \"/\" + self.REPO + \"/?confirm=\" + self.REPO, method=\"GET\")",
            "        # Then An error is returned",
            "        self.assertStatus(405)",
            "        # Then repo still exists",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in UserObject.get_user('admin').repo_objs])"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Apr 10, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "",
            "import os",
            "from time import sleep",
            "from unittest.case import skipIf",
            "",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.librdiff import rdiff_backup_version",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class DeleteRepoTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def _delete(self, user, repo, confirm):",
            "        body = {}",
            "        if confirm is not None:",
            "            body.update({'confirm': confirm})",
            "        self.getPage(\"/delete/\" + user + \"/\" + repo + \"/\", method=\"POST\", body=body)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            (\"with_dir\", 'admin', '/testcases/Revisions', 'Revisions', 303, 404, '/browse/admin/testcases'),",
            "            (\"with_dir_wrong_confirmation\", 'admin', '/testcases/Revisions', 'invalid', 400, 200),",
            "            (\"with_file\", 'admin', '/testcases/Revisions/Data', 'Data', 303, 404, '/browse/admin/testcases/Revisions'),",
            "            (\"with_file_wrong_confirmation\", 'admin', '/testcases/Revisions/Data', 'invalid', 400, 200),",
            "            (\"with_invalid\", 'admin', '/testcases/invalid', 'invalid', 404, 404),",
            "            (",
            "                \"with_broken_symlink\",",
            "                'admin',",
            "                '/testcases/BrokenSymlink',",
            "                'BrokenSymlink',",
            "                303,",
            "                404,",
            "                '/browse/admin/testcases',",
            "            ),",
            "            (",
            "                \"with_utf8\",",
            "                'admin',",
            "                '/testcases/R%C3%A9pertoire%20Existant',",
            "                'R\u00e9pertoire Existant',",
            "                303,",
            "                404,",
            "                '/browse/admin/testcases',",
            "            ),",
            "            (\"with_rdiff_backup_data\", 'admin', '/testcases/rdiff-backup-data', 'rdiff-backup-data', 404, 404),",
            "            (",
            "                \"with_quoted_path\",",
            "                'admin',",
            "                '/testcases/Char%20%3B090%20to%20quote',",
            "                'Char Z to quote',",
            "                303,",
            "                404,",
            "                '/browse/admin/testcases',",
            "            ),",
            "        ]",
            "    )",
            "    @skipIf(rdiff_backup_version() < (2, 0, 1), \"rdiff-backup-delete is available since 2.0.1\")",
            "    def test_delete_path(",
            "        self, unused, username, path, confirmation, expected_status, expected_history_status, expected_redirect=None",
            "    ):",
            "        # When trying to delete a file or a folder with a confirmation",
            "        self._delete(username, path, confirmation)",
            "        # Then a status is returned",
            "        self.assertStatus(expected_status)",
            "        if expected_redirect:",
            "            self.assertHeaderItemValue('Location', self.baseurl + expected_redirect)",
            "        # Check filesystem",
            "        sleep(1)",
            "        self.getPage(\"/history/\" + username + \"/\" + path)",
            "        self.assertStatus(expected_history_status)",
            "",
            "    def test_delete_repo(self):",
            "        \"\"\"",
            "        Check to delete a repo.",
            "        \"\"\"",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Delete repo",
            "        self._delete(self.USERNAME, self.REPO, 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Check filesystem",
            "        sleep(1)",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in userobj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_with_slash(self):",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Then delete it.",
            "        self._delete(self.USERNAME, self.REPO, 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Check filesystem",
            "        sleep(1)",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in userobj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_wrong_confirm(self):",
            "        \"\"\"",
            "        Check failure to delete a repo with wrong confirmation.",
            "        \"\"\"",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Delete repo with wrong confirmation.",
            "        self._delete(self.USERNAME, self.REPO, 'wrong')",
            "        # TODO Make sure the repository is not delete",
            "        userobj.expire()",
            "        self.assertStatus(400)",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "",
            "    def test_delete_repo_without_confirm(self):",
            "        \"\"\"",
            "        Check failure to delete a repo with wrong confirmation.",
            "        \"\"\"",
            "        # Check initial list of repo",
            "        userobj = UserObject.get_user('admin')",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "        # Delete repo without confirmation.",
            "        self._delete(self.USERNAME, self.REPO, None)",
            "        # Make sure the repository is not delete",
            "        self.assertStatus(400)",
            "        self.assertInBody('Confirmation: This field is required')",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in userobj.repo_objs])",
            "",
            "    def test_delete_repo_as_admin(self):",
            "        # Create a another user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "        user_obj.commit()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "",
            "        self._delete('anotheruser', 'testcases', 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "        # Check filesystem",
            "        sleep(1)",
            "        user_obj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in user_obj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_as_maintainer(self):",
            "        self.assertTrue(os.path.isdir(self.testcases))",
            "",
            "        # Create a another user with maintainer right",
            "        user_obj = UserObject.add_user('maintainer', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.role = UserObject.MAINTAINER_ROLE",
            "        user_obj.refresh_repos()",
            "        user_obj.commit()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "",
            "        # Login as maintainer",
            "        self._login('maintainer', 'password')",
            "",
            "        # Try to delete your own repo",
            "        self._delete('maintainer', 'testcases', 'testcases')",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "        # Check filesystem",
            "        sleep(1)",
            "        user_obj.expire()",
            "        self.assertEqual(['broker-repo'], [r.name for r in user_obj.repo_objs])",
            "        self.assertFalse(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_as_user(self):",
            "        # Create a another user with maintainer right",
            "        user_obj = UserObject.add_user('user', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.role = UserObject.USER_ROLE",
            "        user_obj.refresh_repos()",
            "        user_obj.commit()",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "",
            "        # Login as maintainer",
            "        self._login('user', 'password')",
            "",
            "        # Try to delete own own repo",
            "        self._delete('user', 'testcases', 'testcases')",
            "        self.assertStatus(403)",
            "",
            "        # Check database don't change",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in user_obj.repo_objs])",
            "        self.assertTrue(os.path.isdir(os.path.join(self.testcases, 'testcases')))",
            "",
            "    def test_delete_repo_does_not_exists(self):",
            "        # Given an invalid repo",
            "        repo = 'invalid'",
            "        # When trying to delete this repo",
            "        self._delete(self.USERNAME, repo, repo)",
            "        # Then a 404 is return to the user",
            "        self.assertStatus(404)",
            "",
            "    def test_delete_method_get(self):",
            "        # Given a user with repo",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in UserObject.get_user('admin').repo_objs])",
            "        # When trying to deleted repo with GET method",
            "        self.getPage(\"/delete/\" + self.USERNAME + \"/\" + self.REPO + \"/?confirm=\" + self.REPO, method=\"GET\")",
            "        # Then An error is returned",
            "        self.assertStatus(405)",
            "        # Then repo still exists",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in UserObject.get_user('admin').repo_objs])"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/tests/test_page_graphs.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "         user_obj = UserObject.add_user('anotheruser', 'password')"
            },
            "1": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "         user_obj.user_root = self.testcases"
            },
            "2": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "         user_obj.refresh_repos()"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+        user_obj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 58,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 59,
                "PatchRowcode": "         self.getPage(\"/graphs/activities/anotheruser/testcases\")"
            },
            "6": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "         self.assertStatus('200 OK')"
            },
            "7": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "         # Remove admin role"
            },
            "8": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "         admin = UserObject.get_user('admin')"
            },
            "9": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "         admin.role = UserObject.USER_ROLE"
            },
            "10": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        admin.add()"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+        admin.commit()"
            },
            "12": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 67,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "         # Browse admin's repos"
            },
            "14": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "         self.getPage(\"/graphs/activities/anotheruser/testcases\")"
            },
            "15": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "         # Given a failed repo"
            },
            "16": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "         admin = UserObject.get_user('admin')"
            },
            "17": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "         admin.user_root = 'invalid'"
            },
            "18": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        admin.add()"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+        admin.commit()"
            },
            "20": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         # When querying the logs"
            },
            "21": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "         self.getPage(\"/graphs/activities/\" + self.USERNAME + \"/\" + self.REPO + \"/\")"
            },
            "22": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "         # Then the page is return with an error message"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\"",
            "Created on Jan 1, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class SettingsTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_activities(self):",
            "        self.getPage(\"/graphs/activities/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_errors(self):",
            "        self.getPage(\"/graphs/errors/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_files(self):",
            "        self.getPage(\"/graphs/files/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_sizes(self):",
            "        self.getPage(\"/graphs/sizes/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_times(self):",
            "        self.getPage(\"/graphs/times/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_as_another_user(self):",
            "        # Create another user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "",
            "        self.getPage(\"/graphs/activities/anotheruser/testcases\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Activities\")",
            "",
            "        # Remove admin role",
            "        admin = UserObject.get_user('admin')",
            "        admin.role = UserObject.USER_ROLE",
            "        admin.add()",
            "",
            "        # Browse admin's repos",
            "        self.getPage(\"/graphs/activities/anotheruser/testcases\")",
            "        self.assertStatus('403 Forbidden')",
            "",
            "    def test_chartkick_js(self):",
            "        self.getPage(\"/static/js/chart.min.js\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Chart\")",
            "",
            "    def test_chart_js(self):",
            "        self.getPage(\"/static/js/chartkick.min.js\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Chartkick\")",
            "",
            "    def test_does_not_exists(self):",
            "        # Given an invalid repo",
            "        repo = 'invalid'",
            "        # When trying to get graphs of it",
            "        self.getPage(\"/graphs/activities/\" + self.USERNAME + \"/\" + repo + \"/\")",
            "        # Then a 404 error is return",
            "        self.assertStatus(404)",
            "",
            "    def test_browser_with_failed_repo(self):",
            "        # Given a failed repo",
            "        admin = UserObject.get_user('admin')",
            "        admin.user_root = 'invalid'",
            "        admin.add()",
            "        # When querying the logs",
            "        self.getPage(\"/graphs/activities/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        # Then the page is return with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\"",
            "Created on Jan 1, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class SettingsTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_activities(self):",
            "        self.getPage(\"/graphs/activities/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_errors(self):",
            "        self.getPage(\"/graphs/errors/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_files(self):",
            "        self.getPage(\"/graphs/files/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_sizes(self):",
            "        self.getPage(\"/graphs/sizes/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_times(self):",
            "        self.getPage(\"/graphs/times/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_as_another_user(self):",
            "        # Create another user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "        user_obj.commit()",
            "",
            "        self.getPage(\"/graphs/activities/anotheruser/testcases\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Activities\")",
            "",
            "        # Remove admin role",
            "        admin = UserObject.get_user('admin')",
            "        admin.role = UserObject.USER_ROLE",
            "        admin.commit()",
            "",
            "        # Browse admin's repos",
            "        self.getPage(\"/graphs/activities/anotheruser/testcases\")",
            "        self.assertStatus('403 Forbidden')",
            "",
            "    def test_chartkick_js(self):",
            "        self.getPage(\"/static/js/chart.min.js\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Chart\")",
            "",
            "    def test_chart_js(self):",
            "        self.getPage(\"/static/js/chartkick.min.js\")",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Chartkick\")",
            "",
            "    def test_does_not_exists(self):",
            "        # Given an invalid repo",
            "        repo = 'invalid'",
            "        # When trying to get graphs of it",
            "        self.getPage(\"/graphs/activities/\" + self.USERNAME + \"/\" + repo + \"/\")",
            "        # Then a 404 error is return",
            "        self.assertStatus(404)",
            "",
            "    def test_browser_with_failed_repo(self):",
            "        # Given a failed repo",
            "        admin = UserObject.get_user('admin')",
            "        admin.user_root = 'invalid'",
            "        admin.commit()",
            "        # When querying the logs",
            "        self.getPage(\"/graphs/activities/\" + self.USERNAME + \"/\" + self.REPO + \"/\")",
            "        # Then the page is return with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "65": [
                "SettingsTest",
                "test_as_another_user"
            ],
            "93": [
                "SettingsTest",
                "test_browser_with_failed_repo"
            ]
        },
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/tests/test_page_history.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "         user_obj = UserObject.add_user('anotheruser', 'password')"
            },
            "1": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "         user_obj.user_root = self.testcases"
            },
            "2": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "         user_obj.refresh_repos()"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 78,
                "PatchRowcode": "+        user_obj.commit()"
            },
            "4": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "         self.getPage(\"/history/anotheruser/testcases\")"
            },
            "5": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "         self.assertStatus('200 OK')"
            },
            "6": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 81,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "         # Remove admin right"
            },
            "8": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "         admin = UserObject.get_user('admin')"
            },
            "9": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "         admin.role = UserObject.USER_ROLE"
            },
            "10": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        admin.add()"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+        admin.commit()"
            },
            "12": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 86,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "         # Browse admin's repos"
            },
            "14": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "         self.getPage(\"/history/anotheruser/testcases\")"
            },
            "15": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         # Given a failed repo"
            },
            "16": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "         admin = UserObject.get_user('admin')"
            },
            "17": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "         admin.user_root = 'invalid'"
            },
            "18": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        admin.add()"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+        admin.commit()"
            },
            "20": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 104,
                "PatchRowcode": "         # When querying the logs"
            },
            "21": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "         self.getPage(\"/history/\" + self.USERNAME + \"/\" + self.REPO)"
            },
            "22": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "         # Then the page is return with an error message"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\"",
            "Created on Dec 29, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class HistoryPageTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def _history(self, user, path, limit=None):",
            "        url = \"/history/\" + user + \"/\" + path + \"/\"",
            "        if limit:",
            "            url += \"?limit=%s\" % limit",
            "        self.getPage(url)",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_history_with_root(self):",
            "        self._history(self.USERNAME, self.REPO)",
            "        # Check revisions",
            "        self.assertInBody(\"2016-02-02T16:30:40-05:00\")",
            "        self.assertInBody(\"2014-11-02T09:50:53-05:00\")",
            "        # Check show more button get displayed",
            "        self.assertInBody(\"Show more\")",
            "        # Check download buttont",
            "        self.assertInBody(\"Download\")",
            "        self.assertInBody(\"/restore/\" + self.USERNAME + \"/\" + self.REPO + \"?date=1415221507\")",
            "",
            "    def test_history_with_path(self):",
            "        self._history(self.USERNAME, 'testcases/Subdirectory')",
            "        self.assertInBody(\"2016-02-02T16:30:40-05:00\")",
            "        self.assertInBody(\"2016-01-20T10:42:21-05:00\")",
            "        self.assertNotInBody(\"Show more\")",
            "",
            "    def test_history_with_deleted_path(self):",
            "        self._history(self.USERNAME, \"testcases/R%C3%A9pertoire%20Supprim%C3%A9/\")",
            "        self.assertInBody(\"Download\")",
            "        self.assertInBody(\"ZIP\")",
            "        self.assertInBody(\"TAR.GZ\")",
            "        self.assertInBody(\"2014-11-01T15:51:15-04:00\")",
            "        self.assertInBody(",
            "            \"/restore/\" + self.USERNAME + \"/\" + self.REPO + \"/R%C3%A9pertoire%20Supprim%C3%A9?date=1414871475\"",
            "        )",
            "",
            "    def test_history_with_limit(self):",
            "        self._history(self.USERNAME, self.REPO, 10)",
            "        self.assertInBody(\"Show more\")",
            "        self._history(self.USERNAME, self.REPO, 50)",
            "        self.assertNotInBody(\"Show more\")",
            "",
            "    def test_as_another_user(self):",
            "        # Create a nother user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "        self.getPage(\"/history/anotheruser/testcases\")",
            "        self.assertStatus('200 OK')",
            "",
            "        # Remove admin right",
            "        admin = UserObject.get_user('admin')",
            "        admin.role = UserObject.USER_ROLE",
            "        admin.add()",
            "",
            "        # Browse admin's repos",
            "        self.getPage(\"/history/anotheruser/testcases\")",
            "        self.assertStatus('403 Forbidden')",
            "",
            "    def test_history_does_not_exists(self):",
            "        # Given an invalid repo",
            "        repo = 'invalid'",
            "        # When trying to browse the history",
            "        self.getPage(\"/history/\" + self.USERNAME + \"/\" + repo)",
            "        # Then a 404 error is return to the user",
            "        self.assertStatus(404)",
            "",
            "    def test_browser_with_failed_repo(self):",
            "        # Given a failed repo",
            "        admin = UserObject.get_user('admin')",
            "        admin.user_root = 'invalid'",
            "        admin.add()",
            "        # When querying the logs",
            "        self.getPage(\"/history/\" + self.USERNAME + \"/\" + self.REPO)",
            "        # Then the page is return with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\"",
            "Created on Dec 29, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class HistoryPageTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def _history(self, user, path, limit=None):",
            "        url = \"/history/\" + user + \"/\" + path + \"/\"",
            "        if limit:",
            "            url += \"?limit=%s\" % limit",
            "        self.getPage(url)",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_history_with_root(self):",
            "        self._history(self.USERNAME, self.REPO)",
            "        # Check revisions",
            "        self.assertInBody(\"2016-02-02T16:30:40-05:00\")",
            "        self.assertInBody(\"2014-11-02T09:50:53-05:00\")",
            "        # Check show more button get displayed",
            "        self.assertInBody(\"Show more\")",
            "        # Check download buttont",
            "        self.assertInBody(\"Download\")",
            "        self.assertInBody(\"/restore/\" + self.USERNAME + \"/\" + self.REPO + \"?date=1415221507\")",
            "",
            "    def test_history_with_path(self):",
            "        self._history(self.USERNAME, 'testcases/Subdirectory')",
            "        self.assertInBody(\"2016-02-02T16:30:40-05:00\")",
            "        self.assertInBody(\"2016-01-20T10:42:21-05:00\")",
            "        self.assertNotInBody(\"Show more\")",
            "",
            "    def test_history_with_deleted_path(self):",
            "        self._history(self.USERNAME, \"testcases/R%C3%A9pertoire%20Supprim%C3%A9/\")",
            "        self.assertInBody(\"Download\")",
            "        self.assertInBody(\"ZIP\")",
            "        self.assertInBody(\"TAR.GZ\")",
            "        self.assertInBody(\"2014-11-01T15:51:15-04:00\")",
            "        self.assertInBody(",
            "            \"/restore/\" + self.USERNAME + \"/\" + self.REPO + \"/R%C3%A9pertoire%20Supprim%C3%A9?date=1414871475\"",
            "        )",
            "",
            "    def test_history_with_limit(self):",
            "        self._history(self.USERNAME, self.REPO, 10)",
            "        self.assertInBody(\"Show more\")",
            "        self._history(self.USERNAME, self.REPO, 50)",
            "        self.assertNotInBody(\"Show more\")",
            "",
            "    def test_as_another_user(self):",
            "        # Create a nother user with admin right",
            "        user_obj = UserObject.add_user('anotheruser', 'password')",
            "        user_obj.user_root = self.testcases",
            "        user_obj.refresh_repos()",
            "        user_obj.commit()",
            "        self.getPage(\"/history/anotheruser/testcases\")",
            "        self.assertStatus('200 OK')",
            "",
            "        # Remove admin right",
            "        admin = UserObject.get_user('admin')",
            "        admin.role = UserObject.USER_ROLE",
            "        admin.commit()",
            "",
            "        # Browse admin's repos",
            "        self.getPage(\"/history/anotheruser/testcases\")",
            "        self.assertStatus('403 Forbidden')",
            "",
            "    def test_history_does_not_exists(self):",
            "        # Given an invalid repo",
            "        repo = 'invalid'",
            "        # When trying to browse the history",
            "        self.getPage(\"/history/\" + self.USERNAME + \"/\" + repo)",
            "        # Then a 404 error is return to the user",
            "        self.assertStatus(404)",
            "",
            "    def test_browser_with_failed_repo(self):",
            "        # Given a failed repo",
            "        admin = UserObject.get_user('admin')",
            "        admin.user_root = 'invalid'",
            "        admin.commit()",
            "        # When querying the logs",
            "        self.getPage(\"/history/\" + self.USERNAME + \"/\" + self.REPO)",
            "        # Then the page is return with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "84": [
                "HistoryPageTest",
                "test_as_another_user"
            ],
            "102": [
                "HistoryPageTest",
                "test_browser_with_failed_repo"
            ]
        },
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "rdiffweb/controller/tests/test_page_login.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": 170,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "1": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "         self.assertInBody(self.USERNAME)"
            },
            "2": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 172,
                "PatchRowcode": "         # Given another user"
            },
            "3": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        UserObject.add_user('otheruser', password='password')"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 173,
                "PatchRowcode": "+        userobj = UserObject.add_user('otheruser', password='password')"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 174,
                "PatchRowcode": "+        userobj.commit()"
            },
            "6": {
                "beforePatchRowNumber": 174,
                "afterPatchRowNumber": 175,
                "PatchRowcode": "         # When trying to re-authenticated with login page"
            },
            "7": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 176,
                "PatchRowcode": "         self.getPage('/login/', method='POST', body={'login': 'otheruser', 'password': 'password'})"
            },
            "8": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 177,
                "PatchRowcode": "         # Then user is still authenticated with previous user"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "import os",
            "",
            "from parameterized import parameterized, parameterized_class",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import DbSession, SessionObject, UserObject",
            "from rdiffweb.tools.auth_form import LOGIN_TIME, SESSION_KEY",
            "",
            "",
            "class LoginPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage('/')",
            "        # Then user is redirected to login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a session object is created without a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNone(session.get(SESSION_KEY))",
            "",
            "    def test_login_success(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authenticating with valid credentials.",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then a new session_id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Then a session object is created with a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertEqual('admin', session.get(SESSION_KEY))",
            "        self.assertIsNotNone(session.get(LOGIN_TIME))",
            "",
            "    def test_cookie_http_only(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with HttpOnly",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('HttpOnly', cookie)",
            "",
            "    def test_login_with_plaintext(self):",
            "        \"\"\"",
            "        Requesting plain text without being authenticated should show the login form.",
            "        \"\"\"",
            "        # When querying root page without authentication",
            "        self.getPage('/', headers=[(\"Accept\", \"text/plain\")])",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('with_root', '/'),",
            "            ('with_browse_url', '/browse/admin/testcases/Revisions/'),",
            "            ('with_encoded_url', '/browse/admin/testcases/DIR%EF%BF%BD/'),",
            "            (",
            "                'with_broken_encoding',",
            "                '/restore/admin/testcases/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt/?date=1415221507',",
            "            ),",
            "            ('with_query_string', '/restore/admin/testcases/Revisions?date=1477434528'),",
            "            ('with_multiple_query_string', '/restore/admin/testcases/Revisions?date=1477434528&kind=tar.gz'),",
            "            ('with_admin', '/admin/'),",
            "        ]",
            "    )",
            "    def test_login(self, unused, original_url):",
            "        # Given an unauthenticated user",
            "        # Query the page without login-in",
            "        self.getPage(original_url)",
            "        # Then user is redirected to the login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authentication is successful",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then user is redirected to original URL",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + original_url)",
            "        # Then cookie is not persistent",
            "        self.assertNotIn('expires', self.cookies[0][1])",
            "        self.assertNotIn('Max-Age', self.cookies[0][1])",
            "        # When requesting the original page",
            "        self.getPage(original_url)",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "",
            "    def test_getpage_with_redirect_post(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using POST method.",
            "        \"\"\"",
            "        # When posting invalid credentials",
            "        b = {'login': 'admin', 'password': 'invalid', 'redirect': '/browse/' + self.REPO + '/DIR%EF%BF%BD/'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        # Then page return without HTTP Error",
            "        self.assertStatus('200 OK')",
            "        # Then page display an error",
            "        self.assertInBody('Invalid username or password.')",
            "        self.assertInBody('id=\"form-login\"')",
            "        # Then redirect URL is ignored",
            "        self.assertNotInBody('/browse/' + self.REPO + '/DIR%EF%BF%BD/\"')",
            "",
            "    def test_getpage_without_username(self):",
            "        \"\"\"",
            "        Check if error is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/login/', method='GET')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getpage_with_username_too_long(self):",
            "        b = {'login': 'admin' * 52, 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Username too long.')",
            "",
            "    def test_getpage_with_empty_password(self):",
            "        \"\"\"",
            "        Check if authentication is failing without a password.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': ''}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('This field is required.')",
            "",
            "    def test_getpage_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='GET')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_post_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='POST')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_login_twice(self):",
            "        # Given an authenticated user",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "        # Given another user",
            "        UserObject.add_user('otheruser', password='password')",
            "        # When trying to re-authenticated with login page",
            "        self.getPage('/login/', method='POST', body={'login': 'otheruser', 'password': 'password'})",
            "        # Then user is still authenticated with previous user",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "",
            "    def test_login_persistent(self):",
            "        # Given a user authenticated with persistent",
            "        self.getPage('/logout/')",
            "        self.assertStatus(303)",
            "        self.getPage(",
            "            '/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD, 'persistent': '1'}",
            "        )",
            "        self.assertStatus(303)",
            "        # Then a persistent cookie is return",
            "        self.assertIn('expires', self.cookies[0][1])",
            "        self.assertIn('Max-Age', self.cookies[0][1])",
            "        # Then a session is created with persistent flag",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertTrue(session['login_persistent'])",
            "        # Then session timeout is 30 days in future",
            "        self.assertAlmostEqual(session.timeout, 43200, delta=2)",
            "",
            "",
            "class LoginPageWithWelcomeMsgTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'welcomemsg': 'default message', 'welcomemsg[fr]': 'french message'}",
            "",
            "    def test_getpage_default(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"it\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('default message')",
            "",
            "    def test_getpage_french(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"fr\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('french message')",
            "",
            "",
            "class LoginPageWithHeaderName(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'header-name': 'HEADER-NAME'}",
            "",
            "    def test_getpage_default(self):",
            "        # Given a custom header-name",
            "        # When querying the loging page",
            "        self.getPage('/login/')",
            "        # Then the page display the header-name",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('HEADER-NAME')",
            "",
            "",
            "@parameterized_class(",
            "    [",
            "        {\"default_config\": {'rate-limit': 5}},",
            "        {\"default_config\": {'rate-limit': 5, 'rate-limit-dir': '/tmp'}},",
            "    ]",
            ")",
            "class LoginPageRateLimitTest(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        if os.path.isfile('/tmp/ratelimit-127.0.0.1'):",
            "            os.unlink('/tmp/ratelimit-127.0.0.1')",
            "        if os.path.isfile('/tmp/ratelimit-127.0.0.1.-login'):",
            "            os.unlink('/tmp/ratelimit-127.0.0.1.-login')",
            "        return super().setUp()",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page",
            "        for i in range(1, 5):",
            "            self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})",
            "            self.assertStatus(200)",
            "        # Then a 429 error (too many request) is return",
            "        self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTest2(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'rate-limit': 5}",
            "",
            "    def test_login_ratelimit_forwarded_for(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page with different `X-Forwarded-For`",
            "        for i in range(1, 5):",
            "            self.getPage(",
            "                '/login/',",
            "                headers=[('X-Forwarded-For', '127.0.0.%s' % i)],",
            "                method='POST',",
            "                body={'login': 'invalid', 'password': 'invalid'},",
            "            )",
            "            self.assertStatus(200)",
            "        # Then original IP get blocked",
            "        self.getPage(",
            "            '/login/',",
            "            headers=[('X-Forwarded-For', '127.0.0.%s' % i)],",
            "            method='POST',",
            "            body={'login': 'invalid', 'password': 'invalid'},",
            "        )",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTest3(rdiffweb.test.WebCase):",
            "    default_config = {'rate-limit': 5}",
            "",
            "    def test_login_ratelimit_real_ip(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page with different `X-Real-IP`",
            "        for i in range(1, 5):",
            "            self.getPage(",
            "                '/login/',",
            "                headers=[('X-Real-IP', '127.0.0.128')],",
            "                method='POST',",
            "                body={'login': 'invalid', 'password': 'invalid'},",
            "            )",
            "            self.assertStatus(200)",
            "        # Then the X-Real-IP get blocked",
            "        self.getPage(",
            "            '/login/',",
            "            headers=[('X-Real-IP', '127.0.0.128')],",
            "            method='POST',",
            "            body={'login': 'invalid', 'password': 'invalid'},",
            "        )",
            "        self.assertStatus(429)",
            "",
            "",
            "class LogoutPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage_without_login(self):",
            "        # Given an unauthenticated user",
            "        # When Accessing logout page directly",
            "        self.getPage('/logout')",
            "        # Then user is redirect to root '/'",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "    def test_getpage_with_login(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Login",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        prev_session_id = self.session_id",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('200 OK')",
            "        # When logout",
            "        self.getPage('/logout')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected to root page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "import os",
            "",
            "from parameterized import parameterized, parameterized_class",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import DbSession, SessionObject, UserObject",
            "from rdiffweb.tools.auth_form import LOGIN_TIME, SESSION_KEY",
            "",
            "",
            "class LoginPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage('/')",
            "        # Then user is redirected to login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a session object is created without a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNone(session.get(SESSION_KEY))",
            "",
            "    def test_login_success(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authenticating with valid credentials.",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then a new session_id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Then a session object is created with a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertEqual('admin', session.get(SESSION_KEY))",
            "        self.assertIsNotNone(session.get(LOGIN_TIME))",
            "",
            "    def test_cookie_http_only(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with HttpOnly",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('HttpOnly', cookie)",
            "",
            "    def test_login_with_plaintext(self):",
            "        \"\"\"",
            "        Requesting plain text without being authenticated should show the login form.",
            "        \"\"\"",
            "        # When querying root page without authentication",
            "        self.getPage('/', headers=[(\"Accept\", \"text/plain\")])",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('with_root', '/'),",
            "            ('with_browse_url', '/browse/admin/testcases/Revisions/'),",
            "            ('with_encoded_url', '/browse/admin/testcases/DIR%EF%BF%BD/'),",
            "            (",
            "                'with_broken_encoding',",
            "                '/restore/admin/testcases/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt/?date=1415221507',",
            "            ),",
            "            ('with_query_string', '/restore/admin/testcases/Revisions?date=1477434528'),",
            "            ('with_multiple_query_string', '/restore/admin/testcases/Revisions?date=1477434528&kind=tar.gz'),",
            "            ('with_admin', '/admin/'),",
            "        ]",
            "    )",
            "    def test_login(self, unused, original_url):",
            "        # Given an unauthenticated user",
            "        # Query the page without login-in",
            "        self.getPage(original_url)",
            "        # Then user is redirected to the login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authentication is successful",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then user is redirected to original URL",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + original_url)",
            "        # Then cookie is not persistent",
            "        self.assertNotIn('expires', self.cookies[0][1])",
            "        self.assertNotIn('Max-Age', self.cookies[0][1])",
            "        # When requesting the original page",
            "        self.getPage(original_url)",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "",
            "    def test_getpage_with_redirect_post(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using POST method.",
            "        \"\"\"",
            "        # When posting invalid credentials",
            "        b = {'login': 'admin', 'password': 'invalid', 'redirect': '/browse/' + self.REPO + '/DIR%EF%BF%BD/'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        # Then page return without HTTP Error",
            "        self.assertStatus('200 OK')",
            "        # Then page display an error",
            "        self.assertInBody('Invalid username or password.')",
            "        self.assertInBody('id=\"form-login\"')",
            "        # Then redirect URL is ignored",
            "        self.assertNotInBody('/browse/' + self.REPO + '/DIR%EF%BF%BD/\"')",
            "",
            "    def test_getpage_without_username(self):",
            "        \"\"\"",
            "        Check if error is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/login/', method='GET')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getpage_with_username_too_long(self):",
            "        b = {'login': 'admin' * 52, 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Username too long.')",
            "",
            "    def test_getpage_with_empty_password(self):",
            "        \"\"\"",
            "        Check if authentication is failing without a password.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': ''}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('This field is required.')",
            "",
            "    def test_getpage_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='GET')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_post_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='POST')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_login_twice(self):",
            "        # Given an authenticated user",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "        # Given another user",
            "        userobj = UserObject.add_user('otheruser', password='password')",
            "        userobj.commit()",
            "        # When trying to re-authenticated with login page",
            "        self.getPage('/login/', method='POST', body={'login': 'otheruser', 'password': 'password'})",
            "        # Then user is still authenticated with previous user",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "",
            "    def test_login_persistent(self):",
            "        # Given a user authenticated with persistent",
            "        self.getPage('/logout/')",
            "        self.assertStatus(303)",
            "        self.getPage(",
            "            '/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD, 'persistent': '1'}",
            "        )",
            "        self.assertStatus(303)",
            "        # Then a persistent cookie is return",
            "        self.assertIn('expires', self.cookies[0][1])",
            "        self.assertIn('Max-Age', self.cookies[0][1])",
            "        # Then a session is created with persistent flag",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertTrue(session['login_persistent'])",
            "        # Then session timeout is 30 days in future",
            "        self.assertAlmostEqual(session.timeout, 43200, delta=2)",
            "",
            "",
            "class LoginPageWithWelcomeMsgTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'welcomemsg': 'default message', 'welcomemsg[fr]': 'french message'}",
            "",
            "    def test_getpage_default(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"it\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('default message')",
            "",
            "    def test_getpage_french(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"fr\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('french message')",
            "",
            "",
            "class LoginPageWithHeaderName(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'header-name': 'HEADER-NAME'}",
            "",
            "    def test_getpage_default(self):",
            "        # Given a custom header-name",
            "        # When querying the loging page",
            "        self.getPage('/login/')",
            "        # Then the page display the header-name",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('HEADER-NAME')",
            "",
            "",
            "@parameterized_class(",
            "    [",
            "        {\"default_config\": {'rate-limit': 5}},",
            "        {\"default_config\": {'rate-limit': 5, 'rate-limit-dir': '/tmp'}},",
            "    ]",
            ")",
            "class LoginPageRateLimitTest(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        if os.path.isfile('/tmp/ratelimit-127.0.0.1'):",
            "            os.unlink('/tmp/ratelimit-127.0.0.1')",
            "        if os.path.isfile('/tmp/ratelimit-127.0.0.1.-login'):",
            "            os.unlink('/tmp/ratelimit-127.0.0.1.-login')",
            "        return super().setUp()",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page",
            "        for i in range(1, 5):",
            "            self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})",
            "            self.assertStatus(200)",
            "        # Then a 429 error (too many request) is return",
            "        self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTest2(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'rate-limit': 5}",
            "",
            "    def test_login_ratelimit_forwarded_for(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page with different `X-Forwarded-For`",
            "        for i in range(1, 5):",
            "            self.getPage(",
            "                '/login/',",
            "                headers=[('X-Forwarded-For', '127.0.0.%s' % i)],",
            "                method='POST',",
            "                body={'login': 'invalid', 'password': 'invalid'},",
            "            )",
            "            self.assertStatus(200)",
            "        # Then original IP get blocked",
            "        self.getPage(",
            "            '/login/',",
            "            headers=[('X-Forwarded-For', '127.0.0.%s' % i)],",
            "            method='POST',",
            "            body={'login': 'invalid', 'password': 'invalid'},",
            "        )",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTest3(rdiffweb.test.WebCase):",
            "    default_config = {'rate-limit': 5}",
            "",
            "    def test_login_ratelimit_real_ip(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page with different `X-Real-IP`",
            "        for i in range(1, 5):",
            "            self.getPage(",
            "                '/login/',",
            "                headers=[('X-Real-IP', '127.0.0.128')],",
            "                method='POST',",
            "                body={'login': 'invalid', 'password': 'invalid'},",
            "            )",
            "            self.assertStatus(200)",
            "        # Then the X-Real-IP get blocked",
            "        self.getPage(",
            "            '/login/',",
            "            headers=[('X-Real-IP', '127.0.0.128')],",
            "            method='POST',",
            "            body={'login': 'invalid', 'password': 'invalid'},",
            "        )",
            "        self.assertStatus(429)",
            "",
            "",
            "class LogoutPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage_without_login(self):",
            "        # Given an unauthenticated user",
            "        # When Accessing logout page directly",
            "        self.getPage('/logout')",
            "        # Then user is redirect to root '/'",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "    def test_getpage_with_login(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Login",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        prev_session_id = self.session_id",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('200 OK')",
            "        # When logout",
            "        self.getPage('/logout')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected to root page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "173": [
                "LoginPageTest",
                "test_login_twice"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_logs.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         # Given a failed repo\r"
            },
            "1": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "         admin = UserObject.get_user('admin')\r"
            },
            "2": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "         admin.user_root = 'invalid'\r"
            },
            "3": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        admin.add()\r"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+        admin.commit()\r"
            },
            "5": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 104,
                "PatchRowcode": "         # When querying the logs\r"
            },
            "6": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "         self._log(self.USERNAME, self.REPO)\r"
            },
            "7": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "         # Then the page is return with an error message\r"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\"\"\"\r",
            "Created on Apr 26, 2021\r",
            "\r",
            "@author: Patrik Dufresne\r",
            "\"\"\"\r",
            "\r",
            "import os\r",
            "\r",
            "import rdiffweb.test\r",
            "from rdiffweb.core.model import UserObject\r",
            "from rdiffweb.core.rdw_templating import url_for\r",
            "\r",
            "\r",
            "class LogsPageTest(rdiffweb.test.WebCase):\r",
            "\r",
            "    login = True\r",
            "\r",
            "    def _log(self, user, repo, limit=None, date=None, file=None, raw=None):\r",
            "        url = url_for('logs', user, repo, limit=limit, date=date, file=file, raw=raw)\r",
            "        return self.getPage(url)\r",
            "\r",
            "    def test_logs(self):\r",
            "        self._log(self.USERNAME, self.REPO)\r",
            "        # Check revisions\r",
            "        self.assertInBody(\"Backup Log\")\r",
            "        self.assertInBody(\"Restore Log\")\r",
            "        # Check show more button get displayed\r",
            "        self.assertInBody(\"Show more\")\r",
            "\r",
            "    def test_logs_with_date_notfound(self):\r",
            "        self._log(self.USERNAME, self.REPO, date=1)\r",
            "        self.assertStatus(404)\r",
            "\r",
            "    def test_logs_with_date_invalid(self):\r",
            "        self._log(self.USERNAME, self.REPO, date='invalid')\r",
            "        self.assertStatus(400)\r",
            "\r",
            "    def test_logs_with_file_backup(self):\r",
            "        self._log(self.USERNAME, self.REPO, file='backup.log')\r",
            "        self.assertStatus(200)\r",
            "\r",
            "    def test_logs_with_file_backup_missing(self):\r",
            "        os.unlink(os.path.join(self.testcases, self.REPO, 'rdiff-backup-data', 'backup.log'))\r",
            "        self._log(self.USERNAME, self.REPO, file='backup.log')\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody(\"This log file is empty\")\r",
            "\r",
            "    def test_logs_with_file_restore(self):\r",
            "        self._log(self.USERNAME, self.REPO, file='restore.log')\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody(\"Starting restore of\")\r",
            "\r",
            "    def test_logs_with_file_restore_missing(self):\r",
            "        os.unlink(os.path.join(self.testcases, self.REPO, 'rdiff-backup-data', 'restore.log'))\r",
            "        self._log(self.USERNAME, self.REPO, file='restore.log')\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody(\"This log file is empty\")\r",
            "\r",
            "    def test_logs_with_date_valid(self):\r",
            "        self._log(self.USERNAME, self.REPO, date='1454448640')\r",
            "        self.assertStatus(200)\r",
            "\r",
            "    def test_logs_with_limit(self):\r",
            "        self._log(self.USERNAME, self.REPO, limit=50)\r",
            "        self.assertStatus(200)\r",
            "        self.assertNotInBody(\"Show more\")\r",
            "\r",
            "    def test_logs_with_raw(self):\r",
            "        self._log(self.USERNAME, self.REPO, file='restore.log', raw=1)\r",
            "        self.assertStatus(200)\r",
            "        self.assertHeaderItemValue('Content-Type', 'text/plain;charset=utf-8')\r",
            "        self.assertInBody(\"Starting restore of\")\r",
            "        self.assertNotInBody(\"<html\")\r",
            "\r",
            "    def test_logs_does_not_exists(self):\r",
            "        # Given an invalid repo\r",
            "        repo = 'invalid'\r",
            "        # When trying to get logs from it\r",
            "        self._log(self.USERNAME, repo)\r",
            "        # Then a 4040 error is return\r",
            "        self.assertStatus(404)\r",
            "\r",
            "    def test_browser_with_failed_repo(self):\r",
            "        # Given a failed repo\r",
            "        admin = UserObject.get_user('admin')\r",
            "        admin.user_root = 'invalid'\r",
            "        admin.add()\r",
            "        # When querying the logs\r",
            "        self._log(self.USERNAME, self.REPO)\r",
            "        # Then the page is return with an error message\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')\r"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\"\"\"\r",
            "Created on Apr 26, 2021\r",
            "\r",
            "@author: Patrik Dufresne\r",
            "\"\"\"\r",
            "\r",
            "import os\r",
            "\r",
            "import rdiffweb.test\r",
            "from rdiffweb.core.model import UserObject\r",
            "from rdiffweb.core.rdw_templating import url_for\r",
            "\r",
            "\r",
            "class LogsPageTest(rdiffweb.test.WebCase):\r",
            "\r",
            "    login = True\r",
            "\r",
            "    def _log(self, user, repo, limit=None, date=None, file=None, raw=None):\r",
            "        url = url_for('logs', user, repo, limit=limit, date=date, file=file, raw=raw)\r",
            "        return self.getPage(url)\r",
            "\r",
            "    def test_logs(self):\r",
            "        self._log(self.USERNAME, self.REPO)\r",
            "        # Check revisions\r",
            "        self.assertInBody(\"Backup Log\")\r",
            "        self.assertInBody(\"Restore Log\")\r",
            "        # Check show more button get displayed\r",
            "        self.assertInBody(\"Show more\")\r",
            "\r",
            "    def test_logs_with_date_notfound(self):\r",
            "        self._log(self.USERNAME, self.REPO, date=1)\r",
            "        self.assertStatus(404)\r",
            "\r",
            "    def test_logs_with_date_invalid(self):\r",
            "        self._log(self.USERNAME, self.REPO, date='invalid')\r",
            "        self.assertStatus(400)\r",
            "\r",
            "    def test_logs_with_file_backup(self):\r",
            "        self._log(self.USERNAME, self.REPO, file='backup.log')\r",
            "        self.assertStatus(200)\r",
            "\r",
            "    def test_logs_with_file_backup_missing(self):\r",
            "        os.unlink(os.path.join(self.testcases, self.REPO, 'rdiff-backup-data', 'backup.log'))\r",
            "        self._log(self.USERNAME, self.REPO, file='backup.log')\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody(\"This log file is empty\")\r",
            "\r",
            "    def test_logs_with_file_restore(self):\r",
            "        self._log(self.USERNAME, self.REPO, file='restore.log')\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody(\"Starting restore of\")\r",
            "\r",
            "    def test_logs_with_file_restore_missing(self):\r",
            "        os.unlink(os.path.join(self.testcases, self.REPO, 'rdiff-backup-data', 'restore.log'))\r",
            "        self._log(self.USERNAME, self.REPO, file='restore.log')\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody(\"This log file is empty\")\r",
            "\r",
            "    def test_logs_with_date_valid(self):\r",
            "        self._log(self.USERNAME, self.REPO, date='1454448640')\r",
            "        self.assertStatus(200)\r",
            "\r",
            "    def test_logs_with_limit(self):\r",
            "        self._log(self.USERNAME, self.REPO, limit=50)\r",
            "        self.assertStatus(200)\r",
            "        self.assertNotInBody(\"Show more\")\r",
            "\r",
            "    def test_logs_with_raw(self):\r",
            "        self._log(self.USERNAME, self.REPO, file='restore.log', raw=1)\r",
            "        self.assertStatus(200)\r",
            "        self.assertHeaderItemValue('Content-Type', 'text/plain;charset=utf-8')\r",
            "        self.assertInBody(\"Starting restore of\")\r",
            "        self.assertNotInBody(\"<html\")\r",
            "\r",
            "    def test_logs_does_not_exists(self):\r",
            "        # Given an invalid repo\r",
            "        repo = 'invalid'\r",
            "        # When trying to get logs from it\r",
            "        self._log(self.USERNAME, repo)\r",
            "        # Then a 4040 error is return\r",
            "        self.assertStatus(404)\r",
            "\r",
            "    def test_browser_with_failed_repo(self):\r",
            "        # Given a failed repo\r",
            "        admin = UserObject.get_user('admin')\r",
            "        admin.user_root = 'invalid'\r",
            "        admin.commit()\r",
            "        # When querying the logs\r",
            "        self._log(self.USERNAME, self.REPO)\r",
            "        # Then the page is return with an error message\r",
            "        self.assertStatus(200)\r",
            "        self.assertInBody('The repository cannot be found or is badly damaged.')\r"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "103": [
                "LogsPageTest",
                "test_browser_with_failed_repo"
            ]
        },
        "addLocation": []
    }
}