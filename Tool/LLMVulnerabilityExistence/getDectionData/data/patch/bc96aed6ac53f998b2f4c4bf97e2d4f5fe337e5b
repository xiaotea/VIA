{
    "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from django.contrib.auth import get_user_model"
            },
            "1": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 2,
                "PatchRowcode": "+from django.contrib.auth.models import Permission"
            },
            "2": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from django.http import HttpRequest, HttpResponse"
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " from django.test import TestCase"
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from django.urls import reverse"
            },
            "5": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "             response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\""
            },
            "6": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "         )"
            },
            "7": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 54,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+    def test_user_permissions_required(self):"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+        # Log in with a user that doesn't have permission to delete users"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+        user = self.create_user(username=\"editor\", password=\"password\")"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+        admin_permission = Permission.objects.get("
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+            content_type__app_label=\"wagtailadmin\", codename=\"access_admin\""
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+        )"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+        user.user_permissions.add(admin_permission)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+        self.login(username=\"editor\", password=\"password\")"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        response = self.client.get(self.url)"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+        self.assertRedirects(response, \"/admin/\")"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "     def test_bulk_delete(self):"
            },
            "21": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "         response = self.client.post(self.url)"
            },
            "22": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 69,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "from django.contrib.auth import get_user_model",
            "from django.http import HttpRequest, HttpResponse",
            "from django.test import TestCase",
            "from django.urls import reverse",
            "",
            "from wagtail.test.utils import WagtailTestUtils",
            "from wagtail.users.views.bulk_actions.user_bulk_action import UserBulkAction",
            "",
            "User = get_user_model()",
            "",
            "",
            "class TestUserDeleteView(WagtailTestUtils, TestCase):",
            "    def setUp(self):",
            "        # create a set of test users",
            "        self.test_users = [",
            "            self.create_user(",
            "                username=f\"testuser-{i}\",",
            "                email=f\"testuser{i}@email.com\",",
            "                password=f\"password-{i}\",",
            "            )",
            "            for i in range(1, 6)",
            "        ]",
            "        # also create a superuser to delete",
            "        self.superuser = self.create_superuser(",
            "            username=\"testsuperuser\",",
            "            email=\"testsuperuser@email.com\",",
            "            password=\"password\",",
            "        )",
            "        self.current_user = self.login()",
            "        self.url = (",
            "            reverse(",
            "                \"wagtail_bulk_action\",",
            "                args=(",
            "                    User._meta.app_label,",
            "                    User._meta.model_name,",
            "                    \"delete\",",
            "                ),",
            "            )",
            "            + \"?\"",
            "        )",
            "        for user in self.test_users:",
            "            self.url += f\"id={user.pk}&\"",
            "",
            "        self.self_delete_url = self.url + f\"id={self.current_user.pk}\"",
            "        self.superuser_delete_url = self.url + f\"id={self.superuser.pk}\"",
            "",
            "    def test_simple(self):",
            "        response = self.client.get(self.url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertTemplateUsed(",
            "            response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
            "        )",
            "",
            "    def test_bulk_delete(self):",
            "        response = self.client.post(self.url)",
            "",
            "        # Should redirect back to index",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        # Check that the users were deleted",
            "        for user in self.test_users:",
            "            self.assertFalse(User.objects.filter(email=user.email).exists())",
            "",
            "    def test_user_cannot_delete_self(self):",
            "        response = self.client.get(self.self_delete_url)",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        html = response.content.decode()",
            "        self.assertInHTML(\"<p>You don't have permission to delete this user</p>\", html)",
            "",
            "        needle = \"<ul>\"",
            "        needle += f\"<li>{self.current_user.email}</li>\"",
            "        needle += \"</ul>\"",
            "        self.assertInHTML(needle, html)",
            "",
            "        self.client.post(self.self_delete_url)",
            "",
            "        # Check user was not deleted",
            "        self.assertTrue(User.objects.filter(pk=self.current_user.pk).exists())",
            "",
            "    def test_user_can_delete_other_superuser(self):",
            "        response = self.client.get(self.superuser_delete_url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertTemplateUsed(",
            "            response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
            "        )",
            "",
            "        response = self.client.post(self.superuser_delete_url)",
            "        # Should redirect back to index",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        # Check that the user was deleted",
            "        users = User.objects.filter(email=self.superuser.email)",
            "        self.assertEqual(users.count(), 0)",
            "",
            "    def test_before_delete_user_hook_post(self):",
            "        def hook_func(request, action_type, users, action_class_instance):",
            "            self.assertEqual(action_type, \"delete\")",
            "            self.assertIsInstance(request, HttpRequest)",
            "            self.assertIsInstance(action_class_instance, UserBulkAction)",
            "            self.assertCountEqual(",
            "                [user.pk for user in self.test_users], [user.pk for user in users]",
            "            )",
            "",
            "            return HttpResponse(\"Overridden!\")",
            "",
            "        with self.register_hook(\"before_bulk_action\", hook_func):",
            "            response = self.client.post(self.url)",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b\"Overridden!\")",
            "",
            "        for user in self.test_users:",
            "            self.assertTrue(User.objects.filter(email=user.email).exists())",
            "",
            "    def test_after_delete_user_hook(self):",
            "        def hook_func(request, action_type, users, action_class_instance):",
            "            self.assertEqual(action_type, \"delete\")",
            "            self.assertIsInstance(request, HttpRequest)",
            "            self.assertIsInstance(action_class_instance, UserBulkAction)",
            "",
            "            return HttpResponse(\"Overridden!\")",
            "",
            "        with self.register_hook(\"after_bulk_action\", hook_func):",
            "            response = self.client.post(self.url)",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b\"Overridden!\")",
            "",
            "        for user in self.test_users:",
            "            self.assertFalse(User.objects.filter(email=user.email).exists())"
        ],
        "afterPatchFile": [
            "from django.contrib.auth import get_user_model",
            "from django.contrib.auth.models import Permission",
            "from django.http import HttpRequest, HttpResponse",
            "from django.test import TestCase",
            "from django.urls import reverse",
            "",
            "from wagtail.test.utils import WagtailTestUtils",
            "from wagtail.users.views.bulk_actions.user_bulk_action import UserBulkAction",
            "",
            "User = get_user_model()",
            "",
            "",
            "class TestUserDeleteView(WagtailTestUtils, TestCase):",
            "    def setUp(self):",
            "        # create a set of test users",
            "        self.test_users = [",
            "            self.create_user(",
            "                username=f\"testuser-{i}\",",
            "                email=f\"testuser{i}@email.com\",",
            "                password=f\"password-{i}\",",
            "            )",
            "            for i in range(1, 6)",
            "        ]",
            "        # also create a superuser to delete",
            "        self.superuser = self.create_superuser(",
            "            username=\"testsuperuser\",",
            "            email=\"testsuperuser@email.com\",",
            "            password=\"password\",",
            "        )",
            "        self.current_user = self.login()",
            "        self.url = (",
            "            reverse(",
            "                \"wagtail_bulk_action\",",
            "                args=(",
            "                    User._meta.app_label,",
            "                    User._meta.model_name,",
            "                    \"delete\",",
            "                ),",
            "            )",
            "            + \"?\"",
            "        )",
            "        for user in self.test_users:",
            "            self.url += f\"id={user.pk}&\"",
            "",
            "        self.self_delete_url = self.url + f\"id={self.current_user.pk}\"",
            "        self.superuser_delete_url = self.url + f\"id={self.superuser.pk}\"",
            "",
            "    def test_simple(self):",
            "        response = self.client.get(self.url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertTemplateUsed(",
            "            response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
            "        )",
            "",
            "    def test_user_permissions_required(self):",
            "        # Log in with a user that doesn't have permission to delete users",
            "        user = self.create_user(username=\"editor\", password=\"password\")",
            "        admin_permission = Permission.objects.get(",
            "            content_type__app_label=\"wagtailadmin\", codename=\"access_admin\"",
            "        )",
            "        user.user_permissions.add(admin_permission)",
            "        self.login(username=\"editor\", password=\"password\")",
            "",
            "        response = self.client.get(self.url)",
            "        self.assertRedirects(response, \"/admin/\")",
            "",
            "    def test_bulk_delete(self):",
            "        response = self.client.post(self.url)",
            "",
            "        # Should redirect back to index",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        # Check that the users were deleted",
            "        for user in self.test_users:",
            "            self.assertFalse(User.objects.filter(email=user.email).exists())",
            "",
            "    def test_user_cannot_delete_self(self):",
            "        response = self.client.get(self.self_delete_url)",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        html = response.content.decode()",
            "        self.assertInHTML(\"<p>You don't have permission to delete this user</p>\", html)",
            "",
            "        needle = \"<ul>\"",
            "        needle += f\"<li>{self.current_user.email}</li>\"",
            "        needle += \"</ul>\"",
            "        self.assertInHTML(needle, html)",
            "",
            "        self.client.post(self.self_delete_url)",
            "",
            "        # Check user was not deleted",
            "        self.assertTrue(User.objects.filter(pk=self.current_user.pk).exists())",
            "",
            "    def test_user_can_delete_other_superuser(self):",
            "        response = self.client.get(self.superuser_delete_url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertTemplateUsed(",
            "            response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
            "        )",
            "",
            "        response = self.client.post(self.superuser_delete_url)",
            "        # Should redirect back to index",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        # Check that the user was deleted",
            "        users = User.objects.filter(email=self.superuser.email)",
            "        self.assertEqual(users.count(), 0)",
            "",
            "    def test_before_delete_user_hook_post(self):",
            "        def hook_func(request, action_type, users, action_class_instance):",
            "            self.assertEqual(action_type, \"delete\")",
            "            self.assertIsInstance(request, HttpRequest)",
            "            self.assertIsInstance(action_class_instance, UserBulkAction)",
            "            self.assertCountEqual(",
            "                [user.pk for user in self.test_users], [user.pk for user in users]",
            "            )",
            "",
            "            return HttpResponse(\"Overridden!\")",
            "",
            "        with self.register_hook(\"before_bulk_action\", hook_func):",
            "            response = self.client.post(self.url)",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b\"Overridden!\")",
            "",
            "        for user in self.test_users:",
            "            self.assertTrue(User.objects.filter(email=user.email).exists())",
            "",
            "    def test_after_delete_user_hook(self):",
            "        def hook_func(request, action_type, users, action_class_instance):",
            "            self.assertEqual(action_type, \"delete\")",
            "            self.assertIsInstance(request, HttpRequest)",
            "            self.assertIsInstance(action_class_instance, UserBulkAction)",
            "",
            "            return HttpResponse(\"Overridden!\")",
            "",
            "        with self.register_hook(\"after_bulk_action\", hook_func):",
            "            response = self.client.post(self.url)",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b\"Overridden!\")",
            "",
            "        for user in self.test_users:",
            "            self.assertFalse(User.objects.filter(email=user.email).exists())"
        ],
        "action": [
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "wagtail.users.tests.test_bulk_actions.test_bulk_delete.TestUserDeleteView.self",
            "tuf.client.updater.Updater._get_target_from_targets_role"
        ]
    },
    "wagtail/users/views/bulk_actions/user_bulk_action.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from django.contrib.auth import get_user_model"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from wagtail.admin.views.bulk_action import BulkAction"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from wagtail.admin.views.generic.permissions import PermissionCheckedMixin"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+from wagtail.permission_policies import ModelPermissionPolicy"
            },
            "5": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from wagtail.users.views.users import get_users_filter_query"
            },
            "6": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+User = get_user_model()"
            },
            "8": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class UserBulkAction(BulkAction):"
            },
            "10": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    models = [get_user_model()]"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+class UserBulkAction(PermissionCheckedMixin, BulkAction):"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+    models = [User]"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+    permission_policy = ModelPermissionPolicy(User)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+    any_permission_required = [\"add\", \"change\", \"delete\"]"
            },
            "16": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 16,
                "PatchRowcode": "     def get_all_objects_in_listing_query(self, parent_id):"
            },
            "18": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 17,
                "PatchRowcode": "         listing_objects = self.model.objects.all().values_list(\"pk\", flat=True)"
            }
        },
        "frontPatchFile": [
            "from django.contrib.auth import get_user_model",
            "",
            "from wagtail.admin.views.bulk_action import BulkAction",
            "from wagtail.users.views.users import get_users_filter_query",
            "",
            "",
            "class UserBulkAction(BulkAction):",
            "    models = [get_user_model()]",
            "",
            "    def get_all_objects_in_listing_query(self, parent_id):",
            "        listing_objects = self.model.objects.all().values_list(\"pk\", flat=True)",
            "        if \"q\" in self.request.GET:",
            "            q = self.request.GET.get(\"q\")",
            "            model_fields = {f.name for f in self.model._meta.get_fields()}",
            "            conditions = get_users_filter_query(q, model_fields)",
            "",
            "            listing_objects = listing_objects.filter(conditions)",
            "",
            "        return listing_objects"
        ],
        "afterPatchFile": [
            "from django.contrib.auth import get_user_model",
            "",
            "from wagtail.admin.views.bulk_action import BulkAction",
            "from wagtail.admin.views.generic.permissions import PermissionCheckedMixin",
            "from wagtail.permission_policies import ModelPermissionPolicy",
            "from wagtail.users.views.users import get_users_filter_query",
            "",
            "User = get_user_model()",
            "",
            "",
            "class UserBulkAction(PermissionCheckedMixin, BulkAction):",
            "    models = [User]",
            "    permission_policy = ModelPermissionPolicy(User)",
            "    any_permission_required = [\"add\", \"change\", \"delete\"]",
            "",
            "    def get_all_objects_in_listing_query(self, parent_id):",
            "        listing_objects = self.model.objects.all().values_list(\"pk\", flat=True)",
            "        if \"q\" in self.request.GET:",
            "            q = self.request.GET.get(\"q\")",
            "            model_fields = {f.name for f in self.model._meta.get_fields()}",
            "            conditions = get_users_filter_query(q, model_fields)",
            "",
            "            listing_objects = listing_objects.filter(conditions)",
            "",
            "        return listing_objects"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "-1",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "7": [
                "UserBulkAction"
            ],
            "8": [
                "UserBulkAction"
            ]
        },
        "addLocation": []
    }
}