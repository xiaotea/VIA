{
    "rdiffweb/controller/__init__.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "     assert level in ['info', 'error', 'warning', 'success']\r"
            },
            "1": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "     if 'flash' not in cherrypy.session:  # @UndefinedVariable\r"
            },
            "2": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "         cherrypy.session['flash'] = []  # @UndefinedVariable\r"
            },
            "3": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    flash_message = FlashMessage(message, level)\r"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+    flash_message = FlashMessage(str(message), level)\r"
            },
            "5": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "     cherrypy.session['flash'].append(flash_message)\r"
            },
            "6": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 74,
                "PatchRowcode": " \r"
            },
            "7": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 75,
                "PatchRowcode": " \r"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\r",
            "import logging\r",
            "import os\r",
            "from collections import namedtuple\r",
            "\r",
            "import cherrypy\r",
            "import pkg_resources\r",
            "\r",
            "from rdiffweb.core.config import Option\r",
            "from rdiffweb.core.librdiff import RdiffTime\r",
            "from rdiffweb.tools.i18n import ugettext as _\r",
            "\r",
            "# Define the logger\r",
            "logger = logging.getLogger(__name__)\r",
            "\r",
            "\r",
            "def validate(value, message=None):\r",
            "    \"\"\"Raise HTTP error if value is not true.\"\"\"\r",
            "    if not value:\r",
            "        raise cherrypy.HTTPError(400, message)\r",
            "\r",
            "\r",
            "def validate_int(value, message=None):\r",
            "    \"\"\"Raise HTTP Error if the value is not an integer\"\"\"\r",
            "    try:\r",
            "        return int(value)\r",
            "    except ValueError:\r",
            "        raise cherrypy.HTTPError(400, message)\r",
            "\r",
            "\r",
            "def validate_isinstance(value, cls, message=None):\r",
            "    \"\"\"Raise HTTP error if value is not cls.\"\"\"\r",
            "    if not isinstance(value, cls):\r",
            "        raise cherrypy.HTTPError(400, message)\r",
            "\r",
            "\r",
            "def validate_date(value, message=None):\r",
            "    try:\r",
            "        return RdiffTime(int(value))\r",
            "    except ValueError:\r",
            "        logger.warning(\"invalid date %s\", value)\r",
            "        raise cherrypy.HTTPError(400, message or _('Invalid date.'))\r",
            "\r",
            "\r",
            "FlashMessage = namedtuple('FlashMessage', ['message', 'level'])\r",
            "\r",
            "\r",
            "def flash(message, level='info'):\r",
            "    \"\"\"\r",
            "    Add a flashin message to the session.\r",
            "    \"\"\"\r",
            "    assert message\r",
            "    assert level in ['info', 'error', 'warning', 'success']\r",
            "    if 'flash' not in cherrypy.session:  # @UndefinedVariable\r",
            "        cherrypy.session['flash'] = []  # @UndefinedVariable\r",
            "    flash_message = FlashMessage(message, level)\r",
            "    cherrypy.session['flash'].append(flash_message)\r",
            "\r",
            "\r",
            "def get_flashed_messages():\r",
            "    if 'flash' in cherrypy.session:  # @UndefinedVariable\r",
            "        messages = cherrypy.session['flash']  # @UndefinedVariable\r",
            "        del cherrypy.session['flash']  # @UndefinedVariable\r",
            "        return messages\r",
            "    return []\r",
            "\r",
            "\r",
            "class Controller(object):\r",
            "\r",
            "    _header_name = Option(\"header_name\")\r",
            "\r",
            "    _footername = Option(\"footer_name\")\r",
            "\r",
            "    _footerurl = Option(\"footer_url\")\r",
            "\r",
            "    _default_theme = Option(\"default_theme\")\r",
            "\r",
            "    @property\r",
            "    def app(self):\r",
            "        return cherrypy.request.app\r",
            "\r",
            "    def _compile_template(self, template_name, **kwargs):\r",
            "        \"\"\"\r",
            "        Used to generate a standard HTML page using the given template.\r",
            "        This method should be used by subclasses to provide default template\r",
            "        value.\r",
            "        \"\"\"\r",
            "        loc = cherrypy.response.i18n.locale\r",
            "        parms = {\r",
            "            \"lang\": loc.language,\r",
            "            \"header_name\": self._header_name,\r",
            "            \"theme\": self._default_theme,\r",
            "            \"footername\": self._footername,\r",
            "            \"footerurl\": self._footerurl,\r",
            "            \"get_flashed_messages\": get_flashed_messages,\r",
            "        }\r",
            "        if self.app.currentuser:\r",
            "            parms.update(\r",
            "                {\r",
            "                    'username': self.app.currentuser.username,\r",
            "                    'fullname': self.app.currentuser.fullname,\r",
            "                    'is_admin': self.app.currentuser.is_admin,\r",
            "                    'is_maintainer': self.app.currentuser.is_maintainer,\r",
            "                }\r",
            "            )\r",
            "        elif getattr(cherrypy.serving.request, 'login', None):\r",
            "            parms.update(\r",
            "                {\r",
            "                    'username': cherrypy.serving.request.login,\r",
            "                }\r",
            "            )\r",
            "\r",
            "        # Append custom branding\r",
            "        if hasattr(self.app.root, \"header_logo\"):\r",
            "            parms[\"header_logo\"] = '/header_logo'\r",
            "\r",
            "        # Check if theme exists.\r",
            "        default_theme_css = pkg_resources.resource_filename('rdiffweb', 'static/%s.css' % self._default_theme)\r",
            "        if not os.access(default_theme_css, os.F_OK):\r",
            "            logger.warning(\"invalid DefaultTheme value, %s doesn't exists\" % default_theme_css)\r",
            "\r",
            "        # Append template parameters.\r",
            "        parms.update(kwargs)\r",
            "\r",
            "        return self.app.templates.compile_template(template_name, **parms)\r"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\r",
            "import logging\r",
            "import os\r",
            "from collections import namedtuple\r",
            "\r",
            "import cherrypy\r",
            "import pkg_resources\r",
            "\r",
            "from rdiffweb.core.config import Option\r",
            "from rdiffweb.core.librdiff import RdiffTime\r",
            "from rdiffweb.tools.i18n import ugettext as _\r",
            "\r",
            "# Define the logger\r",
            "logger = logging.getLogger(__name__)\r",
            "\r",
            "\r",
            "def validate(value, message=None):\r",
            "    \"\"\"Raise HTTP error if value is not true.\"\"\"\r",
            "    if not value:\r",
            "        raise cherrypy.HTTPError(400, message)\r",
            "\r",
            "\r",
            "def validate_int(value, message=None):\r",
            "    \"\"\"Raise HTTP Error if the value is not an integer\"\"\"\r",
            "    try:\r",
            "        return int(value)\r",
            "    except ValueError:\r",
            "        raise cherrypy.HTTPError(400, message)\r",
            "\r",
            "\r",
            "def validate_isinstance(value, cls, message=None):\r",
            "    \"\"\"Raise HTTP error if value is not cls.\"\"\"\r",
            "    if not isinstance(value, cls):\r",
            "        raise cherrypy.HTTPError(400, message)\r",
            "\r",
            "\r",
            "def validate_date(value, message=None):\r",
            "    try:\r",
            "        return RdiffTime(int(value))\r",
            "    except ValueError:\r",
            "        logger.warning(\"invalid date %s\", value)\r",
            "        raise cherrypy.HTTPError(400, message or _('Invalid date.'))\r",
            "\r",
            "\r",
            "FlashMessage = namedtuple('FlashMessage', ['message', 'level'])\r",
            "\r",
            "\r",
            "def flash(message, level='info'):\r",
            "    \"\"\"\r",
            "    Add a flashin message to the session.\r",
            "    \"\"\"\r",
            "    assert message\r",
            "    assert level in ['info', 'error', 'warning', 'success']\r",
            "    if 'flash' not in cherrypy.session:  # @UndefinedVariable\r",
            "        cherrypy.session['flash'] = []  # @UndefinedVariable\r",
            "    flash_message = FlashMessage(str(message), level)\r",
            "    cherrypy.session['flash'].append(flash_message)\r",
            "\r",
            "\r",
            "def get_flashed_messages():\r",
            "    if 'flash' in cherrypy.session:  # @UndefinedVariable\r",
            "        messages = cherrypy.session['flash']  # @UndefinedVariable\r",
            "        del cherrypy.session['flash']  # @UndefinedVariable\r",
            "        return messages\r",
            "    return []\r",
            "\r",
            "\r",
            "class Controller(object):\r",
            "\r",
            "    _header_name = Option(\"header_name\")\r",
            "\r",
            "    _footername = Option(\"footer_name\")\r",
            "\r",
            "    _footerurl = Option(\"footer_url\")\r",
            "\r",
            "    _default_theme = Option(\"default_theme\")\r",
            "\r",
            "    @property\r",
            "    def app(self):\r",
            "        return cherrypy.request.app\r",
            "\r",
            "    def _compile_template(self, template_name, **kwargs):\r",
            "        \"\"\"\r",
            "        Used to generate a standard HTML page using the given template.\r",
            "        This method should be used by subclasses to provide default template\r",
            "        value.\r",
            "        \"\"\"\r",
            "        loc = cherrypy.response.i18n.locale\r",
            "        parms = {\r",
            "            \"lang\": loc.language,\r",
            "            \"header_name\": self._header_name,\r",
            "            \"theme\": self._default_theme,\r",
            "            \"footername\": self._footername,\r",
            "            \"footerurl\": self._footerurl,\r",
            "            \"get_flashed_messages\": get_flashed_messages,\r",
            "        }\r",
            "        if self.app.currentuser:\r",
            "            parms.update(\r",
            "                {\r",
            "                    'username': self.app.currentuser.username,\r",
            "                    'fullname': self.app.currentuser.fullname,\r",
            "                    'is_admin': self.app.currentuser.is_admin,\r",
            "                    'is_maintainer': self.app.currentuser.is_maintainer,\r",
            "                }\r",
            "            )\r",
            "        elif getattr(cherrypy.serving.request, 'login', None):\r",
            "            parms.update(\r",
            "                {\r",
            "                    'username': cherrypy.serving.request.login,\r",
            "                }\r",
            "            )\r",
            "\r",
            "        # Append custom branding\r",
            "        if hasattr(self.app.root, \"header_logo\"):\r",
            "            parms[\"header_logo\"] = '/header_logo'\r",
            "\r",
            "        # Check if theme exists.\r",
            "        default_theme_css = pkg_resources.resource_filename('rdiffweb', 'static/%s.css' % self._default_theme)\r",
            "        if not os.access(default_theme_css, os.F_OK):\r",
            "            logger.warning(\"invalid DefaultTheme value, %s doesn't exists\" % default_theme_css)\r",
            "\r",
            "        # Append template parameters.\r",
            "        parms.update(kwargs)\r",
            "\r",
            "        return self.app.templates.compile_template(template_name, **parms)\r"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "72": [
                "flash"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_admin_users.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": 159,
                "PatchRowcode": "     def populate_obj(self, userobj):"
            },
            "1": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 160,
                "PatchRowcode": "         # Save password if defined"
            },
            "2": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 161,
                "PatchRowcode": "         if self.password.data:"
            },
            "3": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            userobj.set_password(self.password.data, old_password=None)"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+            userobj.set_password(self.password.data)"
            },
            "5": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": 163,
                "PatchRowcode": "         userobj.role = self.role.data"
            },
            "6": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": 164,
                "PatchRowcode": "         userobj.fullname = self.fullname.data or ''"
            },
            "7": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": 165,
                "PatchRowcode": "         userobj.email = self.email.data or ''"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "            validators.length(min=3, message=_('Username too short.')),",
            "            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "        description=_('To create an LDAP user, you must leave the password empty.'),",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "        render_kw={'data-beta': 1},",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValueError(_('Cannot change your own two-factor authentication settings.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data, old_password=None)",
            "        userobj.role = self.role.data",
            "        userobj.fullname = self.fullname.data or ''",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if self.mfa.data and not userobj.email:",
            "            flash(_(\"User email is required to enabled Two-Factor Authentication\"), level='error')",
            "        else:",
            "            userobj.mfa = self.mfa.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        else:",
            "            userobj.refresh_repos(delete=True)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = UserObject.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    @cherrypy.expose",
            "    def default(self, username=None, action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = UserObject.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = UserObject.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"users\": UserObject.query.all(),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "            validators.length(min=3, message=_('Username too short.')),",
            "            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "        description=_('To create an LDAP user, you must leave the password empty.'),",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "        render_kw={'data-beta': 1},",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValueError(_('Cannot change your own two-factor authentication settings.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data)",
            "        userobj.role = self.role.data",
            "        userobj.fullname = self.fullname.data or ''",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if self.mfa.data and not userobj.email:",
            "            flash(_(\"User email is required to enabled Two-Factor Authentication\"), level='error')",
            "        else:",
            "            userobj.mfa = self.mfa.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        else:",
            "            userobj.refresh_repos(delete=True)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = UserObject.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    @cherrypy.expose",
            "    def default(self, username=None, action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = UserObject.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = UserObject.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"users\": UserObject.query.all(),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "162": [
                "UserForm",
                "populate_obj"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_pref_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " from rdiffweb.core.model import UserObject"
            },
            "1": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " from rdiffweb.tools.i18n import gettext_lazy as _"
            },
            "2": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+# Maximum number of password change attempt before logout"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+CHANGE_PASSWORD_MAX_ATTEMPT = 5"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+CHANGE_PASSWORD_ATTEMPTS = 'change_password_attempts'"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+"
            },
            "7": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " class UserProfileForm(CherryForm):"
            },
            "9": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 38,
                "PatchRowcode": "     action = HiddenField(default='set_profile_info')"
            },
            "10": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "         return super().is_submitted() and self.action.data == 'set_password'"
            },
            "11": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 90,
                "PatchRowcode": " "
            },
            "12": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "     def populate_obj(self, user):"
            },
            "13": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        try:"
            },
            "14": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            user.set_password(self.new.data, old_password=self.current.data)"
            },
            "15": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            flash(_(\"Password updated successfully.\"), level='success')"
            },
            "16": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        except ValueError as e:"
            },
            "17": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            flash(str(e), level='warning')"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+        # Check if current password is \"valid\" if Not, rate limit the"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        # number of attempts and logout user after too many invalid attempts."
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+        if not user.validate_password(self.current.data):"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+            cherrypy.session[CHANGE_PASSWORD_ATTEMPTS] = cherrypy.session.get(CHANGE_PASSWORD_ATTEMPTS, 0) + 1"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+            attempts = cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+            if attempts >= CHANGE_PASSWORD_MAX_ATTEMPT:"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+                cherrypy.session.clear()"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+                cherrypy.session.regenerate()"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+                flash("
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+                    _(\"You were logged out because you entered the wrong password too many times.\"),"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+                    level='warning',"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+                )"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+                raise cherrypy.HTTPRedirect('/login/')"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+            flash(_(\"Wrong current password.\"), level='warning')"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+        else:"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+            # Clear number of attempts"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+            if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+                del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+            # If Valid, update password"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+            try:"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+                user.set_password(self.new.data)"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+                flash(_(\"Password updated successfully.\"), level='success')"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+            except ValueError as e:"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+                flash(str(e), level='warning')"
            },
            "42": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 116,
                "PatchRowcode": " "
            },
            "43": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 117,
                "PatchRowcode": " "
            },
            "44": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 118,
                "PatchRowcode": " class RefreshForm(CherryForm):"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.set_password(self.new.data, old_password=self.current.data)",
            "            flash(_(\"Password updated successfully.\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                password_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Maximum number of password change attempt before logout",
            "CHANGE_PASSWORD_MAX_ATTEMPT = 5",
            "CHANGE_PASSWORD_ATTEMPTS = 'change_password_attempts'",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def populate_obj(self, user):",
            "        # Check if current password is \"valid\" if Not, rate limit the",
            "        # number of attempts and logout user after too many invalid attempts.",
            "        if not user.validate_password(self.current.data):",
            "            cherrypy.session[CHANGE_PASSWORD_ATTEMPTS] = cherrypy.session.get(CHANGE_PASSWORD_ATTEMPTS, 0) + 1",
            "            attempts = cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "            if attempts >= CHANGE_PASSWORD_MAX_ATTEMPT:",
            "                cherrypy.session.clear()",
            "                cherrypy.session.regenerate()",
            "                flash(",
            "                    _(\"You were logged out because you entered the wrong password too many times.\"),",
            "                    level='warning',",
            "                )",
            "                raise cherrypy.HTTPRedirect('/login/')",
            "            flash(_(\"Wrong current password.\"), level='warning')",
            "        else:",
            "            # Clear number of attempts",
            "            if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:",
            "                del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "            # If Valid, update password",
            "            try:",
            "                user.set_password(self.new.data)",
            "                flash(_(\"Password updated successfully.\"), level='success')",
            "            except ValueError as e:",
            "                flash(str(e), level='warning')",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                password_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "88": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "89": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "90": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "91": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "92": [
                "UserPasswordForm",
                "populate_obj"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_prefs_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": 182,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "     def test_change_password_with_wrong_password(self):"
            },
            "2": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": 184,
                "PatchRowcode": "         self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "3": {
                "beforePatchRowNumber": 185,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Wrong password\")"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 185,
                "PatchRowcode": "+        self.assertInBody(\"Wrong current password\")"
            },
            "5": {
                "beforePatchRowNumber": 186,
                "afterPatchRowNumber": 186,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 187,
                "afterPatchRowNumber": 187,
                "PatchRowcode": "     def test_change_password_with_too_short(self):"
            },
            "7": {
                "beforePatchRowNumber": 188,
                "afterPatchRowNumber": 188,
                "PatchRowcode": "         self._set_password(self.PASSWORD, \"short\", \"short\")"
            },
            "8": {
                "beforePatchRowNumber": 193,
                "afterPatchRowNumber": 193,
                "PatchRowcode": "         self._set_password(self.PASSWORD, new_password, new_password)"
            },
            "9": {
                "beforePatchRowNumber": 194,
                "afterPatchRowNumber": 194,
                "PatchRowcode": "         self.assertInBody(\"Password must have between 8 and 128 characters.\")"
            },
            "10": {
                "beforePatchRowNumber": 195,
                "afterPatchRowNumber": 195,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 196,
                "PatchRowcode": "+    def test_change_password_too_many_attemps(self):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 197,
                "PatchRowcode": "+        # When udating user's password with wrong current password 5 times"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 198,
                "PatchRowcode": "+        for _i in range(1, 5):"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 199,
                "PatchRowcode": "+            self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 200,
                "PatchRowcode": "+            self.assertStatus(200)"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 201,
                "PatchRowcode": "+            self.assertInBody(\"Wrong current password.\")"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 202,
                "PatchRowcode": "+        # Then user session is cleared and user is redirect to login page"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 203,
                "PatchRowcode": "+        self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 204,
                "PatchRowcode": "+        self.assertStatus(303)"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 205,
                "PatchRowcode": "+        self.assertHeaderItemValue('Location', self.baseurl + '/login/')"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 206,
                "PatchRowcode": "+        # Then a warning message is displayed on login page"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 207,
                "PatchRowcode": "+        self.getPage('/login/')"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 208,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 209,
                "PatchRowcode": "+        self.assertInBody('You were logged out because you entered the wrong password too many times.')"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 210,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": 196,
                "afterPatchRowNumber": 211,
                "PatchRowcode": "     def test_change_password_method_get(self):"
            },
            "27": {
                "beforePatchRowNumber": 197,
                "afterPatchRowNumber": 212,
                "PatchRowcode": "         # Given an authenticated user"
            },
            "28": {
                "beforePatchRowNumber": 198,
                "afterPatchRowNumber": 213,
                "PatchRowcode": "         # Trying to update password with GET method"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test', True),",
            "            ('My Fullname', True),",
            "        ]",
            "    )",
            "    def test_change_fullname(self, new_fullname, expected_valid):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", new_fullname)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            # Then database is updated with fullname",
            "            self.assertInBody(new_fullname)",
            "            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "            self.assertEqual(new_fullname, user.fullname)",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test@test.com', True),",
            "        ]",
            "    )",
            "    def test_change_email_with_invalid_email(self, new_email, expected_valid):",
            "        self._set_profile_info(new_email)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            self.assertNotInBody(\"Must be a valid email address.\")",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "            self.assertInBody(\"Must be a valid email address.\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test', True),",
            "            ('My Fullname', True),",
            "        ]",
            "    )",
            "    def test_change_fullname(self, new_fullname, expected_valid):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", new_fullname)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            # Then database is updated with fullname",
            "            self.assertInBody(new_fullname)",
            "            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "            self.assertEqual(new_fullname, user.fullname)",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test@test.com', True),",
            "        ]",
            "    )",
            "    def test_change_email_with_invalid_email(self, new_email, expected_valid):",
            "        self._set_profile_info(new_email)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            self.assertNotInBody(\"Must be a valid email address.\")",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "            self.assertInBody(\"Must be a valid email address.\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong current password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_too_many_attemps(self):",
            "        # When udating user's password with wrong current password 5 times",
            "        for _i in range(1, 5):",
            "            self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"Wrong current password.\")",
            "        # Then user session is cleared and user is redirect to login page",
            "        self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a warning message is displayed on login page",
            "        self.getPage('/login/')",
            "        self.assertStatus(200)",
            "        self.assertInBody('You were logged out because you entered the wrong password too many times.')",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "185": [
                "PagePrefGeneralTest",
                "test_change_password_with_wrong_password"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/login.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from cherrypy.process.plugins import SimplePlugin"
            },
            "1": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " from rdiffweb.core.model import UserObject"
            },
            "3": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from rdiffweb.core.passwd import check_password"
            },
            "4": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " logger = logging.getLogger(__name__)"
            },
            "6": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         Only verify the user's credentials using the database store."
            },
            "8": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "         \"\"\""
            },
            "9": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "         user = UserObject.query.filter_by(username=username).first()"
            },
            "10": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if user and check_password(password, user.hash_password):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+        if user and user.validate_password(password):"
            },
            "12": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "             return username, {}"
            },
            "13": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "         return False"
            },
            "14": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 57,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy.process.plugins import SimplePlugin",
            "",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.core.passwd import check_password",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginPlugin(SimplePlugin):",
            "    \"\"\"",
            "    This plugins register an \"authenticate\" listener to validate",
            "    username and password of users. In addition, it provide a \"login\"",
            "    listener to authenticate and possibly create the user in database.",
            "    \"\"\"",
            "",
            "    add_missing_user = False",
            "    add_user_default_role = UserObject.USER_ROLE",
            "    add_user_default_userroot = None",
            "",
            "    def start(self):",
            "        self.bus.log('Start Login plugin')",
            "        self.bus.subscribe(\"authenticate\", self.authenticate)",
            "        self.bus.subscribe(\"login\", self.login)",
            "",
            "    def stop(self):",
            "        self.bus.log('Stop Login plugin')",
            "        self.bus.unsubscribe(\"authenticate\", self.authenticate)",
            "        self.bus.unsubscribe(\"login\", self.login)",
            "",
            "    def authenticate(self, username, password):",
            "        \"\"\"",
            "        Only verify the user's credentials using the database store.",
            "        \"\"\"",
            "        user = UserObject.query.filter_by(username=username).first()",
            "        if user and check_password(password, user.hash_password):",
            "            return username, {}",
            "        return False",
            "",
            "    def login(self, username, password):",
            "        \"\"\"",
            "        Validate username password using database and LDAP.",
            "        \"\"\"",
            "        # Validate credentials.",
            "        authenticates = self.bus.publish('authenticate', username, password)",
            "        authenticates = [a for a in authenticates if a]",
            "        if not authenticates:",
            "            return None",
            "        real_username = authenticates[0][0]",
            "        extra_attrs = authenticates[0][1]",
            "        fullname = extra_attrs.get('_fullname', None)",
            "        email = extra_attrs.get('_email', None)",
            "        # When enabled, create missing userobj in database.",
            "        userobj = UserObject.query.filter_by(username=username).first()",
            "        if userobj is None and self.add_missing_user:",
            "            try:",
            "                # At this point, we need to create a new user in database.",
            "                # In case default values are invalid, let evaluate them",
            "                # before creating the user in database.",
            "                default_user_root = self.add_user_default_userroot and self.add_user_default_userroot.format(",
            "                    **extra_attrs",
            "                )",
            "                default_role = UserObject.ROLES.get(self.add_user_default_role)",
            "                userobj = UserObject.add_user(",
            "                    username=real_username,",
            "                    fullname=fullname,",
            "                    email=email,",
            "                    role=default_role,",
            "                    user_root=default_user_root,",
            "                ).add()",
            "            except Exception:",
            "                logger.error('fail to create new user', exc_info=1)",
            "        if userobj is None:",
            "            # User doesn't exists in database",
            "            return None",
            "",
            "        # Update user attributes",
            "        dirty = False",
            "        if fullname:",
            "            userobj.fullname = fullname",
            "            dirty = True",
            "        if email:",
            "            userobj.email = email",
            "            dirty = True",
            "        if dirty:",
            "            userobj.add()",
            "        self.bus.publish('user_login', userobj)",
            "        return userobj",
            "",
            "",
            "cherrypy.login = LoginPlugin(cherrypy.engine)",
            "cherrypy.login.subscribe()",
            "",
            "cherrypy.config.namespaces['login'] = lambda key, value: setattr(cherrypy.login, key, value)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy.process.plugins import SimplePlugin",
            "",
            "from rdiffweb.core.model import UserObject",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginPlugin(SimplePlugin):",
            "    \"\"\"",
            "    This plugins register an \"authenticate\" listener to validate",
            "    username and password of users. In addition, it provide a \"login\"",
            "    listener to authenticate and possibly create the user in database.",
            "    \"\"\"",
            "",
            "    add_missing_user = False",
            "    add_user_default_role = UserObject.USER_ROLE",
            "    add_user_default_userroot = None",
            "",
            "    def start(self):",
            "        self.bus.log('Start Login plugin')",
            "        self.bus.subscribe(\"authenticate\", self.authenticate)",
            "        self.bus.subscribe(\"login\", self.login)",
            "",
            "    def stop(self):",
            "        self.bus.log('Stop Login plugin')",
            "        self.bus.unsubscribe(\"authenticate\", self.authenticate)",
            "        self.bus.unsubscribe(\"login\", self.login)",
            "",
            "    def authenticate(self, username, password):",
            "        \"\"\"",
            "        Only verify the user's credentials using the database store.",
            "        \"\"\"",
            "        user = UserObject.query.filter_by(username=username).first()",
            "        if user and user.validate_password(password):",
            "            return username, {}",
            "        return False",
            "",
            "    def login(self, username, password):",
            "        \"\"\"",
            "        Validate username password using database and LDAP.",
            "        \"\"\"",
            "        # Validate credentials.",
            "        authenticates = self.bus.publish('authenticate', username, password)",
            "        authenticates = [a for a in authenticates if a]",
            "        if not authenticates:",
            "            return None",
            "        real_username = authenticates[0][0]",
            "        extra_attrs = authenticates[0][1]",
            "        fullname = extra_attrs.get('_fullname', None)",
            "        email = extra_attrs.get('_email', None)",
            "        # When enabled, create missing userobj in database.",
            "        userobj = UserObject.query.filter_by(username=username).first()",
            "        if userobj is None and self.add_missing_user:",
            "            try:",
            "                # At this point, we need to create a new user in database.",
            "                # In case default values are invalid, let evaluate them",
            "                # before creating the user in database.",
            "                default_user_root = self.add_user_default_userroot and self.add_user_default_userroot.format(",
            "                    **extra_attrs",
            "                )",
            "                default_role = UserObject.ROLES.get(self.add_user_default_role)",
            "                userobj = UserObject.add_user(",
            "                    username=real_username,",
            "                    fullname=fullname,",
            "                    email=email,",
            "                    role=default_role,",
            "                    user_root=default_user_root,",
            "                ).add()",
            "            except Exception:",
            "                logger.error('fail to create new user', exc_info=1)",
            "        if userobj is None:",
            "            # User doesn't exists in database",
            "            return None",
            "",
            "        # Update user attributes",
            "        dirty = False",
            "        if fullname:",
            "            userobj.fullname = fullname",
            "            dirty = True",
            "        if email:",
            "            userobj.email = email",
            "            dirty = True",
            "        if dirty:",
            "            userobj.add()",
            "        self.bus.publish('user_login', userobj)",
            "        return userobj",
            "",
            "",
            "cherrypy.login = LoginPlugin(cherrypy.engine)",
            "cherrypy.login.subscribe()",
            "",
            "cherrypy.config.namespaces['login'] = lambda key, value: setattr(cherrypy.login, key, value)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "24": [],
            "55": [
                "LoginPlugin",
                "authenticate"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/model/_user.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 344,
                "afterPatchRowNumber": 344,
                "PatchRowcode": "     def is_maintainer(self):"
            },
            "1": {
                "beforePatchRowNumber": 345,
                "afterPatchRowNumber": 345,
                "PatchRowcode": "         return self.role <= self.MAINTAINER_ROLE"
            },
            "2": {
                "beforePatchRowNumber": 346,
                "afterPatchRowNumber": 346,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 347,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def set_password(self, password, old_password=None):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 347,
                "PatchRowcode": "+    def set_password(self, password):"
            },
            "5": {
                "beforePatchRowNumber": 348,
                "afterPatchRowNumber": 348,
                "PatchRowcode": "         \"\"\""
            },
            "6": {
                "beforePatchRowNumber": 349,
                "afterPatchRowNumber": 349,
                "PatchRowcode": "         Change the user's password. Raise a ValueError if the username or"
            },
            "7": {
                "beforePatchRowNumber": 350,
                "afterPatchRowNumber": 350,
                "PatchRowcode": "         the password are invalid."
            },
            "8": {
                "beforePatchRowNumber": 351,
                "afterPatchRowNumber": 351,
                "PatchRowcode": "         \"\"\""
            },
            "9": {
                "beforePatchRowNumber": 352,
                "afterPatchRowNumber": 352,
                "PatchRowcode": "         assert isinstance(password, str)"
            },
            "10": {
                "beforePatchRowNumber": 353,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        assert old_password is None or isinstance(old_password, str)"
            },
            "11": {
                "beforePatchRowNumber": 354,
                "afterPatchRowNumber": 353,
                "PatchRowcode": "         if not password:"
            },
            "12": {
                "beforePatchRowNumber": 355,
                "afterPatchRowNumber": 354,
                "PatchRowcode": "             raise ValueError(\"password can't be empty\")"
            },
            "13": {
                "beforePatchRowNumber": 356,
                "afterPatchRowNumber": 355,
                "PatchRowcode": "         cfg = cherrypy.tree.apps[''].cfg"
            },
            "14": {
                "beforePatchRowNumber": 359,
                "afterPatchRowNumber": 358,
                "PatchRowcode": "         if self.username == cfg.admin_user and cfg.admin_password:"
            },
            "15": {
                "beforePatchRowNumber": 360,
                "afterPatchRowNumber": 359,
                "PatchRowcode": "             raise ValueError(_(\"can't update admin-password defined in configuration file\"))"
            },
            "16": {
                "beforePatchRowNumber": 361,
                "afterPatchRowNumber": 360,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": 362,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if old_password and not check_password(old_password, self.hash_password):"
            },
            "18": {
                "beforePatchRowNumber": 363,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise ValueError(_(\"Wrong password\"))"
            },
            "19": {
                "beforePatchRowNumber": 364,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "20": {
                "beforePatchRowNumber": 365,
                "afterPatchRowNumber": 361,
                "PatchRowcode": "         # Check password length"
            },
            "21": {
                "beforePatchRowNumber": 366,
                "afterPatchRowNumber": 362,
                "PatchRowcode": "         if cfg.password_min_length > len(password) or len(password) > cfg.password_max_length:"
            },
            "22": {
                "beforePatchRowNumber": 367,
                "afterPatchRowNumber": 363,
                "PatchRowcode": "             raise ValueError("
            },
            "23": {
                "beforePatchRowNumber": 448,
                "afterPatchRowNumber": 444,
                "PatchRowcode": "                 return True"
            },
            "24": {
                "beforePatchRowNumber": 449,
                "afterPatchRowNumber": 445,
                "PatchRowcode": "         return False"
            },
            "25": {
                "beforePatchRowNumber": 450,
                "afterPatchRowNumber": 446,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 447,
                "PatchRowcode": "+    def validate_password(self, password):"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 448,
                "PatchRowcode": "+        return check_password(password, self.hash_password)"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 449,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": 451,
                "afterPatchRowNumber": 450,
                "PatchRowcode": " "
            },
            "30": {
                "beforePatchRowNumber": 452,
                "afterPatchRowNumber": 451,
                "PatchRowcode": " @event.listens_for(UserObject.hash_password, \"set\")"
            },
            "31": {
                "beforePatchRowNumber": 453,
                "afterPatchRowNumber": 452,
                "PatchRowcode": " def hash_password_set(target, value, oldvalue, initiator):"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import datetime",
            "import logging",
            "import os",
            "import secrets",
            "import string",
            "",
            "import cherrypy",
            "from sqlalchemy import Column, Integer, SmallInteger, String, and_, event, inspect, or_",
            "from sqlalchemy.exc import IntegrityError",
            "from sqlalchemy.ext.hybrid import hybrid_property",
            "from sqlalchemy.orm import deferred, relationship",
            "from zxcvbn import zxcvbn",
            "",
            "import rdiffweb.tools.db  # noqa",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.passwd import check_password, hash_password",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "from ._repo import RepoObject",
            "from ._sshkey import SshKey",
            "from ._token import Token",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "Base = cherrypy.tools.db.get_base()",
            "",
            "SEP = b'/'",
            "",
            "",
            "class DuplicateSSHKeyError(Exception):",
            "    \"\"\"",
            "    Raised by add_authorizedkey when trying to add the same SSH Key twice.",
            "    \"\"\"",
            "",
            "    pass",
            "",
            "",
            "class UserObject(Base):",
            "    __tablename__ = 'users'",
            "    __table_args__ = {'sqlite_autoincrement': True}",
            "",
            "    # Value for role.",
            "    ADMIN_ROLE = 0",
            "    MAINTAINER_ROLE = 5",
            "    USER_ROLE = 10",
            "    ROLES = {",
            "        'admin': ADMIN_ROLE,",
            "        'maintainer': MAINTAINER_ROLE,",
            "        'user': USER_ROLE,",
            "    }",
            "    # Value for mfa field",
            "    DISABLED_MFA = 0",
            "    ENABLED_MFA = 1",
            "",
            "    # Regex pattern to be used for validation.",
            "    PATTERN_EMAIL = r\"[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$\"",
            "    PATTERN_FULLNAME = r\"\"\"[^!\"#$%&()*+,./:;<=>?@[\\]_{|}~]+$\"\"\"",
            "    PATTERN_USERNAME = r\"[a-zA-Z0-9_.\\-]+$\"",
            "",
            "    userid = Column('UserID', Integer, primary_key=True)",
            "    _username = Column('Username', String, nullable=False, unique=True)",
            "    hash_password = Column('Password', String, nullable=False, default=\"\")",
            "    _user_root = Column('UserRoot', String, nullable=False, default=\"\")",
            "    _is_admin = deferred(",
            "        Column(",
            "            'IsAdmin',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"0\",",
            "            doc=\"DEPRECATED This column is replaced by 'role'\",",
            "        )",
            "    )",
            "    _email = Column('UserEmail', String, nullable=False, default=\"\")",
            "    restore_format = deferred(",
            "        Column(",
            "            'RestoreFormat',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"1\",",
            "            doc=\"DEPRECATED This column is not used anymore\",",
            "        )",
            "    )",
            "    _role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE))",
            "    fullname = Column('fullname', String, nullable=False, default=\"\")",
            "    mfa = Column('mfa', SmallInteger, nullable=False, default=DISABLED_MFA)",
            "    repo_objs = relationship(",
            "        'RepoObject',",
            "        foreign_keys='UserObject.userid',",
            "        primaryjoin='UserObject.userid == RepoObject.userid',",
            "        uselist=True,",
            "        lazy=True,",
            "        order_by=lambda: RepoObject.repopath,",
            "    )",
            "",
            "    @classmethod",
            "    def get_user(cls, user):",
            "        \"\"\"Return a user object.\"\"\"",
            "        return UserObject.query.filter(UserObject.username == user).first()",
            "",
            "    @classmethod",
            "    def create_admin_user(cls, default_username, default_password):",
            "        # Check if admin user exists. If not, created it.",
            "        userobj = UserObject.get_user(default_username)",
            "        if not userobj:",
            "            userobj = cls.add_user(default_username, role=UserObject.ADMIN_ROLE, user_root='/backups')",
            "        # Also make sure to update the password with latest value from config file.",
            "        if default_password and default_password.startswith('{SSHA}'):",
            "            userobj.hash_password = default_password",
            "        elif default_password:",
            "            userobj.hash_password = hash_password(default_password)",
            "        else:",
            "            userobj.hash_password = hash_password('admin123')",
            "        userobj.add()",
            "",
            "    @classmethod",
            "    def add_user(cls, username, password=None, **attrs):",
            "        \"\"\"",
            "        Used to add a new user with an optional password.",
            "        \"\"\"",
            "        assert password is None or isinstance(password, str)",
            "        # Check if user already exists.",
            "        if UserObject.get_user(username):",
            "            raise ValueError(_(\"User %s already exists.\" % (username,)))",
            "",
            "        # Find a database where to add the user",
            "        logger.info(\"adding new user [%s]\", username)",
            "        userobj = UserObject(",
            "            username=username,",
            "            hash_password=hash_password(password) if password else '',",
            "            **attrs,",
            "        ).add()",
            "        # Raise event",
            "        cherrypy.engine.publish('user_added', userobj)",
            "        # Return user object",
            "        return userobj",
            "",
            "    def add_authorizedkey(self, key, comment=None):",
            "        \"\"\"",
            "        Add the given key to the user. Adding the key to his `authorized_keys`",
            "        file if it exists and adding it to database.",
            "        \"\"\"",
            "        # Parse and validate ssh key",
            "        assert key",
            "        key = authorizedkeys.check_publickey(key)",
            "",
            "        # Remove option, replace comments.",
            "        key = authorizedkeys.AuthorizedKey(",
            "            options=None, keytype=key.keytype, key=key.key, comment=comment or key.comment",
            "        )",
            "",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode=\"r+\", encoding='utf-8') as fh:",
            "                if authorizedkeys.exists(fh, key):",
            "                    raise DuplicateSSHKeyError(_(\"SSH key already exists\"))",
            "                logger.info(\"add key [%s] to [%s] authorized_keys\", key, self.username)",
            "                authorizedkeys.add(fh, key)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"add key [%s] to [%s] database\", key, self.username)",
            "            try:",
            "                SshKey(userid=self.userid, fingerprint=key.fingerprint, key=key.getvalue()).add()",
            "            except IntegrityError:",
            "                SshKey.session.rollback()",
            "                raise DuplicateSSHKeyError(",
            "                    _(\"Duplicate key. This key already exists or is associated to another user.\")",
            "                )",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def add_access_token(self, name, expiration_time=None, length=16):",
            "        \"\"\"",
            "        Create a new access token. Return the un-encrypted value of the token.",
            "        \"\"\"",
            "        assert name",
            "        assert length >= 8",
            "        # Generate a random token",
            "        token = ''.join(secrets.choice(string.ascii_lowercase) for i in range(length))",
            "        # Store hash token",
            "        try:",
            "            obj = Token(userid=self.userid, name=name, hash_token=hash_password(token), expiration_time=expiration_time)",
            "            obj.add()",
            "        except IntegrityError:",
            "            Token.session.rollback()",
            "            raise ValueError(_(\"Duplicate token name: %s\") % name)",
            "        cherrypy.engine.publish('access_token_added', self, name)",
            "        return token",
            "",
            "    def valid_user_root(self):",
            "        \"\"\"",
            "        Check if the current user_root is valid and readable",
            "        \"\"\"",
            "        try:",
            "            return os.access(self.user_root, os.F_OK) and os.path.isdir(self.user_root)",
            "        except Exception:",
            "            return False",
            "",
            "    def delete(self, *args, **kwargs):",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "        if self.username == cfg.admin_user:",
            "            raise ValueError(_(\"can't delete admin user\"))",
            "        # FIXME This should be deleted by cascade",
            "        SshKey.query.filter(SshKey.userid == self.userid).delete()",
            "        RepoObject.query.filter(RepoObject.userid == self.userid).delete()",
            "        Token.query.filter(Token.userid == self.userid).delete()",
            "        # Delete ourself",
            "        Base.delete(self)",
            "",
            "    def delete_authorizedkey(self, fingerprint):",
            "        \"\"\"",
            "        Remove the given key from the user. Remove the key from his",
            "        `authorized_keys` file if it exists and from database database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode='r+', encoding='utf-8') as fh:",
            "                logger.info(\"removing key [%s] from [%s] authorized_keys\", fingerprint, self.username)",
            "                authorizedkeys.remove(fh, fingerprint)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"removing key [%s] from [%s] database\", fingerprint, self.username)",
            "            SshKey.query.filter(and_(SshKey.userid == self.userid, SshKey.fingerprint == fingerprint)).delete()",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def delete_access_token(self, name):",
            "        assert name",
            "        if not Token.query.filter(Token.userid == self.userid, Token.name == name).delete():",
            "            raise ValueError(_(\"token name doesn't exists: %s\") % name)",
            "",
            "    @property",
            "    def disk_usage(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_usage', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @property",
            "    def disk_quota(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_quota', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @disk_quota.setter",
            "    def disk_quota(self, value):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return",
            "        cherrypy.engine.publish('set_disk_quota', self, value)",
            "",
            "    @property",
            "    def authorizedkeys(self):",
            "        \"\"\"",
            "        Return an iterator on the authorized key. Either from his",
            "        `authorized_keys` file if it exists or from database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            for k in authorizedkeys.read(filename):",
            "                yield k",
            "",
            "        # Also look in database.",
            "        for record in SshKey.query.filter(SshKey.userid == self.userid).all():",
            "            yield authorizedkeys.check_publickey(record.key)",
            "",
            "    def refresh_repos(self, delete=False):",
            "        \"\"\"",
            "        Return list of repositories object to reflect the filesystem folders.",
            "",
            "        Return a RepoObject for each sub directories under `user_root` with `rdiff-backup-data`.",
            "        \"\"\"",
            "        # Update the repositories by walking in the directory tree.",
            "        def _onerror(unused):",
            "            logger.error('error updating user [%s] repos' % self.username, exc_info=1)",
            "",
            "        # Get application config",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        dirty = False",
            "        records = RepoObject.query.filter(RepoObject.userid == self.userid).order_by(RepoObject.repopath).all()",
            "        user_root = os.fsencode(self.user_root)",
            "        for root, dirs, unused_files in os.walk(user_root, _onerror):",
            "            for name in dirs.copy():",
            "                if name.startswith(b'.'):",
            "                    dirs.remove(name)",
            "            if b'rdiff-backup-data' in dirs:",
            "                repopath = os.path.relpath(root, start=user_root)",
            "                del dirs[:]",
            "                # Handle special scenario when the repo is the",
            "                # user_root",
            "                repopath = b'' if repopath == b'.' else repopath",
            "",
            "                # Check if repo path exists.",
            "                record_match = next((record for record in records if record.repopath == os.fsdecode(repopath)), None)",
            "                if not record_match:",
            "                    # Add repository to database.",
            "                    RepoObject(user=self, repopath=os.fsdecode(repopath)).add()",
            "                    dirty = True",
            "                else:",
            "                    records.remove(record_match)",
            "            if root.count(SEP) - user_root.count(SEP) >= cfg.max_depth:",
            "                del dirs[:]",
            "        # If enabled, remove entried from database",
            "        if delete:",
            "            for record in records:",
            "                RepoObject.query.filter(RepoObject.repoid == record.repoid).delete()",
            "        return dirty",
            "",
            "    @hybrid_property",
            "    def is_admin(self):",
            "        return self.role <= self.ADMIN_ROLE",
            "",
            "    @hybrid_property",
            "    def is_ldap(self):",
            "        return self.hash_password is None or self.hash_password == ''",
            "",
            "    @is_ldap.expression",
            "    def is_ldap(cls):",
            "        return or_(cls.hash_password.is_(None), cls.hash_password == '')",
            "",
            "    @hybrid_property",
            "    def is_maintainer(self):",
            "        return self.role <= self.MAINTAINER_ROLE",
            "",
            "    def set_password(self, password, old_password=None):",
            "        \"\"\"",
            "        Change the user's password. Raise a ValueError if the username or",
            "        the password are invalid.",
            "        \"\"\"",
            "        assert isinstance(password, str)",
            "        assert old_password is None or isinstance(old_password, str)",
            "        if not password:",
            "            raise ValueError(\"password can't be empty\")",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        # Cannot update admin-password if defined",
            "        if self.username == cfg.admin_user and cfg.admin_password:",
            "            raise ValueError(_(\"can't update admin-password defined in configuration file\"))",
            "",
            "        if old_password and not check_password(old_password, self.hash_password):",
            "            raise ValueError(_(\"Wrong password\"))",
            "",
            "        # Check password length",
            "        if cfg.password_min_length > len(password) or len(password) > cfg.password_max_length:",
            "            raise ValueError(",
            "                _('Password must have between %(min)d and %(max)d characters.')",
            "                % {'min': cfg.password_min_length, 'max': cfg.password_max_length}",
            "            )",
            "",
            "        # Verify password score using zxcvbn",
            "        stats = zxcvbn(password)",
            "        if stats.get('score') < cfg.password_score:",
            "            msg = _('Password too weak.')",
            "            warning = stats.get('feedback', {}).get('warning')",
            "            suggestions = stats.get('feedback', {}).get('suggestions')",
            "            if warning:",
            "                msg += ' ' + warning",
            "            if suggestions:",
            "                msg += ' ' + ' '.join(suggestions)",
            "            raise ValueError(msg)",
            "",
            "        logger.info(\"updating user password [%s]\", self.username)",
            "        self.hash_password = hash_password(password)",
            "",
            "    def __eq__(self, other):",
            "        return type(self) == type(other) and inspect(self).key == inspect(other).key",
            "",
            "    @hybrid_property",
            "    def username(self):",
            "        return self._username",
            "",
            "    @username.setter",
            "    def username(self, value):",
            "        oldvalue = self._username",
            "        self._username = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'username': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def role(self):",
            "        if self._role is None:",
            "            return self.USER_ROLE",
            "        return self._role",
            "",
            "    @role.setter",
            "    def role(self, value):",
            "        oldvalue = self._role",
            "        self._role = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'role': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def email(self):",
            "        return self._email",
            "",
            "    @email.setter",
            "    def email(self, value):",
            "        oldvalue = self._email",
            "        self._email = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'email': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def user_root(self):",
            "        return self._user_root",
            "",
            "    @user_root.setter",
            "    def user_root(self, value):",
            "        oldvalue = self._user_root",
            "        self._user_root = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'user_root': (oldvalue, value)})",
            "",
            "    def validate_access_token(self, token):",
            "        \"\"\"",
            "        Check if the given token matches.",
            "        \"\"\"",
            "        for access_token in Token.query.all():",
            "            # If token expired. Let delete it.",
            "            if access_token.is_expired:",
            "                access_token.delete()",
            "                continue",
            "            if check_password(token, access_token.hash_token):",
            "                # When it matches, let update the record.",
            "                access_token.access_time = datetime.datetime.utcnow",
            "                return True",
            "        return False",
            "",
            "",
            "@event.listens_for(UserObject.hash_password, \"set\")",
            "def hash_password_set(target, value, oldvalue, initiator):",
            "    if value and value != oldvalue:",
            "        cherrypy.engine.publish('user_password_changed', target)",
            "",
            "",
            "@event.listens_for(UserObject, 'after_delete')",
            "def user_after_delete(mapper, connection, target):",
            "    \"\"\"",
            "    Publish event when user is deleted.",
            "    \"\"\"",
            "    cherrypy.engine.publish('user_deleted', target.username)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import datetime",
            "import logging",
            "import os",
            "import secrets",
            "import string",
            "",
            "import cherrypy",
            "from sqlalchemy import Column, Integer, SmallInteger, String, and_, event, inspect, or_",
            "from sqlalchemy.exc import IntegrityError",
            "from sqlalchemy.ext.hybrid import hybrid_property",
            "from sqlalchemy.orm import deferred, relationship",
            "from zxcvbn import zxcvbn",
            "",
            "import rdiffweb.tools.db  # noqa",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.passwd import check_password, hash_password",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "from ._repo import RepoObject",
            "from ._sshkey import SshKey",
            "from ._token import Token",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "Base = cherrypy.tools.db.get_base()",
            "",
            "SEP = b'/'",
            "",
            "",
            "class DuplicateSSHKeyError(Exception):",
            "    \"\"\"",
            "    Raised by add_authorizedkey when trying to add the same SSH Key twice.",
            "    \"\"\"",
            "",
            "    pass",
            "",
            "",
            "class UserObject(Base):",
            "    __tablename__ = 'users'",
            "    __table_args__ = {'sqlite_autoincrement': True}",
            "",
            "    # Value for role.",
            "    ADMIN_ROLE = 0",
            "    MAINTAINER_ROLE = 5",
            "    USER_ROLE = 10",
            "    ROLES = {",
            "        'admin': ADMIN_ROLE,",
            "        'maintainer': MAINTAINER_ROLE,",
            "        'user': USER_ROLE,",
            "    }",
            "    # Value for mfa field",
            "    DISABLED_MFA = 0",
            "    ENABLED_MFA = 1",
            "",
            "    # Regex pattern to be used for validation.",
            "    PATTERN_EMAIL = r\"[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$\"",
            "    PATTERN_FULLNAME = r\"\"\"[^!\"#$%&()*+,./:;<=>?@[\\]_{|}~]+$\"\"\"",
            "    PATTERN_USERNAME = r\"[a-zA-Z0-9_.\\-]+$\"",
            "",
            "    userid = Column('UserID', Integer, primary_key=True)",
            "    _username = Column('Username', String, nullable=False, unique=True)",
            "    hash_password = Column('Password', String, nullable=False, default=\"\")",
            "    _user_root = Column('UserRoot', String, nullable=False, default=\"\")",
            "    _is_admin = deferred(",
            "        Column(",
            "            'IsAdmin',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"0\",",
            "            doc=\"DEPRECATED This column is replaced by 'role'\",",
            "        )",
            "    )",
            "    _email = Column('UserEmail', String, nullable=False, default=\"\")",
            "    restore_format = deferred(",
            "        Column(",
            "            'RestoreFormat',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"1\",",
            "            doc=\"DEPRECATED This column is not used anymore\",",
            "        )",
            "    )",
            "    _role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE))",
            "    fullname = Column('fullname', String, nullable=False, default=\"\")",
            "    mfa = Column('mfa', SmallInteger, nullable=False, default=DISABLED_MFA)",
            "    repo_objs = relationship(",
            "        'RepoObject',",
            "        foreign_keys='UserObject.userid',",
            "        primaryjoin='UserObject.userid == RepoObject.userid',",
            "        uselist=True,",
            "        lazy=True,",
            "        order_by=lambda: RepoObject.repopath,",
            "    )",
            "",
            "    @classmethod",
            "    def get_user(cls, user):",
            "        \"\"\"Return a user object.\"\"\"",
            "        return UserObject.query.filter(UserObject.username == user).first()",
            "",
            "    @classmethod",
            "    def create_admin_user(cls, default_username, default_password):",
            "        # Check if admin user exists. If not, created it.",
            "        userobj = UserObject.get_user(default_username)",
            "        if not userobj:",
            "            userobj = cls.add_user(default_username, role=UserObject.ADMIN_ROLE, user_root='/backups')",
            "        # Also make sure to update the password with latest value from config file.",
            "        if default_password and default_password.startswith('{SSHA}'):",
            "            userobj.hash_password = default_password",
            "        elif default_password:",
            "            userobj.hash_password = hash_password(default_password)",
            "        else:",
            "            userobj.hash_password = hash_password('admin123')",
            "        userobj.add()",
            "",
            "    @classmethod",
            "    def add_user(cls, username, password=None, **attrs):",
            "        \"\"\"",
            "        Used to add a new user with an optional password.",
            "        \"\"\"",
            "        assert password is None or isinstance(password, str)",
            "        # Check if user already exists.",
            "        if UserObject.get_user(username):",
            "            raise ValueError(_(\"User %s already exists.\" % (username,)))",
            "",
            "        # Find a database where to add the user",
            "        logger.info(\"adding new user [%s]\", username)",
            "        userobj = UserObject(",
            "            username=username,",
            "            hash_password=hash_password(password) if password else '',",
            "            **attrs,",
            "        ).add()",
            "        # Raise event",
            "        cherrypy.engine.publish('user_added', userobj)",
            "        # Return user object",
            "        return userobj",
            "",
            "    def add_authorizedkey(self, key, comment=None):",
            "        \"\"\"",
            "        Add the given key to the user. Adding the key to his `authorized_keys`",
            "        file if it exists and adding it to database.",
            "        \"\"\"",
            "        # Parse and validate ssh key",
            "        assert key",
            "        key = authorizedkeys.check_publickey(key)",
            "",
            "        # Remove option, replace comments.",
            "        key = authorizedkeys.AuthorizedKey(",
            "            options=None, keytype=key.keytype, key=key.key, comment=comment or key.comment",
            "        )",
            "",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode=\"r+\", encoding='utf-8') as fh:",
            "                if authorizedkeys.exists(fh, key):",
            "                    raise DuplicateSSHKeyError(_(\"SSH key already exists\"))",
            "                logger.info(\"add key [%s] to [%s] authorized_keys\", key, self.username)",
            "                authorizedkeys.add(fh, key)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"add key [%s] to [%s] database\", key, self.username)",
            "            try:",
            "                SshKey(userid=self.userid, fingerprint=key.fingerprint, key=key.getvalue()).add()",
            "            except IntegrityError:",
            "                SshKey.session.rollback()",
            "                raise DuplicateSSHKeyError(",
            "                    _(\"Duplicate key. This key already exists or is associated to another user.\")",
            "                )",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def add_access_token(self, name, expiration_time=None, length=16):",
            "        \"\"\"",
            "        Create a new access token. Return the un-encrypted value of the token.",
            "        \"\"\"",
            "        assert name",
            "        assert length >= 8",
            "        # Generate a random token",
            "        token = ''.join(secrets.choice(string.ascii_lowercase) for i in range(length))",
            "        # Store hash token",
            "        try:",
            "            obj = Token(userid=self.userid, name=name, hash_token=hash_password(token), expiration_time=expiration_time)",
            "            obj.add()",
            "        except IntegrityError:",
            "            Token.session.rollback()",
            "            raise ValueError(_(\"Duplicate token name: %s\") % name)",
            "        cherrypy.engine.publish('access_token_added', self, name)",
            "        return token",
            "",
            "    def valid_user_root(self):",
            "        \"\"\"",
            "        Check if the current user_root is valid and readable",
            "        \"\"\"",
            "        try:",
            "            return os.access(self.user_root, os.F_OK) and os.path.isdir(self.user_root)",
            "        except Exception:",
            "            return False",
            "",
            "    def delete(self, *args, **kwargs):",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "        if self.username == cfg.admin_user:",
            "            raise ValueError(_(\"can't delete admin user\"))",
            "        # FIXME This should be deleted by cascade",
            "        SshKey.query.filter(SshKey.userid == self.userid).delete()",
            "        RepoObject.query.filter(RepoObject.userid == self.userid).delete()",
            "        Token.query.filter(Token.userid == self.userid).delete()",
            "        # Delete ourself",
            "        Base.delete(self)",
            "",
            "    def delete_authorizedkey(self, fingerprint):",
            "        \"\"\"",
            "        Remove the given key from the user. Remove the key from his",
            "        `authorized_keys` file if it exists and from database database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode='r+', encoding='utf-8') as fh:",
            "                logger.info(\"removing key [%s] from [%s] authorized_keys\", fingerprint, self.username)",
            "                authorizedkeys.remove(fh, fingerprint)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"removing key [%s] from [%s] database\", fingerprint, self.username)",
            "            SshKey.query.filter(and_(SshKey.userid == self.userid, SshKey.fingerprint == fingerprint)).delete()",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def delete_access_token(self, name):",
            "        assert name",
            "        if not Token.query.filter(Token.userid == self.userid, Token.name == name).delete():",
            "            raise ValueError(_(\"token name doesn't exists: %s\") % name)",
            "",
            "    @property",
            "    def disk_usage(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_usage', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @property",
            "    def disk_quota(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_quota', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @disk_quota.setter",
            "    def disk_quota(self, value):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return",
            "        cherrypy.engine.publish('set_disk_quota', self, value)",
            "",
            "    @property",
            "    def authorizedkeys(self):",
            "        \"\"\"",
            "        Return an iterator on the authorized key. Either from his",
            "        `authorized_keys` file if it exists or from database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            for k in authorizedkeys.read(filename):",
            "                yield k",
            "",
            "        # Also look in database.",
            "        for record in SshKey.query.filter(SshKey.userid == self.userid).all():",
            "            yield authorizedkeys.check_publickey(record.key)",
            "",
            "    def refresh_repos(self, delete=False):",
            "        \"\"\"",
            "        Return list of repositories object to reflect the filesystem folders.",
            "",
            "        Return a RepoObject for each sub directories under `user_root` with `rdiff-backup-data`.",
            "        \"\"\"",
            "        # Update the repositories by walking in the directory tree.",
            "        def _onerror(unused):",
            "            logger.error('error updating user [%s] repos' % self.username, exc_info=1)",
            "",
            "        # Get application config",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        dirty = False",
            "        records = RepoObject.query.filter(RepoObject.userid == self.userid).order_by(RepoObject.repopath).all()",
            "        user_root = os.fsencode(self.user_root)",
            "        for root, dirs, unused_files in os.walk(user_root, _onerror):",
            "            for name in dirs.copy():",
            "                if name.startswith(b'.'):",
            "                    dirs.remove(name)",
            "            if b'rdiff-backup-data' in dirs:",
            "                repopath = os.path.relpath(root, start=user_root)",
            "                del dirs[:]",
            "                # Handle special scenario when the repo is the",
            "                # user_root",
            "                repopath = b'' if repopath == b'.' else repopath",
            "",
            "                # Check if repo path exists.",
            "                record_match = next((record for record in records if record.repopath == os.fsdecode(repopath)), None)",
            "                if not record_match:",
            "                    # Add repository to database.",
            "                    RepoObject(user=self, repopath=os.fsdecode(repopath)).add()",
            "                    dirty = True",
            "                else:",
            "                    records.remove(record_match)",
            "            if root.count(SEP) - user_root.count(SEP) >= cfg.max_depth:",
            "                del dirs[:]",
            "        # If enabled, remove entried from database",
            "        if delete:",
            "            for record in records:",
            "                RepoObject.query.filter(RepoObject.repoid == record.repoid).delete()",
            "        return dirty",
            "",
            "    @hybrid_property",
            "    def is_admin(self):",
            "        return self.role <= self.ADMIN_ROLE",
            "",
            "    @hybrid_property",
            "    def is_ldap(self):",
            "        return self.hash_password is None or self.hash_password == ''",
            "",
            "    @is_ldap.expression",
            "    def is_ldap(cls):",
            "        return or_(cls.hash_password.is_(None), cls.hash_password == '')",
            "",
            "    @hybrid_property",
            "    def is_maintainer(self):",
            "        return self.role <= self.MAINTAINER_ROLE",
            "",
            "    def set_password(self, password):",
            "        \"\"\"",
            "        Change the user's password. Raise a ValueError if the username or",
            "        the password are invalid.",
            "        \"\"\"",
            "        assert isinstance(password, str)",
            "        if not password:",
            "            raise ValueError(\"password can't be empty\")",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        # Cannot update admin-password if defined",
            "        if self.username == cfg.admin_user and cfg.admin_password:",
            "            raise ValueError(_(\"can't update admin-password defined in configuration file\"))",
            "",
            "        # Check password length",
            "        if cfg.password_min_length > len(password) or len(password) > cfg.password_max_length:",
            "            raise ValueError(",
            "                _('Password must have between %(min)d and %(max)d characters.')",
            "                % {'min': cfg.password_min_length, 'max': cfg.password_max_length}",
            "            )",
            "",
            "        # Verify password score using zxcvbn",
            "        stats = zxcvbn(password)",
            "        if stats.get('score') < cfg.password_score:",
            "            msg = _('Password too weak.')",
            "            warning = stats.get('feedback', {}).get('warning')",
            "            suggestions = stats.get('feedback', {}).get('suggestions')",
            "            if warning:",
            "                msg += ' ' + warning",
            "            if suggestions:",
            "                msg += ' ' + ' '.join(suggestions)",
            "            raise ValueError(msg)",
            "",
            "        logger.info(\"updating user password [%s]\", self.username)",
            "        self.hash_password = hash_password(password)",
            "",
            "    def __eq__(self, other):",
            "        return type(self) == type(other) and inspect(self).key == inspect(other).key",
            "",
            "    @hybrid_property",
            "    def username(self):",
            "        return self._username",
            "",
            "    @username.setter",
            "    def username(self, value):",
            "        oldvalue = self._username",
            "        self._username = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'username': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def role(self):",
            "        if self._role is None:",
            "            return self.USER_ROLE",
            "        return self._role",
            "",
            "    @role.setter",
            "    def role(self, value):",
            "        oldvalue = self._role",
            "        self._role = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'role': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def email(self):",
            "        return self._email",
            "",
            "    @email.setter",
            "    def email(self, value):",
            "        oldvalue = self._email",
            "        self._email = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'email': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def user_root(self):",
            "        return self._user_root",
            "",
            "    @user_root.setter",
            "    def user_root(self, value):",
            "        oldvalue = self._user_root",
            "        self._user_root = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'user_root': (oldvalue, value)})",
            "",
            "    def validate_access_token(self, token):",
            "        \"\"\"",
            "        Check if the given token matches.",
            "        \"\"\"",
            "        for access_token in Token.query.all():",
            "            # If token expired. Let delete it.",
            "            if access_token.is_expired:",
            "                access_token.delete()",
            "                continue",
            "            if check_password(token, access_token.hash_token):",
            "                # When it matches, let update the record.",
            "                access_token.access_time = datetime.datetime.utcnow",
            "                return True",
            "        return False",
            "",
            "    def validate_password(self, password):",
            "        return check_password(password, self.hash_password)",
            "",
            "",
            "@event.listens_for(UserObject.hash_password, \"set\")",
            "def hash_password_set(target, value, oldvalue, initiator):",
            "    if value and value != oldvalue:",
            "        cherrypy.engine.publish('user_password_changed', target)",
            "",
            "",
            "@event.listens_for(UserObject, 'after_delete')",
            "def user_after_delete(mapper, connection, target):",
            "    \"\"\"",
            "    Publish event when user is deleted.",
            "    \"\"\"",
            "    cherrypy.engine.publish('user_deleted', target.username)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "347": [
                "UserObject",
                "set_password"
            ],
            "353": [
                "UserObject",
                "set_password"
            ],
            "362": [
                "UserObject",
                "set_password"
            ],
            "363": [
                "UserObject",
                "set_password"
            ],
            "364": [
                "UserObject",
                "set_password"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/model/tests/test_user.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": 200,
                "PatchRowcode": "         # Check if listener called"
            },
            "1": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": 201,
                "PatchRowcode": "         self.listener.user_password_changed.assert_called_once_with(userobj)"
            },
            "2": {
                "beforePatchRowNumber": 202,
                "afterPatchRowNumber": 202,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_set_password_with_old_password(self):"
            },
            "4": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Given a user in drabase with a password"
            },
            "5": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        userobj = UserObject.add_user('john', 'password')"
            },
            "6": {
                "beforePatchRowNumber": 206,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.listener.user_password_changed.reset_mock()"
            },
            "7": {
                "beforePatchRowNumber": 207,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # When updating the user's password with old_password"
            },
            "8": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        userobj.set_password('new_password', old_password='password')"
            },
            "9": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then password is SSHA"
            },
            "10": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertTrue(check_password('new_password', userobj.hash_password))"
            },
            "11": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Check if listener called"
            },
            "12": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.listener.user_password_changed.assert_called_once_with(userobj)"
            },
            "13": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "14": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_set_password_with_invalid_old_password(self):"
            },
            "15": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Given a user in drabase with a password"
            },
            "16": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        userobj = UserObject.add_user('foo', 'password')"
            },
            "17": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.listener.user_password_changed.reset_mock()"
            },
            "18": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # When updating the user's password with wrong old_password"
            },
            "19": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then an exception is raised"
            },
            "20": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        with self.assertRaises(ValueError):"
            },
            "21": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            userobj.set_password('new_password', old_password='invalid')"
            },
            "22": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Check if listener called"
            },
            "23": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.listener.user_password_changed.assert_not_called()"
            },
            "24": {
                "beforePatchRowNumber": 224,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "25": {
                "beforePatchRowNumber": 225,
                "afterPatchRowNumber": 203,
                "PatchRowcode": "     def test_delete_user(self):"
            },
            "26": {
                "beforePatchRowNumber": 226,
                "afterPatchRowNumber": 204,
                "PatchRowcode": "         # Given an existing user in database"
            },
            "27": {
                "beforePatchRowNumber": 227,
                "afterPatchRowNumber": 205,
                "PatchRowcode": "         userobj = UserObject.add_user('vicky')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on June 30, 2022",
            "",
            "Module to test `user` model.",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "import datetime",
            "import os",
            "from io import StringIO, open",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "import pkg_resources",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError, RepoObject, Token, UserObject",
            "from rdiffweb.core.passwd import check_password",
            "",
            "",
            "class UserObjectTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'email-send-changed-notification': True,",
            "    }",
            "",
            "    def _read_ssh_key(self):",
            "        \"\"\"Readthe pub key from test packages\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_publickey_ssh_rsa.pub')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.readline()",
            "",
            "    def _read_authorized_keys(self):",
            "        \"\"\"Read the content of test_authorized_keys\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_authorized_keys')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.read()",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('access_token_added', self.listener.access_token_added, priority=50)",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_mail, priority=50)",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_login', self.listener.user_login, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('access_token_added', self.listener.access_token_added)",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_mail)",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_login', self.listener.user_login)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def test_add_user(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_updated_by_listener(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        # Given a listener with side effet",
            "        def change_user_obj(userobj):",
            "            userobj.user_root = '/new/value'",
            "",
            "        self.listener.user_added.side_effect = change_user_obj",
            "        # When adding user",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Then lister get called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "        # Then object was updated by listener",
            "        self.assertEqual('/new/value', userobj.user_root)",
            "",
            "    def test_add_user_with_duplicate(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        UserObject.add_user('denise')",
            "        self.listener.user_added.reset_mock()",
            "        with self.assertRaises(ValueError):",
            "            UserObject.add_user('denise')",
            "        # Check if listener called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_user_with_password(self):",
            "        \"\"\"Add user to database with password.\"\"\"",
            "        userobj = UserObject.add_user('jo', 'password')",
            "        self.assertIsNotNone(UserObject.get_user('jo'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_delete_admin_user(self):",
            "        # Trying to delete admin user should raise an error.",
            "        userobj = UserObject.get_user('admin')",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete()",
            "",
            "    def test_users(self):",
            "        # Check admin exists",
            "        self.assertEqual(1, UserObject.query.count())",
            "        # Create user.",
            "        UserObject.add_user('annik')",
            "        users = UserObject.query.all()",
            "        self.assertEqual(2, len(users))",
            "        self.assertEqual('annik', users[1].username)",
            "        # Then 2 user exists",
            "        self.assertEqual(2, UserObject.query.count())",
            "",
            "    def test_get_user(self):",
            "        # Create new user",
            "        user = UserObject.add_user('bernie', 'my-password')",
            "        user.user_root = self.testcases",
            "        user.role = UserObject.ADMIN_ROLE",
            "        user.email = 'bernie@gmail.com'",
            "        user.refresh_repos()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        user.repo_objs[0].maxage = -1",
            "        user.repo_objs[1].maxage = 3",
            "",
            "        # Get user record.",
            "        obj = UserObject.get_user('bernie')",
            "        self.assertIsNotNone(obj)",
            "        self.assertEqual('bernie', obj.username)",
            "        self.assertEqual('bernie@gmail.com', obj.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in obj.repo_objs]))",
            "        self.assertEqual(self.testcases, obj.user_root)",
            "        self.assertEqual(True, obj.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, obj.role)",
            "",
            "        # Get repo object",
            "        self.assertEqual('broker-repo', obj.repo_objs[0].name)",
            "        self.assertEqual(-1, obj.repo_objs[0].maxage)",
            "        self.assertEqual('testcases', obj.repo_objs[1].name)",
            "        self.assertEqual(3, obj.repo_objs[1].maxage)",
            "",
            "    def test_get_user_with_invalid_user(self):",
            "        self.assertIsNone(UserObject.get_user('invalid'))",
            "",
            "    def test_get_set(self):",
            "        user = UserObject.add_user('larry', 'password')",
            "",
            "        self.assertEqual('', user.email)",
            "        self.assertEqual([], user.repo_objs)",
            "        self.assertEqual('', user.user_root)",
            "        self.assertEqual(False, user.is_admin)",
            "        self.assertEqual(UserObject.USER_ROLE, user.role)",
            "",
            "        user.user_root = self.testcases",
            "        user.refresh_repos()",
            "        self.listener.user_attr_changed.assert_called_with(user, {'user_root': ('', self.testcases)})",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user.role = UserObject.ADMIN_ROLE",
            "        self.listener.user_attr_changed.assert_called_with(",
            "            user, {'role': (UserObject.USER_ROLE, UserObject.ADMIN_ROLE)}",
            "        )",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user.email = 'larry@gmail.com'",
            "        self.listener.user_attr_changed.assert_called_with(user, {'email': ('', 'larry@gmail.com')})",
            "        self.listener.user_attr_changed.reset_mock()",
            "",
            "        self.assertEqual('larry@gmail.com', user.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        self.assertEqual(self.testcases, user.user_root)",
            "        self.assertEqual(True, user.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, user.role)",
            "",
            "    def test_set_password_update(self):",
            "        # Given a user in database with a password",
            "        userobj = UserObject.add_user('annik', 'password')",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When updating the user's password",
            "        userobj.set_password('new_password')",
            "        # Then password is SSHA",
            "        self.assertTrue(check_password('new_password', userobj.hash_password))",
            "        # Check if listener called",
            "        self.listener.user_password_changed.assert_called_once_with(userobj)",
            "",
            "    def test_set_password_with_old_password(self):",
            "        # Given a user in drabase with a password",
            "        userobj = UserObject.add_user('john', 'password')",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When updating the user's password with old_password",
            "        userobj.set_password('new_password', old_password='password')",
            "        # Then password is SSHA",
            "        self.assertTrue(check_password('new_password', userobj.hash_password))",
            "        # Check if listener called",
            "        self.listener.user_password_changed.assert_called_once_with(userobj)",
            "",
            "    def test_set_password_with_invalid_old_password(self):",
            "        # Given a user in drabase with a password",
            "        userobj = UserObject.add_user('foo', 'password')",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When updating the user's password with wrong old_password",
            "        # Then an exception is raised",
            "        with self.assertRaises(ValueError):",
            "            userobj.set_password('new_password', old_password='invalid')",
            "        # Check if listener called",
            "        self.listener.user_password_changed.assert_not_called()",
            "",
            "    def test_delete_user(self):",
            "        # Given an existing user in database",
            "        userobj = UserObject.add_user('vicky')",
            "        self.assertIsNotNone(UserObject.get_user('vicky'))",
            "        # When deleting that user",
            "        userobj.delete()",
            "        # Then user it no longer in database",
            "        self.assertIsNone(UserObject.get_user('vicky'))",
            "        # Then listner was called",
            "        self.listener.user_deleted.assert_called_once_with('vicky')",
            "",
            "    def test_set_password_empty(self):",
            "        \"\"\"Expect error when trying to update password of invalid user.\"\"\"",
            "        userobj = UserObject.add_user('john')",
            "        with self.assertRaises(ValueError):",
            "            self.assertFalse(userobj.set_password(''))",
            "",
            "    def test_disk_quota(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.disk_quota",
            "",
            "    def test_disk_usage(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        disk_usage = userobj.disk_usage",
            "        self.assertIsInstance(disk_usage, int)",
            "",
            "    def test_add_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user without an authorizedkey file.",
            "        \"\"\"",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys), \"expecting one key\")",
            "        self.assertEqual(\"3c:99:ed:a7:82:a8:71:09:2c:15:3d:78:4a:8c:11:99\", keys[0].fingerprint)",
            "",
            "    def test_add_authorizedkey_duplicate(self):",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "        # Add the same key",
            "        with self.assertRaises(DuplicateSSHKeyError):",
            "            userobj.add_authorizedkey(key)",
            "",
            "    def test_add_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user with an authorizedkey file.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "",
            "        # Create empty authorized_keys file",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        open(filename, 'a').close()",
            "",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # Validate",
            "        with open(filename, 'r') as fh:",
            "            self.assertEqual(key, fh.read())",
            "",
            "    def test_delete_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user without authorizedkey file.",
            "        \"\"\"",
            "        # Update user with ssh keys.",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        for k in authorizedkeys.read(StringIO(data)):",
            "            try:",
            "                userobj.add_authorizedkey(k.getvalue())",
            "            except ValueError:",
            "                # Some ssh key in the testing file are not valid.",
            "                pass",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(2, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys))",
            "",
            "    def test_delete_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user with authorizedkey file.",
            "        \"\"\"",
            "        # Create authorized_keys file",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        with open(filename, 'w') as f:",
            "            f.write(data)",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(5, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(4, len(keys))",
            "",
            "    def test_repo_objs(self):",
            "        # Given a user with a list of repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        repos = sorted(userobj.repo_objs, key=lambda r: r.name)",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in repos])",
            "        # When deleting a repository empty list",
            "        repos[1].delete()",
            "        # Then the repository is removed from the list.",
            "        self.assertEqual(['broker-repo'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_without_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos()",
            "        # Then the list invlaid the invalid repo and new repos",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_single_repo(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.user_root = os.path.join(self.testcases, 'testcases')",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual([''], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_add_access_token(self):",
            "        # Given a user with an email",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = 'test@examples.com'",
            "        userobj.add()",
            "        # When adding a new token",
            "        token = userobj.add_access_token('test')",
            "        # Then a new token get created",
            "        self.assertTrue(token)",
            "        tokenobj = Token.query.filter(Token.userid == userobj.userid).first()",
            "        self.assertTrue(tokenobj)",
            "        self.assertEqual(None, tokenobj.expiration_time)",
            "        self.assertEqual(None, tokenobj.access_time)",
            "        # Then an email is sent to the user.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "        self.listener.queue_mail.assert_called_once()",
            "",
            "    def test_add_access_token_duplicate_name(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When adding a new token with the same name",
            "        with self.assertRaises(ValueError):",
            "            userobj.add_access_token('test')",
            "        # Then token is not created",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # Then an email is not sent.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "",
            "    def test_delete_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an access token",
            "        userobj.delete_access_token('test')",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_access_token_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an invalid access token",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete_access_token('invalid')",
            "        # Then Token not deleted",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_user_remove_access_tokens(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.add_user('testuser', 'password')",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting the user",
            "        userobj.delete()",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is valid",
            "        self.assertTrue(userobj.validate_access_token(token))",
            "",
            "    def test_verify_access_token_with_expired(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token(",
            "            'test', expiration_time=datetime.datetime.now() - datetime.timedelta(seconds=1)",
            "        )",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token(token))",
            "        # Then token get removed",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token_with_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test', expiration_time=datetime.datetime.now())",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token('invalid'))",
            "",
            "",
            "class UserObjectWithAdminPassword(rdiffweb.test.WebCase):",
            "",
            "    # password: test",
            "    default_config = {'admin-password': '{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e'}",
            "",
            "    def setUp(self):",
            "        # Do nothing - We need to skip the default setup to avoid deleting the records.",
            "        pass",
            "",
            "    def test_create_admin_user(self):",
            "        # Given admin-password is configure",
            "        # When database get created",
            "        # Then admin user get created with 'test' password",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertIsNotNone(userobj)",
            "        self.assertEqual('{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e', userobj.hash_password)",
            "        self.assertTrue(check_password('test', userobj.hash_password))",
            "",
            "    def test_set_password(self):",
            "        # Given admin-password is configure",
            "        # When trying to update admin password",
            "        # Then an exception is raised",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        with self.assertRaises(ValueError):",
            "            userobj.set_password('newpassword')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on June 30, 2022",
            "",
            "Module to test `user` model.",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "import datetime",
            "import os",
            "from io import StringIO, open",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "import pkg_resources",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError, RepoObject, Token, UserObject",
            "from rdiffweb.core.passwd import check_password",
            "",
            "",
            "class UserObjectTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'email-send-changed-notification': True,",
            "    }",
            "",
            "    def _read_ssh_key(self):",
            "        \"\"\"Readthe pub key from test packages\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_publickey_ssh_rsa.pub')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.readline()",
            "",
            "    def _read_authorized_keys(self):",
            "        \"\"\"Read the content of test_authorized_keys\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_authorized_keys')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.read()",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('access_token_added', self.listener.access_token_added, priority=50)",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_mail, priority=50)",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_login', self.listener.user_login, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('access_token_added', self.listener.access_token_added)",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_mail)",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_login', self.listener.user_login)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def test_add_user(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_updated_by_listener(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        # Given a listener with side effet",
            "        def change_user_obj(userobj):",
            "            userobj.user_root = '/new/value'",
            "",
            "        self.listener.user_added.side_effect = change_user_obj",
            "        # When adding user",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Then lister get called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "        # Then object was updated by listener",
            "        self.assertEqual('/new/value', userobj.user_root)",
            "",
            "    def test_add_user_with_duplicate(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        UserObject.add_user('denise')",
            "        self.listener.user_added.reset_mock()",
            "        with self.assertRaises(ValueError):",
            "            UserObject.add_user('denise')",
            "        # Check if listener called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_user_with_password(self):",
            "        \"\"\"Add user to database with password.\"\"\"",
            "        userobj = UserObject.add_user('jo', 'password')",
            "        self.assertIsNotNone(UserObject.get_user('jo'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_delete_admin_user(self):",
            "        # Trying to delete admin user should raise an error.",
            "        userobj = UserObject.get_user('admin')",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete()",
            "",
            "    def test_users(self):",
            "        # Check admin exists",
            "        self.assertEqual(1, UserObject.query.count())",
            "        # Create user.",
            "        UserObject.add_user('annik')",
            "        users = UserObject.query.all()",
            "        self.assertEqual(2, len(users))",
            "        self.assertEqual('annik', users[1].username)",
            "        # Then 2 user exists",
            "        self.assertEqual(2, UserObject.query.count())",
            "",
            "    def test_get_user(self):",
            "        # Create new user",
            "        user = UserObject.add_user('bernie', 'my-password')",
            "        user.user_root = self.testcases",
            "        user.role = UserObject.ADMIN_ROLE",
            "        user.email = 'bernie@gmail.com'",
            "        user.refresh_repos()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        user.repo_objs[0].maxage = -1",
            "        user.repo_objs[1].maxage = 3",
            "",
            "        # Get user record.",
            "        obj = UserObject.get_user('bernie')",
            "        self.assertIsNotNone(obj)",
            "        self.assertEqual('bernie', obj.username)",
            "        self.assertEqual('bernie@gmail.com', obj.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in obj.repo_objs]))",
            "        self.assertEqual(self.testcases, obj.user_root)",
            "        self.assertEqual(True, obj.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, obj.role)",
            "",
            "        # Get repo object",
            "        self.assertEqual('broker-repo', obj.repo_objs[0].name)",
            "        self.assertEqual(-1, obj.repo_objs[0].maxage)",
            "        self.assertEqual('testcases', obj.repo_objs[1].name)",
            "        self.assertEqual(3, obj.repo_objs[1].maxage)",
            "",
            "    def test_get_user_with_invalid_user(self):",
            "        self.assertIsNone(UserObject.get_user('invalid'))",
            "",
            "    def test_get_set(self):",
            "        user = UserObject.add_user('larry', 'password')",
            "",
            "        self.assertEqual('', user.email)",
            "        self.assertEqual([], user.repo_objs)",
            "        self.assertEqual('', user.user_root)",
            "        self.assertEqual(False, user.is_admin)",
            "        self.assertEqual(UserObject.USER_ROLE, user.role)",
            "",
            "        user.user_root = self.testcases",
            "        user.refresh_repos()",
            "        self.listener.user_attr_changed.assert_called_with(user, {'user_root': ('', self.testcases)})",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user.role = UserObject.ADMIN_ROLE",
            "        self.listener.user_attr_changed.assert_called_with(",
            "            user, {'role': (UserObject.USER_ROLE, UserObject.ADMIN_ROLE)}",
            "        )",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user.email = 'larry@gmail.com'",
            "        self.listener.user_attr_changed.assert_called_with(user, {'email': ('', 'larry@gmail.com')})",
            "        self.listener.user_attr_changed.reset_mock()",
            "",
            "        self.assertEqual('larry@gmail.com', user.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        self.assertEqual(self.testcases, user.user_root)",
            "        self.assertEqual(True, user.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, user.role)",
            "",
            "    def test_set_password_update(self):",
            "        # Given a user in database with a password",
            "        userobj = UserObject.add_user('annik', 'password')",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When updating the user's password",
            "        userobj.set_password('new_password')",
            "        # Then password is SSHA",
            "        self.assertTrue(check_password('new_password', userobj.hash_password))",
            "        # Check if listener called",
            "        self.listener.user_password_changed.assert_called_once_with(userobj)",
            "",
            "    def test_delete_user(self):",
            "        # Given an existing user in database",
            "        userobj = UserObject.add_user('vicky')",
            "        self.assertIsNotNone(UserObject.get_user('vicky'))",
            "        # When deleting that user",
            "        userobj.delete()",
            "        # Then user it no longer in database",
            "        self.assertIsNone(UserObject.get_user('vicky'))",
            "        # Then listner was called",
            "        self.listener.user_deleted.assert_called_once_with('vicky')",
            "",
            "    def test_set_password_empty(self):",
            "        \"\"\"Expect error when trying to update password of invalid user.\"\"\"",
            "        userobj = UserObject.add_user('john')",
            "        with self.assertRaises(ValueError):",
            "            self.assertFalse(userobj.set_password(''))",
            "",
            "    def test_disk_quota(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.disk_quota",
            "",
            "    def test_disk_usage(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        disk_usage = userobj.disk_usage",
            "        self.assertIsInstance(disk_usage, int)",
            "",
            "    def test_add_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user without an authorizedkey file.",
            "        \"\"\"",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys), \"expecting one key\")",
            "        self.assertEqual(\"3c:99:ed:a7:82:a8:71:09:2c:15:3d:78:4a:8c:11:99\", keys[0].fingerprint)",
            "",
            "    def test_add_authorizedkey_duplicate(self):",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "        # Add the same key",
            "        with self.assertRaises(DuplicateSSHKeyError):",
            "            userobj.add_authorizedkey(key)",
            "",
            "    def test_add_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user with an authorizedkey file.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "",
            "        # Create empty authorized_keys file",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        open(filename, 'a').close()",
            "",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # Validate",
            "        with open(filename, 'r') as fh:",
            "            self.assertEqual(key, fh.read())",
            "",
            "    def test_delete_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user without authorizedkey file.",
            "        \"\"\"",
            "        # Update user with ssh keys.",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        for k in authorizedkeys.read(StringIO(data)):",
            "            try:",
            "                userobj.add_authorizedkey(k.getvalue())",
            "            except ValueError:",
            "                # Some ssh key in the testing file are not valid.",
            "                pass",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(2, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys))",
            "",
            "    def test_delete_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user with authorizedkey file.",
            "        \"\"\"",
            "        # Create authorized_keys file",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        with open(filename, 'w') as f:",
            "            f.write(data)",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(5, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(4, len(keys))",
            "",
            "    def test_repo_objs(self):",
            "        # Given a user with a list of repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        repos = sorted(userobj.repo_objs, key=lambda r: r.name)",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in repos])",
            "        # When deleting a repository empty list",
            "        repos[1].delete()",
            "        # Then the repository is removed from the list.",
            "        self.assertEqual(['broker-repo'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_without_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos()",
            "        # Then the list invlaid the invalid repo and new repos",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_single_repo(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.user_root = os.path.join(self.testcases, 'testcases')",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual([''], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_add_access_token(self):",
            "        # Given a user with an email",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = 'test@examples.com'",
            "        userobj.add()",
            "        # When adding a new token",
            "        token = userobj.add_access_token('test')",
            "        # Then a new token get created",
            "        self.assertTrue(token)",
            "        tokenobj = Token.query.filter(Token.userid == userobj.userid).first()",
            "        self.assertTrue(tokenobj)",
            "        self.assertEqual(None, tokenobj.expiration_time)",
            "        self.assertEqual(None, tokenobj.access_time)",
            "        # Then an email is sent to the user.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "        self.listener.queue_mail.assert_called_once()",
            "",
            "    def test_add_access_token_duplicate_name(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When adding a new token with the same name",
            "        with self.assertRaises(ValueError):",
            "            userobj.add_access_token('test')",
            "        # Then token is not created",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # Then an email is not sent.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "",
            "    def test_delete_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an access token",
            "        userobj.delete_access_token('test')",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_access_token_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an invalid access token",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete_access_token('invalid')",
            "        # Then Token not deleted",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_user_remove_access_tokens(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.add_user('testuser', 'password')",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting the user",
            "        userobj.delete()",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is valid",
            "        self.assertTrue(userobj.validate_access_token(token))",
            "",
            "    def test_verify_access_token_with_expired(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token(",
            "            'test', expiration_time=datetime.datetime.now() - datetime.timedelta(seconds=1)",
            "        )",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token(token))",
            "        # Then token get removed",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token_with_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test', expiration_time=datetime.datetime.now())",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token('invalid'))",
            "",
            "",
            "class UserObjectWithAdminPassword(rdiffweb.test.WebCase):",
            "",
            "    # password: test",
            "    default_config = {'admin-password': '{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e'}",
            "",
            "    def setUp(self):",
            "        # Do nothing - We need to skip the default setup to avoid deleting the records.",
            "        pass",
            "",
            "    def test_create_admin_user(self):",
            "        # Given admin-password is configure",
            "        # When database get created",
            "        # Then admin user get created with 'test' password",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertIsNotNone(userobj)",
            "        self.assertEqual('{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e', userobj.hash_password)",
            "        self.assertTrue(check_password('test', userobj.hash_password))",
            "",
            "    def test_set_password(self):",
            "        # Given admin-password is configure",
            "        # When trying to update admin password",
            "        # Then an exception is raised",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        with self.assertRaises(ValueError):",
            "            userobj.set_password('newpassword')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "203": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "204": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "205": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "206": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "207": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "208": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "209": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "210": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "211": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "212": [
                "UserObjectTest",
                "test_set_password_with_old_password"
            ],
            "213": [
                "UserObjectTest"
            ],
            "214": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "215": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "216": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "217": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "218": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "219": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "220": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "221": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "222": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "223": [
                "UserObjectTest",
                "test_set_password_with_invalid_old_password"
            ],
            "224": [
                "UserObjectTest"
            ]
        },
        "addLocation": []
    }
}