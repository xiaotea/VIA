{
    "postgraas_server/backends/postgres_cluster/postgres_cluster_driver.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " import psycopg2"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT"
            },
            "2": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 3,
                "PatchRowcode": "+from psycopg2.sql import SQL, Identifier"
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " "
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " def _create_pg_connection(config):"
            },
            "6": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " def check_db_or_user_exists(db_name, db_user, config):"
            },
            "7": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 21,
                "PatchRowcode": "     with _create_pg_connection(config) as con:"
            },
            "8": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": "         with con.cursor() as cur:"
            },
            "9": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cur.execute(\"SELECT 1 FROM pg_database WHERE datname='{}';\".format(db_name))"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+            cur.execute(\"SELECT 1 FROM pg_database WHERE datname=%s;\", (db_name, ))"
            },
            "11": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 24,
                "PatchRowcode": "             db_exists = cur.fetchone() is not None"
            },
            "12": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cur.execute(\"SELECT 1 FROM pg_roles WHERE rolname='{}';\".format(db_user))"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+            cur.execute(\"SELECT 1 FROM pg_roles WHERE rolname=%s;\", (db_user, ))"
            },
            "14": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 26,
                "PatchRowcode": "             user = cur.fetchone()"
            },
            "15": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 27,
                "PatchRowcode": "             user_exists = user is not None"
            },
            "16": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 28,
                "PatchRowcode": "             return db_exists or user_exists"
            },
            "17": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "     with _create_pg_connection(config) as con:"
            },
            "18": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "         con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)"
            },
            "19": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "         with con.cursor() as cur:"
            },
            "20": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            create_role = \"CREATE USER {db_username} WITH PASSWORD '{db_pwd}';\".format(**connection_dict)"
            },
            "21": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            drop_role = \"DROP ROLE {db_username};\".format(**connection_dict)"
            },
            "22": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            grant_role = 'GRANT {db_username} TO \"{postgraas_user}\";'.format("
            },
            "23": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                db_username=connection_dict['db_username'], postgraas_user=get_normalized_username(config['username'])"
            },
            "24": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            )"
            },
            "25": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            create_database = \"CREATE DATABASE {db_name} OWNER {db_username};\".format(**connection_dict)"
            },
            "26": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "             try:"
            },
            "27": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                cur.execute(create_role)"
            },
            "28": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                cur.execute(grant_role)"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+                cur.execute(SQL(\"CREATE USER {} WITH PASSWORD %s;\").format("
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+                    Identifier(connection_dict['db_username']),"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+                ), ("
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+                    connection_dict['db_pwd'],"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+                ))"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+                cur.execute(SQL(\"GRANT {} TO {};\").format("
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+                    Identifier(connection_dict['db_username']),"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+                    Identifier(get_normalized_username(config['username'])),"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+                ))"
            },
            "38": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "             except psycopg2.ProgrammingError as e:"
            },
            "39": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "                 raise ValueError(e.args[0])"
            },
            "40": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "             # cleanup role in case database creation fails"
            },
            "41": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # saidly 'CREATE DATABASE' cannot run inside a transaction block"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+            # sadly 'CREATE DATABASE' cannot run inside a transaction block"
            },
            "43": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "             try:"
            },
            "44": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                cur.execute(create_database)"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+                cur.execute(SQL(\"CREATE DATABASE {} OWNER {};\").format("
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+                    Identifier(connection_dict['db_name']),"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+                    Identifier(connection_dict['db_username']),"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+                ))"
            },
            "49": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "             except psycopg2.ProgrammingError as e:"
            },
            "50": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                cur.execute(drop_role)"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+                cur.execute(SQL(\"DROP ROLE {};\").format("
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+                    Identifier(connection_dict['db_username']),"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+                ))"
            },
            "54": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "                 raise ValueError(e.args[0])"
            },
            "55": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 61,
                "PatchRowcode": " "
            },
            "56": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 62,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "import psycopg2",
            "from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT",
            "",
            "",
            "def _create_pg_connection(config):",
            "    if 'server' in config:",
            "        username = '@'.join([config['username'], config['server']])",
            "    else:",
            "        username = config['username']",
            "    return psycopg2.connect(",
            "        database=config['database'],",
            "        user=username,",
            "        host=config['host'],",
            "        port=config['port'],",
            "        password=config['password'],",
            "    )",
            "",
            "",
            "def check_db_or_user_exists(db_name, db_user, config):",
            "    with _create_pg_connection(config) as con:",
            "        with con.cursor() as cur:",
            "            cur.execute(\"SELECT 1 FROM pg_database WHERE datname='{}';\".format(db_name))",
            "            db_exists = cur.fetchone() is not None",
            "            cur.execute(\"SELECT 1 FROM pg_roles WHERE rolname='{}';\".format(db_user))",
            "            user = cur.fetchone()",
            "            user_exists = user is not None",
            "            return db_exists or user_exists",
            "",
            "",
            "def create_postgres_db(connection_dict, config):",
            "    if check_db_or_user_exists(connection_dict[\"db_name\"], connection_dict[\"db_username\"], config):",
            "        raise ValueError(\"db or user already exists\")",
            "    with _create_pg_connection(config) as con:",
            "        con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)",
            "        with con.cursor() as cur:",
            "            create_role = \"CREATE USER {db_username} WITH PASSWORD '{db_pwd}';\".format(**connection_dict)",
            "            drop_role = \"DROP ROLE {db_username};\".format(**connection_dict)",
            "            grant_role = 'GRANT {db_username} TO \"{postgraas_user}\";'.format(",
            "                db_username=connection_dict['db_username'], postgraas_user=get_normalized_username(config['username'])",
            "            )",
            "            create_database = \"CREATE DATABASE {db_name} OWNER {db_username};\".format(**connection_dict)",
            "            try:",
            "                cur.execute(create_role)",
            "                cur.execute(grant_role)",
            "            except psycopg2.ProgrammingError as e:",
            "                raise ValueError(e.args[0])",
            "            # cleanup role in case database creation fails",
            "            # saidly 'CREATE DATABASE' cannot run inside a transaction block",
            "            try:",
            "                cur.execute(create_database)",
            "            except psycopg2.ProgrammingError as e:",
            "                cur.execute(drop_role)",
            "                raise ValueError(e.args[0])",
            "",
            "",
            "def get_normalized_username(username):",
            "    return username.split('@')[0]",
            "",
            "",
            "def delete_database(db_name, config):",
            "    with _create_pg_connection(config) as con:",
            "        con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)",
            "        with con.cursor() as cur:",
            "            try:",
            "                cur.execute('''DROP DATABASE \"{}\";'''.format(db_name))",
            "            except psycopg2.ProgrammingError as e:",
            "                raise ValueError(e.args[0])",
            "",
            "",
            "def delete_user(username, config):",
            "    with _create_pg_connection(config) as con:",
            "        con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)",
            "        with con.cursor() as cur:",
            "            try:",
            "                cur.execute('''DROP USER \"{}\";'''.format(get_normalized_username(username)))",
            "            except psycopg2.ProgrammingError as e:",
            "                raise ValueError(e.args[0])"
        ],
        "afterPatchFile": [
            "import psycopg2",
            "from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT",
            "from psycopg2.sql import SQL, Identifier",
            "",
            "",
            "def _create_pg_connection(config):",
            "    if 'server' in config:",
            "        username = '@'.join([config['username'], config['server']])",
            "    else:",
            "        username = config['username']",
            "    return psycopg2.connect(",
            "        database=config['database'],",
            "        user=username,",
            "        host=config['host'],",
            "        port=config['port'],",
            "        password=config['password'],",
            "    )",
            "",
            "",
            "def check_db_or_user_exists(db_name, db_user, config):",
            "    with _create_pg_connection(config) as con:",
            "        with con.cursor() as cur:",
            "            cur.execute(\"SELECT 1 FROM pg_database WHERE datname=%s;\", (db_name, ))",
            "            db_exists = cur.fetchone() is not None",
            "            cur.execute(\"SELECT 1 FROM pg_roles WHERE rolname=%s;\", (db_user, ))",
            "            user = cur.fetchone()",
            "            user_exists = user is not None",
            "            return db_exists or user_exists",
            "",
            "",
            "def create_postgres_db(connection_dict, config):",
            "    if check_db_or_user_exists(connection_dict[\"db_name\"], connection_dict[\"db_username\"], config):",
            "        raise ValueError(\"db or user already exists\")",
            "    with _create_pg_connection(config) as con:",
            "        con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)",
            "        with con.cursor() as cur:",
            "            try:",
            "                cur.execute(SQL(\"CREATE USER {} WITH PASSWORD %s;\").format(",
            "                    Identifier(connection_dict['db_username']),",
            "                ), (",
            "                    connection_dict['db_pwd'],",
            "                ))",
            "                cur.execute(SQL(\"GRANT {} TO {};\").format(",
            "                    Identifier(connection_dict['db_username']),",
            "                    Identifier(get_normalized_username(config['username'])),",
            "                ))",
            "            except psycopg2.ProgrammingError as e:",
            "                raise ValueError(e.args[0])",
            "            # cleanup role in case database creation fails",
            "            # sadly 'CREATE DATABASE' cannot run inside a transaction block",
            "            try:",
            "                cur.execute(SQL(\"CREATE DATABASE {} OWNER {};\").format(",
            "                    Identifier(connection_dict['db_name']),",
            "                    Identifier(connection_dict['db_username']),",
            "                ))",
            "            except psycopg2.ProgrammingError as e:",
            "                cur.execute(SQL(\"DROP ROLE {};\").format(",
            "                    Identifier(connection_dict['db_username']),",
            "                ))",
            "                raise ValueError(e.args[0])",
            "",
            "",
            "def get_normalized_username(username):",
            "    return username.split('@')[0]",
            "",
            "",
            "def delete_database(db_name, config):",
            "    with _create_pg_connection(config) as con:",
            "        con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)",
            "        with con.cursor() as cur:",
            "            try:",
            "                cur.execute('''DROP DATABASE \"{}\";'''.format(db_name))",
            "            except psycopg2.ProgrammingError as e:",
            "                raise ValueError(e.args[0])",
            "",
            "",
            "def delete_user(username, config):",
            "    with _create_pg_connection(config) as con:",
            "        con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)",
            "        with con.cursor() as cur:",
            "            try:",
            "                cur.execute('''DROP USER \"{}\";'''.format(get_normalized_username(username)))",
            "            except psycopg2.ProgrammingError as e:",
            "                raise ValueError(e.args[0])"
        ],
        "action": [
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "22": [
                "check_db_or_user_exists"
            ],
            "24": [
                "check_db_or_user_exists"
            ],
            "36": [
                "create_postgres_db"
            ],
            "37": [
                "create_postgres_db"
            ],
            "38": [
                "create_postgres_db"
            ],
            "39": [
                "create_postgres_db"
            ],
            "40": [
                "create_postgres_db"
            ],
            "41": [
                "create_postgres_db"
            ],
            "43": [
                "create_postgres_db"
            ],
            "44": [
                "create_postgres_db"
            ],
            "48": [
                "create_postgres_db"
            ],
            "50": [
                "create_postgres_db"
            ],
            "52": [
                "create_postgres_db"
            ]
        },
        "addLocation": []
    }
}