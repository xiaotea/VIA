{
    "rdiffweb/controller/page_admin_users.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": 265,
                "PatchRowcode": "             ldap_enabled=self.app.cfg.ldap_uri,"
            },
            "1": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": 266,
                "PatchRowcode": "         )"
            },
            "2": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": 267,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @cherrypy.expose()"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 268,
                "PatchRowcode": "+    @cherrypy.expose"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 269,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'])"
            },
            "6": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": 270,
                "PatchRowcode": "     def new(self, **kwargs):"
            },
            "7": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 271,
                "PatchRowcode": "         form = UserForm()"
            },
            "8": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": 272,
                "PatchRowcode": "         if form.is_submitted():"
            },
            "9": {
                "beforePatchRowNumber": 282,
                "afterPatchRowNumber": 283,
                "PatchRowcode": "                 flash(form.error_message, level='error')"
            },
            "10": {
                "beforePatchRowNumber": 283,
                "afterPatchRowNumber": 284,
                "PatchRowcode": "         return self._compile_template(\"admin_user_new.html\", form=form)"
            },
            "11": {
                "beforePatchRowNumber": 284,
                "afterPatchRowNumber": 285,
                "PatchRowcode": " "
            },
            "12": {
                "beforePatchRowNumber": 285,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @cherrypy.expose()"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 286,
                "PatchRowcode": "+    @cherrypy.expose"
            },
            "14": {
                "beforePatchRowNumber": 286,
                "afterPatchRowNumber": 287,
                "PatchRowcode": "     def edit(self, username_vpath, **kwargs):"
            },
            "15": {
                "beforePatchRowNumber": 287,
                "afterPatchRowNumber": 288,
                "PatchRowcode": "         user = UserObject.get_user(username_vpath)"
            },
            "16": {
                "beforePatchRowNumber": 288,
                "afterPatchRowNumber": 289,
                "PatchRowcode": "         if not user:"
            },
            "17": {
                "beforePatchRowNumber": 297,
                "afterPatchRowNumber": 298,
                "PatchRowcode": "                 flash(form.error_message, level='error')"
            },
            "18": {
                "beforePatchRowNumber": 298,
                "afterPatchRowNumber": 299,
                "PatchRowcode": "         return self._compile_template(\"admin_user_edit.html\", form=form)"
            },
            "19": {
                "beforePatchRowNumber": 299,
                "afterPatchRowNumber": 300,
                "PatchRowcode": " "
            },
            "20": {
                "beforePatchRowNumber": 300,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @cherrypy.expose()"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 301,
                "PatchRowcode": "+    @cherrypy.expose"
            },
            "22": {
                "beforePatchRowNumber": 301,
                "afterPatchRowNumber": 302,
                "PatchRowcode": "     def delete(self, username=None, **kwargs):"
            },
            "23": {
                "beforePatchRowNumber": 302,
                "afterPatchRowNumber": 303,
                "PatchRowcode": "         # Validate form method."
            },
            "24": {
                "beforePatchRowNumber": 303,
                "afterPatchRowNumber": 304,
                "PatchRowcode": "         form = DeleteUserForm()"
            },
            "25": {
                "beforePatchRowNumber": 320,
                "afterPatchRowNumber": 321,
                "PatchRowcode": "         else:"
            },
            "26": {
                "beforePatchRowNumber": 321,
                "afterPatchRowNumber": 322,
                "PatchRowcode": "             flash(form.error_message, level='error')"
            },
            "27": {
                "beforePatchRowNumber": 322,
                "afterPatchRowNumber": 323,
                "PatchRowcode": "         raise cherrypy.HTTPRedirect(url_for('admin', 'users'))"
            },
            "28": {
                "beforePatchRowNumber": 323,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "29": {
                "beforePatchRowNumber": 324,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "30": {
                "beforePatchRowNumber": 325,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-# TODO Allow configuration of notification settigns"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2023 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.validators import ValidationError",
            "",
            "try:",
            "    from wtforms.fields import EmailField  # wtform >=3",
            "except ImportError:",
            "    from wtforms.fields.html5 import EmailField  # wtform <3",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.core.rdw_templating import url_for",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValidationError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "            validators.length(min=3, message=_('Username too short.')),",
            "            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    report_time_range = SelectField(",
            "        _('Send Backup report'),",
            "        choices=[",
            "            (0, _('Never')),",
            "            (1, _('Daily')),",
            "            (7, _('Weekly')),",
            "            (30, _('Monthly')),",
            "        ],",
            "        coerce=int,",
            "        default='0',",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make quota field readonly if quota is not enabled.",
            "        self.quota_enabled = len(cherrypy.engine.listeners.get('set_disk_quota', [])) > 0",
            "        if not self.quota_enabled:",
            "            self.disk_quota.render_kw = {'readonly': True, 'disabled': True}",
            "            self.disk_usage.render_kw = {'readonly': True, 'disabled': True}",
            "        # Add help text for LDAP user",
            "        cfg = cherrypy.request.app.cfg",
            "        if cfg.ldap_uri:",
            "            self.password.description = _('To create an LDAP user, you must leave the password empty.')",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValidationError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValidationError(_('Cannot change your own two-factor authentication settings.'))",
            "        if not self.email.data and self.mfa.data:",
            "            raise ValidationError(_('User email is required to enabled Two-Factor Authentication.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            # Save password if defined",
            "            if self.password.data:",
            "                userobj.set_password(self.password.data)",
            "            userobj.role = self.role.data",
            "            userobj.fullname = self.fullname.data or ''",
            "            userobj.email = self.email.data or ''",
            "            userobj.user_root = self.user_root.data",
            "            userobj.mfa = self.mfa.data",
            "            userobj.report_time_range = self.report_time_range.data",
            "            if userobj.user_root:",
            "                if not userobj.valid_user_root():",
            "                    flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "                    logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "                else:",
            "                    userobj.refresh_repos(delete=True)",
            "            userobj.commit()",
            "",
            "        except Exception as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "            return False",
            "",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        if self.quota_enabled:",
            "            new_quota = self.disk_quota.data or 0",
            "            old_quota = humanfriendly.parse_size(",
            "                humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True)",
            "            )",
            "            if old_quota != new_quota:",
            "                userobj.disk_quota = new_quota",
            "                # Setting quota will silently fail. Check if quota was updated.",
            "                if userobj.disk_quota != new_quota:",
            "                    flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "        return True",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True, 'disabled': True}",
            "",
            "        # When editing ourself.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.object_data == currentuser.username:",
            "            # Disable MFA",
            "            self.mfa.render_kw = {'readonly': True, 'disabled': True}",
            "            # Disable Role",
            "            self.role.render_kw = {'readonly': True, 'disabled': True}",
            "",
            "    def validate_username(self, field):",
            "        # Raise an error if username doesn't matches our user object",
            "        if field.data != field.object_data:",
            "            raise ValidationError(_('Cannot change username of and existing user.'))",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"",
            "    Administration pages. Allow to manage users database.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        # Build users page",
            "        form = UserForm()",
            "        return self._compile_template(",
            "            \"admin_users.html\",",
            "            form=form,",
            "            users=UserObject.query.all(),",
            "            ldap_enabled=self.app.cfg.ldap_uri,",
            "        )",
            "",
            "    @cherrypy.expose()",
            "    def new(self, **kwargs):",
            "        form = UserForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                try:",
            "                    user = UserObject.add_user(form.username.data)",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "                else:",
            "                    if form.populate_obj(user):",
            "                        flash(_(\"User added successfully.\"))",
            "                        raise cherrypy.HTTPRedirect(url_for('admin', 'users'))",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        return self._compile_template(\"admin_user_new.html\", form=form)",
            "",
            "    @cherrypy.expose()",
            "    def edit(self, username_vpath, **kwargs):",
            "        user = UserObject.get_user(username_vpath)",
            "        if not user:",
            "            raise cherrypy.HTTPError(400, _(\"User %s doesn't exists\") % username_vpath)",
            "        form = EditUserForm(obj=user)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.populate_obj(user):",
            "                    flash(_(\"User information modified successfully.\"))",
            "                    raise cherrypy.HTTPRedirect(url_for('admin', 'users'))",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        return self._compile_template(\"admin_user_edit.html\", form=form)",
            "",
            "    @cherrypy.expose()",
            "    def delete(self, username=None, **kwargs):",
            "        # Validate form method.",
            "        form = DeleteUserForm()",
            "        if not form.is_submitted():",
            "            raise cherrypy.HTTPError(405)",
            "        # Get user",
            "        user = UserObject.get_user(username)",
            "        if not user:",
            "            raise cherrypy.HTTPError(400, _(\"User %s doesn't exists\") % username)",
            "        if form.validate():",
            "            if form.username.data == self.app.currentuser.username:",
            "                raise cherrypy.HTTPError(400, _(\"You cannot remove your own account!\"))",
            "            try:",
            "                user.delete()",
            "                user.commit()",
            "                flash(_(\"User account removed.\"))",
            "            except Exception as e:",
            "                user.rollback()",
            "                flash(str(e), level='error')",
            "        else:",
            "            flash(form.error_message, level='error')",
            "        raise cherrypy.HTTPRedirect(url_for('admin', 'users'))",
            "",
            "",
            "# TODO Allow configuration of notification settigns"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2023 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.validators import ValidationError",
            "",
            "try:",
            "    from wtforms.fields import EmailField  # wtform >=3",
            "except ImportError:",
            "    from wtforms.fields.html5 import EmailField  # wtform <3",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.core.rdw_templating import url_for",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValidationError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "            validators.length(min=3, message=_('Username too short.')),",
            "            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    report_time_range = SelectField(",
            "        _('Send Backup report'),",
            "        choices=[",
            "            (0, _('Never')),",
            "            (1, _('Daily')),",
            "            (7, _('Weekly')),",
            "            (30, _('Monthly')),",
            "        ],",
            "        coerce=int,",
            "        default='0',",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make quota field readonly if quota is not enabled.",
            "        self.quota_enabled = len(cherrypy.engine.listeners.get('set_disk_quota', [])) > 0",
            "        if not self.quota_enabled:",
            "            self.disk_quota.render_kw = {'readonly': True, 'disabled': True}",
            "            self.disk_usage.render_kw = {'readonly': True, 'disabled': True}",
            "        # Add help text for LDAP user",
            "        cfg = cherrypy.request.app.cfg",
            "        if cfg.ldap_uri:",
            "            self.password.description = _('To create an LDAP user, you must leave the password empty.')",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValidationError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValidationError(_('Cannot change your own two-factor authentication settings.'))",
            "        if not self.email.data and self.mfa.data:",
            "            raise ValidationError(_('User email is required to enabled Two-Factor Authentication.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            # Save password if defined",
            "            if self.password.data:",
            "                userobj.set_password(self.password.data)",
            "            userobj.role = self.role.data",
            "            userobj.fullname = self.fullname.data or ''",
            "            userobj.email = self.email.data or ''",
            "            userobj.user_root = self.user_root.data",
            "            userobj.mfa = self.mfa.data",
            "            userobj.report_time_range = self.report_time_range.data",
            "            if userobj.user_root:",
            "                if not userobj.valid_user_root():",
            "                    flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "                    logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "                else:",
            "                    userobj.refresh_repos(delete=True)",
            "            userobj.commit()",
            "",
            "        except Exception as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "            return False",
            "",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        if self.quota_enabled:",
            "            new_quota = self.disk_quota.data or 0",
            "            old_quota = humanfriendly.parse_size(",
            "                humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True)",
            "            )",
            "            if old_quota != new_quota:",
            "                userobj.disk_quota = new_quota",
            "                # Setting quota will silently fail. Check if quota was updated.",
            "                if userobj.disk_quota != new_quota:",
            "                    flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "        return True",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True, 'disabled': True}",
            "",
            "        # When editing ourself.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.object_data == currentuser.username:",
            "            # Disable MFA",
            "            self.mfa.render_kw = {'readonly': True, 'disabled': True}",
            "            # Disable Role",
            "            self.role.render_kw = {'readonly': True, 'disabled': True}",
            "",
            "    def validate_username(self, field):",
            "        # Raise an error if username doesn't matches our user object",
            "        if field.data != field.object_data:",
            "            raise ValidationError(_('Cannot change username of and existing user.'))",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"",
            "    Administration pages. Allow to manage users database.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        # Build users page",
            "        form = UserForm()",
            "        return self._compile_template(",
            "            \"admin_users.html\",",
            "            form=form,",
            "            users=UserObject.query.all(),",
            "            ldap_enabled=self.app.cfg.ldap_uri,",
            "        )",
            "",
            "    @cherrypy.expose",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def new(self, **kwargs):",
            "        form = UserForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                try:",
            "                    user = UserObject.add_user(form.username.data)",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "                else:",
            "                    if form.populate_obj(user):",
            "                        flash(_(\"User added successfully.\"))",
            "                        raise cherrypy.HTTPRedirect(url_for('admin', 'users'))",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        return self._compile_template(\"admin_user_new.html\", form=form)",
            "",
            "    @cherrypy.expose",
            "    def edit(self, username_vpath, **kwargs):",
            "        user = UserObject.get_user(username_vpath)",
            "        if not user:",
            "            raise cherrypy.HTTPError(400, _(\"User %s doesn't exists\") % username_vpath)",
            "        form = EditUserForm(obj=user)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.populate_obj(user):",
            "                    flash(_(\"User information modified successfully.\"))",
            "                    raise cherrypy.HTTPRedirect(url_for('admin', 'users'))",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        return self._compile_template(\"admin_user_edit.html\", form=form)",
            "",
            "    @cherrypy.expose",
            "    def delete(self, username=None, **kwargs):",
            "        # Validate form method.",
            "        form = DeleteUserForm()",
            "        if not form.is_submitted():",
            "            raise cherrypy.HTTPError(405)",
            "        # Get user",
            "        user = UserObject.get_user(username)",
            "        if not user:",
            "            raise cherrypy.HTTPError(400, _(\"User %s doesn't exists\") % username)",
            "        if form.validate():",
            "            if form.username.data == self.app.currentuser.username:",
            "                raise cherrypy.HTTPError(400, _(\"You cannot remove your own account!\"))",
            "            try:",
            "                user.delete()",
            "                user.commit()",
            "                flash(_(\"User account removed.\"))",
            "            except Exception as e:",
            "                user.rollback()",
            "                flash(str(e), level='error')",
            "        else:",
            "            flash(form.error_message, level='error')",
            "        raise cherrypy.HTTPRedirect(url_for('admin', 'users'))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "268": [
                "AdminUsersPage"
            ],
            "285": [
                "AdminUsersPage"
            ],
            "300": [
                "AdminUsersPage"
            ],
            "323": [],
            "324": [],
            "325": []
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_pref_sshkeys.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 115,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 116,
                "PatchRowcode": " class PagePrefSshKeys(Controller):"
            },
            "2": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "     @cherrypy.expose"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'])"
            },
            "4": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 119,
                "PatchRowcode": "     def default(self, **kwargs):"
            },
            "5": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 120,
                "PatchRowcode": "         # Handle action"
            },
            "6": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 121,
                "PatchRowcode": "         add_form = SshForm()"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2023 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugins to allows users to configure the SSH keys using the web",
            "interface. Basically it's a UI for `~/.ssh/authorized_keys`. For this",
            "plugin to work properly, the users home directory need to match a real",
            "user home.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import HiddenField, StringField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets.core import TextArea",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.dispatch import restapi",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "_logger = logging.getLogger(__name__)",
            "",
            "",
            "def validate_key(unused_form, field):",
            "    \"\"\"Custom validator to check the SSH Key.\"\"\"",
            "    try:",
            "        authorizedkeys.check_publickey(field.data)",
            "    except ValueError:",
            "        raise ValidationError(_(\"Invalid SSH key.\"))",
            "",
            "",
            "class SshForm(CherryForm):",
            "    action = HiddenField(default=\"add\")",
            "    title = StringField(",
            "        _('Title'),",
            "        description=_('The title is an optional description to identify the key. e.g.: bob@thinkpad-t530'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(",
            "                max=256,",
            "                message=_('Title too long.'),",
            "            ),",
            "        ],",
            "    )",
            "    key = StringField(",
            "        _('Key'),",
            "        widget=TextArea(),",
            "        description=_(",
            "            \"Enter a SSH public key. It should start with 'ssh-dss', 'ssh-ed25519', 'ssh-rsa', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384' or 'ecdsa-sha2-nistp521'.\"",
            "        ),",
            "        validators=[validators.data_required(), validate_key],",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'add'",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            userobj.add_authorizedkey(key=self.key.data, comment=self.title.data)",
            "            userobj.commit()",
            "            return True",
            "        except DuplicateSSHKeyError as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='error')",
            "            _logger.warning(\"trying to add duplicate ssh key\")",
            "            return False",
            "        except Exception:",
            "            userobj.rollback()",
            "            flash(_(\"Unknown error while adding the SSH Key\"), level='error')",
            "            _logger.warning(\"error adding ssh key\", exc_info=1)",
            "            return False",
            "",
            "",
            "class DeleteSshForm(CherryForm):",
            "    action = HiddenField(default=\"delete\")",
            "    fingerprint = StringField('Fingerprint', validators=[validators.data_required()])",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'delete'",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_authorizedkey(self.fingerprint.data)",
            "            userobj.commit()",
            "            return True",
            "        except Exception:",
            "            userobj.rollback()",
            "            if hasattr(cherrypy.serving, 'session'):",
            "                flash(_(\"Unknown error while removing the SSH Key\"), level='error')",
            "            _logger.warning(\"error removing ssh key\", exc_info=1)",
            "            return False",
            "",
            "",
            "class PagePrefSshKeys(Controller):",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Handle action",
            "        add_form = SshForm()",
            "        delete_form = DeleteSshForm()",
            "        if not self.app.cfg.disable_ssh_keys:",
            "            if add_form.is_submitted():",
            "                if add_form.validate():",
            "                    if add_form.populate_obj(self.app.currentuser):",
            "                        raise cherrypy.HTTPRedirect(\"\")",
            "                else:",
            "                    flash(add_form.error_message, level='warning')",
            "            elif delete_form.is_submitted():",
            "                if delete_form.validate():",
            "                    if delete_form.populate_obj(self.app.currentuser):",
            "                        raise cherrypy.HTTPRedirect(\"\")",
            "                else:",
            "                    flash(delete_form.error_message, level='warning')",
            "",
            "        # Get SSH keys if file exists.",
            "        params = {",
            "            'disable_ssh_keys': self.app.cfg.disable_ssh_keys,",
            "            'form': add_form,",
            "        }",
            "        try:",
            "            params[\"sshkeys\"] = [",
            "                {'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys",
            "            ]",
            "        except IOError:",
            "            params[\"sshkeys\"] = []",
            "            flash(_(\"Failed to get SSH keys\"), level='error')",
            "            _logger.warning(\"error reading SSH keys\", exc_info=1)",
            "",
            "        return self._compile_template(\"prefs_sshkeys.html\", **params)",
            "",
            "",
            "@restapi()",
            "@cherrypy.tools.json_out()",
            "class ApiSshKeys(Controller):",
            "    @cherrypy.expose",
            "    def list(self):",
            "        return [{'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys]",
            "",
            "    @cherrypy.expose",
            "    def get(self, fingerprint):",
            "        for key in self.app.currentuser.authorizedkeys:",
            "            if key.fingerprint == fingerprint:",
            "                return {'title': key.comment, 'fingerprint': key.fingerprint}",
            "        raise cherrypy.HTTPError(404)",
            "",
            "    @cherrypy.expose",
            "    def delete(self, fingerprint):",
            "        form = DeleteSshForm(fingerprint=fingerprint)",
            "        if form.validate():",
            "            form.populate_obj(self.app.currentuser)",
            "            return {}",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)",
            "",
            "    @cherrypy.expose",
            "    def post(self, **kwargs):",
            "        form = SshForm()",
            "        if form.validate():",
            "            # Create the SSH Key",
            "            userobj = self.app.currentuser",
            "            try:",
            "                userobj.add_authorizedkey(key=form.key.data, comment=form.title.data)",
            "                userobj.commit()",
            "            except DuplicateSSHKeyError as e:",
            "                userobj.rollback()",
            "                raise cherrypy.HTTPError(400, str(e))",
            "            return kwargs",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2023 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugins to allows users to configure the SSH keys using the web",
            "interface. Basically it's a UI for `~/.ssh/authorized_keys`. For this",
            "plugin to work properly, the users home directory need to match a real",
            "user home.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import HiddenField, StringField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets.core import TextArea",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.dispatch import restapi",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "_logger = logging.getLogger(__name__)",
            "",
            "",
            "def validate_key(unused_form, field):",
            "    \"\"\"Custom validator to check the SSH Key.\"\"\"",
            "    try:",
            "        authorizedkeys.check_publickey(field.data)",
            "    except ValueError:",
            "        raise ValidationError(_(\"Invalid SSH key.\"))",
            "",
            "",
            "class SshForm(CherryForm):",
            "    action = HiddenField(default=\"add\")",
            "    title = StringField(",
            "        _('Title'),",
            "        description=_('The title is an optional description to identify the key. e.g.: bob@thinkpad-t530'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(",
            "                max=256,",
            "                message=_('Title too long.'),",
            "            ),",
            "        ],",
            "    )",
            "    key = StringField(",
            "        _('Key'),",
            "        widget=TextArea(),",
            "        description=_(",
            "            \"Enter a SSH public key. It should start with 'ssh-dss', 'ssh-ed25519', 'ssh-rsa', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384' or 'ecdsa-sha2-nistp521'.\"",
            "        ),",
            "        validators=[validators.data_required(), validate_key],",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'add'",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            userobj.add_authorizedkey(key=self.key.data, comment=self.title.data)",
            "            userobj.commit()",
            "            return True",
            "        except DuplicateSSHKeyError as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='error')",
            "            _logger.warning(\"trying to add duplicate ssh key\")",
            "            return False",
            "        except Exception:",
            "            userobj.rollback()",
            "            flash(_(\"Unknown error while adding the SSH Key\"), level='error')",
            "            _logger.warning(\"error adding ssh key\", exc_info=1)",
            "            return False",
            "",
            "",
            "class DeleteSshForm(CherryForm):",
            "    action = HiddenField(default=\"delete\")",
            "    fingerprint = StringField('Fingerprint', validators=[validators.data_required()])",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'delete'",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_authorizedkey(self.fingerprint.data)",
            "            userobj.commit()",
            "            return True",
            "        except Exception:",
            "            userobj.rollback()",
            "            if hasattr(cherrypy.serving, 'session'):",
            "                flash(_(\"Unknown error while removing the SSH Key\"), level='error')",
            "            _logger.warning(\"error removing ssh key\", exc_info=1)",
            "            return False",
            "",
            "",
            "class PagePrefSshKeys(Controller):",
            "    @cherrypy.expose",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def default(self, **kwargs):",
            "        # Handle action",
            "        add_form = SshForm()",
            "        delete_form = DeleteSshForm()",
            "        if not self.app.cfg.disable_ssh_keys:",
            "            if add_form.is_submitted():",
            "                if add_form.validate():",
            "                    if add_form.populate_obj(self.app.currentuser):",
            "                        raise cherrypy.HTTPRedirect(\"\")",
            "                else:",
            "                    flash(add_form.error_message, level='warning')",
            "            elif delete_form.is_submitted():",
            "                if delete_form.validate():",
            "                    if delete_form.populate_obj(self.app.currentuser):",
            "                        raise cherrypy.HTTPRedirect(\"\")",
            "                else:",
            "                    flash(delete_form.error_message, level='warning')",
            "",
            "        # Get SSH keys if file exists.",
            "        params = {",
            "            'disable_ssh_keys': self.app.cfg.disable_ssh_keys,",
            "            'form': add_form,",
            "        }",
            "        try:",
            "            params[\"sshkeys\"] = [",
            "                {'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys",
            "            ]",
            "        except IOError:",
            "            params[\"sshkeys\"] = []",
            "            flash(_(\"Failed to get SSH keys\"), level='error')",
            "            _logger.warning(\"error reading SSH keys\", exc_info=1)",
            "",
            "        return self._compile_template(\"prefs_sshkeys.html\", **params)",
            "",
            "",
            "@restapi()",
            "@cherrypy.tools.json_out()",
            "class ApiSshKeys(Controller):",
            "    @cherrypy.expose",
            "    def list(self):",
            "        return [{'title': key.comment, 'fingerprint': key.fingerprint} for key in self.app.currentuser.authorizedkeys]",
            "",
            "    @cherrypy.expose",
            "    def get(self, fingerprint):",
            "        for key in self.app.currentuser.authorizedkeys:",
            "            if key.fingerprint == fingerprint:",
            "                return {'title': key.comment, 'fingerprint': key.fingerprint}",
            "        raise cherrypy.HTTPError(404)",
            "",
            "    @cherrypy.expose",
            "    def delete(self, fingerprint):",
            "        form = DeleteSshForm(fingerprint=fingerprint)",
            "        if form.validate():",
            "            form.populate_obj(self.app.currentuser)",
            "            return {}",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)",
            "",
            "    @cherrypy.expose",
            "    def post(self, **kwargs):",
            "        form = SshForm()",
            "        if form.validate():",
            "            # Create the SSH Key",
            "            userobj = self.app.currentuser",
            "            try:",
            "                userobj.add_authorizedkey(key=form.key.data, comment=form.title.data)",
            "                userobj.commit()",
            "            except DuplicateSSHKeyError as e:",
            "                userobj.rollback()",
            "                raise cherrypy.HTTPError(400, str(e))",
            "            return kwargs",
            "        else:",
            "            raise cherrypy.HTTPError(400, form.error_message)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.page_pref_sshkeys.PagePrefSshKeys.self"
        ]
    },
    "rdiffweb/controller/page_pref_tokens.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 119,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 120,
                "PatchRowcode": " class PagePrefTokens(Controller):"
            },
            "2": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 121,
                "PatchRowcode": "     @cherrypy.expose"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'])"
            },
            "4": {
                "beforePatchRowNumber": 122,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "     def default(self, **kwargs):"
            },
            "5": {
                "beforePatchRowNumber": 123,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "         form = TokenForm()"
            },
            "6": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 125,
                "PatchRowcode": "         delete_form = DeleteTokenForm()"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2023 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import DateTimeField, StringField, SubmitField",
            "from wtforms.validators import DataRequired, Length, Optional",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import Token",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "try:",
            "    # wtform>=3",
            "    from wtforms.widgets import DateInput",
            "except ImportError:",
            "    # wtform<3",
            "    from wtforms.widgets.html5 import DateInput",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class TokenForm(CherryForm):",
            "    name = StringField(",
            "        _('Token name'),",
            "        description=_(",
            "            'Used only to identify the purpose of the token. For example, the application that uses the token.'",
            "        ),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_('Token name too long')),",
            "        ],",
            "    )",
            "    expiration = DateTimeField(",
            "        _('Expiration date'),",
            "        description=_(",
            "            'Allows the creation of a temporary token by defining an expiration date. Leave empty to keep the token forever.'",
            "        ),",
            "        render_kw={",
            "            \"placeholder\": _('YYYY-MM-DD'),",
            "        },",
            "        format=\"%Y-%m-%d\",",
            "        widget=DateInput(),",
            "        validators=[Optional()],",
            "    )",
            "    add_access_token = SubmitField(_('Create access token'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.add_access_token.data",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            token = userobj.add_access_token(self.name.data, self.expiration.data)",
            "            userobj.commit()",
            "            flash(",
            "                _(",
            "                    \"Your new personal access token has been created.\\n\"",
            "                    \"Make sure to save it - you won't be able to access it again.\\n\"",
            "                    \"%s\"",
            "                )",
            "                % token,",
            "                level='info',",
            "            )",
            "            return True",
            "        except ValueError as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "            return False",
            "        except Exception:",
            "            userobj.rollback()",
            "            logger.exception(\"error adding access token: %s, %s\" % (self.name.data, self.expiration.data))",
            "            flash(_(\"Unknown error while adding the access token.\"), level='error')",
            "            return False",
            "",
            "",
            "class DeleteTokenForm(CherryForm):",
            "    name = StringField(validators=[DataRequired()])",
            "    revoke = SubmitField(_('Revoke'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.revoke.data",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_access_token(self.name.data)",
            "            flash(_('The access token has been successfully deleted.'), level='success')",
            "            return True",
            "        except ValueError as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "            return False",
            "        except Exception:",
            "            userobj.rollback()",
            "            logger.exception(\"error removing access token: %s\" % self.name.data)",
            "            flash(_(\"Unknown error while removing the access token.\"), level='error')",
            "            return False",
            "",
            "",
            "class PagePrefTokens(Controller):",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        form = TokenForm()",
            "        delete_form = DeleteTokenForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.populate_obj(self.app.currentuser):",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif delete_form.is_submitted():",
            "            if delete_form.validate():",
            "                if delete_form.populate_obj(self.app.currentuser):",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(delete_form.error_message, level='error')",
            "        params = {",
            "            'form': form,",
            "            'tokens': Token.query.filter(Token.userid == self.app.currentuser.userid),",
            "        }",
            "        return self._compile_template(\"prefs_tokens.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2023 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import DateTimeField, StringField, SubmitField",
            "from wtforms.validators import DataRequired, Length, Optional",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import Token",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "try:",
            "    # wtform>=3",
            "    from wtforms.widgets import DateInput",
            "except ImportError:",
            "    # wtform<3",
            "    from wtforms.widgets.html5 import DateInput",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class TokenForm(CherryForm):",
            "    name = StringField(",
            "        _('Token name'),",
            "        description=_(",
            "            'Used only to identify the purpose of the token. For example, the application that uses the token.'",
            "        ),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_('Token name too long')),",
            "        ],",
            "    )",
            "    expiration = DateTimeField(",
            "        _('Expiration date'),",
            "        description=_(",
            "            'Allows the creation of a temporary token by defining an expiration date. Leave empty to keep the token forever.'",
            "        ),",
            "        render_kw={",
            "            \"placeholder\": _('YYYY-MM-DD'),",
            "        },",
            "        format=\"%Y-%m-%d\",",
            "        widget=DateInput(),",
            "        validators=[Optional()],",
            "    )",
            "    add_access_token = SubmitField(_('Create access token'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.add_access_token.data",
            "",
            "    def populate_obj(self, userobj):",
            "        try:",
            "            token = userobj.add_access_token(self.name.data, self.expiration.data)",
            "            userobj.commit()",
            "            flash(",
            "                _(",
            "                    \"Your new personal access token has been created.\\n\"",
            "                    \"Make sure to save it - you won't be able to access it again.\\n\"",
            "                    \"%s\"",
            "                )",
            "                % token,",
            "                level='info',",
            "            )",
            "            return True",
            "        except ValueError as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "            return False",
            "        except Exception:",
            "            userobj.rollback()",
            "            logger.exception(\"error adding access token: %s, %s\" % (self.name.data, self.expiration.data))",
            "            flash(_(\"Unknown error while adding the access token.\"), level='error')",
            "            return False",
            "",
            "",
            "class DeleteTokenForm(CherryForm):",
            "    name = StringField(validators=[DataRequired()])",
            "    revoke = SubmitField(_('Revoke'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.revoke.data",
            "",
            "    def populate_obj(self, userobj):",
            "        is_maintainer()",
            "        try:",
            "            userobj.delete_access_token(self.name.data)",
            "            flash(_('The access token has been successfully deleted.'), level='success')",
            "            return True",
            "        except ValueError as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "            return False",
            "        except Exception:",
            "            userobj.rollback()",
            "            logger.exception(\"error removing access token: %s\" % self.name.data)",
            "            flash(_(\"Unknown error while removing the access token.\"), level='error')",
            "            return False",
            "",
            "",
            "class PagePrefTokens(Controller):",
            "    @cherrypy.expose",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def default(self, **kwargs):",
            "        form = TokenForm()",
            "        delete_form = DeleteTokenForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.populate_obj(self.app.currentuser):",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif delete_form.is_submitted():",
            "            if delete_form.validate():",
            "                if delete_form.populate_obj(self.app.currentuser):",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(delete_form.error_message, level='error')",
            "        params = {",
            "            'form': form,",
            "            'tokens': Token.query.filter(Token.userid == self.app.currentuser.userid),",
            "        }",
            "        return self._compile_template(\"prefs_tokens.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.page_pref_tokens.PagePrefTokens.self"
        ]
    }
}