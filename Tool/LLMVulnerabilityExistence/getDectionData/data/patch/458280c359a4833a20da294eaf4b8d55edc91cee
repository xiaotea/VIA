{
    "nautobot/core/tests/test_views.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import urllib.parse"
            },
            "1": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from django.contrib.contenttypes.models import ContentType"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from django.core.files.uploadedfile import SimpleUploadedFile"
            },
            "4": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from django.test import RequestFactory, override_settings"
            },
            "5": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from django.test.utils import override_script_prefix"
            },
            "6": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from django.urls import get_script_prefix, reverse"
            },
            "7": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from prometheus_client.parser import text_string_to_metric_families"
            },
            "8": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from nautobot.core.testing import TestCase"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+from nautobot.core.utils.permissions import get_permission_for_model"
            },
            "11": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from nautobot.core.views.mixins import GetReturnURLMixin"
            },
            "12": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from nautobot.dcim.models.locations import Location"
            },
            "13": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from nautobot.extras.choices import CustomFieldTypeChoices"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 17,
                "PatchRowcode": "+from nautobot.extras.models import FileProxy"
            },
            "15": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from nautobot.extras.models.customfields import CustomField, CustomFieldChoice"
            },
            "16": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " from nautobot.extras.registry import registry"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 20,
                "PatchRowcode": "+from nautobot.users.models import ObjectPermission"
            },
            "18": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " "
            },
            "20": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " class GetReturnURLMixinTestCase(TestCase):"
            },
            "21": {
                "beforePatchRowNumber": 476,
                "afterPatchRowNumber": 480,
                "PatchRowcode": "         self.assertNotContains(response, \"Network to Code\", status_code=500)"
            },
            "22": {
                "beforePatchRowNumber": 477,
                "afterPatchRowNumber": 481,
                "PatchRowcode": "         response_content = response.content.decode(response.charset)"
            },
            "23": {
                "beforePatchRowNumber": 478,
                "afterPatchRowNumber": 482,
                "PatchRowcode": "         self.assertInHTML(\"Hello world!\", response_content)"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 483,
                "PatchRowcode": "+"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 484,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 485,
                "PatchRowcode": "+class DBFileStorageViewTestCase(TestCase):"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 486,
                "PatchRowcode": "+    \"\"\"Test authentication/permission enforcement for django_db_file_storage views.\"\"\""
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 487,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 488,
                "PatchRowcode": "+    def setUp(self):"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 489,
                "PatchRowcode": "+        super().setUp()"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 490,
                "PatchRowcode": "+        self.test_file_1 = SimpleUploadedFile(name=\"test_file_1.txt\", content=b\"I am content.\\n\")"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 491,
                "PatchRowcode": "+        self.file_proxy_1 = FileProxy.objects.create(name=self.test_file_1.name, file=self.test_file_1)"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 492,
                "PatchRowcode": "+        self.test_file_2 = SimpleUploadedFile(name=\"test_file_2.txt\", content=b\"I am content.\\n\")"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 493,
                "PatchRowcode": "+        self.file_proxy_2 = FileProxy.objects.create(name=self.test_file_2.name, file=self.test_file_2)"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 494,
                "PatchRowcode": "+        self.urls = ["
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 495,
                "PatchRowcode": "+            f\"{reverse('db_file_storage.download_file')}?name={self.file_proxy_1.file.name}\","
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 496,
                "PatchRowcode": "+            f\"{reverse('db_file_storage.get_file')}?name={self.file_proxy_1.file.name}\","
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 497,
                "PatchRowcode": "+        ]"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 498,
                "PatchRowcode": "+"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 499,
                "PatchRowcode": "+    def test_get_file_anonymous(self):"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 500,
                "PatchRowcode": "+        self.client.logout()"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 501,
                "PatchRowcode": "+        for url in self.urls:"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 502,
                "PatchRowcode": "+            with self.subTest(url):"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 503,
                "PatchRowcode": "+                response = self.client.get(url)"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 504,
                "PatchRowcode": "+                self.assertHttpStatus(response, 403)"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 505,
                "PatchRowcode": "+"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 506,
                "PatchRowcode": "+    def test_get_file_without_permission(self):"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 507,
                "PatchRowcode": "+        for url in self.urls:"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 508,
                "PatchRowcode": "+            with self.subTest(url):"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 509,
                "PatchRowcode": "+                response = self.client.get(url)"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 510,
                "PatchRowcode": "+                self.assertHttpStatus(response, 403)"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 511,
                "PatchRowcode": "+"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 512,
                "PatchRowcode": "+    def test_get_object_with_permission(self):"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 513,
                "PatchRowcode": "+        self.add_permissions(get_permission_for_model(FileProxy, \"view\"))"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 514,
                "PatchRowcode": "+        for url in self.urls:"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 515,
                "PatchRowcode": "+            with self.subTest(url):"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 516,
                "PatchRowcode": "+                response = self.client.get(url)"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 517,
                "PatchRowcode": "+                self.assertHttpStatus(response, 200)"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 518,
                "PatchRowcode": "+"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 519,
                "PatchRowcode": "+    def test_get_object_with_constrained_permission(self):"
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 520,
                "PatchRowcode": "+        obj_perm = ObjectPermission("
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 521,
                "PatchRowcode": "+            name=\"Test permission\","
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 522,
                "PatchRowcode": "+            constraints={\"pk\": self.file_proxy_1.pk},"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 523,
                "PatchRowcode": "+            actions=[\"view\"],"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 524,
                "PatchRowcode": "+        )"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 525,
                "PatchRowcode": "+        obj_perm.save()"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 526,
                "PatchRowcode": "+        obj_perm.users.add(self.user)"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 527,
                "PatchRowcode": "+        obj_perm.object_types.add(ContentType.objects.get_for_model(FileProxy))"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 528,
                "PatchRowcode": "+        for url in self.urls:"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 529,
                "PatchRowcode": "+            with self.subTest(url):"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 530,
                "PatchRowcode": "+                response = self.client.get(url)"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 531,
                "PatchRowcode": "+                self.assertHttpStatus(response, 200)"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 532,
                "PatchRowcode": "+        for url in ["
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 533,
                "PatchRowcode": "+            f\"{reverse('db_file_storage.download_file')}?name={self.file_proxy_2.file.name}\","
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 534,
                "PatchRowcode": "+            f\"{reverse('db_file_storage.get_file')}?name={self.file_proxy_2.file.name}\","
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 535,
                "PatchRowcode": "+        ]:"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 536,
                "PatchRowcode": "+            with self.subTest(url):"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 537,
                "PatchRowcode": "+                response = self.client.get(url)"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 538,
                "PatchRowcode": "+                self.assertHttpStatus(response, 404)"
            }
        },
        "frontPatchFile": [
            "import re",
            "from unittest import mock",
            "import urllib.parse",
            "",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.test import RequestFactory, override_settings",
            "from django.test.utils import override_script_prefix",
            "from django.urls import get_script_prefix, reverse",
            "from prometheus_client.parser import text_string_to_metric_families",
            "",
            "from nautobot.core.testing import TestCase",
            "from nautobot.core.views.mixins import GetReturnURLMixin",
            "from nautobot.dcim.models.locations import Location",
            "from nautobot.extras.choices import CustomFieldTypeChoices",
            "from nautobot.extras.models.customfields import CustomField, CustomFieldChoice",
            "from nautobot.extras.registry import registry",
            "",
            "",
            "class GetReturnURLMixinTestCase(TestCase):",
            "    \"\"\"Tests for the API of GetReturnURLMixin.\"\"\"",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):",
            "        cls.factory = RequestFactory(SERVER_NAME=\"nautobot.example.com\")",
            "        cls.mixin = GetReturnURLMixin()",
            "",
            "    def test_get_return_url_explicit(self):",
            "        request = self.factory.get(\"/\", {\"return_url\": \"/dcim/devices/\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), \"/dcim/devices/\")",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=Location.objects.first()), \"/dcim/devices/\")",
            "",
            "        request = self.factory.get(\"/\", {\"return_url\": \"/dcim/devices/?status=Active\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), \"/dcim/devices/?status=Active\")",
            "",
            "    def test_get_return_url_explicit_unsafe(self):",
            "        request = self.factory.get(\"/\", {\"return_url\": \"http://example.com\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), reverse(\"home\"))",
            "",
            "    def test_get_return_url_explicit_punycode(self):",
            "        request = self.factory.get(\"/\", {\"return_url\": \"/dc\u0131m/devices/\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), \"/dc%C4%B1m/devices/\")",
            "",
            "    def test_get_return_url_default_with_obj(self):",
            "        request = self.factory.get(\"/\")",
            "        location = Location.objects.first()",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=location), location.get_absolute_url())",
            "",
            "",
            "class HomeViewTestCase(TestCase):",
            "    def test_home(self):",
            "        url = reverse(\"home\")",
            "",
            "        response = self.client.get(url)",
            "        self.assertHttpStatus(response, 200)",
            "",
            "    def test_search(self):",
            "        url = reverse(\"search\")",
            "        params = {",
            "            \"q\": \"foo\",",
            "        }",
            "",
            "        response = self.client.get(f\"{url}?{urllib.parse.urlencode(params)}\")",
            "        self.assertHttpStatus(response, 200)",
            "",
            "    def make_request(self):",
            "        url = reverse(\"home\")",
            "        response = self.client.get(url)",
            "",
            "        # Search bar in nav",
            "        nav_search_bar_pattern = re.compile(",
            "            '<nav.*<form action=\"/search/\" method=\"get\" class=\"navbar-form navbar-right\" id=\"navbar_search\" role=\"search\">.*</form>.*</nav>'",
            "        )",
            "        nav_search_bar_result = nav_search_bar_pattern.search(",
            "            response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        )",
            "",
            "        # Global search bar in body/container-fluid wrapper",
            "        body_search_bar_pattern = re.compile(",
            "            '<div class=\"container-fluid wrapper\">.*<form action=\"/search/\" method=\"get\" class=\"form-inline\">.*</form>.*</div>'",
            "        )",
            "        body_search_bar_result = body_search_bar_pattern.search(",
            "            response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        )",
            "",
            "        return nav_search_bar_result, body_search_bar_result",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True)",
            "    def test_search_bar_not_visible_if_user_not_authenticated_and_hide_restricted_ui_True(self):",
            "        self.client.logout()",
            "",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNone(nav_search_bar_result)",
            "        self.assertIsNone(body_search_bar_result)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_search_bar_visible_if_user_authenticated_and_hide_restricted_ui_True(self):",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNotNone(nav_search_bar_result)",
            "        self.assertIsNotNone(body_search_bar_result)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_search_bar_visible_if_hide_restricted_ui_False(self):",
            "        # Assert if user is authenticated",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNotNone(nav_search_bar_result)",
            "        self.assertIsNotNone(body_search_bar_result)",
            "",
            "        # Assert if user is logout",
            "        self.client.logout()",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNotNone(nav_search_bar_result)",
            "        self.assertIsNotNone(body_search_bar_result)",
            "",
            "    @override_settings(VERSION=\"1.2.3\")",
            "    def test_footer_version_visible_authenticated_users_only(self):",
            "        url = reverse(\"home\")",
            "        response = self.client.get(url)",
            "        response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "",
            "        footer_hostname_version_pattern = re.compile(r'<p class=\"text-muted\">\\s+\\S+\\s+\\(v1\\.2\\.3\\)\\s+</p>')",
            "        self.assertRegex(response_content, footer_hostname_version_pattern)",
            "",
            "        self.client.logout()",
            "        response = self.client.get(url)",
            "        response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        self.assertNotRegex(response_content, footer_hostname_version_pattern)",
            "",
            "",
            "@override_settings(BRANDING_TITLE=\"Nautobot\")",
            "class SearchFieldsTestCase(TestCase):",
            "    def test_search_bar_redirect_to_login(self):",
            "        self.client.logout()",
            "        response = self.client.get(reverse(\"search\") + \"?q=prefix\")",
            "        # Assert that if the user is not logged in",
            "        # SearchForm will redirect the user to the login Page",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_global_and_model_search_bar(self):",
            "        self.add_permissions(\"dcim.view_location\", \"dcim.view_device\")",
            "",
            "        # Assert model search bar present in list UI",
            "        response = self.client.get(reverse(\"dcim:location_list\"))",
            "        self.assertInHTML(",
            "            '<input type=\"text\" name=\"q\" class=\"form-control\" required placeholder=\"Search Locations\" id=\"id_q\">',",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "        response = self.client.get(reverse(\"dcim:device_list\"))",
            "        self.assertInHTML(",
            "            '<input type=\"text\" name=\"q\" class=\"form-control\" required placeholder=\"Search Devices\" id=\"id_q\">',",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "        # Assert global search bar present in UI",
            "        self.assertInHTML(",
            "            '<input type=\"text\" name=\"q\" class=\"form-control\" placeholder=\"Search Nautobot\">',",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "",
            "class FilterFormsTestCase(TestCase):",
            "    def test_support_for_both_default_and_dynamic_filter_form_in_ui(self):",
            "        self.add_permissions(\"dcim.view_location\", \"circuits.view_circuit\")",
            "",
            "        filter_tabs = \"\"\"",
            "            <ul id=\"tabs\" class=\"nav nav-tabs\">",
            "                <li role=\"presentation\" class=\"active\">",
            "                    <a href=\"#default-filter\" role=\"tab\" data-toggle=\"tab\">",
            "                        Default",
            "                    </a>",
            "                </li>",
            "                <li role=\"presentation\" class=\"\">",
            "                    <a href=\"#advanced-filter\" role=\"tab\" data-toggle=\"tab\">",
            "                        Advanced",
            "                    </a>",
            "                </li>",
            "            </ul>",
            "            \"\"\"",
            "",
            "        response = self.client.get(reverse(\"dcim:location_list\"))",
            "        self.assertInHTML(",
            "            filter_tabs,",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "        response = self.client.get(reverse(\"circuits:circuit_list\"))",
            "        self.assertInHTML(",
            "            filter_tabs,",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "    def test_filtering_on_custom_select_filter_field(self):",
            "        \"\"\"Assert CustomField select and multiple select fields can be filtered using multiple entries\"\"\"",
            "        self.add_permissions(\"dcim.view_location\")",
            "",
            "        multi_select_cf = CustomField.objects.create(",
            "            type=CustomFieldTypeChoices.TYPE_MULTISELECT, label=\"Multiple Choice\"",
            "        )",
            "        select_cf = CustomField.objects.create(type=CustomFieldTypeChoices.TYPE_SELECT, label=\"choice\")",
            "        choices = [\"Foo\", \"Bar\", \"FooBar\"]",
            "        for cf in [multi_select_cf, select_cf]:",
            "            cf.content_types.set([ContentType.objects.get_for_model(Location)])",
            "            CustomFieldChoice.objects.create(custom_field=cf, value=choices[0])",
            "            CustomFieldChoice.objects.create(custom_field=cf, value=choices[1])",
            "            CustomFieldChoice.objects.create(custom_field=cf, value=choices[2])",
            "",
            "        locations = Location.objects.all()[:3]",
            "        for idx, location in enumerate(locations):",
            "            location.cf[multi_select_cf.key] = choices[:2]",
            "            location.cf[select_cf.key] = choices[idx]",
            "            location.save()",
            "",
            "        query_param = (",
            "            f\"?cf_{multi_select_cf.key}={choices[0]}&cf_{multi_select_cf.key}={choices[1]}\"",
            "            f\"&cf_{select_cf.key}={choices[0]}&cf_{select_cf.key}={choices[1]}\"",
            "        )",
            "        url = reverse(\"dcim:location_list\") + query_param",
            "        response = self.client.get(url)",
            "        response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        self.assertInHTML(locations[0].name, response_content)",
            "        self.assertInHTML(locations[1].name, response_content)",
            "",
            "",
            "class ForceScriptNameTestcase(TestCase):",
            "    \"\"\"Basic test to assert that `settings.FORCE_SCRIPT_NAME` works as intended.\"\"\"",
            "",
            "    @override_settings(",
            "        FORCE_SCRIPT_NAME=\"/nautobot/\",",
            "    )",
            "    @override_script_prefix(\"/nautobot/\")",
            "    def test_subdirectory_routes(self):",
            "        # We must call `set_script_prefix()` to set the URL resolver script prefix outside of the",
            "        # request/response cycle (e.g. in scripts/tests) to generate correct URLs when `SCRIPT_NAME`",
            "        # is not `/`.",
            "        #",
            "        # We must then call it again to reset the script pefix after we're done because",
            "        # the state is stored in the thread-local scope and will \"infect\" other tests.",
            "        prefix = get_script_prefix()",
            "        self.assertEqual(prefix, \"/nautobot/\")",
            "",
            "        # And that routes will start w/ the prefix vs. just \"/\" (the default).",
            "        routes = (\"home\", \"login\", \"search\", \"api-root\")",
            "        for route in routes:",
            "            url = reverse(route)",
            "            self.assertTrue(url.startswith(prefix))",
            "",
            "",
            "class NavRestrictedUI(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "",
            "        self.url = reverse(\"plugins:plugins_list\")",
            "        self.item_weight = 100  # TODO: not easy to introspect from the nav menu struct, so hard-code it here for now",
            "",
            "    def make_request(self):",
            "        response = self.client.get(reverse(\"home\"))",
            "        return response.content.decode(response.charset)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True)",
            "    def test_installed_apps_visible_to_staff_with_hide_restricted_ui_true(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be available to is_staff user regardless of HIDE_RESTRICTED_UI.\"\"\"",
            "        # Make user admin",
            "        self.user.is_staff = True",
            "        self.user.save()",
            "",
            "        response_content = self.make_request()",
            "        self.assertInHTML(",
            "            f\"\"\"",
            "            <a href=\"{self.url}\"",
            "                data-item-weight=\"{self.item_weight}\">",
            "                Installed Plugins",
            "            </a>",
            "            \"\"\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_installed_apps_visible_to_staff_with_hide_restricted_ui_false(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be available to is_staff user regardless of HIDE_RESTRICTED_UI.\"\"\"",
            "        # Make user admin",
            "        self.user.is_staff = True",
            "        self.user.save()",
            "",
            "        response_content = self.make_request()",
            "        self.assertInHTML(",
            "            f\"\"\"",
            "            <a href=\"{self.url}\"",
            "                data-item-weight=\"{self.item_weight}\">",
            "                Installed Plugins",
            "            </a>",
            "            \"\"\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True)",
            "    def test_installed_apps_not_visible_to_non_staff_user_with_hide_restricted_ui_true(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be hidden from a non-staff user when HIDE_RESTRICTED_UI=True.\"\"\"",
            "        response_content = self.make_request()",
            "",
            "        self.assertNotRegex(response_content, r\"Installed\\s+Apps\")",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_installed_apps_disabled_to_non_staff_user_with_hide_restricted_ui_false(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be disabled for a non-staff user when HIDE_RESTRICTED_UI=False.\"\"\"",
            "        response_content = self.make_request()",
            "",
            "        # print(response_content)",
            "",
            "        self.assertInHTML(",
            "            f\"\"\"",
            "            <a href=\"{self.url}\"",
            "                data-item-weight=\"{self.item_weight}\">",
            "                Installed Plugins",
            "            </a>",
            "            \"\"\",",
            "            response_content,",
            "        )",
            "",
            "",
            "class LoginUI(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "",
            "        self.footer_elements = [",
            "            '<a href=\"#theme_modal\" data-toggle=\"modal\" data-target=\"#theme_modal\" id=\"btn-theme-modal\"><i class=\"mdi mdi-theme-light-dark text-primary\"></i>Theme</a>',",
            "            '<a href=\"/static/docs/index.html\">Docs</a>',",
            "            '<i class=\"mdi mdi-cloud-braces text-primary\"></i> <a href=\"/api/docs/\">API</a>',",
            "            '<i class=\"mdi mdi-graphql text-primary\"></i> <a href=\"/graphql/\">GraphQL</a>',",
            "            '<i class=\"mdi mdi-xml text-primary\"></i> <a href=\"https://github.com/nautobot/nautobot\">Code</a>',",
            "            '<i class=\"mdi mdi-lifebuoy text-primary\"></i> <a href=\"https://github.com/nautobot/nautobot/wiki\">Help</a>',",
            "        ]",
            "",
            "    def make_request(self):",
            "        response = self.client.get(reverse(\"login\"))",
            "        sso_login_pattern = re.compile('<a href=\".*\">Continue with SSO</a>')",
            "        return sso_login_pattern.search(response.content.decode(response.charset))",
            "",
            "    def test_sso_login_button_not_visible(self):",
            "        \"\"\"Test Continue with SSO button not visible if SSO is enabled\"\"\"",
            "        self.client.logout()",
            "",
            "        sso_login_search_result = self.make_request()",
            "        self.assertIsNone(sso_login_search_result)",
            "",
            "    @override_settings(",
            "        AUTHENTICATION_BACKENDS=[",
            "            \"social_core.backends.google.GoogleOAuth2\",",
            "            \"nautobot.core.authentication.ObjectPermissionBackend\",",
            "        ]",
            "    )",
            "    def test_sso_login_button_visible(self):",
            "        self.client.logout()",
            "        sso_login_search_result = self.make_request()",
            "        self.assertIsNotNone(sso_login_search_result)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True, BANNER_TOP=\"Hello, Banner Top\", BANNER_BOTTOM=\"Hello, Banner Bottom\")",
            "    def test_routes_redirect_back_to_login_if_hide_restricted_ui_true(self):",
            "        \"\"\"Assert that api docs and graphql redirects to login page if user is unauthenticated and HIDE_RESTRICTED_UI=True.\"\"\"",
            "        self.client.logout()",
            "        headers = {\"HTTP_ACCEPT\": \"text/html\"}",
            "        urls = [reverse(\"api_docs\"), reverse(\"graphql\")]",
            "        for url in urls:",
            "            response = self.client.get(url, follow=True, **headers)",
            "            self.assertHttpStatus(response, 200)",
            "            redirect_chain = [(f\"/login/?next={url}\", 302)]",
            "            self.assertEqual(response.redirect_chain, redirect_chain)",
            "            response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "            # Assert Footer items(`self.footer_elements`), Banner and Banner Top is hidden",
            "            for footer_text in self.footer_elements:",
            "                self.assertNotIn(footer_text, response_content)",
            "            # Only API Docs implements BANNERS",
            "            if url == urls[0]:",
            "                self.assertNotIn(\"Hello, Banner Top\", response_content)",
            "                self.assertNotIn(\"Hello, Banner Bottom\", response_content)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False, BANNER_TOP=\"Hello, Banner Top\", BANNER_BOTTOM=\"Hello, Banner Bottom\")",
            "    def test_routes_no_redirect_back_to_login_if_hide_restricted_ui_false(self):",
            "        \"\"\"Assert that api docs and graphql do not redirects to login page if user is unauthenticated and HIDE_RESTRICTED_UI=False.\"\"\"",
            "        self.client.logout()",
            "        headers = {\"HTTP_ACCEPT\": \"text/html\"}",
            "        urls = [reverse(\"api_docs\"), reverse(\"graphql\")]",
            "        for url in urls:",
            "            response = self.client.get(url, **headers)",
            "            self.assertHttpStatus(response, 200)",
            "            self.assertEqual(response.request[\"PATH_INFO\"], url)",
            "            response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "            # Assert Footer items(`self.footer_elements`), Banner and Banner Top is not hidden",
            "            for footer_text in self.footer_elements:",
            "                self.assertInHTML(footer_text, response_content)",
            "",
            "            # Only API Docs implements BANNERS",
            "            if url == urls[0]:",
            "                self.assertInHTML(\"Hello, Banner Top\", response_content)",
            "                self.assertInHTML(\"Hello, Banner Bottom\", response_content)",
            "",
            "",
            "class MetricsViewTestCase(TestCase):",
            "    def query_and_parse_metrics(self):",
            "        response = self.client.get(reverse(\"metrics\"))",
            "        self.assertHttpStatus(response, 200, msg=\"/metrics should return a 200 HTTP status code.\")",
            "        page_content = response.content.decode(response.charset)",
            "        return text_string_to_metric_families(page_content)",
            "",
            "    def test_metrics_extensibility(self):",
            "        \"\"\"Assert that the example metric from the example plugin shows up _exactly_ when the plugin is enabled.\"\"\"",
            "        test_metric_name = \"nautobot_example_metric_count\"",
            "        metrics_with_plugin = self.query_and_parse_metrics()",
            "        metric_names_with_plugin = {metric.name for metric in metrics_with_plugin}",
            "        self.assertIn(test_metric_name, metric_names_with_plugin)",
            "        with override_settings(PLUGINS=[]):",
            "            # Clear out the app metric registry because it is not updated when settings are changed but Nautobot is not",
            "            # restarted.",
            "            registry[\"app_metrics\"].clear()",
            "            metrics_without_plugin = self.query_and_parse_metrics()",
            "            metric_names_without_plugin = {metric.name for metric in metrics_without_plugin}",
            "            self.assertNotIn(test_metric_name, metric_names_without_plugin)",
            "        metric_names_with_plugin.remove(test_metric_name)",
            "        self.assertSetEqual(metric_names_with_plugin, metric_names_without_plugin)",
            "",
            "",
            "class ErrorPagesTestCase(TestCase):",
            "    \"\"\"Tests for 4xx and 5xx error page rendering.\"\"\"",
            "",
            "    @override_settings(DEBUG=False)",
            "    def test_404_default_support_message(self):",
            "        \"\"\"Nautobot's custom 404 page should be used and should include a default support message.\"\"\"",
            "        with self.assertTemplateUsed(\"404.html\"):",
            "            response = self.client.get(\"/foo/bar\")",
            "        self.assertContains(response, \"Network to Code\", status_code=404)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(",
            "            \"If further assistance is required, please join the <code>#nautobot</code> channel \"",
            "            'on <a href=\"https://slack.networktocode.com/\">Network to Code\\'s Slack community</a> '",
            "            \"and post your question.\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(DEBUG=False, SUPPORT_MESSAGE=\"Hello world!\")",
            "    def test_404_custom_support_message(self):",
            "        \"\"\"Nautobot's custom 404 page should be used and should include a custom support message if defined.\"\"\"",
            "        with self.assertTemplateUsed(\"404.html\"):",
            "            response = self.client.get(\"/foo/bar\")",
            "        self.assertNotContains(response, \"Network to Code\", status_code=404)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(\"Hello world!\", response_content)",
            "",
            "    @override_settings(DEBUG=False)",
            "    @mock.patch(\"nautobot.core.views.HomeView.get\", side_effect=Exception)",
            "    def test_500_default_support_message(self, mock_get):",
            "        \"\"\"Nautobot's custom 500 page should be used and should include a default support message.\"\"\"",
            "        url = reverse(\"home\")",
            "        with self.assertTemplateUsed(\"500.html\"):",
            "            self.client.raise_request_exception = False",
            "            response = self.client.get(url)",
            "        self.assertContains(response, \"Network to Code\", status_code=500)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(",
            "            \"If further assistance is required, please join the <code>#nautobot</code> channel \"",
            "            'on <a href=\"https://slack.networktocode.com/\">Network to Code\\'s Slack community</a> '",
            "            \"and post your question.\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(DEBUG=False, SUPPORT_MESSAGE=\"Hello world!\")",
            "    @mock.patch(\"nautobot.core.views.HomeView.get\", side_effect=Exception)",
            "    def test_500_custom_support_message(self, mock_get):",
            "        \"\"\"Nautobot's custom 500 page should be used and should include a default support message.\"\"\"",
            "        url = reverse(\"home\")",
            "        with self.assertTemplateUsed(\"500.html\"):",
            "            self.client.raise_request_exception = False",
            "            response = self.client.get(url)",
            "        self.assertNotContains(response, \"Network to Code\", status_code=500)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(\"Hello world!\", response_content)"
        ],
        "afterPatchFile": [
            "import re",
            "from unittest import mock",
            "import urllib.parse",
            "",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.core.files.uploadedfile import SimpleUploadedFile",
            "from django.test import RequestFactory, override_settings",
            "from django.test.utils import override_script_prefix",
            "from django.urls import get_script_prefix, reverse",
            "from prometheus_client.parser import text_string_to_metric_families",
            "",
            "from nautobot.core.testing import TestCase",
            "from nautobot.core.utils.permissions import get_permission_for_model",
            "from nautobot.core.views.mixins import GetReturnURLMixin",
            "from nautobot.dcim.models.locations import Location",
            "from nautobot.extras.choices import CustomFieldTypeChoices",
            "from nautobot.extras.models import FileProxy",
            "from nautobot.extras.models.customfields import CustomField, CustomFieldChoice",
            "from nautobot.extras.registry import registry",
            "from nautobot.users.models import ObjectPermission",
            "",
            "",
            "class GetReturnURLMixinTestCase(TestCase):",
            "    \"\"\"Tests for the API of GetReturnURLMixin.\"\"\"",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):",
            "        cls.factory = RequestFactory(SERVER_NAME=\"nautobot.example.com\")",
            "        cls.mixin = GetReturnURLMixin()",
            "",
            "    def test_get_return_url_explicit(self):",
            "        request = self.factory.get(\"/\", {\"return_url\": \"/dcim/devices/\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), \"/dcim/devices/\")",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=Location.objects.first()), \"/dcim/devices/\")",
            "",
            "        request = self.factory.get(\"/\", {\"return_url\": \"/dcim/devices/?status=Active\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), \"/dcim/devices/?status=Active\")",
            "",
            "    def test_get_return_url_explicit_unsafe(self):",
            "        request = self.factory.get(\"/\", {\"return_url\": \"http://example.com\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), reverse(\"home\"))",
            "",
            "    def test_get_return_url_explicit_punycode(self):",
            "        request = self.factory.get(\"/\", {\"return_url\": \"/dc\u0131m/devices/\"})",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=None), \"/dc%C4%B1m/devices/\")",
            "",
            "    def test_get_return_url_default_with_obj(self):",
            "        request = self.factory.get(\"/\")",
            "        location = Location.objects.first()",
            "        self.assertEqual(self.mixin.get_return_url(request=request, obj=location), location.get_absolute_url())",
            "",
            "",
            "class HomeViewTestCase(TestCase):",
            "    def test_home(self):",
            "        url = reverse(\"home\")",
            "",
            "        response = self.client.get(url)",
            "        self.assertHttpStatus(response, 200)",
            "",
            "    def test_search(self):",
            "        url = reverse(\"search\")",
            "        params = {",
            "            \"q\": \"foo\",",
            "        }",
            "",
            "        response = self.client.get(f\"{url}?{urllib.parse.urlencode(params)}\")",
            "        self.assertHttpStatus(response, 200)",
            "",
            "    def make_request(self):",
            "        url = reverse(\"home\")",
            "        response = self.client.get(url)",
            "",
            "        # Search bar in nav",
            "        nav_search_bar_pattern = re.compile(",
            "            '<nav.*<form action=\"/search/\" method=\"get\" class=\"navbar-form navbar-right\" id=\"navbar_search\" role=\"search\">.*</form>.*</nav>'",
            "        )",
            "        nav_search_bar_result = nav_search_bar_pattern.search(",
            "            response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        )",
            "",
            "        # Global search bar in body/container-fluid wrapper",
            "        body_search_bar_pattern = re.compile(",
            "            '<div class=\"container-fluid wrapper\">.*<form action=\"/search/\" method=\"get\" class=\"form-inline\">.*</form>.*</div>'",
            "        )",
            "        body_search_bar_result = body_search_bar_pattern.search(",
            "            response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        )",
            "",
            "        return nav_search_bar_result, body_search_bar_result",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True)",
            "    def test_search_bar_not_visible_if_user_not_authenticated_and_hide_restricted_ui_True(self):",
            "        self.client.logout()",
            "",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNone(nav_search_bar_result)",
            "        self.assertIsNone(body_search_bar_result)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_search_bar_visible_if_user_authenticated_and_hide_restricted_ui_True(self):",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNotNone(nav_search_bar_result)",
            "        self.assertIsNotNone(body_search_bar_result)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_search_bar_visible_if_hide_restricted_ui_False(self):",
            "        # Assert if user is authenticated",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNotNone(nav_search_bar_result)",
            "        self.assertIsNotNone(body_search_bar_result)",
            "",
            "        # Assert if user is logout",
            "        self.client.logout()",
            "        nav_search_bar_result, body_search_bar_result = self.make_request()",
            "",
            "        self.assertIsNotNone(nav_search_bar_result)",
            "        self.assertIsNotNone(body_search_bar_result)",
            "",
            "    @override_settings(VERSION=\"1.2.3\")",
            "    def test_footer_version_visible_authenticated_users_only(self):",
            "        url = reverse(\"home\")",
            "        response = self.client.get(url)",
            "        response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "",
            "        footer_hostname_version_pattern = re.compile(r'<p class=\"text-muted\">\\s+\\S+\\s+\\(v1\\.2\\.3\\)\\s+</p>')",
            "        self.assertRegex(response_content, footer_hostname_version_pattern)",
            "",
            "        self.client.logout()",
            "        response = self.client.get(url)",
            "        response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        self.assertNotRegex(response_content, footer_hostname_version_pattern)",
            "",
            "",
            "@override_settings(BRANDING_TITLE=\"Nautobot\")",
            "class SearchFieldsTestCase(TestCase):",
            "    def test_search_bar_redirect_to_login(self):",
            "        self.client.logout()",
            "        response = self.client.get(reverse(\"search\") + \"?q=prefix\")",
            "        # Assert that if the user is not logged in",
            "        # SearchForm will redirect the user to the login Page",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_global_and_model_search_bar(self):",
            "        self.add_permissions(\"dcim.view_location\", \"dcim.view_device\")",
            "",
            "        # Assert model search bar present in list UI",
            "        response = self.client.get(reverse(\"dcim:location_list\"))",
            "        self.assertInHTML(",
            "            '<input type=\"text\" name=\"q\" class=\"form-control\" required placeholder=\"Search Locations\" id=\"id_q\">',",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "        response = self.client.get(reverse(\"dcim:device_list\"))",
            "        self.assertInHTML(",
            "            '<input type=\"text\" name=\"q\" class=\"form-control\" required placeholder=\"Search Devices\" id=\"id_q\">',",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "        # Assert global search bar present in UI",
            "        self.assertInHTML(",
            "            '<input type=\"text\" name=\"q\" class=\"form-control\" placeholder=\"Search Nautobot\">',",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "",
            "class FilterFormsTestCase(TestCase):",
            "    def test_support_for_both_default_and_dynamic_filter_form_in_ui(self):",
            "        self.add_permissions(\"dcim.view_location\", \"circuits.view_circuit\")",
            "",
            "        filter_tabs = \"\"\"",
            "            <ul id=\"tabs\" class=\"nav nav-tabs\">",
            "                <li role=\"presentation\" class=\"active\">",
            "                    <a href=\"#default-filter\" role=\"tab\" data-toggle=\"tab\">",
            "                        Default",
            "                    </a>",
            "                </li>",
            "                <li role=\"presentation\" class=\"\">",
            "                    <a href=\"#advanced-filter\" role=\"tab\" data-toggle=\"tab\">",
            "                        Advanced",
            "                    </a>",
            "                </li>",
            "            </ul>",
            "            \"\"\"",
            "",
            "        response = self.client.get(reverse(\"dcim:location_list\"))",
            "        self.assertInHTML(",
            "            filter_tabs,",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "        response = self.client.get(reverse(\"circuits:circuit_list\"))",
            "        self.assertInHTML(",
            "            filter_tabs,",
            "            response.content.decode(response.charset),",
            "        )",
            "",
            "    def test_filtering_on_custom_select_filter_field(self):",
            "        \"\"\"Assert CustomField select and multiple select fields can be filtered using multiple entries\"\"\"",
            "        self.add_permissions(\"dcim.view_location\")",
            "",
            "        multi_select_cf = CustomField.objects.create(",
            "            type=CustomFieldTypeChoices.TYPE_MULTISELECT, label=\"Multiple Choice\"",
            "        )",
            "        select_cf = CustomField.objects.create(type=CustomFieldTypeChoices.TYPE_SELECT, label=\"choice\")",
            "        choices = [\"Foo\", \"Bar\", \"FooBar\"]",
            "        for cf in [multi_select_cf, select_cf]:",
            "            cf.content_types.set([ContentType.objects.get_for_model(Location)])",
            "            CustomFieldChoice.objects.create(custom_field=cf, value=choices[0])",
            "            CustomFieldChoice.objects.create(custom_field=cf, value=choices[1])",
            "            CustomFieldChoice.objects.create(custom_field=cf, value=choices[2])",
            "",
            "        locations = Location.objects.all()[:3]",
            "        for idx, location in enumerate(locations):",
            "            location.cf[multi_select_cf.key] = choices[:2]",
            "            location.cf[select_cf.key] = choices[idx]",
            "            location.save()",
            "",
            "        query_param = (",
            "            f\"?cf_{multi_select_cf.key}={choices[0]}&cf_{multi_select_cf.key}={choices[1]}\"",
            "            f\"&cf_{select_cf.key}={choices[0]}&cf_{select_cf.key}={choices[1]}\"",
            "        )",
            "        url = reverse(\"dcim:location_list\") + query_param",
            "        response = self.client.get(url)",
            "        response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "        self.assertInHTML(locations[0].name, response_content)",
            "        self.assertInHTML(locations[1].name, response_content)",
            "",
            "",
            "class ForceScriptNameTestcase(TestCase):",
            "    \"\"\"Basic test to assert that `settings.FORCE_SCRIPT_NAME` works as intended.\"\"\"",
            "",
            "    @override_settings(",
            "        FORCE_SCRIPT_NAME=\"/nautobot/\",",
            "    )",
            "    @override_script_prefix(\"/nautobot/\")",
            "    def test_subdirectory_routes(self):",
            "        # We must call `set_script_prefix()` to set the URL resolver script prefix outside of the",
            "        # request/response cycle (e.g. in scripts/tests) to generate correct URLs when `SCRIPT_NAME`",
            "        # is not `/`.",
            "        #",
            "        # We must then call it again to reset the script pefix after we're done because",
            "        # the state is stored in the thread-local scope and will \"infect\" other tests.",
            "        prefix = get_script_prefix()",
            "        self.assertEqual(prefix, \"/nautobot/\")",
            "",
            "        # And that routes will start w/ the prefix vs. just \"/\" (the default).",
            "        routes = (\"home\", \"login\", \"search\", \"api-root\")",
            "        for route in routes:",
            "            url = reverse(route)",
            "            self.assertTrue(url.startswith(prefix))",
            "",
            "",
            "class NavRestrictedUI(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "",
            "        self.url = reverse(\"plugins:plugins_list\")",
            "        self.item_weight = 100  # TODO: not easy to introspect from the nav menu struct, so hard-code it here for now",
            "",
            "    def make_request(self):",
            "        response = self.client.get(reverse(\"home\"))",
            "        return response.content.decode(response.charset)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True)",
            "    def test_installed_apps_visible_to_staff_with_hide_restricted_ui_true(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be available to is_staff user regardless of HIDE_RESTRICTED_UI.\"\"\"",
            "        # Make user admin",
            "        self.user.is_staff = True",
            "        self.user.save()",
            "",
            "        response_content = self.make_request()",
            "        self.assertInHTML(",
            "            f\"\"\"",
            "            <a href=\"{self.url}\"",
            "                data-item-weight=\"{self.item_weight}\">",
            "                Installed Plugins",
            "            </a>",
            "            \"\"\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_installed_apps_visible_to_staff_with_hide_restricted_ui_false(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be available to is_staff user regardless of HIDE_RESTRICTED_UI.\"\"\"",
            "        # Make user admin",
            "        self.user.is_staff = True",
            "        self.user.save()",
            "",
            "        response_content = self.make_request()",
            "        self.assertInHTML(",
            "            f\"\"\"",
            "            <a href=\"{self.url}\"",
            "                data-item-weight=\"{self.item_weight}\">",
            "                Installed Plugins",
            "            </a>",
            "            \"\"\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True)",
            "    def test_installed_apps_not_visible_to_non_staff_user_with_hide_restricted_ui_true(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be hidden from a non-staff user when HIDE_RESTRICTED_UI=True.\"\"\"",
            "        response_content = self.make_request()",
            "",
            "        self.assertNotRegex(response_content, r\"Installed\\s+Apps\")",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False)",
            "    def test_installed_apps_disabled_to_non_staff_user_with_hide_restricted_ui_false(self):",
            "        \"\"\"The \"Installed Apps\" menu item should be disabled for a non-staff user when HIDE_RESTRICTED_UI=False.\"\"\"",
            "        response_content = self.make_request()",
            "",
            "        # print(response_content)",
            "",
            "        self.assertInHTML(",
            "            f\"\"\"",
            "            <a href=\"{self.url}\"",
            "                data-item-weight=\"{self.item_weight}\">",
            "                Installed Plugins",
            "            </a>",
            "            \"\"\",",
            "            response_content,",
            "        )",
            "",
            "",
            "class LoginUI(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "",
            "        self.footer_elements = [",
            "            '<a href=\"#theme_modal\" data-toggle=\"modal\" data-target=\"#theme_modal\" id=\"btn-theme-modal\"><i class=\"mdi mdi-theme-light-dark text-primary\"></i>Theme</a>',",
            "            '<a href=\"/static/docs/index.html\">Docs</a>',",
            "            '<i class=\"mdi mdi-cloud-braces text-primary\"></i> <a href=\"/api/docs/\">API</a>',",
            "            '<i class=\"mdi mdi-graphql text-primary\"></i> <a href=\"/graphql/\">GraphQL</a>',",
            "            '<i class=\"mdi mdi-xml text-primary\"></i> <a href=\"https://github.com/nautobot/nautobot\">Code</a>',",
            "            '<i class=\"mdi mdi-lifebuoy text-primary\"></i> <a href=\"https://github.com/nautobot/nautobot/wiki\">Help</a>',",
            "        ]",
            "",
            "    def make_request(self):",
            "        response = self.client.get(reverse(\"login\"))",
            "        sso_login_pattern = re.compile('<a href=\".*\">Continue with SSO</a>')",
            "        return sso_login_pattern.search(response.content.decode(response.charset))",
            "",
            "    def test_sso_login_button_not_visible(self):",
            "        \"\"\"Test Continue with SSO button not visible if SSO is enabled\"\"\"",
            "        self.client.logout()",
            "",
            "        sso_login_search_result = self.make_request()",
            "        self.assertIsNone(sso_login_search_result)",
            "",
            "    @override_settings(",
            "        AUTHENTICATION_BACKENDS=[",
            "            \"social_core.backends.google.GoogleOAuth2\",",
            "            \"nautobot.core.authentication.ObjectPermissionBackend\",",
            "        ]",
            "    )",
            "    def test_sso_login_button_visible(self):",
            "        self.client.logout()",
            "        sso_login_search_result = self.make_request()",
            "        self.assertIsNotNone(sso_login_search_result)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=True, BANNER_TOP=\"Hello, Banner Top\", BANNER_BOTTOM=\"Hello, Banner Bottom\")",
            "    def test_routes_redirect_back_to_login_if_hide_restricted_ui_true(self):",
            "        \"\"\"Assert that api docs and graphql redirects to login page if user is unauthenticated and HIDE_RESTRICTED_UI=True.\"\"\"",
            "        self.client.logout()",
            "        headers = {\"HTTP_ACCEPT\": \"text/html\"}",
            "        urls = [reverse(\"api_docs\"), reverse(\"graphql\")]",
            "        for url in urls:",
            "            response = self.client.get(url, follow=True, **headers)",
            "            self.assertHttpStatus(response, 200)",
            "            redirect_chain = [(f\"/login/?next={url}\", 302)]",
            "            self.assertEqual(response.redirect_chain, redirect_chain)",
            "            response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "            # Assert Footer items(`self.footer_elements`), Banner and Banner Top is hidden",
            "            for footer_text in self.footer_elements:",
            "                self.assertNotIn(footer_text, response_content)",
            "            # Only API Docs implements BANNERS",
            "            if url == urls[0]:",
            "                self.assertNotIn(\"Hello, Banner Top\", response_content)",
            "                self.assertNotIn(\"Hello, Banner Bottom\", response_content)",
            "",
            "    @override_settings(HIDE_RESTRICTED_UI=False, BANNER_TOP=\"Hello, Banner Top\", BANNER_BOTTOM=\"Hello, Banner Bottom\")",
            "    def test_routes_no_redirect_back_to_login_if_hide_restricted_ui_false(self):",
            "        \"\"\"Assert that api docs and graphql do not redirects to login page if user is unauthenticated and HIDE_RESTRICTED_UI=False.\"\"\"",
            "        self.client.logout()",
            "        headers = {\"HTTP_ACCEPT\": \"text/html\"}",
            "        urls = [reverse(\"api_docs\"), reverse(\"graphql\")]",
            "        for url in urls:",
            "            response = self.client.get(url, **headers)",
            "            self.assertHttpStatus(response, 200)",
            "            self.assertEqual(response.request[\"PATH_INFO\"], url)",
            "            response_content = response.content.decode(response.charset).replace(\"\\n\", \"\")",
            "            # Assert Footer items(`self.footer_elements`), Banner and Banner Top is not hidden",
            "            for footer_text in self.footer_elements:",
            "                self.assertInHTML(footer_text, response_content)",
            "",
            "            # Only API Docs implements BANNERS",
            "            if url == urls[0]:",
            "                self.assertInHTML(\"Hello, Banner Top\", response_content)",
            "                self.assertInHTML(\"Hello, Banner Bottom\", response_content)",
            "",
            "",
            "class MetricsViewTestCase(TestCase):",
            "    def query_and_parse_metrics(self):",
            "        response = self.client.get(reverse(\"metrics\"))",
            "        self.assertHttpStatus(response, 200, msg=\"/metrics should return a 200 HTTP status code.\")",
            "        page_content = response.content.decode(response.charset)",
            "        return text_string_to_metric_families(page_content)",
            "",
            "    def test_metrics_extensibility(self):",
            "        \"\"\"Assert that the example metric from the example plugin shows up _exactly_ when the plugin is enabled.\"\"\"",
            "        test_metric_name = \"nautobot_example_metric_count\"",
            "        metrics_with_plugin = self.query_and_parse_metrics()",
            "        metric_names_with_plugin = {metric.name for metric in metrics_with_plugin}",
            "        self.assertIn(test_metric_name, metric_names_with_plugin)",
            "        with override_settings(PLUGINS=[]):",
            "            # Clear out the app metric registry because it is not updated when settings are changed but Nautobot is not",
            "            # restarted.",
            "            registry[\"app_metrics\"].clear()",
            "            metrics_without_plugin = self.query_and_parse_metrics()",
            "            metric_names_without_plugin = {metric.name for metric in metrics_without_plugin}",
            "            self.assertNotIn(test_metric_name, metric_names_without_plugin)",
            "        metric_names_with_plugin.remove(test_metric_name)",
            "        self.assertSetEqual(metric_names_with_plugin, metric_names_without_plugin)",
            "",
            "",
            "class ErrorPagesTestCase(TestCase):",
            "    \"\"\"Tests for 4xx and 5xx error page rendering.\"\"\"",
            "",
            "    @override_settings(DEBUG=False)",
            "    def test_404_default_support_message(self):",
            "        \"\"\"Nautobot's custom 404 page should be used and should include a default support message.\"\"\"",
            "        with self.assertTemplateUsed(\"404.html\"):",
            "            response = self.client.get(\"/foo/bar\")",
            "        self.assertContains(response, \"Network to Code\", status_code=404)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(",
            "            \"If further assistance is required, please join the <code>#nautobot</code> channel \"",
            "            'on <a href=\"https://slack.networktocode.com/\">Network to Code\\'s Slack community</a> '",
            "            \"and post your question.\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(DEBUG=False, SUPPORT_MESSAGE=\"Hello world!\")",
            "    def test_404_custom_support_message(self):",
            "        \"\"\"Nautobot's custom 404 page should be used and should include a custom support message if defined.\"\"\"",
            "        with self.assertTemplateUsed(\"404.html\"):",
            "            response = self.client.get(\"/foo/bar\")",
            "        self.assertNotContains(response, \"Network to Code\", status_code=404)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(\"Hello world!\", response_content)",
            "",
            "    @override_settings(DEBUG=False)",
            "    @mock.patch(\"nautobot.core.views.HomeView.get\", side_effect=Exception)",
            "    def test_500_default_support_message(self, mock_get):",
            "        \"\"\"Nautobot's custom 500 page should be used and should include a default support message.\"\"\"",
            "        url = reverse(\"home\")",
            "        with self.assertTemplateUsed(\"500.html\"):",
            "            self.client.raise_request_exception = False",
            "            response = self.client.get(url)",
            "        self.assertContains(response, \"Network to Code\", status_code=500)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(",
            "            \"If further assistance is required, please join the <code>#nautobot</code> channel \"",
            "            'on <a href=\"https://slack.networktocode.com/\">Network to Code\\'s Slack community</a> '",
            "            \"and post your question.\",",
            "            response_content,",
            "        )",
            "",
            "    @override_settings(DEBUG=False, SUPPORT_MESSAGE=\"Hello world!\")",
            "    @mock.patch(\"nautobot.core.views.HomeView.get\", side_effect=Exception)",
            "    def test_500_custom_support_message(self, mock_get):",
            "        \"\"\"Nautobot's custom 500 page should be used and should include a default support message.\"\"\"",
            "        url = reverse(\"home\")",
            "        with self.assertTemplateUsed(\"500.html\"):",
            "            self.client.raise_request_exception = False",
            "            response = self.client.get(url)",
            "        self.assertNotContains(response, \"Network to Code\", status_code=500)",
            "        response_content = response.content.decode(response.charset)",
            "        self.assertInHTML(\"Hello world!\", response_content)",
            "",
            "",
            "class DBFileStorageViewTestCase(TestCase):",
            "    \"\"\"Test authentication/permission enforcement for django_db_file_storage views.\"\"\"",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.test_file_1 = SimpleUploadedFile(name=\"test_file_1.txt\", content=b\"I am content.\\n\")",
            "        self.file_proxy_1 = FileProxy.objects.create(name=self.test_file_1.name, file=self.test_file_1)",
            "        self.test_file_2 = SimpleUploadedFile(name=\"test_file_2.txt\", content=b\"I am content.\\n\")",
            "        self.file_proxy_2 = FileProxy.objects.create(name=self.test_file_2.name, file=self.test_file_2)",
            "        self.urls = [",
            "            f\"{reverse('db_file_storage.download_file')}?name={self.file_proxy_1.file.name}\",",
            "            f\"{reverse('db_file_storage.get_file')}?name={self.file_proxy_1.file.name}\",",
            "        ]",
            "",
            "    def test_get_file_anonymous(self):",
            "        self.client.logout()",
            "        for url in self.urls:",
            "            with self.subTest(url):",
            "                response = self.client.get(url)",
            "                self.assertHttpStatus(response, 403)",
            "",
            "    def test_get_file_without_permission(self):",
            "        for url in self.urls:",
            "            with self.subTest(url):",
            "                response = self.client.get(url)",
            "                self.assertHttpStatus(response, 403)",
            "",
            "    def test_get_object_with_permission(self):",
            "        self.add_permissions(get_permission_for_model(FileProxy, \"view\"))",
            "        for url in self.urls:",
            "            with self.subTest(url):",
            "                response = self.client.get(url)",
            "                self.assertHttpStatus(response, 200)",
            "",
            "    def test_get_object_with_constrained_permission(self):",
            "        obj_perm = ObjectPermission(",
            "            name=\"Test permission\",",
            "            constraints={\"pk\": self.file_proxy_1.pk},",
            "            actions=[\"view\"],",
            "        )",
            "        obj_perm.save()",
            "        obj_perm.users.add(self.user)",
            "        obj_perm.object_types.add(ContentType.objects.get_for_model(FileProxy))",
            "        for url in self.urls:",
            "            with self.subTest(url):",
            "                response = self.client.get(url)",
            "                self.assertHttpStatus(response, 200)",
            "        for url in [",
            "            f\"{reverse('db_file_storage.download_file')}?name={self.file_proxy_2.file.name}\",",
            "            f\"{reverse('db_file_storage.get_file')}?name={self.file_proxy_2.file.name}\",",
            "        ]:",
            "            with self.subTest(url):",
            "                response = self.client.get(url)",
            "                self.assertHttpStatus(response, 404)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "jwt.api_jwt"
        ]
    },
    "nautobot/core/urls.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from django.conf import settings"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from django.conf.urls import include"
            },
            "2": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 2,
                "PatchRowcode": "+from django.conf.urls import include, url"
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from django.urls import path"
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " from django.views.static import serve"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from nautobot.core.views import CustomGraphQLView, HomeView, StaticMediaFailureView, SearchView, nautobot_metrics_view"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from nautobot.core.views import ("
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+    CustomGraphQLView,"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+    HomeView,"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+    StaticMediaFailureView,"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+    SearchView,"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+    nautobot_metrics_view,"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+    get_file_with_authorization,"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+)"
            },
            "15": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from nautobot.extras.plugins.urls import ("
            },
            "16": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 15,
                "PatchRowcode": "     plugin_admin_patterns,"
            },
            "17": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 16,
                "PatchRowcode": "     plugin_patterns,"
            },
            "18": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "     # django-health-check"
            },
            "19": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "     path(r\"health/\", include(\"health_check.urls\")),"
            },
            "20": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "     # FileProxy attachments download/get URLs used in admin views only"
            },
            "21": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    path(\"files/\", include(\"db_file_storage.urls\")),"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+    url("
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+        \"files/download/\","
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+        get_file_with_authorization,"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+        {\"add_attachment_headers\": True},"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+        name=\"db_file_storage.download_file\","
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+    ),"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+    url("
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+        \"files/get/\","
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+        get_file_with_authorization,"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        {\"add_attachment_headers\": False},"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+        name=\"db_file_storage.get_file\","
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+    ),"
            },
            "34": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 67,
                "PatchRowcode": " ]"
            },
            "35": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 68,
                "PatchRowcode": " "
            },
            "36": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 69,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "from django.conf import settings",
            "from django.conf.urls import include",
            "from django.urls import path",
            "from django.views.static import serve",
            "",
            "from nautobot.core.views import CustomGraphQLView, HomeView, StaticMediaFailureView, SearchView, nautobot_metrics_view",
            "from nautobot.extras.plugins.urls import (",
            "    plugin_admin_patterns,",
            "    plugin_patterns,",
            ")",
            "from nautobot.users.views import LoginView, LogoutView",
            "from .admin import admin_site",
            "",
            "",
            "urlpatterns = [",
            "    # Base views",
            "    path(\"\", HomeView.as_view(), name=\"home\"),",
            "    path(\"search/\", SearchView.as_view(), name=\"search\"),",
            "    # Login/logout",
            "    path(\"login/\", LoginView.as_view(), name=\"login\"),",
            "    path(\"logout/\", LogoutView.as_view(), name=\"logout\"),",
            "    # Apps",
            "    path(\"circuits/\", include(\"nautobot.circuits.urls\")),",
            "    path(\"dcim/\", include(\"nautobot.dcim.urls\")),",
            "    path(\"extras/\", include(\"nautobot.extras.urls\")),",
            "    path(\"ipam/\", include(\"nautobot.ipam.urls\")),",
            "    path(\"tenancy/\", include(\"nautobot.tenancy.urls\")),",
            "    path(\"user/\", include(\"nautobot.users.urls\")),",
            "    path(\"virtualization/\", include(\"nautobot.virtualization.urls\")),",
            "    # API",
            "    path(\"api/\", include(\"nautobot.core.api.urls\")),",
            "    # GraphQL",
            "    path(\"graphql/\", CustomGraphQLView.as_view(graphiql=True), name=\"graphql\"),",
            "    # Serving static media in Django",
            "    path(\"media/<path:path>\", serve, {\"document_root\": settings.MEDIA_ROOT}),",
            "    # Admin",
            "    path(\"admin/\", admin_site.urls),",
            "    # Errors",
            "    path(\"media-failure/\", StaticMediaFailureView.as_view(), name=\"media_failure\"),",
            "    # Plugins",
            "    path(\"plugins/\", include((plugin_patterns, \"plugins\"))),",
            "    path(\"admin/plugins/\", include(plugin_admin_patterns)),",
            "    # Social auth/SSO",
            "    path(\"\", include(\"social_django.urls\", namespace=\"social\")),",
            "    # django-health-check",
            "    path(r\"health/\", include(\"health_check.urls\")),",
            "    # FileProxy attachments download/get URLs used in admin views only",
            "    path(\"files/\", include(\"db_file_storage.urls\")),",
            "]",
            "",
            "",
            "if settings.DEBUG:",
            "    try:",
            "        import debug_toolbar",
            "",
            "        urlpatterns += [",
            "            path(\"__debug__/\", include(debug_toolbar.urls)),",
            "        ]",
            "    except ImportError:",
            "        pass",
            "",
            "if settings.METRICS_ENABLED:",
            "    urlpatterns += [",
            "        path(\"metrics/\", nautobot_metrics_view, name=\"metrics\"),",
            "    ]",
            "",
            "handler404 = \"nautobot.core.views.resource_not_found\"",
            "handler500 = \"nautobot.core.views.server_error\""
        ],
        "afterPatchFile": [
            "from django.conf import settings",
            "from django.conf.urls import include, url",
            "from django.urls import path",
            "from django.views.static import serve",
            "",
            "from nautobot.core.views import (",
            "    CustomGraphQLView,",
            "    HomeView,",
            "    StaticMediaFailureView,",
            "    SearchView,",
            "    nautobot_metrics_view,",
            "    get_file_with_authorization,",
            ")",
            "from nautobot.extras.plugins.urls import (",
            "    plugin_admin_patterns,",
            "    plugin_patterns,",
            ")",
            "from nautobot.users.views import LoginView, LogoutView",
            "from .admin import admin_site",
            "",
            "",
            "urlpatterns = [",
            "    # Base views",
            "    path(\"\", HomeView.as_view(), name=\"home\"),",
            "    path(\"search/\", SearchView.as_view(), name=\"search\"),",
            "    # Login/logout",
            "    path(\"login/\", LoginView.as_view(), name=\"login\"),",
            "    path(\"logout/\", LogoutView.as_view(), name=\"logout\"),",
            "    # Apps",
            "    path(\"circuits/\", include(\"nautobot.circuits.urls\")),",
            "    path(\"dcim/\", include(\"nautobot.dcim.urls\")),",
            "    path(\"extras/\", include(\"nautobot.extras.urls\")),",
            "    path(\"ipam/\", include(\"nautobot.ipam.urls\")),",
            "    path(\"tenancy/\", include(\"nautobot.tenancy.urls\")),",
            "    path(\"user/\", include(\"nautobot.users.urls\")),",
            "    path(\"virtualization/\", include(\"nautobot.virtualization.urls\")),",
            "    # API",
            "    path(\"api/\", include(\"nautobot.core.api.urls\")),",
            "    # GraphQL",
            "    path(\"graphql/\", CustomGraphQLView.as_view(graphiql=True), name=\"graphql\"),",
            "    # Serving static media in Django",
            "    path(\"media/<path:path>\", serve, {\"document_root\": settings.MEDIA_ROOT}),",
            "    # Admin",
            "    path(\"admin/\", admin_site.urls),",
            "    # Errors",
            "    path(\"media-failure/\", StaticMediaFailureView.as_view(), name=\"media_failure\"),",
            "    # Plugins",
            "    path(\"plugins/\", include((plugin_patterns, \"plugins\"))),",
            "    path(\"admin/plugins/\", include(plugin_admin_patterns)),",
            "    # Social auth/SSO",
            "    path(\"\", include(\"social_django.urls\", namespace=\"social\")),",
            "    # django-health-check",
            "    path(r\"health/\", include(\"health_check.urls\")),",
            "    # FileProxy attachments download/get URLs used in admin views only",
            "    url(",
            "        \"files/download/\",",
            "        get_file_with_authorization,",
            "        {\"add_attachment_headers\": True},",
            "        name=\"db_file_storage.download_file\",",
            "    ),",
            "    url(",
            "        \"files/get/\",",
            "        get_file_with_authorization,",
            "        {\"add_attachment_headers\": False},",
            "        name=\"db_file_storage.get_file\",",
            "    ),",
            "]",
            "",
            "",
            "if settings.DEBUG:",
            "    try:",
            "        import debug_toolbar",
            "",
            "        urlpatterns += [",
            "            path(\"__debug__/\", include(debug_toolbar.urls)),",
            "        ]",
            "    except ImportError:",
            "        pass",
            "",
            "if settings.METRICS_ENABLED:",
            "    urlpatterns += [",
            "        path(\"metrics/\", nautobot_metrics_view, name=\"metrics\"),",
            "    ]",
            "",
            "handler404 = \"nautobot.core.views.resource_not_found\"",
            "handler500 = \"nautobot.core.views.server_error\""
        ],
        "action": [
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "2": [],
            "6": [],
            "48": []
        },
        "addLocation": []
    },
    "nautobot/core/views/__init__.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import sys"
            },
            "1": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import time"
            },
            "2": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from db_file_storage.views import get_file"
            },
            "4": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from django.apps import apps"
            },
            "5": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " import prometheus_client"
            },
            "6": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from django.conf import settings"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+from django.contrib.auth.decorators import permission_required"
            },
            "8": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from django.contrib.auth.mixins import AccessMixin"
            },
            "9": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from django.http import HttpResponseServerError, JsonResponse, HttpResponseForbidden, HttpResponse"
            },
            "10": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from django.shortcuts import redirect, render"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+from django.shortcuts import get_object_or_404, redirect, render"
            },
            "12": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from django.template import loader, RequestContext, Template"
            },
            "13": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from django.template.exceptions import TemplateDoesNotExist"
            },
            "14": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from django.urls import resolve, reverse"
            },
            "15": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " from nautobot.core.releases import get_latest_release"
            },
            "16": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " from nautobot.core.utils.config import get_settings_or_config"
            },
            "17": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 31,
                "PatchRowcode": " from nautobot.core.utils.lookup import get_route_for_model"
            },
            "18": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from nautobot.extras.models import GraphQLQuery"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+from nautobot.core.utils.permissions import get_permission_for_model"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+from nautobot.extras.models import GraphQLQuery, FileProxy"
            },
            "21": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " from nautobot.extras.registry import registry"
            },
            "22": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " from nautobot.extras.forms import GraphQLQueryForm"
            },
            "23": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": 294,
                "afterPatchRowNumber": 297,
                "PatchRowcode": "         pass"
            },
            "25": {
                "beforePatchRowNumber": 295,
                "afterPatchRowNumber": 298,
                "PatchRowcode": "     metrics_page = prometheus_client.generate_latest(prometheus_registry)"
            },
            "26": {
                "beforePatchRowNumber": 296,
                "afterPatchRowNumber": 299,
                "PatchRowcode": "     return HttpResponse(metrics_page, content_type=prometheus_client.CONTENT_TYPE_LATEST)"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 300,
                "PatchRowcode": "+"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 301,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 302,
                "PatchRowcode": "+@permission_required(get_permission_for_model(FileProxy, \"view\"), raise_exception=True)"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 303,
                "PatchRowcode": "+def get_file_with_authorization(request, *args, **kwargs):"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 304,
                "PatchRowcode": "+    \"\"\"Patch db_file_storage view with authentication.\"\"\""
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 305,
                "PatchRowcode": "+    # Make sure user has permissions"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 306,
                "PatchRowcode": "+    queryset = FileProxy.objects.restrict(request.user, \"view\")"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 307,
                "PatchRowcode": "+    get_object_or_404(queryset, file=request.GET.get(\"name\"))"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 308,
                "PatchRowcode": "+"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 309,
                "PatchRowcode": "+    return get_file(request, *args, **kwargs)"
            }
        },
        "frontPatchFile": [
            "import os",
            "import platform",
            "import sys",
            "import time",
            "",
            "from django.apps import apps",
            "import prometheus_client",
            "from django.conf import settings",
            "from django.contrib.auth.mixins import AccessMixin",
            "from django.http import HttpResponseServerError, JsonResponse, HttpResponseForbidden, HttpResponse",
            "from django.shortcuts import redirect, render",
            "from django.template import loader, RequestContext, Template",
            "from django.template.exceptions import TemplateDoesNotExist",
            "from django.urls import resolve, reverse",
            "from django.views.decorators.csrf import requires_csrf_token",
            "from django.views.defaults import ERROR_500_TEMPLATE_NAME, page_not_found",
            "from django.views.csrf import csrf_failure as _csrf_failure",
            "from django.views.generic import TemplateView, View",
            "from packaging import version",
            "from graphene_django.views import GraphQLView",
            "from prometheus_client import multiprocess",
            "from prometheus_client.metrics_core import GaugeMetricFamily",
            "from prometheus_client.registry import Collector",
            "",
            "from nautobot.core.constants import SEARCH_MAX_RESULTS",
            "from nautobot.core.forms import SearchForm",
            "from nautobot.core.releases import get_latest_release",
            "from nautobot.core.utils.config import get_settings_or_config",
            "from nautobot.core.utils.lookup import get_route_for_model",
            "from nautobot.extras.models import GraphQLQuery",
            "from nautobot.extras.registry import registry",
            "from nautobot.extras.forms import GraphQLQueryForm",
            "",
            "",
            "class HomeView(AccessMixin, TemplateView):",
            "    template_name = \"home.html\"",
            "    use_new_ui = True",
            "",
            "    def render_additional_content(self, request, context, details):",
            "        # Collect all custom data using callback functions.",
            "        for key, data in details.get(\"custom_data\", {}).items():",
            "            if callable(data):",
            "                context[key] = data(request)",
            "            else:",
            "                context[key] = data",
            "",
            "        # Create standalone template",
            "        path = f'{details[\"template_path\"]}{details[\"custom_template\"]}'",
            "        if os.path.isfile(path):",
            "            with open(path, \"r\") as f:",
            "                html = f.read()",
            "        else:",
            "            raise TemplateDoesNotExist(path)",
            "",
            "        template = Template(html)",
            "",
            "        additional_context = RequestContext(request, context)",
            "        return template.render(additional_context)",
            "",
            "    def get(self, request, *args, **kwargs):",
            "        # Redirect user to login page if not authenticated and HIDE_RESTRICTED_UI is set to True",
            "        if not request.user.is_authenticated and get_settings_or_config(\"HIDE_RESTRICTED_UI\"):",
            "            return self.handle_no_permission()",
            "        # Check whether a new release is available. (Only for staff/superusers.)",
            "        new_release = None",
            "        if request.user.is_staff or request.user.is_superuser:",
            "            latest_release, release_url = get_latest_release()",
            "            if isinstance(latest_release, version.Version):",
            "                current_version = version.parse(settings.VERSION)",
            "                if latest_release > current_version:",
            "                    new_release = {",
            "                        \"version\": str(latest_release),",
            "                        \"url\": release_url,",
            "                    }",
            "",
            "        context = self.get_context_data()",
            "        context.update(",
            "            {",
            "                \"search_form\": SearchForm(),",
            "                \"new_release\": new_release,",
            "            }",
            "        )",
            "",
            "        # Loop over homepage layout to collect all additional data and create custom panels.",
            "        for panel_details in registry[\"homepage_layout\"][\"panels\"].values():",
            "            if panel_details.get(\"custom_template\"):",
            "                panel_details[\"rendered_html\"] = self.render_additional_content(request, context, panel_details)",
            "",
            "            else:",
            "                for item_details in panel_details[\"items\"].values():",
            "                    if item_details.get(\"custom_template\"):",
            "                        item_details[\"rendered_html\"] = self.render_additional_content(request, context, item_details)",
            "",
            "                    elif item_details.get(\"model\"):",
            "                        # If there is a model attached collect object count.",
            "                        item_details[\"count\"] = item_details[\"model\"].objects.restrict(request.user, \"view\").count()",
            "",
            "                    elif item_details.get(\"items\"):",
            "                        # Collect count for grouped objects.",
            "                        for group_item_details in item_details[\"items\"].values():",
            "                            if group_item_details.get(\"custom_template\"):",
            "                                group_item_details[\"rendered_html\"] = self.render_additional_content(",
            "                                    request, context, group_item_details",
            "                                )",
            "                            elif group_item_details.get(\"model\"):",
            "                                group_item_details[\"count\"] = (",
            "                                    group_item_details[\"model\"].objects.restrict(request.user, \"view\").count()",
            "                                )",
            "",
            "        return self.render_to_response(context)",
            "",
            "",
            "class SearchView(AccessMixin, View):",
            "    def get(self, request):",
            "        # if user is not authenticated, redirect to login page",
            "        # when attempting to search",
            "        if not request.user.is_authenticated:",
            "            return self.handle_no_permission()",
            "",
            "        # No query",
            "        if \"q\" not in request.GET:",
            "            return render(",
            "                request,",
            "                \"search.html\",",
            "                {",
            "                    \"form\": SearchForm(),",
            "                },",
            "            )",
            "",
            "        form = SearchForm(request.GET)",
            "        results = []",
            "",
            "        if form.is_valid():",
            "            # Build the list of (app_label, modelname) tuples, representing all models included in the global search,",
            "            # based on the `app_config.searchable_models` list (if any) defined by each app",
            "            searchable_models = []",
            "            for app_config in apps.get_app_configs():",
            "                if hasattr(app_config, \"searchable_models\"):",
            "                    searchable_models += [(app_config.label, modelname) for modelname in app_config.searchable_models]",
            "",
            "            if form.cleaned_data[\"obj_type\"]:",
            "                # Searching for a single type of object",
            "                obj_types = [form.cleaned_data[\"obj_type\"]]",
            "            else:",
            "                # Searching all object types",
            "                obj_types = [model_info[1] for model_info in searchable_models]",
            "",
            "            for label, modelname in searchable_models:",
            "                if modelname not in obj_types:",
            "                    continue",
            "                # Based on the label and modelname, reverse-lookup the list URL, then the view or UIViewSet",
            "                # corresponding to that URL, and finally the queryset, filterset, and table classes needed",
            "                # to find and display the model search results.",
            "                url = get_route_for_model(f\"{label}.{modelname}\", \"list\")",
            "                view_func = resolve(reverse(url)).func",
            "                # For a UIViewSet, view_func.cls gets what we need; for an ObjectListView, view_func.view_class is it.",
            "                view_or_viewset = getattr(view_func, \"cls\", getattr(view_func, \"view_class\", None))",
            "                queryset = view_or_viewset.queryset.restrict(request.user, \"view\")",
            "                # For a UIViewSet, .filterset_class, for an ObjectListView, .filterset.",
            "                filterset = getattr(view_or_viewset, \"filterset_class\", getattr(view_or_viewset, \"filterset\", None))",
            "                # For a UIViewSet, .table_class, for an ObjectListView, .table.",
            "                table = getattr(view_or_viewset, \"table_class\", getattr(view_or_viewset, \"table\", None))",
            "",
            "                # Construct the results table for this object type",
            "                filtered_queryset = filterset({\"q\": form.cleaned_data[\"q\"]}, queryset=queryset).qs",
            "                table = table(filtered_queryset, orderable=False)",
            "                table.paginate(per_page=SEARCH_MAX_RESULTS)",
            "",
            "                if table.page:",
            "                    results.append(",
            "                        {",
            "                            \"name\": queryset.model._meta.verbose_name_plural,",
            "                            \"table\": table,",
            "                            \"url\": f\"{reverse(url)}?q={form.cleaned_data.get('q')}\",",
            "                        }",
            "                    )",
            "",
            "        return render(",
            "            request,",
            "            \"search.html\",",
            "            {",
            "                \"form\": form,",
            "                \"results\": results,",
            "            },",
            "        )",
            "",
            "",
            "class StaticMediaFailureView(View):",
            "    \"\"\"",
            "    Display a user-friendly error message with troubleshooting tips when a static media file fails to load.",
            "    \"\"\"",
            "",
            "    def get(self, request):",
            "        return render(request, \"media_failure.html\", {\"filename\": request.GET.get(\"filename\")})",
            "",
            "",
            "def resource_not_found(request, exception):",
            "    if request.path.startswith(\"/api/\"):",
            "        return JsonResponse({\"detail\": \"Not found.\"}, status=404)",
            "    else:",
            "        return page_not_found(request, exception, \"404.html\")",
            "",
            "",
            "@requires_csrf_token",
            "def server_error(request, template_name=ERROR_500_TEMPLATE_NAME):",
            "    \"\"\"",
            "    Custom 500 handler to provide additional context when rendering 500.html.",
            "    \"\"\"",
            "    try:",
            "        template = loader.get_template(template_name)",
            "    except TemplateDoesNotExist:",
            "        return HttpResponseServerError(\"<h1>Server Error (500)</h1>\", content_type=\"text/html\")",
            "    type_, error, _traceback = sys.exc_info()",
            "    context = {",
            "        \"error\": error,",
            "        \"exception\": str(type_),",
            "        \"nautobot_version\": settings.VERSION,",
            "        \"python_version\": platform.python_version(),",
            "    }",
            "",
            "    return HttpResponseServerError(template.render(context, request))",
            "",
            "",
            "def csrf_failure(request, reason=\"\", template_name=\"403_csrf_failure.html\"):",
            "    \"\"\"Custom 403 CSRF failure handler to account for additional context.",
            "",
            "    If Nautobot is set to DEBUG the default view for csrf_failure.",
            "    `403_csrf_failure.html` template name is used over `403_csrf.html` to account for",
            "    additional context that is required to render the inherited templates.",
            "    \"\"\"",
            "    if settings.DEBUG:",
            "        return _csrf_failure(request, reason=reason)",
            "    t = loader.get_template(template_name)",
            "    context = {",
            "        \"reason\": reason,",
            "        \"settings\": settings,",
            "        \"nautobot_version\": settings.VERSION,",
            "        \"python_version\": platform.python_version(),",
            "    }",
            "    return HttpResponseForbidden(t.render(context), content_type=\"text/html\")",
            "",
            "",
            "class CustomGraphQLView(GraphQLView):",
            "    def render_graphiql(self, request, **data):",
            "        if not request.user.is_authenticated and get_settings_or_config(\"HIDE_RESTRICTED_UI\"):",
            "            graphql_url = reverse(\"graphql\")",
            "            login_url = reverse(settings.LOGIN_URL)",
            "            return redirect(f\"{login_url}?next={graphql_url}\")",
            "        query_name = request.GET.get(\"name\")",
            "        if query_name:",
            "            data[\"obj\"] = GraphQLQuery.objects.get(name=query_name)",
            "            data[\"editing\"] = True",
            "        data[\"saved_graphiql_queries\"] = GraphQLQuery.objects.all()",
            "        data[\"form\"] = GraphQLQueryForm",
            "        return render(request, self.graphiql_template, data)",
            "",
            "",
            "class NautobotAppMetricsCollector(Collector):",
            "    \"\"\"Custom Nautobot metrics collector.",
            "",
            "    Metric collector that reads from registry[\"plugin_metrics\"] and yields any metrics registered there.\"\"\"",
            "",
            "    def collect(self):",
            "        \"\"\"Collect metrics from plugins.\"\"\"",
            "        start = time.time()",
            "        for metric_generator in registry[\"app_metrics\"]:",
            "            yield from metric_generator()",
            "        gauge = GaugeMetricFamily(\"nautobot_app_metrics_processing_ms\", \"Time in ms to generate the app metrics\")",
            "        duration = time.time() - start",
            "        gauge.add_metric([], format(duration * 1000, \".5f\"))",
            "        yield gauge",
            "",
            "",
            "def nautobot_metrics_view(request):",
            "    \"\"\"Exports /metrics.",
            "",
            "    This overwrites the default django_prometheus view to inject metrics from Nautobot apps.",
            "",
            "    Note that we cannot use `prometheus_django.ExportToDjangoView`, as that is a simple function, and we need access to",
            "    the `prometheus_registry` variable that is defined inside of it.\"\"\"",
            "    if \"PROMETHEUS_MULTIPROC_DIR\" in os.environ or \"prometheus_multiproc_dir\" in os.environ:",
            "        prometheus_registry = prometheus_client.CollectorRegistry()",
            "        multiprocess.MultiProcessCollector(prometheus_registry)",
            "    else:",
            "        prometheus_registry = prometheus_client.REGISTRY",
            "    # Instantiate and register the collector. Note that this has to be done every time this view is accessed, because",
            "    # the registry for multiprocess metrics is also instantiated every time this view is accessed. As a result, the",
            "    # same goes for the registration of the collector to the registry.",
            "    try:",
            "        nb_app_collector = NautobotAppMetricsCollector()",
            "        prometheus_registry.register(nb_app_collector)",
            "    except ValueError:",
            "        # Collector already registered, we are running without multiprocessing",
            "        pass",
            "    metrics_page = prometheus_client.generate_latest(prometheus_registry)",
            "    return HttpResponse(metrics_page, content_type=prometheus_client.CONTENT_TYPE_LATEST)"
        ],
        "afterPatchFile": [
            "import os",
            "import platform",
            "import sys",
            "import time",
            "",
            "from db_file_storage.views import get_file",
            "from django.apps import apps",
            "import prometheus_client",
            "from django.conf import settings",
            "from django.contrib.auth.decorators import permission_required",
            "from django.contrib.auth.mixins import AccessMixin",
            "from django.http import HttpResponseServerError, JsonResponse, HttpResponseForbidden, HttpResponse",
            "from django.shortcuts import get_object_or_404, redirect, render",
            "from django.template import loader, RequestContext, Template",
            "from django.template.exceptions import TemplateDoesNotExist",
            "from django.urls import resolve, reverse",
            "from django.views.decorators.csrf import requires_csrf_token",
            "from django.views.defaults import ERROR_500_TEMPLATE_NAME, page_not_found",
            "from django.views.csrf import csrf_failure as _csrf_failure",
            "from django.views.generic import TemplateView, View",
            "from packaging import version",
            "from graphene_django.views import GraphQLView",
            "from prometheus_client import multiprocess",
            "from prometheus_client.metrics_core import GaugeMetricFamily",
            "from prometheus_client.registry import Collector",
            "",
            "from nautobot.core.constants import SEARCH_MAX_RESULTS",
            "from nautobot.core.forms import SearchForm",
            "from nautobot.core.releases import get_latest_release",
            "from nautobot.core.utils.config import get_settings_or_config",
            "from nautobot.core.utils.lookup import get_route_for_model",
            "from nautobot.core.utils.permissions import get_permission_for_model",
            "from nautobot.extras.models import GraphQLQuery, FileProxy",
            "from nautobot.extras.registry import registry",
            "from nautobot.extras.forms import GraphQLQueryForm",
            "",
            "",
            "class HomeView(AccessMixin, TemplateView):",
            "    template_name = \"home.html\"",
            "    use_new_ui = True",
            "",
            "    def render_additional_content(self, request, context, details):",
            "        # Collect all custom data using callback functions.",
            "        for key, data in details.get(\"custom_data\", {}).items():",
            "            if callable(data):",
            "                context[key] = data(request)",
            "            else:",
            "                context[key] = data",
            "",
            "        # Create standalone template",
            "        path = f'{details[\"template_path\"]}{details[\"custom_template\"]}'",
            "        if os.path.isfile(path):",
            "            with open(path, \"r\") as f:",
            "                html = f.read()",
            "        else:",
            "            raise TemplateDoesNotExist(path)",
            "",
            "        template = Template(html)",
            "",
            "        additional_context = RequestContext(request, context)",
            "        return template.render(additional_context)",
            "",
            "    def get(self, request, *args, **kwargs):",
            "        # Redirect user to login page if not authenticated and HIDE_RESTRICTED_UI is set to True",
            "        if not request.user.is_authenticated and get_settings_or_config(\"HIDE_RESTRICTED_UI\"):",
            "            return self.handle_no_permission()",
            "        # Check whether a new release is available. (Only for staff/superusers.)",
            "        new_release = None",
            "        if request.user.is_staff or request.user.is_superuser:",
            "            latest_release, release_url = get_latest_release()",
            "            if isinstance(latest_release, version.Version):",
            "                current_version = version.parse(settings.VERSION)",
            "                if latest_release > current_version:",
            "                    new_release = {",
            "                        \"version\": str(latest_release),",
            "                        \"url\": release_url,",
            "                    }",
            "",
            "        context = self.get_context_data()",
            "        context.update(",
            "            {",
            "                \"search_form\": SearchForm(),",
            "                \"new_release\": new_release,",
            "            }",
            "        )",
            "",
            "        # Loop over homepage layout to collect all additional data and create custom panels.",
            "        for panel_details in registry[\"homepage_layout\"][\"panels\"].values():",
            "            if panel_details.get(\"custom_template\"):",
            "                panel_details[\"rendered_html\"] = self.render_additional_content(request, context, panel_details)",
            "",
            "            else:",
            "                for item_details in panel_details[\"items\"].values():",
            "                    if item_details.get(\"custom_template\"):",
            "                        item_details[\"rendered_html\"] = self.render_additional_content(request, context, item_details)",
            "",
            "                    elif item_details.get(\"model\"):",
            "                        # If there is a model attached collect object count.",
            "                        item_details[\"count\"] = item_details[\"model\"].objects.restrict(request.user, \"view\").count()",
            "",
            "                    elif item_details.get(\"items\"):",
            "                        # Collect count for grouped objects.",
            "                        for group_item_details in item_details[\"items\"].values():",
            "                            if group_item_details.get(\"custom_template\"):",
            "                                group_item_details[\"rendered_html\"] = self.render_additional_content(",
            "                                    request, context, group_item_details",
            "                                )",
            "                            elif group_item_details.get(\"model\"):",
            "                                group_item_details[\"count\"] = (",
            "                                    group_item_details[\"model\"].objects.restrict(request.user, \"view\").count()",
            "                                )",
            "",
            "        return self.render_to_response(context)",
            "",
            "",
            "class SearchView(AccessMixin, View):",
            "    def get(self, request):",
            "        # if user is not authenticated, redirect to login page",
            "        # when attempting to search",
            "        if not request.user.is_authenticated:",
            "            return self.handle_no_permission()",
            "",
            "        # No query",
            "        if \"q\" not in request.GET:",
            "            return render(",
            "                request,",
            "                \"search.html\",",
            "                {",
            "                    \"form\": SearchForm(),",
            "                },",
            "            )",
            "",
            "        form = SearchForm(request.GET)",
            "        results = []",
            "",
            "        if form.is_valid():",
            "            # Build the list of (app_label, modelname) tuples, representing all models included in the global search,",
            "            # based on the `app_config.searchable_models` list (if any) defined by each app",
            "            searchable_models = []",
            "            for app_config in apps.get_app_configs():",
            "                if hasattr(app_config, \"searchable_models\"):",
            "                    searchable_models += [(app_config.label, modelname) for modelname in app_config.searchable_models]",
            "",
            "            if form.cleaned_data[\"obj_type\"]:",
            "                # Searching for a single type of object",
            "                obj_types = [form.cleaned_data[\"obj_type\"]]",
            "            else:",
            "                # Searching all object types",
            "                obj_types = [model_info[1] for model_info in searchable_models]",
            "",
            "            for label, modelname in searchable_models:",
            "                if modelname not in obj_types:",
            "                    continue",
            "                # Based on the label and modelname, reverse-lookup the list URL, then the view or UIViewSet",
            "                # corresponding to that URL, and finally the queryset, filterset, and table classes needed",
            "                # to find and display the model search results.",
            "                url = get_route_for_model(f\"{label}.{modelname}\", \"list\")",
            "                view_func = resolve(reverse(url)).func",
            "                # For a UIViewSet, view_func.cls gets what we need; for an ObjectListView, view_func.view_class is it.",
            "                view_or_viewset = getattr(view_func, \"cls\", getattr(view_func, \"view_class\", None))",
            "                queryset = view_or_viewset.queryset.restrict(request.user, \"view\")",
            "                # For a UIViewSet, .filterset_class, for an ObjectListView, .filterset.",
            "                filterset = getattr(view_or_viewset, \"filterset_class\", getattr(view_or_viewset, \"filterset\", None))",
            "                # For a UIViewSet, .table_class, for an ObjectListView, .table.",
            "                table = getattr(view_or_viewset, \"table_class\", getattr(view_or_viewset, \"table\", None))",
            "",
            "                # Construct the results table for this object type",
            "                filtered_queryset = filterset({\"q\": form.cleaned_data[\"q\"]}, queryset=queryset).qs",
            "                table = table(filtered_queryset, orderable=False)",
            "                table.paginate(per_page=SEARCH_MAX_RESULTS)",
            "",
            "                if table.page:",
            "                    results.append(",
            "                        {",
            "                            \"name\": queryset.model._meta.verbose_name_plural,",
            "                            \"table\": table,",
            "                            \"url\": f\"{reverse(url)}?q={form.cleaned_data.get('q')}\",",
            "                        }",
            "                    )",
            "",
            "        return render(",
            "            request,",
            "            \"search.html\",",
            "            {",
            "                \"form\": form,",
            "                \"results\": results,",
            "            },",
            "        )",
            "",
            "",
            "class StaticMediaFailureView(View):",
            "    \"\"\"",
            "    Display a user-friendly error message with troubleshooting tips when a static media file fails to load.",
            "    \"\"\"",
            "",
            "    def get(self, request):",
            "        return render(request, \"media_failure.html\", {\"filename\": request.GET.get(\"filename\")})",
            "",
            "",
            "def resource_not_found(request, exception):",
            "    if request.path.startswith(\"/api/\"):",
            "        return JsonResponse({\"detail\": \"Not found.\"}, status=404)",
            "    else:",
            "        return page_not_found(request, exception, \"404.html\")",
            "",
            "",
            "@requires_csrf_token",
            "def server_error(request, template_name=ERROR_500_TEMPLATE_NAME):",
            "    \"\"\"",
            "    Custom 500 handler to provide additional context when rendering 500.html.",
            "    \"\"\"",
            "    try:",
            "        template = loader.get_template(template_name)",
            "    except TemplateDoesNotExist:",
            "        return HttpResponseServerError(\"<h1>Server Error (500)</h1>\", content_type=\"text/html\")",
            "    type_, error, _traceback = sys.exc_info()",
            "    context = {",
            "        \"error\": error,",
            "        \"exception\": str(type_),",
            "        \"nautobot_version\": settings.VERSION,",
            "        \"python_version\": platform.python_version(),",
            "    }",
            "",
            "    return HttpResponseServerError(template.render(context, request))",
            "",
            "",
            "def csrf_failure(request, reason=\"\", template_name=\"403_csrf_failure.html\"):",
            "    \"\"\"Custom 403 CSRF failure handler to account for additional context.",
            "",
            "    If Nautobot is set to DEBUG the default view for csrf_failure.",
            "    `403_csrf_failure.html` template name is used over `403_csrf.html` to account for",
            "    additional context that is required to render the inherited templates.",
            "    \"\"\"",
            "    if settings.DEBUG:",
            "        return _csrf_failure(request, reason=reason)",
            "    t = loader.get_template(template_name)",
            "    context = {",
            "        \"reason\": reason,",
            "        \"settings\": settings,",
            "        \"nautobot_version\": settings.VERSION,",
            "        \"python_version\": platform.python_version(),",
            "    }",
            "    return HttpResponseForbidden(t.render(context), content_type=\"text/html\")",
            "",
            "",
            "class CustomGraphQLView(GraphQLView):",
            "    def render_graphiql(self, request, **data):",
            "        if not request.user.is_authenticated and get_settings_or_config(\"HIDE_RESTRICTED_UI\"):",
            "            graphql_url = reverse(\"graphql\")",
            "            login_url = reverse(settings.LOGIN_URL)",
            "            return redirect(f\"{login_url}?next={graphql_url}\")",
            "        query_name = request.GET.get(\"name\")",
            "        if query_name:",
            "            data[\"obj\"] = GraphQLQuery.objects.get(name=query_name)",
            "            data[\"editing\"] = True",
            "        data[\"saved_graphiql_queries\"] = GraphQLQuery.objects.all()",
            "        data[\"form\"] = GraphQLQueryForm",
            "        return render(request, self.graphiql_template, data)",
            "",
            "",
            "class NautobotAppMetricsCollector(Collector):",
            "    \"\"\"Custom Nautobot metrics collector.",
            "",
            "    Metric collector that reads from registry[\"plugin_metrics\"] and yields any metrics registered there.\"\"\"",
            "",
            "    def collect(self):",
            "        \"\"\"Collect metrics from plugins.\"\"\"",
            "        start = time.time()",
            "        for metric_generator in registry[\"app_metrics\"]:",
            "            yield from metric_generator()",
            "        gauge = GaugeMetricFamily(\"nautobot_app_metrics_processing_ms\", \"Time in ms to generate the app metrics\")",
            "        duration = time.time() - start",
            "        gauge.add_metric([], format(duration * 1000, \".5f\"))",
            "        yield gauge",
            "",
            "",
            "def nautobot_metrics_view(request):",
            "    \"\"\"Exports /metrics.",
            "",
            "    This overwrites the default django_prometheus view to inject metrics from Nautobot apps.",
            "",
            "    Note that we cannot use `prometheus_django.ExportToDjangoView`, as that is a simple function, and we need access to",
            "    the `prometheus_registry` variable that is defined inside of it.\"\"\"",
            "    if \"PROMETHEUS_MULTIPROC_DIR\" in os.environ or \"prometheus_multiproc_dir\" in os.environ:",
            "        prometheus_registry = prometheus_client.CollectorRegistry()",
            "        multiprocess.MultiProcessCollector(prometheus_registry)",
            "    else:",
            "        prometheus_registry = prometheus_client.REGISTRY",
            "    # Instantiate and register the collector. Note that this has to be done every time this view is accessed, because",
            "    # the registry for multiprocess metrics is also instantiated every time this view is accessed. As a result, the",
            "    # same goes for the registration of the collector to the registry.",
            "    try:",
            "        nb_app_collector = NautobotAppMetricsCollector()",
            "        prometheus_registry.register(nb_app_collector)",
            "    except ValueError:",
            "        # Collector already registered, we are running without multiprocessing",
            "        pass",
            "    metrics_page = prometheus_client.generate_latest(prometheus_registry)",
            "    return HttpResponse(metrics_page, content_type=prometheus_client.CONTENT_TYPE_LATEST)",
            "",
            "",
            "@permission_required(get_permission_for_model(FileProxy, \"view\"), raise_exception=True)",
            "def get_file_with_authorization(request, *args, **kwargs):",
            "    \"\"\"Patch db_file_storage view with authentication.\"\"\"",
            "    # Make sure user has permissions",
            "    queryset = FileProxy.objects.restrict(request.user, \"view\")",
            "    get_object_or_404(queryset, file=request.GET.get(\"name\"))",
            "",
            "    return get_file(request, *args, **kwargs)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "11": [],
            "30": []
        },
        "addLocation": []
    }
}