{
    "wagtail/contrib/forms/forms.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from collections import OrderedDict"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import django.forms"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from django.conf import settings"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+from django.utils.html import conditional_escape"
            },
            "5": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from django.utils.translation import gettext_lazy as _"
            },
            "6": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from wagtail.admin.forms import WagtailAdminPageForm"
            },
            "8": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 116,
                "PatchRowcode": "     def get_field_options(self, field):"
            },
            "9": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "         options = {}"
            },
            "10": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 118,
                "PatchRowcode": "         options['label'] = field.label"
            },
            "11": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        options['help_text'] = field.help_text"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+        if getattr(settings, 'WAGTAILFORMS_HELP_TEXT_ALLOW_HTML', False):"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 120,
                "PatchRowcode": "+            options['help_text'] = field.help_text"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+        else:"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+            options['help_text'] = conditional_escape(field.help_text)"
            },
            "16": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "         options['required'] = field.required"
            },
            "17": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "         options['initial'] = field.default_value"
            },
            "18": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 125,
                "PatchRowcode": "         return options"
            }
        },
        "frontPatchFile": [
            "from collections import OrderedDict",
            "",
            "import django.forms",
            "from django.utils.translation import gettext_lazy as _",
            "",
            "from wagtail.admin.forms import WagtailAdminPageForm",
            "from wagtail.contrib.forms.utils import get_field_clean_name",
            "",
            "",
            "class BaseForm(django.forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        kwargs.setdefault('label_suffix', '')",
            "",
            "        self.user = kwargs.pop('user', None)",
            "        self.page = kwargs.pop('page', None)",
            "",
            "        super().__init__(*args, **kwargs)",
            "",
            "",
            "class FormBuilder:",
            "    def __init__(self, fields):",
            "        self.fields = fields",
            "",
            "    def create_singleline_field(self, field, options):",
            "        # TODO: This is a default value - it may need to be changed",
            "        options['max_length'] = 255",
            "        return django.forms.CharField(**options)",
            "",
            "    def create_multiline_field(self, field, options):",
            "        return django.forms.CharField(widget=django.forms.Textarea, **options)",
            "",
            "    def create_date_field(self, field, options):",
            "        return django.forms.DateField(**options)",
            "",
            "    def create_datetime_field(self, field, options):",
            "        return django.forms.DateTimeField(**options)",
            "",
            "    def create_email_field(self, field, options):",
            "        return django.forms.EmailField(**options)",
            "",
            "    def create_url_field(self, field, options):",
            "        return django.forms.URLField(**options)",
            "",
            "    def create_number_field(self, field, options):",
            "        return django.forms.DecimalField(**options)",
            "",
            "    def create_dropdown_field(self, field, options):",
            "        options['choices'] = map(",
            "            lambda x: (x.strip(), x.strip()),",
            "            field.choices.split(',')",
            "        )",
            "        return django.forms.ChoiceField(**options)",
            "",
            "    def create_multiselect_field(self, field, options):",
            "        options['choices'] = map(",
            "            lambda x: (x.strip(), x.strip()),",
            "            field.choices.split(',')",
            "        )",
            "        return django.forms.MultipleChoiceField(**options)",
            "",
            "    def create_radio_field(self, field, options):",
            "        options['choices'] = map(",
            "            lambda x: (x.strip(), x.strip()),",
            "            field.choices.split(',')",
            "        )",
            "        return django.forms.ChoiceField(widget=django.forms.RadioSelect, **options)",
            "",
            "    def create_checkboxes_field(self, field, options):",
            "        options['choices'] = [(x.strip(), x.strip()) for x in field.choices.split(',')]",
            "        options['initial'] = [x.strip() for x in field.default_value.split(',')]",
            "        return django.forms.MultipleChoiceField(",
            "            widget=django.forms.CheckboxSelectMultiple, **options",
            "        )",
            "",
            "    def create_checkbox_field(self, field, options):",
            "        return django.forms.BooleanField(**options)",
            "",
            "    def create_hidden_field(self, field, options):",
            "        return django.forms.CharField(widget=django.forms.HiddenInput, **options)",
            "",
            "    def get_create_field_function(self, type):",
            "        \"\"\"",
            "            Takes string of field type and returns a Django Form Field Instance.",
            "            Assumes form field creation functions are in the format:",
            "            'create_fieldtype_field'",
            "        \"\"\"",
            "        create_field_function = getattr(self, 'create_%s_field' % type, None)",
            "        if create_field_function:",
            "            return create_field_function",
            "        else:",
            "            import inspect",
            "            method_list = [",
            "                f[0] for f in",
            "                inspect.getmembers(self.__class__, inspect.isfunction)",
            "                if f[0].startswith('create_') and f[0].endswith('_field')",
            "            ]",
            "            raise AttributeError(",
            "                \"Could not find function matching format \\",
            "                create_<fieldname>_field for type: \" + type,",
            "                \"Must be one of: \" + \", \".join(method_list)",
            "            )",
            "",
            "    @property",
            "    def formfields(self):",
            "        formfields = OrderedDict()",
            "",
            "        for field in self.fields:",
            "            options = self.get_field_options(field)",
            "            create_field = self.get_create_field_function(field.field_type)",
            "            formfields[field.clean_name] = create_field(field, options)",
            "",
            "        return formfields",
            "",
            "    def get_field_options(self, field):",
            "        options = {}",
            "        options['label'] = field.label",
            "        options['help_text'] = field.help_text",
            "        options['required'] = field.required",
            "        options['initial'] = field.default_value",
            "        return options",
            "",
            "    def get_form_class(self):",
            "        return type(str('WagtailForm'), (BaseForm,), self.formfields)",
            "",
            "",
            "class SelectDateForm(django.forms.Form):",
            "    date_from = django.forms.DateTimeField(",
            "        required=False,",
            "        widget=django.forms.DateInput(attrs={'placeholder': _('Date from')})",
            "    )",
            "    date_to = django.forms.DateTimeField(",
            "        required=False,",
            "        widget=django.forms.DateInput(attrs={'placeholder': _('Date to')})",
            "    )",
            "",
            "",
            "class WagtailAdminFormPageForm(WagtailAdminPageForm):",
            "",
            "    def clean(self):",
            "",
            "        super().clean()",
            "",
            "        # Check for dupe form field labels - fixes #585",
            "        if 'form_fields' in self.formsets:",
            "            _forms = self.formsets['form_fields'].forms",
            "            for f in _forms:",
            "                f.is_valid()",
            "",
            "            for i, form in enumerate(_forms):",
            "                if 'label' in form.changed_data:",
            "                    label = form.cleaned_data.get('label')",
            "                    clean_name = get_field_clean_name(label)",
            "                    for idx, ff in enumerate(_forms):",
            "                        # Exclude self",
            "                        ff_clean_name = get_field_clean_name(ff.cleaned_data.get('label'))",
            "                        if idx != i and clean_name == ff_clean_name:",
            "                            form.add_error(",
            "                                'label',",
            "                                django.forms.ValidationError(_('There is another field with the label %s, please change one of them.' % label))",
            "                            )"
        ],
        "afterPatchFile": [
            "from collections import OrderedDict",
            "",
            "import django.forms",
            "from django.conf import settings",
            "from django.utils.html import conditional_escape",
            "from django.utils.translation import gettext_lazy as _",
            "",
            "from wagtail.admin.forms import WagtailAdminPageForm",
            "from wagtail.contrib.forms.utils import get_field_clean_name",
            "",
            "",
            "class BaseForm(django.forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        kwargs.setdefault('label_suffix', '')",
            "",
            "        self.user = kwargs.pop('user', None)",
            "        self.page = kwargs.pop('page', None)",
            "",
            "        super().__init__(*args, **kwargs)",
            "",
            "",
            "class FormBuilder:",
            "    def __init__(self, fields):",
            "        self.fields = fields",
            "",
            "    def create_singleline_field(self, field, options):",
            "        # TODO: This is a default value - it may need to be changed",
            "        options['max_length'] = 255",
            "        return django.forms.CharField(**options)",
            "",
            "    def create_multiline_field(self, field, options):",
            "        return django.forms.CharField(widget=django.forms.Textarea, **options)",
            "",
            "    def create_date_field(self, field, options):",
            "        return django.forms.DateField(**options)",
            "",
            "    def create_datetime_field(self, field, options):",
            "        return django.forms.DateTimeField(**options)",
            "",
            "    def create_email_field(self, field, options):",
            "        return django.forms.EmailField(**options)",
            "",
            "    def create_url_field(self, field, options):",
            "        return django.forms.URLField(**options)",
            "",
            "    def create_number_field(self, field, options):",
            "        return django.forms.DecimalField(**options)",
            "",
            "    def create_dropdown_field(self, field, options):",
            "        options['choices'] = map(",
            "            lambda x: (x.strip(), x.strip()),",
            "            field.choices.split(',')",
            "        )",
            "        return django.forms.ChoiceField(**options)",
            "",
            "    def create_multiselect_field(self, field, options):",
            "        options['choices'] = map(",
            "            lambda x: (x.strip(), x.strip()),",
            "            field.choices.split(',')",
            "        )",
            "        return django.forms.MultipleChoiceField(**options)",
            "",
            "    def create_radio_field(self, field, options):",
            "        options['choices'] = map(",
            "            lambda x: (x.strip(), x.strip()),",
            "            field.choices.split(',')",
            "        )",
            "        return django.forms.ChoiceField(widget=django.forms.RadioSelect, **options)",
            "",
            "    def create_checkboxes_field(self, field, options):",
            "        options['choices'] = [(x.strip(), x.strip()) for x in field.choices.split(',')]",
            "        options['initial'] = [x.strip() for x in field.default_value.split(',')]",
            "        return django.forms.MultipleChoiceField(",
            "            widget=django.forms.CheckboxSelectMultiple, **options",
            "        )",
            "",
            "    def create_checkbox_field(self, field, options):",
            "        return django.forms.BooleanField(**options)",
            "",
            "    def create_hidden_field(self, field, options):",
            "        return django.forms.CharField(widget=django.forms.HiddenInput, **options)",
            "",
            "    def get_create_field_function(self, type):",
            "        \"\"\"",
            "            Takes string of field type and returns a Django Form Field Instance.",
            "            Assumes form field creation functions are in the format:",
            "            'create_fieldtype_field'",
            "        \"\"\"",
            "        create_field_function = getattr(self, 'create_%s_field' % type, None)",
            "        if create_field_function:",
            "            return create_field_function",
            "        else:",
            "            import inspect",
            "            method_list = [",
            "                f[0] for f in",
            "                inspect.getmembers(self.__class__, inspect.isfunction)",
            "                if f[0].startswith('create_') and f[0].endswith('_field')",
            "            ]",
            "            raise AttributeError(",
            "                \"Could not find function matching format \\",
            "                create_<fieldname>_field for type: \" + type,",
            "                \"Must be one of: \" + \", \".join(method_list)",
            "            )",
            "",
            "    @property",
            "    def formfields(self):",
            "        formfields = OrderedDict()",
            "",
            "        for field in self.fields:",
            "            options = self.get_field_options(field)",
            "            create_field = self.get_create_field_function(field.field_type)",
            "            formfields[field.clean_name] = create_field(field, options)",
            "",
            "        return formfields",
            "",
            "    def get_field_options(self, field):",
            "        options = {}",
            "        options['label'] = field.label",
            "        if getattr(settings, 'WAGTAILFORMS_HELP_TEXT_ALLOW_HTML', False):",
            "            options['help_text'] = field.help_text",
            "        else:",
            "            options['help_text'] = conditional_escape(field.help_text)",
            "        options['required'] = field.required",
            "        options['initial'] = field.default_value",
            "        return options",
            "",
            "    def get_form_class(self):",
            "        return type(str('WagtailForm'), (BaseForm,), self.formfields)",
            "",
            "",
            "class SelectDateForm(django.forms.Form):",
            "    date_from = django.forms.DateTimeField(",
            "        required=False,",
            "        widget=django.forms.DateInput(attrs={'placeholder': _('Date from')})",
            "    )",
            "    date_to = django.forms.DateTimeField(",
            "        required=False,",
            "        widget=django.forms.DateInput(attrs={'placeholder': _('Date to')})",
            "    )",
            "",
            "",
            "class WagtailAdminFormPageForm(WagtailAdminPageForm):",
            "",
            "    def clean(self):",
            "",
            "        super().clean()",
            "",
            "        # Check for dupe form field labels - fixes #585",
            "        if 'form_fields' in self.formsets:",
            "            _forms = self.formsets['form_fields'].forms",
            "            for f in _forms:",
            "                f.is_valid()",
            "",
            "            for i, form in enumerate(_forms):",
            "                if 'label' in form.changed_data:",
            "                    label = form.cleaned_data.get('label')",
            "                    clean_name = get_field_clean_name(label)",
            "                    for idx, ff in enumerate(_forms):",
            "                        # Exclude self",
            "                        ff_clean_name = get_field_clean_name(ff.cleaned_data.get('label'))",
            "                        if idx != i and clean_name == ff_clean_name:",
            "                            form.add_error(",
            "                                'label',",
            "                                django.forms.ValidationError(_('There is another field with the label %s, please change one of them.' % label))",
            "                            )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "117": [
                "FormBuilder",
                "get_field_options"
            ]
        },
        "addLocation": []
    },
    "wagtail/contrib/forms/tests/test_models.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": "         self.assertTemplateUsed(response, 'tests/form_page.html')"
            },
            "1": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "         self.assertTemplateNotUsed(response, 'tests/form_page_landing.html')"
            },
            "2": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+        # HTML in help text should be escaped"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+        self.assertContains(response, \"&lt;em&gt;please&lt;/em&gt; be polite\")"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+"
            },
            "6": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "         # check that variables defined in get_context are passed through to the template (#1429)"
            },
            "7": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "         self.assertContains(response, \"<p>hello world</p>\")"
            },
            "8": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+    @override_settings(WAGTAILFORMS_HELP_TEXT_ALLOW_HTML=True)"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+    def test_get_form_without_help_text_escaping(self):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+        response = self.client.get('/contact-us/')"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+        # HTML in help text should not be escaped"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+        self.assertContains(response, \"<em>please</em> be polite\")"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+"
            },
            "15": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "     def test_post_invalid_form(self):"
            },
            "16": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "         response = self.client.post('/contact-us/', {"
            },
            "17": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "             'your_email': 'bob',"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import json",
            "",
            "from django.core import mail",
            "from django.core.checks import Info",
            "from django.test import TestCase, override_settings",
            "",
            "from wagtail.contrib.forms.models import FormSubmission",
            "from wagtail.contrib.forms.tests.utils import (",
            "    make_form_page, make_form_page_with_custom_submission, make_form_page_with_redirect,",
            "    make_types_test_form_page)",
            "from wagtail.core.models import Page",
            "from wagtail.tests.testapp.models import (",
            "    CustomFormPageSubmission, ExtendedFormField, FormField, FormFieldWithCustomSubmission,",
            "    FormPageWithCustomFormBuilder, JadeFormPage)",
            "from wagtail.tests.utils import WagtailTestUtils",
            "",
            "",
            "class TestFormSubmission(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page()",
            "",
            "    def test_get_form(self):",
            "        response = self.client.get('/contact-us/')",
            "",
            "        # Check response",
            "        self.assertContains(response, \"\"\"<label for=\"id_your_email\">Your email</label>\"\"\")",
            "        self.assertTemplateUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "    def test_post_invalid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob',",
            "            'your_message': 'hello world',",
            "            'your_choices': ''",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Enter a valid email address.\")",
            "        self.assertTemplateUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_landing.html')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # check the default form_submission is added to the context",
            "        self.assertContains(response, \"<li>your_email: bob@example.com</li>\")",
            "",
            "        # Check that an email was sent",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].to, ['to@email.com'])",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(FormSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "    def test_post_unicode_characters(self):",
            "        self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your message: \u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c\", mail.outbox[0].body)",
            "",
            "        # Check the form submission",
            "        submission = FormSubmission.objects.get()",
            "        submission_data = json.loads(submission.form_data)",
            "        self.assertEqual(submission_data['your_message'], '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c')",
            "",
            "    def test_post_multiple_values(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': 'on', 'bar': 'on', 'baz': 'on'}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # Check that the three checkbox values were saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        submission = FormSubmission.objects.filter(",
            "            page=form_page, form_data__contains='hello world'",
            "        )",
            "        self.assertIn(\"foo\", submission[0].form_data)",
            "        self.assertIn(\"bar\", submission[0].form_data)",
            "        self.assertIn(\"baz\", submission[0].form_data)",
            "",
            "        # Check that the all the multiple checkbox values are serialised in the",
            "        # email correctly",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"bar\", mail.outbox[0].body)",
            "        self.assertIn(\"foo\", mail.outbox[0].body)",
            "        self.assertIn(\"baz\", mail.outbox[0].body)",
            "",
            "    def test_post_blank_checkbox(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {},",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # Check that the checkbox was serialised in the email correctly",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your choices: \", mail.outbox[0].body)",
            "",
            "",
            "class TestFormWithCustomSubmission(TestCase, WagtailTestUtils):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page_with_custom_submission()",
            "",
            "        self.user = self.login()",
            "",
            "    def test_get_form(self):",
            "        response = self.client.get('/contact-us/')",
            "",
            "        # Check response",
            "        self.assertContains(response, \"\"\"<label for=\"id_your_email\">Your email</label>\"\"\")",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertNotContains(response, '<div>You must log in first.</div>', html=True)",
            "        self.assertContains(response, '<p>Boring intro text</p>', html=True)",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "    def test_get_form_with_anonymous_user(self):",
            "        self.client.logout()",
            "",
            "        response = self.client.get('/contact-us/')",
            "",
            "        # Check response",
            "        self.assertNotContains(response, \"\"\"<label for=\"id_your_email\">Your email</label>\"\"\")",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertContains(response, '<div>You must log in first.</div>', html=True)",
            "        self.assertNotContains(response, '<p>Boring intro text</p>', html=True)",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "    def test_post_invalid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob',",
            "            'your_message': 'hello world',",
            "            'your_choices': ''",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Enter a valid email address.\")",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # check that the custom form_submission is added to the context",
            "        self.assertContains(response, \"<p>Username: test@email.com</p>\")",
            "",
            "        # Check that an email was sent",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].to, ['to@email.com'])",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(CustomFormPageSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "    def test_post_form_twice(self):",
            "        # First submission",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertContains(response, '<p>Thank you for your patience!</p>', html=True)",
            "        self.assertNotContains(response, '<div>The form is already filled.</div>', html=True)",
            "",
            "        # Check that first form submission was saved correctly",
            "        submissions_qs = CustomFormPageSubmission.objects.filter(user=self.user, page=self.form_page)",
            "        self.assertEqual(submissions_qs.count(), 1)",
            "        self.assertTrue(submissions_qs.filter(form_data__contains='hello world').exists())",
            "",
            "        # Second submission",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertNotContains(response, '<p>Thank you for your patience!</p>', html=True)",
            "        self.assertContains(response, '<div>The form is already filled.</div>', html=True)",
            "        self.assertNotContains(response, '<div>You must log in first.</div>', html=True)",
            "        self.assertNotContains(response, '<p>Boring intro text</p>', html=True)",
            "",
            "        # Check that first submission exists and second submission wasn't saved",
            "        submissions_qs = CustomFormPageSubmission.objects.filter(user=self.user, page=self.form_page)",
            "        self.assertEqual(submissions_qs.count(), 1)",
            "        self.assertTrue(submissions_qs.filter(form_data__contains='hello world').exists())",
            "        self.assertFalse(submissions_qs.filter(form_data__contains='hello cruel world').exists())",
            "",
            "    def test_post_unicode_characters(self):",
            "        self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your message: \u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c\", mail.outbox[0].body)",
            "",
            "        # Check the form submission",
            "        submission = CustomFormPageSubmission.objects.get()",
            "        submission_data = json.loads(submission.form_data)",
            "        self.assertEqual(submission_data['your_message'], '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c')",
            "",
            "    def test_post_multiple_values(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': 'on', 'bar': 'on', 'baz': 'on'}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # Check that the three checkbox values were saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        submission = CustomFormPageSubmission.objects.filter(",
            "            page=form_page, form_data__contains='hello world'",
            "        )",
            "        self.assertIn(\"foo\", submission[0].form_data)",
            "        self.assertIn(\"bar\", submission[0].form_data)",
            "        self.assertIn(\"baz\", submission[0].form_data)",
            "",
            "    def test_post_blank_checkbox(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {},",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # Check that the checkbox was serialised in the email correctly",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your choices: None\", mail.outbox[0].body)",
            "",
            "",
            "class TestFormSubmissionWithMultipleRecipients(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page(to_address='to@email.com, another@email.com')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # Check that one email was sent, but to two recipients",
            "        self.assertEqual(len(mail.outbox), 1)",
            "",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "        self.assertEqual(set(mail.outbox[0].to), {'to@email.com', 'another@email.com'})",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(FormSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "",
            "class TestFormSubmissionWithMultipleRecipientsAndWithCustomSubmission(TestCase, WagtailTestUtils):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page_with_custom_submission(",
            "            to_address='to@email.com, another@email.com'",
            "        )",
            "",
            "        self.user = self.login()",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # Check that one email was sent, but to two recipients",
            "        self.assertEqual(len(mail.outbox), 1)",
            "",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "        self.assertEqual(set(mail.outbox[0].to), {'to@email.com', 'another@email.com'})",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(",
            "            CustomFormPageSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists()",
            "        )",
            "",
            "",
            "class TestFormWithRedirect(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page_with_redirect(to_address='to@email.com, another@email.com')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertRedirects(response, '/')",
            "",
            "        # Check that one email was sent, but to two recipients",
            "        self.assertEqual(len(mail.outbox), 1)",
            "",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "        self.assertEqual(set(mail.outbox[0].to), {'to@email.com', 'another@email.com'})",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(FormSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "",
            "class TestFormPageWithCustomFormBuilder(TestCase, WagtailTestUtils):",
            "",
            "    def setUp(self):",
            "",
            "        home_page = Page.objects.get(url_path='/home/')",
            "        form_page = home_page.add_child(",
            "            instance=FormPageWithCustomFormBuilder(",
            "                title='Support Request',",
            "                slug='support-request',",
            "                to_address='it@jenkins.com',",
            "                from_address='support@jenkins.com',",
            "                subject='Support Request Submitted',",
            "            )",
            "        )",
            "        ExtendedFormField.objects.create(",
            "            page=form_page,",
            "            sort_order=1,",
            "            label='Name',",
            "            field_type='singleline',  # singleline field will be max_length 120",
            "            required=True,",
            "        )",
            "        ExtendedFormField.objects.create(",
            "            page=form_page,",
            "            sort_order=1,",
            "            label='Device IP Address',",
            "            field_type='ipaddress',",
            "            required=True,",
            "        )",
            "",
            "    def test_get_form(self):",
            "        response = self.client.get('/support-request/')",
            "",
            "        # Check response",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "        self.assertContains(response, '<title>Support Request</title>', html=True)",
            "        # check that max_length attribute has been passed into form",
            "        self.assertContains(response, '<input type=\"text\" name=\"name\" required maxlength=\"120\" id=\"id_name\" />', html=True)",
            "        # check ip address field has rendered",
            "        self.assertContains(response, '<input type=\"text\" name=\"device_ip_address\" required id=\"id_device_ip_address\" />', html=True)",
            "",
            "    def test_post_invalid_form(self):",
            "        response = self.client.post('/support-request/', {",
            "            'name': 'very long name longer than 120 characters' * 3,  # invalid",
            "            'device_ip_address': '192.0.2.30',  # valid",
            "        })",
            "        # Check response with invalid character count",
            "        self.assertContains(response, 'Ensure this value has at most 120 characters (it has 123)')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "",
            "        response = self.client.post('/support-request/', {",
            "            'name': 'Ron Johnson',  # valid",
            "            'device_ip_address': '3300.192.0.2.30',  # invalid",
            "        })",
            "        # Check response with invalid character count",
            "        self.assertContains(response, 'Enter a valid IPv4 or IPv6 address.')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/support-request/', {",
            "            'name': 'Ron Johnson',",
            "            'device_ip_address': '192.0.2.30',",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, 'Thank you for submitting a Support Request.')",
            "        self.assertContains(response, 'Ron Johnson')",
            "        self.assertContains(response, '192.0.2.30')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "",
            "",
            "class TestCleanedDataEmails(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_types_test_form_page()",
            "",
            "    def test_empty_field_presence(self):",
            "        self.client.post('/contact-us/', {})",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Single line text: \", mail.outbox[0].body)",
            "        self.assertIn(\"Multiline: \", mail.outbox[0].body)",
            "        self.assertIn(\"Email: \", mail.outbox[0].body)",
            "        self.assertIn(\"Number: \", mail.outbox[0].body)",
            "        self.assertIn(\"URL: \", mail.outbox[0].body)",
            "        self.assertIn(\"Checkbox: \", mail.outbox[0].body)",
            "        self.assertIn(\"Checkboxes: \", mail.outbox[0].body)",
            "        self.assertIn(\"Drop down: \", mail.outbox[0].body)",
            "        self.assertIn(\"Multiple select: \", mail.outbox[0].body)",
            "        self.assertIn(\"Radio buttons: \", mail.outbox[0].body)",
            "        self.assertIn(\"Date: \", mail.outbox[0].body)",
            "        self.assertIn(\"Datetime: \", mail.outbox[0].body)",
            "",
            "    def test_email_field_order(self):",
            "        self.client.post('/contact-us/', {})",
            "",
            "        line_beginnings = [",
            "            \"Single line text: \",",
            "            \"Multiline: \",",
            "            \"Email: \",",
            "            \"Number: \",",
            "            \"URL: \",",
            "            \"Checkbox: \",",
            "            \"Checkboxes: \",",
            "            \"Drop down: \",",
            "            \"Multiple select: \",",
            "            \"Radio buttons: \",",
            "            \"Date: \",",
            "            \"Datetime: \",",
            "        ]",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        email_lines = mail.outbox[0].body.split('\\n')",
            "",
            "        for beginning in line_beginnings:",
            "            message_line = email_lines.pop(0)",
            "            self.assertTrue(message_line.startswith(beginning))",
            "",
            "    @override_settings(SHORT_DATE_FORMAT='m/d/Y')",
            "    def test_date_normalization(self):",
            "        self.client.post('/contact-us/', {",
            "            'date': '12/31/17',",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Date: 12/31/2017\", mail.outbox[0].body)",
            "",
            "        self.client.post('/contact-us/', {",
            "            'date': '12/31/1917',",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 2)",
            "        self.assertIn(\"Date: 12/31/1917\", mail.outbox[1].body)",
            "",
            "",
            "    @override_settings(SHORT_DATETIME_FORMAT='m/d/Y P')",
            "    def test_datetime_normalization(self):",
            "        self.client.post('/contact-us/', {",
            "            'datetime': '12/31/17 4:00:00',",
            "        })",
            "",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Datetime: 12/31/2017 4 a.m.\", mail.outbox[0].body)",
            "",
            "        self.client.post('/contact-us/', {",
            "            'datetime': '12/31/1917 21:19',",
            "        })",
            "",
            "        self.assertEqual(len(mail.outbox), 2)",
            "        self.assertIn(\"Datetime: 12/31/1917 9:19 p.m.\", mail.outbox[1].body)",
            "",
            "        self.client.post('/contact-us/', {",
            "            'datetime': '1910-12-21 21:19:12',",
            "        })",
            "",
            "        self.assertEqual(len(mail.outbox), 3)",
            "        self.assertIn(\"Datetime: 12/21/1910 9:19 p.m.\", mail.outbox[2].body)",
            "",
            "",
            "",
            "class TestIssue798(TestCase):",
            "    fixtures = ['test.json']",
            "",
            "    def setUp(self):",
            "        self.assertTrue(self.client.login(username='siteeditor', password='password'))",
            "        self.form_page = Page.objects.get(url_path='/home/contact-us/').specific",
            "",
            "        # Add a number field to the page",
            "        FormField.objects.create(",
            "            page=self.form_page,",
            "            label=\"Your favourite number\",",
            "            field_type='number',",
            "        )",
            "",
            "    def test_post(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''},",
            "            'your_favourite_number': '7.3',",
            "        })",
            "",
            "        # Check response",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # Check that form submission was saved correctly",
            "        self.assertTrue(FormSubmission.objects.filter(page=self.form_page, form_data__contains='hello world').exists())",
            "        self.assertTrue(FormSubmission.objects.filter(page=self.form_page, form_data__contains='7.3').exists())",
            "",
            "",
            "class TestNonHtmlExtension(TestCase):",
            "    fixtures = ['test.json']",
            "",
            "    def test_non_html_extension(self):",
            "        form_page = JadeFormPage(title=\"test\")",
            "        self.assertEqual(form_page.landing_page_template, \"tests/form_page_landing.jade\")",
            "",
            "",
            "class TestLegacyFormFieldCleanNameChecks(TestCase):",
            "    fixtures = ['test.json']",
            "",
            "    def setUp(self):",
            "        self.assertTrue(self.client.login(username='siteeditor', password='password'))",
            "        self.form_page = Page.objects.get(url_path='/home/contact-us-one-more-time/').specific",
            "",
            "",
            "    def test_form_field_clean_name_update_on_checks(self):",
            "",
            "        fields_before_checks = [",
            "            (field.label, field.clean_name,)",
            "            for field in FormFieldWithCustomSubmission.objects.all()",
            "        ]",
            "",
            "        self.assertEqual(fields_before_checks, [",
            "            ('Your email', ''),",
            "            ('Your message', ''),",
            "            ('Your choices', ''),",
            "        ])",
            "",
            "        # running checks should show an info message AND update blank clean_name values",
            "",
            "        messages = FormFieldWithCustomSubmission.check()",
            "",
            "        self.assertEqual(",
            "            messages,",
            "            [Info('Added `clean_name` on 3 form field(s)', obj=FormFieldWithCustomSubmission)]",
            "        )",
            "",
            "",
            "        fields_after_checks = [",
            "            (field.label, field.clean_name,)",
            "            for field in FormFieldWithCustomSubmission.objects.all()",
            "        ]",
            "",
            "        self.assertEqual(fields_after_checks, [",
            "            ('Your email', 'your-email'),  # kebab case, legacy format",
            "            ('Your message', 'your-message'),",
            "            ('Your choices', 'your-choices'),",
            "        ])",
            "",
            "        # running checks again should return no messages as fields no longer need changing",
            "        self.assertEqual(FormFieldWithCustomSubmission.check(), [])",
            "",
            "        # creating a new field should use the non-legacy clean_name format",
            "",
            "        field = FormFieldWithCustomSubmission.objects.create(",
            "            page=self.form_page,",
            "            label=\"Your FAVOURITE #number\",",
            "            field_type='number',",
            "        )",
            "",
            "        self.assertEqual(field.clean_name, 'your_favourite_number')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import json",
            "",
            "from django.core import mail",
            "from django.core.checks import Info",
            "from django.test import TestCase, override_settings",
            "",
            "from wagtail.contrib.forms.models import FormSubmission",
            "from wagtail.contrib.forms.tests.utils import (",
            "    make_form_page, make_form_page_with_custom_submission, make_form_page_with_redirect,",
            "    make_types_test_form_page)",
            "from wagtail.core.models import Page",
            "from wagtail.tests.testapp.models import (",
            "    CustomFormPageSubmission, ExtendedFormField, FormField, FormFieldWithCustomSubmission,",
            "    FormPageWithCustomFormBuilder, JadeFormPage)",
            "from wagtail.tests.utils import WagtailTestUtils",
            "",
            "",
            "class TestFormSubmission(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page()",
            "",
            "    def test_get_form(self):",
            "        response = self.client.get('/contact-us/')",
            "",
            "        # Check response",
            "        self.assertContains(response, \"\"\"<label for=\"id_your_email\">Your email</label>\"\"\")",
            "        self.assertTemplateUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # HTML in help text should be escaped",
            "        self.assertContains(response, \"&lt;em&gt;please&lt;/em&gt; be polite\")",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "    @override_settings(WAGTAILFORMS_HELP_TEXT_ALLOW_HTML=True)",
            "    def test_get_form_without_help_text_escaping(self):",
            "        response = self.client.get('/contact-us/')",
            "        # HTML in help text should not be escaped",
            "        self.assertContains(response, \"<em>please</em> be polite\")",
            "",
            "    def test_post_invalid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob',",
            "            'your_message': 'hello world',",
            "            'your_choices': ''",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Enter a valid email address.\")",
            "        self.assertTemplateUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_landing.html')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # check the default form_submission is added to the context",
            "        self.assertContains(response, \"<li>your_email: bob@example.com</li>\")",
            "",
            "        # Check that an email was sent",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].to, ['to@email.com'])",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(FormSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "    def test_post_unicode_characters(self):",
            "        self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your message: \u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c\", mail.outbox[0].body)",
            "",
            "        # Check the form submission",
            "        submission = FormSubmission.objects.get()",
            "        submission_data = json.loads(submission.form_data)",
            "        self.assertEqual(submission_data['your_message'], '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c')",
            "",
            "    def test_post_multiple_values(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': 'on', 'bar': 'on', 'baz': 'on'}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # Check that the three checkbox values were saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        submission = FormSubmission.objects.filter(",
            "            page=form_page, form_data__contains='hello world'",
            "        )",
            "        self.assertIn(\"foo\", submission[0].form_data)",
            "        self.assertIn(\"bar\", submission[0].form_data)",
            "        self.assertIn(\"baz\", submission[0].form_data)",
            "",
            "        # Check that the all the multiple checkbox values are serialised in the",
            "        # email correctly",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"bar\", mail.outbox[0].body)",
            "        self.assertIn(\"foo\", mail.outbox[0].body)",
            "        self.assertIn(\"baz\", mail.outbox[0].body)",
            "",
            "    def test_post_blank_checkbox(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {},",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # Check that the checkbox was serialised in the email correctly",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your choices: \", mail.outbox[0].body)",
            "",
            "",
            "class TestFormWithCustomSubmission(TestCase, WagtailTestUtils):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page_with_custom_submission()",
            "",
            "        self.user = self.login()",
            "",
            "    def test_get_form(self):",
            "        response = self.client.get('/contact-us/')",
            "",
            "        # Check response",
            "        self.assertContains(response, \"\"\"<label for=\"id_your_email\">Your email</label>\"\"\")",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertNotContains(response, '<div>You must log in first.</div>', html=True)",
            "        self.assertContains(response, '<p>Boring intro text</p>', html=True)",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "    def test_get_form_with_anonymous_user(self):",
            "        self.client.logout()",
            "",
            "        response = self.client.get('/contact-us/')",
            "",
            "        # Check response",
            "        self.assertNotContains(response, \"\"\"<label for=\"id_your_email\">Your email</label>\"\"\")",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertContains(response, '<div>You must log in first.</div>', html=True)",
            "        self.assertNotContains(response, '<p>Boring intro text</p>', html=True)",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "    def test_post_invalid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob',",
            "            'your_message': 'hello world',",
            "            'your_choices': ''",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Enter a valid email address.\")",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # check that the custom form_submission is added to the context",
            "        self.assertContains(response, \"<p>Username: test@email.com</p>\")",
            "",
            "        # Check that an email was sent",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].to, ['to@email.com'])",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(CustomFormPageSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "    def test_post_form_twice(self):",
            "        # First submission",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertContains(response, '<p>Thank you for your patience!</p>', html=True)",
            "        self.assertNotContains(response, '<div>The form is already filled.</div>', html=True)",
            "",
            "        # Check that first form submission was saved correctly",
            "        submissions_qs = CustomFormPageSubmission.objects.filter(user=self.user, page=self.form_page)",
            "        self.assertEqual(submissions_qs.count(), 1)",
            "        self.assertTrue(submissions_qs.filter(form_data__contains='hello world').exists())",
            "",
            "        # Second submission",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "        self.assertNotContains(response, '<p>Thank you for your patience!</p>', html=True)",
            "        self.assertContains(response, '<div>The form is already filled.</div>', html=True)",
            "        self.assertNotContains(response, '<div>You must log in first.</div>', html=True)",
            "        self.assertNotContains(response, '<p>Boring intro text</p>', html=True)",
            "",
            "        # Check that first submission exists and second submission wasn't saved",
            "        submissions_qs = CustomFormPageSubmission.objects.filter(user=self.user, page=self.form_page)",
            "        self.assertEqual(submissions_qs.count(), 1)",
            "        self.assertTrue(submissions_qs.filter(form_data__contains='hello world').exists())",
            "        self.assertFalse(submissions_qs.filter(form_data__contains='hello cruel world').exists())",
            "",
            "    def test_post_unicode_characters(self):",
            "        self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your message: \u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c\", mail.outbox[0].body)",
            "",
            "        # Check the form submission",
            "        submission = CustomFormPageSubmission.objects.get()",
            "        submission_data = json.loads(submission.form_data)",
            "        self.assertEqual(submission_data['your_message'], '\u3053\u3093\u306b\u3061\u306f\u3001\u4e16\u754c')",
            "",
            "    def test_post_multiple_values(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': 'on', 'bar': 'on', 'baz': 'on'}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # Check that the three checkbox values were saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        submission = CustomFormPageSubmission.objects.filter(",
            "            page=form_page, form_data__contains='hello world'",
            "        )",
            "        self.assertIn(\"foo\", submission[0].form_data)",
            "        self.assertIn(\"bar\", submission[0].form_data)",
            "        self.assertIn(\"baz\", submission[0].form_data)",
            "",
            "    def test_post_blank_checkbox(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {},",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # Check that the checkbox was serialised in the email correctly",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Your choices: None\", mail.outbox[0].body)",
            "",
            "",
            "class TestFormSubmissionWithMultipleRecipients(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page(to_address='to@email.com, another@email.com')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your feedback.\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # Check that one email was sent, but to two recipients",
            "        self.assertEqual(len(mail.outbox), 1)",
            "",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "        self.assertEqual(set(mail.outbox[0].to), {'to@email.com', 'another@email.com'})",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(FormSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "",
            "class TestFormSubmissionWithMultipleRecipientsAndWithCustomSubmission(TestCase, WagtailTestUtils):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page_with_custom_submission(",
            "            to_address='to@email.com, another@email.com'",
            "        )",
            "",
            "        self.user = self.login()",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, \"Thank you for your patience!\")",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_submission.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_submission_landing.html')",
            "",
            "        # check that variables defined in get_context are passed through to the template (#1429)",
            "        self.assertContains(response, \"<p>hello world</p>\")",
            "",
            "        # Check that one email was sent, but to two recipients",
            "        self.assertEqual(len(mail.outbox), 1)",
            "",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "        self.assertEqual(set(mail.outbox[0].to), {'to@email.com', 'another@email.com'})",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(",
            "            CustomFormPageSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists()",
            "        )",
            "",
            "",
            "class TestFormWithRedirect(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_form_page_with_redirect(to_address='to@email.com, another@email.com')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''}",
            "        })",
            "",
            "        # Check response",
            "        self.assertRedirects(response, '/')",
            "",
            "        # Check that one email was sent, but to two recipients",
            "        self.assertEqual(len(mail.outbox), 1)",
            "",
            "        self.assertEqual(mail.outbox[0].subject, \"The subject\")",
            "        self.assertIn(\"Your message: hello world\", mail.outbox[0].body)",
            "        self.assertEqual(mail.outbox[0].from_email, 'from@email.com')",
            "        self.assertEqual(set(mail.outbox[0].to), {'to@email.com', 'another@email.com'})",
            "",
            "        # Check that form submission was saved correctly",
            "        form_page = Page.objects.get(url_path='/home/contact-us/')",
            "        self.assertTrue(FormSubmission.objects.filter(page=form_page, form_data__contains='hello world').exists())",
            "",
            "",
            "class TestFormPageWithCustomFormBuilder(TestCase, WagtailTestUtils):",
            "",
            "    def setUp(self):",
            "",
            "        home_page = Page.objects.get(url_path='/home/')",
            "        form_page = home_page.add_child(",
            "            instance=FormPageWithCustomFormBuilder(",
            "                title='Support Request',",
            "                slug='support-request',",
            "                to_address='it@jenkins.com',",
            "                from_address='support@jenkins.com',",
            "                subject='Support Request Submitted',",
            "            )",
            "        )",
            "        ExtendedFormField.objects.create(",
            "            page=form_page,",
            "            sort_order=1,",
            "            label='Name',",
            "            field_type='singleline',  # singleline field will be max_length 120",
            "            required=True,",
            "        )",
            "        ExtendedFormField.objects.create(",
            "            page=form_page,",
            "            sort_order=1,",
            "            label='Device IP Address',",
            "            field_type='ipaddress',",
            "            required=True,",
            "        )",
            "",
            "    def test_get_form(self):",
            "        response = self.client.get('/support-request/')",
            "",
            "        # Check response",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "        self.assertContains(response, '<title>Support Request</title>', html=True)",
            "        # check that max_length attribute has been passed into form",
            "        self.assertContains(response, '<input type=\"text\" name=\"name\" required maxlength=\"120\" id=\"id_name\" />', html=True)",
            "        # check ip address field has rendered",
            "        self.assertContains(response, '<input type=\"text\" name=\"device_ip_address\" required id=\"id_device_ip_address\" />', html=True)",
            "",
            "    def test_post_invalid_form(self):",
            "        response = self.client.post('/support-request/', {",
            "            'name': 'very long name longer than 120 characters' * 3,  # invalid",
            "            'device_ip_address': '192.0.2.30',  # valid",
            "        })",
            "        # Check response with invalid character count",
            "        self.assertContains(response, 'Ensure this value has at most 120 characters (it has 123)')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "",
            "        response = self.client.post('/support-request/', {",
            "            'name': 'Ron Johnson',  # valid",
            "            'device_ip_address': '3300.192.0.2.30',  # invalid",
            "        })",
            "        # Check response with invalid character count",
            "        self.assertContains(response, 'Enter a valid IPv4 or IPv6 address.')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "",
            "    def test_post_valid_form(self):",
            "        response = self.client.post('/support-request/', {",
            "            'name': 'Ron Johnson',",
            "            'device_ip_address': '192.0.2.30',",
            "        })",
            "",
            "        # Check response",
            "        self.assertContains(response, 'Thank you for submitting a Support Request.')",
            "        self.assertContains(response, 'Ron Johnson')",
            "        self.assertContains(response, '192.0.2.30')",
            "        self.assertTemplateNotUsed(response, 'tests/form_page_with_custom_form_builder.html')",
            "        self.assertTemplateUsed(response, 'tests/form_page_with_custom_form_builder_landing.html')",
            "",
            "",
            "class TestCleanedDataEmails(TestCase):",
            "    def setUp(self):",
            "        # Create a form page",
            "        self.form_page = make_types_test_form_page()",
            "",
            "    def test_empty_field_presence(self):",
            "        self.client.post('/contact-us/', {})",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Single line text: \", mail.outbox[0].body)",
            "        self.assertIn(\"Multiline: \", mail.outbox[0].body)",
            "        self.assertIn(\"Email: \", mail.outbox[0].body)",
            "        self.assertIn(\"Number: \", mail.outbox[0].body)",
            "        self.assertIn(\"URL: \", mail.outbox[0].body)",
            "        self.assertIn(\"Checkbox: \", mail.outbox[0].body)",
            "        self.assertIn(\"Checkboxes: \", mail.outbox[0].body)",
            "        self.assertIn(\"Drop down: \", mail.outbox[0].body)",
            "        self.assertIn(\"Multiple select: \", mail.outbox[0].body)",
            "        self.assertIn(\"Radio buttons: \", mail.outbox[0].body)",
            "        self.assertIn(\"Date: \", mail.outbox[0].body)",
            "        self.assertIn(\"Datetime: \", mail.outbox[0].body)",
            "",
            "    def test_email_field_order(self):",
            "        self.client.post('/contact-us/', {})",
            "",
            "        line_beginnings = [",
            "            \"Single line text: \",",
            "            \"Multiline: \",",
            "            \"Email: \",",
            "            \"Number: \",",
            "            \"URL: \",",
            "            \"Checkbox: \",",
            "            \"Checkboxes: \",",
            "            \"Drop down: \",",
            "            \"Multiple select: \",",
            "            \"Radio buttons: \",",
            "            \"Date: \",",
            "            \"Datetime: \",",
            "        ]",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        email_lines = mail.outbox[0].body.split('\\n')",
            "",
            "        for beginning in line_beginnings:",
            "            message_line = email_lines.pop(0)",
            "            self.assertTrue(message_line.startswith(beginning))",
            "",
            "    @override_settings(SHORT_DATE_FORMAT='m/d/Y')",
            "    def test_date_normalization(self):",
            "        self.client.post('/contact-us/', {",
            "            'date': '12/31/17',",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Date: 12/31/2017\", mail.outbox[0].body)",
            "",
            "        self.client.post('/contact-us/', {",
            "            'date': '12/31/1917',",
            "        })",
            "",
            "        # Check the email",
            "        self.assertEqual(len(mail.outbox), 2)",
            "        self.assertIn(\"Date: 12/31/1917\", mail.outbox[1].body)",
            "",
            "",
            "    @override_settings(SHORT_DATETIME_FORMAT='m/d/Y P')",
            "    def test_datetime_normalization(self):",
            "        self.client.post('/contact-us/', {",
            "            'datetime': '12/31/17 4:00:00',",
            "        })",
            "",
            "        self.assertEqual(len(mail.outbox), 1)",
            "        self.assertIn(\"Datetime: 12/31/2017 4 a.m.\", mail.outbox[0].body)",
            "",
            "        self.client.post('/contact-us/', {",
            "            'datetime': '12/31/1917 21:19',",
            "        })",
            "",
            "        self.assertEqual(len(mail.outbox), 2)",
            "        self.assertIn(\"Datetime: 12/31/1917 9:19 p.m.\", mail.outbox[1].body)",
            "",
            "        self.client.post('/contact-us/', {",
            "            'datetime': '1910-12-21 21:19:12',",
            "        })",
            "",
            "        self.assertEqual(len(mail.outbox), 3)",
            "        self.assertIn(\"Datetime: 12/21/1910 9:19 p.m.\", mail.outbox[2].body)",
            "",
            "",
            "",
            "class TestIssue798(TestCase):",
            "    fixtures = ['test.json']",
            "",
            "    def setUp(self):",
            "        self.assertTrue(self.client.login(username='siteeditor', password='password'))",
            "        self.form_page = Page.objects.get(url_path='/home/contact-us/').specific",
            "",
            "        # Add a number field to the page",
            "        FormField.objects.create(",
            "            page=self.form_page,",
            "            label=\"Your favourite number\",",
            "            field_type='number',",
            "        )",
            "",
            "    def test_post(self):",
            "        response = self.client.post('/contact-us/', {",
            "            'your_email': 'bob@example.com',",
            "            'your_message': 'hello world',",
            "            'your_choices': {'foo': '', 'bar': '', 'baz': ''},",
            "            'your_favourite_number': '7.3',",
            "        })",
            "",
            "        # Check response",
            "        self.assertTemplateUsed(response, 'tests/form_page_landing.html')",
            "",
            "        # Check that form submission was saved correctly",
            "        self.assertTrue(FormSubmission.objects.filter(page=self.form_page, form_data__contains='hello world').exists())",
            "        self.assertTrue(FormSubmission.objects.filter(page=self.form_page, form_data__contains='7.3').exists())",
            "",
            "",
            "class TestNonHtmlExtension(TestCase):",
            "    fixtures = ['test.json']",
            "",
            "    def test_non_html_extension(self):",
            "        form_page = JadeFormPage(title=\"test\")",
            "        self.assertEqual(form_page.landing_page_template, \"tests/form_page_landing.jade\")",
            "",
            "",
            "class TestLegacyFormFieldCleanNameChecks(TestCase):",
            "    fixtures = ['test.json']",
            "",
            "    def setUp(self):",
            "        self.assertTrue(self.client.login(username='siteeditor', password='password'))",
            "        self.form_page = Page.objects.get(url_path='/home/contact-us-one-more-time/').specific",
            "",
            "",
            "    def test_form_field_clean_name_update_on_checks(self):",
            "",
            "        fields_before_checks = [",
            "            (field.label, field.clean_name,)",
            "            for field in FormFieldWithCustomSubmission.objects.all()",
            "        ]",
            "",
            "        self.assertEqual(fields_before_checks, [",
            "            ('Your email', ''),",
            "            ('Your message', ''),",
            "            ('Your choices', ''),",
            "        ])",
            "",
            "        # running checks should show an info message AND update blank clean_name values",
            "",
            "        messages = FormFieldWithCustomSubmission.check()",
            "",
            "        self.assertEqual(",
            "            messages,",
            "            [Info('Added `clean_name` on 3 form field(s)', obj=FormFieldWithCustomSubmission)]",
            "        )",
            "",
            "",
            "        fields_after_checks = [",
            "            (field.label, field.clean_name,)",
            "            for field in FormFieldWithCustomSubmission.objects.all()",
            "        ]",
            "",
            "        self.assertEqual(fields_after_checks, [",
            "            ('Your email', 'your-email'),  # kebab case, legacy format",
            "            ('Your message', 'your-message'),",
            "            ('Your choices', 'your-choices'),",
            "        ])",
            "",
            "        # running checks again should return no messages as fields no longer need changing",
            "        self.assertEqual(FormFieldWithCustomSubmission.check(), [])",
            "",
            "        # creating a new field should use the non-legacy clean_name format",
            "",
            "        field = FormFieldWithCustomSubmission.objects.create(",
            "            page=self.form_page,",
            "            label=\"Your FAVOURITE #number\",",
            "            field_type='number',",
            "        )",
            "",
            "        self.assertEqual(field.clean_name, 'your_favourite_number')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "certifi",
            "wagtail.contrib.forms.tests.test_models.TestFormSubmission.self"
        ]
    },
    "wagtail/contrib/forms/tests/utils.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 28,
                "PatchRowcode": "         label=\"Your message\","
            },
            "1": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": "         field_type='multiline',"
            },
            "2": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "         required=True,"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+        help_text=\"<em>please</em> be polite\""
            },
            "4": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 32,
                "PatchRowcode": "     )"
            },
            "5": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 33,
                "PatchRowcode": "     FormField.objects.create("
            },
            "6": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "         page=form_page,"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from wagtail.core.models import Page",
            "from wagtail.tests.testapp.models import (",
            "    FormField, FormFieldWithCustomSubmission, FormPage, FormPageWithCustomSubmission,",
            "    FormPageWithRedirect, RedirectFormField)",
            "",
            "",
            "def make_form_page(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    form_page = home_page.add_child(instance=FormPage(**kwargs))",
            "",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Your email\",",
            "        field_type='email',",
            "        required=True,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Your message\",",
            "        field_type='multiline',",
            "        required=True,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Your choices\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "",
            "    return form_page",
            "",
            "",
            "def make_form_page_with_custom_submission(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('intro', \"<p>Boring intro text</p>\")",
            "    kwargs.setdefault('thank_you_text', \"<p>Thank you for your patience!</p>\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    form_page = home_page.add_child(instance=FormPageWithCustomSubmission(**kwargs))",
            "",
            "    FormFieldWithCustomSubmission.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Your email\",",
            "        field_type='email',",
            "        required=True,",
            "    )",
            "    FormFieldWithCustomSubmission.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Your message\",",
            "        field_type='multiline',",
            "        required=True,",
            "    )",
            "    FormFieldWithCustomSubmission.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Your choices\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "",
            "    return form_page",
            "",
            "",
            "def make_form_page_with_redirect(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    kwargs.setdefault('thank_you_redirect_page', home_page)",
            "    form_page = home_page.add_child(instance=FormPageWithRedirect(**kwargs))",
            "    # form_page.thank_you_redirect_page = home_page",
            "",
            "    RedirectFormField.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Your email\",",
            "        field_type='email',",
            "        required=True,",
            "    )",
            "    RedirectFormField.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Your message\",",
            "        field_type='multiline',",
            "        required=True,",
            "    )",
            "    RedirectFormField.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Your choices\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "",
            "    return form_page",
            "",
            "",
            "def make_types_test_form_page(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    form_page = home_page.add_child(instance=FormPage(**kwargs))",
            "",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Single line text\",",
            "        field_type='singleline',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Multiline\",",
            "        field_type='multiline',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Email\",",
            "        field_type='email',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=4,",
            "        label=\"Number\",",
            "        field_type='number',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=5,",
            "        label=\"URL\",",
            "        field_type='url',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=6,",
            "        label=\"Checkbox\",",
            "        field_type='checkbox',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=7,",
            "        label=\"Checkboxes\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=8,",
            "        label=\"Drop down\",",
            "        field_type='dropdown',",
            "        required=False,",
            "        choices='spam,ham,eggs',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=9,",
            "        label=\"Multiple select\",",
            "        field_type='multiselect',",
            "        required=False,",
            "        choices='qux,quux,quuz,corge',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=10,",
            "        label=\"Radio buttons\",",
            "        field_type='radio',",
            "        required=False,",
            "        choices='wibble,wobble,wubble',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=11,",
            "        label=\"Date\",",
            "        field_type='date',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=12,",
            "        label=\"Datetime\",",
            "        field_type='datetime',",
            "        required=False,",
            "    )",
            "",
            "    return form_page"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from wagtail.core.models import Page",
            "from wagtail.tests.testapp.models import (",
            "    FormField, FormFieldWithCustomSubmission, FormPage, FormPageWithCustomSubmission,",
            "    FormPageWithRedirect, RedirectFormField)",
            "",
            "",
            "def make_form_page(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    form_page = home_page.add_child(instance=FormPage(**kwargs))",
            "",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Your email\",",
            "        field_type='email',",
            "        required=True,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Your message\",",
            "        field_type='multiline',",
            "        required=True,",
            "        help_text=\"<em>please</em> be polite\"",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Your choices\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "",
            "    return form_page",
            "",
            "",
            "def make_form_page_with_custom_submission(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('intro', \"<p>Boring intro text</p>\")",
            "    kwargs.setdefault('thank_you_text', \"<p>Thank you for your patience!</p>\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    form_page = home_page.add_child(instance=FormPageWithCustomSubmission(**kwargs))",
            "",
            "    FormFieldWithCustomSubmission.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Your email\",",
            "        field_type='email',",
            "        required=True,",
            "    )",
            "    FormFieldWithCustomSubmission.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Your message\",",
            "        field_type='multiline',",
            "        required=True,",
            "    )",
            "    FormFieldWithCustomSubmission.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Your choices\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "",
            "    return form_page",
            "",
            "",
            "def make_form_page_with_redirect(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    kwargs.setdefault('thank_you_redirect_page', home_page)",
            "    form_page = home_page.add_child(instance=FormPageWithRedirect(**kwargs))",
            "    # form_page.thank_you_redirect_page = home_page",
            "",
            "    RedirectFormField.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Your email\",",
            "        field_type='email',",
            "        required=True,",
            "    )",
            "    RedirectFormField.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Your message\",",
            "        field_type='multiline',",
            "        required=True,",
            "    )",
            "    RedirectFormField.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Your choices\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "",
            "    return form_page",
            "",
            "",
            "def make_types_test_form_page(**kwargs):",
            "    kwargs.setdefault('title', \"Contact us\")",
            "    kwargs.setdefault('slug', \"contact-us\")",
            "    kwargs.setdefault('to_address', \"to@email.com\")",
            "    kwargs.setdefault('from_address', \"from@email.com\")",
            "    kwargs.setdefault('subject', \"The subject\")",
            "",
            "    home_page = Page.objects.get(url_path='/home/')",
            "    form_page = home_page.add_child(instance=FormPage(**kwargs))",
            "",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=1,",
            "        label=\"Single line text\",",
            "        field_type='singleline',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=2,",
            "        label=\"Multiline\",",
            "        field_type='multiline',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=3,",
            "        label=\"Email\",",
            "        field_type='email',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=4,",
            "        label=\"Number\",",
            "        field_type='number',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=5,",
            "        label=\"URL\",",
            "        field_type='url',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=6,",
            "        label=\"Checkbox\",",
            "        field_type='checkbox',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=7,",
            "        label=\"Checkboxes\",",
            "        field_type='checkboxes',",
            "        required=False,",
            "        choices='foo,bar,baz',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=8,",
            "        label=\"Drop down\",",
            "        field_type='dropdown',",
            "        required=False,",
            "        choices='spam,ham,eggs',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=9,",
            "        label=\"Multiple select\",",
            "        field_type='multiselect',",
            "        required=False,",
            "        choices='qux,quux,quuz,corge',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=10,",
            "        label=\"Radio buttons\",",
            "        field_type='radio',",
            "        required=False,",
            "        choices='wibble,wobble,wubble',",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=11,",
            "        label=\"Date\",",
            "        field_type='date',",
            "        required=False,",
            "    )",
            "    FormField.objects.create(",
            "        page=form_page,",
            "        sort_order=12,",
            "        label=\"Datetime\",",
            "        field_type='datetime',",
            "        required=False,",
            "    )",
            "",
            "    return form_page"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "certifi"
        ]
    }
}