{
    "oauthenticator/google.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "         help=\"\"\""
            },
            "1": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "         This config has two functions."
            },
            "2": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 113,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        1. Restrict sign-in to a list of email domain names, such as"
            },
            "4": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-           `[\"mycollege.edu\"]` or `[\"college1.edu\", \"college2.edu\"]`."
            },
            "5": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        2. If a single domain is specified, the username will be stripped to exclude the `@domain` part."
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+        1. Restrict sign-in to users part of Google organizations/workspaces"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+           managing domains, such as `[\"mycollege.edu\"]` or `[\"college1.edu\","
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+           \"college2.edu\"]`."
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+        2. If a single domain is specified, usernames with that domain will be"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+           stripped to exclude the `@domain` part."
            },
            "11": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 119,
                "PatchRowcode": " "
            },
            "12": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        Note that users with email domains in this list must still be allowed"
            },
            "13": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        via another config, such as `allow_all`, `allowed_users`, or"
            },
            "14": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        `allowed_google_groups`."
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 120,
                "PatchRowcode": "+        Users not restricted by this configuration must still be explicitly"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+        allowed by a configuration intended to allow users, like `allow_all`,"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+        `allowed_users`, or `allowed_google_groups`."
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 123,
                "PatchRowcode": "+"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 124,
                "PatchRowcode": "+        .. warning::"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 126,
                "PatchRowcode": "+           Changing this config either to or from having a single entry is a"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+           disruptive change as the same Google user will get a new username,"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+           either without or with a domain name included."
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+        :::"
            },
            "25": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 130,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 122,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ```{warning} Disruptive config changes"
            },
            "27": {
                "beforePatchRowNumber": 123,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        Changing this config either to or from having a single entry is a"
            },
            "28": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        disruptive change as the same Google user will get a new username,"
            },
            "29": {
                "beforePatchRowNumber": 125,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        either without or with a domain name included."
            },
            "30": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ```"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+        .. versionchanged:: 16.1"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+           Now restricts sign-in based on the hd claim, not the domain in the"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+           user's email."
            },
            "35": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": 135,
                "PatchRowcode": "         \"\"\","
            },
            "36": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 136,
                "PatchRowcode": "     )"
            },
            "37": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 137,
                "PatchRowcode": " "
            },
            "38": {
                "beforePatchRowNumber": 174,
                "afterPatchRowNumber": 182,
                "PatchRowcode": "         user_email = user_info[\"email\"]"
            },
            "39": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "         user_domain = user_info[\"domain\"] = user_email.split(\"@\")[1].lower()"
            },
            "40": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 184,
                "PatchRowcode": " "
            },
            "41": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if len(self.hosted_domain) == 1 and self.hosted_domain[0] == user_domain:"
            },
            "42": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # unambiguous domain, use only base name"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 185,
                "PatchRowcode": "+        # NOTE: This is not an authorization check, it just about username"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 186,
                "PatchRowcode": "+        #       derivation. Decoupling hosted_domain from this is considered in"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 187,
                "PatchRowcode": "+        #       https://github.com/jupyterhub/oauthenticator/issues/733."
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 188,
                "PatchRowcode": "+        #"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 189,
                "PatchRowcode": "+        # NOTE: This code is written with without knowing for sure if the user"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 190,
                "PatchRowcode": "+        #       email's domain could be different from the domain in hd, so we"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 191,
                "PatchRowcode": "+        #       assume it could be even though it seems like it can't be. If a"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 192,
                "PatchRowcode": "+        #       Google organization/workspace manages users in a \"primary"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 193,
                "PatchRowcode": "+        #       domain\" and a \"secondary domain\", users with respective email"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 194,
                "PatchRowcode": "+        #       domain have their hd field set respectively."
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 195,
                "PatchRowcode": "+        #"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 196,
                "PatchRowcode": "+        if len(self.hosted_domain) == 1 and user_domain == self.hosted_domain[0]:"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 197,
                "PatchRowcode": "+            # strip the domain in this situation"
            },
            "56": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 198,
                "PatchRowcode": "             username = username.split(\"@\")[0]"
            },
            "57": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 199,
                "PatchRowcode": " "
            },
            "58": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 200,
                "PatchRowcode": "         return username"
            },
            "59": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": 233,
                "PatchRowcode": " "
            },
            "60": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": 234,
                "PatchRowcode": "         return auth_model"
            },
            "61": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": 235,
                "PatchRowcode": " "
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 236,
                "PatchRowcode": "+    def check_blocked_users(self, username, auth_model):"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 237,
                "PatchRowcode": "+        \"\"\""
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 238,
                "PatchRowcode": "+        Overrides `Authenticator.check_blocked_users` to not only block users in"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 239,
                "PatchRowcode": "+        `Authenticator.blocked_users`, but to also enforce"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 240,
                "PatchRowcode": "+        `GoogleOAuthenticator.hosted_domain` if its configured."
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 241,
                "PatchRowcode": "+"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 242,
                "PatchRowcode": "+        When hosted_domain is configured, users are required to be part of"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 243,
                "PatchRowcode": "+        listed Google organizations/workspaces."
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 244,
                "PatchRowcode": "+"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 245,
                "PatchRowcode": "+        Returns False if the user is blocked, otherwise True."
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 246,
                "PatchRowcode": "+        \"\"\""
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 247,
                "PatchRowcode": "+        user_info = auth_model[\"auth_state\"][self.user_auth_state_key]"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 248,
                "PatchRowcode": "+"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 249,
                "PatchRowcode": "+        # hd ref: https://developers.google.com/identity/openid-connect/openid-connect#id_token-hd"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 250,
                "PatchRowcode": "+        hd = user_info.get(\"hd\", \"\")"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+        if self.hosted_domain and hd not in self.hosted_domain:"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+            self.log.warning(f\"Blocked {username} with 'hd={hd}' not in hosted_domain\")"
            },
            "80": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 254,
                "PatchRowcode": "+            return False"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 255,
                "PatchRowcode": "+"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 256,
                "PatchRowcode": "+        return super().check_blocked_users(username, auth_model)"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 257,
                "PatchRowcode": "+"
            },
            "84": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": 258,
                "PatchRowcode": "     async def check_allowed(self, username, auth_model):"
            },
            "85": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": 259,
                "PatchRowcode": "         \"\"\""
            },
            "86": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": 260,
                "PatchRowcode": "         Overrides the OAuthenticator.check_allowed to also allow users part of"
            },
            "87": {
                "beforePatchRowNumber": 236,
                "afterPatchRowNumber": 277,
                "PatchRowcode": "             self.log.warning(message)"
            },
            "88": {
                "beforePatchRowNumber": 237,
                "afterPatchRowNumber": 278,
                "PatchRowcode": "             raise HTTPError(403, message)"
            },
            "89": {
                "beforePatchRowNumber": 238,
                "afterPatchRowNumber": 279,
                "PatchRowcode": " "
            },
            "90": {
                "beforePatchRowNumber": 239,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # NOTE: If hosted_domain is configured as [\"a.com\", \"b.com\"], and"
            },
            "91": {
                "beforePatchRowNumber": 240,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        #       allowed_google_groups is declared as {\"a.com\": {\"a-group\"}}, a"
            },
            "92": {
                "beforePatchRowNumber": 241,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        #       \"b.com\" user won't be authorized unless allowed in another way."
            },
            "93": {
                "beforePatchRowNumber": 242,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        #"
            },
            "94": {
                "beforePatchRowNumber": 243,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        #       This means that its not possible to allow all users of a given"
            },
            "95": {
                "beforePatchRowNumber": 244,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        #       domain if one wants to restrict another."
            },
            "96": {
                "beforePatchRowNumber": 245,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        #"
            },
            "97": {
                "beforePatchRowNumber": 246,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if self.hosted_domain:"
            },
            "98": {
                "beforePatchRowNumber": 247,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if user_domain not in self.hosted_domain:"
            },
            "99": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                message = f\"Login with domain @{user_domain} is not allowed\""
            },
            "100": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                self.log.warning(message)"
            },
            "101": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                raise HTTPError(403, message)"
            },
            "102": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "103": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": 280,
                "PatchRowcode": "         if await super().check_allowed(username, auth_model):"
            },
            "104": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": 281,
                "PatchRowcode": "             return True"
            },
            "105": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": 282,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "\"\"\"",
            "A JupyterHub authenticator class for use with Google as an identity provider.",
            "\"\"\"",
            "",
            "import os",
            "",
            "from jupyterhub.auth import LocalAuthenticator",
            "from tornado.auth import GoogleOAuth2Mixin",
            "from tornado.web import HTTPError",
            "from traitlets import Dict, List, Set, Unicode, default, validate",
            "",
            "from .oauth2 import OAuthenticator",
            "",
            "",
            "class GoogleOAuthenticator(OAuthenticator, GoogleOAuth2Mixin):",
            "    user_auth_state_key = \"google_user\"",
            "",
            "    @default(\"login_service\")",
            "    def _login_service_default(self):",
            "        return os.environ.get(\"LOGIN_SERVICE\", \"Google\")",
            "",
            "    @default(\"scope\")",
            "    def _scope_default(self):",
            "        return [\"openid\", \"email\"]",
            "",
            "    @default(\"username_claim\")",
            "    def _username_claim_default(self):",
            "        return \"email\"",
            "",
            "    @default(\"authorize_url\")",
            "    def _authorize_url_default(self):",
            "        return \"https://accounts.google.com/o/oauth2/v2/auth\"",
            "",
            "    google_api_url = Unicode(",
            "        config=True,",
            "        help=\"\"\"",
            "        Used to determine the default values for `token_url` and `userdata_url`.",
            "        \"\"\",",
            "    )",
            "",
            "    @default(\"google_api_url\")",
            "    def _google_api_url(self):",
            "        \"\"\"get default google apis url from env\"\"\"",
            "        google_api_url = os.getenv('GOOGLE_API_URL')",
            "",
            "        # default to googleapis.com",
            "        if not google_api_url:",
            "            google_api_url = 'https://www.googleapis.com'",
            "",
            "        return google_api_url",
            "",
            "    @default(\"token_url\")",
            "    def _token_url_default(self):",
            "        return f\"{self.google_api_url}/oauth2/v4/token\"",
            "",
            "    @default(\"userdata_url\")",
            "    def _userdata_url_default(self):",
            "        return f\"{self.google_api_url}/oauth2/v1/userinfo\"",
            "",
            "    google_service_account_keys = Dict(",
            "        Unicode(),",
            "        config=True,",
            "        help=\"\"\"",
            "        Service account keys to use with each domain, see https://developers.google.com/admin-sdk/directory/v1/guides/delegation",
            "",
            "        Required if and only if `allowed_google_groups` or `admin_google_groups`",
            "        is configured.",
            "        \"\"\",",
            "    )",
            "",
            "    gsuite_administrator = Dict(",
            "        Unicode(),",
            "        config=True,",
            "        help=\"\"\"",
            "        Username of a G Suite Administrator for the service account to act as.",
            "",
            "        Required if and only if `allowed_google_groups` or `admin_google_groups`",
            "        is configured.",
            "        \"\"\",",
            "    )",
            "",
            "    allowed_google_groups = Dict(",
            "        Set(Unicode()),",
            "        config=True,",
            "        help=\"\"\"",
            "        Allow members of selected Google groups to sign in.",
            "",
            "        Use of this requires configuration of `gsuite_administrator` and",
            "        `google_service_account_keys`.",
            "        \"\"\",",
            "    )",
            "",
            "    admin_google_groups = Dict(",
            "        Set(Unicode()),",
            "        config=True,",
            "        help=\"\"\"",
            "        Allow members of selected Google groups to sign in and consider them as",
            "        JupyterHub admins.",
            "",
            "        If this is set and a user isn't part of one of these groups or listed in",
            "        `admin_users`, a user signing in will have their admin status revoked.",
            "",
            "        Use of this requires configuration of `gsuite_administrator` and",
            "        `google_service_account_keys`.",
            "        \"\"\",",
            "    )",
            "",
            "    hosted_domain = List(",
            "        Unicode(),",
            "        config=True,",
            "        help=\"\"\"",
            "        This config has two functions.",
            "",
            "        1. Restrict sign-in to a list of email domain names, such as",
            "           `[\"mycollege.edu\"]` or `[\"college1.edu\", \"college2.edu\"]`.",
            "        2. If a single domain is specified, the username will be stripped to exclude the `@domain` part.",
            "",
            "        Note that users with email domains in this list must still be allowed",
            "        via another config, such as `allow_all`, `allowed_users`, or",
            "        `allowed_google_groups`.",
            "",
            "        ```{warning} Disruptive config changes",
            "        Changing this config either to or from having a single entry is a",
            "        disruptive change as the same Google user will get a new username,",
            "        either without or with a domain name included.",
            "        ```",
            "        \"\"\",",
            "    )",
            "",
            "    @default('hosted_domain')",
            "    def _hosted_domain_from_env(self):",
            "        domains = []",
            "        for domain in os.environ.get('HOSTED_DOMAIN', '').lower().split(';'):",
            "            if domain:",
            "                # check falsy to avoid trailing separators",
            "                # adding empty domains",
            "                domains.append(domain)",
            "        return domains",
            "",
            "    @validate('hosted_domain')",
            "    def _cast_hosted_domain(self, proposal):",
            "        \"\"\"handle backward-compatibility with hosted_domain is a single domain as a string\"\"\"",
            "        if isinstance(proposal.value, str):",
            "            # pre-0.9 hosted_domain was a string",
            "            # set it to a single item list",
            "            # (or if it's empty, an empty list)",
            "            if proposal.value == '':",
            "                return []",
            "            return [proposal.value.lower()]",
            "        return [hd.lower() for hd in proposal.value]",
            "",
            "    # _deprecated_oauth_aliases is used by deprecation logic in OAuthenticator",
            "    _deprecated_oauth_aliases = {",
            "        \"google_group_whitelist\": (\"allowed_google_groups\", \"0.12.0\"),",
            "        **OAuthenticator._deprecated_oauth_aliases,",
            "    }",
            "    google_group_whitelist = Dict(",
            "        config=True,",
            "        help=\"\"\"",
            "        .. deprecated:: 0.12",
            "",
            "           Use :attr:`allowed_google_groups`.",
            "        \"\"\",",
            "    )",
            "",
            "    def user_info_to_username(self, user_info):",
            "        \"\"\"",
            "        Overrides the default implementation to conditionally also strip the",
            "        user email's domain name from the username based on the hosted_domain",
            "        configuration. The domain saved to user_info for use by authorization",
            "        logic.",
            "        \"\"\"",
            "        username = super().user_info_to_username(user_info)",
            "        user_email = user_info[\"email\"]",
            "        user_domain = user_info[\"domain\"] = user_email.split(\"@\")[1].lower()",
            "",
            "        if len(self.hosted_domain) == 1 and self.hosted_domain[0] == user_domain:",
            "            # unambiguous domain, use only base name",
            "            username = username.split(\"@\")[0]",
            "",
            "        return username",
            "",
            "    async def update_auth_model(self, auth_model):",
            "        \"\"\"",
            "        Fetch and store `google_groups` in auth state if `allowed_google_groups`",
            "        or `admin_google_groups` is configured.",
            "",
            "        Sets admin status to True or False if `admin_google_groups` is",
            "        configured and the user isn't part of `admin_users`. Note that leaving",
            "        it at None makes users able to retain an admin status while setting it",
            "        to False makes it be revoked.",
            "",
            "        Strips the domain from the username if `hosted_domain` is configured",
            "        with a single entry.",
            "        \"\"\"",
            "        user_info = auth_model[\"auth_state\"][self.user_auth_state_key]",
            "        user_email = user_info[\"email\"]",
            "        user_domain = user_info[\"domain\"]",
            "",
            "        user_groups = set()",
            "        if self.allowed_google_groups or self.admin_google_groups:",
            "            user_groups = self._fetch_user_groups(user_email, user_domain)",
            "        # sets are not JSONable, cast to list for auth_state",
            "        user_info[\"google_groups\"] = list(user_groups)",
            "",
            "        if auth_model[\"admin\"]:",
            "            # auth_model[\"admin\"] being True means the user was in admin_users",
            "            return auth_model",
            "",
            "        if self.admin_google_groups:",
            "            # admin status should in this case be True or False, not None",
            "            admin_groups = self.admin_google_groups.get(user_domain, set())",
            "            auth_model[\"admin\"] = bool(user_groups & admin_groups)",
            "",
            "        return auth_model",
            "",
            "    async def check_allowed(self, username, auth_model):",
            "        \"\"\"",
            "        Overrides the OAuthenticator.check_allowed to also allow users part of",
            "        `allowed_google_groups`.",
            "        \"\"\"",
            "        # A workaround for JupyterHub < 5.0 described in",
            "        # https://github.com/jupyterhub/oauthenticator/issues/621",
            "        if auth_model is None:",
            "            return True",
            "",
            "        # before considering allowing a username by being recognized in a list",
            "        # of usernames or similar, we must ensure that the authenticated user",
            "        # has a verified email and is part of hosted_domain if configured.",
            "        user_info = auth_model[\"auth_state\"][self.user_auth_state_key]",
            "        user_email = user_info[\"email\"]",
            "        user_domain = user_info[\"domain\"]",
            "",
            "        if not user_info[\"verified_email\"]:",
            "            message = f\"Login with unverified email {user_email} is not allowed\"",
            "            self.log.warning(message)",
            "            raise HTTPError(403, message)",
            "",
            "        # NOTE: If hosted_domain is configured as [\"a.com\", \"b.com\"], and",
            "        #       allowed_google_groups is declared as {\"a.com\": {\"a-group\"}}, a",
            "        #       \"b.com\" user won't be authorized unless allowed in another way.",
            "        #",
            "        #       This means that its not possible to allow all users of a given",
            "        #       domain if one wants to restrict another.",
            "        #",
            "        if self.hosted_domain:",
            "            if user_domain not in self.hosted_domain:",
            "                message = f\"Login with domain @{user_domain} is not allowed\"",
            "                self.log.warning(message)",
            "                raise HTTPError(403, message)",
            "",
            "        if await super().check_allowed(username, auth_model):",
            "            return True",
            "",
            "        if self.allowed_google_groups:",
            "            user_groups = set(user_info[\"google_groups\"])",
            "            allowed_groups = self.allowed_google_groups.get(user_domain, set())",
            "            if user_groups & allowed_groups:",
            "                return True",
            "",
            "        # users should be explicitly allowed via config, otherwise they aren't",
            "        return False",
            "",
            "    def _service_client_credentials(self, scopes, user_email_domain):",
            "        \"\"\"",
            "        Return a configured service client credentials for the API.",
            "        \"\"\"",
            "        try:",
            "            from google.oauth2 import service_account",
            "        except:",
            "            raise ImportError(",
            "                \"Could not import google.oauth2's service_account,\"",
            "                \"you may need to run 'pip install oauthenticator[googlegroups]' or not declare google groups\"",
            "            )",
            "",
            "        gsuite_administrator_email = \"{}@{}\".format(",
            "            self.gsuite_administrator[user_email_domain], user_email_domain",
            "        )",
            "        self.log.debug(f\"scopes are {scopes}, user_email_domain is {user_email_domain}\")",
            "        credentials = service_account.Credentials.from_service_account_file(",
            "            self.google_service_account_keys[user_email_domain], scopes=scopes",
            "        )",
            "",
            "        credentials = credentials.with_subject(gsuite_administrator_email)",
            "",
            "        return credentials",
            "",
            "    def _service_client(self, service_name, service_version, credentials, http=None):",
            "        \"\"\"",
            "        Return a configured service client for the API.",
            "        \"\"\"",
            "        try:",
            "            from googleapiclient.discovery import build",
            "        except:",
            "            raise ImportError(",
            "                \"Could not import googleapiclient.discovery's build,\"",
            "                \"you may need to run 'pip install oauthenticator[googlegroups]' or not declare google groups\"",
            "            )",
            "",
            "        self.log.debug(",
            "            f\"service_name is {service_name}, service_version is {service_version}\"",
            "        )",
            "",
            "        return build(",
            "            serviceName=service_name,",
            "            version=service_version,",
            "            credentials=credentials,",
            "            cache_discovery=False,",
            "            http=http,",
            "        )",
            "",
            "    def _fetch_user_groups(self, user_email, user_email_domain, http=None):",
            "        \"\"\"",
            "        Return a set with the google groups a given user is a member of",
            "        \"\"\"",
            "        # FIXME: When this function is used and waiting for web request",
            "        #        responses, JupyterHub gets blocked from doing other things.",
            "        #        Ideally the web requests should be made using an async client",
            "        #        that can be awaited while JupyterHub handles other things.",
            "        #",
            "        credentials = self._service_client_credentials(",
            "            scopes=[f\"{self.google_api_url}/auth/admin.directory.group.readonly\"],",
            "            user_email_domain=user_email_domain,",
            "        )",
            "        service = self._service_client(",
            "            service_name='admin',",
            "            service_version='directory_v1',",
            "            credentials=credentials,",
            "            http=http,",
            "        )",
            "",
            "        resp = service.groups().list(userKey=user_email).execute()",
            "        user_groups = {",
            "            g['email'].split('@')[0] for g in resp.get('groups', [{'email': None}])",
            "        }",
            "        self.log.debug(f\"user_email {user_email} is a member of {user_groups}\")",
            "        return user_groups",
            "",
            "",
            "class LocalGoogleOAuthenticator(LocalAuthenticator, GoogleOAuthenticator):",
            "    \"\"\"A version that mixes in local system user creation\"\"\""
        ],
        "afterPatchFile": [
            "\"\"\"",
            "A JupyterHub authenticator class for use with Google as an identity provider.",
            "\"\"\"",
            "",
            "import os",
            "",
            "from jupyterhub.auth import LocalAuthenticator",
            "from tornado.auth import GoogleOAuth2Mixin",
            "from tornado.web import HTTPError",
            "from traitlets import Dict, List, Set, Unicode, default, validate",
            "",
            "from .oauth2 import OAuthenticator",
            "",
            "",
            "class GoogleOAuthenticator(OAuthenticator, GoogleOAuth2Mixin):",
            "    user_auth_state_key = \"google_user\"",
            "",
            "    @default(\"login_service\")",
            "    def _login_service_default(self):",
            "        return os.environ.get(\"LOGIN_SERVICE\", \"Google\")",
            "",
            "    @default(\"scope\")",
            "    def _scope_default(self):",
            "        return [\"openid\", \"email\"]",
            "",
            "    @default(\"username_claim\")",
            "    def _username_claim_default(self):",
            "        return \"email\"",
            "",
            "    @default(\"authorize_url\")",
            "    def _authorize_url_default(self):",
            "        return \"https://accounts.google.com/o/oauth2/v2/auth\"",
            "",
            "    google_api_url = Unicode(",
            "        config=True,",
            "        help=\"\"\"",
            "        Used to determine the default values for `token_url` and `userdata_url`.",
            "        \"\"\",",
            "    )",
            "",
            "    @default(\"google_api_url\")",
            "    def _google_api_url(self):",
            "        \"\"\"get default google apis url from env\"\"\"",
            "        google_api_url = os.getenv('GOOGLE_API_URL')",
            "",
            "        # default to googleapis.com",
            "        if not google_api_url:",
            "            google_api_url = 'https://www.googleapis.com'",
            "",
            "        return google_api_url",
            "",
            "    @default(\"token_url\")",
            "    def _token_url_default(self):",
            "        return f\"{self.google_api_url}/oauth2/v4/token\"",
            "",
            "    @default(\"userdata_url\")",
            "    def _userdata_url_default(self):",
            "        return f\"{self.google_api_url}/oauth2/v1/userinfo\"",
            "",
            "    google_service_account_keys = Dict(",
            "        Unicode(),",
            "        config=True,",
            "        help=\"\"\"",
            "        Service account keys to use with each domain, see https://developers.google.com/admin-sdk/directory/v1/guides/delegation",
            "",
            "        Required if and only if `allowed_google_groups` or `admin_google_groups`",
            "        is configured.",
            "        \"\"\",",
            "    )",
            "",
            "    gsuite_administrator = Dict(",
            "        Unicode(),",
            "        config=True,",
            "        help=\"\"\"",
            "        Username of a G Suite Administrator for the service account to act as.",
            "",
            "        Required if and only if `allowed_google_groups` or `admin_google_groups`",
            "        is configured.",
            "        \"\"\",",
            "    )",
            "",
            "    allowed_google_groups = Dict(",
            "        Set(Unicode()),",
            "        config=True,",
            "        help=\"\"\"",
            "        Allow members of selected Google groups to sign in.",
            "",
            "        Use of this requires configuration of `gsuite_administrator` and",
            "        `google_service_account_keys`.",
            "        \"\"\",",
            "    )",
            "",
            "    admin_google_groups = Dict(",
            "        Set(Unicode()),",
            "        config=True,",
            "        help=\"\"\"",
            "        Allow members of selected Google groups to sign in and consider them as",
            "        JupyterHub admins.",
            "",
            "        If this is set and a user isn't part of one of these groups or listed in",
            "        `admin_users`, a user signing in will have their admin status revoked.",
            "",
            "        Use of this requires configuration of `gsuite_administrator` and",
            "        `google_service_account_keys`.",
            "        \"\"\",",
            "    )",
            "",
            "    hosted_domain = List(",
            "        Unicode(),",
            "        config=True,",
            "        help=\"\"\"",
            "        This config has two functions.",
            "",
            "        1. Restrict sign-in to users part of Google organizations/workspaces",
            "           managing domains, such as `[\"mycollege.edu\"]` or `[\"college1.edu\",",
            "           \"college2.edu\"]`.",
            "        2. If a single domain is specified, usernames with that domain will be",
            "           stripped to exclude the `@domain` part.",
            "",
            "        Users not restricted by this configuration must still be explicitly",
            "        allowed by a configuration intended to allow users, like `allow_all`,",
            "        `allowed_users`, or `allowed_google_groups`.",
            "",
            "        .. warning::",
            "",
            "           Changing this config either to or from having a single entry is a",
            "           disruptive change as the same Google user will get a new username,",
            "           either without or with a domain name included.",
            "        :::",
            "",
            "        .. versionchanged:: 16.1",
            "",
            "           Now restricts sign-in based on the hd claim, not the domain in the",
            "           user's email.",
            "        \"\"\",",
            "    )",
            "",
            "    @default('hosted_domain')",
            "    def _hosted_domain_from_env(self):",
            "        domains = []",
            "        for domain in os.environ.get('HOSTED_DOMAIN', '').lower().split(';'):",
            "            if domain:",
            "                # check falsy to avoid trailing separators",
            "                # adding empty domains",
            "                domains.append(domain)",
            "        return domains",
            "",
            "    @validate('hosted_domain')",
            "    def _cast_hosted_domain(self, proposal):",
            "        \"\"\"handle backward-compatibility with hosted_domain is a single domain as a string\"\"\"",
            "        if isinstance(proposal.value, str):",
            "            # pre-0.9 hosted_domain was a string",
            "            # set it to a single item list",
            "            # (or if it's empty, an empty list)",
            "            if proposal.value == '':",
            "                return []",
            "            return [proposal.value.lower()]",
            "        return [hd.lower() for hd in proposal.value]",
            "",
            "    # _deprecated_oauth_aliases is used by deprecation logic in OAuthenticator",
            "    _deprecated_oauth_aliases = {",
            "        \"google_group_whitelist\": (\"allowed_google_groups\", \"0.12.0\"),",
            "        **OAuthenticator._deprecated_oauth_aliases,",
            "    }",
            "    google_group_whitelist = Dict(",
            "        config=True,",
            "        help=\"\"\"",
            "        .. deprecated:: 0.12",
            "",
            "           Use :attr:`allowed_google_groups`.",
            "        \"\"\",",
            "    )",
            "",
            "    def user_info_to_username(self, user_info):",
            "        \"\"\"",
            "        Overrides the default implementation to conditionally also strip the",
            "        user email's domain name from the username based on the hosted_domain",
            "        configuration. The domain saved to user_info for use by authorization",
            "        logic.",
            "        \"\"\"",
            "        username = super().user_info_to_username(user_info)",
            "        user_email = user_info[\"email\"]",
            "        user_domain = user_info[\"domain\"] = user_email.split(\"@\")[1].lower()",
            "",
            "        # NOTE: This is not an authorization check, it just about username",
            "        #       derivation. Decoupling hosted_domain from this is considered in",
            "        #       https://github.com/jupyterhub/oauthenticator/issues/733.",
            "        #",
            "        # NOTE: This code is written with without knowing for sure if the user",
            "        #       email's domain could be different from the domain in hd, so we",
            "        #       assume it could be even though it seems like it can't be. If a",
            "        #       Google organization/workspace manages users in a \"primary",
            "        #       domain\" and a \"secondary domain\", users with respective email",
            "        #       domain have their hd field set respectively.",
            "        #",
            "        if len(self.hosted_domain) == 1 and user_domain == self.hosted_domain[0]:",
            "            # strip the domain in this situation",
            "            username = username.split(\"@\")[0]",
            "",
            "        return username",
            "",
            "    async def update_auth_model(self, auth_model):",
            "        \"\"\"",
            "        Fetch and store `google_groups` in auth state if `allowed_google_groups`",
            "        or `admin_google_groups` is configured.",
            "",
            "        Sets admin status to True or False if `admin_google_groups` is",
            "        configured and the user isn't part of `admin_users`. Note that leaving",
            "        it at None makes users able to retain an admin status while setting it",
            "        to False makes it be revoked.",
            "",
            "        Strips the domain from the username if `hosted_domain` is configured",
            "        with a single entry.",
            "        \"\"\"",
            "        user_info = auth_model[\"auth_state\"][self.user_auth_state_key]",
            "        user_email = user_info[\"email\"]",
            "        user_domain = user_info[\"domain\"]",
            "",
            "        user_groups = set()",
            "        if self.allowed_google_groups or self.admin_google_groups:",
            "            user_groups = self._fetch_user_groups(user_email, user_domain)",
            "        # sets are not JSONable, cast to list for auth_state",
            "        user_info[\"google_groups\"] = list(user_groups)",
            "",
            "        if auth_model[\"admin\"]:",
            "            # auth_model[\"admin\"] being True means the user was in admin_users",
            "            return auth_model",
            "",
            "        if self.admin_google_groups:",
            "            # admin status should in this case be True or False, not None",
            "            admin_groups = self.admin_google_groups.get(user_domain, set())",
            "            auth_model[\"admin\"] = bool(user_groups & admin_groups)",
            "",
            "        return auth_model",
            "",
            "    def check_blocked_users(self, username, auth_model):",
            "        \"\"\"",
            "        Overrides `Authenticator.check_blocked_users` to not only block users in",
            "        `Authenticator.blocked_users`, but to also enforce",
            "        `GoogleOAuthenticator.hosted_domain` if its configured.",
            "",
            "        When hosted_domain is configured, users are required to be part of",
            "        listed Google organizations/workspaces.",
            "",
            "        Returns False if the user is blocked, otherwise True.",
            "        \"\"\"",
            "        user_info = auth_model[\"auth_state\"][self.user_auth_state_key]",
            "",
            "        # hd ref: https://developers.google.com/identity/openid-connect/openid-connect#id_token-hd",
            "        hd = user_info.get(\"hd\", \"\")",
            "",
            "        if self.hosted_domain and hd not in self.hosted_domain:",
            "            self.log.warning(f\"Blocked {username} with 'hd={hd}' not in hosted_domain\")",
            "            return False",
            "",
            "        return super().check_blocked_users(username, auth_model)",
            "",
            "    async def check_allowed(self, username, auth_model):",
            "        \"\"\"",
            "        Overrides the OAuthenticator.check_allowed to also allow users part of",
            "        `allowed_google_groups`.",
            "        \"\"\"",
            "        # A workaround for JupyterHub < 5.0 described in",
            "        # https://github.com/jupyterhub/oauthenticator/issues/621",
            "        if auth_model is None:",
            "            return True",
            "",
            "        # before considering allowing a username by being recognized in a list",
            "        # of usernames or similar, we must ensure that the authenticated user",
            "        # has a verified email and is part of hosted_domain if configured.",
            "        user_info = auth_model[\"auth_state\"][self.user_auth_state_key]",
            "        user_email = user_info[\"email\"]",
            "        user_domain = user_info[\"domain\"]",
            "",
            "        if not user_info[\"verified_email\"]:",
            "            message = f\"Login with unverified email {user_email} is not allowed\"",
            "            self.log.warning(message)",
            "            raise HTTPError(403, message)",
            "",
            "        if await super().check_allowed(username, auth_model):",
            "            return True",
            "",
            "        if self.allowed_google_groups:",
            "            user_groups = set(user_info[\"google_groups\"])",
            "            allowed_groups = self.allowed_google_groups.get(user_domain, set())",
            "            if user_groups & allowed_groups:",
            "                return True",
            "",
            "        # users should be explicitly allowed via config, otherwise they aren't",
            "        return False",
            "",
            "    def _service_client_credentials(self, scopes, user_email_domain):",
            "        \"\"\"",
            "        Return a configured service client credentials for the API.",
            "        \"\"\"",
            "        try:",
            "            from google.oauth2 import service_account",
            "        except:",
            "            raise ImportError(",
            "                \"Could not import google.oauth2's service_account,\"",
            "                \"you may need to run 'pip install oauthenticator[googlegroups]' or not declare google groups\"",
            "            )",
            "",
            "        gsuite_administrator_email = \"{}@{}\".format(",
            "            self.gsuite_administrator[user_email_domain], user_email_domain",
            "        )",
            "        self.log.debug(f\"scopes are {scopes}, user_email_domain is {user_email_domain}\")",
            "        credentials = service_account.Credentials.from_service_account_file(",
            "            self.google_service_account_keys[user_email_domain], scopes=scopes",
            "        )",
            "",
            "        credentials = credentials.with_subject(gsuite_administrator_email)",
            "",
            "        return credentials",
            "",
            "    def _service_client(self, service_name, service_version, credentials, http=None):",
            "        \"\"\"",
            "        Return a configured service client for the API.",
            "        \"\"\"",
            "        try:",
            "            from googleapiclient.discovery import build",
            "        except:",
            "            raise ImportError(",
            "                \"Could not import googleapiclient.discovery's build,\"",
            "                \"you may need to run 'pip install oauthenticator[googlegroups]' or not declare google groups\"",
            "            )",
            "",
            "        self.log.debug(",
            "            f\"service_name is {service_name}, service_version is {service_version}\"",
            "        )",
            "",
            "        return build(",
            "            serviceName=service_name,",
            "            version=service_version,",
            "            credentials=credentials,",
            "            cache_discovery=False,",
            "            http=http,",
            "        )",
            "",
            "    def _fetch_user_groups(self, user_email, user_email_domain, http=None):",
            "        \"\"\"",
            "        Return a set with the google groups a given user is a member of",
            "        \"\"\"",
            "        # FIXME: When this function is used and waiting for web request",
            "        #        responses, JupyterHub gets blocked from doing other things.",
            "        #        Ideally the web requests should be made using an async client",
            "        #        that can be awaited while JupyterHub handles other things.",
            "        #",
            "        credentials = self._service_client_credentials(",
            "            scopes=[f\"{self.google_api_url}/auth/admin.directory.group.readonly\"],",
            "            user_email_domain=user_email_domain,",
            "        )",
            "        service = self._service_client(",
            "            service_name='admin',",
            "            service_version='directory_v1',",
            "            credentials=credentials,",
            "            http=http,",
            "        )",
            "",
            "        resp = service.groups().list(userKey=user_email).execute()",
            "        user_groups = {",
            "            g['email'].split('@')[0] for g in resp.get('groups', [{'email': None}])",
            "        }",
            "        self.log.debug(f\"user_email {user_email} is a member of {user_groups}\")",
            "        return user_groups",
            "",
            "",
            "class LocalGoogleOAuthenticator(LocalAuthenticator, GoogleOAuthenticator):",
            "    \"\"\"A version that mixes in local system user creation\"\"\""
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "114": [
                "GoogleOAuthenticator"
            ],
            "115": [
                "GoogleOAuthenticator"
            ],
            "116": [
                "GoogleOAuthenticator"
            ],
            "118": [
                "GoogleOAuthenticator"
            ],
            "119": [
                "GoogleOAuthenticator"
            ],
            "120": [
                "GoogleOAuthenticator"
            ],
            "122": [
                "GoogleOAuthenticator"
            ],
            "123": [
                "GoogleOAuthenticator"
            ],
            "124": [
                "GoogleOAuthenticator"
            ],
            "125": [
                "GoogleOAuthenticator"
            ],
            "126": [
                "GoogleOAuthenticator"
            ],
            "177": [
                "GoogleOAuthenticator",
                "user_info_to_username"
            ],
            "178": [
                "GoogleOAuthenticator",
                "user_info_to_username"
            ],
            "239": [
                "GoogleOAuthenticator"
            ],
            "240": [
                "GoogleOAuthenticator"
            ],
            "241": [
                "GoogleOAuthenticator"
            ],
            "242": [
                "GoogleOAuthenticator"
            ],
            "243": [
                "GoogleOAuthenticator"
            ],
            "244": [
                "GoogleOAuthenticator"
            ],
            "245": [
                "GoogleOAuthenticator"
            ],
            "246": [
                "GoogleOAuthenticator"
            ],
            "247": [
                "GoogleOAuthenticator"
            ],
            "248": [
                "GoogleOAuthenticator"
            ],
            "249": [
                "GoogleOAuthenticator"
            ],
            "250": [
                "GoogleOAuthenticator"
            ],
            "251": [
                "GoogleOAuthenticator"
            ]
        },
        "addLocation": []
    },
    "oauthenticator/tests/test_google.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from unittest import mock"
            },
            "1": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from pytest import fixture, mark, raises"
            },
            "3": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from tornado.web import HTTPError"
            },
            "4": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from traitlets.config import Config"
            },
            "5": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from ..google import GoogleOAuthenticator"
            },
            "7": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from .mocks import setup_oauth_mock"
            },
            "8": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def user_model(email, username=\"user1\"):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+def user_model(email, username=\"user1\", hd=None):"
            },
            "12": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 15,
                "PatchRowcode": "     \"\"\"Return a user model\"\"\""
            },
            "13": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    return {"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 16,
                "PatchRowcode": "+    model = {"
            },
            "15": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 17,
                "PatchRowcode": "         'sub': hashlib.md5(email.encode()).hexdigest(),"
            },
            "16": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 18,
                "PatchRowcode": "         'email': email,"
            },
            "17": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 19,
                "PatchRowcode": "         'custom': username,"
            },
            "18": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        'hd': email.split('@')[1],"
            },
            "19": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 20,
                "PatchRowcode": "         'verified_email': True,"
            },
            "20": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 21,
                "PatchRowcode": "     }"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+    if hd:"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+        model['hd'] = hd"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+    return model"
            },
            "24": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " "
            },
            "25": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " @fixture"
            },
            "27": {
                "beforePatchRowNumber": 187,
                "afterPatchRowNumber": 188,
                "PatchRowcode": "         assert auth_model == None"
            },
            "28": {
                "beforePatchRowNumber": 188,
                "afterPatchRowNumber": 189,
                "PatchRowcode": " "
            },
            "29": {
                "beforePatchRowNumber": 189,
                "afterPatchRowNumber": 190,
                "PatchRowcode": " "
            },
            "30": {
                "beforePatchRowNumber": 190,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-async def test_hosted_domain_single_entry(google_client):"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 191,
                "PatchRowcode": "+@mark.parametrize("
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 192,
                "PatchRowcode": "+    \"test_variation_id,user_email,user_hd,expect_username,expect_allowed,expect_admin\","
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 193,
                "PatchRowcode": "+    ["
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 194,
                "PatchRowcode": "+        (\"01\", \"user1@ok-hd.orG\", \"ok-hd.org\", \"user1\", True, True),"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 195,
                "PatchRowcode": "+        (\"02\", \"user2@ok-hd.orG\", \"ok-hd.org\", \"user2\", True, None),"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 196,
                "PatchRowcode": "+        (\"03\", \"blocked@ok-hd.org\", \"ok-hd.org\", None, False, None),"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 197,
                "PatchRowcode": "+        (\"04\", \"user2@ok-hd.org\", \"\", None, False, None),"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 198,
                "PatchRowcode": "+        (\"05\", \"user1@not-ok.org\", \"\", None, False, None),"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 199,
                "PatchRowcode": "+        # Test variation 06 below isn't believed to be possible, but since we"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 200,
                "PatchRowcode": "+        # aren't sure this test clarifies what we expect to happen."
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 201,
                "PatchRowcode": "+        (\"06\", \"user1@other.org\", \"ok-hd.org\", \"user1@other.org\", True, None),"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 202,
                "PatchRowcode": "+    ],"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 203,
                "PatchRowcode": "+)"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 204,
                "PatchRowcode": "+async def test_hosted_domain_single_entry("
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 205,
                "PatchRowcode": "+    google_client,"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 206,
                "PatchRowcode": "+    test_variation_id,"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 207,
                "PatchRowcode": "+    user_email,"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 208,
                "PatchRowcode": "+    user_hd,"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 209,
                "PatchRowcode": "+    expect_username,"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 210,
                "PatchRowcode": "+    expect_allowed,"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 211,
                "PatchRowcode": "+    expect_admin,"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 212,
                "PatchRowcode": "+):"
            },
            "53": {
                "beforePatchRowNumber": 191,
                "afterPatchRowNumber": 213,
                "PatchRowcode": "     \"\"\""
            },
            "54": {
                "beforePatchRowNumber": 192,
                "afterPatchRowNumber": 214,
                "PatchRowcode": "     Tests that sign in is restricted to the listed domain and that the username"
            },
            "55": {
                "beforePatchRowNumber": 193,
                "afterPatchRowNumber": 215,
                "PatchRowcode": "     represents the part before the `@domain.com` as expected when hosted_domain"
            },
            "56": {
                "beforePatchRowNumber": 194,
                "afterPatchRowNumber": 216,
                "PatchRowcode": "     contains a single entry."
            },
            "57": {
                "beforePatchRowNumber": 195,
                "afterPatchRowNumber": 217,
                "PatchRowcode": "     \"\"\""
            },
            "58": {
                "beforePatchRowNumber": 196,
                "afterPatchRowNumber": 218,
                "PatchRowcode": "     c = Config()"
            },
            "59": {
                "beforePatchRowNumber": 197,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    c.GoogleOAuthenticator.hosted_domain = [\"In-Hosted-Domain.com\"]"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 219,
                "PatchRowcode": "+    c.GoogleOAuthenticator.hosted_domain = [\"ok-hd.org\"]"
            },
            "61": {
                "beforePatchRowNumber": 198,
                "afterPatchRowNumber": 220,
                "PatchRowcode": "     c.GoogleOAuthenticator.admin_users = {\"user1\"}"
            },
            "62": {
                "beforePatchRowNumber": 199,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    c.GoogleOAuthenticator.allowed_users = {\"user2\"}"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 221,
                "PatchRowcode": "+    c.GoogleOAuthenticator.allowed_users = {\"user2\", \"blocked\", \"user1@other.org\"}"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 222,
                "PatchRowcode": "+    c.GoogleOAuthenticator.blocked_users = {\"blocked\"}"
            },
            "65": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": 223,
                "PatchRowcode": "     authenticator = GoogleOAuthenticator(config=c)"
            },
            "66": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": 224,
                "PatchRowcode": " "
            },
            "67": {
                "beforePatchRowNumber": 202,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handled_user_model = user_model(\"user1@iN-hosteD-domaiN.com\")"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 225,
                "PatchRowcode": "+    handled_user_model = user_model(user_email, hd=user_hd)"
            },
            "69": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": 226,
                "PatchRowcode": "     handler = google_client.handler_for_user(handled_user_model)"
            },
            "70": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": 227,
                "PatchRowcode": "     auth_model = await authenticator.get_authenticated_user(handler, None)"
            },
            "71": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model"
            },
            "72": {
                "beforePatchRowNumber": 206,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model[\"name\"] == \"user1\""
            },
            "73": {
                "beforePatchRowNumber": 207,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model[\"admin\"] == True"
            },
            "74": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "75": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handled_user_model = user_model(\"user2@iN-hosteD-domaiN.com\")"
            },
            "76": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handler = google_client.handler_for_user(handled_user_model)"
            },
            "77": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    auth_model = await authenticator.get_authenticated_user(handler, None)"
            },
            "78": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model"
            },
            "79": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model[\"name\"] == \"user2\""
            },
            "80": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model[\"admin\"] == None"
            },
            "81": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "82": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handled_user_model = user_model(\"user1@not-in-hosted-domain.com\")"
            },
            "83": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handler = google_client.handler_for_user(handled_user_model)"
            },
            "84": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    with raises(HTTPError) as exc:"
            },
            "85": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        await authenticator.get_authenticated_user(handler, None)"
            },
            "86": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert exc.value.status_code == 403"
            },
            "87": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 228,
                "PatchRowcode": "+    if expect_allowed:"
            },
            "88": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 229,
                "PatchRowcode": "+        assert auth_model"
            },
            "89": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 230,
                "PatchRowcode": "+        assert auth_model[\"name\"] == expect_username"
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 231,
                "PatchRowcode": "+        assert auth_model[\"admin\"] == expect_admin"
            },
            "91": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 232,
                "PatchRowcode": "+    else:"
            },
            "92": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 233,
                "PatchRowcode": "+        assert auth_model == None"
            },
            "93": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": 234,
                "PatchRowcode": " "
            },
            "94": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": 235,
                "PatchRowcode": " "
            },
            "95": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": 236,
                "PatchRowcode": " @mark.parametrize("
            },
            "96": {
                "beforePatchRowNumber": 235,
                "afterPatchRowNumber": 248,
                "PatchRowcode": "     assert await authenticator.check_allowed(name, None)"
            },
            "97": {
                "beforePatchRowNumber": 236,
                "afterPatchRowNumber": 249,
                "PatchRowcode": " "
            },
            "98": {
                "beforePatchRowNumber": 237,
                "afterPatchRowNumber": 250,
                "PatchRowcode": " "
            },
            "99": {
                "beforePatchRowNumber": 238,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-async def test_hosted_domain_multiple_entries(google_client):"
            },
            "100": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+@mark.parametrize("
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+    \"test_variation_id,user_email,user_hd,expect_username,expect_allowed\","
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+    ["
            },
            "103": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 254,
                "PatchRowcode": "+        (\"01\", \"user1@ok-hd1.orG\", \"ok-hd1.org\", \"user1@ok-hd1.org\", True),"
            },
            "104": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 255,
                "PatchRowcode": "+        (\"02\", \"user2@ok-hd2.orG\", \"ok-hd2.org\", \"user2@ok-hd2.org\", True),"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 256,
                "PatchRowcode": "+        (\"03\", \"blocked@ok-hd1.org\", \"ok-hd1.org\", None, False),"
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 257,
                "PatchRowcode": "+        (\"04\", \"user3@ok-hd1.org\", \"\", None, False),"
            },
            "107": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 258,
                "PatchRowcode": "+        (\"05\", \"user1@not-ok.org\", \"\", None, False),"
            },
            "108": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 259,
                "PatchRowcode": "+        # Test variation 06 below isn't believed to be possible, but since we"
            },
            "109": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 260,
                "PatchRowcode": "+        # aren't sure this test clarifies what we expect to happen."
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 261,
                "PatchRowcode": "+        (\"06\", \"user1@other.org\", \"ok-hd1.org\", \"user1@other.org\", True),"
            },
            "111": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 262,
                "PatchRowcode": "+    ],"
            },
            "112": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 263,
                "PatchRowcode": "+)"
            },
            "113": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 264,
                "PatchRowcode": "+async def test_hosted_domain_multiple_entries("
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 265,
                "PatchRowcode": "+    google_client,"
            },
            "115": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 266,
                "PatchRowcode": "+    test_variation_id,"
            },
            "116": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 267,
                "PatchRowcode": "+    user_email,"
            },
            "117": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 268,
                "PatchRowcode": "+    user_hd,"
            },
            "118": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 269,
                "PatchRowcode": "+    expect_username,"
            },
            "119": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 270,
                "PatchRowcode": "+    expect_allowed,"
            },
            "120": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 271,
                "PatchRowcode": "+):"
            },
            "121": {
                "beforePatchRowNumber": 239,
                "afterPatchRowNumber": 272,
                "PatchRowcode": "     \"\"\""
            },
            "122": {
                "beforePatchRowNumber": 240,
                "afterPatchRowNumber": 273,
                "PatchRowcode": "     Tests that sign in is restricted to the listed domains and that the username"
            },
            "123": {
                "beforePatchRowNumber": 241,
                "afterPatchRowNumber": 274,
                "PatchRowcode": "     represents the full email as expected when hosted_domain contains multiple"
            },
            "124": {
                "beforePatchRowNumber": 242,
                "afterPatchRowNumber": 275,
                "PatchRowcode": "     entries."
            },
            "125": {
                "beforePatchRowNumber": 243,
                "afterPatchRowNumber": 276,
                "PatchRowcode": "     \"\"\""
            },
            "126": {
                "beforePatchRowNumber": 244,
                "afterPatchRowNumber": 277,
                "PatchRowcode": "     c = Config()"
            },
            "127": {
                "beforePatchRowNumber": 245,
                "afterPatchRowNumber": 278,
                "PatchRowcode": "     c.GoogleOAuthenticator.hosted_domain = ["
            },
            "128": {
                "beforePatchRowNumber": 246,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"In-Hosted-Domain1.com\","
            },
            "129": {
                "beforePatchRowNumber": 247,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"In-Hosted-Domain2.com\","
            },
            "130": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 279,
                "PatchRowcode": "+        \"ok-hd1.org\","
            },
            "131": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 280,
                "PatchRowcode": "+        \"ok-hd2.ORG\","
            },
            "132": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": 281,
                "PatchRowcode": "     ]"
            },
            "133": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 282,
                "PatchRowcode": "+    c.GoogleOAuthenticator.blocked_users = [\"blocked@ok-hd1.org\"]"
            },
            "134": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": 283,
                "PatchRowcode": "     c.GoogleOAuthenticator.allow_all = True"
            },
            "135": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": 284,
                "PatchRowcode": "     authenticator = GoogleOAuthenticator(config=c)"
            },
            "136": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": 285,
                "PatchRowcode": " "
            },
            "137": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handled_user_model = user_model(\"user1@iN-hosteD-domaiN1.com\")"
            },
            "138": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 286,
                "PatchRowcode": "+    handled_user_model = user_model(user_email, hd=user_hd)"
            },
            "139": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": 287,
                "PatchRowcode": "     handler = google_client.handler_for_user(handled_user_model)"
            },
            "140": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": 288,
                "PatchRowcode": "     auth_model = await authenticator.get_authenticated_user(handler, None)"
            },
            "141": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model"
            },
            "142": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model[\"name\"] == \"user1@in-hosted-domain1.com\""
            },
            "143": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "144": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handled_user_model = user_model(\"user2@iN-hosteD-domaiN2.com\")"
            },
            "145": {
                "beforePatchRowNumber": 259,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handler = google_client.handler_for_user(handled_user_model)"
            },
            "146": {
                "beforePatchRowNumber": 260,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    auth_model = await authenticator.get_authenticated_user(handler, None)"
            },
            "147": {
                "beforePatchRowNumber": 261,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model"
            },
            "148": {
                "beforePatchRowNumber": 262,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert auth_model[\"name\"] == \"user2@in-hosted-domain2.com\""
            },
            "149": {
                "beforePatchRowNumber": 263,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "150": {
                "beforePatchRowNumber": 264,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handled_user_model = user_model(\"user1@not-in-hosted-domain.com\")"
            },
            "151": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    handler = google_client.handler_for_user(handled_user_model)"
            },
            "152": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    with raises(HTTPError) as exc:"
            },
            "153": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        await authenticator.get_authenticated_user(handler, None)"
            },
            "154": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    assert exc.value.status_code == 403"
            },
            "155": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 289,
                "PatchRowcode": "+    if expect_allowed:"
            },
            "156": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 290,
                "PatchRowcode": "+        assert auth_model"
            },
            "157": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 291,
                "PatchRowcode": "+        assert auth_model[\"name\"] == expect_username"
            },
            "158": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 292,
                "PatchRowcode": "+    else:"
            },
            "159": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 293,
                "PatchRowcode": "+        assert auth_model == None"
            },
            "160": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": 294,
                "PatchRowcode": " "
            },
            "161": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 295,
                "PatchRowcode": " "
            },
            "162": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": 296,
                "PatchRowcode": " @mark.parametrize("
            }
        },
        "frontPatchFile": [
            "import hashlib",
            "import json",
            "import logging",
            "import re",
            "from unittest import mock",
            "",
            "from pytest import fixture, mark, raises",
            "from tornado.web import HTTPError",
            "from traitlets.config import Config",
            "",
            "from ..google import GoogleOAuthenticator",
            "from .mocks import setup_oauth_mock",
            "",
            "",
            "def user_model(email, username=\"user1\"):",
            "    \"\"\"Return a user model\"\"\"",
            "    return {",
            "        'sub': hashlib.md5(email.encode()).hexdigest(),",
            "        'email': email,",
            "        'custom': username,",
            "        'hd': email.split('@')[1],",
            "        'verified_email': True,",
            "    }",
            "",
            "",
            "@fixture",
            "def google_client(client):",
            "    setup_oauth_mock(",
            "        client,",
            "        host=['accounts.google.com', 'www.googleapis.com'],",
            "        access_token_path=re.compile('^(/o/oauth2/token|/oauth2/v4/token)$'),",
            "        user_path='/oauth2/v1/userinfo',",
            "    )",
            "    return client",
            "",
            "",
            "@mark.parametrize(",
            "    \"test_variation_id,class_config,expect_allowed,expect_admin\",",
            "    [",
            "        # no allow config tested",
            "        (\"00\", {}, False, None),",
            "        # allow config, individually tested",
            "        (\"01\", {\"allow_all\": True}, True, None),",
            "        (\"02\", {\"allowed_users\": {\"user1\"}}, True, None),",
            "        (\"03\", {\"allowed_users\": {\"not-test-user\"}}, False, None),",
            "        (\"04\", {\"admin_users\": {\"user1\"}}, True, True),",
            "        (\"05\", {\"admin_users\": {\"not-test-user\"}}, False, None),",
            "        (\"06\", {\"allowed_google_groups\": {\"example.com\": {\"group1\"}}}, True, None),",
            "        (",
            "            \"07\",",
            "            {\"allowed_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}}},",
            "            False,",
            "            None,",
            "        ),",
            "        (\"08\", {\"admin_google_groups\": {\"example.com\": {\"group1\"}}}, True, True),",
            "        (",
            "            \"09\",",
            "            {\"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}}},",
            "            False,",
            "            False,",
            "        ),",
            "        # allow config, some combinations of two tested",
            "        (",
            "            \"10\",",
            "            {",
            "                \"allow_all\": False,",
            "                \"allowed_users\": {\"not-test-user\"},",
            "            },",
            "            False,",
            "            None,",
            "        ),",
            "        (",
            "            \"11\",",
            "            {",
            "                \"allowed_users\": {\"not-test-user\"},",
            "                \"admin_users\": {\"user1\"},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"12\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"group1\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"13\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"group1\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            True,",
            "            False,",
            "        ),",
            "        (",
            "            \"14\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"15\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            False,",
            "            False,",
            "        ),",
            "        (",
            "            \"16\",",
            "            {",
            "                \"admin_users\": {\"user1\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"17\",",
            "            {",
            "                \"admin_users\": {\"user1\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"18\",",
            "            {",
            "                \"admin_users\": {\"not-test-user\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"19\",",
            "            {",
            "                \"admin_users\": {\"not-test-user\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            False,",
            "            False,",
            "        ),",
            "    ],",
            ")",
            "async def test_google(",
            "    google_client,",
            "    test_variation_id,",
            "    class_config,",
            "    expect_allowed,",
            "    expect_admin,",
            "):",
            "    print(f\"Running test variation id {test_variation_id}\")",
            "    c = Config()",
            "    c.GoogleOAuthenticator = Config(class_config)",
            "    c.GoogleOAuthenticator.username_claim = \"custom\"",
            "    authenticator = GoogleOAuthenticator(config=c)",
            "",
            "    handled_user_model = user_model(\"user1@example.com\", \"user1\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    with mock.patch.object(",
            "        authenticator, \"_fetch_user_groups\", lambda *args: {\"group1\"}",
            "    ):",
            "        auth_model = await authenticator.get_authenticated_user(handler, None)",
            "",
            "    if expect_allowed:",
            "        assert auth_model",
            "        assert set(auth_model) == {\"name\", \"admin\", \"auth_state\"}",
            "        assert auth_model[\"admin\"] == expect_admin",
            "        auth_state = auth_model[\"auth_state\"]",
            "        assert json.dumps(auth_state)",
            "        assert \"access_token\" in auth_state",
            "        user_info = auth_state[authenticator.user_auth_state_key]",
            "        assert auth_model[\"name\"] == user_info[authenticator.username_claim]",
            "        if authenticator.allowed_google_groups or authenticator.admin_google_groups:",
            "            assert user_info[\"google_groups\"] == [\"group1\"]",
            "    else:",
            "        assert auth_model == None",
            "",
            "",
            "async def test_hosted_domain_single_entry(google_client):",
            "    \"\"\"",
            "    Tests that sign in is restricted to the listed domain and that the username",
            "    represents the part before the `@domain.com` as expected when hosted_domain",
            "    contains a single entry.",
            "    \"\"\"",
            "    c = Config()",
            "    c.GoogleOAuthenticator.hosted_domain = [\"In-Hosted-Domain.com\"]",
            "    c.GoogleOAuthenticator.admin_users = {\"user1\"}",
            "    c.GoogleOAuthenticator.allowed_users = {\"user2\"}",
            "    authenticator = GoogleOAuthenticator(config=c)",
            "",
            "    handled_user_model = user_model(\"user1@iN-hosteD-domaiN.com\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    auth_model = await authenticator.get_authenticated_user(handler, None)",
            "    assert auth_model",
            "    assert auth_model[\"name\"] == \"user1\"",
            "    assert auth_model[\"admin\"] == True",
            "",
            "    handled_user_model = user_model(\"user2@iN-hosteD-domaiN.com\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    auth_model = await authenticator.get_authenticated_user(handler, None)",
            "    assert auth_model",
            "    assert auth_model[\"name\"] == \"user2\"",
            "    assert auth_model[\"admin\"] == None",
            "",
            "    handled_user_model = user_model(\"user1@not-in-hosted-domain.com\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    with raises(HTTPError) as exc:",
            "        await authenticator.get_authenticated_user(handler, None)",
            "    assert exc.value.status_code == 403",
            "",
            "",
            "@mark.parametrize(",
            "    \"name, allowed\",",
            "    [",
            "        (\"allowed\", True),",
            "        (\"notallowed\", False),",
            "    ],",
            ")",
            "async def test_check_allowed_no_auth_state(google_client, name, allowed):",
            "    authenticator = GoogleOAuthenticator(allowed_users={\"allowed\"})",
            "    # allow check always gets called with no auth model during Hub startup",
            "    # these are previously-allowed users who should pass until subsequent",
            "    # this check is removed in JupyterHub 5",
            "    assert await authenticator.check_allowed(name, None)",
            "",
            "",
            "async def test_hosted_domain_multiple_entries(google_client):",
            "    \"\"\"",
            "    Tests that sign in is restricted to the listed domains and that the username",
            "    represents the full email as expected when hosted_domain contains multiple",
            "    entries.",
            "    \"\"\"",
            "    c = Config()",
            "    c.GoogleOAuthenticator.hosted_domain = [",
            "        \"In-Hosted-Domain1.com\",",
            "        \"In-Hosted-Domain2.com\",",
            "    ]",
            "    c.GoogleOAuthenticator.allow_all = True",
            "    authenticator = GoogleOAuthenticator(config=c)",
            "",
            "    handled_user_model = user_model(\"user1@iN-hosteD-domaiN1.com\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    auth_model = await authenticator.get_authenticated_user(handler, None)",
            "    assert auth_model",
            "    assert auth_model[\"name\"] == \"user1@in-hosted-domain1.com\"",
            "",
            "    handled_user_model = user_model(\"user2@iN-hosteD-domaiN2.com\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    auth_model = await authenticator.get_authenticated_user(handler, None)",
            "    assert auth_model",
            "    assert auth_model[\"name\"] == \"user2@in-hosted-domain2.com\"",
            "",
            "    handled_user_model = user_model(\"user1@not-in-hosted-domain.com\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    with raises(HTTPError) as exc:",
            "        await authenticator.get_authenticated_user(handler, None)",
            "    assert exc.value.status_code == 403",
            "",
            "",
            "@mark.parametrize(",
            "    \"test_variation_id,class_config,expect_config,expect_loglevel,expect_message\",",
            "    [",
            "        (",
            "            \"google_group_whitelist\",",
            "            {\"google_group_whitelist\": {\"example.com\": {\"dummy\"}}},",
            "            {\"allowed_google_groups\": {\"example.com\": {\"dummy\"}}},",
            "            logging.WARNING,",
            "            \"GoogleOAuthenticator.google_group_whitelist is deprecated in GoogleOAuthenticator 0.12.0, use GoogleOAuthenticator.allowed_google_groups instead\",",
            "        ),",
            "    ],",
            ")",
            "async def test_deprecated_config(",
            "    caplog,",
            "    test_variation_id,",
            "    class_config,",
            "    expect_config,",
            "    expect_loglevel,",
            "    expect_message,",
            "):",
            "    \"\"\"",
            "    Tests that a warning is emitted when using a deprecated config and that",
            "    configuring the old config ends up configuring the new config.",
            "    \"\"\"",
            "    print(f\"Running test variation id {test_variation_id}\")",
            "    c = Config()",
            "    c.GoogleOAuthenticator = Config(class_config)",
            "",
            "    test_logger = logging.getLogger('testlog')",
            "    if expect_loglevel == logging.ERROR:",
            "        with raises(ValueError, match=expect_message):",
            "            GoogleOAuthenticator(config=c, log=test_logger)",
            "    else:",
            "        authenticator = GoogleOAuthenticator(config=c, log=test_logger)",
            "        for key, value in expect_config.items():",
            "            assert getattr(authenticator, key) == value",
            "",
            "    captured_log_tuples = caplog.record_tuples",
            "    print(captured_log_tuples)",
            "",
            "    expected_log_tuple = (test_logger.name, expect_loglevel, expect_message)",
            "    assert expected_log_tuple in captured_log_tuples"
        ],
        "afterPatchFile": [
            "import hashlib",
            "import json",
            "import logging",
            "import re",
            "from unittest import mock",
            "",
            "from pytest import fixture, mark, raises",
            "from traitlets.config import Config",
            "",
            "from ..google import GoogleOAuthenticator",
            "from .mocks import setup_oauth_mock",
            "",
            "",
            "def user_model(email, username=\"user1\", hd=None):",
            "    \"\"\"Return a user model\"\"\"",
            "    model = {",
            "        'sub': hashlib.md5(email.encode()).hexdigest(),",
            "        'email': email,",
            "        'custom': username,",
            "        'verified_email': True,",
            "    }",
            "    if hd:",
            "        model['hd'] = hd",
            "    return model",
            "",
            "",
            "@fixture",
            "def google_client(client):",
            "    setup_oauth_mock(",
            "        client,",
            "        host=['accounts.google.com', 'www.googleapis.com'],",
            "        access_token_path=re.compile('^(/o/oauth2/token|/oauth2/v4/token)$'),",
            "        user_path='/oauth2/v1/userinfo',",
            "    )",
            "    return client",
            "",
            "",
            "@mark.parametrize(",
            "    \"test_variation_id,class_config,expect_allowed,expect_admin\",",
            "    [",
            "        # no allow config tested",
            "        (\"00\", {}, False, None),",
            "        # allow config, individually tested",
            "        (\"01\", {\"allow_all\": True}, True, None),",
            "        (\"02\", {\"allowed_users\": {\"user1\"}}, True, None),",
            "        (\"03\", {\"allowed_users\": {\"not-test-user\"}}, False, None),",
            "        (\"04\", {\"admin_users\": {\"user1\"}}, True, True),",
            "        (\"05\", {\"admin_users\": {\"not-test-user\"}}, False, None),",
            "        (\"06\", {\"allowed_google_groups\": {\"example.com\": {\"group1\"}}}, True, None),",
            "        (",
            "            \"07\",",
            "            {\"allowed_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}}},",
            "            False,",
            "            None,",
            "        ),",
            "        (\"08\", {\"admin_google_groups\": {\"example.com\": {\"group1\"}}}, True, True),",
            "        (",
            "            \"09\",",
            "            {\"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}}},",
            "            False,",
            "            False,",
            "        ),",
            "        # allow config, some combinations of two tested",
            "        (",
            "            \"10\",",
            "            {",
            "                \"allow_all\": False,",
            "                \"allowed_users\": {\"not-test-user\"},",
            "            },",
            "            False,",
            "            None,",
            "        ),",
            "        (",
            "            \"11\",",
            "            {",
            "                \"allowed_users\": {\"not-test-user\"},",
            "                \"admin_users\": {\"user1\"},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"12\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"group1\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"13\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"group1\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            True,",
            "            False,",
            "        ),",
            "        (",
            "            \"14\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"15\",",
            "            {",
            "                \"allowed_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            False,",
            "            False,",
            "        ),",
            "        (",
            "            \"16\",",
            "            {",
            "                \"admin_users\": {\"user1\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"17\",",
            "            {",
            "                \"admin_users\": {\"user1\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"18\",",
            "            {",
            "                \"admin_users\": {\"not-test-user\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"group1\"}},",
            "            },",
            "            True,",
            "            True,",
            "        ),",
            "        (",
            "            \"19\",",
            "            {",
            "                \"admin_users\": {\"not-test-user\"},",
            "                \"admin_google_groups\": {\"example.com\": {\"test-user-not-in-group\"}},",
            "            },",
            "            False,",
            "            False,",
            "        ),",
            "    ],",
            ")",
            "async def test_google(",
            "    google_client,",
            "    test_variation_id,",
            "    class_config,",
            "    expect_allowed,",
            "    expect_admin,",
            "):",
            "    print(f\"Running test variation id {test_variation_id}\")",
            "    c = Config()",
            "    c.GoogleOAuthenticator = Config(class_config)",
            "    c.GoogleOAuthenticator.username_claim = \"custom\"",
            "    authenticator = GoogleOAuthenticator(config=c)",
            "",
            "    handled_user_model = user_model(\"user1@example.com\", \"user1\")",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    with mock.patch.object(",
            "        authenticator, \"_fetch_user_groups\", lambda *args: {\"group1\"}",
            "    ):",
            "        auth_model = await authenticator.get_authenticated_user(handler, None)",
            "",
            "    if expect_allowed:",
            "        assert auth_model",
            "        assert set(auth_model) == {\"name\", \"admin\", \"auth_state\"}",
            "        assert auth_model[\"admin\"] == expect_admin",
            "        auth_state = auth_model[\"auth_state\"]",
            "        assert json.dumps(auth_state)",
            "        assert \"access_token\" in auth_state",
            "        user_info = auth_state[authenticator.user_auth_state_key]",
            "        assert auth_model[\"name\"] == user_info[authenticator.username_claim]",
            "        if authenticator.allowed_google_groups or authenticator.admin_google_groups:",
            "            assert user_info[\"google_groups\"] == [\"group1\"]",
            "    else:",
            "        assert auth_model == None",
            "",
            "",
            "@mark.parametrize(",
            "    \"test_variation_id,user_email,user_hd,expect_username,expect_allowed,expect_admin\",",
            "    [",
            "        (\"01\", \"user1@ok-hd.orG\", \"ok-hd.org\", \"user1\", True, True),",
            "        (\"02\", \"user2@ok-hd.orG\", \"ok-hd.org\", \"user2\", True, None),",
            "        (\"03\", \"blocked@ok-hd.org\", \"ok-hd.org\", None, False, None),",
            "        (\"04\", \"user2@ok-hd.org\", \"\", None, False, None),",
            "        (\"05\", \"user1@not-ok.org\", \"\", None, False, None),",
            "        # Test variation 06 below isn't believed to be possible, but since we",
            "        # aren't sure this test clarifies what we expect to happen.",
            "        (\"06\", \"user1@other.org\", \"ok-hd.org\", \"user1@other.org\", True, None),",
            "    ],",
            ")",
            "async def test_hosted_domain_single_entry(",
            "    google_client,",
            "    test_variation_id,",
            "    user_email,",
            "    user_hd,",
            "    expect_username,",
            "    expect_allowed,",
            "    expect_admin,",
            "):",
            "    \"\"\"",
            "    Tests that sign in is restricted to the listed domain and that the username",
            "    represents the part before the `@domain.com` as expected when hosted_domain",
            "    contains a single entry.",
            "    \"\"\"",
            "    c = Config()",
            "    c.GoogleOAuthenticator.hosted_domain = [\"ok-hd.org\"]",
            "    c.GoogleOAuthenticator.admin_users = {\"user1\"}",
            "    c.GoogleOAuthenticator.allowed_users = {\"user2\", \"blocked\", \"user1@other.org\"}",
            "    c.GoogleOAuthenticator.blocked_users = {\"blocked\"}",
            "    authenticator = GoogleOAuthenticator(config=c)",
            "",
            "    handled_user_model = user_model(user_email, hd=user_hd)",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    auth_model = await authenticator.get_authenticated_user(handler, None)",
            "    if expect_allowed:",
            "        assert auth_model",
            "        assert auth_model[\"name\"] == expect_username",
            "        assert auth_model[\"admin\"] == expect_admin",
            "    else:",
            "        assert auth_model == None",
            "",
            "",
            "@mark.parametrize(",
            "    \"name, allowed\",",
            "    [",
            "        (\"allowed\", True),",
            "        (\"notallowed\", False),",
            "    ],",
            ")",
            "async def test_check_allowed_no_auth_state(google_client, name, allowed):",
            "    authenticator = GoogleOAuthenticator(allowed_users={\"allowed\"})",
            "    # allow check always gets called with no auth model during Hub startup",
            "    # these are previously-allowed users who should pass until subsequent",
            "    # this check is removed in JupyterHub 5",
            "    assert await authenticator.check_allowed(name, None)",
            "",
            "",
            "@mark.parametrize(",
            "    \"test_variation_id,user_email,user_hd,expect_username,expect_allowed\",",
            "    [",
            "        (\"01\", \"user1@ok-hd1.orG\", \"ok-hd1.org\", \"user1@ok-hd1.org\", True),",
            "        (\"02\", \"user2@ok-hd2.orG\", \"ok-hd2.org\", \"user2@ok-hd2.org\", True),",
            "        (\"03\", \"blocked@ok-hd1.org\", \"ok-hd1.org\", None, False),",
            "        (\"04\", \"user3@ok-hd1.org\", \"\", None, False),",
            "        (\"05\", \"user1@not-ok.org\", \"\", None, False),",
            "        # Test variation 06 below isn't believed to be possible, but since we",
            "        # aren't sure this test clarifies what we expect to happen.",
            "        (\"06\", \"user1@other.org\", \"ok-hd1.org\", \"user1@other.org\", True),",
            "    ],",
            ")",
            "async def test_hosted_domain_multiple_entries(",
            "    google_client,",
            "    test_variation_id,",
            "    user_email,",
            "    user_hd,",
            "    expect_username,",
            "    expect_allowed,",
            "):",
            "    \"\"\"",
            "    Tests that sign in is restricted to the listed domains and that the username",
            "    represents the full email as expected when hosted_domain contains multiple",
            "    entries.",
            "    \"\"\"",
            "    c = Config()",
            "    c.GoogleOAuthenticator.hosted_domain = [",
            "        \"ok-hd1.org\",",
            "        \"ok-hd2.ORG\",",
            "    ]",
            "    c.GoogleOAuthenticator.blocked_users = [\"blocked@ok-hd1.org\"]",
            "    c.GoogleOAuthenticator.allow_all = True",
            "    authenticator = GoogleOAuthenticator(config=c)",
            "",
            "    handled_user_model = user_model(user_email, hd=user_hd)",
            "    handler = google_client.handler_for_user(handled_user_model)",
            "    auth_model = await authenticator.get_authenticated_user(handler, None)",
            "    if expect_allowed:",
            "        assert auth_model",
            "        assert auth_model[\"name\"] == expect_username",
            "    else:",
            "        assert auth_model == None",
            "",
            "",
            "@mark.parametrize(",
            "    \"test_variation_id,class_config,expect_config,expect_loglevel,expect_message\",",
            "    [",
            "        (",
            "            \"google_group_whitelist\",",
            "            {\"google_group_whitelist\": {\"example.com\": {\"dummy\"}}},",
            "            {\"allowed_google_groups\": {\"example.com\": {\"dummy\"}}},",
            "            logging.WARNING,",
            "            \"GoogleOAuthenticator.google_group_whitelist is deprecated in GoogleOAuthenticator 0.12.0, use GoogleOAuthenticator.allowed_google_groups instead\",",
            "        ),",
            "    ],",
            ")",
            "async def test_deprecated_config(",
            "    caplog,",
            "    test_variation_id,",
            "    class_config,",
            "    expect_config,",
            "    expect_loglevel,",
            "    expect_message,",
            "):",
            "    \"\"\"",
            "    Tests that a warning is emitted when using a deprecated config and that",
            "    configuring the old config ends up configuring the new config.",
            "    \"\"\"",
            "    print(f\"Running test variation id {test_variation_id}\")",
            "    c = Config()",
            "    c.GoogleOAuthenticator = Config(class_config)",
            "",
            "    test_logger = logging.getLogger('testlog')",
            "    if expect_loglevel == logging.ERROR:",
            "        with raises(ValueError, match=expect_message):",
            "            GoogleOAuthenticator(config=c, log=test_logger)",
            "    else:",
            "        authenticator = GoogleOAuthenticator(config=c, log=test_logger)",
            "        for key, value in expect_config.items():",
            "            assert getattr(authenticator, key) == value",
            "",
            "    captured_log_tuples = caplog.record_tuples",
            "    print(captured_log_tuples)",
            "",
            "    expected_log_tuple = (test_logger.name, expect_loglevel, expect_message)",
            "    assert expected_log_tuple in captured_log_tuples"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "8": [],
            "15": [
                "user_model"
            ],
            "17": [
                "user_model"
            ],
            "21": [
                "user_model"
            ],
            "190": [],
            "197": [],
            "199": [],
            "202": [
                "handled_user_model"
            ],
            "205": [],
            "206": [],
            "207": [],
            "208": [],
            "209": [
                "handled_user_model"
            ],
            "210": [
                "handler"
            ],
            "211": [
                "auth_model"
            ],
            "212": [],
            "213": [],
            "214": [],
            "215": [],
            "216": [
                "handled_user_model"
            ],
            "217": [
                "handler"
            ],
            "218": [],
            "219": [],
            "220": [],
            "238": [],
            "246": [],
            "247": [],
            "252": [
                "handled_user_model"
            ],
            "255": [],
            "256": [],
            "257": [],
            "258": [
                "handled_user_model"
            ],
            "259": [
                "handler"
            ],
            "260": [
                "auth_model"
            ],
            "261": [],
            "262": [],
            "263": [],
            "264": [
                "handled_user_model"
            ],
            "265": [
                "handler"
            ],
            "266": [],
            "267": [],
            "268": []
        },
        "addLocation": []
    }
}