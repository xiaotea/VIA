{
    "rdiffweb/controller/api.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "             return True"
            },
            "1": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "         # Disable password authentication for MFA"
            },
            "2": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "         if userobj.mfa == UserObject.ENABLED_MFA:"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+            cherrypy.tools.ratelimit.hit()"
            },
            "4": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "             return False"
            },
            "5": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "     # Otherwise validate username password"
            },
            "6": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    return any(cherrypy.engine.publish('login', username, password))"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+    valid = any(cherrypy.engine.publish('login', username, password))"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+    if not valid:"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+        # When invalid, we need to increase the rate limit."
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+        cherrypy.tools.ratelimit.hit()"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+    return valid"
            },
            "12": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 75,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 76,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 77,
                "PatchRowcode": " class ApiCurrentUser(Controller):"
            },
            "15": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 104,
                "PatchRowcode": " @cherrypy.tools.auth_basic(realm='rdiffweb', checkpassword=_checkpassword, priority=70)"
            },
            "16": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 105,
                "PatchRowcode": " @cherrypy.tools.auth_form(on=False)"
            },
            "17": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 106,
                "PatchRowcode": " @cherrypy.tools.auth_mfa(on=False)"
            },
            "18": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-@cherrypy.tools.sessions(on=False)"
            },
            "19": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 107,
                "PatchRowcode": " @cherrypy.tools.i18n(on=False)"
            },
            "20": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-@cherrypy.tools.ratelimit()"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+@cherrypy.tools.ratelimit(scope='rdiffweb-api', hit=0, priority=69)"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+@cherrypy.tools.sessions(on=False)"
            },
            "23": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 110,
                "PatchRowcode": " class ApiPage(Controller):"
            },
            "24": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "     \"\"\""
            },
            "25": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "     This class provide a restful API to access some of the rdiffweb resources."
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "# Define the logger",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "",
            "from rdiffweb.controller import Controller",
            "from rdiffweb.core.librdiff import RdiffTime",
            "from rdiffweb.core.model import UserObject",
            "",
            "try:",
            "    import simplejson as json",
            "except ImportError:",
            "    import json",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def json_handler(*args, **kwargs):",
            "    \"\"\"Custom json handle to convert RdiffDate to str.\"\"\"",
            "    value = cherrypy.serving.request._json_inner_handler(*args, **kwargs)",
            "",
            "    def default(o):",
            "        if isinstance(o, RdiffTime):",
            "            return str(o)",
            "        raise TypeError(repr(o) + \" is not JSON serializable\")",
            "",
            "    encode = json.JSONEncoder(default=default, ensure_ascii=False).iterencode",
            "    for chunk in encode(value):",
            "        yield chunk.encode('utf-8')",
            "",
            "",
            "def _checkpassword(realm, username, password):",
            "    \"\"\"",
            "    Check basic authentication.",
            "    \"\"\"",
            "    # Validate username",
            "    userobj = UserObject.get_user(username)",
            "    if userobj is not None:",
            "        # Verify if the password matches a token.",
            "        if userobj.validate_access_token(password):",
            "            return True",
            "        # Disable password authentication for MFA",
            "        if userobj.mfa == UserObject.ENABLED_MFA:",
            "            return False",
            "    # Otherwise validate username password",
            "    return any(cherrypy.engine.publish('login', username, password))",
            "",
            "",
            "class ApiCurrentUser(Controller):",
            "    @cherrypy.expose",
            "    def default(self):",
            "        u = self.app.currentuser",
            "        u.refresh_repos()",
            "        return {",
            "            \"email\": u.email,",
            "            \"username\": u.username,",
            "            \"repos\": [",
            "                {",
            "                    # Database fields.",
            "                    \"name\": repo_obj.name,",
            "                    \"maxage\": repo_obj.maxage,",
            "                    \"keepdays\": repo_obj.keepdays,",
            "                    # Repository fields.",
            "                    \"display_name\": repo_obj.display_name,",
            "                    \"last_backup_date\": repo_obj.last_backup_date,",
            "                    \"status\": repo_obj.status[0],",
            "                    \"encoding\": repo_obj.encoding,",
            "                }",
            "                for repo_obj in u.repo_objs",
            "            ],",
            "        }",
            "",
            "",
            "@cherrypy.tools.json_out(handler=json_handler)",
            "@cherrypy.config(**{'error_page.default': False})",
            "@cherrypy.tools.auth_basic(realm='rdiffweb', checkpassword=_checkpassword, priority=70)",
            "@cherrypy.tools.auth_form(on=False)",
            "@cherrypy.tools.auth_mfa(on=False)",
            "@cherrypy.tools.sessions(on=False)",
            "@cherrypy.tools.i18n(on=False)",
            "@cherrypy.tools.ratelimit()",
            "class ApiPage(Controller):",
            "    \"\"\"",
            "    This class provide a restful API to access some of the rdiffweb resources.",
            "    \"\"\"",
            "",
            "    currentuser = ApiCurrentUser()",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        return {",
            "            \"version\": self.app.version,",
            "        }"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "# Define the logger",
            "",
            "",
            "import logging",
            "",
            "import cherrypy",
            "",
            "from rdiffweb.controller import Controller",
            "from rdiffweb.core.librdiff import RdiffTime",
            "from rdiffweb.core.model import UserObject",
            "",
            "try:",
            "    import simplejson as json",
            "except ImportError:",
            "    import json",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def json_handler(*args, **kwargs):",
            "    \"\"\"Custom json handle to convert RdiffDate to str.\"\"\"",
            "    value = cherrypy.serving.request._json_inner_handler(*args, **kwargs)",
            "",
            "    def default(o):",
            "        if isinstance(o, RdiffTime):",
            "            return str(o)",
            "        raise TypeError(repr(o) + \" is not JSON serializable\")",
            "",
            "    encode = json.JSONEncoder(default=default, ensure_ascii=False).iterencode",
            "    for chunk in encode(value):",
            "        yield chunk.encode('utf-8')",
            "",
            "",
            "def _checkpassword(realm, username, password):",
            "    \"\"\"",
            "    Check basic authentication.",
            "    \"\"\"",
            "    # Validate username",
            "    userobj = UserObject.get_user(username)",
            "    if userobj is not None:",
            "        # Verify if the password matches a token.",
            "        if userobj.validate_access_token(password):",
            "            return True",
            "        # Disable password authentication for MFA",
            "        if userobj.mfa == UserObject.ENABLED_MFA:",
            "            cherrypy.tools.ratelimit.hit()",
            "            return False",
            "    # Otherwise validate username password",
            "    valid = any(cherrypy.engine.publish('login', username, password))",
            "    if not valid:",
            "        # When invalid, we need to increase the rate limit.",
            "        cherrypy.tools.ratelimit.hit()",
            "    return valid",
            "",
            "",
            "class ApiCurrentUser(Controller):",
            "    @cherrypy.expose",
            "    def default(self):",
            "        u = self.app.currentuser",
            "        u.refresh_repos()",
            "        return {",
            "            \"email\": u.email,",
            "            \"username\": u.username,",
            "            \"repos\": [",
            "                {",
            "                    # Database fields.",
            "                    \"name\": repo_obj.name,",
            "                    \"maxage\": repo_obj.maxage,",
            "                    \"keepdays\": repo_obj.keepdays,",
            "                    # Repository fields.",
            "                    \"display_name\": repo_obj.display_name,",
            "                    \"last_backup_date\": repo_obj.last_backup_date,",
            "                    \"status\": repo_obj.status[0],",
            "                    \"encoding\": repo_obj.encoding,",
            "                }",
            "                for repo_obj in u.repo_objs",
            "            ],",
            "        }",
            "",
            "",
            "@cherrypy.tools.json_out(handler=json_handler)",
            "@cherrypy.config(**{'error_page.default': False})",
            "@cherrypy.tools.auth_basic(realm='rdiffweb', checkpassword=_checkpassword, priority=70)",
            "@cherrypy.tools.auth_form(on=False)",
            "@cherrypy.tools.auth_mfa(on=False)",
            "@cherrypy.tools.i18n(on=False)",
            "@cherrypy.tools.ratelimit(scope='rdiffweb-api', hit=0, priority=69)",
            "@cherrypy.tools.sessions(on=False)",
            "class ApiPage(Controller):",
            "    \"\"\"",
            "    This class provide a restful API to access some of the rdiffweb resources.",
            "    \"\"\"",
            "",
            "    currentuser = ApiCurrentUser()",
            "",
            "    @cherrypy.expose",
            "    def index(self):",
            "        return {",
            "            \"version\": self.app.version,",
            "        }"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "69": [
                "_checkpassword"
            ],
            "102": [],
            "104": []
        },
        "addLocation": [
            "tensorflow.python.kernel_tests.init_ops_test.RangeTest"
        ]
    },
    "rdiffweb/controller/form.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " from markupsafe import Markup\r"
            },
            "1": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " from wtforms.form import Form\r"
            },
            "2": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " \r"
            },
            "3": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-SUBMIT_METHODS = {'POST', 'PUT', 'PATCH', 'DELETE'}\r"
            },
            "4": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-\r"
            },
            "5": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " \r"
            },
            "6": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " class _ProxyFormdata:\r"
            },
            "7": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 24,
                "PatchRowcode": "     \"\"\"\r"
            },
            "8": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "         Consider the form submitted if there is an active request and\r"
            },
            "9": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "         the method is ``POST``, ``PUT``, ``PATCH``, or ``DELETE``.\r"
            },
            "10": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "         \"\"\"\r"
            },
            "11": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return cherrypy.request.method in SUBMIT_METHODS\r"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+        return cherrypy.request.method == 'POST'\r"
            },
            "13": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 67,
                "PatchRowcode": " \r"
            },
            "14": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "     def validate_on_submit(self):\r"
            },
            "15": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "         \"\"\"\r"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\r",
            "import cherrypy\r",
            "from markupsafe import Markup\r",
            "from wtforms.form import Form\r",
            "\r",
            "SUBMIT_METHODS = {'POST', 'PUT', 'PATCH', 'DELETE'}\r",
            "\r",
            "\r",
            "class _ProxyFormdata:\r",
            "    \"\"\"\r",
            "    Custom class to proxy default form data into WTForm from cherrypy variables.\r",
            "    \"\"\"\r",
            "\r",
            "    def __contains__(self, key):\r",
            "        return key in cherrypy.request.params\r",
            "\r",
            "    def getlist(self, key):\r",
            "        # Default to use cherrypy params.\r",
            "        params = cherrypy.request.params\r",
            "        if key in params:\r",
            "            if isinstance(params[key], list):\r",
            "                return params[key]\r",
            "            else:\r",
            "                return [params[key]]\r",
            "        # Return default empty list.\r",
            "        return []\r",
            "\r",
            "\r",
            "_AUTO = _ProxyFormdata()\r",
            "\r",
            "\r",
            "class CherryForm(Form):\r",
            "    \"\"\"\r",
            "    Custom implementation of WTForm for cherrypy to support kwargs parms.\r",
            "\r",
            "    If ``formdata`` is not specified, this will use cherrypy.request.params\r",
            "    Explicitly pass ``formdata=None`` to prevent this.\r",
            "    \"\"\"\r",
            "\r",
            "    def __init__(self, **kwargs):\r",
            "        if 'formdata' in kwargs:\r",
            "            formdata = kwargs.pop('formdata')\r",
            "        else:\r",
            "            formdata = _AUTO if CherryForm.is_submitted(self) else None\r",
            "        super().__init__(formdata=formdata, **kwargs)\r",
            "\r",
            "    def is_submitted(self):\r",
            "        \"\"\"\r",
            "        Consider the form submitted if there is an active request and\r",
            "        the method is ``POST``, ``PUT``, ``PATCH``, or ``DELETE``.\r",
            "        \"\"\"\r",
            "        return cherrypy.request.method in SUBMIT_METHODS\r",
            "\r",
            "    def validate_on_submit(self):\r",
            "        \"\"\"\r",
            "        Call `validate` only if the form is submitted.\r",
            "        This is a shortcut for ``form.is_submitted() and form.validate()``.\r",
            "        \"\"\"\r",
            "        return self.is_submitted() and self.validate()\r",
            "\r",
            "    @property\r",
            "    def error_message(self):\r",
            "        if self.errors:\r",
            "            msg = Markup(\"\")\r",
            "            for field, messages in self.errors.items():\r",
            "                if msg:\r",
            "                    msg += Markup('<br/>')\r",
            "                # Field name\r",
            "                if field in self:\r",
            "                    msg += \"%s: \" % self[field].label.text\r",
            "                else:\r",
            "                    msg += \"%s: \" % field\r",
            "                for m in messages:\r",
            "                    msg += m\r",
            "            return msg\r",
            "\r",
            "    def __html__(self):\r",
            "        \"\"\"\r",
            "        Return a HTML representation of the form. For more powerful rendering, see the __call__() method.\r",
            "        \"\"\"\r",
            "        return self()\r",
            "\r",
            "    def __call__(self, **kwargs):\r",
            "        env = cherrypy.tree.apps[''].templates.jinja_env\r",
            "        tmpl = env.get_template('components/form.html')\r",
            "        return Markup(tmpl.render(form=self, **kwargs))\r"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2021 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\r",
            "import cherrypy\r",
            "from markupsafe import Markup\r",
            "from wtforms.form import Form\r",
            "\r",
            "\r",
            "class _ProxyFormdata:\r",
            "    \"\"\"\r",
            "    Custom class to proxy default form data into WTForm from cherrypy variables.\r",
            "    \"\"\"\r",
            "\r",
            "    def __contains__(self, key):\r",
            "        return key in cherrypy.request.params\r",
            "\r",
            "    def getlist(self, key):\r",
            "        # Default to use cherrypy params.\r",
            "        params = cherrypy.request.params\r",
            "        if key in params:\r",
            "            if isinstance(params[key], list):\r",
            "                return params[key]\r",
            "            else:\r",
            "                return [params[key]]\r",
            "        # Return default empty list.\r",
            "        return []\r",
            "\r",
            "\r",
            "_AUTO = _ProxyFormdata()\r",
            "\r",
            "\r",
            "class CherryForm(Form):\r",
            "    \"\"\"\r",
            "    Custom implementation of WTForm for cherrypy to support kwargs parms.\r",
            "\r",
            "    If ``formdata`` is not specified, this will use cherrypy.request.params\r",
            "    Explicitly pass ``formdata=None`` to prevent this.\r",
            "    \"\"\"\r",
            "\r",
            "    def __init__(self, **kwargs):\r",
            "        if 'formdata' in kwargs:\r",
            "            formdata = kwargs.pop('formdata')\r",
            "        else:\r",
            "            formdata = _AUTO if CherryForm.is_submitted(self) else None\r",
            "        super().__init__(formdata=formdata, **kwargs)\r",
            "\r",
            "    def is_submitted(self):\r",
            "        \"\"\"\r",
            "        Consider the form submitted if there is an active request and\r",
            "        the method is ``POST``, ``PUT``, ``PATCH``, or ``DELETE``.\r",
            "        \"\"\"\r",
            "        return cherrypy.request.method == 'POST'\r",
            "\r",
            "    def validate_on_submit(self):\r",
            "        \"\"\"\r",
            "        Call `validate` only if the form is submitted.\r",
            "        This is a shortcut for ``form.is_submitted() and form.validate()``.\r",
            "        \"\"\"\r",
            "        return self.is_submitted() and self.validate()\r",
            "\r",
            "    @property\r",
            "    def error_message(self):\r",
            "        if self.errors:\r",
            "            msg = Markup(\"\")\r",
            "            for field, messages in self.errors.items():\r",
            "                if msg:\r",
            "                    msg += Markup('<br/>')\r",
            "                # Field name\r",
            "                if field in self:\r",
            "                    msg += \"%s: \" % self[field].label.text\r",
            "                else:\r",
            "                    msg += \"%s: \" % field\r",
            "                for m in messages:\r",
            "                    msg += m\r",
            "            return msg\r",
            "\r",
            "    def __html__(self):\r",
            "        \"\"\"\r",
            "        Return a HTML representation of the form. For more powerful rendering, see the __call__() method.\r",
            "        \"\"\"\r",
            "        return self()\r",
            "\r",
            "    def __call__(self, **kwargs):\r",
            "        env = cherrypy.tree.apps[''].templates.jinja_env\r",
            "        tmpl = env.get_template('components/form.html')\r",
            "        return Markup(tmpl.render(form=self, **kwargs))\r"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "22": [
                "SUBMIT_METHODS"
            ],
            "23": [],
            "68": [
                "CherryForm",
                "is_submitted"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_admin_session.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "     action = StringField(validators=[validators.regexp('delete')])"
            },
            "1": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": "     number = IntegerField(validators=[validators.data_required()])"
            },
            "2": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 32,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @property"
            },
            "4": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def app(self):"
            },
            "5": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return cherrypy.request.app"
            },
            "6": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "7": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " @cherrypy.tools.is_admin()"
            },
            "9": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " class AdminSessionPage(Controller):"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminSessionPage(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(SessionObject.number == form.number.data).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter().all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"admin_session.html\", active_sessions=active_sessions)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminSessionPage(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(SessionObject.number == form.number.data).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter().all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"admin_session.html\", active_sessions=active_sessions)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "33": [
                "RevokeSessionForm"
            ],
            "34": [
                "RevokeSessionForm",
                "app"
            ],
            "35": [
                "RevokeSessionForm",
                "app"
            ],
            "36": []
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_login.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 62,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "     @cherrypy.expose()"
            },
            "2": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "     @cherrypy.tools.auth_mfa(on=False)"
            },
            "3": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @cherrypy.tools.ratelimit()"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'])"
            },
            "5": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "     def index(self, **kwargs):"
            },
            "6": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "         \"\"\""
            },
            "7": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "         Called by auth_form to generate the /login/ page."
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import BooleanField, PasswordField, StringField, SubmitField",
            "from wtforms.validators import InputRequired, Length",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.tools.auth_form import LOGIN_PERSISTENT, SESSION_KEY",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginForm(CherryForm):",
            "    # Sanitize the redirect URL to avoid Open Redirect",
            "    # redirect = HiddenField(default='/', filters=[lambda v: v if v.startswith('/') else '/'])",
            "    login = StringField(",
            "        _('Username'),",
            "        default=lambda: cherrypy.session.get(SESSION_KEY, None),",
            "        validators=[InputRequired(), Length(max=256, message=_('Username too long.'))],",
            "        render_kw={",
            "            \"placeholder\": _('Username'),",
            "            \"autocorrect\": \"off\",",
            "            \"autocapitalize\": \"none\",",
            "            \"autocomplete\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    password = PasswordField(_('Password'), validators=[InputRequired()], render_kw={\"placeholder\": _('Password')})",
            "    persistent = BooleanField(",
            "        _('Remember me'),",
            "        default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),",
            "    )",
            "    submit = SubmitField(",
            "        _('Sign in'),",
            "        render_kw={\"class\": \"btn-primary btn-lg btn-block\"},",
            "    )",
            "",
            "",
            "class LoginPage(Controller):",
            "    \"\"\"",
            "    This page is used by the authentication to enter a user/pass.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose()",
            "    @cherrypy.tools.auth_mfa(on=False)",
            "    @cherrypy.tools.ratelimit()",
            "    def index(self, **kwargs):",
            "        \"\"\"",
            "        Called by auth_form to generate the /login/ page.",
            "        \"\"\"",
            "        form = LoginForm()",
            "",
            "        # Validate user's credentials",
            "        if form.validate_on_submit():",
            "            try:",
            "                results = [r for r in cherrypy.engine.publish('login', form.login.data, form.password.data) if r]",
            "            except Exception:",
            "                logger.exception('fail to validate user [%s] credentials', form.login.data)",
            "                flash(_(\"Failed to validate user credentials.\"), level='error')",
            "            else:",
            "                if len(results) > 0 and results[0]:",
            "                    cherrypy.tools.auth_form.login(username=results[0].username, persistent=form.persistent.data)",
            "                    cherrypy.tools.auth_form.redirect_to_original_url()",
            "                else:",
            "                    flash(_(\"Invalid username or password.\"))",
            "        params = {",
            "            'form': form,",
            "        }",
            "        # Add welcome message to params. Try to load translated message.",
            "        welcome_msg = self.app.cfg.welcome_msg",
            "        if welcome_msg:",
            "            params[\"welcome_msg\"] = welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = welcome_msg.get(locale, params[\"welcome_msg\"])",
            "",
            "        return self._compile_template(\"login.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import BooleanField, PasswordField, StringField, SubmitField",
            "from wtforms.validators import InputRequired, Length",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.tools.auth_form import LOGIN_PERSISTENT, SESSION_KEY",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginForm(CherryForm):",
            "    # Sanitize the redirect URL to avoid Open Redirect",
            "    # redirect = HiddenField(default='/', filters=[lambda v: v if v.startswith('/') else '/'])",
            "    login = StringField(",
            "        _('Username'),",
            "        default=lambda: cherrypy.session.get(SESSION_KEY, None),",
            "        validators=[InputRequired(), Length(max=256, message=_('Username too long.'))],",
            "        render_kw={",
            "            \"placeholder\": _('Username'),",
            "            \"autocorrect\": \"off\",",
            "            \"autocapitalize\": \"none\",",
            "            \"autocomplete\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    password = PasswordField(_('Password'), validators=[InputRequired()], render_kw={\"placeholder\": _('Password')})",
            "    persistent = BooleanField(",
            "        _('Remember me'),",
            "        default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),",
            "    )",
            "    submit = SubmitField(",
            "        _('Sign in'),",
            "        render_kw={\"class\": \"btn-primary btn-lg btn-block\"},",
            "    )",
            "",
            "",
            "class LoginPage(Controller):",
            "    \"\"\"",
            "    This page is used by the authentication to enter a user/pass.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose()",
            "    @cherrypy.tools.auth_mfa(on=False)",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def index(self, **kwargs):",
            "        \"\"\"",
            "        Called by auth_form to generate the /login/ page.",
            "        \"\"\"",
            "        form = LoginForm()",
            "",
            "        # Validate user's credentials",
            "        if form.validate_on_submit():",
            "            try:",
            "                results = [r for r in cherrypy.engine.publish('login', form.login.data, form.password.data) if r]",
            "            except Exception:",
            "                logger.exception('fail to validate user [%s] credentials', form.login.data)",
            "                flash(_(\"Failed to validate user credentials.\"), level='error')",
            "            else:",
            "                if len(results) > 0 and results[0]:",
            "                    cherrypy.tools.auth_form.login(username=results[0].username, persistent=form.persistent.data)",
            "                    cherrypy.tools.auth_form.redirect_to_original_url()",
            "                else:",
            "                    flash(_(\"Invalid username or password.\"))",
            "        params = {",
            "            'form': form,",
            "        }",
            "        # Add welcome message to params. Try to load translated message.",
            "        welcome_msg = self.app.cfg.welcome_msg",
            "        if welcome_msg:",
            "            params[\"welcome_msg\"] = welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = welcome_msg.get(locale, params[\"welcome_msg\"])",
            "",
            "        return self._compile_template(\"login.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "65": [
                "LoginPage"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_mfa.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 70,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 71,
                "PatchRowcode": " class MfaPage(Controller):"
            },
            "2": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "     @cherrypy.expose()"
            },
            "3": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @cherrypy.tools.ratelimit()"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'])"
            },
            "5": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "     def index(self, **kwargs):"
            },
            "6": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "         form = MfaForm()"
            },
            "7": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 76,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import BooleanField, StringField, SubmitField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.tools.auth_form import LOGIN_PERSISTENT",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class MfaForm(CherryForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        description=_('Enter the code to verify your identity.'),",
            "        render_kw={",
            "            \"class\": \"form-control-lg\",",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    persistent = BooleanField(",
            "        _('Remember me'),",
            "        default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),",
            "    )",
            "    submit = SubmitField(",
            "        _('Sign in'),",
            "        render_kw={\"class\": \"btn-primary btn-lg btn-block\"},",
            "    )",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link btn-sm btn-block\"},",
            "    )",
            "",
            "    def validate_code(self, field):",
            "        # Code is required when submit.",
            "        if self.submit.data:",
            "            if not self.code.data:",
            "                raise ValueError(_('Invalid verification code.'))",
            "            # Validate verification code.",
            "            if not cherrypy.tools.auth_mfa.verify_code(code=self.code.data, persistent=self.persistent.data):",
            "                raise ValueError(_('Invalid verification code.'))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.submit.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class MfaPage(Controller):",
            "    @cherrypy.expose()",
            "    @cherrypy.tools.ratelimit()",
            "    def index(self, **kwargs):",
            "        form = MfaForm()",
            "",
            "        # Validate MFA",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.submit.data:",
            "                    cherrypy.tools.auth_mfa.redirect_to_original_url()",
            "                elif form.resend_code.data:",
            "                    self.send_code()",
            "        if cherrypy.tools.auth_mfa.is_code_expired():",
            "            # Send verification code if previous code expired.",
            "            self.send_code()",
            "        params = {",
            "            'form': form,",
            "        }",
            "        # Add welcome message to params. Try to load translated message.",
            "        welcome_msg = self.app.cfg.welcome_msg",
            "        if welcome_msg:",
            "            params[\"welcome_msg\"] = welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = welcome_msg.get(locale, params[\"welcome_msg\"])",
            "        return self._compile_template(\"mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        # Send verification code by email",
            "        userobj = cherrypy.serving.request.currentuser",
            "        if not userobj.email:",
            "            flash(",
            "                _(",
            "                    \"Multi-factor authentication is enabled for your account, but your account does not have a valid email address to send the verification code to. Check your account settings with your administrator.\"",
            "                )",
            "            )",
            "        else:",
            "            code = cherrypy.tools.auth_mfa.generate_code()",
            "            body = self.app.templates.compile_template(",
            "                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "            )",
            "            cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "            flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import BooleanField, StringField, SubmitField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.tools.auth_form import LOGIN_PERSISTENT",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class MfaForm(CherryForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        description=_('Enter the code to verify your identity.'),",
            "        render_kw={",
            "            \"class\": \"form-control-lg\",",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    persistent = BooleanField(",
            "        _('Remember me'),",
            "        default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),",
            "    )",
            "    submit = SubmitField(",
            "        _('Sign in'),",
            "        render_kw={\"class\": \"btn-primary btn-lg btn-block\"},",
            "    )",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link btn-sm btn-block\"},",
            "    )",
            "",
            "    def validate_code(self, field):",
            "        # Code is required when submit.",
            "        if self.submit.data:",
            "            if not self.code.data:",
            "                raise ValueError(_('Invalid verification code.'))",
            "            # Validate verification code.",
            "            if not cherrypy.tools.auth_mfa.verify_code(code=self.code.data, persistent=self.persistent.data):",
            "                raise ValueError(_('Invalid verification code.'))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.submit.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class MfaPage(Controller):",
            "    @cherrypy.expose()",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def index(self, **kwargs):",
            "        form = MfaForm()",
            "",
            "        # Validate MFA",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.submit.data:",
            "                    cherrypy.tools.auth_mfa.redirect_to_original_url()",
            "                elif form.resend_code.data:",
            "                    self.send_code()",
            "        if cherrypy.tools.auth_mfa.is_code_expired():",
            "            # Send verification code if previous code expired.",
            "            self.send_code()",
            "        params = {",
            "            'form': form,",
            "        }",
            "        # Add welcome message to params. Try to load translated message.",
            "        welcome_msg = self.app.cfg.welcome_msg",
            "        if welcome_msg:",
            "            params[\"welcome_msg\"] = welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = welcome_msg.get(locale, params[\"welcome_msg\"])",
            "        return self._compile_template(\"mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        # Send verification code by email",
            "        userobj = cherrypy.serving.request.currentuser",
            "        if not userobj.email:",
            "            flash(",
            "                _(",
            "                    \"Multi-factor authentication is enabled for your account, but your account does not have a valid email address to send the verification code to. Check your account settings with your administrator.\"",
            "                )",
            "            )",
            "        else:",
            "            code = cherrypy.tools.auth_mfa.generate_code()",
            "            body = self.app.templates.compile_template(",
            "                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "            )",
            "            cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "            flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "73": [
                "MfaPage"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_pref_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " from rdiffweb.core.model import UserObject"
            },
            "1": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " from rdiffweb.tools.i18n import gettext_lazy as _"
            },
            "2": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-# Maximum number of password change attempt before logout"
            },
            "4": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-CHANGE_PASSWORD_MAX_ATTEMPT = 5"
            },
            "5": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-CHANGE_PASSWORD_ATTEMPTS = 'change_password_attempts'"
            },
            "6": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "7": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 32,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " class UserProfileForm(CherryForm):"
            },
            "9": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "     action = HiddenField(default='set_profile_info')"
            },
            "10": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         # Check if current password is \"valid\" if Not, rate limit the"
            },
            "11": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "         # number of attempts and logout user after too many invalid attempts."
            },
            "12": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "         if not user.validate_password(self.current.data):"
            },
            "13": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.session[CHANGE_PASSWORD_ATTEMPTS] = cherrypy.session.get(CHANGE_PASSWORD_ATTEMPTS, 0) + 1"
            },
            "14": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            attempts = cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]"
            },
            "15": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if attempts >= CHANGE_PASSWORD_MAX_ATTEMPT:"
            },
            "16": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                cherrypy.session.clear()"
            },
            "17": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                cherrypy.session.regenerate()"
            },
            "18": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                flash("
            },
            "19": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    _(\"You were logged out because you entered the wrong password too many times.\"),"
            },
            "20": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    level='warning',"
            },
            "21": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                )"
            },
            "22": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                raise cherrypy.HTTPRedirect('/login/')"
            },
            "23": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "             self.current.errors = [_(\"Wrong current password.\")]"
            },
            "24": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "             return False"
            },
            "25": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "26": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Clear number of attempts"
            },
            "27": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:"
            },
            "28": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]"
            },
            "29": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "30": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         try:"
            },
            "31": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "             user.set_password(self.new.data)"
            },
            "32": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "             return True"
            },
            "33": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 132,
                "PatchRowcode": "     \"\"\""
            },
            "34": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": 133,
                "PatchRowcode": " "
            },
            "35": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": 134,
                "PatchRowcode": "     @cherrypy.expose"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'], logout=True)"
            },
            "37": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": 136,
                "PatchRowcode": "     def default(self, **kwargs):"
            },
            "38": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "         # Process the parameters."
            },
            "39": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 138,
                "PatchRowcode": "         profile_form = UserProfileForm(obj=self.app.currentuser)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Maximum number of password change attempt before logout",
            "CHANGE_PASSWORD_MAX_ATTEMPT = 5",
            "CHANGE_PASSWORD_ATTEMPTS = 'change_password_attempts'",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def validate_new(self, field):",
            "        \"\"\"",
            "        Make sure new password if not equals to old password.",
            "        \"\"\"",
            "        if self.new.data and self.new.data == self.current.data:",
            "            raise ValueError(_('The new password must be different from the current password.'))",
            "",
            "    def populate_obj(self, user):",
            "        # Check if current password is \"valid\" if Not, rate limit the",
            "        # number of attempts and logout user after too many invalid attempts.",
            "        if not user.validate_password(self.current.data):",
            "            cherrypy.session[CHANGE_PASSWORD_ATTEMPTS] = cherrypy.session.get(CHANGE_PASSWORD_ATTEMPTS, 0) + 1",
            "            attempts = cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "            if attempts >= CHANGE_PASSWORD_MAX_ATTEMPT:",
            "                cherrypy.session.clear()",
            "                cherrypy.session.regenerate()",
            "                flash(",
            "                    _(\"You were logged out because you entered the wrong password too many times.\"),",
            "                    level='warning',",
            "                )",
            "                raise cherrypy.HTTPRedirect('/login/')",
            "            self.current.errors = [_(\"Wrong current password.\")]",
            "            return False",
            "",
            "        # Clear number of attempts",
            "        if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:",
            "            del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "",
            "        try:",
            "            user.set_password(self.new.data)",
            "            return True",
            "        except ValueError as e:",
            "            self.new.errors = [str(e)]",
            "            return False",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "                raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                if password_form.populate_obj(self.app.currentuser):",
            "                    flash(_(\"Password updated successfully.\"), level='success')",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def validate_new(self, field):",
            "        \"\"\"",
            "        Make sure new password if not equals to old password.",
            "        \"\"\"",
            "        if self.new.data and self.new.data == self.current.data:",
            "            raise ValueError(_('The new password must be different from the current password.'))",
            "",
            "    def populate_obj(self, user):",
            "        # Check if current password is \"valid\" if Not, rate limit the",
            "        # number of attempts and logout user after too many invalid attempts.",
            "        if not user.validate_password(self.current.data):",
            "            self.current.errors = [_(\"Wrong current password.\")]",
            "            return False",
            "        try:",
            "            user.set_password(self.new.data)",
            "            return True",
            "        except ValueError as e:",
            "            self.new.errors = [str(e)]",
            "            return False",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    @cherrypy.tools.ratelimit(methods=['POST'], logout=True)",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "                raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                if password_form.populate_obj(self.app.currentuser):",
            "                    flash(_(\"Password updated successfully.\"), level='success')",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "32": [],
            "33": [
                "CHANGE_PASSWORD_MAX_ATTEMPT"
            ],
            "34": [
                "CHANGE_PASSWORD_ATTEMPTS"
            ],
            "35": [],
            "102": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "103": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "104": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "105": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "106": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "107": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "108": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "109": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "110": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "111": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "114": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "115": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "116": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "117": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "118": [
                "UserPasswordForm",
                "populate_obj"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_pref_session.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "     action = StringField(validators=[validators.regexp('delete')])"
            },
            "1": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": "     number = IntegerField(validators=[validators.data_required()])"
            },
            "2": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 32,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @property"
            },
            "4": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def app(self):"
            },
            "5": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return cherrypy.request.app"
            },
            "6": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "7": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " class PagePrefSession(Controller):"
            },
            "9": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "     @cherrypy.expose"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "",
            "class PagePrefSession(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(",
            "                    SessionObject.username == self.app.currentuser.username, SessionObject.number == form.number.data",
            "                ).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter(SessionObject.username == self.app.currentuser.username).all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"prefs_session.html\", active_sessions=active_sessions)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms import validators",
            "from wtforms.fields import IntegerField, StringField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import SessionObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "",
            "class RevokeSessionForm(CherryForm):",
            "    action = StringField(validators=[validators.regexp('delete')])",
            "    number = IntegerField(validators=[validators.data_required()])",
            "",
            "",
            "class PagePrefSession(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        # Delete session on form submit",
            "        form = RevokeSessionForm()",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                session = SessionObject.query.filter(",
            "                    SessionObject.username == self.app.currentuser.username, SessionObject.number == form.number.data",
            "                ).first()",
            "                if not session:",
            "                    flash(_('The given session cannot be removed because it cannot be found.'), level='warning')",
            "                elif session.id == cherrypy.session.id:",
            "                    flash(_('You cannot revoke your current session.'), level='warning')",
            "                else:",
            "                    session.delete()",
            "                    flash(_('The session was successfully revoked.'), level='success')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        # Get list of current user's session",
            "        obj_list = SessionObject.query.filter(SessionObject.username == self.app.currentuser.username).all()",
            "        active_sessions = [",
            "            {",
            "                'number': obj.number,",
            "                'access_time': obj.data.get('access_time', None),",
            "                'current': cherrypy.session.id == obj.id,",
            "                'expiration_time': obj.expiration_time,",
            "                'ip_address': obj.data.get('ip_address', None),",
            "                'login_time': obj.data.get('login_time', None),",
            "                'user_agent': obj.data.get('user_agent', None),",
            "                'username': obj.username,",
            "            }",
            "            for obj in obj_list",
            "        ]",
            "        return self._compile_template(\"prefs_session.html\", active_sessions=active_sessions)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "33": [
                "RevokeSessionForm"
            ],
            "34": [
                "RevokeSessionForm",
                "app"
            ],
            "35": [
                "RevokeSessionForm",
                "app"
            ],
            "36": []
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_api.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "     }"
            },
            "1": {
                "beforePatchRowNumber": 125,
                "afterPatchRowNumber": 125,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "     def test_login_ratelimit(self):"
            },
            "3": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for i in range(0, 6):"
            },
            "4": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage('/api/')"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+        # Given invalid credentials sent to API"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+        headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))]"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+        for i in range(1, 5):"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+            self.getPage('/api/', headers=headers)"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+            self.assertStatus(401)"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+        # Then the 6th request is refused"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+        self.getPage('/api/', headers=headers)"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+        self.assertStatus(429)"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+        # Next request is also refused event if credentials are valid."
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])"
            },
            "15": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "         self.assertStatus(429)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "",
            "from base64 import b64encode",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class APITest(rdiffweb.test.WebCase):",
            "",
            "    headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))]",
            "",
            "    def test_get_index(self):",
            "        data = self.getJson('/api/', headers=self.headers)",
            "        self.assertIsNotNone(data.get('version'))",
            "",
            "    def test_get_currentuser(self):",
            "        data = self.getJson('/api/currentuser/', headers=self.headers)",
            "        self.assertEqual(data.get('username'), 'admin')",
            "        self.assertEqual(data.get('email'), '')",
            "        # This value change on every execution.",
            "        self.assertEqual(2, len(data.get('repos')))",
            "        repo = data.get('repos')[1]",
            "        self.assertEqual(repo.get('keepdays'), -1)",
            "        self.assertEqual(repo.get('last_backup_date'), '2016-02-02T16:30:40-05:00')",
            "        self.assertEqual(repo.get('status'), 'ok')",
            "        self.assertEqual(repo.get('display_name'), 'testcases')",
            "        self.assertEqual(repo.get('encoding'), 'utf-8')",
            "        self.assertEqual(repo.get('name'), 'testcases')",
            "        self.assertEqual(repo.get('maxage'), 0)",
            "",
            "    def test_getapi_without_authorization(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/')",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_without_username(self):",
            "        \"\"\"",
            "        Check if error 401 is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\":admin123\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_empty_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_invalid_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_authorization(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getapi_with_session(self):",
            "        # Given an authenticate user",
            "        b = {'login': self.USERNAME, 'password': self.PASSWORD}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        # When querying the API",
            "        self.getPage('/api/')",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_auth_with_access_token(self):",
            "        # Given a user with an access token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test').encode('ascii')",
            "        # When using this token to authenticated with /api",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\" + token).decode('ascii'))])",
            "        # Then authentication is successful",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_auth_failed_with_mfa_enabled(self):",
            "        # Given a user with MFA enabled",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.mfa = UserObject.ENABLED_MFA",
            "        userobj.add()",
            "        # When authenticating with /api/",
            "        self.getPage('/api/', headers=self.headers)",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "",
            "class APIRatelimitTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        for i in range(0, 6):",
            "            self.getPage('/api/')",
            "        self.assertStatus(429)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Nov 16, 2017",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "",
            "from base64 import b64encode",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class APITest(rdiffweb.test.WebCase):",
            "",
            "    headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))]",
            "",
            "    def test_get_index(self):",
            "        data = self.getJson('/api/', headers=self.headers)",
            "        self.assertIsNotNone(data.get('version'))",
            "",
            "    def test_get_currentuser(self):",
            "        data = self.getJson('/api/currentuser/', headers=self.headers)",
            "        self.assertEqual(data.get('username'), 'admin')",
            "        self.assertEqual(data.get('email'), '')",
            "        # This value change on every execution.",
            "        self.assertEqual(2, len(data.get('repos')))",
            "        repo = data.get('repos')[1]",
            "        self.assertEqual(repo.get('keepdays'), -1)",
            "        self.assertEqual(repo.get('last_backup_date'), '2016-02-02T16:30:40-05:00')",
            "        self.assertEqual(repo.get('status'), 'ok')",
            "        self.assertEqual(repo.get('display_name'), 'testcases')",
            "        self.assertEqual(repo.get('encoding'), 'utf-8')",
            "        self.assertEqual(repo.get('name'), 'testcases')",
            "        self.assertEqual(repo.get('maxage'), 0)",
            "",
            "    def test_getapi_without_authorization(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/')",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_without_username(self):",
            "        \"\"\"",
            "        Check if error 401 is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\":admin123\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_empty_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_invalid_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_authorization(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getapi_with_session(self):",
            "        # Given an authenticate user",
            "        b = {'login': self.USERNAME, 'password': self.PASSWORD}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        # When querying the API",
            "        self.getPage('/api/')",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_auth_with_access_token(self):",
            "        # Given a user with an access token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test').encode('ascii')",
            "        # When using this token to authenticated with /api",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\" + token).decode('ascii'))])",
            "        # Then authentication is successful",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_auth_failed_with_mfa_enabled(self):",
            "        # Given a user with MFA enabled",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.mfa = UserObject.ENABLED_MFA",
            "        userobj.add()",
            "        # When authenticating with /api/",
            "        self.getPage('/api/', headers=self.headers)",
            "        # Then access is refused",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "",
            "class APIRatelimitTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given invalid credentials sent to API",
            "        headers = [(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))]",
            "        for i in range(1, 5):",
            "            self.getPage('/api/', headers=headers)",
            "            self.assertStatus(401)",
            "        # Then the 6th request is refused",
            "        self.getPage('/api/', headers=headers)",
            "        self.assertStatus(429)",
            "        # Next request is also refused event if credentials are valid.",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus(429)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0"
        ],
        "dele_reviseLocation": {
            "127": [
                "APIRatelimitTest",
                "test_login_ratelimit"
            ],
            "128": [
                "APIRatelimitTest",
                "test_login_ratelimit"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_login.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " @author: Patrik Dufresne"
            },
            "2": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " \"\"\""
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+import os"
            },
            "4": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "6": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from parameterized import parameterized"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+from parameterized import parameterized, parameterized_class"
            },
            "8": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " import rdiffweb.test"
            },
            "10": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " from rdiffweb.core.model import DbSession, SessionObject, UserObject"
            },
            "11": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": 212,
                "PatchRowcode": "         self.assertInBody('HEADER-NAME')"
            },
            "12": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": 213,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": 214,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 215,
                "PatchRowcode": "+@parameterized_class("
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 216,
                "PatchRowcode": "+    ["
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 217,
                "PatchRowcode": "+        {\"default_config\": {'rate-limit': 5}},"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 218,
                "PatchRowcode": "+        {\"default_config\": {'rate-limit': 5, 'rate-limit-dir': '/tmp'}},"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 219,
                "PatchRowcode": "+    ]"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 220,
                "PatchRowcode": "+)"
            },
            "20": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": 221,
                "PatchRowcode": " class LoginPageRateLimitTest(rdiffweb.test.WebCase):"
            },
            "21": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "22": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    default_config = {"
            },
            "23": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        'rate-limit': 5,"
            },
            "24": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    }"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 222,
                "PatchRowcode": "+    def setUp(self):"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 223,
                "PatchRowcode": "+        if os.path.isfile('/tmp/ratelimit-127.0.0.1'):"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 224,
                "PatchRowcode": "+            os.unlink('/tmp/ratelimit-127.0.0.1')"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 225,
                "PatchRowcode": "+        if os.path.isfile('/tmp/ratelimit-127.0.0.1.-login'):"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 226,
                "PatchRowcode": "+            os.unlink('/tmp/ratelimit-127.0.0.1.-login')"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 227,
                "PatchRowcode": "+        return super().setUp()"
            },
            "31": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": 228,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": 229,
                "PatchRowcode": "     def test_login_ratelimit(self):"
            },
            "33": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": 230,
                "PatchRowcode": "         # Given an unauthenticate"
            },
            "34": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # When requesting multple time the login page"
            },
            "35": {
                "beforePatchRowNumber": 224,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for i in range(0, 6):"
            },
            "36": {
                "beforePatchRowNumber": 225,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage('/login/')"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 231,
                "PatchRowcode": "+        # When requesting multiple time the login page"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 232,
                "PatchRowcode": "+        for i in range(1, 5):"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 233,
                "PatchRowcode": "+            self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 234,
                "PatchRowcode": "+            self.assertStatus(200)"
            },
            "41": {
                "beforePatchRowNumber": 226,
                "afterPatchRowNumber": 235,
                "PatchRowcode": "         # Then a 429 error (too many request) is return"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 236,
                "PatchRowcode": "+        self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})"
            },
            "43": {
                "beforePatchRowNumber": 227,
                "afterPatchRowNumber": 237,
                "PatchRowcode": "         self.assertStatus(429)"
            },
            "44": {
                "beforePatchRowNumber": 228,
                "afterPatchRowNumber": 238,
                "PatchRowcode": " "
            },
            "45": {
                "beforePatchRowNumber": 229,
                "afterPatchRowNumber": 239,
                "PatchRowcode": " "
            },
            "46": {
                "beforePatchRowNumber": 230,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class LoginPageRateLimitWithSessionDirTest(rdiffweb.test.WebCase):"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 240,
                "PatchRowcode": "+class LoginPageRateLimitTest2(rdiffweb.test.WebCase):"
            },
            "48": {
                "beforePatchRowNumber": 231,
                "afterPatchRowNumber": 241,
                "PatchRowcode": " "
            },
            "49": {
                "beforePatchRowNumber": 232,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    default_config = {"
            },
            "50": {
                "beforePatchRowNumber": 233,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        'rate-limit-dir': '/tmp',"
            },
            "51": {
                "beforePatchRowNumber": 234,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        'rate-limit': 5,"
            },
            "52": {
                "beforePatchRowNumber": 235,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    }"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 242,
                "PatchRowcode": "+    default_config = {'rate-limit': 5}"
            },
            "54": {
                "beforePatchRowNumber": 236,
                "afterPatchRowNumber": 243,
                "PatchRowcode": " "
            },
            "55": {
                "beforePatchRowNumber": 237,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_login_ratelimit(self):"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 244,
                "PatchRowcode": "+    def test_login_ratelimit_forwarded_for(self):"
            },
            "57": {
                "beforePatchRowNumber": 238,
                "afterPatchRowNumber": 245,
                "PatchRowcode": "         # Given an unauthenticate"
            },
            "58": {
                "beforePatchRowNumber": 239,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # When requesting multple time the login page"
            },
            "59": {
                "beforePatchRowNumber": 240,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for i in range(0, 6):"
            },
            "60": {
                "beforePatchRowNumber": 241,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage('/login/')"
            },
            "61": {
                "beforePatchRowNumber": 242,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then a 429 error (too many request) is return"
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 246,
                "PatchRowcode": "+        # When requesting multiple time the login page with different `X-Forwarded-For`"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 247,
                "PatchRowcode": "+        for i in range(1, 5):"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 248,
                "PatchRowcode": "+            self.getPage("
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 249,
                "PatchRowcode": "+                '/login/',"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 250,
                "PatchRowcode": "+                headers=[('X-Forwarded-For', '127.0.0.%s' % i)],"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+                method='POST',"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+                body={'login': 'invalid', 'password': 'invalid'},"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+            )"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 254,
                "PatchRowcode": "+            self.assertStatus(200)"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 255,
                "PatchRowcode": "+        # Then original IP get blocked"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 256,
                "PatchRowcode": "+        self.getPage("
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 257,
                "PatchRowcode": "+            '/login/',"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 258,
                "PatchRowcode": "+            headers=[('X-Forwarded-For', '127.0.0.%s' % i)],"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 259,
                "PatchRowcode": "+            method='POST',"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 260,
                "PatchRowcode": "+            body={'login': 'invalid', 'password': 'invalid'},"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 261,
                "PatchRowcode": "+        )"
            },
            "78": {
                "beforePatchRowNumber": 243,
                "afterPatchRowNumber": 262,
                "PatchRowcode": "         self.assertStatus(429)"
            },
            "79": {
                "beforePatchRowNumber": 244,
                "afterPatchRowNumber": 263,
                "PatchRowcode": " "
            },
            "80": {
                "beforePatchRowNumber": 245,
                "afterPatchRowNumber": 264,
                "PatchRowcode": " "
            },
            "81": {
                "beforePatchRowNumber": 246,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class LoginPageRateLimitTestWithXForwardedFor(rdiffweb.test.WebCase):"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 265,
                "PatchRowcode": "+class LoginPageRateLimitTest3(rdiffweb.test.WebCase):"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 266,
                "PatchRowcode": "+    default_config = {'rate-limit': 5}"
            },
            "84": {
                "beforePatchRowNumber": 247,
                "afterPatchRowNumber": 267,
                "PatchRowcode": " "
            },
            "85": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    default_config = {"
            },
            "86": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        'rate-limit': 5,"
            },
            "87": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    }"
            },
            "88": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "89": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_login_ratelimit(self):"
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 268,
                "PatchRowcode": "+    def test_login_ratelimit_real_ip(self):"
            },
            "91": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": 269,
                "PatchRowcode": "         # Given an unauthenticate"
            },
            "92": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # When requesting multple time the login page"
            },
            "93": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for i in range(0, 6):"
            },
            "94": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage('/login/', headers=[('X-Forwarded-For', '127.0.0.%s' % i)])"
            },
            "95": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then a 429 error (too many request) is return"
            },
            "96": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 270,
                "PatchRowcode": "+        # When requesting multiple time the login page with different `X-Real-IP`"
            },
            "97": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 271,
                "PatchRowcode": "+        for i in range(1, 5):"
            },
            "98": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 272,
                "PatchRowcode": "+            self.getPage("
            },
            "99": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 273,
                "PatchRowcode": "+                '/login/',"
            },
            "100": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 274,
                "PatchRowcode": "+                headers=[('X-Real-IP', '127.0.0.128')],"
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 275,
                "PatchRowcode": "+                method='POST',"
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 276,
                "PatchRowcode": "+                body={'login': 'invalid', 'password': 'invalid'},"
            },
            "103": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 277,
                "PatchRowcode": "+            )"
            },
            "104": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 278,
                "PatchRowcode": "+            self.assertStatus(200)"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 279,
                "PatchRowcode": "+        # Then the X-Real-IP get blocked"
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 280,
                "PatchRowcode": "+        self.getPage("
            },
            "107": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 281,
                "PatchRowcode": "+            '/login/',"
            },
            "108": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 282,
                "PatchRowcode": "+            headers=[('X-Real-IP', '127.0.0.128')],"
            },
            "109": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 283,
                "PatchRowcode": "+            method='POST',"
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 284,
                "PatchRowcode": "+            body={'login': 'invalid', 'password': 'invalid'},"
            },
            "111": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 285,
                "PatchRowcode": "+        )"
            },
            "112": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": 286,
                "PatchRowcode": "         self.assertStatus(429)"
            },
            "113": {
                "beforePatchRowNumber": 259,
                "afterPatchRowNumber": 287,
                "PatchRowcode": " "
            },
            "114": {
                "beforePatchRowNumber": 260,
                "afterPatchRowNumber": 288,
                "PatchRowcode": " "
            },
            "115": {
                "beforePatchRowNumber": 261,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class LoginPageRateLimitTestWithXRealIP(rdiffweb.test.WebCase):"
            },
            "116": {
                "beforePatchRowNumber": 262,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "117": {
                "beforePatchRowNumber": 263,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    default_config = {"
            },
            "118": {
                "beforePatchRowNumber": 264,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        'rate-limit': 5,"
            },
            "119": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    }"
            },
            "120": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "121": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_login_ratelimit(self):"
            },
            "122": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Given an unauthenticate"
            },
            "123": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # When requesting multple time the login page"
            },
            "124": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for i in range(0, 6):"
            },
            "125": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage('/login/', headers=[('X-Real-IP', '127.0.0.%s' % i)])"
            },
            "126": {
                "beforePatchRowNumber": 272,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then a 200 is return."
            },
            "127": {
                "beforePatchRowNumber": 273,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "128": {
                "beforePatchRowNumber": 274,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "129": {
                "beforePatchRowNumber": 275,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "130": {
                "beforePatchRowNumber": 276,
                "afterPatchRowNumber": 289,
                "PatchRowcode": " class LogoutPageTest(rdiffweb.test.WebCase):"
            },
            "131": {
                "beforePatchRowNumber": 277,
                "afterPatchRowNumber": 290,
                "PatchRowcode": "     def test_getpage_without_login(self):"
            },
            "132": {
                "beforePatchRowNumber": 278,
                "afterPatchRowNumber": 291,
                "PatchRowcode": "         # Given an unauthenticated user"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import DbSession, SessionObject, UserObject",
            "from rdiffweb.tools.auth_form import LOGIN_TIME, SESSION_KEY",
            "",
            "",
            "class LoginPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage('/')",
            "        # Then user is redirected to login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a session object is created without a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNone(session.get(SESSION_KEY))",
            "",
            "    def test_login_success(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authenticating with valid credentials.",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then a new session_id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Then a session object is created with a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertEqual('admin', session.get(SESSION_KEY))",
            "        self.assertIsNotNone(session.get(LOGIN_TIME))",
            "",
            "    def test_cookie_http_only(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with HttpOnly",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('HttpOnly', cookie)",
            "",
            "    def test_login_with_plaintext(self):",
            "        \"\"\"",
            "        Requesting plain text without being authenticated should show the login form.",
            "        \"\"\"",
            "        # When querying root page without authentication",
            "        self.getPage('/', headers=[(\"Accept\", \"text/plain\")])",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('with_root', '/'),",
            "            ('with_browse_url', '/browse/admin/testcases/Revisions/'),",
            "            ('with_encoded_url', '/browse/admin/testcases/DIR%EF%BF%BD/'),",
            "            (",
            "                'with_broken_encoding',",
            "                '/restore/admin/testcases/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt/?date=1415221507',",
            "            ),",
            "            ('with_query_string', '/restore/admin/testcases/Revisions?date=1477434528'),",
            "            ('with_multiple_query_string', '/restore/admin/testcases/Revisions?date=1477434528&kind=tar.gz'),",
            "            ('with_admin', '/admin/'),",
            "        ]",
            "    )",
            "    def test_login(self, unused, original_url):",
            "        # Given an unauthenticated user",
            "        # Query the page without login-in",
            "        self.getPage(original_url)",
            "        # Then user is redirected to the login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authentication is successful",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then user is redirected to original URL",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + original_url)",
            "        # When requesting the original page",
            "        self.getPage(original_url)",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "",
            "    def test_getpage_with_redirect_post(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using POST method.",
            "        \"\"\"",
            "        # When posting invalid credentials",
            "        b = {'login': 'admin', 'password': 'invalid', 'redirect': '/browse/' + self.REPO + '/DIR%EF%BF%BD/'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        # Then page return without HTTP Error",
            "        self.assertStatus('200 OK')",
            "        # Then page display an error",
            "        self.assertInBody('Invalid username or password.')",
            "        self.assertInBody('id=\"form-login\"')",
            "        # Then redirect URL is ignored",
            "        self.assertNotInBody('/browse/' + self.REPO + '/DIR%EF%BF%BD/\"')",
            "",
            "    def test_getpage_without_username(self):",
            "        \"\"\"",
            "        Check if error is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/login/', method='GET')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getpage_with_username_too_long(self):",
            "        b = {'login': 'admin' * 52, 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Username too long.')",
            "",
            "    def test_getpage_with_empty_password(self):",
            "        \"\"\"",
            "        Check if authentication is failing without a password.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': ''}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('This field is required.')",
            "",
            "    def test_getpage_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='GET')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_post_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='POST')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_login_twice(self):",
            "        # Given an authenticated user",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "        # Given another user",
            "        UserObject.add_user('otheruser', password='password')",
            "        # When trying to re-authenticated with login page",
            "        self.getPage('/login/', method='POST', body={'login': 'otheruser', 'password': 'password'})",
            "        # Then user is still authenticated with previous user",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "",
            "",
            "class LoginPageWithWelcomeMsgTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'welcomemsg': 'default message', 'welcomemsg[fr]': 'french message'}",
            "",
            "    def test_getpage_default(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"it\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('default message')",
            "",
            "    def test_getpage_french(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"fr\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('french message')",
            "",
            "",
            "class LoginPageWithHeaderName(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'header-name': 'HEADER-NAME'}",
            "",
            "    def test_getpage_default(self):",
            "        # Given a custom header-name",
            "        # When querying the loging page",
            "        self.getPage('/login/')",
            "        # Then the page display the header-name",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('HEADER-NAME')",
            "",
            "",
            "class LoginPageRateLimitTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/')",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitWithSessionDirTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit-dir': '/tmp',",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/')",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTestWithXForwardedFor(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/', headers=[('X-Forwarded-For', '127.0.0.%s' % i)])",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTestWithXRealIP(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/', headers=[('X-Real-IP', '127.0.0.%s' % i)])",
            "        # Then a 200 is return.",
            "        self.assertStatus(200)",
            "",
            "",
            "class LogoutPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage_without_login(self):",
            "        # Given an unauthenticated user",
            "        # When Accessing logout page directly",
            "        self.getPage('/logout')",
            "        # Then user is redirect to root '/'",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "    def test_getpage_with_login(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Login",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        prev_session_id = self.session_id",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('200 OK')",
            "        # When logout",
            "        self.getPage('/logout')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected to root page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "import os",
            "",
            "from parameterized import parameterized, parameterized_class",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import DbSession, SessionObject, UserObject",
            "from rdiffweb.tools.auth_form import LOGIN_TIME, SESSION_KEY",
            "",
            "",
            "class LoginPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage(self):",
            "        # When making a query to a page while unauthenticated",
            "        self.getPage('/')",
            "        # Then user is redirected to login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a session object is created without a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertIsNone(session.get(SESSION_KEY))",
            "",
            "    def test_login_success(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authenticating with valid credentials.",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then a new session_id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Then a session object is created with a username",
            "        self.assertEqual(1, SessionObject.query.filter(SessionObject.id == self.session_id).count())",
            "        SessionObject.query.filter(SessionObject.id == self.session_id).first()",
            "        session = DbSession(id=self.session_id)",
            "        session.load()",
            "        self.assertEqual('admin', session.get(SESSION_KEY))",
            "        self.assertIsNotNone(session.get(LOGIN_TIME))",
            "",
            "    def test_cookie_http_only(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with HttpOnly",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('HttpOnly', cookie)",
            "",
            "    def test_login_with_plaintext(self):",
            "        \"\"\"",
            "        Requesting plain text without being authenticated should show the login form.",
            "        \"\"\"",
            "        # When querying root page without authentication",
            "        self.getPage('/', headers=[(\"Accept\", \"text/plain\")])",
            "        # Then user is redirected to /login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('with_root', '/'),",
            "            ('with_browse_url', '/browse/admin/testcases/Revisions/'),",
            "            ('with_encoded_url', '/browse/admin/testcases/DIR%EF%BF%BD/'),",
            "            (",
            "                'with_broken_encoding',",
            "                '/restore/admin/testcases/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt/?date=1415221507',",
            "            ),",
            "            ('with_query_string', '/restore/admin/testcases/Revisions?date=1477434528'),",
            "            ('with_multiple_query_string', '/restore/admin/testcases/Revisions?date=1477434528&kind=tar.gz'),",
            "            ('with_admin', '/admin/'),",
            "        ]",
            "    )",
            "    def test_login(self, unused, original_url):",
            "        # Given an unauthenticated user",
            "        # Query the page without login-in",
            "        self.getPage(original_url)",
            "        # Then user is redirected to the login page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # When authentication is successful",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        # Then user is redirected to original URL",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + original_url)",
            "        # When requesting the original page",
            "        self.getPage(original_url)",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "",
            "    def test_getpage_with_redirect_post(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using POST method.",
            "        \"\"\"",
            "        # When posting invalid credentials",
            "        b = {'login': 'admin', 'password': 'invalid', 'redirect': '/browse/' + self.REPO + '/DIR%EF%BF%BD/'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        # Then page return without HTTP Error",
            "        self.assertStatus('200 OK')",
            "        # Then page display an error",
            "        self.assertInBody('Invalid username or password.')",
            "        self.assertInBody('id=\"form-login\"')",
            "        # Then redirect URL is ignored",
            "        self.assertNotInBody('/browse/' + self.REPO + '/DIR%EF%BF%BD/\"')",
            "",
            "    def test_getpage_without_username(self):",
            "        \"\"\"",
            "        Check if error is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/login/', method='GET')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getpage_with_username_too_long(self):",
            "        b = {'login': 'admin' * 52, 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Username too long.')",
            "",
            "    def test_getpage_with_empty_password(self):",
            "        \"\"\"",
            "        Check if authentication is failing without a password.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': ''}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('This field is required.')",
            "",
            "    def test_getpage_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='GET')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_post_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='POST')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_login_twice(self):",
            "        # Given an authenticated user",
            "        self.getPage('/login/', method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "        # Given another user",
            "        UserObject.add_user('otheruser', password='password')",
            "        # When trying to re-authenticated with login page",
            "        self.getPage('/login/', method='POST', body={'login': 'otheruser', 'password': 'password'})",
            "        # Then user is still authenticated with previous user",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + \"/\")",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.USERNAME)",
            "",
            "",
            "class LoginPageWithWelcomeMsgTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'welcomemsg': 'default message', 'welcomemsg[fr]': 'french message'}",
            "",
            "    def test_getpage_default(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"it\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('default message')",
            "",
            "    def test_getpage_french(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"fr\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('french message')",
            "",
            "",
            "class LoginPageWithHeaderName(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'header-name': 'HEADER-NAME'}",
            "",
            "    def test_getpage_default(self):",
            "        # Given a custom header-name",
            "        # When querying the loging page",
            "        self.getPage('/login/')",
            "        # Then the page display the header-name",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('HEADER-NAME')",
            "",
            "",
            "@parameterized_class(",
            "    [",
            "        {\"default_config\": {'rate-limit': 5}},",
            "        {\"default_config\": {'rate-limit': 5, 'rate-limit-dir': '/tmp'}},",
            "    ]",
            ")",
            "class LoginPageRateLimitTest(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        if os.path.isfile('/tmp/ratelimit-127.0.0.1'):",
            "            os.unlink('/tmp/ratelimit-127.0.0.1')",
            "        if os.path.isfile('/tmp/ratelimit-127.0.0.1.-login'):",
            "            os.unlink('/tmp/ratelimit-127.0.0.1.-login')",
            "        return super().setUp()",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page",
            "        for i in range(1, 5):",
            "            self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})",
            "            self.assertStatus(200)",
            "        # Then a 429 error (too many request) is return",
            "        self.getPage('/login/', method='POST', body={'login': 'invalid', 'password': 'invalid'})",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTest2(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'rate-limit': 5}",
            "",
            "    def test_login_ratelimit_forwarded_for(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page with different `X-Forwarded-For`",
            "        for i in range(1, 5):",
            "            self.getPage(",
            "                '/login/',",
            "                headers=[('X-Forwarded-For', '127.0.0.%s' % i)],",
            "                method='POST',",
            "                body={'login': 'invalid', 'password': 'invalid'},",
            "            )",
            "            self.assertStatus(200)",
            "        # Then original IP get blocked",
            "        self.getPage(",
            "            '/login/',",
            "            headers=[('X-Forwarded-For', '127.0.0.%s' % i)],",
            "            method='POST',",
            "            body={'login': 'invalid', 'password': 'invalid'},",
            "        )",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTest3(rdiffweb.test.WebCase):",
            "    default_config = {'rate-limit': 5}",
            "",
            "    def test_login_ratelimit_real_ip(self):",
            "        # Given an unauthenticate",
            "        # When requesting multiple time the login page with different `X-Real-IP`",
            "        for i in range(1, 5):",
            "            self.getPage(",
            "                '/login/',",
            "                headers=[('X-Real-IP', '127.0.0.128')],",
            "                method='POST',",
            "                body={'login': 'invalid', 'password': 'invalid'},",
            "            )",
            "            self.assertStatus(200)",
            "        # Then the X-Real-IP get blocked",
            "        self.getPage(",
            "            '/login/',",
            "            headers=[('X-Real-IP', '127.0.0.128')],",
            "            method='POST',",
            "            body={'login': 'invalid', 'password': 'invalid'},",
            "        )",
            "        self.assertStatus(429)",
            "",
            "",
            "class LogoutPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage_without_login(self):",
            "        # Given an unauthenticated user",
            "        # When Accessing logout page directly",
            "        self.getPage('/logout')",
            "        # Then user is redirect to root '/'",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "    def test_getpage_with_login(self):",
            "        # Given an anonymous user",
            "        self.getPage('/')",
            "        prev_session_id = self.session_id",
            "        # Login",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        prev_session_id = self.session_id",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('200 OK')",
            "        # When logout",
            "        self.getPage('/logout')",
            "        # Then a new session id is generated",
            "        self.assertNotEqual(prev_session_id, self.session_id)",
            "        # Then user is redirected to root page",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/general\")",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "23": [],
            "24": [],
            "216": [
                "LoginPageRateLimitTest"
            ],
            "217": [
                "LoginPageRateLimitTest"
            ],
            "218": [
                "LoginPageRateLimitTest"
            ],
            "219": [
                "LoginPageRateLimitTest"
            ],
            "223": [
                "LoginPageRateLimitTest",
                "test_login_ratelimit"
            ],
            "224": [
                "LoginPageRateLimitTest",
                "test_login_ratelimit"
            ],
            "225": [
                "LoginPageRateLimitTest",
                "test_login_ratelimit"
            ],
            "230": [
                "LoginPageRateLimitWithSessionDirTest"
            ],
            "232": [
                "LoginPageRateLimitWithSessionDirTest"
            ],
            "233": [
                "LoginPageRateLimitWithSessionDirTest"
            ],
            "234": [
                "LoginPageRateLimitWithSessionDirTest"
            ],
            "235": [
                "LoginPageRateLimitWithSessionDirTest"
            ],
            "237": [
                "LoginPageRateLimitWithSessionDirTest",
                "test_login_ratelimit"
            ],
            "239": [
                "LoginPageRateLimitWithSessionDirTest",
                "test_login_ratelimit"
            ],
            "240": [
                "LoginPageRateLimitWithSessionDirTest",
                "test_login_ratelimit"
            ],
            "241": [
                "LoginPageRateLimitWithSessionDirTest",
                "test_login_ratelimit"
            ],
            "242": [
                "LoginPageRateLimitWithSessionDirTest",
                "test_login_ratelimit"
            ],
            "246": [
                "LoginPageRateLimitTestWithXForwardedFor"
            ],
            "248": [
                "LoginPageRateLimitTestWithXForwardedFor"
            ],
            "249": [
                "LoginPageRateLimitTestWithXForwardedFor"
            ],
            "250": [
                "LoginPageRateLimitTestWithXForwardedFor"
            ],
            "251": [
                "LoginPageRateLimitTestWithXForwardedFor"
            ],
            "252": [
                "LoginPageRateLimitTestWithXForwardedFor",
                "test_login_ratelimit"
            ],
            "254": [
                "LoginPageRateLimitTestWithXForwardedFor",
                "test_login_ratelimit"
            ],
            "255": [
                "LoginPageRateLimitTestWithXForwardedFor",
                "test_login_ratelimit"
            ],
            "256": [
                "LoginPageRateLimitTestWithXForwardedFor",
                "test_login_ratelimit"
            ],
            "257": [
                "LoginPageRateLimitTestWithXForwardedFor",
                "test_login_ratelimit"
            ],
            "261": [
                "LoginPageRateLimitTestWithXRealIP"
            ],
            "262": [
                "LoginPageRateLimitTestWithXRealIP"
            ],
            "263": [
                "LoginPageRateLimitTestWithXRealIP"
            ],
            "264": [
                "LoginPageRateLimitTestWithXRealIP"
            ],
            "265": [
                "LoginPageRateLimitTestWithXRealIP"
            ],
            "266": [
                "LoginPageRateLimitTestWithXRealIP"
            ],
            "267": [
                "LoginPageRateLimitTestWithXRealIP",
                "test_login_ratelimit"
            ],
            "268": [
                "LoginPageRateLimitTestWithXRealIP",
                "test_login_ratelimit"
            ],
            "269": [
                "LoginPageRateLimitTestWithXRealIP",
                "test_login_ratelimit"
            ],
            "270": [
                "LoginPageRateLimitTestWithXRealIP",
                "test_login_ratelimit"
            ],
            "271": [
                "LoginPageRateLimitTestWithXRealIP",
                "test_login_ratelimit"
            ],
            "272": [
                "LoginPageRateLimitTestWithXRealIP",
                "test_login_ratelimit"
            ],
            "273": [
                "LoginPageRateLimitTestWithXRealIP",
                "test_login_ratelimit"
            ],
            "274": [],
            "275": []
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_prefs_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": 203,
                "PatchRowcode": "         self._set_password(self.PASSWORD, new_password, new_password)"
            },
            "1": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": 204,
                "PatchRowcode": "         self.assertInBody(\"Password must have between 8 and 128 characters.\")"
            },
            "2": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": 205,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 206,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_change_password_too_many_attemps(self):"
            },
            "4": {
                "beforePatchRowNumber": 207,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # When udating user's password with wrong current password 5 times"
            },
            "5": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for _i in range(1, 5):"
            },
            "6": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "7": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertStatus(200)"
            },
            "8": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertInBody(\"Wrong current password.\")"
            },
            "9": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then user session is cleared and user is redirect to login page"
            },
            "10": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "11": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(303)"
            },
            "12": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertHeaderItemValue('Location', self.baseurl + '/login/')"
            },
            "13": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then a warning message is displayed on login page"
            },
            "14": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.getPage('/login/')"
            },
            "15": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "16": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody('You were logged out because you entered the wrong password too many times.')"
            },
            "17": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "18": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": 206,
                "PatchRowcode": "     def test_change_password_with_same_value(self):"
            },
            "19": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": 207,
                "PatchRowcode": "         # Given a user with a password"
            },
            "20": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": 208,
                "PatchRowcode": "         self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "21": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": 241,
                "PatchRowcode": "         # Then the list is free of inexisting repos."
            },
            "22": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": 242,
                "PatchRowcode": "         userobj.expire()"
            },
            "23": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": 243,
                "PatchRowcode": "         self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 244,
                "PatchRowcode": "+"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 245,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 246,
                "PatchRowcode": "+class PagePrefGeneralRateLimitTest(rdiffweb.test.WebCase):"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 247,
                "PatchRowcode": "+    login = True"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 248,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 249,
                "PatchRowcode": "+    default_config = {'rate-limit': 5}"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 250,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+    def test_change_password_too_many_attemps(self):"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+        # When udating user's password with wrong current password 5 times"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+        for _i in range(1, 5):"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 254,
                "PatchRowcode": "+            self.getPage("
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 255,
                "PatchRowcode": "+                '/prefs/general',"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 256,
                "PatchRowcode": "+                method='POST',"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 257,
                "PatchRowcode": "+                body={'action': 'set_password', 'current': 'wrong', 'new': 'pr3j5Dwi', 'confirm': 'pr3j5Dwi'},"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 258,
                "PatchRowcode": "+            )"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 259,
                "PatchRowcode": "+            self.assertStatus(200)"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 260,
                "PatchRowcode": "+            self.assertInBody(\"Wrong current password.\")"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 261,
                "PatchRowcode": "+        # Then user session is cleared and user is redirect to login page"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 262,
                "PatchRowcode": "+        self.getPage("
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 263,
                "PatchRowcode": "+            '/prefs/general',"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 264,
                "PatchRowcode": "+            method='POST',"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 265,
                "PatchRowcode": "+            body={'action': 'set_password', 'current': 'wrong', 'new': 'pr3j5Dwi', 'confirm': 'pr3j5Dwi'},"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 266,
                "PatchRowcode": "+        )"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 267,
                "PatchRowcode": "+        self.assertStatus(303)"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 268,
                "PatchRowcode": "+        self.assertHeaderItemValue('Location', self.baseurl + '/')"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 269,
                "PatchRowcode": "+        # Then a warning message is displayed on login page"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 270,
                "PatchRowcode": "+        self.getPage('/login/')"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 271,
                "PatchRowcode": "+        self.assertStatus(200)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(303)",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test', True),",
            "            ('My Fullname', True),",
            "        ]",
            "    )",
            "    def test_change_fullname(self, new_fullname, expected_valid):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", new_fullname)",
            "        if expected_valid:",
            "            self.assertStatus(303)",
            "            self.getPage(self.PREFS)",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            # Then database is updated with fullname",
            "            self.assertInBody(new_fullname)",
            "            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "            self.assertEqual(new_fullname, user.fullname)",
            "        else:",
            "            self.assertStatus(200)",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(303)",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test@test.com', True),",
            "        ]",
            "    )",
            "    def test_change_email_with_invalid_email(self, new_email, expected_valid):",
            "        self._set_profile_info(new_email)",
            "        if expected_valid:",
            "            self.assertStatus(303)",
            "            self.getPage(self.PREFS)",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            self.assertNotInBody(\"Must be a valid email address.\")",
            "        else:",
            "            self.assertStatus(200)",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "            self.assertInBody(\"Must be a valid email address.\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        # Then user is redirect to same page",
            "        self.assertStatus(303)",
            "        # Then the page return success message.",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong current password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_too_many_attemps(self):",
            "        # When udating user's password with wrong current password 5 times",
            "        for _i in range(1, 5):",
            "            self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"Wrong current password.\")",
            "        # Then user session is cleared and user is redirect to login page",
            "        self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a warning message is displayed on login page",
            "        self.getPage('/login/')",
            "        self.assertStatus(200)",
            "        self.assertInBody('You were logged out because you entered the wrong password too many times.')",
            "",
            "    def test_change_password_with_same_value(self):",
            "        # Given a user with a password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(303)",
            "        # When updating the pasword with the same password",
            "        self._set_password(\"pr3j5Dwi\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(200)",
            "        # Then an error should be displayed",
            "        self.assertInBody(\"The new password must be different from the current password.\")",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(303)",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test', True),",
            "            ('My Fullname', True),",
            "        ]",
            "    )",
            "    def test_change_fullname(self, new_fullname, expected_valid):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", new_fullname)",
            "        if expected_valid:",
            "            self.assertStatus(303)",
            "            self.getPage(self.PREFS)",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            # Then database is updated with fullname",
            "            self.assertInBody(new_fullname)",
            "            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "            self.assertEqual(new_fullname, user.fullname)",
            "        else:",
            "            self.assertStatus(200)",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(303)",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test@test.com', True),",
            "        ]",
            "    )",
            "    def test_change_email_with_invalid_email(self, new_email, expected_valid):",
            "        self._set_profile_info(new_email)",
            "        if expected_valid:",
            "            self.assertStatus(303)",
            "            self.getPage(self.PREFS)",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            self.assertNotInBody(\"Must be a valid email address.\")",
            "        else:",
            "            self.assertStatus(200)",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "            self.assertInBody(\"Must be a valid email address.\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        # Then user is redirect to same page",
            "        self.assertStatus(303)",
            "        # Then the page return success message.",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong current password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_same_value(self):",
            "        # Given a user with a password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(303)",
            "        # When updating the pasword with the same password",
            "        self._set_password(\"pr3j5Dwi\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(200)",
            "        # Then an error should be displayed",
            "        self.assertInBody(\"The new password must be different from the current password.\")",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "",
            "class PagePrefGeneralRateLimitTest(rdiffweb.test.WebCase):",
            "    login = True",
            "",
            "    default_config = {'rate-limit': 5}",
            "",
            "    def test_change_password_too_many_attemps(self):",
            "        # When udating user's password with wrong current password 5 times",
            "        for _i in range(1, 5):",
            "            self.getPage(",
            "                '/prefs/general',",
            "                method='POST',",
            "                body={'action': 'set_password', 'current': 'wrong', 'new': 'pr3j5Dwi', 'confirm': 'pr3j5Dwi'},",
            "            )",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"Wrong current password.\")",
            "        # Then user session is cleared and user is redirect to login page",
            "        self.getPage(",
            "            '/prefs/general',",
            "            method='POST',",
            "            body={'action': 'set_password', 'current': 'wrong', 'new': 'pr3j5Dwi', 'confirm': 'pr3j5Dwi'},",
            "        )",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Then a warning message is displayed on login page",
            "        self.getPage('/login/')",
            "        self.assertStatus(200)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "206": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "207": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "208": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "209": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "210": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "211": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "212": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "213": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "214": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "215": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "216": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "217": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "218": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "219": [
                "PagePrefGeneralTest",
                "test_change_password_too_many_attemps"
            ],
            "220": [
                "PagePrefGeneralTest"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/config.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 404,
                "afterPatchRowNumber": 404,
                "PatchRowcode": "         '--rate-limit',"
            },
            "1": {
                "beforePatchRowNumber": 405,
                "afterPatchRowNumber": 405,
                "PatchRowcode": "         metavar='LIMIT',"
            },
            "2": {
                "beforePatchRowNumber": 406,
                "afterPatchRowNumber": 406,
                "PatchRowcode": "         type=int,"
            },
            "3": {
                "beforePatchRowNumber": 407,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        default=30,"
            },
            "4": {
                "beforePatchRowNumber": 408,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        help='maximum number of requests per minute that can be made by an IP address for an unauthenticated connection. When this limit is reached, an HTTP 429 message is returned to the user. This security measure is used to limit brute force attacks on the login page and the RESTful API.',"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 407,
                "PatchRowcode": "+        default=20,"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 408,
                "PatchRowcode": "+        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API.',"
            },
            "7": {
                "beforePatchRowNumber": 409,
                "afterPatchRowNumber": 409,
                "PatchRowcode": "     )"
            },
            "8": {
                "beforePatchRowNumber": 410,
                "afterPatchRowNumber": 410,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 411,
                "afterPatchRowNumber": 411,
                "PatchRowcode": "     parser.add("
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import argparse",
            "import logging",
            "import re",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import configargparse",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Get rdiffweb version.",
            "try:",
            "    VERSION = pkg_resources.get_distribution(\"rdiffweb\").version",
            "except pkg_resources.DistributionNotFound:",
            "    VERSION = \"DEV\"",
            "",
            "",
            "def get_parser():",
            "    # Get global config argument parser",
            "    parser = configargparse.ArgumentParser(",
            "        prog='rdiffweb',",
            "        description='Web interface to browse and restore rdiff-backup repositories.',",
            "        default_config_files=['/etc/rdiffweb/rdw.conf', '/etc/rdiffweb/rdw.conf.d/*.conf'],",
            "        add_env_var_help=True,",
            "        auto_env_var_prefix='RDIFFWEB_',",
            "        config_file_parser_class=ConfigFileParser,",
            "        conflict_handler='resolve',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-f', '--config', is_config_file=True, metavar='FILE', help='location of Rdiffweb configuration file'",
            "    )",
            "",
            "    parser.add(",
            "        '--database-uri',",
            "        '--sqlitedb-file',",
            "        '--sqlitedbfile',",
            "        metavar='URI',",
            "        help=\"\"\"Location of the database used for persistence. SQLite and PostgreSQL",
            "            database are supported officially. To use a SQLite database you may",
            "            define the location using a file path or a URI.",
            "            e.g.: /srv/rdiffweb/file.db or sqlite:///srv/rdiffweb/file.db`.",
            "            To use PostgreSQL server you must provide",
            "            a URI similar to postgresql://user:pass@10.255.1.34/dbname and you",
            "            must install required dependencies.",
            "            By default, Rdiffweb uses a SQLite embedded database located at",
            "            /etc/rdiffweb/rdw.db.\"\"\",",
            "        default='/etc/rdiffweb/rdw.db',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-d',",
            "        '--debug',",
            "        action='store_true',",
            "        help='enable rdiffweb debug mode - change the log level to DEBUG, print exception stack trace to the web interface and show SQL query in logs',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-user',",
            "        '--adminuser',",
            "        metavar='USERNAME',",
            "        help='administrator username. The administrator user get created on startup if the database is empty.',",
            "        default='admin',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-password',",
            "        metavar='USERNAME',",
            "        help=\"\"\"administrator encrypted password as SSHA. Read online",
            "            documentation to know more about how to encrypt your password",
            "            into SSHA or use http://projects.marsching.org/weave4j/util/genpassword.php",
            "            When defined, administrator password cannot be updated using the web interface.",
            "            When undefined, default administrator password is `admin123` and",
            "            it can be updated using the web interface.\"\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--default-theme',",
            "        '--defaulttheme',",
            "        help='define the default theme. Either: default, blue or orange. Define the CSS file to be loaded in the web interface. You may manually edit a CSS file to customize it. The location is similar to `/usr/local/lib/python3.9/dist-packages/rdiffweb/static/`',",
            "        choices=['default', 'blue', 'orange'],",
            "        default='default',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--environment',",
            "        choices=['development', 'production'],",
            "        help='define the type of environment: development, production. This is used to limit the information shown to the user when an error occur.',",
            "        default='production',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-encryption',",
            "        '--emailencryption',",
            "        choices=['none', 'ssl', 'starttls'],",
            "        help='type of encryption to be used when establishing communication with SMTP server. Default: none',",
            "        default='none',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-host',",
            "        '--emailhost',",
            "        metavar='HOST',",
            "        help='SMTP server used to send email in the form <host>:<port>. If the port is not provided, default to standard port 25 or 465 is used. e.g.: smtp.gmail.com:587',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-sender',",
            "        '--emailsender',",
            "        metavar='EMAIL',",
            "        help='email addres used for the `from:` field when sending email.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-notification-time',",
            "        '--emailnotificationtime',",
            "        metavar='TIME',",
            "        help='time when the email notifcation should be sent for inactive backups. e.g.: 22:00 Default value: 23:00',",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-username',",
            "        '--emailusername',",
            "        metavar='USERNAME',",
            "        help='username used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-password',",
            "        '--emailpassword',",
            "        metavar='PASSWORD',",
            "        help='password used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-send-changed-notification',",
            "        '--emailsendchangednotification',",
            "        help='True to send notification when sensitive information get change in user profile.',",
            "        action='store_true',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--favicon',",
            "        help='location of an icon to be used as a favicon displayed in web browser.',",
            "        default=pkg_resources.resource_filename('rdiffweb', 'static/favicon.ico'),",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-name', '--footername', help=argparse.SUPPRESS, default='rdiffweb'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-url', '--footerurl', help=argparse.SUPPRESS, default='https://rdiffweb.org/'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--header-logo',",
            "        '--headerlogo',",
            "        help='location of an image (preferably a .png) to be used as a replacement for the rdiffweb logo.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--header-name',",
            "        '--headername',",
            "        help='application name displayed in the title bar and header menu.',",
            "        default='Rdiffweb',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-missing-user',",
            "        '--addmissinguser',",
            "        action='store_true',",
            "        help='enable creation of users from LDAP when the credential are valid.',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-role',",
            "        help='default role used when creating users from LDAP. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='user',",
            "        choices=['admin', 'maintainer', 'user'],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-userroot',",
            "        help='default user root directory used when creating users from LDAP. LDAP attributes may be used to define the default location. e.g.: `/backups/{uid[0]}/`. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-uri',",
            "        '--ldapuri',",
            "        help='URL to the LDAP server used to validate user credentials. e.g.: ldap://localhost:389',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-base-dn',",
            "        '--ldapbasedn',",
            "        metavar='DN',",
            "        help='DN of the branch of the directory where all searches should start from. e.g.: dc=my,dc=domain',",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-scope',",
            "        '--ldapscope',",
            "        help='scope of the search. Can be either base, onelevel or subtree',",
            "        choices=['base', 'onelevel', 'subtree'],",
            "        default=\"subtree\",",
            "    )",
            "",
            "    parser.add_argument('--ldap-tls', '--ldaptls', action='store_true', help='enable TLS')",
            "",
            "    parser.add_argument(",
            "        '--ldap-username-attribute',",
            "        '--ldapattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"The attribute to search username. If no attributes are provided, the default is to use `uid`. It's a good idea to choose an attribute that will be unique across all entries in the subtree you will be using.\",",
            "        default='uid',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-filter',",
            "        '--ldapfilter',",
            "        help=\"search filter to limit LDAP lookup. If not provided, defaults to (objectClass=*), which searches for all objects in the tree.\",",
            "        default='(objectClass=*)',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-required-group',",
            "        '--ldaprequiredgroup',",
            "        metavar='GROUPNAME',",
            "        help=\"name of the group of which the user must be a member to access rdiffweb. Should be used with ldap-group-attribute and ldap-group-attribute-is-dn.\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute',",
            "        '--ldapgroupattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"name of the attribute defining the groups of which the user is a member. Should be used with ldap-required-group and ldap-group-attribute-is-dn.\",",
            "        default='member',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute-is-dn',",
            "        '--ldapgroupattributeisdn',",
            "        help=\"True if the content of the attribute `ldap-group-attribute` is a DN.\",",
            "        action='store_true',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-dn',",
            "        '--ldapbinddn',",
            "        metavar='DN',",
            "        help=\"optional DN used to bind to the server when searching for entries. If not provided, will use an anonymous bind.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-password',",
            "        '--ldapbindpassword',",
            "        metavar='PASSWORD',",
            "        help=\"password to use in conjunction with LdapBindDn. Note that the bind password is probably sensitive data, and should be properly protected. You should only use the LdapBindDn and LdapBindPassword if you absolutely need them to search the directory.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-version',",
            "        '--ldapversion',",
            "        '--ldapprotocolversion',",
            "        help=\"version of LDAP in use either 2 or 3. Default to 3.\",",
            "        default=3,",
            "        type=int,",
            "        choices=[2, 3],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-network-timeout',",
            "        '--ldapnetworktimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP connection\",",
            "        default=100,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-timeout',",
            "        '--ldaptimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP request\",",
            "        default=300,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-encoding',",
            "        '--ldapencoding',",
            "        metavar='ENCODING',",
            "        help=\"encoding used by your LDAP server.\",",
            "        default=\"utf-8\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-access-file', '--logaccessfile', metavar='FILE', help='location of Rdiffweb log access file.'",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-file',",
            "        '--logfile',",
            "        metavar='FILE',",
            "        help='location of Rdiffweb log file. Print log to the console if not define in config file.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-level',",
            "        '--loglevel',",
            "        help='Define the log level.',",
            "        choices=['ERROR', 'WARN', 'INFO', 'DEBUG'],",
            "        default='INFO',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--max-depth',",
            "        '--maxdepth',",
            "        metavar='DEPTH',",
            "        help=\"define the maximum folder depthness to search into the user's root directory to find repositories. This is commonly used if you repositories are organised with multiple sub-folder.\",",
            "        type=int,",
            "        default=3,",
            "    )",
            "",
            "    parser.add('--quota-set-cmd', '--quotasetcmd', metavar='COMMAND', help=\"command line to set the user's quota.\")",
            "",
            "    parser.add('--quota-get-cmd', '--quotagetcmd', metavar='COMMAND', help=\"command line to get the user's quota.\")",
            "",
            "    parser.add(",
            "        '--quota-used-cmd', '--quotausedcmd', metavar='COMMAND', help=\"Command line to get user's quota disk usage.\"",
            "    )",
            "",
            "    parser.add(",
            "        '--remove-older-time',",
            "        '--removeoldertime',",
            "        metavar='TIME',",
            "        help=\"Time when to execute the remove older scheduled job. e.g.: 22:30\",",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add('--server-host', '--serverhost', metavar='IP', default='127.0.0.1', help='IP address to listen to')",
            "",
            "    parser.add(",
            "        '--server-port',",
            "        '--serverport',",
            "        metavar='PORT',",
            "        help='port to listen to for HTTP request',",
            "        default='8080',",
            "        type=int,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit-dir',",
            "        '--session-dir',",
            "        '--sessiondir',",
            "        metavar='FOLDER',",
            "        help='location where to store rate-limit information. When undefined, the data is kept in memory. `--session-dir` are deprecated and kept for backward compatibility.',",
            "    )",
            "",
            "    parser.add(",
            "        '--session-timeout',",
            "        metavar='MINUTES',",
            "        help='Sessions will be revoke after this period of inactivity, unless the user selected \"remember me\". Default 15 minutes.',",
            "        default=15,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-persistent-timeout',",
            "        metavar='MINUTES',",
            "        help='Persistent sessions (remember me) will be revoke after this period of inactivity. Default 30 days.',",
            "        default=43200,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit',",
            "        metavar='LIMIT',",
            "        type=int,",
            "        default=30,",
            "        help='maximum number of requests per minute that can be made by an IP address for an unauthenticated connection. When this limit is reached, an HTTP 429 message is returned to the user. This security measure is used to limit brute force attacks on the login page and the RESTful API.',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-certificate',",
            "        '--sslcertificate',",
            "        metavar='CERT',",
            "        help='location of the SSL Certification to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-private-key',",
            "        '--sslprivatekey',",
            "        metavar='KEY',",
            "        help='location of the SSL Private Key to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--tempdir',",
            "        metavar='FOLDER',",
            "        help='alternate temporary folder to be used when restoring files. Might be useful if the default location has limited disk space. Default to TEMPDIR environment or `/tmp`.',",
            "    )",
            "",
            "    parser.add(",
            "        '--disable-ssh-keys',",
            "        action='store_true',",
            "        help='used to hide SSH Key management to avoid users to add or remove SSH Key using the web application',",
            "        default=False,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-min-length',",
            "        type=int,",
            "        help=\"Minimum length of the user's password\",",
            "        default=8,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-max-length',",
            "        type=int,",
            "        help=\"Maximum length of the user's password\",",
            "        default=128,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-score',",
            "        type=lambda x: max(1, min(int(x), 4)),",
            "        help=\"Minimum zxcvbn's score for password. Value from 1 to 4. Default value 2. Read more about it here: https://github.com/dropbox/zxcvbn\",",
            "        default=2,",
            "    )",
            "",
            "    parser.add_argument('--version', action='version', version='%(prog)s ' + VERSION)",
            "",
            "    # Here we append a list of arguments for each locale.",
            "    flags = ['--welcome-msg'] + ['--welcome-msg-' + i for i in ['ca', 'en', 'es', 'fr', 'ru']] + ['--welcomemsg']",
            "    parser.add_argument(",
            "        *flags,",
            "        metavar='HTML',",
            "        help='replace the welcome message displayed in the login page for default locale or for a specific locale',",
            "        action=LocaleAction",
            "    )",
            "    return parser",
            "",
            "",
            "def parse_args(args=None, config_file_contents=None):",
            "    args = sys.argv[1:] if args is None else args",
            "    return get_parser().parse_args(args, config_file_contents=config_file_contents)",
            "",
            "",
            "class LocaleAction(argparse.Action):",
            "    \"\"\"",
            "    Custom Action to support defining arguments with locale.",
            "    \"\"\"",
            "",
            "    def __init__(self, option_strings, dest, nargs=None, **kwargs):",
            "        super(LocaleAction, self).__init__(option_strings, dest, **kwargs)",
            "",
            "    def __call__(self, parser, namespace, value, option_string=None):",
            "        if option_string[-3] == '-':",
            "            # When using arguments, we can extract the locale from the argument key",
            "            locale = option_string[-2:]",
            "        elif value[2] == ':':",
            "            # When using config file, the locale could be extract from the value e.g. fr:message",
            "            locale = value[0:2]",
            "            value = value[3:]",
            "        else:",
            "            locale = ''",
            "        # Create a dictionary with locale.",
            "        items = getattr(namespace, self.dest) or {}",
            "        items[locale] = value",
            "        setattr(namespace, self.dest, items)",
            "",
            "",
            "class ConfigFileParser(object):",
            "    \"\"\"",
            "    Custom config file parser to support rdiffweb config file format.",
            "    \"\"\"",
            "",
            "    def get_syntax_description(self):",
            "        msg = \"Configuration file syntax allows: key=value, flag=true.\"",
            "        return msg",
            "",
            "    def parse(self, stream):",
            "        \"\"\"",
            "        Used to read the rdiffweb config file as dict.",
            "        \"\"\"",
            "",
            "        result = OrderedDict()",
            "",
            "        for i, line in enumerate(stream):",
            "            line = re.compile(\"(.*?)#.*\").sub(r'\\1', line).strip()",
            "            if not line:",
            "                continue",
            "            if '=' not in line:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "            split_line = line.partition('=')",
            "            if not len(split_line) == 3:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "",
            "            # Get key a& value",
            "            key = split_line[0].lower().strip().replace('_', '-')",
            "            value = split_line[2].strip()",
            "",
            "            # Support welcome-msg locale for backward compatibility",
            "            m = re.match(\"welcome-?msg\\\\[(ca|en|es|fr|ru)\\\\]\", key.lower())",
            "            if m:",
            "                key = \"welcome-msg-\" + m.group(1)",
            "                value = m.group(1) + \":\" + value",
            "",
            "            result[key] = value",
            "",
            "        # This dictionary is read by cherrypy. So create appropriate structure.",
            "        return result",
            "",
            "",
            "class Option(object):",
            "    def __init__(self, key):",
            "        assert key",
            "        self.key = key",
            "",
            "    def __get__(self, instance, owner):",
            "        \"\"\"",
            "        Return a property to wrap the given option.",
            "        \"\"\"",
            "        return self.get(instance)",
            "",
            "    def get(self, instance=None):",
            "        \"\"\"",
            "        Return the value of this options.",
            "        \"\"\"",
            "        if isinstance(instance, Application):",
            "            app = instance",
            "        else:",
            "            app = cherrypy.request.app or getattr(instance, 'app', None)",
            "        assert app, \"Option() can't get reference to app\"",
            "        assert app.cfg, \"Option() can't get reference to app.cfg\"",
            "        return getattr(app.cfg, self.key)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import argparse",
            "import logging",
            "import re",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import configargparse",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Get rdiffweb version.",
            "try:",
            "    VERSION = pkg_resources.get_distribution(\"rdiffweb\").version",
            "except pkg_resources.DistributionNotFound:",
            "    VERSION = \"DEV\"",
            "",
            "",
            "def get_parser():",
            "    # Get global config argument parser",
            "    parser = configargparse.ArgumentParser(",
            "        prog='rdiffweb',",
            "        description='Web interface to browse and restore rdiff-backup repositories.',",
            "        default_config_files=['/etc/rdiffweb/rdw.conf', '/etc/rdiffweb/rdw.conf.d/*.conf'],",
            "        add_env_var_help=True,",
            "        auto_env_var_prefix='RDIFFWEB_',",
            "        config_file_parser_class=ConfigFileParser,",
            "        conflict_handler='resolve',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-f', '--config', is_config_file=True, metavar='FILE', help='location of Rdiffweb configuration file'",
            "    )",
            "",
            "    parser.add(",
            "        '--database-uri',",
            "        '--sqlitedb-file',",
            "        '--sqlitedbfile',",
            "        metavar='URI',",
            "        help=\"\"\"Location of the database used for persistence. SQLite and PostgreSQL",
            "            database are supported officially. To use a SQLite database you may",
            "            define the location using a file path or a URI.",
            "            e.g.: /srv/rdiffweb/file.db or sqlite:///srv/rdiffweb/file.db`.",
            "            To use PostgreSQL server you must provide",
            "            a URI similar to postgresql://user:pass@10.255.1.34/dbname and you",
            "            must install required dependencies.",
            "            By default, Rdiffweb uses a SQLite embedded database located at",
            "            /etc/rdiffweb/rdw.db.\"\"\",",
            "        default='/etc/rdiffweb/rdw.db',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-d',",
            "        '--debug',",
            "        action='store_true',",
            "        help='enable rdiffweb debug mode - change the log level to DEBUG, print exception stack trace to the web interface and show SQL query in logs',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-user',",
            "        '--adminuser',",
            "        metavar='USERNAME',",
            "        help='administrator username. The administrator user get created on startup if the database is empty.',",
            "        default='admin',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-password',",
            "        metavar='USERNAME',",
            "        help=\"\"\"administrator encrypted password as SSHA. Read online",
            "            documentation to know more about how to encrypt your password",
            "            into SSHA or use http://projects.marsching.org/weave4j/util/genpassword.php",
            "            When defined, administrator password cannot be updated using the web interface.",
            "            When undefined, default administrator password is `admin123` and",
            "            it can be updated using the web interface.\"\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--default-theme',",
            "        '--defaulttheme',",
            "        help='define the default theme. Either: default, blue or orange. Define the CSS file to be loaded in the web interface. You may manually edit a CSS file to customize it. The location is similar to `/usr/local/lib/python3.9/dist-packages/rdiffweb/static/`',",
            "        choices=['default', 'blue', 'orange'],",
            "        default='default',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--environment',",
            "        choices=['development', 'production'],",
            "        help='define the type of environment: development, production. This is used to limit the information shown to the user when an error occur.',",
            "        default='production',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-encryption',",
            "        '--emailencryption',",
            "        choices=['none', 'ssl', 'starttls'],",
            "        help='type of encryption to be used when establishing communication with SMTP server. Default: none',",
            "        default='none',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-host',",
            "        '--emailhost',",
            "        metavar='HOST',",
            "        help='SMTP server used to send email in the form <host>:<port>. If the port is not provided, default to standard port 25 or 465 is used. e.g.: smtp.gmail.com:587',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-sender',",
            "        '--emailsender',",
            "        metavar='EMAIL',",
            "        help='email addres used for the `from:` field when sending email.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-notification-time',",
            "        '--emailnotificationtime',",
            "        metavar='TIME',",
            "        help='time when the email notifcation should be sent for inactive backups. e.g.: 22:00 Default value: 23:00',",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-username',",
            "        '--emailusername',",
            "        metavar='USERNAME',",
            "        help='username used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-password',",
            "        '--emailpassword',",
            "        metavar='PASSWORD',",
            "        help='password used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-send-changed-notification',",
            "        '--emailsendchangednotification',",
            "        help='True to send notification when sensitive information get change in user profile.',",
            "        action='store_true',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--favicon',",
            "        help='location of an icon to be used as a favicon displayed in web browser.',",
            "        default=pkg_resources.resource_filename('rdiffweb', 'static/favicon.ico'),",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-name', '--footername', help=argparse.SUPPRESS, default='rdiffweb'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-url', '--footerurl', help=argparse.SUPPRESS, default='https://rdiffweb.org/'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--header-logo',",
            "        '--headerlogo',",
            "        help='location of an image (preferably a .png) to be used as a replacement for the rdiffweb logo.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--header-name',",
            "        '--headername',",
            "        help='application name displayed in the title bar and header menu.',",
            "        default='Rdiffweb',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-missing-user',",
            "        '--addmissinguser',",
            "        action='store_true',",
            "        help='enable creation of users from LDAP when the credential are valid.',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-role',",
            "        help='default role used when creating users from LDAP. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='user',",
            "        choices=['admin', 'maintainer', 'user'],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-userroot',",
            "        help='default user root directory used when creating users from LDAP. LDAP attributes may be used to define the default location. e.g.: `/backups/{uid[0]}/`. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-uri',",
            "        '--ldapuri',",
            "        help='URL to the LDAP server used to validate user credentials. e.g.: ldap://localhost:389',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-base-dn',",
            "        '--ldapbasedn',",
            "        metavar='DN',",
            "        help='DN of the branch of the directory where all searches should start from. e.g.: dc=my,dc=domain',",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-scope',",
            "        '--ldapscope',",
            "        help='scope of the search. Can be either base, onelevel or subtree',",
            "        choices=['base', 'onelevel', 'subtree'],",
            "        default=\"subtree\",",
            "    )",
            "",
            "    parser.add_argument('--ldap-tls', '--ldaptls', action='store_true', help='enable TLS')",
            "",
            "    parser.add_argument(",
            "        '--ldap-username-attribute',",
            "        '--ldapattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"The attribute to search username. If no attributes are provided, the default is to use `uid`. It's a good idea to choose an attribute that will be unique across all entries in the subtree you will be using.\",",
            "        default='uid',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-filter',",
            "        '--ldapfilter',",
            "        help=\"search filter to limit LDAP lookup. If not provided, defaults to (objectClass=*), which searches for all objects in the tree.\",",
            "        default='(objectClass=*)',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-required-group',",
            "        '--ldaprequiredgroup',",
            "        metavar='GROUPNAME',",
            "        help=\"name of the group of which the user must be a member to access rdiffweb. Should be used with ldap-group-attribute and ldap-group-attribute-is-dn.\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute',",
            "        '--ldapgroupattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"name of the attribute defining the groups of which the user is a member. Should be used with ldap-required-group and ldap-group-attribute-is-dn.\",",
            "        default='member',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute-is-dn',",
            "        '--ldapgroupattributeisdn',",
            "        help=\"True if the content of the attribute `ldap-group-attribute` is a DN.\",",
            "        action='store_true',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-dn',",
            "        '--ldapbinddn',",
            "        metavar='DN',",
            "        help=\"optional DN used to bind to the server when searching for entries. If not provided, will use an anonymous bind.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-password',",
            "        '--ldapbindpassword',",
            "        metavar='PASSWORD',",
            "        help=\"password to use in conjunction with LdapBindDn. Note that the bind password is probably sensitive data, and should be properly protected. You should only use the LdapBindDn and LdapBindPassword if you absolutely need them to search the directory.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-version',",
            "        '--ldapversion',",
            "        '--ldapprotocolversion',",
            "        help=\"version of LDAP in use either 2 or 3. Default to 3.\",",
            "        default=3,",
            "        type=int,",
            "        choices=[2, 3],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-network-timeout',",
            "        '--ldapnetworktimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP connection\",",
            "        default=100,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-timeout',",
            "        '--ldaptimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP request\",",
            "        default=300,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-encoding',",
            "        '--ldapencoding',",
            "        metavar='ENCODING',",
            "        help=\"encoding used by your LDAP server.\",",
            "        default=\"utf-8\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-access-file', '--logaccessfile', metavar='FILE', help='location of Rdiffweb log access file.'",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-file',",
            "        '--logfile',",
            "        metavar='FILE',",
            "        help='location of Rdiffweb log file. Print log to the console if not define in config file.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-level',",
            "        '--loglevel',",
            "        help='Define the log level.',",
            "        choices=['ERROR', 'WARN', 'INFO', 'DEBUG'],",
            "        default='INFO',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--max-depth',",
            "        '--maxdepth',",
            "        metavar='DEPTH',",
            "        help=\"define the maximum folder depthness to search into the user's root directory to find repositories. This is commonly used if you repositories are organised with multiple sub-folder.\",",
            "        type=int,",
            "        default=3,",
            "    )",
            "",
            "    parser.add('--quota-set-cmd', '--quotasetcmd', metavar='COMMAND', help=\"command line to set the user's quota.\")",
            "",
            "    parser.add('--quota-get-cmd', '--quotagetcmd', metavar='COMMAND', help=\"command line to get the user's quota.\")",
            "",
            "    parser.add(",
            "        '--quota-used-cmd', '--quotausedcmd', metavar='COMMAND', help=\"Command line to get user's quota disk usage.\"",
            "    )",
            "",
            "    parser.add(",
            "        '--remove-older-time',",
            "        '--removeoldertime',",
            "        metavar='TIME',",
            "        help=\"Time when to execute the remove older scheduled job. e.g.: 22:30\",",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add('--server-host', '--serverhost', metavar='IP', default='127.0.0.1', help='IP address to listen to')",
            "",
            "    parser.add(",
            "        '--server-port',",
            "        '--serverport',",
            "        metavar='PORT',",
            "        help='port to listen to for HTTP request',",
            "        default='8080',",
            "        type=int,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit-dir',",
            "        '--session-dir',",
            "        '--sessiondir',",
            "        metavar='FOLDER',",
            "        help='location where to store rate-limit information. When undefined, the data is kept in memory. `--session-dir` are deprecated and kept for backward compatibility.',",
            "    )",
            "",
            "    parser.add(",
            "        '--session-timeout',",
            "        metavar='MINUTES',",
            "        help='Sessions will be revoke after this period of inactivity, unless the user selected \"remember me\". Default 15 minutes.',",
            "        default=15,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-persistent-timeout',",
            "        metavar='MINUTES',",
            "        help='Persistent sessions (remember me) will be revoke after this period of inactivity. Default 30 days.',",
            "        default=43200,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit',",
            "        metavar='LIMIT',",
            "        type=int,",
            "        default=20,",
            "        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API.',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-certificate',",
            "        '--sslcertificate',",
            "        metavar='CERT',",
            "        help='location of the SSL Certification to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-private-key',",
            "        '--sslprivatekey',",
            "        metavar='KEY',",
            "        help='location of the SSL Private Key to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--tempdir',",
            "        metavar='FOLDER',",
            "        help='alternate temporary folder to be used when restoring files. Might be useful if the default location has limited disk space. Default to TEMPDIR environment or `/tmp`.',",
            "    )",
            "",
            "    parser.add(",
            "        '--disable-ssh-keys',",
            "        action='store_true',",
            "        help='used to hide SSH Key management to avoid users to add or remove SSH Key using the web application',",
            "        default=False,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-min-length',",
            "        type=int,",
            "        help=\"Minimum length of the user's password\",",
            "        default=8,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-max-length',",
            "        type=int,",
            "        help=\"Maximum length of the user's password\",",
            "        default=128,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-score',",
            "        type=lambda x: max(1, min(int(x), 4)),",
            "        help=\"Minimum zxcvbn's score for password. Value from 1 to 4. Default value 2. Read more about it here: https://github.com/dropbox/zxcvbn\",",
            "        default=2,",
            "    )",
            "",
            "    parser.add_argument('--version', action='version', version='%(prog)s ' + VERSION)",
            "",
            "    # Here we append a list of arguments for each locale.",
            "    flags = ['--welcome-msg'] + ['--welcome-msg-' + i for i in ['ca', 'en', 'es', 'fr', 'ru']] + ['--welcomemsg']",
            "    parser.add_argument(",
            "        *flags,",
            "        metavar='HTML',",
            "        help='replace the welcome message displayed in the login page for default locale or for a specific locale',",
            "        action=LocaleAction",
            "    )",
            "    return parser",
            "",
            "",
            "def parse_args(args=None, config_file_contents=None):",
            "    args = sys.argv[1:] if args is None else args",
            "    return get_parser().parse_args(args, config_file_contents=config_file_contents)",
            "",
            "",
            "class LocaleAction(argparse.Action):",
            "    \"\"\"",
            "    Custom Action to support defining arguments with locale.",
            "    \"\"\"",
            "",
            "    def __init__(self, option_strings, dest, nargs=None, **kwargs):",
            "        super(LocaleAction, self).__init__(option_strings, dest, **kwargs)",
            "",
            "    def __call__(self, parser, namespace, value, option_string=None):",
            "        if option_string[-3] == '-':",
            "            # When using arguments, we can extract the locale from the argument key",
            "            locale = option_string[-2:]",
            "        elif value[2] == ':':",
            "            # When using config file, the locale could be extract from the value e.g. fr:message",
            "            locale = value[0:2]",
            "            value = value[3:]",
            "        else:",
            "            locale = ''",
            "        # Create a dictionary with locale.",
            "        items = getattr(namespace, self.dest) or {}",
            "        items[locale] = value",
            "        setattr(namespace, self.dest, items)",
            "",
            "",
            "class ConfigFileParser(object):",
            "    \"\"\"",
            "    Custom config file parser to support rdiffweb config file format.",
            "    \"\"\"",
            "",
            "    def get_syntax_description(self):",
            "        msg = \"Configuration file syntax allows: key=value, flag=true.\"",
            "        return msg",
            "",
            "    def parse(self, stream):",
            "        \"\"\"",
            "        Used to read the rdiffweb config file as dict.",
            "        \"\"\"",
            "",
            "        result = OrderedDict()",
            "",
            "        for i, line in enumerate(stream):",
            "            line = re.compile(\"(.*?)#.*\").sub(r'\\1', line).strip()",
            "            if not line:",
            "                continue",
            "            if '=' not in line:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "            split_line = line.partition('=')",
            "            if not len(split_line) == 3:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "",
            "            # Get key a& value",
            "            key = split_line[0].lower().strip().replace('_', '-')",
            "            value = split_line[2].strip()",
            "",
            "            # Support welcome-msg locale for backward compatibility",
            "            m = re.match(\"welcome-?msg\\\\[(ca|en|es|fr|ru)\\\\]\", key.lower())",
            "            if m:",
            "                key = \"welcome-msg-\" + m.group(1)",
            "                value = m.group(1) + \":\" + value",
            "",
            "            result[key] = value",
            "",
            "        # This dictionary is read by cherrypy. So create appropriate structure.",
            "        return result",
            "",
            "",
            "class Option(object):",
            "    def __init__(self, key):",
            "        assert key",
            "        self.key = key",
            "",
            "    def __get__(self, instance, owner):",
            "        \"\"\"",
            "        Return a property to wrap the given option.",
            "        \"\"\"",
            "        return self.get(instance)",
            "",
            "    def get(self, instance=None):",
            "        \"\"\"",
            "        Return the value of this options.",
            "        \"\"\"",
            "        if isinstance(instance, Application):",
            "            app = instance",
            "        else:",
            "            app = cherrypy.request.app or getattr(instance, 'app', None)",
            "        assert app, \"Option() can't get reference to app\"",
            "        assert app.cfg, \"Option() can't get reference to app.cfg\"",
            "        return getattr(app.cfg, self.key)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "407": [
                "get_parser"
            ],
            "408": [
                "get_parser"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/rdw_app.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": 209,
                "PatchRowcode": "                 'tools.sessions.persistent': False,  # auth_form should update this."
            },
            "1": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": 210,
                "PatchRowcode": "                 'tools.auth_form.timeout': cfg.session_persistent_timeout,  # minutes"
            },
            "2": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": 211,
                "PatchRowcode": "                 'tools.ratelimit.debug': cfg.debug,"
            },
            "3": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                'tools.ratelimit.delay': 60,"
            },
            "4": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                'tools.ratelimit.anonymous_limit': cfg.rate_limit,"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 212,
                "PatchRowcode": "+                'tools.ratelimit.delay': 3600,"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 213,
                "PatchRowcode": "+                'tools.ratelimit.limit': cfg.rate_limit,"
            },
            "7": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": 214,
                "PatchRowcode": "                 'tools.ratelimit.storage_class': rate_limit_storage_class,"
            },
            "8": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": 215,
                "PatchRowcode": "                 'tools.ratelimit.storage_path': cfg.rate_limit_dir,"
            },
            "9": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": 216,
                "PatchRowcode": "             },"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "import os",
            "",
            "import cherrypy",
            "import cherrypy.lib.sessions",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "import rdiffweb",
            "import rdiffweb.controller.filter_authorization",
            "import rdiffweb.core.login  # noqa",
            "import rdiffweb.core.notification",
            "import rdiffweb.core.quota",
            "import rdiffweb.core.remove_older",
            "import rdiffweb.plugins.ldap",
            "import rdiffweb.plugins.scheduler",
            "import rdiffweb.plugins.smtp",
            "import rdiffweb.tools.auth_form",
            "import rdiffweb.tools.auth_mfa",
            "import rdiffweb.tools.currentuser",
            "import rdiffweb.tools.db",
            "import rdiffweb.tools.enrich_session",
            "import rdiffweb.tools.errors",
            "import rdiffweb.tools.i18n",
            "import rdiffweb.tools.proxy",
            "import rdiffweb.tools.ratelimit",
            "import rdiffweb.tools.secure_headers",
            "from rdiffweb.controller import Controller",
            "from rdiffweb.controller.api import ApiPage",
            "from rdiffweb.controller.dispatch import staticdir, staticfile",
            "from rdiffweb.controller.page_admin import AdminPage",
            "from rdiffweb.controller.page_browse import BrowsePage",
            "from rdiffweb.controller.page_delete import DeletePage",
            "from rdiffweb.controller.page_graphs import GraphsPage",
            "from rdiffweb.controller.page_history import HistoryPage",
            "from rdiffweb.controller.page_locations import LocationsPage",
            "from rdiffweb.controller.page_login import LoginPage",
            "from rdiffweb.controller.page_logs import LogsPage",
            "from rdiffweb.controller.page_mfa import MfaPage",
            "from rdiffweb.controller.page_pref_sshkeys import ApiSshKeys",
            "from rdiffweb.controller.page_prefs import PreferencesPage",
            "from rdiffweb.controller.page_restore import RestorePage",
            "from rdiffweb.controller.page_settings import SettingsPage",
            "from rdiffweb.controller.page_status import StatusPage",
            "from rdiffweb.core import rdw_templating",
            "from rdiffweb.core.config import Option, parse_args",
            "from rdiffweb.core.model import DbSession, UserObject",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "# Define cherrypy development environment",
            "cherrypy.config.environments['development'] = {",
            "    'engine.autoreload.on': True,",
            "    'checker.on': False,",
            "    'tools.log_headers.on': True,",
            "    'request.show_tracebacks': True,",
            "    'request.show_mismatched_params': True,",
            "    'log.screen': False,",
            "}",
            "",
            "",
            "@cherrypy.tools.auth_form()",
            "@cherrypy.tools.auth_mfa(",
            "    mfa_enabled=lambda username: UserObject.get_user(username).mfa == UserObject.ENABLED_MFA,",
            ")",
            "@cherrypy.tools.currentuser(userobj=lambda username: UserObject.get_user(username))",
            "@cherrypy.tools.db()",
            "@cherrypy.tools.enrich_session()",
            "@cherrypy.tools.proxy(remote='X-Real-IP')",
            "@cherrypy.tools.secure_headers()",
            "class Root(LocationsPage):",
            "    def __init__(self):",
            "        self.login = LoginPage()",
            "        self.mfa = MfaPage()",
            "        self.browse = BrowsePage()",
            "        self.delete = DeletePage()",
            "        self.restore = RestorePage()",
            "        self.history = HistoryPage()",
            "        self.status = StatusPage()",
            "        self.admin = AdminPage()",
            "        self.prefs = PreferencesPage()",
            "        self.settings = SettingsPage()",
            "        self.api = ApiPage()",
            "        self.api.currentuser.sshkeys = ApiSshKeys()",
            "        self.graphs = GraphsPage()",
            "        self.logs = LogsPage()",
            "",
            "        # Register static dir.",
            "        static_dir = pkg_resources.resource_filename('rdiffweb', 'static')  # @UndefinedVariable",
            "        self.static = staticdir(static_dir)",
            "",
            "        # Register robots.txt",
            "        robots_txt = pkg_resources.resource_filename('rdiffweb', 'static/robots.txt')  # @UndefinedVariable",
            "        self.robots_txt = staticfile(robots_txt)",
            "",
            "",
            "class RdiffwebApp(Application):",
            "    \"\"\"This class represent the application context.\"\"\"",
            "",
            "    _favicon = Option('favicon')",
            "",
            "    _header_logo = Option('header_logo')",
            "",
            "    _tempdir = Option('tempdir')",
            "",
            "    @classmethod",
            "    def parse_args(cls, args=None, config_file_contents=None):",
            "        return parse_args(args, config_file_contents)",
            "",
            "    def __init__(self, cfg):",
            "        self.cfg = cfg",
            "        db_uri = self.cfg.database_uri if '://' in self.cfg.database_uri else \"sqlite:///\" + self.cfg.database_uri",
            "        cherrypy.config.update(",
            "            {",
            "                'environment': 'development' if cfg.debug else cfg.environment,",
            "                # Configure database plugins",
            "                'tools.db.uri': db_uri,",
            "                'tools.db.debug': cfg.debug,",
            "                # Configure LDAP plugin",
            "                'ldap.uri': cfg.ldap_uri,",
            "                'ldap.base_dn': cfg.ldap_base_dn,",
            "                'ldap.bind_dn': cfg.ldap_bind_dn,",
            "                'ldap.bind_password': cfg.ldap_bind_password,",
            "                'ldap.scope': cfg.ldap_scope,",
            "                'ldap.tls': cfg.ldap_tls,",
            "                'ldap.username_attribute': cfg.ldap_username_attribute,",
            "                'ldap.required_group': cfg.ldap_required_group,",
            "                'ldap.group_attribute': cfg.ldap_group_attribute,",
            "                'ldap.group_attribute_is_dn': cfg.ldap_group_attribute_is_dn,",
            "                'ldap.version': cfg.ldap_version,",
            "                'ldap.network_timeout': cfg.ldap_network_timeout,",
            "                'ldap.timeout': cfg.ldap_timeout,",
            "                'ldap.encoding': cfg.ldap_encoding,",
            "                # Configure login",
            "                'login.add_missing_user': cfg.ldap_add_missing_user,",
            "                'login.add_user_default_role': cfg.ldap_add_user_default_role,",
            "                'login.add_user_default_userroot': cfg.ldap_add_user_default_userroot,",
            "                # Configure SMTP plugin",
            "                'smtp.server': cfg.email_host,",
            "                'smtp.username': cfg.email_username,",
            "                'smtp.password': cfg.email_password,",
            "                'smtp.email_from': cfg.email_sender",
            "                and '%s <%s>'",
            "                % (",
            "                    cfg.header_name,",
            "                    cfg.email_sender,",
            "                ),",
            "                'smtp.encryption': cfg.email_encryption,",
            "                # Configure remove_older plugin",
            "                'remove_older.execution_time': self.cfg.remove_older_time,",
            "                # Configure notification plugin",
            "                'notification.execution_time': self.cfg.email_notification_time,",
            "                'notification.send_changed': self.cfg.email_send_changed_notification,",
            "                # Configure quota plugin",
            "                'quota.set_quota_cmd': self.cfg.quota_set_cmd,",
            "                'quota.get_quota_cmd': self.cfg.quota_get_cmd,",
            "                'quota.get_usage_cmd': self.cfg.quota_used_cmd,",
            "            }",
            "        )",
            "        # Create database if required",
            "        cherrypy.tools.db.create_all()",
            "",
            "        # Initialise the template engine.",
            "        self.templates = rdw_templating.TemplateManager()",
            "",
            "        # Pick the right implementation for storage",
            "        rate_limit_storage_class = rdiffweb.tools.ratelimit.RamRateLimit",
            "        if cfg.rate_limit_dir:",
            "            rate_limit_storage_class = rdiffweb.tools.ratelimit.FileRateLimit",
            "",
            "        config = {",
            "            '/': {",
            "                # To work around the new behaviour in CherryPy >= 5.5.0, force usage of",
            "                # ISO-8859-1 encoding for URL. This avoid any conversion of the",
            "                # URL into UTF-8.",
            "                'request.uri_encoding': 'ISO-8859-1',",
            "                'tools.i18n.on': True,",
            "                'tools.i18n.default': 'en_US',",
            "                'tools.i18n.mo_dir': pkg_resources.resource_filename('rdiffweb', 'locales'),  # @UndefinedVariable",
            "                'tools.i18n.domain': 'messages',",
            "                'tools.encode.on': True,",
            "                'tools.encode.encoding': 'utf-8',",
            "                'tools.gzip.on': True,",
            "                'error_page.default': self.error_page,",
            "                'tools.sessions.on': True,",
            "                'tools.sessions.debug': cfg.debug,",
            "                'tools.sessions.storage_class': DbSession,",
            "                'tools.sessions.httponly': True,",
            "                'tools.sessions.timeout': cfg.session_timeout,  # minutes",
            "                'tools.sessions.persistent': False,  # auth_form should update this.",
            "                'tools.auth_form.timeout': cfg.session_persistent_timeout,  # minutes",
            "                'tools.ratelimit.debug': cfg.debug,",
            "                'tools.ratelimit.delay': 60,",
            "                'tools.ratelimit.anonymous_limit': cfg.rate_limit,",
            "                'tools.ratelimit.storage_class': rate_limit_storage_class,",
            "                'tools.ratelimit.storage_path': cfg.rate_limit_dir,",
            "            },",
            "        }",
            "",
            "        # Initialize the application",
            "        Application.__init__(self, root=Root(), config=config)",
            "",
            "        # Register favicon.ico",
            "        self.root.favicon_ico = staticfile(self._favicon)",
            "",
            "        # Register header_logo",
            "        if self._header_logo:",
            "            self.root.header_logo = staticfile(self._header_logo)",
            "",
            "        # Define TEMP env",
            "        if self._tempdir:",
            "            os.environ[\"TMPDIR\"] = self._tempdir",
            "",
            "        # create user manager",
            "        UserObject.create_admin_user(cfg.admin_user, cfg.admin_password)",
            "",
            "    @property",
            "    def currentuser(self):",
            "        \"\"\"",
            "        Proxy property to get current user from cherrypy request object.",
            "        Return a UserObject when logged in or None.",
            "        \"\"\"",
            "        return getattr(cherrypy.serving.request, 'currentuser', None)",
            "",
            "    def error_page(self, **kwargs):",
            "        \"\"\"",
            "        Default error page shown to the user when an unexpected error occur.",
            "        \"\"\"",
            "        # Log exception.",
            "        logger.error(",
            "            'error page: %s %s\\n%s' % (kwargs.get('status', ''), kwargs.get('message', ''), kwargs.get('traceback', ''))",
            "        )",
            "",
            "        # Replace message by generic one for 404. Default implementation leak path info.",
            "        if kwargs.get('status', '') == '404 Not Found':",
            "            kwargs['message'] = 'Nothing matches the given URI'",
            "",
            "        # Check expected response type.",
            "        mtype = cherrypy.tools.accept.callable(['text/html', 'text/plain'])  # @UndefinedVariable",
            "        if mtype == 'text/plain':",
            "            return kwargs.get('message')",
            "",
            "        # Try to build a nice error page.",
            "        try:",
            "            page = Controller()",
            "            return page._compile_template('error_page_default.html', **kwargs)",
            "        except Exception:",
            "            # If failing, send the raw error message.",
            "            return kwargs.get('message')",
            "",
            "    @property",
            "    def version(self):",
            "        \"\"\"",
            "        Get the current running version (using package info).",
            "        \"\"\"",
            "        return rdiffweb.__version__"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "import os",
            "",
            "import cherrypy",
            "import cherrypy.lib.sessions",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "import rdiffweb",
            "import rdiffweb.controller.filter_authorization",
            "import rdiffweb.core.login  # noqa",
            "import rdiffweb.core.notification",
            "import rdiffweb.core.quota",
            "import rdiffweb.core.remove_older",
            "import rdiffweb.plugins.ldap",
            "import rdiffweb.plugins.scheduler",
            "import rdiffweb.plugins.smtp",
            "import rdiffweb.tools.auth_form",
            "import rdiffweb.tools.auth_mfa",
            "import rdiffweb.tools.currentuser",
            "import rdiffweb.tools.db",
            "import rdiffweb.tools.enrich_session",
            "import rdiffweb.tools.errors",
            "import rdiffweb.tools.i18n",
            "import rdiffweb.tools.proxy",
            "import rdiffweb.tools.ratelimit",
            "import rdiffweb.tools.secure_headers",
            "from rdiffweb.controller import Controller",
            "from rdiffweb.controller.api import ApiPage",
            "from rdiffweb.controller.dispatch import staticdir, staticfile",
            "from rdiffweb.controller.page_admin import AdminPage",
            "from rdiffweb.controller.page_browse import BrowsePage",
            "from rdiffweb.controller.page_delete import DeletePage",
            "from rdiffweb.controller.page_graphs import GraphsPage",
            "from rdiffweb.controller.page_history import HistoryPage",
            "from rdiffweb.controller.page_locations import LocationsPage",
            "from rdiffweb.controller.page_login import LoginPage",
            "from rdiffweb.controller.page_logs import LogsPage",
            "from rdiffweb.controller.page_mfa import MfaPage",
            "from rdiffweb.controller.page_pref_sshkeys import ApiSshKeys",
            "from rdiffweb.controller.page_prefs import PreferencesPage",
            "from rdiffweb.controller.page_restore import RestorePage",
            "from rdiffweb.controller.page_settings import SettingsPage",
            "from rdiffweb.controller.page_status import StatusPage",
            "from rdiffweb.core import rdw_templating",
            "from rdiffweb.core.config import Option, parse_args",
            "from rdiffweb.core.model import DbSession, UserObject",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "# Define cherrypy development environment",
            "cherrypy.config.environments['development'] = {",
            "    'engine.autoreload.on': True,",
            "    'checker.on': False,",
            "    'tools.log_headers.on': True,",
            "    'request.show_tracebacks': True,",
            "    'request.show_mismatched_params': True,",
            "    'log.screen': False,",
            "}",
            "",
            "",
            "@cherrypy.tools.auth_form()",
            "@cherrypy.tools.auth_mfa(",
            "    mfa_enabled=lambda username: UserObject.get_user(username).mfa == UserObject.ENABLED_MFA,",
            ")",
            "@cherrypy.tools.currentuser(userobj=lambda username: UserObject.get_user(username))",
            "@cherrypy.tools.db()",
            "@cherrypy.tools.enrich_session()",
            "@cherrypy.tools.proxy(remote='X-Real-IP')",
            "@cherrypy.tools.secure_headers()",
            "class Root(LocationsPage):",
            "    def __init__(self):",
            "        self.login = LoginPage()",
            "        self.mfa = MfaPage()",
            "        self.browse = BrowsePage()",
            "        self.delete = DeletePage()",
            "        self.restore = RestorePage()",
            "        self.history = HistoryPage()",
            "        self.status = StatusPage()",
            "        self.admin = AdminPage()",
            "        self.prefs = PreferencesPage()",
            "        self.settings = SettingsPage()",
            "        self.api = ApiPage()",
            "        self.api.currentuser.sshkeys = ApiSshKeys()",
            "        self.graphs = GraphsPage()",
            "        self.logs = LogsPage()",
            "",
            "        # Register static dir.",
            "        static_dir = pkg_resources.resource_filename('rdiffweb', 'static')  # @UndefinedVariable",
            "        self.static = staticdir(static_dir)",
            "",
            "        # Register robots.txt",
            "        robots_txt = pkg_resources.resource_filename('rdiffweb', 'static/robots.txt')  # @UndefinedVariable",
            "        self.robots_txt = staticfile(robots_txt)",
            "",
            "",
            "class RdiffwebApp(Application):",
            "    \"\"\"This class represent the application context.\"\"\"",
            "",
            "    _favicon = Option('favicon')",
            "",
            "    _header_logo = Option('header_logo')",
            "",
            "    _tempdir = Option('tempdir')",
            "",
            "    @classmethod",
            "    def parse_args(cls, args=None, config_file_contents=None):",
            "        return parse_args(args, config_file_contents)",
            "",
            "    def __init__(self, cfg):",
            "        self.cfg = cfg",
            "        db_uri = self.cfg.database_uri if '://' in self.cfg.database_uri else \"sqlite:///\" + self.cfg.database_uri",
            "        cherrypy.config.update(",
            "            {",
            "                'environment': 'development' if cfg.debug else cfg.environment,",
            "                # Configure database plugins",
            "                'tools.db.uri': db_uri,",
            "                'tools.db.debug': cfg.debug,",
            "                # Configure LDAP plugin",
            "                'ldap.uri': cfg.ldap_uri,",
            "                'ldap.base_dn': cfg.ldap_base_dn,",
            "                'ldap.bind_dn': cfg.ldap_bind_dn,",
            "                'ldap.bind_password': cfg.ldap_bind_password,",
            "                'ldap.scope': cfg.ldap_scope,",
            "                'ldap.tls': cfg.ldap_tls,",
            "                'ldap.username_attribute': cfg.ldap_username_attribute,",
            "                'ldap.required_group': cfg.ldap_required_group,",
            "                'ldap.group_attribute': cfg.ldap_group_attribute,",
            "                'ldap.group_attribute_is_dn': cfg.ldap_group_attribute_is_dn,",
            "                'ldap.version': cfg.ldap_version,",
            "                'ldap.network_timeout': cfg.ldap_network_timeout,",
            "                'ldap.timeout': cfg.ldap_timeout,",
            "                'ldap.encoding': cfg.ldap_encoding,",
            "                # Configure login",
            "                'login.add_missing_user': cfg.ldap_add_missing_user,",
            "                'login.add_user_default_role': cfg.ldap_add_user_default_role,",
            "                'login.add_user_default_userroot': cfg.ldap_add_user_default_userroot,",
            "                # Configure SMTP plugin",
            "                'smtp.server': cfg.email_host,",
            "                'smtp.username': cfg.email_username,",
            "                'smtp.password': cfg.email_password,",
            "                'smtp.email_from': cfg.email_sender",
            "                and '%s <%s>'",
            "                % (",
            "                    cfg.header_name,",
            "                    cfg.email_sender,",
            "                ),",
            "                'smtp.encryption': cfg.email_encryption,",
            "                # Configure remove_older plugin",
            "                'remove_older.execution_time': self.cfg.remove_older_time,",
            "                # Configure notification plugin",
            "                'notification.execution_time': self.cfg.email_notification_time,",
            "                'notification.send_changed': self.cfg.email_send_changed_notification,",
            "                # Configure quota plugin",
            "                'quota.set_quota_cmd': self.cfg.quota_set_cmd,",
            "                'quota.get_quota_cmd': self.cfg.quota_get_cmd,",
            "                'quota.get_usage_cmd': self.cfg.quota_used_cmd,",
            "            }",
            "        )",
            "        # Create database if required",
            "        cherrypy.tools.db.create_all()",
            "",
            "        # Initialise the template engine.",
            "        self.templates = rdw_templating.TemplateManager()",
            "",
            "        # Pick the right implementation for storage",
            "        rate_limit_storage_class = rdiffweb.tools.ratelimit.RamRateLimit",
            "        if cfg.rate_limit_dir:",
            "            rate_limit_storage_class = rdiffweb.tools.ratelimit.FileRateLimit",
            "",
            "        config = {",
            "            '/': {",
            "                # To work around the new behaviour in CherryPy >= 5.5.0, force usage of",
            "                # ISO-8859-1 encoding for URL. This avoid any conversion of the",
            "                # URL into UTF-8.",
            "                'request.uri_encoding': 'ISO-8859-1',",
            "                'tools.i18n.on': True,",
            "                'tools.i18n.default': 'en_US',",
            "                'tools.i18n.mo_dir': pkg_resources.resource_filename('rdiffweb', 'locales'),  # @UndefinedVariable",
            "                'tools.i18n.domain': 'messages',",
            "                'tools.encode.on': True,",
            "                'tools.encode.encoding': 'utf-8',",
            "                'tools.gzip.on': True,",
            "                'error_page.default': self.error_page,",
            "                'tools.sessions.on': True,",
            "                'tools.sessions.debug': cfg.debug,",
            "                'tools.sessions.storage_class': DbSession,",
            "                'tools.sessions.httponly': True,",
            "                'tools.sessions.timeout': cfg.session_timeout,  # minutes",
            "                'tools.sessions.persistent': False,  # auth_form should update this.",
            "                'tools.auth_form.timeout': cfg.session_persistent_timeout,  # minutes",
            "                'tools.ratelimit.debug': cfg.debug,",
            "                'tools.ratelimit.delay': 3600,",
            "                'tools.ratelimit.limit': cfg.rate_limit,",
            "                'tools.ratelimit.storage_class': rate_limit_storage_class,",
            "                'tools.ratelimit.storage_path': cfg.rate_limit_dir,",
            "            },",
            "        }",
            "",
            "        # Initialize the application",
            "        Application.__init__(self, root=Root(), config=config)",
            "",
            "        # Register favicon.ico",
            "        self.root.favicon_ico = staticfile(self._favicon)",
            "",
            "        # Register header_logo",
            "        if self._header_logo:",
            "            self.root.header_logo = staticfile(self._header_logo)",
            "",
            "        # Define TEMP env",
            "        if self._tempdir:",
            "            os.environ[\"TMPDIR\"] = self._tempdir",
            "",
            "        # create user manager",
            "        UserObject.create_admin_user(cfg.admin_user, cfg.admin_password)",
            "",
            "    @property",
            "    def currentuser(self):",
            "        \"\"\"",
            "        Proxy property to get current user from cherrypy request object.",
            "        Return a UserObject when logged in or None.",
            "        \"\"\"",
            "        return getattr(cherrypy.serving.request, 'currentuser', None)",
            "",
            "    def error_page(self, **kwargs):",
            "        \"\"\"",
            "        Default error page shown to the user when an unexpected error occur.",
            "        \"\"\"",
            "        # Log exception.",
            "        logger.error(",
            "            'error page: %s %s\\n%s' % (kwargs.get('status', ''), kwargs.get('message', ''), kwargs.get('traceback', ''))",
            "        )",
            "",
            "        # Replace message by generic one for 404. Default implementation leak path info.",
            "        if kwargs.get('status', '') == '404 Not Found':",
            "            kwargs['message'] = 'Nothing matches the given URI'",
            "",
            "        # Check expected response type.",
            "        mtype = cherrypy.tools.accept.callable(['text/html', 'text/plain'])  # @UndefinedVariable",
            "        if mtype == 'text/plain':",
            "            return kwargs.get('message')",
            "",
            "        # Try to build a nice error page.",
            "        try:",
            "            page = Controller()",
            "            return page._compile_template('error_page_default.html', **kwargs)",
            "        except Exception:",
            "            # If failing, send the raw error message.",
            "            return kwargs.get('message')",
            "",
            "    @property",
            "    def version(self):",
            "        \"\"\"",
            "        Get the current running version (using package info).",
            "        \"\"\"",
            "        return rdiffweb.__version__"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "212": [
                "RdiffwebApp",
                "__init__"
            ],
            "213": [
                "RdiffwebApp",
                "__init__"
            ]
        },
        "addLocation": []
    }
}