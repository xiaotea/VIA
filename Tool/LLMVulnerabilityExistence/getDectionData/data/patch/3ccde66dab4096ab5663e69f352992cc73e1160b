{
    "src/MISP_maltego/transforms/attributetoevent.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from canari.maltego.entities import Unknown, Hashtag"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from canari.maltego.transform import Transform"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from MISP_maltego.transforms.common.entities import MISPGalaxy"
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from MISP_maltego.transforms.common.util import check_update, get_misp_connection, event_to_entity, object_to_entity, get_attribute_in_event, get_attribute_in_object, attribute_to_entity, get_entity_property, search_galaxy_cluster, galaxycluster_to_entity, tag_matches_note_prefix"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from MISP_maltego.transforms.common.util import check_update, MISPConnection, event_to_entity, get_attribute_in_event, get_attribute_in_object, attribute_to_entity, get_entity_property, search_galaxy_cluster, galaxycluster_to_entity"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from canari.maltego.message import LinkDirection, Bookmark"
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " __author__ = 'Christophe Vandeplas'"
            },
            "8": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 26,
                "PatchRowcode": "         link_label = 'Search result'"
            },
            "9": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 28,
                "PatchRowcode": "         if 'properties.mispevent' in request.entity.fields:"
            },
            "11": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            misp = get_misp_connection(config, request.parameters)"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+            conn = MISPConnection(config, request.parameters)"
            },
            "13": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "             # if event_id"
            },
            "14": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": "             try:"
            },
            "15": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 32,
                "PatchRowcode": "                 if request.entity.value == '0':"
            },
            "16": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 33,
                "PatchRowcode": "                     return response"
            },
            "17": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "                 eventid = int(request.entity.value)"
            },
            "18": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                events_json = misp.search(controller='events', eventid=eventid, with_attachments=False)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+                events_json = conn.misp.search(controller='events', eventid=eventid, with_attachments=False)"
            },
            "20": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "                 for e in events_json:"
            },
            "21": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "                     response += event_to_entity(e, link_label=link_label, link_direction=LinkDirection.OutputToInput)"
            },
            "22": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": "                 return response"
            },
            "23": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "             except ValueError:"
            },
            "24": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "                 pass"
            },
            "25": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 41,
                "PatchRowcode": "             # if event_info string as value"
            },
            "26": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            events_json = misp.search(controller='events', eventinfo=request.entity.value, with_attachments=False)"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+            events_json = conn.misp.search(controller='events', eventinfo=request.entity.value, with_attachments=False)"
            },
            "28": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 43,
                "PatchRowcode": "             for e in events_json:"
            },
            "29": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "                 response += event_to_entity(e, link_label=link_label, link_direction=LinkDirection.OutputToInput)"
            },
            "30": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "             return response"
            },
            "31": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "                 keyword = get_entity_property(request.entity, 'Temp')"
            },
            "32": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "                 if not keyword:"
            },
            "33": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "                     keyword = request.entity.value"
            },
            "34": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                misp = get_misp_connection(config, request.parameters)"
            },
            "35": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                result = misp.direct_call('tags/search', {'name': keyword})"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+                conn = MISPConnection(config, request.parameters)"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+                result = conn.misp.direct_call('tags/search', {'name': keyword})"
            },
            "38": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "                 for t in result:"
            },
            "39": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "                     # skip misp-galaxies as we have processed them earlier on"
            },
            "40": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "                     if t['Tag']['name'].startswith('misp-galaxy'):"
            },
            "41": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "             return response"
            },
            "42": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 81,
                "PatchRowcode": " "
            },
            "43": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "         # for all other normal entities"
            },
            "44": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        misp = get_misp_connection(config, request.parameters)"
            },
            "45": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        events_json = misp.search(controller='events', value=request.entity.value, with_attachments=False)"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+        conn = MISPConnection(config, request.parameters)"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        events_json = conn.misp.search(controller='events', value=request.entity.value, with_attachments=False)"
            },
            "48": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 85,
                "PatchRowcode": "         # we need to do really rebuild the Entity from scratch as request.entity is of type Unknown"
            },
            "49": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 86,
                "PatchRowcode": "         for e in events_json:"
            },
            "50": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "             # find the value as attribute"
            },
            "51": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "             if 'Object' in e['Event']:"
            },
            "52": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "                 for o in e['Event']['Object']:"
            },
            "53": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "                     if get_attribute_in_object(o, attribute_value=request.entity.value, substring=True).get('value'):"
            },
            "54": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        response += object_to_entity(o, link_label=link_label)"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+                        response += conn.object_to_entity(o, link_label=link_label)"
            },
            "56": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": 97,
                "PatchRowcode": " "
            },
            "57": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "         return response"
            },
            "58": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 99,
                "PatchRowcode": " "
            },
            "59": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "             # placeholder for https://github.com/MISP/MISP-maltego/issues/11"
            },
            "60": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": 138,
                "PatchRowcode": "             pass"
            },
            "61": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 139,
                "PatchRowcode": " "
            },
            "62": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        misp = get_misp_connection(config, request.parameters)"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+        conn = MISPConnection(config, request.parameters)"
            },
            "64": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": 141,
                "PatchRowcode": "         # from Galaxy"
            },
            "65": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": 142,
                "PatchRowcode": "         if 'properties.mispgalaxy' in request.entity.fields:"
            },
            "66": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": 143,
                "PatchRowcode": "             tag_name = get_entity_property(request.entity, 'tag_name')"
            },
            "67": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": 144,
                "PatchRowcode": "             if not tag_name:"
            },
            "68": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": 145,
                "PatchRowcode": "                 tag_name = request.entity.value"
            },
            "69": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            events_json = misp.search(controller='events', tags=tag_name, with_attachments=False)"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+            events_json = conn.misp.search(controller='events', tags=tag_name, with_attachments=False)"
            },
            "71": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "             for e in events_json:"
            },
            "72": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": 148,
                "PatchRowcode": "                 response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)"
            },
            "73": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": 149,
                "PatchRowcode": "             return response"
            },
            "74": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 150,
                "PatchRowcode": "         # from Object"
            },
            "75": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 151,
                "PatchRowcode": "         elif 'properties.mispobject' in request.entity.fields:"
            },
            "76": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": 152,
                "PatchRowcode": "             if request.entity.fields.get('event_id'):"
            },
            "77": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                events_json = misp.search(controller='events', eventid=request.entity.fields.get('event_id').value, with_attachments=False)"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+                events_json = conn.misp.search(controller='events', eventid=request.entity.fields.get('event_id').value, with_attachments=False)"
            },
            "79": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": 154,
                "PatchRowcode": "                 for e in events_json:"
            },
            "80": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": 155,
                "PatchRowcode": "                     response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)"
            },
            "81": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 156,
                "PatchRowcode": "                 return response"
            },
            "82": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 161,
                "PatchRowcode": "             tag_name = get_entity_property(request.entity, 'Temp')"
            },
            "83": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": 162,
                "PatchRowcode": "             if not tag_name:"
            },
            "84": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": 163,
                "PatchRowcode": "                 tag_name = request.entity.value"
            },
            "85": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            events_json = misp.search(controller='events', tags=tag_name, with_attachments=False)"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+            events_json = conn.misp.search(controller='events', tags=tag_name, with_attachments=False)"
            },
            "87": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": 165,
                "PatchRowcode": "             for e in events_json:"
            },
            "88": {
                "beforePatchRowNumber": 166,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "                 response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)"
            },
            "89": {
                "beforePatchRowNumber": 167,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "             return response"
            },
            "90": {
                "beforePatchRowNumber": 168,
                "afterPatchRowNumber": 168,
                "PatchRowcode": "         # standard Entities (normal attributes)"
            },
            "91": {
                "beforePatchRowNumber": 169,
                "afterPatchRowNumber": 169,
                "PatchRowcode": "         else:"
            },
            "92": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            events_json = misp.search(controller='events', value=request.entity.value, with_attachments=False)"
            },
            "93": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 170,
                "PatchRowcode": "+            events_json = conn.misp.search(controller='events', value=request.entity.value, with_attachments=False)"
            },
            "94": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": 171,
                "PatchRowcode": " "
            },
            "95": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 172,
                "PatchRowcode": "         # return the MISPEvent or MISPObject of the attribute"
            },
            "96": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": 173,
                "PatchRowcode": "         for e in events_json:"
            },
            "97": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 179,
                "PatchRowcode": "             if 'Object' in e['Event']:"
            },
            "98": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 180,
                "PatchRowcode": "                 for o in e['Event']['Object']:"
            },
            "99": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 181,
                "PatchRowcode": "                     if get_attribute_in_object(o, attribute_value=request.entity.value).get('value'):"
            },
            "100": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        response += object_to_entity(o, link_direction=LinkDirection.OutputToInput)"
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+                        response += conn.object_to_entity(o, link_direction=LinkDirection.OutputToInput)"
            },
            "102": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": 183,
                "PatchRowcode": " "
            },
            "103": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": 184,
                "PatchRowcode": "         return response"
            }
        },
        "frontPatchFile": [
            "from canari.maltego.entities import Unknown, Hashtag",
            "from canari.maltego.transform import Transform",
            "from MISP_maltego.transforms.common.entities import MISPGalaxy",
            "from MISP_maltego.transforms.common.util import check_update, get_misp_connection, event_to_entity, object_to_entity, get_attribute_in_event, get_attribute_in_object, attribute_to_entity, get_entity_property, search_galaxy_cluster, galaxycluster_to_entity, tag_matches_note_prefix",
            "from canari.maltego.message import LinkDirection, Bookmark",
            "",
            "__author__ = 'Christophe Vandeplas'",
            "__copyright__ = 'Copyright 2018, MISP_maltego Project'",
            "__credits__ = []",
            "",
            "__license__ = 'AGPLv3'",
            "__version__ = '0.1'",
            "__maintainer__ = 'Christophe Vandeplas'",
            "__email__ = 'christophe@vandeplas.com'",
            "__status__ = 'Development'",
            "",
            "",
            "class SearchInMISP(Transform):",
            "    \"\"\"Search an attribute, event in MISP, allowing the use of % at the front and end\"\"\"",
            "    input_type = Unknown",
            "    display_name = 'Search in MISP'",
            "    remote = True",
            "",
            "    def do_transform(self, request, response, config):",
            "        response += check_update(config)",
            "        link_label = 'Search result'",
            "",
            "        if 'properties.mispevent' in request.entity.fields:",
            "            misp = get_misp_connection(config, request.parameters)",
            "            # if event_id",
            "            try:",
            "                if request.entity.value == '0':",
            "                    return response",
            "                eventid = int(request.entity.value)",
            "                events_json = misp.search(controller='events', eventid=eventid, with_attachments=False)",
            "                for e in events_json:",
            "                    response += event_to_entity(e, link_label=link_label, link_direction=LinkDirection.OutputToInput)",
            "                return response",
            "            except ValueError:",
            "                pass",
            "            # if event_info string as value",
            "            events_json = misp.search(controller='events', eventinfo=request.entity.value, with_attachments=False)",
            "            for e in events_json:",
            "                response += event_to_entity(e, link_label=link_label, link_direction=LinkDirection.OutputToInput)",
            "            return response",
            "",
            "        # From galaxy or Hashtag",
            "        if 'properties.mispgalaxy' in request.entity.fields or 'properties.temp' in request.entity.fields:",
            "            if request.entity.value == '-':",
            "                return response",
            "            # First search in galaxies",
            "            keyword = get_entity_property(request.entity, 'Temp')",
            "            if not keyword:",
            "                keyword = request.entity.value",
            "            # assume the user is searching for a cluster based on a substring.",
            "            # Search in the list for those that match and return galaxy entities'",
            "            potential_clusters = search_galaxy_cluster(keyword)",
            "            # LATER check if duplicates are possible",
            "            if potential_clusters:",
            "                for potential_cluster in potential_clusters:",
            "                    new_entity = galaxycluster_to_entity(potential_cluster, link_label=link_label)",
            "                    # LATER support the type_filter - unfortunately this is not possible, we need Canari to tell us the original entity type",
            "                    if isinstance(new_entity, MISPGalaxy):",
            "                        response += new_entity",
            "",
            "            # from Hashtag search also in tags",
            "            if 'properties.temp' in request.entity.fields:",
            "                keyword = get_entity_property(request.entity, 'Temp')",
            "                if not keyword:",
            "                    keyword = request.entity.value",
            "                misp = get_misp_connection(config, request.parameters)",
            "                result = misp.direct_call('tags/search', {'name': keyword})",
            "                for t in result:",
            "                    # skip misp-galaxies as we have processed them earlier on",
            "                    if t['Tag']['name'].startswith('misp-galaxy'):",
            "                        continue",
            "                    # In this case we do not filter away those we add as notes, as people might want to pivot on it explicitly.",
            "                    response += Hashtag(t['Tag']['name'], link_label=link_label, bookmark=Bookmark.Green)",
            "",
            "            return response",
            "",
            "        # for all other normal entities",
            "        misp = get_misp_connection(config, request.parameters)",
            "        events_json = misp.search(controller='events', value=request.entity.value, with_attachments=False)",
            "        # we need to do really rebuild the Entity from scratch as request.entity is of type Unknown",
            "        for e in events_json:",
            "            # find the value as attribute",
            "            attr = get_attribute_in_event(e, request.entity.value, substring=True)",
            "            if attr:",
            "                for item in attribute_to_entity(attr, only_self=True):",
            "                    response += item",
            "            # find the value as object, and return the object",
            "            if 'Object' in e['Event']:",
            "                for o in e['Event']['Object']:",
            "                    if get_attribute_in_object(o, attribute_value=request.entity.value, substring=True).get('value'):",
            "                        response += object_to_entity(o, link_label=link_label)",
            "",
            "        return response",
            "",
            "# placeholder for https://github.com/MISP/MISP-maltego/issues/11",
            "# waiting for support of CIDR search through the REST API",
            "# @EnableDebugWindow",
            "# class NetblockToAttributes(Transform):",
            "#     display_name = 'to MISP Attributes'",
            "#     input_type = Netblock",
            "#     remote = True",
            "",
            "#     def do_transform(self, request, response, config):",
            "#         maltego_misp_attribute = request.entity",
            "#         misp = get_misp_connection(config, request.parameters)",
            "#         import ipaddress",
            "#         ip_start, ip_end = maltego_misp_attribute.value.split('-')",
            "#         # LATER make this work with IPv4 and IPv6",
            "#         # automagically detect the different CIDRs",
            "#         cidrs = ipaddress.summarize_address_range(ipaddress.IPv4Address(ip_start), ipaddress.IPv4Address(ip_end))",
            "#         for cidr in cidrs:",
            "#             print(str(cidr))",
            "#             attr_json = misp.search(controller='attributes', value=str(cidr), with_attachments=False)",
            "#             print(attr_json)",
            "#         return response",
            "",
            "",
            "class AttributeToEvent(Transform):",
            "    input_type = Unknown",
            "    display_name = 'to MISP Event'",
            "    remote = True",
            "",
            "    def do_transform(self, request, response, config):",
            "        response += check_update(config)",
            "        # skip some Entities",
            "        skip = ['properties.mispevent']",
            "        for i in skip:",
            "            if i in request.entity.fields:",
            "                return response",
            "",
            "        if 'ipv4-range' in request.entity.fields:",
            "            # placeholder for https://github.com/MISP/MISP-maltego/issues/11",
            "            pass",
            "",
            "        misp = get_misp_connection(config, request.parameters)",
            "        # from Galaxy",
            "        if 'properties.mispgalaxy' in request.entity.fields:",
            "            tag_name = get_entity_property(request.entity, 'tag_name')",
            "            if not tag_name:",
            "                tag_name = request.entity.value",
            "            events_json = misp.search(controller='events', tags=tag_name, with_attachments=False)",
            "            for e in events_json:",
            "                response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "            return response",
            "        # from Object",
            "        elif 'properties.mispobject' in request.entity.fields:",
            "            if request.entity.fields.get('event_id'):",
            "                events_json = misp.search(controller='events', eventid=request.entity.fields.get('event_id').value, with_attachments=False)",
            "                for e in events_json:",
            "                    response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "                return response",
            "            else:",
            "                return response",
            "        # from Hashtag",
            "        elif 'properties.temp' in request.entity.fields:",
            "            tag_name = get_entity_property(request.entity, 'Temp')",
            "            if not tag_name:",
            "                tag_name = request.entity.value",
            "            events_json = misp.search(controller='events', tags=tag_name, with_attachments=False)",
            "            for e in events_json:",
            "                response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "            return response",
            "        # standard Entities (normal attributes)",
            "        else:",
            "            events_json = misp.search(controller='events', value=request.entity.value, with_attachments=False)",
            "",
            "        # return the MISPEvent or MISPObject of the attribute",
            "        for e in events_json:",
            "            # find the value as attribute",
            "            attr = get_attribute_in_event(e, request.entity.value)",
            "            if attr:",
            "                response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "            # find the value as object",
            "            if 'Object' in e['Event']:",
            "                for o in e['Event']['Object']:",
            "                    if get_attribute_in_object(o, attribute_value=request.entity.value).get('value'):",
            "                        response += object_to_entity(o, link_direction=LinkDirection.OutputToInput)",
            "",
            "        return response"
        ],
        "afterPatchFile": [
            "from canari.maltego.entities import Unknown, Hashtag",
            "from canari.maltego.transform import Transform",
            "from MISP_maltego.transforms.common.entities import MISPGalaxy",
            "from MISP_maltego.transforms.common.util import check_update, MISPConnection, event_to_entity, get_attribute_in_event, get_attribute_in_object, attribute_to_entity, get_entity_property, search_galaxy_cluster, galaxycluster_to_entity",
            "from canari.maltego.message import LinkDirection, Bookmark",
            "",
            "__author__ = 'Christophe Vandeplas'",
            "__copyright__ = 'Copyright 2018, MISP_maltego Project'",
            "__credits__ = []",
            "",
            "__license__ = 'AGPLv3'",
            "__version__ = '0.1'",
            "__maintainer__ = 'Christophe Vandeplas'",
            "__email__ = 'christophe@vandeplas.com'",
            "__status__ = 'Development'",
            "",
            "",
            "class SearchInMISP(Transform):",
            "    \"\"\"Search an attribute, event in MISP, allowing the use of % at the front and end\"\"\"",
            "    input_type = Unknown",
            "    display_name = 'Search in MISP'",
            "    remote = True",
            "",
            "    def do_transform(self, request, response, config):",
            "        response += check_update(config)",
            "        link_label = 'Search result'",
            "",
            "        if 'properties.mispevent' in request.entity.fields:",
            "            conn = MISPConnection(config, request.parameters)",
            "            # if event_id",
            "            try:",
            "                if request.entity.value == '0':",
            "                    return response",
            "                eventid = int(request.entity.value)",
            "                events_json = conn.misp.search(controller='events', eventid=eventid, with_attachments=False)",
            "                for e in events_json:",
            "                    response += event_to_entity(e, link_label=link_label, link_direction=LinkDirection.OutputToInput)",
            "                return response",
            "            except ValueError:",
            "                pass",
            "            # if event_info string as value",
            "            events_json = conn.misp.search(controller='events', eventinfo=request.entity.value, with_attachments=False)",
            "            for e in events_json:",
            "                response += event_to_entity(e, link_label=link_label, link_direction=LinkDirection.OutputToInput)",
            "            return response",
            "",
            "        # From galaxy or Hashtag",
            "        if 'properties.mispgalaxy' in request.entity.fields or 'properties.temp' in request.entity.fields:",
            "            if request.entity.value == '-':",
            "                return response",
            "            # First search in galaxies",
            "            keyword = get_entity_property(request.entity, 'Temp')",
            "            if not keyword:",
            "                keyword = request.entity.value",
            "            # assume the user is searching for a cluster based on a substring.",
            "            # Search in the list for those that match and return galaxy entities'",
            "            potential_clusters = search_galaxy_cluster(keyword)",
            "            # LATER check if duplicates are possible",
            "            if potential_clusters:",
            "                for potential_cluster in potential_clusters:",
            "                    new_entity = galaxycluster_to_entity(potential_cluster, link_label=link_label)",
            "                    # LATER support the type_filter - unfortunately this is not possible, we need Canari to tell us the original entity type",
            "                    if isinstance(new_entity, MISPGalaxy):",
            "                        response += new_entity",
            "",
            "            # from Hashtag search also in tags",
            "            if 'properties.temp' in request.entity.fields:",
            "                keyword = get_entity_property(request.entity, 'Temp')",
            "                if not keyword:",
            "                    keyword = request.entity.value",
            "                conn = MISPConnection(config, request.parameters)",
            "                result = conn.misp.direct_call('tags/search', {'name': keyword})",
            "                for t in result:",
            "                    # skip misp-galaxies as we have processed them earlier on",
            "                    if t['Tag']['name'].startswith('misp-galaxy'):",
            "                        continue",
            "                    # In this case we do not filter away those we add as notes, as people might want to pivot on it explicitly.",
            "                    response += Hashtag(t['Tag']['name'], link_label=link_label, bookmark=Bookmark.Green)",
            "",
            "            return response",
            "",
            "        # for all other normal entities",
            "        conn = MISPConnection(config, request.parameters)",
            "        events_json = conn.misp.search(controller='events', value=request.entity.value, with_attachments=False)",
            "        # we need to do really rebuild the Entity from scratch as request.entity is of type Unknown",
            "        for e in events_json:",
            "            # find the value as attribute",
            "            attr = get_attribute_in_event(e, request.entity.value, substring=True)",
            "            if attr:",
            "                for item in attribute_to_entity(attr, only_self=True):",
            "                    response += item",
            "            # find the value as object, and return the object",
            "            if 'Object' in e['Event']:",
            "                for o in e['Event']['Object']:",
            "                    if get_attribute_in_object(o, attribute_value=request.entity.value, substring=True).get('value'):",
            "                        response += conn.object_to_entity(o, link_label=link_label)",
            "",
            "        return response",
            "",
            "# placeholder for https://github.com/MISP/MISP-maltego/issues/11",
            "# waiting for support of CIDR search through the REST API",
            "# @EnableDebugWindow",
            "# class NetblockToAttributes(Transform):",
            "#     display_name = 'to MISP Attributes'",
            "#     input_type = Netblock",
            "#     remote = True",
            "",
            "#     def do_transform(self, request, response, config):",
            "#         maltego_misp_attribute = request.entity",
            "#         misp = get_misp_connection(config, request.parameters)",
            "#         import ipaddress",
            "#         ip_start, ip_end = maltego_misp_attribute.value.split('-')",
            "#         # LATER make this work with IPv4 and IPv6",
            "#         # automagically detect the different CIDRs",
            "#         cidrs = ipaddress.summarize_address_range(ipaddress.IPv4Address(ip_start), ipaddress.IPv4Address(ip_end))",
            "#         for cidr in cidrs:",
            "#             print(str(cidr))",
            "#             attr_json = misp.search(controller='attributes', value=str(cidr), with_attachments=False)",
            "#             print(attr_json)",
            "#         return response",
            "",
            "",
            "class AttributeToEvent(Transform):",
            "    input_type = Unknown",
            "    display_name = 'to MISP Event'",
            "    remote = True",
            "",
            "    def do_transform(self, request, response, config):",
            "        response += check_update(config)",
            "        # skip some Entities",
            "        skip = ['properties.mispevent']",
            "        for i in skip:",
            "            if i in request.entity.fields:",
            "                return response",
            "",
            "        if 'ipv4-range' in request.entity.fields:",
            "            # placeholder for https://github.com/MISP/MISP-maltego/issues/11",
            "            pass",
            "",
            "        conn = MISPConnection(config, request.parameters)",
            "        # from Galaxy",
            "        if 'properties.mispgalaxy' in request.entity.fields:",
            "            tag_name = get_entity_property(request.entity, 'tag_name')",
            "            if not tag_name:",
            "                tag_name = request.entity.value",
            "            events_json = conn.misp.search(controller='events', tags=tag_name, with_attachments=False)",
            "            for e in events_json:",
            "                response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "            return response",
            "        # from Object",
            "        elif 'properties.mispobject' in request.entity.fields:",
            "            if request.entity.fields.get('event_id'):",
            "                events_json = conn.misp.search(controller='events', eventid=request.entity.fields.get('event_id').value, with_attachments=False)",
            "                for e in events_json:",
            "                    response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "                return response",
            "            else:",
            "                return response",
            "        # from Hashtag",
            "        elif 'properties.temp' in request.entity.fields:",
            "            tag_name = get_entity_property(request.entity, 'Temp')",
            "            if not tag_name:",
            "                tag_name = request.entity.value",
            "            events_json = conn.misp.search(controller='events', tags=tag_name, with_attachments=False)",
            "            for e in events_json:",
            "                response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "            return response",
            "        # standard Entities (normal attributes)",
            "        else:",
            "            events_json = conn.misp.search(controller='events', value=request.entity.value, with_attachments=False)",
            "",
            "        # return the MISPEvent or MISPObject of the attribute",
            "        for e in events_json:",
            "            # find the value as attribute",
            "            attr = get_attribute_in_event(e, request.entity.value)",
            "            if attr:",
            "                response += event_to_entity(e, link_direction=LinkDirection.OutputToInput)",
            "            # find the value as object",
            "            if 'Object' in e['Event']:",
            "                for o in e['Event']['Object']:",
            "                    if get_attribute_in_object(o, attribute_value=request.entity.value).get('value'):",
            "                        response += conn.object_to_entity(o, link_direction=LinkDirection.OutputToInput)",
            "",
            "        return response"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "4": [],
            "29": [
                "SearchInMISP",
                "do_transform"
            ],
            "35": [
                "SearchInMISP",
                "do_transform"
            ],
            "42": [
                "SearchInMISP",
                "do_transform"
            ],
            "71": [
                "SearchInMISP",
                "do_transform"
            ],
            "72": [
                "SearchInMISP",
                "do_transform"
            ],
            "83": [
                "SearchInMISP",
                "do_transform"
            ],
            "84": [
                "SearchInMISP",
                "do_transform"
            ],
            "96": [
                "SearchInMISP",
                "do_transform"
            ],
            "140": [
                "AttributeToEvent",
                "do_transform"
            ],
            "146": [
                "AttributeToEvent",
                "do_transform"
            ],
            "153": [
                "AttributeToEvent",
                "do_transform"
            ],
            "164": [
                "AttributeToEvent",
                "do_transform"
            ],
            "170": [
                "AttributeToEvent",
                "do_transform"
            ],
            "182": [
                "AttributeToEvent",
                "do_transform"
            ]
        },
        "addLocation": []
    },
    "src/MISP_maltego/transforms/common/util.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " tag_note_prefixes = ['tlp:', 'PAP:', 'de-vs:', 'euci:', 'fr-classif:', 'nato:']"
            },
            "2": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-misp_connection = None"
            },
            "4": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " update_url = 'https://raw.githubusercontent.com/MISP/MISP-maltego/master/setup.py'"
            },
            "5": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " local_path_root = os.path.join(tempfile.gettempdir(), 'MISP-maltego')"
            },
            "6": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " local_path_version = os.path.join(local_path_root, 'versioncheck')"
            },
            "7": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "     return None"
            },
            "8": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 64,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 65,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def get_misp_connection(config=None, parameters=None):"
            },
            "11": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    global misp_connection"
            },
            "12": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if misp_connection:"
            },
            "13": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return misp_connection"
            },
            "14": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if not config:"
            },
            "15": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        raise MaltegoException(\"ERROR: MISP connection not yet established, and config not provided as parameter.\")"
            },
            "16": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    misp_verify = True"
            },
            "17": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    misp_debug = False"
            },
            "18": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    misp_url = None"
            },
            "19": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    misp_key = None"
            },
            "20": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    try:"
            },
            "21": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if is_local_exec_mode():"
            },
            "22": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            misp_url = config['MISP_maltego.local.misp_url']"
            },
            "23": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            misp_key = config['MISP_maltego.local.misp_key']"
            },
            "24": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if config['MISP_maltego.local.misp_verify'] in ['False', 'false', 0, 'no', 'No']:"
            },
            "25": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                misp_verify = False"
            },
            "26": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if config['MISP_maltego.local.misp_debug'] in ['True', 'true', 1, 'yes', 'Yes']:"
            },
            "27": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                misp_debug = True"
            },
            "28": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if is_remote_exec_mode():"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+class MISPConnection():"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+    def __init__(self, config=None, parameters=None):"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+        self.misp = None"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+        if not config:"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+            raise MaltegoException(\"ERROR: MISP connection not yet established, and config not provided as parameter.\")"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+        misp_verify = True"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+        misp_debug = False"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+        misp_url = None"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+        misp_key = None"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 76,
                "PatchRowcode": "+        try:"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+            if is_local_exec_mode():"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 78,
                "PatchRowcode": "+                misp_url = config['MISP_maltego.local.misp_url']"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+                misp_key = config['MISP_maltego.local.misp_key']"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 80,
                "PatchRowcode": "+                if config['MISP_maltego.local.misp_verify'] in ['False', 'false', 0, 'no', 'No']:"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+                    misp_verify = False"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+                if config['MISP_maltego.local.misp_debug'] in ['True', 'true', 1, 'yes', 'Yes']:"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+                    misp_debug = True"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+            else:"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+                try:"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+                    misp_url = parameters['mispurl'].value"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+                    misp_key = parameters['mispkey'].value"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+                except AttributeError:"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+                    raise MaltegoException(\"ERROR: mispurl and mispkey need to be set to something valid\")"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+            self.misp = PyMISP(misp_url, misp_key, misp_verify, 'json', misp_debug, tool='misp_maltego')"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+        except Exception:"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+            if is_local_exec_mode():"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+                raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your MISP_Maltego.conf settings.\")"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+            else:"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+                raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your settings (MISP URL and API key), and ensure the MISP server is reachable from the internet.\")"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+    def object_to_entity(self, o, link_label=None, link_direction=LinkDirection.InputToOutput):"
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+        # find a nice icon for it"
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+        try:"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+            icon_url = mapping_object_icon[o['name']]"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+        except KeyError:"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+            # it's not in our mapping, just ignore and leave the default icon"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+            icon_url = None"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+        # Generate a human readable display-name:"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+        # - find the first RequiredOneOf that exists"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+        # - if none, use the first RequiredField"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+        # LATER further finetune the human readable version of this object"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+        o_template = self.misp.get_object_template(o['template_uuid'])"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+        human_readable = None"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+        try:"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+            found = False"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+            while not found:  # the while loop is broken once something is found, or the requiredOneOf has no elements left"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+                required_ote_type = o_template['ObjectTemplate']['requirements']['requiredOneOf'].pop(0)"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+                for ote in o_template['ObjectTemplateElement']:"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+                    if ote['object_relation'] == required_ote_type:"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+                        required_a_type = ote['type']"
            },
            "80": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+                        break"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+                for a in o['Attribute']:"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+                    if a['type'] == required_a_type:"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 120,
                "PatchRowcode": "+                        human_readable = '{}:\\n{}'.format(o['name'], a['value'])"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+                        found = True"
            },
            "85": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+                        break"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 123,
                "PatchRowcode": "+        except Exception:"
            },
            "87": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 124,
                "PatchRowcode": "+            pass"
            },
            "88": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+        if not human_readable:"
            },
            "89": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "             try:"
            },
            "90": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                misp_url = parameters['mispurl'].value"
            },
            "91": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                misp_key = parameters['mispkey'].value"
            },
            "92": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            except AttributeError:"
            },
            "93": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                raise MaltegoException(\"ERROR: mispurl and mispkey need to be set to something valid\")"
            },
            "94": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        misp_connection = PyMISP(misp_url, misp_key, misp_verify, 'json', misp_debug, tool='misp_maltego')"
            },
            "95": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    except Exception:"
            },
            "96": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if is_local_exec_mode():"
            },
            "97": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your MISP_Maltego.conf settings.\")"
            },
            "98": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if is_remote_exec_mode():"
            },
            "99": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your settings (MISP URL and API key), and ensure the MISP server is reachable from the internet.\")"
            },
            "100": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    return misp_connection"
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+                found = False"
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+                parts = []"
            },
            "103": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+                for required_ote_type in o_template['ObjectTemplate']['requirements']['required']:"
            },
            "104": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+                    for ote in o_template['ObjectTemplateElement']:"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+                        if ote['object_relation'] == required_ote_type:"
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+                            required_a_type = ote['type']"
            },
            "107": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+                            break"
            },
            "108": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+                    for a in o['Attribute']:"
            },
            "109": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+                        if a['type'] == required_a_type:"
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+                            parts.append(a['value'])"
            },
            "111": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+                            break"
            },
            "112": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+                human_readable = '{}:\\n{}'.format(o['name'], '|'.join(parts))"
            },
            "113": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+            except Exception:"
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+                human_readable = o['name']"
            },
            "115": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 141,
                "PatchRowcode": "+        return MISPObject("
            },
            "116": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 142,
                "PatchRowcode": "+            human_readable,"
            },
            "117": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+            uuid=o['uuid'],"
            },
            "118": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+            event_id=int(o['event_id']),"
            },
            "119": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+            meta_category=o.get('meta_category'),"
            },
            "120": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+            description=o.get('description'),"
            },
            "121": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 147,
                "PatchRowcode": "+            comment=o.get('comment'),"
            },
            "122": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 148,
                "PatchRowcode": "+            icon_url=icon_url,"
            },
            "123": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 149,
                "PatchRowcode": "+            link_label=link_label,"
            },
            "124": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+            link_direction=link_direction,"
            },
            "125": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 151,
                "PatchRowcode": "+            bookmark=Bookmark.Green"
            },
            "126": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+        )"
            },
            "127": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+"
            },
            "128": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+    def object_to_relations(self, o, e):"
            },
            "129": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+        # process forward and reverse references, so just loop over all the objects of the event"
            },
            "130": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+        if 'Object' in e['Event']:"
            },
            "131": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+            for eo in e['Event']['Object']:"
            },
            "132": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+                if 'ObjectReference' in eo:"
            },
            "133": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 159,
                "PatchRowcode": "+                    for ref in eo['ObjectReference']:"
            },
            "134": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 160,
                "PatchRowcode": "+                        # we have found original object. Expand to the related object and attributes"
            },
            "135": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+                        if eo['uuid'] == o['uuid']:"
            },
            "136": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+                            # the reference is an Object"
            },
            "137": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+                            if ref.get('Object'):"
            },
            "138": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+                                # get the full object in the event, as our objectReference included does not contain everything we need"
            },
            "139": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+                                sub_object = get_object_in_event(ref['Object']['uuid'], e)"
            },
            "140": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 166,
                "PatchRowcode": "+                                yield self.object_to_entity(sub_object, link_label=ref['relationship_type'])"
            },
            "141": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 167,
                "PatchRowcode": "+                            # the reference is an Attribute"
            },
            "142": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 168,
                "PatchRowcode": "+                            if ref.get('Attribute'):"
            },
            "143": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 169,
                "PatchRowcode": "+                                ref['Attribute']['event_id'] = ref['event_id']   # LATER remove this ugly workaround - object can't be requested directly from MISP using the uuid, and to find a full object we need the event_id"
            },
            "144": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 170,
                "PatchRowcode": "+                                for item in attribute_to_entity(ref['Attribute'], link_label=ref['relationship_type']):"
            },
            "145": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 171,
                "PatchRowcode": "+                                    yield item"
            },
            "146": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 172,
                "PatchRowcode": "+"
            },
            "147": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 173,
                "PatchRowcode": "+                        # reverse-lookup - this is another objects relating the original object"
            },
            "148": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 174,
                "PatchRowcode": "+                        if ref['referenced_uuid'] == o['uuid']:"
            },
            "149": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 175,
                "PatchRowcode": "+                            yield self.object_to_entity(eo, link_label=ref['relationship_type'], link_direction=LinkDirection.OutputToInput)"
            },
            "150": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": 176,
                "PatchRowcode": " "
            },
            "151": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 177,
                "PatchRowcode": " "
            },
            "152": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 178,
                "PatchRowcode": " def entity_obj_to_entity(entity_obj, v, t, **kwargs):"
            },
            "153": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 254,
                "PatchRowcode": "     # LATER : relationships from attributes - not yet supported by MISP yet, but there are references in the datamodel"
            },
            "154": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": 255,
                "PatchRowcode": " "
            },
            "155": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": 256,
                "PatchRowcode": " "
            },
            "156": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def object_to_entity(o, link_label=None, link_direction=LinkDirection.InputToOutput):"
            },
            "157": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    misp = get_misp_connection()"
            },
            "158": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    # find a nice icon for it"
            },
            "159": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    try:"
            },
            "160": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        icon_url = mapping_object_icon[o['name']]"
            },
            "161": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    except KeyError:"
            },
            "162": {
                "beforePatchRowNumber": 185,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # it's not in our mapping, just ignore and leave the default icon"
            },
            "163": {
                "beforePatchRowNumber": 186,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        icon_url = None"
            },
            "164": {
                "beforePatchRowNumber": 187,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    # Generate a human readable display-name:"
            },
            "165": {
                "beforePatchRowNumber": 188,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    # - find the first RequiredOneOf that exists"
            },
            "166": {
                "beforePatchRowNumber": 189,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    # - if none, use the first RequiredField"
            },
            "167": {
                "beforePatchRowNumber": 190,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    # LATER further finetune the human readable version of this object"
            },
            "168": {
                "beforePatchRowNumber": 191,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    o_template = misp.get_object_template(o['template_uuid'])"
            },
            "169": {
                "beforePatchRowNumber": 192,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    human_readable = None"
            },
            "170": {
                "beforePatchRowNumber": 193,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    try:"
            },
            "171": {
                "beforePatchRowNumber": 194,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        found = False"
            },
            "172": {
                "beforePatchRowNumber": 195,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        while not found:  # the while loop is broken once something is found, or the requiredOneOf has no elements left"
            },
            "173": {
                "beforePatchRowNumber": 196,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            required_ote_type = o_template['ObjectTemplate']['requirements']['requiredOneOf'].pop(0)"
            },
            "174": {
                "beforePatchRowNumber": 197,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            for ote in o_template['ObjectTemplateElement']:"
            },
            "175": {
                "beforePatchRowNumber": 198,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                if ote['object_relation'] == required_ote_type:"
            },
            "176": {
                "beforePatchRowNumber": 199,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    required_a_type = ote['type']"
            },
            "177": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    break"
            },
            "178": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            for a in o['Attribute']:"
            },
            "179": {
                "beforePatchRowNumber": 202,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                if a['type'] == required_a_type:"
            },
            "180": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    human_readable = '{}:\\n{}'.format(o['name'], a['value'])"
            },
            "181": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    found = True"
            },
            "182": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    break"
            },
            "183": {
                "beforePatchRowNumber": 206,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    except Exception:"
            },
            "184": {
                "beforePatchRowNumber": 207,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        pass"
            },
            "185": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if not human_readable:"
            },
            "186": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        try:"
            },
            "187": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            found = False"
            },
            "188": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            parts = []"
            },
            "189": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            for required_ote_type in o_template['ObjectTemplate']['requirements']['required']:"
            },
            "190": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                for ote in o_template['ObjectTemplateElement']:"
            },
            "191": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    if ote['object_relation'] == required_ote_type:"
            },
            "192": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        required_a_type = ote['type']"
            },
            "193": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        break"
            },
            "194": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                for a in o['Attribute']:"
            },
            "195": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    if a['type'] == required_a_type:"
            },
            "196": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        parts.append(a['value'])"
            },
            "197": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        break"
            },
            "198": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            human_readable = '{}:\\n{}'.format(o['name'], '|'.join(parts))"
            },
            "199": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        except Exception:"
            },
            "200": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            human_readable = o['name']"
            },
            "201": {
                "beforePatchRowNumber": 224,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    return MISPObject("
            },
            "202": {
                "beforePatchRowNumber": 225,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        human_readable,"
            },
            "203": {
                "beforePatchRowNumber": 226,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        uuid=o['uuid'],"
            },
            "204": {
                "beforePatchRowNumber": 227,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        event_id=int(o['event_id']),"
            },
            "205": {
                "beforePatchRowNumber": 228,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        meta_category=o.get('meta_category'),"
            },
            "206": {
                "beforePatchRowNumber": 229,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        description=o.get('description'),"
            },
            "207": {
                "beforePatchRowNumber": 230,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        comment=o.get('comment'),"
            },
            "208": {
                "beforePatchRowNumber": 231,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        icon_url=icon_url,"
            },
            "209": {
                "beforePatchRowNumber": 232,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        link_label=link_label,"
            },
            "210": {
                "beforePatchRowNumber": 233,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        link_direction=link_direction,"
            },
            "211": {
                "beforePatchRowNumber": 234,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        bookmark=Bookmark.Green"
            },
            "212": {
                "beforePatchRowNumber": 235,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    )"
            },
            "213": {
                "beforePatchRowNumber": 236,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "214": {
                "beforePatchRowNumber": 237,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "215": {
                "beforePatchRowNumber": 238,
                "afterPatchRowNumber": 257,
                "PatchRowcode": " def object_to_attributes(o, e):"
            },
            "216": {
                "beforePatchRowNumber": 239,
                "afterPatchRowNumber": 258,
                "PatchRowcode": "     # first process attributes from an object that belong together (eg: first-name + last-name), and remove them from the list"
            },
            "217": {
                "beforePatchRowNumber": 240,
                "afterPatchRowNumber": 259,
                "PatchRowcode": "     if o['name'] == 'person':"
            },
            "218": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": 267,
                "PatchRowcode": "             yield item"
            },
            "219": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": 268,
                "PatchRowcode": " "
            },
            "220": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": 269,
                "PatchRowcode": " "
            },
            "221": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def object_to_relations(o, e):"
            },
            "222": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    # process forward and reverse references, so just loop over all the objects of the event"
            },
            "223": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if 'Object' in e['Event']:"
            },
            "224": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for eo in e['Event']['Object']:"
            },
            "225": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if 'ObjectReference' in eo:"
            },
            "226": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                for ref in eo['ObjectReference']:"
            },
            "227": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    # we have found original object. Expand to the related object and attributes"
            },
            "228": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    if eo['uuid'] == o['uuid']:"
            },
            "229": {
                "beforePatchRowNumber": 259,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        # the reference is an Object"
            },
            "230": {
                "beforePatchRowNumber": 260,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        if ref.get('Object'):"
            },
            "231": {
                "beforePatchRowNumber": 261,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                            # get the full object in the event, as our objectReference included does not contain everything we need"
            },
            "232": {
                "beforePatchRowNumber": 262,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                            sub_object = get_object_in_event(ref['Object']['uuid'], e)"
            },
            "233": {
                "beforePatchRowNumber": 263,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                            yield object_to_entity(sub_object, link_label=ref['relationship_type'])"
            },
            "234": {
                "beforePatchRowNumber": 264,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        # the reference is an Attribute"
            },
            "235": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        if ref.get('Attribute'):"
            },
            "236": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                            ref['Attribute']['event_id'] = ref['event_id']   # LATER remove this ugly workaround - object can't be requested directly from MISP using the uuid, and to find a full object we need the event_id"
            },
            "237": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                            for item in attribute_to_entity(ref['Attribute'], link_label=ref['relationship_type']):"
            },
            "238": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                                yield item"
            },
            "239": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "240": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    # reverse-lookup - this is another objects relating the original object"
            },
            "241": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    if ref['referenced_uuid'] == o['uuid']:"
            },
            "242": {
                "beforePatchRowNumber": 272,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        yield object_to_entity(eo, link_label=ref['relationship_type'], link_direction=LinkDirection.OutputToInput)"
            },
            "243": {
                "beforePatchRowNumber": 273,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "244": {
                "beforePatchRowNumber": 274,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "245": {
                "beforePatchRowNumber": 275,
                "afterPatchRowNumber": 270,
                "PatchRowcode": " def get_object_in_event(uuid, e):"
            },
            "246": {
                "beforePatchRowNumber": 276,
                "afterPatchRowNumber": 271,
                "PatchRowcode": "     for o in e['Event']['Object']:"
            },
            "247": {
                "beforePatchRowNumber": 277,
                "afterPatchRowNumber": 272,
                "PatchRowcode": "         if o['uuid'] == uuid:"
            }
        },
        "frontPatchFile": [
            "from canari.maltego.entities import Hash, URL, File, Person, Hashtag",
            "from canari.maltego.message import Label, LinkStyle, MaltegoException, Bookmark, LinkDirection, UIMessage, UIMessageType",
            "from canari.mode import is_local_exec_mode, is_remote_exec_mode",
            "from distutils.version import StrictVersion",
            "from MISP_maltego.transforms.common.entities import MISPEvent, MISPObject, MISPGalaxy",
            "from MISP_maltego.transforms.common.mappings import mapping_object_icon, mapping_misp_to_maltego, mapping_galaxy_icon, mapping_galaxy_type",
            "from pymisp import ExpandedPyMISP as PyMISP",
            "import json",
            "import os",
            "import os.path",
            "import requests",
            "import tempfile",
            "import time",
            "",
            "# FIXME from galaxy 'to MISP Event' is confusing",
            "",
            "__version__ = '1.4.4'  # also update version in setup.py",
            "",
            "tag_note_prefixes = ['tlp:', 'PAP:', 'de-vs:', 'euci:', 'fr-classif:', 'nato:']",
            "",
            "misp_connection = None",
            "update_url = 'https://raw.githubusercontent.com/MISP/MISP-maltego/master/setup.py'",
            "local_path_root = os.path.join(tempfile.gettempdir(), 'MISP-maltego')",
            "local_path_version = os.path.join(local_path_root, 'versioncheck')",
            "if not os.path.exists(local_path_root):",
            "    os.mkdir(local_path_root)",
            "    os.chmod(local_path_root, mode=0o777)  # temporary workaround - see https://github.com/redcanari/canari3/issues/61",
            "",
            "",
            "def check_update(config):",
            "    # Do not check updates if running as remote transform",
            "    if is_remote_exec_mode():",
            "        return None",
            "    # only raise the alert once a day/reboot to the user.",
            "    try:",
            "        if time.time() - os.path.getmtime(local_path_version) > 60 * 60 * 24:  # check the timestamp of the file",
            "            recheck = True",
            "        else:",
            "            recheck = False",
            "    except Exception:  # file does not exist, so check version",
            "        recheck = True",
            "    if not recheck:",
            "        return None",
            "    # remember we checked the version",
            "    from pathlib import Path",
            "    Path(local_path_version).touch()",
            "    # UIMessageType must be Fatal as otherwise it is not shown to the user.",
            "    if 'MISP_maltego.local.check_updates' not in config:",
            "        return UIMessage(\"'check_updates' parameter missing in '.canari/MISP_maltego.conf'. Please set 'check_updates = True/False'.\", type=UIMessageType.Fatal)",
            "    if config['MISP_maltego.local.check_updates']:",
            "        # check the version",
            "        r = requests.get(update_url)",
            "        for l in r.text.splitlines():",
            "            if 'version=' in l:",
            "                online_ver = l.strip().strip(',').split('=').pop().strip(\"'\")",
            "                if StrictVersion(online_ver) > StrictVersion(__version__):",
            "                    message = ('A new version of MISP-Maltego is available.\\n'",
            "                               'To upgrade, please:\\n'",
            "                               '    pip3 --upgrade MISP-maltego'",
            "                               '    canari create-profile MISP_maltego\\n'",
            "                               '    And import the newly generated .mtz bundle in Maltego (Import > Import Configuration)')",
            "                    return UIMessage(message, type=UIMessageType.Fatal)",
            "                break",
            "    return None",
            "",
            "",
            "def get_misp_connection(config=None, parameters=None):",
            "    global misp_connection",
            "    if misp_connection:",
            "        return misp_connection",
            "    if not config:",
            "        raise MaltegoException(\"ERROR: MISP connection not yet established, and config not provided as parameter.\")",
            "    misp_verify = True",
            "    misp_debug = False",
            "    misp_url = None",
            "    misp_key = None",
            "    try:",
            "        if is_local_exec_mode():",
            "            misp_url = config['MISP_maltego.local.misp_url']",
            "            misp_key = config['MISP_maltego.local.misp_key']",
            "            if config['MISP_maltego.local.misp_verify'] in ['False', 'false', 0, 'no', 'No']:",
            "                misp_verify = False",
            "            if config['MISP_maltego.local.misp_debug'] in ['True', 'true', 1, 'yes', 'Yes']:",
            "                misp_debug = True",
            "        if is_remote_exec_mode():",
            "            try:",
            "                misp_url = parameters['mispurl'].value",
            "                misp_key = parameters['mispkey'].value",
            "            except AttributeError:",
            "                raise MaltegoException(\"ERROR: mispurl and mispkey need to be set to something valid\")",
            "        misp_connection = PyMISP(misp_url, misp_key, misp_verify, 'json', misp_debug, tool='misp_maltego')",
            "    except Exception:",
            "        if is_local_exec_mode():",
            "            raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your MISP_Maltego.conf settings.\")",
            "        if is_remote_exec_mode():",
            "            raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your settings (MISP URL and API key), and ensure the MISP server is reachable from the internet.\")",
            "    return misp_connection",
            "",
            "",
            "def entity_obj_to_entity(entity_obj, v, t, **kwargs):",
            "    if entity_obj == Hash:",
            "        return entity_obj(v, _type=t, **kwargs)  # LATER type is conflicting with type of Entity, Report this as bug see line 326 /usr/local/lib/python3.5/dist-packages/canari/maltego/entities.py",
            "",
            "    return entity_obj(v, **kwargs)",
            "",
            "",
            "def get_entity_property(entity, name):",
            "    for k, v in entity.fields.items():",
            "        if k == name:",
            "            return v.value",
            "    return None",
            "",
            "",
            "def attribute_to_entity(a, link_label=None, event_tags=[], only_self=False):",
            "    # prepare some attributes to a better form",
            "    a['data'] = None  # empty the file content as we really don't need this here",
            "    if a['type'] == 'malware-sample':",
            "        a['type'] = 'filename|md5'",
            "    if a['type'] == 'regkey|value':  # LATER regkey|value => needs to be a special non-combined object",
            "        a['type'] = 'regkey'",
            "",
            "    combined_tags = event_tags",
            "    if 'Galaxy' in a and not only_self:",
            "        for g in a['Galaxy']:",
            "            for c in g['GalaxyCluster']:",
            "                yield galaxycluster_to_entity(c)",
            "",
            "    # complement the event tags with the attribute tags.",
            "    if 'Tag' in a and not only_self:",
            "            for t in a['Tag']:",
            "                combined_tags.append(t['name'])",
            "                # ignore all misp-galaxies",
            "                if t['name'].startswith('misp-galaxy'):",
            "                    continue",
            "                # ignore all those we add as notes",
            "                if tag_matches_note_prefix(t['name']):",
            "                    continue",
            "                yield Hashtag(t['name'], bookmark=Bookmark.Green)",
            "",
            "    notes = convert_tags_to_note(combined_tags)",
            "",
            "    # special cases",
            "    if a['type'] in ('url', 'uri'):",
            "        yield(URL(url=a['value'], short_title=a['value'], link_label=link_label, notes=notes, bookmark=Bookmark.Green))",
            "        return",
            "",
            "    # attribute is from an object, and a relation gives better understanding of the type of attribute",
            "    if a.get('object_relation') and mapping_misp_to_maltego.get(a['object_relation']):",
            "        entity_obj = mapping_misp_to_maltego[a['object_relation']][0]",
            "        yield entity_obj(a['value'], labels=[Label('comment', a.get('comment'))], link_label=link_label, notes=notes, bookmark=Bookmark.Green)",
            "",
            "    # combined attributes",
            "    elif '|' in a['type']:",
            "        t_1, t_2 = a['type'].split('|')",
            "        v_1, v_2 = a['value'].split('|')",
            "        if t_1 in mapping_misp_to_maltego:",
            "            entity_obj = mapping_misp_to_maltego[t_1][0]",
            "            labels = [Label('comment', a.get('comment'))]",
            "            if entity_obj == File:",
            "                labels.append(Label('hash', v_2))",
            "            yield entity_obj_to_entity(entity_obj, v_1, t_1, labels=labels, link_label=link_label, notes=notes, bookmark=Bookmark.Green)  # LATER change the comment to include the second part of the regkey",
            "        if t_2 in mapping_misp_to_maltego:",
            "            entity_obj = mapping_misp_to_maltego[t_2][0]",
            "            labels = [Label('comment', a.get('comment'))]",
            "            if entity_obj == Hash:",
            "                labels.append(Label('filename', v_1))",
            "            yield entity_obj_to_entity(entity_obj, v_2, t_2, labels=labels, link_label=link_label, notes=notes, bookmark=Bookmark.Green)  # LATER change the comment to include the first part of the regkey",
            "",
            "    # normal attributes",
            "    elif a['type'] in mapping_misp_to_maltego:",
            "        entity_obj = mapping_misp_to_maltego[a['type']][0]",
            "        yield entity_obj_to_entity(entity_obj, a['value'], a['type'], labels=[Label('comment', a.get('comment'))], link_label=link_label, notes=notes, bookmark=Bookmark.Green)",
            "",
            "    # not supported in our maltego mapping are not handled",
            "",
            "    # LATER : relationships from attributes - not yet supported by MISP yet, but there are references in the datamodel",
            "",
            "",
            "def object_to_entity(o, link_label=None, link_direction=LinkDirection.InputToOutput):",
            "    misp = get_misp_connection()",
            "    # find a nice icon for it",
            "    try:",
            "        icon_url = mapping_object_icon[o['name']]",
            "    except KeyError:",
            "        # it's not in our mapping, just ignore and leave the default icon",
            "        icon_url = None",
            "    # Generate a human readable display-name:",
            "    # - find the first RequiredOneOf that exists",
            "    # - if none, use the first RequiredField",
            "    # LATER further finetune the human readable version of this object",
            "    o_template = misp.get_object_template(o['template_uuid'])",
            "    human_readable = None",
            "    try:",
            "        found = False",
            "        while not found:  # the while loop is broken once something is found, or the requiredOneOf has no elements left",
            "            required_ote_type = o_template['ObjectTemplate']['requirements']['requiredOneOf'].pop(0)",
            "            for ote in o_template['ObjectTemplateElement']:",
            "                if ote['object_relation'] == required_ote_type:",
            "                    required_a_type = ote['type']",
            "                    break",
            "            for a in o['Attribute']:",
            "                if a['type'] == required_a_type:",
            "                    human_readable = '{}:\\n{}'.format(o['name'], a['value'])",
            "                    found = True",
            "                    break",
            "    except Exception:",
            "        pass",
            "    if not human_readable:",
            "        try:",
            "            found = False",
            "            parts = []",
            "            for required_ote_type in o_template['ObjectTemplate']['requirements']['required']:",
            "                for ote in o_template['ObjectTemplateElement']:",
            "                    if ote['object_relation'] == required_ote_type:",
            "                        required_a_type = ote['type']",
            "                        break",
            "                for a in o['Attribute']:",
            "                    if a['type'] == required_a_type:",
            "                        parts.append(a['value'])",
            "                        break",
            "            human_readable = '{}:\\n{}'.format(o['name'], '|'.join(parts))",
            "        except Exception:",
            "            human_readable = o['name']",
            "    return MISPObject(",
            "        human_readable,",
            "        uuid=o['uuid'],",
            "        event_id=int(o['event_id']),",
            "        meta_category=o.get('meta_category'),",
            "        description=o.get('description'),",
            "        comment=o.get('comment'),",
            "        icon_url=icon_url,",
            "        link_label=link_label,",
            "        link_direction=link_direction,",
            "        bookmark=Bookmark.Green",
            "    )",
            "",
            "",
            "def object_to_attributes(o, e):",
            "    # first process attributes from an object that belong together (eg: first-name + last-name), and remove them from the list",
            "    if o['name'] == 'person':",
            "        first_name = get_attribute_in_object(o, attribute_type='first-name', drop=True).get('value')",
            "        last_name = get_attribute_in_object(o, attribute_type='last-name', drop=True).get('value')",
            "        yield entity_obj_to_entity(Person, ' '.join([first_name, last_name]).strip(), 'person', lastname=last_name, firstnames=first_name, bookmark=Bookmark.Green)",
            "",
            "    # process normal attributes",
            "    for a in o['Attribute']:",
            "        for item in attribute_to_entity(a):",
            "            yield item",
            "",
            "",
            "def object_to_relations(o, e):",
            "    # process forward and reverse references, so just loop over all the objects of the event",
            "    if 'Object' in e['Event']:",
            "        for eo in e['Event']['Object']:",
            "            if 'ObjectReference' in eo:",
            "                for ref in eo['ObjectReference']:",
            "                    # we have found original object. Expand to the related object and attributes",
            "                    if eo['uuid'] == o['uuid']:",
            "                        # the reference is an Object",
            "                        if ref.get('Object'):",
            "                            # get the full object in the event, as our objectReference included does not contain everything we need",
            "                            sub_object = get_object_in_event(ref['Object']['uuid'], e)",
            "                            yield object_to_entity(sub_object, link_label=ref['relationship_type'])",
            "                        # the reference is an Attribute",
            "                        if ref.get('Attribute'):",
            "                            ref['Attribute']['event_id'] = ref['event_id']   # LATER remove this ugly workaround - object can't be requested directly from MISP using the uuid, and to find a full object we need the event_id",
            "                            for item in attribute_to_entity(ref['Attribute'], link_label=ref['relationship_type']):",
            "                                yield item",
            "",
            "                    # reverse-lookup - this is another objects relating the original object",
            "                    if ref['referenced_uuid'] == o['uuid']:",
            "                        yield object_to_entity(eo, link_label=ref['relationship_type'], link_direction=LinkDirection.OutputToInput)",
            "",
            "",
            "def get_object_in_event(uuid, e):",
            "    for o in e['Event']['Object']:",
            "        if o['uuid'] == uuid:",
            "            return o",
            "",
            "",
            "def get_attribute_in_object(o, attribute_type=False, attribute_value=False, drop=False, substring=False):",
            "    '''Gets the first attribute of a specific type within an object'''",
            "    found_attribute = {'value': ''}",
            "    for i, a in enumerate(o['Attribute']):",
            "        if a['type'] == attribute_type:",
            "            found_attribute = a.copy()",
            "            if drop:    # drop the attribute from the object",
            "                o['Attribute'].pop(i)",
            "            break",
            "        if a['value'] == attribute_value:",
            "            found_attribute = a.copy()",
            "            if drop:    # drop the attribute from the object",
            "                o['Attribute'].pop(i)",
            "            break",
            "        if '|' in a['type'] or a['type'] == 'malware-sample':",
            "            if attribute_value in a['value'].split('|'):",
            "                found_attribute = a.copy()",
            "                if drop:    # drop the attribute from the object",
            "                    o['Attribute'].pop(i)",
            "                break",
            "        # TODO implement substring matching",
            "        if substring:",
            "            keyword = attribute_value.strip('%')",
            "            if attribute_value.startswith('%') and attribute_value.endswith('%'):",
            "                if attribute_value in a['value']:",
            "                    found_attribute = a.copy()",
            "                    if drop:    # drop the attribute from the object",
            "                        o['Attribute'].pop(i)",
            "                    break",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if attribute_value in val1 or attribute_value in val2:",
            "                        found_attribute = a.copy()",
            "                        if drop:    # drop the attribute from the object",
            "                            o['Attribute'].pop(i)",
            "                        break",
            "            elif attribute_value.startswith('%'):",
            "                if a['value'].endswith(keyword):",
            "                    found_attribute = a.copy()",
            "                    if drop:    # drop the attribute from the object",
            "                        o['Attribute'].pop(i)",
            "                    break",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.endswith(keyword) or val2.endswith(keyword):",
            "                        found_attribute = a.copy()",
            "                        if drop:    # drop the attribute from the object",
            "                            o['Attribute'].pop(i)",
            "                        break",
            "",
            "            elif attribute_value.endswith('%'):",
            "                if a['value'].startswith(keyword):",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.startswith(keyword) or val2.startswith(keyword):",
            "                        found_attribute = a.copy()",
            "                        if drop:    # drop the attribute from the object",
            "                            o['Attribute'].pop(i)",
            "                        break",
            "    return found_attribute",
            "",
            "",
            "def get_attribute_in_event(e, attribute_value, substring=False):",
            "    for a in e['Event'][\"Attribute\"]:",
            "        if a['value'] == attribute_value:",
            "            return a",
            "        if '|' in a['type'] or a['type'] == 'malware-sample':",
            "            if attribute_value in a['value'].split('|'):",
            "                return a",
            "        if substring:",
            "            keyword = attribute_value.strip('%')",
            "            if attribute_value.startswith('%') and attribute_value.endswith('%'):",
            "                if attribute_value in a['value']:",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if attribute_value in val1 or attribute_value in val2:",
            "                        return a",
            "            elif attribute_value.startswith('%'):",
            "                if a['value'].endswith(keyword):",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.endswith(keyword) or val2.endswith(keyword):",
            "                        return a",
            "",
            "            elif attribute_value.endswith('%'):",
            "                if a['value'].startswith(keyword):",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.startswith(keyword) or val2.startswith(keyword):",
            "                        return a",
            "",
            "    return None",
            "",
            "",
            "def convert_tags_to_note(tags):",
            "    if not tags:",
            "        return None",
            "    notes = []",
            "    for tag in tags:",
            "        for tag_note_prefix in tag_note_prefixes:",
            "            if tag.startswith(tag_note_prefix):",
            "                notes.append(tag)",
            "    return '\\n'.join(notes)",
            "",
            "",
            "def tag_matches_note_prefix(tag):",
            "    for tag_note_prefix in tag_note_prefixes:",
            "        if tag.startswith(tag_note_prefix):",
            "            return True",
            "    return False",
            "",
            "",
            "def event_to_entity(e, link_style=LinkStyle.Normal, link_label=None, link_direction=LinkDirection.InputToOutput):",
            "    tags = []",
            "    if 'Tag' in e['Event']:",
            "        for t in e['Event']['Tag']:",
            "            tags.append(t['name'])",
            "    notes = convert_tags_to_note(tags)",
            "    return MISPEvent(",
            "        e['Event']['id'],",
            "        uuid=e['Event']['uuid'],",
            "        info=e['Event']['info'],",
            "        link_style=link_style,",
            "        link_label=link_label,",
            "        link_direction=link_direction,",
            "        count_attributes=len(e['Event'].get('Attribute') or \"\"),",
            "        count_objects=len(e['Event'].get('Object') or \"\"),",
            "        notes=notes,",
            "        bookmark=Bookmark.Green)",
            "",
            "",
            "def galaxycluster_to_entity(c, link_label=None, link_direction=LinkDirection.InputToOutput):",
            "    if 'meta' in c and 'uuid' in c['meta']:",
            "        c['uuid'] = c['meta']['uuid'].pop(0)",
            "",
            "    if 'meta' in c and 'synonyms' in c['meta']:",
            "        synonyms = ', '.join(c['meta']['synonyms'])",
            "    else:",
            "        synonyms = ''",
            "",
            "    galaxy_cluster = get_galaxy_cluster(uuid=c['uuid'])",
            "    # map the 'icon' name from the cluster to the icon filename of the intelligence-icons repository",
            "    try:",
            "        icon_url = mapping_galaxy_icon[galaxy_cluster['icon']]",
            "    except KeyError:",
            "        # it's not in our mapping, just ignore and leave the default icon",
            "        icon_url = None",
            "",
            "    # create the right sub-galaxy: ThreatActor, Software, AttackTechnique, ... or MISPGalaxy",
            "    try:",
            "        galaxy_type = mapping_galaxy_type[galaxy_cluster['type']]",
            "    except KeyError:",
            "        galaxy_type = MISPGalaxy",
            "    return galaxy_type(",
            "        '{}\\n{}'.format(c['type'], c['value']),",
            "        uuid=c['uuid'],",
            "        description=c.get('description'),",
            "        cluster_type=c.get('type'),",
            "        cluster_value=c.get('value'),",
            "        synonyms=synonyms,",
            "        tag_name=c['tag_name'],",
            "        link_label=link_label,",
            "        icon_url=icon_url,",
            "        link_direction=link_direction",
            "    )",
            "",
            "",
            "# LATER this uses the galaxies from github as the MISP web UI does not fully support the Galaxies in the webui.",
            "# See https://github.com/MISP/MISP/issues/3801",
            "galaxy_archive_url = 'https://github.com/MISP/misp-galaxy/archive/master.zip'",
            "local_path_uuid_mapping = os.path.join(local_path_root, 'MISP_maltego_galaxy_mapping.json')",
            "local_path_clusters = os.path.join(local_path_root, 'misp-galaxy-master', 'clusters')",
            "galaxy_cluster_uuids = None",
            "",
            "",
            "def galaxy_update_local_copy(force=False):",
            "    import io",
            "    import json",
            "    import os",
            "    import requests",
            "    from zipfile import ZipFile",
            "",
            "    # some aging and automatic re-downloading",
            "    if not os.path.exists(local_path_uuid_mapping):",
            "        force = True",
            "    else:",
            "        # force update if cache is older than 24 hours",
            "        if time.time() - os.path.getmtime(local_path_uuid_mapping) > 60 * 60 * 24:",
            "            force = True",
            "",
            "    if force:",
            "        # create a lock to prevent two processes doing the same, and writing to the file at the same time",
            "        lockfile = local_path_uuid_mapping + '.lock'",
            "        from pathlib import Path",
            "        while os.path.exists(lockfile):",
            "            time.sleep(0.3)",
            "        Path(local_path_uuid_mapping + '.lock').touch()",
            "        # download the latest zip of the public galaxy",
            "        try:",
            "            resp = requests.get(galaxy_archive_url)",
            "            zf = ZipFile(io.BytesIO(resp.content))",
            "            zf.extractall(local_path_root)",
            "            zf.close()",
            "        except Exception:",
            "            raise(MaltegoException(\"ERROR: Could not download Galaxy data from htts://github.com/MISP/MISP-galaxy/. Please check internet connectivity.\"))",
            "",
            "        # generate the uuid mapping and save it to a file",
            "        galaxies_fnames = []",
            "        for f in os.listdir(local_path_clusters):",
            "            if '.json' in f:",
            "                galaxies_fnames.append(f)",
            "        galaxies_fnames.sort()",
            "",
            "        cluster_uuids = {}",
            "        for galaxy_fname in galaxies_fnames:",
            "            try:",
            "                fullPathClusters = os.path.join(local_path_clusters, galaxy_fname)",
            "                with open(fullPathClusters) as fp:",
            "                    galaxy = json.load(fp)",
            "                with open(fullPathClusters.replace('clusters', 'galaxies')) as fg:",
            "                    galaxy_main = json.load(fg)",
            "                for cluster in galaxy['values']:",
            "                    if 'uuid' not in cluster:",
            "                        continue",
            "                    # skip deprecated galaxies/clusters",
            "                    if galaxy_main['namespace'] == 'deprecated':",
            "                        continue",
            "                    # keep track of the cluster, but also enhance it to look like the cluster we receive when accessing the web.",
            "                    cluster_uuids[cluster['uuid']] = cluster",
            "                    cluster_uuids[cluster['uuid']]['type'] = galaxy['type']",
            "                    cluster_uuids[cluster['uuid']]['tag_name'] = 'misp-galaxy:{}=\"{}\"'.format(galaxy['type'], cluster['value'])",
            "                    if 'icon' in galaxy_main:",
            "                        cluster_uuids[cluster['uuid']]['icon'] = galaxy_main['icon']",
            "            except Exception:",
            "                # we ignore incorrect galaxies",
            "                pass",
            "",
            "        with open(local_path_uuid_mapping, 'w') as f:",
            "            json.dump(cluster_uuids, f)",
            "        # remove the lock",
            "        os.remove(lockfile)",
            "",
            "",
            "def galaxy_load_cluster_mapping():",
            "    galaxy_update_local_copy()",
            "    with open(local_path_uuid_mapping, 'r') as f:",
            "        cluster_uuids = json.load(f)",
            "    return cluster_uuids",
            "",
            "",
            "def get_galaxy_cluster(uuid=None, tag=None, request_entity=None):",
            "    global galaxy_cluster_uuids",
            "    if not galaxy_cluster_uuids:",
            "        galaxy_cluster_uuids = galaxy_load_cluster_mapping()",
            "",
            "    if uuid:",
            "        return galaxy_cluster_uuids.get(uuid)",
            "    if tag:",
            "        for item in galaxy_cluster_uuids.values():",
            "            if item['tag_name'] == tag:",
            "                return item",
            "    if request_entity:",
            "        if request_entity.uuid:",
            "            return get_galaxy_cluster(uuid=request_entity.uuid)",
            "        elif request_entity.tag_name:",
            "            return get_galaxy_cluster(tag=request_entity.tag_name)",
            "        elif request_entity.name:",
            "            return get_galaxy_cluster(tag=request_entity.name)",
            "",
            "",
            "def search_galaxy_cluster(keyword):",
            "    keyword = keyword.lower()",
            "    global galaxy_cluster_uuids",
            "    if not galaxy_cluster_uuids:",
            "        galaxy_cluster_uuids = galaxy_load_cluster_mapping()",
            "",
            "    # % only at start",
            "    if keyword.startswith('%') and not keyword.endswith('%'):",
            "        keyword = keyword.strip('%')",
            "        for item in galaxy_cluster_uuids.values():",
            "            if item['value'].lower().endswith(keyword):",
            "                yield item",
            "            else:",
            "                if 'meta' in item and 'synonyms' in item['meta']:",
            "                    for synonym in item['meta']['synonyms']:",
            "                        if synonym.lower().endswith(keyword):",
            "                            yield item",
            "",
            "    # % only at end",
            "    elif keyword.endswith('%') and not keyword.startswith('%'):",
            "        keyword = keyword.strip('%')",
            "        for item in galaxy_cluster_uuids.values():",
            "            if item['value'].lower().startswith(keyword):",
            "                yield item",
            "            else:",
            "                if 'meta' in item and 'synonyms' in item['meta']:",
            "                    for synonym in item['meta']['synonyms']:",
            "                        if synonym.lower().startswith(keyword):",
            "                            yield item",
            "",
            "    # search substring assuming % at start and end",
            "    else:",
            "        keyword = keyword.strip('%')",
            "        for item in galaxy_cluster_uuids.values():",
            "            if keyword in item['value'].lower():",
            "                yield item",
            "            else:",
            "                if 'meta' in item and 'synonyms' in item['meta']:",
            "                    for synonym in item['meta']['synonyms']:",
            "                        if keyword in synonym.lower():",
            "                            yield item",
            "",
            "",
            "def get_galaxies_relating(uuid):",
            "    global galaxy_cluster_uuids",
            "    if not galaxy_cluster_uuids:",
            "        galaxy_cluster_uuids = galaxy_load_cluster_mapping()",
            "",
            "    for item in galaxy_cluster_uuids.values():",
            "        if 'related' in item:",
            "            for related in item['related']:",
            "                if related['dest-uuid'] == uuid:",
            "                    yield item"
        ],
        "afterPatchFile": [
            "from canari.maltego.entities import Hash, URL, File, Person, Hashtag",
            "from canari.maltego.message import Label, LinkStyle, MaltegoException, Bookmark, LinkDirection, UIMessage, UIMessageType",
            "from canari.mode import is_local_exec_mode, is_remote_exec_mode",
            "from distutils.version import StrictVersion",
            "from MISP_maltego.transforms.common.entities import MISPEvent, MISPObject, MISPGalaxy",
            "from MISP_maltego.transforms.common.mappings import mapping_object_icon, mapping_misp_to_maltego, mapping_galaxy_icon, mapping_galaxy_type",
            "from pymisp import ExpandedPyMISP as PyMISP",
            "import json",
            "import os",
            "import os.path",
            "import requests",
            "import tempfile",
            "import time",
            "",
            "# FIXME from galaxy 'to MISP Event' is confusing",
            "",
            "__version__ = '1.4.4'  # also update version in setup.py",
            "",
            "tag_note_prefixes = ['tlp:', 'PAP:', 'de-vs:', 'euci:', 'fr-classif:', 'nato:']",
            "",
            "update_url = 'https://raw.githubusercontent.com/MISP/MISP-maltego/master/setup.py'",
            "local_path_root = os.path.join(tempfile.gettempdir(), 'MISP-maltego')",
            "local_path_version = os.path.join(local_path_root, 'versioncheck')",
            "if not os.path.exists(local_path_root):",
            "    os.mkdir(local_path_root)",
            "    os.chmod(local_path_root, mode=0o777)  # temporary workaround - see https://github.com/redcanari/canari3/issues/61",
            "",
            "",
            "def check_update(config):",
            "    # Do not check updates if running as remote transform",
            "    if is_remote_exec_mode():",
            "        return None",
            "    # only raise the alert once a day/reboot to the user.",
            "    try:",
            "        if time.time() - os.path.getmtime(local_path_version) > 60 * 60 * 24:  # check the timestamp of the file",
            "            recheck = True",
            "        else:",
            "            recheck = False",
            "    except Exception:  # file does not exist, so check version",
            "        recheck = True",
            "    if not recheck:",
            "        return None",
            "    # remember we checked the version",
            "    from pathlib import Path",
            "    Path(local_path_version).touch()",
            "    # UIMessageType must be Fatal as otherwise it is not shown to the user.",
            "    if 'MISP_maltego.local.check_updates' not in config:",
            "        return UIMessage(\"'check_updates' parameter missing in '.canari/MISP_maltego.conf'. Please set 'check_updates = True/False'.\", type=UIMessageType.Fatal)",
            "    if config['MISP_maltego.local.check_updates']:",
            "        # check the version",
            "        r = requests.get(update_url)",
            "        for l in r.text.splitlines():",
            "            if 'version=' in l:",
            "                online_ver = l.strip().strip(',').split('=').pop().strip(\"'\")",
            "                if StrictVersion(online_ver) > StrictVersion(__version__):",
            "                    message = ('A new version of MISP-Maltego is available.\\n'",
            "                               'To upgrade, please:\\n'",
            "                               '    pip3 --upgrade MISP-maltego'",
            "                               '    canari create-profile MISP_maltego\\n'",
            "                               '    And import the newly generated .mtz bundle in Maltego (Import > Import Configuration)')",
            "                    return UIMessage(message, type=UIMessageType.Fatal)",
            "                break",
            "    return None",
            "",
            "",
            "class MISPConnection():",
            "    def __init__(self, config=None, parameters=None):",
            "        self.misp = None",
            "",
            "        if not config:",
            "            raise MaltegoException(\"ERROR: MISP connection not yet established, and config not provided as parameter.\")",
            "        misp_verify = True",
            "        misp_debug = False",
            "        misp_url = None",
            "        misp_key = None",
            "        try:",
            "            if is_local_exec_mode():",
            "                misp_url = config['MISP_maltego.local.misp_url']",
            "                misp_key = config['MISP_maltego.local.misp_key']",
            "                if config['MISP_maltego.local.misp_verify'] in ['False', 'false', 0, 'no', 'No']:",
            "                    misp_verify = False",
            "                if config['MISP_maltego.local.misp_debug'] in ['True', 'true', 1, 'yes', 'Yes']:",
            "                    misp_debug = True",
            "            else:",
            "                try:",
            "                    misp_url = parameters['mispurl'].value",
            "                    misp_key = parameters['mispkey'].value",
            "                except AttributeError:",
            "                    raise MaltegoException(\"ERROR: mispurl and mispkey need to be set to something valid\")",
            "            self.misp = PyMISP(misp_url, misp_key, misp_verify, 'json', misp_debug, tool='misp_maltego')",
            "        except Exception:",
            "            if is_local_exec_mode():",
            "                raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your MISP_Maltego.conf settings.\")",
            "            else:",
            "                raise MaltegoException(\"ERROR: Cannot connect to MISP server. Please verify your settings (MISP URL and API key), and ensure the MISP server is reachable from the internet.\")",
            "",
            "    def object_to_entity(self, o, link_label=None, link_direction=LinkDirection.InputToOutput):",
            "        # find a nice icon for it",
            "        try:",
            "            icon_url = mapping_object_icon[o['name']]",
            "        except KeyError:",
            "            # it's not in our mapping, just ignore and leave the default icon",
            "            icon_url = None",
            "        # Generate a human readable display-name:",
            "        # - find the first RequiredOneOf that exists",
            "        # - if none, use the first RequiredField",
            "        # LATER further finetune the human readable version of this object",
            "        o_template = self.misp.get_object_template(o['template_uuid'])",
            "        human_readable = None",
            "        try:",
            "            found = False",
            "            while not found:  # the while loop is broken once something is found, or the requiredOneOf has no elements left",
            "                required_ote_type = o_template['ObjectTemplate']['requirements']['requiredOneOf'].pop(0)",
            "                for ote in o_template['ObjectTemplateElement']:",
            "                    if ote['object_relation'] == required_ote_type:",
            "                        required_a_type = ote['type']",
            "                        break",
            "                for a in o['Attribute']:",
            "                    if a['type'] == required_a_type:",
            "                        human_readable = '{}:\\n{}'.format(o['name'], a['value'])",
            "                        found = True",
            "                        break",
            "        except Exception:",
            "            pass",
            "        if not human_readable:",
            "            try:",
            "                found = False",
            "                parts = []",
            "                for required_ote_type in o_template['ObjectTemplate']['requirements']['required']:",
            "                    for ote in o_template['ObjectTemplateElement']:",
            "                        if ote['object_relation'] == required_ote_type:",
            "                            required_a_type = ote['type']",
            "                            break",
            "                    for a in o['Attribute']:",
            "                        if a['type'] == required_a_type:",
            "                            parts.append(a['value'])",
            "                            break",
            "                human_readable = '{}:\\n{}'.format(o['name'], '|'.join(parts))",
            "            except Exception:",
            "                human_readable = o['name']",
            "        return MISPObject(",
            "            human_readable,",
            "            uuid=o['uuid'],",
            "            event_id=int(o['event_id']),",
            "            meta_category=o.get('meta_category'),",
            "            description=o.get('description'),",
            "            comment=o.get('comment'),",
            "            icon_url=icon_url,",
            "            link_label=link_label,",
            "            link_direction=link_direction,",
            "            bookmark=Bookmark.Green",
            "        )",
            "",
            "    def object_to_relations(self, o, e):",
            "        # process forward and reverse references, so just loop over all the objects of the event",
            "        if 'Object' in e['Event']:",
            "            for eo in e['Event']['Object']:",
            "                if 'ObjectReference' in eo:",
            "                    for ref in eo['ObjectReference']:",
            "                        # we have found original object. Expand to the related object and attributes",
            "                        if eo['uuid'] == o['uuid']:",
            "                            # the reference is an Object",
            "                            if ref.get('Object'):",
            "                                # get the full object in the event, as our objectReference included does not contain everything we need",
            "                                sub_object = get_object_in_event(ref['Object']['uuid'], e)",
            "                                yield self.object_to_entity(sub_object, link_label=ref['relationship_type'])",
            "                            # the reference is an Attribute",
            "                            if ref.get('Attribute'):",
            "                                ref['Attribute']['event_id'] = ref['event_id']   # LATER remove this ugly workaround - object can't be requested directly from MISP using the uuid, and to find a full object we need the event_id",
            "                                for item in attribute_to_entity(ref['Attribute'], link_label=ref['relationship_type']):",
            "                                    yield item",
            "",
            "                        # reverse-lookup - this is another objects relating the original object",
            "                        if ref['referenced_uuid'] == o['uuid']:",
            "                            yield self.object_to_entity(eo, link_label=ref['relationship_type'], link_direction=LinkDirection.OutputToInput)",
            "",
            "",
            "def entity_obj_to_entity(entity_obj, v, t, **kwargs):",
            "    if entity_obj == Hash:",
            "        return entity_obj(v, _type=t, **kwargs)  # LATER type is conflicting with type of Entity, Report this as bug see line 326 /usr/local/lib/python3.5/dist-packages/canari/maltego/entities.py",
            "",
            "    return entity_obj(v, **kwargs)",
            "",
            "",
            "def get_entity_property(entity, name):",
            "    for k, v in entity.fields.items():",
            "        if k == name:",
            "            return v.value",
            "    return None",
            "",
            "",
            "def attribute_to_entity(a, link_label=None, event_tags=[], only_self=False):",
            "    # prepare some attributes to a better form",
            "    a['data'] = None  # empty the file content as we really don't need this here",
            "    if a['type'] == 'malware-sample':",
            "        a['type'] = 'filename|md5'",
            "    if a['type'] == 'regkey|value':  # LATER regkey|value => needs to be a special non-combined object",
            "        a['type'] = 'regkey'",
            "",
            "    combined_tags = event_tags",
            "    if 'Galaxy' in a and not only_self:",
            "        for g in a['Galaxy']:",
            "            for c in g['GalaxyCluster']:",
            "                yield galaxycluster_to_entity(c)",
            "",
            "    # complement the event tags with the attribute tags.",
            "    if 'Tag' in a and not only_self:",
            "            for t in a['Tag']:",
            "                combined_tags.append(t['name'])",
            "                # ignore all misp-galaxies",
            "                if t['name'].startswith('misp-galaxy'):",
            "                    continue",
            "                # ignore all those we add as notes",
            "                if tag_matches_note_prefix(t['name']):",
            "                    continue",
            "                yield Hashtag(t['name'], bookmark=Bookmark.Green)",
            "",
            "    notes = convert_tags_to_note(combined_tags)",
            "",
            "    # special cases",
            "    if a['type'] in ('url', 'uri'):",
            "        yield(URL(url=a['value'], short_title=a['value'], link_label=link_label, notes=notes, bookmark=Bookmark.Green))",
            "        return",
            "",
            "    # attribute is from an object, and a relation gives better understanding of the type of attribute",
            "    if a.get('object_relation') and mapping_misp_to_maltego.get(a['object_relation']):",
            "        entity_obj = mapping_misp_to_maltego[a['object_relation']][0]",
            "        yield entity_obj(a['value'], labels=[Label('comment', a.get('comment'))], link_label=link_label, notes=notes, bookmark=Bookmark.Green)",
            "",
            "    # combined attributes",
            "    elif '|' in a['type']:",
            "        t_1, t_2 = a['type'].split('|')",
            "        v_1, v_2 = a['value'].split('|')",
            "        if t_1 in mapping_misp_to_maltego:",
            "            entity_obj = mapping_misp_to_maltego[t_1][0]",
            "            labels = [Label('comment', a.get('comment'))]",
            "            if entity_obj == File:",
            "                labels.append(Label('hash', v_2))",
            "            yield entity_obj_to_entity(entity_obj, v_1, t_1, labels=labels, link_label=link_label, notes=notes, bookmark=Bookmark.Green)  # LATER change the comment to include the second part of the regkey",
            "        if t_2 in mapping_misp_to_maltego:",
            "            entity_obj = mapping_misp_to_maltego[t_2][0]",
            "            labels = [Label('comment', a.get('comment'))]",
            "            if entity_obj == Hash:",
            "                labels.append(Label('filename', v_1))",
            "            yield entity_obj_to_entity(entity_obj, v_2, t_2, labels=labels, link_label=link_label, notes=notes, bookmark=Bookmark.Green)  # LATER change the comment to include the first part of the regkey",
            "",
            "    # normal attributes",
            "    elif a['type'] in mapping_misp_to_maltego:",
            "        entity_obj = mapping_misp_to_maltego[a['type']][0]",
            "        yield entity_obj_to_entity(entity_obj, a['value'], a['type'], labels=[Label('comment', a.get('comment'))], link_label=link_label, notes=notes, bookmark=Bookmark.Green)",
            "",
            "    # not supported in our maltego mapping are not handled",
            "",
            "    # LATER : relationships from attributes - not yet supported by MISP yet, but there are references in the datamodel",
            "",
            "",
            "def object_to_attributes(o, e):",
            "    # first process attributes from an object that belong together (eg: first-name + last-name), and remove them from the list",
            "    if o['name'] == 'person':",
            "        first_name = get_attribute_in_object(o, attribute_type='first-name', drop=True).get('value')",
            "        last_name = get_attribute_in_object(o, attribute_type='last-name', drop=True).get('value')",
            "        yield entity_obj_to_entity(Person, ' '.join([first_name, last_name]).strip(), 'person', lastname=last_name, firstnames=first_name, bookmark=Bookmark.Green)",
            "",
            "    # process normal attributes",
            "    for a in o['Attribute']:",
            "        for item in attribute_to_entity(a):",
            "            yield item",
            "",
            "",
            "def get_object_in_event(uuid, e):",
            "    for o in e['Event']['Object']:",
            "        if o['uuid'] == uuid:",
            "            return o",
            "",
            "",
            "def get_attribute_in_object(o, attribute_type=False, attribute_value=False, drop=False, substring=False):",
            "    '''Gets the first attribute of a specific type within an object'''",
            "    found_attribute = {'value': ''}",
            "    for i, a in enumerate(o['Attribute']):",
            "        if a['type'] == attribute_type:",
            "            found_attribute = a.copy()",
            "            if drop:    # drop the attribute from the object",
            "                o['Attribute'].pop(i)",
            "            break",
            "        if a['value'] == attribute_value:",
            "            found_attribute = a.copy()",
            "            if drop:    # drop the attribute from the object",
            "                o['Attribute'].pop(i)",
            "            break",
            "        if '|' in a['type'] or a['type'] == 'malware-sample':",
            "            if attribute_value in a['value'].split('|'):",
            "                found_attribute = a.copy()",
            "                if drop:    # drop the attribute from the object",
            "                    o['Attribute'].pop(i)",
            "                break",
            "        # TODO implement substring matching",
            "        if substring:",
            "            keyword = attribute_value.strip('%')",
            "            if attribute_value.startswith('%') and attribute_value.endswith('%'):",
            "                if attribute_value in a['value']:",
            "                    found_attribute = a.copy()",
            "                    if drop:    # drop the attribute from the object",
            "                        o['Attribute'].pop(i)",
            "                    break",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if attribute_value in val1 or attribute_value in val2:",
            "                        found_attribute = a.copy()",
            "                        if drop:    # drop the attribute from the object",
            "                            o['Attribute'].pop(i)",
            "                        break",
            "            elif attribute_value.startswith('%'):",
            "                if a['value'].endswith(keyword):",
            "                    found_attribute = a.copy()",
            "                    if drop:    # drop the attribute from the object",
            "                        o['Attribute'].pop(i)",
            "                    break",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.endswith(keyword) or val2.endswith(keyword):",
            "                        found_attribute = a.copy()",
            "                        if drop:    # drop the attribute from the object",
            "                            o['Attribute'].pop(i)",
            "                        break",
            "",
            "            elif attribute_value.endswith('%'):",
            "                if a['value'].startswith(keyword):",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.startswith(keyword) or val2.startswith(keyword):",
            "                        found_attribute = a.copy()",
            "                        if drop:    # drop the attribute from the object",
            "                            o['Attribute'].pop(i)",
            "                        break",
            "    return found_attribute",
            "",
            "",
            "def get_attribute_in_event(e, attribute_value, substring=False):",
            "    for a in e['Event'][\"Attribute\"]:",
            "        if a['value'] == attribute_value:",
            "            return a",
            "        if '|' in a['type'] or a['type'] == 'malware-sample':",
            "            if attribute_value in a['value'].split('|'):",
            "                return a",
            "        if substring:",
            "            keyword = attribute_value.strip('%')",
            "            if attribute_value.startswith('%') and attribute_value.endswith('%'):",
            "                if attribute_value in a['value']:",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if attribute_value in val1 or attribute_value in val2:",
            "                        return a",
            "            elif attribute_value.startswith('%'):",
            "                if a['value'].endswith(keyword):",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.endswith(keyword) or val2.endswith(keyword):",
            "                        return a",
            "",
            "            elif attribute_value.endswith('%'):",
            "                if a['value'].startswith(keyword):",
            "                    return a",
            "                if '|' in a['type'] or a['type'] == 'malware-sample':",
            "                    val1, val2 = a['value'].split('|')",
            "                    if val1.startswith(keyword) or val2.startswith(keyword):",
            "                        return a",
            "",
            "    return None",
            "",
            "",
            "def convert_tags_to_note(tags):",
            "    if not tags:",
            "        return None",
            "    notes = []",
            "    for tag in tags:",
            "        for tag_note_prefix in tag_note_prefixes:",
            "            if tag.startswith(tag_note_prefix):",
            "                notes.append(tag)",
            "    return '\\n'.join(notes)",
            "",
            "",
            "def tag_matches_note_prefix(tag):",
            "    for tag_note_prefix in tag_note_prefixes:",
            "        if tag.startswith(tag_note_prefix):",
            "            return True",
            "    return False",
            "",
            "",
            "def event_to_entity(e, link_style=LinkStyle.Normal, link_label=None, link_direction=LinkDirection.InputToOutput):",
            "    tags = []",
            "    if 'Tag' in e['Event']:",
            "        for t in e['Event']['Tag']:",
            "            tags.append(t['name'])",
            "    notes = convert_tags_to_note(tags)",
            "    return MISPEvent(",
            "        e['Event']['id'],",
            "        uuid=e['Event']['uuid'],",
            "        info=e['Event']['info'],",
            "        link_style=link_style,",
            "        link_label=link_label,",
            "        link_direction=link_direction,",
            "        count_attributes=len(e['Event'].get('Attribute') or \"\"),",
            "        count_objects=len(e['Event'].get('Object') or \"\"),",
            "        notes=notes,",
            "        bookmark=Bookmark.Green)",
            "",
            "",
            "def galaxycluster_to_entity(c, link_label=None, link_direction=LinkDirection.InputToOutput):",
            "    if 'meta' in c and 'uuid' in c['meta']:",
            "        c['uuid'] = c['meta']['uuid'].pop(0)",
            "",
            "    if 'meta' in c and 'synonyms' in c['meta']:",
            "        synonyms = ', '.join(c['meta']['synonyms'])",
            "    else:",
            "        synonyms = ''",
            "",
            "    galaxy_cluster = get_galaxy_cluster(uuid=c['uuid'])",
            "    # map the 'icon' name from the cluster to the icon filename of the intelligence-icons repository",
            "    try:",
            "        icon_url = mapping_galaxy_icon[galaxy_cluster['icon']]",
            "    except KeyError:",
            "        # it's not in our mapping, just ignore and leave the default icon",
            "        icon_url = None",
            "",
            "    # create the right sub-galaxy: ThreatActor, Software, AttackTechnique, ... or MISPGalaxy",
            "    try:",
            "        galaxy_type = mapping_galaxy_type[galaxy_cluster['type']]",
            "    except KeyError:",
            "        galaxy_type = MISPGalaxy",
            "    return galaxy_type(",
            "        '{}\\n{}'.format(c['type'], c['value']),",
            "        uuid=c['uuid'],",
            "        description=c.get('description'),",
            "        cluster_type=c.get('type'),",
            "        cluster_value=c.get('value'),",
            "        synonyms=synonyms,",
            "        tag_name=c['tag_name'],",
            "        link_label=link_label,",
            "        icon_url=icon_url,",
            "        link_direction=link_direction",
            "    )",
            "",
            "",
            "# LATER this uses the galaxies from github as the MISP web UI does not fully support the Galaxies in the webui.",
            "# See https://github.com/MISP/MISP/issues/3801",
            "galaxy_archive_url = 'https://github.com/MISP/misp-galaxy/archive/master.zip'",
            "local_path_uuid_mapping = os.path.join(local_path_root, 'MISP_maltego_galaxy_mapping.json')",
            "local_path_clusters = os.path.join(local_path_root, 'misp-galaxy-master', 'clusters')",
            "galaxy_cluster_uuids = None",
            "",
            "",
            "def galaxy_update_local_copy(force=False):",
            "    import io",
            "    import json",
            "    import os",
            "    import requests",
            "    from zipfile import ZipFile",
            "",
            "    # some aging and automatic re-downloading",
            "    if not os.path.exists(local_path_uuid_mapping):",
            "        force = True",
            "    else:",
            "        # force update if cache is older than 24 hours",
            "        if time.time() - os.path.getmtime(local_path_uuid_mapping) > 60 * 60 * 24:",
            "            force = True",
            "",
            "    if force:",
            "        # create a lock to prevent two processes doing the same, and writing to the file at the same time",
            "        lockfile = local_path_uuid_mapping + '.lock'",
            "        from pathlib import Path",
            "        while os.path.exists(lockfile):",
            "            time.sleep(0.3)",
            "        Path(local_path_uuid_mapping + '.lock').touch()",
            "        # download the latest zip of the public galaxy",
            "        try:",
            "            resp = requests.get(galaxy_archive_url)",
            "            zf = ZipFile(io.BytesIO(resp.content))",
            "            zf.extractall(local_path_root)",
            "            zf.close()",
            "        except Exception:",
            "            raise(MaltegoException(\"ERROR: Could not download Galaxy data from htts://github.com/MISP/MISP-galaxy/. Please check internet connectivity.\"))",
            "",
            "        # generate the uuid mapping and save it to a file",
            "        galaxies_fnames = []",
            "        for f in os.listdir(local_path_clusters):",
            "            if '.json' in f:",
            "                galaxies_fnames.append(f)",
            "        galaxies_fnames.sort()",
            "",
            "        cluster_uuids = {}",
            "        for galaxy_fname in galaxies_fnames:",
            "            try:",
            "                fullPathClusters = os.path.join(local_path_clusters, galaxy_fname)",
            "                with open(fullPathClusters) as fp:",
            "                    galaxy = json.load(fp)",
            "                with open(fullPathClusters.replace('clusters', 'galaxies')) as fg:",
            "                    galaxy_main = json.load(fg)",
            "                for cluster in galaxy['values']:",
            "                    if 'uuid' not in cluster:",
            "                        continue",
            "                    # skip deprecated galaxies/clusters",
            "                    if galaxy_main['namespace'] == 'deprecated':",
            "                        continue",
            "                    # keep track of the cluster, but also enhance it to look like the cluster we receive when accessing the web.",
            "                    cluster_uuids[cluster['uuid']] = cluster",
            "                    cluster_uuids[cluster['uuid']]['type'] = galaxy['type']",
            "                    cluster_uuids[cluster['uuid']]['tag_name'] = 'misp-galaxy:{}=\"{}\"'.format(galaxy['type'], cluster['value'])",
            "                    if 'icon' in galaxy_main:",
            "                        cluster_uuids[cluster['uuid']]['icon'] = galaxy_main['icon']",
            "            except Exception:",
            "                # we ignore incorrect galaxies",
            "                pass",
            "",
            "        with open(local_path_uuid_mapping, 'w') as f:",
            "            json.dump(cluster_uuids, f)",
            "        # remove the lock",
            "        os.remove(lockfile)",
            "",
            "",
            "def galaxy_load_cluster_mapping():",
            "    galaxy_update_local_copy()",
            "    with open(local_path_uuid_mapping, 'r') as f:",
            "        cluster_uuids = json.load(f)",
            "    return cluster_uuids",
            "",
            "",
            "def get_galaxy_cluster(uuid=None, tag=None, request_entity=None):",
            "    global galaxy_cluster_uuids",
            "    if not galaxy_cluster_uuids:",
            "        galaxy_cluster_uuids = galaxy_load_cluster_mapping()",
            "",
            "    if uuid:",
            "        return galaxy_cluster_uuids.get(uuid)",
            "    if tag:",
            "        for item in galaxy_cluster_uuids.values():",
            "            if item['tag_name'] == tag:",
            "                return item",
            "    if request_entity:",
            "        if request_entity.uuid:",
            "            return get_galaxy_cluster(uuid=request_entity.uuid)",
            "        elif request_entity.tag_name:",
            "            return get_galaxy_cluster(tag=request_entity.tag_name)",
            "        elif request_entity.name:",
            "            return get_galaxy_cluster(tag=request_entity.name)",
            "",
            "",
            "def search_galaxy_cluster(keyword):",
            "    keyword = keyword.lower()",
            "    global galaxy_cluster_uuids",
            "    if not galaxy_cluster_uuids:",
            "        galaxy_cluster_uuids = galaxy_load_cluster_mapping()",
            "",
            "    # % only at start",
            "    if keyword.startswith('%') and not keyword.endswith('%'):",
            "        keyword = keyword.strip('%')",
            "        for item in galaxy_cluster_uuids.values():",
            "            if item['value'].lower().endswith(keyword):",
            "                yield item",
            "            else:",
            "                if 'meta' in item and 'synonyms' in item['meta']:",
            "                    for synonym in item['meta']['synonyms']:",
            "                        if synonym.lower().endswith(keyword):",
            "                            yield item",
            "",
            "    # % only at end",
            "    elif keyword.endswith('%') and not keyword.startswith('%'):",
            "        keyword = keyword.strip('%')",
            "        for item in galaxy_cluster_uuids.values():",
            "            if item['value'].lower().startswith(keyword):",
            "                yield item",
            "            else:",
            "                if 'meta' in item and 'synonyms' in item['meta']:",
            "                    for synonym in item['meta']['synonyms']:",
            "                        if synonym.lower().startswith(keyword):",
            "                            yield item",
            "",
            "    # search substring assuming % at start and end",
            "    else:",
            "        keyword = keyword.strip('%')",
            "        for item in galaxy_cluster_uuids.values():",
            "            if keyword in item['value'].lower():",
            "                yield item",
            "            else:",
            "                if 'meta' in item and 'synonyms' in item['meta']:",
            "                    for synonym in item['meta']['synonyms']:",
            "                        if keyword in synonym.lower():",
            "                            yield item",
            "",
            "",
            "def get_galaxies_relating(uuid):",
            "    global galaxy_cluster_uuids",
            "    if not galaxy_cluster_uuids:",
            "        galaxy_cluster_uuids = galaxy_load_cluster_mapping()",
            "",
            "    for item in galaxy_cluster_uuids.values():",
            "        if 'related' in item:",
            "            for related in item['related']:",
            "                if related['dest-uuid'] == uuid:",
            "                    yield item"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "21": [
                "misp_connection"
            ],
            "67": [
                "get_misp_connection"
            ],
            "68": [
                "get_misp_connection"
            ],
            "69": [
                "get_misp_connection"
            ],
            "70": [
                "get_misp_connection"
            ],
            "71": [
                "get_misp_connection"
            ],
            "72": [
                "get_misp_connection"
            ],
            "73": [
                "get_misp_connection"
            ],
            "74": [
                "get_misp_connection"
            ],
            "75": [
                "get_misp_connection"
            ],
            "76": [
                "get_misp_connection"
            ],
            "77": [
                "get_misp_connection"
            ],
            "78": [
                "get_misp_connection"
            ],
            "79": [
                "get_misp_connection"
            ],
            "80": [
                "get_misp_connection"
            ],
            "81": [
                "get_misp_connection"
            ],
            "82": [
                "get_misp_connection"
            ],
            "83": [
                "get_misp_connection"
            ],
            "84": [
                "get_misp_connection"
            ],
            "85": [
                "get_misp_connection"
            ],
            "87": [
                "get_misp_connection"
            ],
            "88": [
                "get_misp_connection"
            ],
            "89": [
                "get_misp_connection"
            ],
            "90": [
                "get_misp_connection"
            ],
            "91": [
                "get_misp_connection"
            ],
            "92": [
                "get_misp_connection"
            ],
            "93": [
                "get_misp_connection"
            ],
            "94": [
                "get_misp_connection"
            ],
            "95": [
                "get_misp_connection"
            ],
            "96": [
                "get_misp_connection"
            ],
            "97": [
                "get_misp_connection"
            ],
            "179": [
                "object_to_entity"
            ],
            "180": [
                "object_to_entity"
            ],
            "181": [
                "object_to_entity"
            ],
            "182": [
                "object_to_entity"
            ],
            "183": [
                "object_to_entity"
            ],
            "184": [
                "object_to_entity"
            ],
            "185": [
                "object_to_entity"
            ],
            "186": [
                "object_to_entity"
            ],
            "187": [
                "object_to_entity"
            ],
            "188": [
                "object_to_entity"
            ],
            "189": [
                "object_to_entity"
            ],
            "190": [
                "object_to_entity"
            ],
            "191": [
                "object_to_entity"
            ],
            "192": [
                "object_to_entity"
            ],
            "193": [
                "object_to_entity"
            ],
            "194": [
                "object_to_entity"
            ],
            "195": [
                "object_to_entity"
            ],
            "196": [
                "object_to_entity"
            ],
            "197": [
                "object_to_entity"
            ],
            "198": [
                "object_to_entity"
            ],
            "199": [
                "object_to_entity"
            ],
            "200": [
                "object_to_entity"
            ],
            "201": [
                "object_to_entity"
            ],
            "202": [
                "object_to_entity"
            ],
            "203": [
                "object_to_entity"
            ],
            "204": [
                "object_to_entity"
            ],
            "205": [
                "object_to_entity"
            ],
            "206": [
                "object_to_entity"
            ],
            "207": [
                "object_to_entity"
            ],
            "208": [
                "object_to_entity"
            ],
            "209": [
                "object_to_entity"
            ],
            "210": [
                "object_to_entity"
            ],
            "211": [
                "object_to_entity"
            ],
            "212": [
                "object_to_entity"
            ],
            "213": [
                "object_to_entity"
            ],
            "214": [
                "object_to_entity"
            ],
            "215": [
                "object_to_entity"
            ],
            "216": [
                "object_to_entity"
            ],
            "217": [
                "object_to_entity"
            ],
            "218": [
                "object_to_entity"
            ],
            "219": [
                "object_to_entity"
            ],
            "220": [
                "object_to_entity"
            ],
            "221": [
                "object_to_entity"
            ],
            "222": [
                "object_to_entity"
            ],
            "223": [
                "object_to_entity"
            ],
            "224": [
                "object_to_entity"
            ],
            "225": [
                "object_to_entity"
            ],
            "226": [
                "object_to_entity"
            ],
            "227": [
                "object_to_entity"
            ],
            "228": [
                "object_to_entity"
            ],
            "229": [
                "object_to_entity"
            ],
            "230": [
                "object_to_entity"
            ],
            "231": [
                "object_to_entity"
            ],
            "232": [
                "object_to_entity"
            ],
            "233": [
                "object_to_entity"
            ],
            "234": [
                "object_to_entity"
            ],
            "235": [
                "object_to_entity"
            ],
            "236": [],
            "237": [],
            "251": [
                "object_to_relations"
            ],
            "252": [
                "object_to_relations"
            ],
            "253": [
                "object_to_relations"
            ],
            "254": [
                "object_to_relations"
            ],
            "255": [
                "object_to_relations"
            ],
            "256": [
                "object_to_relations"
            ],
            "257": [
                "object_to_relations"
            ],
            "258": [
                "object_to_relations"
            ],
            "259": [
                "object_to_relations"
            ],
            "260": [
                "object_to_relations"
            ],
            "261": [
                "object_to_relations"
            ],
            "262": [
                "object_to_relations"
            ],
            "263": [
                "object_to_relations"
            ],
            "264": [
                "object_to_relations"
            ],
            "265": [
                "object_to_relations"
            ],
            "266": [
                "object_to_relations"
            ],
            "267": [
                "object_to_relations"
            ],
            "268": [
                "object_to_relations"
            ],
            "269": [
                "object_to_relations"
            ],
            "270": [
                "object_to_relations"
            ],
            "271": [
                "object_to_relations"
            ],
            "272": [
                "object_to_relations"
            ],
            "273": [],
            "274": []
        },
        "addLocation": []
    }
}