{
    "xhu.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " import typing"
            },
            "1": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": " import flask"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+import werkzeug.exceptions"
            },
            "4": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " app = flask.Flask(\"xmpp-http-upload\")"
            },
            "6": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " app.config.from_envvar(\"XMPP_HTTP_UPLOAD_CONFIG\")"
            },
            "7": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "     CORS(app)"
            },
            "8": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 41,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 42,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def sanitized_join(path: str, root: pathlib.Path) -> pathlib.Path:"
            },
            "11": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    result = (root / path).absolute()"
            },
            "12": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if not str(result).startswith(str(root) + \"/\"):"
            },
            "13": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        raise ValueError(\"resulting path is outside root\")"
            },
            "14": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    return result"
            },
            "15": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "16": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "17": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def get_paths(base_path: pathlib.Path):"
            },
            "18": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    data_file = pathlib.Path(str(base_path) + \".data\")"
            },
            "19": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    metadata_file = pathlib.Path(str(base_path) + \".meta\")"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+def get_paths(root: str, sub_path: str) \\"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+        -> typing.Tuple[pathlib.Path, pathlib.Path]:"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+    base_path = flask.safe_join(root, sub_path)"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+    data_file = pathlib.Path(base_path + \".data\")"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+    metadata_file = pathlib.Path(base_path + \".meta\")"
            },
            "25": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 48,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "     return data_file, metadata_file"
            },
            "27": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 50,
                "PatchRowcode": " "
            },
            "28": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "         return json.load(f)"
            },
            "29": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 55,
                "PatchRowcode": " "
            },
            "30": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 56,
                "PatchRowcode": " "
            },
            "31": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def get_info(path: str, root: pathlib.Path) -> typing.Tuple["
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+def get_info(path: str) -> typing.Tuple["
            },
            "33": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 58,
                "PatchRowcode": "         pathlib.Path,"
            },
            "34": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 59,
                "PatchRowcode": "         dict]:"
            },
            "35": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    dest_path = sanitized_join("
            },
            "36": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        path,"
            },
            "37": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        pathlib.Path(app.config[\"DATA_ROOT\"]),"
            },
            "38": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    )"
            },
            "39": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "40": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    data_file, metadata_file = get_paths(dest_path)"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+    data_file, metadata_file = get_paths(app.config[\"DATA_ROOT\"], path)"
            },
            "42": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 61,
                "PatchRowcode": " "
            },
            "43": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "     return data_file, load_metadata(metadata_file)"
            },
            "44": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 63,
                "PatchRowcode": " "
            },
            "45": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 95,
                "PatchRowcode": " @app.route(\"/<path:path>\", methods=[\"PUT\"])"
            },
            "46": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 96,
                "PatchRowcode": " def put_file(path):"
            },
            "47": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "     try:"
            },
            "48": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        dest_path = sanitized_join("
            },
            "49": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            path,"
            },
            "50": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            pathlib.Path(app.config[\"DATA_ROOT\"]),"
            },
            "51": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        )"
            },
            "52": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    except ValueError:"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+        data_file, metadata_file = get_paths(app.config[\"DATA_ROOT\"], path)"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+    except werkzeug.exceptions.NotFound:"
            },
            "55": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         return flask.Response("
            },
            "56": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "             \"Not Found\","
            },
            "57": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "             404,"
            },
            "58": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 122,
                "PatchRowcode": "         \"application/octet-stream\","
            },
            "59": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "     )"
            },
            "60": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 124,
                "PatchRowcode": " "
            },
            "61": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    dest_path.parent.mkdir(parents=True, exist_ok=True, mode=0o770)"
            },
            "62": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    data_file, metadata_file = get_paths(dest_path)"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+    data_file.parent.mkdir(parents=True, exist_ok=True, mode=0o770)"
            },
            "64": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 126,
                "PatchRowcode": " "
            },
            "65": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": 127,
                "PatchRowcode": "     try:"
            },
            "66": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": 128,
                "PatchRowcode": "         with write_file(data_file) as fout:"
            },
            "67": {
                "beforePatchRowNumber": 189,
                "afterPatchRowNumber": 176,
                "PatchRowcode": " @app.route(\"/<path:path>\", methods=[\"HEAD\"])"
            },
            "68": {
                "beforePatchRowNumber": 190,
                "afterPatchRowNumber": 177,
                "PatchRowcode": " def head_file(path):"
            },
            "69": {
                "beforePatchRowNumber": 191,
                "afterPatchRowNumber": 178,
                "PatchRowcode": "     try:"
            },
            "70": {
                "beforePatchRowNumber": 192,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        data_file, metadata = get_info("
            },
            "71": {
                "beforePatchRowNumber": 193,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            path,"
            },
            "72": {
                "beforePatchRowNumber": 194,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            pathlib.Path(app.config[\"DATA_ROOT\"])"
            },
            "73": {
                "beforePatchRowNumber": 195,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        )"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 179,
                "PatchRowcode": "+        data_file, metadata = get_info(path)"
            },
            "75": {
                "beforePatchRowNumber": 196,
                "afterPatchRowNumber": 180,
                "PatchRowcode": " "
            },
            "76": {
                "beforePatchRowNumber": 197,
                "afterPatchRowNumber": 181,
                "PatchRowcode": "         stat = data_file.stat()"
            },
            "77": {
                "beforePatchRowNumber": 198,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    except (OSError, ValueError):"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+    except (OSError, werkzeug.exceptions.NotFound):"
            },
            "79": {
                "beforePatchRowNumber": 199,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "         return flask.Response("
            },
            "80": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": 184,
                "PatchRowcode": "             \"Not Found\","
            },
            "81": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": 185,
                "PatchRowcode": "             404,"
            },
            "82": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": 198,
                "PatchRowcode": " @app.route(\"/<path:path>\", methods=[\"GET\"])"
            },
            "83": {
                "beforePatchRowNumber": 215,
                "afterPatchRowNumber": 199,
                "PatchRowcode": " def get_file(path):"
            },
            "84": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": 200,
                "PatchRowcode": "     try:"
            },
            "85": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        data_file, metadata = get_info("
            },
            "86": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            path,"
            },
            "87": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            pathlib.Path(app.config[\"DATA_ROOT\"])"
            },
            "88": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        )"
            },
            "89": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    except (OSError, ValueError):"
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 201,
                "PatchRowcode": "+        data_file, metadata = get_info(path)"
            },
            "91": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 202,
                "PatchRowcode": "+    except (OSError, werkzeug.exceptions.NotFound):"
            },
            "92": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": 203,
                "PatchRowcode": "         return flask.Response("
            },
            "93": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": 204,
                "PatchRowcode": "             \"Not Found\","
            },
            "94": {
                "beforePatchRowNumber": 224,
                "afterPatchRowNumber": 205,
                "PatchRowcode": "             404,"
            }
        },
        "frontPatchFile": [
            "########################################################################",
            "# File name: xhu.py",
            "# This file is part of: xmpp-http-upload",
            "#",
            "# LICENSE",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful, but",
            "# WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU",
            "# General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public",
            "# License along with this program.  If not, see",
            "# <http://www.gnu.org/licenses/>.",
            "#",
            "########################################################################",
            "import contextlib",
            "import errno",
            "import fnmatch",
            "import json",
            "import hashlib",
            "import hmac",
            "import pathlib",
            "import typing",
            "",
            "import flask",
            "",
            "app = flask.Flask(\"xmpp-http-upload\")",
            "app.config.from_envvar(\"XMPP_HTTP_UPLOAD_CONFIG\")",
            "application = app",
            "",
            "if app.config['ENABLE_CORS']:",
            "    from flask_cors import CORS",
            "    CORS(app)",
            "",
            "",
            "def sanitized_join(path: str, root: pathlib.Path) -> pathlib.Path:",
            "    result = (root / path).absolute()",
            "    if not str(result).startswith(str(root) + \"/\"):",
            "        raise ValueError(\"resulting path is outside root\")",
            "    return result",
            "",
            "",
            "def get_paths(base_path: pathlib.Path):",
            "    data_file = pathlib.Path(str(base_path) + \".data\")",
            "    metadata_file = pathlib.Path(str(base_path) + \".meta\")",
            "",
            "    return data_file, metadata_file",
            "",
            "",
            "def load_metadata(metadata_file):",
            "    with metadata_file.open(\"r\") as f:",
            "        return json.load(f)",
            "",
            "",
            "def get_info(path: str, root: pathlib.Path) -> typing.Tuple[",
            "        pathlib.Path,",
            "        dict]:",
            "    dest_path = sanitized_join(",
            "        path,",
            "        pathlib.Path(app.config[\"DATA_ROOT\"]),",
            "    )",
            "",
            "    data_file, metadata_file = get_paths(dest_path)",
            "",
            "    return data_file, load_metadata(metadata_file)",
            "",
            "",
            "@contextlib.contextmanager",
            "def write_file(at: pathlib.Path):",
            "    with at.open(\"xb\") as f:",
            "        try:",
            "            yield f",
            "        except:  # NOQA",
            "            at.unlink()",
            "            raise",
            "",
            "",
            "@app.route(\"/\")",
            "def index():",
            "    return flask.Response(",
            "        \"Welcome to XMPP HTTP Upload. State your business.\",",
            "        mimetype=\"text/plain\",",
            "    )",
            "",
            "",
            "def stream_file(src, dest, nbytes):",
            "    while nbytes > 0:",
            "        data = src.read(min(nbytes, 4096))",
            "        if not data:",
            "            break",
            "        dest.write(data)",
            "        nbytes -= len(data)",
            "",
            "    if nbytes > 0:",
            "        raise EOFError",
            "",
            "",
            "@app.route(\"/<path:path>\", methods=[\"PUT\"])",
            "def put_file(path):",
            "    try:",
            "        dest_path = sanitized_join(",
            "            path,",
            "            pathlib.Path(app.config[\"DATA_ROOT\"]),",
            "        )",
            "    except ValueError:",
            "        return flask.Response(",
            "            \"Not Found\",",
            "            404,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    verification_key = flask.request.args.get(\"v\", \"\")",
            "    length = int(flask.request.headers.get(\"Content-Length\", 0))",
            "    hmac_input = \"{} {}\".format(path, length).encode(\"utf-8\")",
            "    key = app.config[\"SECRET_KEY\"]",
            "    mac = hmac.new(key, hmac_input, hashlib.sha256)",
            "    digest = mac.hexdigest()",
            "",
            "    if not hmac.compare_digest(digest, verification_key):",
            "        return flask.Response(",
            "            \"Invalid verification key\",",
            "            403,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    content_type = flask.request.headers.get(",
            "        \"Content-Type\",",
            "        \"application/octet-stream\",",
            "    )",
            "",
            "    dest_path.parent.mkdir(parents=True, exist_ok=True, mode=0o770)",
            "    data_file, metadata_file = get_paths(dest_path)",
            "",
            "    try:",
            "        with write_file(data_file) as fout:",
            "            stream_file(flask.request.stream, fout, length)",
            "",
            "            with metadata_file.open(\"x\") as f:",
            "                json.dump(",
            "                    {",
            "                        \"headers\": {\"Content-Type\": content_type},",
            "                    },",
            "                    f,",
            "                )",
            "    except EOFError:",
            "        return flask.Response(",
            "            \"Bad Request\",",
            "            400,",
            "            mimetype=\"text/plain\",",
            "        )",
            "    except OSError as exc:",
            "        if exc.errno == errno.EEXIST:",
            "            return flask.Response(",
            "                \"Conflict\",",
            "                409,",
            "                mimetype=\"text/plain\",",
            "            )",
            "        raise",
            "",
            "    return flask.Response(",
            "        \"Created\",",
            "        201,",
            "        mimetype=\"text/plain\",",
            "    )",
            "",
            "",
            "def generate_headers(response_headers, metadata_headers):",
            "    for key, value in metadata_headers.items():",
            "        response_headers[key] = value",
            "",
            "    content_type = metadata_headers[\"Content-Type\"]",
            "    for mimetype_glob in app.config.get(\"NON_ATTACHMENT_MIME_TYPES\", []):",
            "        if fnmatch.fnmatch(content_type, mimetype_glob):",
            "            break",
            "    else:",
            "        response_headers[\"Content-Disposition\"] = \"attachment\"",
            "",
            "    response_headers[\"X-Content-Type-Options\"] = \"nosniff\"",
            "    response_headers[\"X-Frame-Options\"] = \"DENY\"",
            "    response_headers[\"Content-Security-Policy\"] = \"default-src 'none'; frame-ancestors 'none'; sandbox\"",
            "",
            "",
            "@app.route(\"/<path:path>\", methods=[\"HEAD\"])",
            "def head_file(path):",
            "    try:",
            "        data_file, metadata = get_info(",
            "            path,",
            "            pathlib.Path(app.config[\"DATA_ROOT\"])",
            "        )",
            "",
            "        stat = data_file.stat()",
            "    except (OSError, ValueError):",
            "        return flask.Response(",
            "            \"Not Found\",",
            "            404,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    response = flask.Response()",
            "    response.headers[\"Content-Length\"] = str(stat.st_size)",
            "    generate_headers(",
            "        response.headers,",
            "        metadata[\"headers\"],",
            "    )",
            "    return response",
            "",
            "",
            "@app.route(\"/<path:path>\", methods=[\"GET\"])",
            "def get_file(path):",
            "    try:",
            "        data_file, metadata = get_info(",
            "            path,",
            "            pathlib.Path(app.config[\"DATA_ROOT\"])",
            "        )",
            "    except (OSError, ValueError):",
            "        return flask.Response(",
            "            \"Not Found\",",
            "            404,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    response = flask.make_response(flask.send_file(",
            "        str(data_file),",
            "    ))",
            "    generate_headers(",
            "        response.headers,",
            "        metadata[\"headers\"],",
            "    )",
            "    return response"
        ],
        "afterPatchFile": [
            "########################################################################",
            "# File name: xhu.py",
            "# This file is part of: xmpp-http-upload",
            "#",
            "# LICENSE",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful, but",
            "# WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU",
            "# General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public",
            "# License along with this program.  If not, see",
            "# <http://www.gnu.org/licenses/>.",
            "#",
            "########################################################################",
            "import contextlib",
            "import errno",
            "import fnmatch",
            "import json",
            "import hashlib",
            "import hmac",
            "import pathlib",
            "import typing",
            "",
            "import flask",
            "import werkzeug.exceptions",
            "",
            "app = flask.Flask(\"xmpp-http-upload\")",
            "app.config.from_envvar(\"XMPP_HTTP_UPLOAD_CONFIG\")",
            "application = app",
            "",
            "if app.config['ENABLE_CORS']:",
            "    from flask_cors import CORS",
            "    CORS(app)",
            "",
            "",
            "def get_paths(root: str, sub_path: str) \\",
            "        -> typing.Tuple[pathlib.Path, pathlib.Path]:",
            "    base_path = flask.safe_join(root, sub_path)",
            "    data_file = pathlib.Path(base_path + \".data\")",
            "    metadata_file = pathlib.Path(base_path + \".meta\")",
            "",
            "    return data_file, metadata_file",
            "",
            "",
            "def load_metadata(metadata_file):",
            "    with metadata_file.open(\"r\") as f:",
            "        return json.load(f)",
            "",
            "",
            "def get_info(path: str) -> typing.Tuple[",
            "        pathlib.Path,",
            "        dict]:",
            "    data_file, metadata_file = get_paths(app.config[\"DATA_ROOT\"], path)",
            "",
            "    return data_file, load_metadata(metadata_file)",
            "",
            "",
            "@contextlib.contextmanager",
            "def write_file(at: pathlib.Path):",
            "    with at.open(\"xb\") as f:",
            "        try:",
            "            yield f",
            "        except:  # NOQA",
            "            at.unlink()",
            "            raise",
            "",
            "",
            "@app.route(\"/\")",
            "def index():",
            "    return flask.Response(",
            "        \"Welcome to XMPP HTTP Upload. State your business.\",",
            "        mimetype=\"text/plain\",",
            "    )",
            "",
            "",
            "def stream_file(src, dest, nbytes):",
            "    while nbytes > 0:",
            "        data = src.read(min(nbytes, 4096))",
            "        if not data:",
            "            break",
            "        dest.write(data)",
            "        nbytes -= len(data)",
            "",
            "    if nbytes > 0:",
            "        raise EOFError",
            "",
            "",
            "@app.route(\"/<path:path>\", methods=[\"PUT\"])",
            "def put_file(path):",
            "    try:",
            "        data_file, metadata_file = get_paths(app.config[\"DATA_ROOT\"], path)",
            "    except werkzeug.exceptions.NotFound:",
            "        return flask.Response(",
            "            \"Not Found\",",
            "            404,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    verification_key = flask.request.args.get(\"v\", \"\")",
            "    length = int(flask.request.headers.get(\"Content-Length\", 0))",
            "    hmac_input = \"{} {}\".format(path, length).encode(\"utf-8\")",
            "    key = app.config[\"SECRET_KEY\"]",
            "    mac = hmac.new(key, hmac_input, hashlib.sha256)",
            "    digest = mac.hexdigest()",
            "",
            "    if not hmac.compare_digest(digest, verification_key):",
            "        return flask.Response(",
            "            \"Invalid verification key\",",
            "            403,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    content_type = flask.request.headers.get(",
            "        \"Content-Type\",",
            "        \"application/octet-stream\",",
            "    )",
            "",
            "    data_file.parent.mkdir(parents=True, exist_ok=True, mode=0o770)",
            "",
            "    try:",
            "        with write_file(data_file) as fout:",
            "            stream_file(flask.request.stream, fout, length)",
            "",
            "            with metadata_file.open(\"x\") as f:",
            "                json.dump(",
            "                    {",
            "                        \"headers\": {\"Content-Type\": content_type},",
            "                    },",
            "                    f,",
            "                )",
            "    except EOFError:",
            "        return flask.Response(",
            "            \"Bad Request\",",
            "            400,",
            "            mimetype=\"text/plain\",",
            "        )",
            "    except OSError as exc:",
            "        if exc.errno == errno.EEXIST:",
            "            return flask.Response(",
            "                \"Conflict\",",
            "                409,",
            "                mimetype=\"text/plain\",",
            "            )",
            "        raise",
            "",
            "    return flask.Response(",
            "        \"Created\",",
            "        201,",
            "        mimetype=\"text/plain\",",
            "    )",
            "",
            "",
            "def generate_headers(response_headers, metadata_headers):",
            "    for key, value in metadata_headers.items():",
            "        response_headers[key] = value",
            "",
            "    content_type = metadata_headers[\"Content-Type\"]",
            "    for mimetype_glob in app.config.get(\"NON_ATTACHMENT_MIME_TYPES\", []):",
            "        if fnmatch.fnmatch(content_type, mimetype_glob):",
            "            break",
            "    else:",
            "        response_headers[\"Content-Disposition\"] = \"attachment\"",
            "",
            "    response_headers[\"X-Content-Type-Options\"] = \"nosniff\"",
            "    response_headers[\"X-Frame-Options\"] = \"DENY\"",
            "    response_headers[\"Content-Security-Policy\"] = \"default-src 'none'; frame-ancestors 'none'; sandbox\"",
            "",
            "",
            "@app.route(\"/<path:path>\", methods=[\"HEAD\"])",
            "def head_file(path):",
            "    try:",
            "        data_file, metadata = get_info(path)",
            "",
            "        stat = data_file.stat()",
            "    except (OSError, werkzeug.exceptions.NotFound):",
            "        return flask.Response(",
            "            \"Not Found\",",
            "            404,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    response = flask.Response()",
            "    response.headers[\"Content-Length\"] = str(stat.st_size)",
            "    generate_headers(",
            "        response.headers,",
            "        metadata[\"headers\"],",
            "    )",
            "    return response",
            "",
            "",
            "@app.route(\"/<path:path>\", methods=[\"GET\"])",
            "def get_file(path):",
            "    try:",
            "        data_file, metadata = get_info(path)",
            "    except (OSError, werkzeug.exceptions.NotFound):",
            "        return flask.Response(",
            "            \"Not Found\",",
            "            404,",
            "            mimetype=\"text/plain\",",
            "        )",
            "",
            "    response = flask.make_response(flask.send_file(",
            "        str(data_file),",
            "    ))",
            "    generate_headers(",
            "        response.headers,",
            "        metadata[\"headers\"],",
            "    )",
            "    return response"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "42": [
                "sanitized_join"
            ],
            "43": [
                "sanitized_join"
            ],
            "44": [
                "sanitized_join"
            ],
            "45": [
                "sanitized_join"
            ],
            "46": [
                "sanitized_join"
            ],
            "47": [],
            "48": [],
            "49": [
                "get_paths"
            ],
            "50": [
                "get_paths"
            ],
            "51": [
                "get_paths"
            ],
            "61": [
                "get_info"
            ],
            "64": [
                "get_info"
            ],
            "65": [
                "get_info"
            ],
            "66": [
                "get_info"
            ],
            "67": [
                "get_info"
            ],
            "68": [
                "get_info"
            ],
            "69": [
                "get_info"
            ],
            "107": [
                "put_file"
            ],
            "108": [
                "put_file"
            ],
            "109": [
                "put_file"
            ],
            "110": [
                "put_file"
            ],
            "111": [
                "put_file"
            ],
            "137": [
                "put_file"
            ],
            "138": [
                "put_file"
            ],
            "192": [
                "head_file"
            ],
            "193": [
                "head_file"
            ],
            "194": [
                "head_file"
            ],
            "195": [
                "head_file"
            ],
            "198": [
                "head_file"
            ],
            "217": [
                "get_file"
            ],
            "218": [
                "get_file"
            ],
            "219": [
                "get_file"
            ],
            "220": [
                "get_file"
            ],
            "221": [
                "get_file"
            ]
        },
        "addLocation": []
    }
}