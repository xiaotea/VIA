{
    "rdiffweb/controller/page_admin_users.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "         validators=["
            },
            "1": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "             validators.data_required(),"
            },
            "2": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "             validators.length(max=256, message=_('Username too long.')),"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+            validators.length(min=3, message=_('Username too short.')),"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 78,
                "PatchRowcode": "+            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),"
            },
            "5": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "         ],"
            },
            "6": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "     )"
            },
            "7": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "     fullname = StringField("
            },
            "8": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "         _('Fullname'),"
            },
            "9": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "         validators=["
            },
            "10": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "             validators.optional(),"
            },
            "11": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 85,
                "PatchRowcode": "             validators.length(max=256, message=_('Fullname too long.')),"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),"
            },
            "13": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "         ],"
            },
            "14": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "     )"
            },
            "15": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "     email = EmailField("
            },
            "16": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 90,
                "PatchRowcode": "         _('Email'),"
            },
            "17": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "         validators=["
            },
            "18": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "             validators.optional(),"
            },
            "19": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "             validators.length(max=256, message=_('Email too long.')),"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),"
            },
            "21": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         ],"
            },
            "22": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "     )"
            },
            "23": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "     password = PasswordField("
            },
            "24": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": 144,
                "PatchRowcode": "         widget=widgets.HiddenInput(),"
            },
            "25": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": 145,
                "PatchRowcode": "     )"
            },
            "26": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": 146,
                "PatchRowcode": " "
            },
            "27": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def __init__(self, *args, **kwargs):"
            },
            "28": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        super().__init__(*args, **kwargs)"
            },
            "29": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cfg = cherrypy.tree.apps[''].cfg"
            },
            "30": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.password.validators += ["
            },
            "31": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            validators.length("
            },
            "32": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                min=cfg.password_min_length,"
            },
            "33": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                max=cfg.password_max_length,"
            },
            "34": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                message=_('Password must have between %(min)d and %(max)d characters.'),"
            },
            "35": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            )"
            },
            "36": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ]"
            },
            "37": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "38": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "     def validate_role(self, field):"
            },
            "39": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": 148,
                "PatchRowcode": "         # Don't allow the user to changes it's \"role\" state."
            },
            "40": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 149,
                "PatchRowcode": "         currentuser = cherrypy.request.currentuser"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "        description=_('To create an LDAP user, you must leave the password empty.'),",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "        render_kw={'data-beta': 1},",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "        self.password.validators += [",
            "            validators.length(",
            "                min=cfg.password_min_length,",
            "                max=cfg.password_max_length,",
            "                message=_('Password must have between %(min)d and %(max)d characters.'),",
            "            )",
            "        ]",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValueError(_('Cannot change your own two-factor authentication settings.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data, old_password=None)",
            "        userobj.role = self.role.data",
            "        userobj.fullname = self.fullname.data or ''",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if self.mfa.data and not userobj.email:",
            "            flash(_(\"User email is required to enabled Two-Factor Authentication\"), level='error')",
            "        else:",
            "            userobj.mfa = self.mfa.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        else:",
            "            userobj.refresh_repos(delete=True)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = UserObject.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    @cherrypy.expose",
            "    def default(self, username=None, action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = UserObject.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = UserObject.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"users\": UserObject.query.all(),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import logging",
            "",
            "import cherrypy",
            "import humanfriendly",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, HiddenField, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Max root directory path length",
            "MAX_PATH = 260",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = HiddenField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "            validators.length(min=3, message=_('Username too short.')),",
            "            validators.regexp(UserObject.PATTERN_USERNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Fullname too long.')),",
            "            validators.regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "            validators.regexp(UserObject.PATTERN_EMAIL, message=_('Must be a valid email address.')),",
            "        ],",
            "    )",
            "    password = PasswordField(",
            "        _('Password'),",
            "        validators=[validators.optional()],",
            "        description=_('To create an LDAP user, you must leave the password empty.'),",
            "    )",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA)'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        default=UserObject.DISABLED_MFA,",
            "        description=_(",
            "            \"When Two-Factor Authentication (2FA) is enabled for a user, a verification code get sent by email when user login from a new location.\"",
            "        ),",
            "        render_kw={'data-beta': 1},",
            "    )",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.ADMIN_ROLE, _(\"Admin\")),",
            "            (UserObject.MAINTAINER_ROLE, _(\"Maintainer\")),",
            "            (UserObject.USER_ROLE, _(\"User\")),",
            "        ],",
            "        default=UserObject.USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Disk spaces (in bytes) used by this user.\"),",
            "        widget=widgets.HiddenInput(),",
            "    )",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def validate_mfa(self, field):",
            "        # Don't allow the user to changes it's \"mfa\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.mfa.data != currentuser.mfa:",
            "            raise ValueError(_('Cannot change your own two-factor authentication settings.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data, old_password=None)",
            "        userobj.role = self.role.data",
            "        userobj.fullname = self.fullname.data or ''",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if self.mfa.data and not userobj.email:",
            "            flash(_(\"User email is required to enabled Two-Factor Authentication\"), level='error')",
            "        else:",
            "            userobj.mfa = self.mfa.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        else:",
            "            userobj.refresh_repos(delete=True)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminUsersPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = UserObject.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    @cherrypy.expose",
            "    def default(self, username=None, action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = UserObject.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = UserObject.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"users\": UserObject.query.all(),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "143": [
                "UserForm",
                "__init__"
            ],
            "144": [
                "UserForm",
                "__init__"
            ],
            "145": [
                "UserForm",
                "__init__"
            ],
            "146": [
                "UserForm",
                "__init__"
            ],
            "147": [
                "UserForm",
                "__init__"
            ],
            "148": [
                "UserForm",
                "__init__"
            ],
            "149": [
                "UserForm",
                "__init__"
            ],
            "150": [
                "UserForm",
                "__init__"
            ],
            "151": [
                "UserForm",
                "__init__"
            ],
            "152": [
                "UserForm",
                "__init__"
            ],
            "153": [
                "UserForm"
            ]
        },
        "addLocation": [
            "rdiffweb.controller.page_admin_users.AdminUsersPage.default",
            "rdiffweb.controller.page_admin_users.AdminUsersPage.default.form",
            "rdiffweb.controller.page_admin_users.UserForm.self",
            "rdiffweb.controller.page_admin_users.SizeField.__init__.validators"
        ]
    },
    "rdiffweb/controller/page_pref_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " to change password ans refresh it's repository view."
            },
            "1": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " \"\"\""
            },
            "2": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-import logging"
            },
            "4": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-import re"
            },
            "5": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "6": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " import cherrypy"
            },
            "7": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField"
            },
            "8": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " from wtforms.fields.html5 import EmailField"
            },
            "9": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp"
            },
            "10": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " from rdiffweb.controller import Controller, flash"
            },
            "12": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 28,
                "PatchRowcode": " from rdiffweb.controller.form import CherryForm"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+from rdiffweb.core.model import UserObject"
            },
            "14": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " from rdiffweb.tools.i18n import gettext_lazy as _"
            },
            "15": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 31,
                "PatchRowcode": " "
            },
            "16": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-# Define the logger"
            },
            "17": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-_logger = logging.getLogger(__name__)"
            },
            "18": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "19": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-PATTERN_EMAIL = re.compile(r'[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$')"
            },
            "20": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "21": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 32,
                "PatchRowcode": " "
            },
            "22": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " class UserProfileForm(CherryForm):"
            },
            "23": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "     action = HiddenField(default='set_profile_info')"
            },
            "24": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 38,
                "PatchRowcode": "         validators=["
            },
            "25": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "             Optional(),"
            },
            "26": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "             Length(max=256, message=_('Fullname too long.')),"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),"
            },
            "28": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 42,
                "PatchRowcode": "         ],"
            },
            "29": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 43,
                "PatchRowcode": "     )"
            },
            "30": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "     email = EmailField("
            },
            "31": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "         _('Email'),"
            },
            "32": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "         validators=["
            },
            "33": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "             DataRequired(),"
            },
            "34": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            Length(max=256, message=_(\"Invalid email.\")),"
            },
            "35": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            Regexp(PATTERN_EMAIL, message=_(\"Invalid email.\")),"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 48,
                "PatchRowcode": "+            Length(max=256, message=_(\"Email too long.\")),"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),"
            },
            "38": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "         ],"
            },
            "39": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "     )"
            },
            "40": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "     set_profile_info = SubmitField(_('Save changes'))"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import logging",
            "import re",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "_logger = logging.getLogger(__name__)",
            "",
            "PATTERN_EMAIL = re.compile(r'[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$')",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Invalid email.\")),",
            "            Regexp(PATTERN_EMAIL, message=_(\"Invalid email.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.set_password(self.new.data, old_password=self.current.data)",
            "            flash(_(\"Password updated successfully.\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                password_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.set_password(self.new.data, old_password=self.current.data)",
            "            flash(_(\"Password updated successfully.\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                password_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "22": [],
            "23": [],
            "24": [],
            "34": [],
            "35": [
                "_logger"
            ],
            "36": [],
            "37": [
                "PATTERN_EMAIL"
            ],
            "38": [],
            "54": [
                "UserProfileForm"
            ],
            "55": [
                "UserProfileForm"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_admin_users.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from unittest.mock import ANY, MagicMock"
            },
            "1": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " import cherrypy"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+from parameterized import parameterized"
            },
            "4": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " import rdiffweb.test"
            },
            "6": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " from rdiffweb.core.model import UserObject"
            },
            "7": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "         self.assertInBody(\"User account removed.\")"
            },
            "8": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": 172,
                "PatchRowcode": "         self.assertNotInBody(\"test2\")"
            },
            "9": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 173,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_edit_fullname(self):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 174,
                "PatchRowcode": "+    @parameterized.expand("
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 175,
                "PatchRowcode": "+        ["
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 176,
                "PatchRowcode": "+            # Invalid"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 177,
                "PatchRowcode": "+            ('evil.com', False),"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 178,
                "PatchRowcode": "+            ('http://test', False),"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 179,
                "PatchRowcode": "+            ('email@test.test', False),"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 180,
                "PatchRowcode": "+            ('/test/', False),"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 181,
                "PatchRowcode": "+            # Valid"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+            ('My fullname', True),"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 183,
                "PatchRowcode": "+            ('Test Test', True),"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 184,
                "PatchRowcode": "+            ('\u00c9ric Terrien-Pascal', True),"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 185,
                "PatchRowcode": "+            (\"Tel'c\", True),"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 186,
                "PatchRowcode": "+        ]"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 187,
                "PatchRowcode": "+    )"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 188,
                "PatchRowcode": "+    def test_edit_fullname_with_special_character(self, new_fullname, expected_valid):"
            },
            "26": {
                "beforePatchRowNumber": 174,
                "afterPatchRowNumber": 189,
                "PatchRowcode": "         # Given an existing user"
            },
            "27": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 190,
                "PatchRowcode": "         # When updating the user's fullname"
            },
            "28": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 191,
                "PatchRowcode": "         self.getPage("
            },
            "29": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": 192,
                "PatchRowcode": "             \"/admin/users/\","
            },
            "30": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": 193,
                "PatchRowcode": "             method='POST',"
            },
            "31": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            body={'action': 'edit', 'username': self.USERNAME, 'fullname': 'My fullname'},"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 194,
                "PatchRowcode": "+            body={'action': 'edit', 'username': self.USERNAME, 'fullname': new_fullname},"
            },
            "33": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 195,
                "PatchRowcode": "         )"
            },
            "34": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 196,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "35": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then user is updated successfully"
            },
            "36": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"User information modified successfully.\")"
            },
            "37": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then database is updated"
            },
            "38": {
                "beforePatchRowNumber": 185,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        obj = UserObject.query.filter(UserObject.username == self.USERNAME).first()"
            },
            "39": {
                "beforePatchRowNumber": 186,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertEqual('My fullname', obj.fullname)"
            },
            "40": {
                "beforePatchRowNumber": 187,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "41": {
                "beforePatchRowNumber": 188,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_add_edit_delete_user_with_encoding(self):"
            },
            "42": {
                "beforePatchRowNumber": 189,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\""
            },
            "43": {
                "beforePatchRowNumber": 190,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        Check creation of user with non-ascii char."
            },
            "44": {
                "beforePatchRowNumber": 191,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\""
            },
            "45": {
                "beforePatchRowNumber": 192,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._add_user(\"\u00c9ric\", \"\u00e9ric@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)"
            },
            "46": {
                "beforePatchRowNumber": 193,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"User added successfully.\")"
            },
            "47": {
                "beforePatchRowNumber": 194,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"\u00c9ric\")"
            },
            "48": {
                "beforePatchRowNumber": 195,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"\u00e9ric@test.com\")"
            },
            "49": {
                "beforePatchRowNumber": 196,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Update user"
            },
            "50": {
                "beforePatchRowNumber": 197,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._edit_user(\"\u00c9ric\", \"eric.l\u00e9tourno@test.com\", \"\u00e9cureuil\", \"/tmp/\", UserObject.ADMIN_ROLE)"
            },
            "51": {
                "beforePatchRowNumber": 198,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"User information modified successfully.\")"
            },
            "52": {
                "beforePatchRowNumber": 199,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"\u00c9ric\")"
            },
            "53": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"eric.l\u00e9tourno@test.com\")"
            },
            "54": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertNotInBody(\"/home/\")"
            },
            "55": {
                "beforePatchRowNumber": 202,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"/tmp/\")"
            },
            "56": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "57": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._delete_user(\"\u00c9ric\")"
            },
            "58": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"User account removed.\")"
            },
            "59": {
                "beforePatchRowNumber": 206,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertNotInBody(\"\u00c9ric\")"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 197,
                "PatchRowcode": "+        if expected_valid:"
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 198,
                "PatchRowcode": "+            self.assertInBody(\"User information modified successfully.\")"
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 199,
                "PatchRowcode": "+            self.assertNotInBody(\"Fullname: Must not contain any special characters.\")"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 200,
                "PatchRowcode": "+        else:"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 201,
                "PatchRowcode": "+            self.assertNotInBody(\"User information modified successfully.\")"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 202,
                "PatchRowcode": "+            self.assertInBody(\"Fullname: Must not contain any special characters.\")"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 203,
                "PatchRowcode": "+"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 204,
                "PatchRowcode": "+    @parameterized.expand("
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 205,
                "PatchRowcode": "+        ["
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 206,
                "PatchRowcode": "+            # Invalid"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 207,
                "PatchRowcode": "+            ('http://username', False),"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 208,
                "PatchRowcode": "+            ('username@test.test', False),"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 209,
                "PatchRowcode": "+            ('/username/', False),"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 210,
                "PatchRowcode": "+            # Valid"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 211,
                "PatchRowcode": "+            ('username.com', True),"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 212,
                "PatchRowcode": "+            ('admin_user', True),"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 213,
                "PatchRowcode": "+            ('test.test', True),"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 214,
                "PatchRowcode": "+            ('test-test', True),"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 215,
                "PatchRowcode": "+        ]"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 216,
                "PatchRowcode": "+    )"
            },
            "80": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 217,
                "PatchRowcode": "+    def test_add_user_with_special_character(self, new_username, expected_valid):"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 218,
                "PatchRowcode": "+        self._add_user(new_username, \"eric@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 219,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 220,
                "PatchRowcode": "+        if expected_valid:"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 221,
                "PatchRowcode": "+            self.assertInBody(\"User added successfully.\")"
            },
            "85": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 222,
                "PatchRowcode": "+            self.assertNotInBody(\"Username: Must not contain any special characters.\")"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 223,
                "PatchRowcode": "+        else:"
            },
            "87": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 224,
                "PatchRowcode": "+            self.assertNotInBody(\"User added successfully.\")"
            },
            "88": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 225,
                "PatchRowcode": "+            self.assertInBody(\"Username: Must not contain any special characters.\")"
            },
            "89": {
                "beforePatchRowNumber": 207,
                "afterPatchRowNumber": 226,
                "PatchRowcode": " "
            },
            "90": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": 227,
                "PatchRowcode": "     def test_add_user_with_empty_username(self):"
            },
            "91": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": 228,
                "PatchRowcode": "         \"\"\""
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "from unittest.mock import ANY, MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class AbstractAdminTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self._quota = {}",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        self.listener.get_disk_quota.side_effect = self._load_quota",
            "        cherrypy.engine.subscribe('get_disk_quota', self.listener.get_disk_quota, priority=40)",
            "        self.listener.get_disk_usage.return_value = 0",
            "        cherrypy.engine.subscribe('get_disk_usage', self.listener.get_disk_usage, priority=40)",
            "        self.listener.set_disk_quota.side_effect = self._store_quota",
            "        cherrypy.engine.subscribe('set_disk_quota', self.listener.set_disk_quota, priority=40)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        cherrypy.engine.unsubscribe('get_disk_quota', self.listener.get_disk_quota)",
            "        cherrypy.engine.unsubscribe('get_disk_usage', self.listener.get_disk_usage)",
            "        cherrypy.engine.unsubscribe('set_disk_quota', self.listener.set_disk_quota)",
            "        return super().tearDown()",
            "",
            "    def _store_quota(self, userobj, value):",
            "        self._quota[userobj.username] = value",
            "",
            "    def _load_quota(self, userobj):",
            "        return self._quota.get(userobj.username, 0)",
            "",
            "    def _add_user(self, username=None, email=None, password=None, user_root=None, role=None, mfa=None, fullname=None):",
            "        b = {}",
            "        b['action'] = 'add'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        if fullname is not None:",
            "            b['fullname'] = str(fullname)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _edit_user(",
            "        self, username=None, email=None, password=None, user_root=None, role=None, disk_quota=None, mfa=None",
            "    ):",
            "        b = {}",
            "        b['action'] = 'edit'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if disk_quota is not None:",
            "            b['disk_quota'] = disk_quota",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _delete_user(self, username='test1'):",
            "        b = {'action': 'delete', 'username': username}",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def test_add_user_with_role_admin(self):",
            "        # When trying to create a new user with role admin",
            "        self._add_user(\"admin_role\", \"admin_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.ADMIN_ROLE)",
            "        # Then page return success",
            "        self.assertStatus(200)",
            "        # Then database is updated",
            "        userobj = UserObject.get_user('admin_role')",
            "        self.assertEqual(UserObject.ADMIN_ROLE, userobj.role)",
            "        # Then notification was raised",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_with_role_maintainer(self):",
            "        self._add_user(\"maintainer_role\", \"maintainer_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.MAINTAINER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.MAINTAINER_ROLE, UserObject.get_user('maintainer_role').role)",
            "",
            "    def test_add_user_with_role_user(self):",
            "        self._add_user(\"user_role\", \"user_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.USER_ROLE, UserObject.get_user('user_role').role)",
            "",
            "    def test_add_user_with_invalid_role(self):",
            "        # When trying to create a new user with an invalid role (admin instead of 0)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", 'admin')",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('Role: Invalid Choice: could not coerce')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "        # When trying to create a new user with an invalid role (-1)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", -1)",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('User Role: Not a valid choice')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_edit_delete(self):",
            "        #  Add user to be listed",
            "        self.listener.user_password_changed.reset_mock()",
            "        self._add_user(",
            "            \"test2\", \"test2@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE, mfa=UserObject.DISABLED_MFA",
            "        )",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"test2@test.com\")",
            "        self.listener.user_added.assert_called_once()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.listener.user_password_changed.reset_mock()",
            "        #  Update user",
            "        self._edit_user(",
            "            \"test2\", \"chaned@test.com\", \"new-password\", \"/tmp/\", UserObject.ADMIN_ROLE, mfa=UserObject.ENABLED_MFA",
            "        )",
            "        self.listener.user_attr_changed.assert_called()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"chaned@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "",
            "        self._delete_user(\"test2\")",
            "        self.listener.user_deleted.assert_called()",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"test2\")",
            "",
            "    def test_edit_fullname(self):",
            "        # Given an existing user",
            "        # When updating the user's fullname",
            "        self.getPage(",
            "            \"/admin/users/\",",
            "            method='POST',",
            "            body={'action': 'edit', 'username': self.USERNAME, 'fullname': 'My fullname'},",
            "        )",
            "        self.assertStatus(200)",
            "        # Then user is updated successfully",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        # Then database is updated",
            "        obj = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual('My fullname', obj.fullname)",
            "",
            "    def test_add_edit_delete_user_with_encoding(self):",
            "        \"\"\"",
            "        Check creation of user with non-ascii char.",
            "        \"\"\"",
            "        self._add_user(\"\u00c9ric\", \"\u00e9ric@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "        self.assertInBody(\"\u00e9ric@test.com\")",
            "        # Update user",
            "        self._edit_user(\"\u00c9ric\", \"eric.l\u00e9tourno@test.com\", \"\u00e9cureuil\", \"/tmp/\", UserObject.ADMIN_ROLE)",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "        self.assertInBody(\"eric.l\u00e9tourno@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "",
            "        self._delete_user(\"\u00c9ric\")",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"\u00c9ric\")",
            "",
            "    def test_add_user_with_empty_username(self):",
            "        \"\"\"",
            "        Verify failure trying to create user without username.",
            "        \"\"\"",
            "        self._add_user(\"\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username: This field is required.\")",
            "",
            "    def test_add_user_with_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to add the same user.",
            "        \"\"\"",
            "        # Given a user named `test1`",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # When trying to create a new user with the same name",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message.",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User test1 already exists.\")",
            "",
            "    def test_add_user_with_invalid_root_directory(self):",
            "        \"\"\"",
            "        Verify failure to add a user with invalid root directory.",
            "        \"\"\"",
            "        try:",
            "            self._delete_user(\"test5\")",
            "        except Exception:",
            "            pass",
            "        self._add_user(\"test5\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_add_without_email(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "    def test_add_without_user_root(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test6\", None, \"pr3j5Dwi\", None, UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "        user = UserObject.get_user('test6')",
            "        self.assertEqual('', user.user_root)",
            "",
            "    def test_add_with_username_too_long(self):",
            "        # Given a too long username",
            "        username = \"test2\" * 52",
            "        # When trying to create the user",
            "        self._add_user(username, None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username too long.\")",
            "",
            "    def test_add_with_email_too_long(self):",
            "        # Given a too long username",
            "        email = (\"test2\" * 50) + \"@test.com\"",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", email, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_add_with_user_root_too_long(self):",
            "        # Given a too long user root",
            "        user_root = \"/temp/\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", user_root, UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Root directory too long.\")",
            "",
            "    def test_add_with_fullname_too_long(self):",
            "        # Given a too long user root",
            "        fullname = \"fullname\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE, fullname=fullname)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Fullname too long.\")",
            "",
            "    def test_delete_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure to delete invalid username.",
            "        \"\"\"",
            "        self._delete_user(\"test3\")",
            "        self.assertInBody(\"User doesn&#39;t exists!\")",
            "",
            "    def test_delete_our_self(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        self._delete_user(self.USERNAME)",
            "        self.assertInBody(\"You cannot remove your own account!\")",
            "",
            "    def test_delete_user_admin(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        # Create another admin user",
            "        self._add_user('admin2', '', 'pr3j5Dwi', '', UserObject.ADMIN_ROLE)",
            "        self.getPage(\"/logout\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        self._login('admin2', 'pr3j5Dwi')",
            "",
            "        # Try deleting admin user",
            "        self._delete_user(self.USERNAME)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"can&#39;t delete admin user\")",
            "",
            "    def test_delete_user_method_get(self):",
            "        # Given a user",
            "        UserObject.add_user('newuser')",
            "        # When trying to delete this user using method GET",
            "        self.getPage(\"/admin/users/?action=delete&username=newuser\", method='GET')",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then user is not deleted",
            "        self.assertIsNotNone(UserObject.get_user('newuser'))",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._edit_user(self.USERNAME, password='short')",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._edit_user(self.USERNAME, password=new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_admin_password(self):",
            "        # Given rdiffweb is configured with admin-password option",
            "        self.app.cfg.admin_password = 'hardcoded'",
            "        try:",
            "            # When trying to update admin password",
            "            self._edit_user('admin', password='new-password')",
            "            # Then the form is refused with 200 OK with an error message.",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"can&#39;t update admin-password defined in configuration file\")",
            "        finally:",
            "            self.app.cfg.admin_password = None",
            "",
            "    def test_edit_user_with_invalid_path(self):",
            "        \"\"\"",
            "        Verify failure trying to update user with invalid path.",
            "        \"\"\"",
            "        UserObject.add_user('test1')",
            "        self._edit_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertNotInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_list(self):",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertInBody(\"Users\")",
            "        self.assertInBody(\"User management\")",
            "        self.assertInBody(\"Add user\")",
            "",
            "    def test_edit_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to update invalid user.",
            "        \"\"\"",
            "        # Given an invalid username",
            "        username = 'invalid'",
            "        # When trying to edit the user",
            "        self._edit_user(username, \"test1@test.com\", \"test\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit user `invalid`: user doesn&#39;t exists\")",
            "",
            "    def test_user_invalid_root(self):",
            "        # Delete all user's",
            "        for user in UserObject.query.all():",
            "            if user.username != self.USERNAME:",
            "                user.delete()",
            "        # Change the user's root",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/invalid\"",
            "        user.add()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertInBody(\"Root directory not accessible!\")",
            "",
            "        # Query the page by default",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/tmp/\"",
            "        user.add()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertNotInBody(\"Root directory not accessible!\")",
            "",
            "    def test_get_quota(self):",
            "        # Mock a quota.",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 654321",
            "        # When querying the user list",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertStatus(200)",
            "        # Then get_disk_quota listenre is called",
            "        self.listener.get_disk_quota.assert_called()",
            "        # Then the quota value is displayed in human readable format",
            "        self.assertInBody(\"638.99 KiB\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota(self):",
            "        # When updating user quota.",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then listenr get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_gib(self):",
            "        # When updating user quota",
            "        self._edit_user(\"admin\", disk_quota='1GiB')",
            "        # Then listern get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1073741824)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_comma(self):",
            "        # When updating quota with comma value",
            "        self._edit_user(\"admin\", disk_quota='1,5 GiB')",
            "        # Then listner get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1610612736)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_leading_dot(self):",
            "        # When updating quota with leading dot",
            "        self._edit_user(\"admin\", disk_quota='.5 GiB')",
            "        # Then listener get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 536870912)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_empty(self):",
            "        # When quota is not defined",
            "        self._edit_user(\"admin\", disk_quota='')",
            "        # Then listener is not called.",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_same_value(self):",
            "        # Given an exiting quota",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 1234567890",
            "        # When setting the quota value to the same value",
            "        self._edit_user(\"admin\", disk_quota='1.15 GiB')",
            "        #  Then listener is not called",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_unsupported(self):",
            "        # Given setting quota is not supported",
            "        self.listener.set_disk_quota.side_effect = None",
            "        self.listener.set_disk_quota.return_value = None",
            "        # When updating the quota",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        self.assertInBody(\"Setting user&#39;s quota is not supported\")",
            "        self.assertStatus(200)",
            "",
            "    def test_edit_own_role(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, role=UserObject.MAINTAINER_ROLE)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit your own role.\")",
            "",
            "    def test_edit_own_mfa(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, mfa=UserObject.ENABLED_MFA)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot change your own two-factor authentication settings.\")"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "from unittest.mock import ANY, MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class AbstractAdminTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self._quota = {}",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        self.listener.get_disk_quota.side_effect = self._load_quota",
            "        cherrypy.engine.subscribe('get_disk_quota', self.listener.get_disk_quota, priority=40)",
            "        self.listener.get_disk_usage.return_value = 0",
            "        cherrypy.engine.subscribe('get_disk_usage', self.listener.get_disk_usage, priority=40)",
            "        self.listener.set_disk_quota.side_effect = self._store_quota",
            "        cherrypy.engine.subscribe('set_disk_quota', self.listener.set_disk_quota, priority=40)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        cherrypy.engine.unsubscribe('get_disk_quota', self.listener.get_disk_quota)",
            "        cherrypy.engine.unsubscribe('get_disk_usage', self.listener.get_disk_usage)",
            "        cherrypy.engine.unsubscribe('set_disk_quota', self.listener.set_disk_quota)",
            "        return super().tearDown()",
            "",
            "    def _store_quota(self, userobj, value):",
            "        self._quota[userobj.username] = value",
            "",
            "    def _load_quota(self, userobj):",
            "        return self._quota.get(userobj.username, 0)",
            "",
            "    def _add_user(self, username=None, email=None, password=None, user_root=None, role=None, mfa=None, fullname=None):",
            "        b = {}",
            "        b['action'] = 'add'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        if fullname is not None:",
            "            b['fullname'] = str(fullname)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _edit_user(",
            "        self, username=None, email=None, password=None, user_root=None, role=None, disk_quota=None, mfa=None",
            "    ):",
            "        b = {}",
            "        b['action'] = 'edit'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if disk_quota is not None:",
            "            b['disk_quota'] = disk_quota",
            "        if mfa is not None:",
            "            b['mfa'] = str(mfa)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _delete_user(self, username='test1'):",
            "        b = {'action': 'delete', 'username': username}",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def test_add_user_with_role_admin(self):",
            "        # When trying to create a new user with role admin",
            "        self._add_user(\"admin_role\", \"admin_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.ADMIN_ROLE)",
            "        # Then page return success",
            "        self.assertStatus(200)",
            "        # Then database is updated",
            "        userobj = UserObject.get_user('admin_role')",
            "        self.assertEqual(UserObject.ADMIN_ROLE, userobj.role)",
            "        # Then notification was raised",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_with_role_maintainer(self):",
            "        self._add_user(\"maintainer_role\", \"maintainer_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.MAINTAINER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.MAINTAINER_ROLE, UserObject.get_user('maintainer_role').role)",
            "",
            "    def test_add_user_with_role_user(self):",
            "        self._add_user(\"user_role\", \"user_role@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(UserObject.USER_ROLE, UserObject.get_user('user_role').role)",
            "",
            "    def test_add_user_with_invalid_role(self):",
            "        # When trying to create a new user with an invalid role (admin instead of 0)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", 'admin')",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('Role: Invalid Choice: could not coerce')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "        # When trying to create a new user with an invalid role (-1)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"pr3j5Dwi\", \"/home/\", -1)",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('User Role: Not a valid choice')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_edit_delete(self):",
            "        #  Add user to be listed",
            "        self.listener.user_password_changed.reset_mock()",
            "        self._add_user(",
            "            \"test2\", \"test2@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE, mfa=UserObject.DISABLED_MFA",
            "        )",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"test2@test.com\")",
            "        self.listener.user_added.assert_called_once()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.listener.user_password_changed.reset_mock()",
            "        #  Update user",
            "        self._edit_user(",
            "            \"test2\", \"chaned@test.com\", \"new-password\", \"/tmp/\", UserObject.ADMIN_ROLE, mfa=UserObject.ENABLED_MFA",
            "        )",
            "        self.listener.user_attr_changed.assert_called()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"chaned@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "",
            "        self._delete_user(\"test2\")",
            "        self.listener.user_deleted.assert_called()",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"test2\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('evil.com', False),",
            "            ('http://test', False),",
            "            ('email@test.test', False),",
            "            ('/test/', False),",
            "            # Valid",
            "            ('My fullname', True),",
            "            ('Test Test', True),",
            "            ('\u00c9ric Terrien-Pascal', True),",
            "            (\"Tel'c\", True),",
            "        ]",
            "    )",
            "    def test_edit_fullname_with_special_character(self, new_fullname, expected_valid):",
            "        # Given an existing user",
            "        # When updating the user's fullname",
            "        self.getPage(",
            "            \"/admin/users/\",",
            "            method='POST',",
            "            body={'action': 'edit', 'username': self.USERNAME, 'fullname': new_fullname},",
            "        )",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"User information modified successfully.\")",
            "            self.assertNotInBody(\"Fullname: Must not contain any special characters.\")",
            "        else:",
            "            self.assertNotInBody(\"User information modified successfully.\")",
            "            self.assertInBody(\"Fullname: Must not contain any special characters.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('http://username', False),",
            "            ('username@test.test', False),",
            "            ('/username/', False),",
            "            # Valid",
            "            ('username.com', True),",
            "            ('admin_user', True),",
            "            ('test.test', True),",
            "            ('test-test', True),",
            "        ]",
            "    )",
            "    def test_add_user_with_special_character(self, new_username, expected_valid):",
            "        self._add_user(new_username, \"eric@test.com\", \"pr3j5Dwi\", \"/home/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"User added successfully.\")",
            "            self.assertNotInBody(\"Username: Must not contain any special characters.\")",
            "        else:",
            "            self.assertNotInBody(\"User added successfully.\")",
            "            self.assertInBody(\"Username: Must not contain any special characters.\")",
            "",
            "    def test_add_user_with_empty_username(self):",
            "        \"\"\"",
            "        Verify failure trying to create user without username.",
            "        \"\"\"",
            "        self._add_user(\"\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username: This field is required.\")",
            "",
            "    def test_add_user_with_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to add the same user.",
            "        \"\"\"",
            "        # Given a user named `test1`",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # When trying to create a new user with the same name",
            "        self._add_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message.",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User test1 already exists.\")",
            "",
            "    def test_add_user_with_invalid_root_directory(self):",
            "        \"\"\"",
            "        Verify failure to add a user with invalid root directory.",
            "        \"\"\"",
            "        try:",
            "            self._delete_user(\"test5\")",
            "        except Exception:",
            "            pass",
            "        self._add_user(\"test5\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_add_without_email(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "    def test_add_without_user_root(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test6\", None, \"pr3j5Dwi\", None, UserObject.USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "        user = UserObject.get_user('test6')",
            "        self.assertEqual('', user.user_root)",
            "",
            "    def test_add_with_username_too_long(self):",
            "        # Given a too long username",
            "        username = \"test2\" * 52",
            "        # When trying to create the user",
            "        self._add_user(username, None, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username too long.\")",
            "",
            "    def test_add_with_email_too_long(self):",
            "        # Given a too long username",
            "        email = (\"test2\" * 50) + \"@test.com\"",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", email, \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_add_with_user_root_too_long(self):",
            "        # Given a too long user root",
            "        user_root = \"/temp/\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", user_root, UserObject.USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Root directory too long.\")",
            "",
            "    def test_add_with_fullname_too_long(self):",
            "        # Given a too long user root",
            "        fullname = \"fullname\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"pr3j5Dwi\", \"/tmp/\", UserObject.USER_ROLE, fullname=fullname)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Fullname too long.\")",
            "",
            "    def test_delete_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure to delete invalid username.",
            "        \"\"\"",
            "        self._delete_user(\"test3\")",
            "        self.assertInBody(\"User doesn&#39;t exists!\")",
            "",
            "    def test_delete_our_self(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        self._delete_user(self.USERNAME)",
            "        self.assertInBody(\"You cannot remove your own account!\")",
            "",
            "    def test_delete_user_admin(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        # Create another admin user",
            "        self._add_user('admin2', '', 'pr3j5Dwi', '', UserObject.ADMIN_ROLE)",
            "        self.getPage(\"/logout\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        self._login('admin2', 'pr3j5Dwi')",
            "",
            "        # Try deleting admin user",
            "        self._delete_user(self.USERNAME)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"can&#39;t delete admin user\")",
            "",
            "    def test_delete_user_method_get(self):",
            "        # Given a user",
            "        UserObject.add_user('newuser')",
            "        # When trying to delete this user using method GET",
            "        self.getPage(\"/admin/users/?action=delete&username=newuser\", method='GET')",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then user is not deleted",
            "        self.assertIsNotNone(UserObject.get_user('newuser'))",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._edit_user(self.USERNAME, password='short')",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._edit_user(self.USERNAME, password=new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_admin_password(self):",
            "        # Given rdiffweb is configured with admin-password option",
            "        self.app.cfg.admin_password = 'hardcoded'",
            "        try:",
            "            # When trying to update admin password",
            "            self._edit_user('admin', password='new-password')",
            "            # Then the form is refused with 200 OK with an error message.",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"can&#39;t update admin-password defined in configuration file\")",
            "        finally:",
            "            self.app.cfg.admin_password = None",
            "",
            "    def test_edit_user_with_invalid_path(self):",
            "        \"\"\"",
            "        Verify failure trying to update user with invalid path.",
            "        \"\"\"",
            "        UserObject.add_user('test1')",
            "        self._edit_user(\"test1\", \"test1@test.com\", \"pr3j5Dwi\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        self.assertNotInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_list(self):",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertInBody(\"Users\")",
            "        self.assertInBody(\"User management\")",
            "        self.assertInBody(\"Add user\")",
            "",
            "    def test_edit_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to update invalid user.",
            "        \"\"\"",
            "        # Given an invalid username",
            "        username = 'invalid'",
            "        # When trying to edit the user",
            "        self._edit_user(username, \"test1@test.com\", \"test\", \"/var/invalid/\", UserObject.USER_ROLE)",
            "        # Then the user list is displayed with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit user `invalid`: user doesn&#39;t exists\")",
            "",
            "    def test_user_invalid_root(self):",
            "        # Delete all user's",
            "        for user in UserObject.query.all():",
            "            if user.username != self.USERNAME:",
            "                user.delete()",
            "        # Change the user's root",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/invalid\"",
            "        user.add()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertInBody(\"Root directory not accessible!\")",
            "",
            "        # Query the page by default",
            "        user = UserObject.get_user('admin')",
            "        user.user_root = \"/tmp/\"",
            "        user.add()",
            "        self.getPage(\"/admin/users\")",
            "        self.assertNotInBody(\"Root directory not accessible!\")",
            "",
            "    def test_get_quota(self):",
            "        # Mock a quota.",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 654321",
            "        # When querying the user list",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertStatus(200)",
            "        # Then get_disk_quota listenre is called",
            "        self.listener.get_disk_quota.assert_called()",
            "        # Then the quota value is displayed in human readable format",
            "        self.assertInBody(\"638.99 KiB\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota(self):",
            "        # When updating user quota.",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then listenr get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_gib(self):",
            "        # When updating user quota",
            "        self._edit_user(\"admin\", disk_quota='1GiB')",
            "        # Then listern get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1073741824)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_comma(self):",
            "        # When updating quota with comma value",
            "        self._edit_user(\"admin\", disk_quota='1,5 GiB')",
            "        # Then listner get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1610612736)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_leading_dot(self):",
            "        # When updating quota with leading dot",
            "        self._edit_user(\"admin\", disk_quota='.5 GiB')",
            "        # Then listener get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 536870912)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_empty(self):",
            "        # When quota is not defined",
            "        self._edit_user(\"admin\", disk_quota='')",
            "        # Then listener is not called.",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_same_value(self):",
            "        # Given an exiting quota",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 1234567890",
            "        # When setting the quota value to the same value",
            "        self._edit_user(\"admin\", disk_quota='1.15 GiB')",
            "        #  Then listener is not called",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_unsupported(self):",
            "        # Given setting quota is not supported",
            "        self.listener.set_disk_quota.side_effect = None",
            "        self.listener.set_disk_quota.return_value = None",
            "        # When updating the quota",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        self.assertInBody(\"Setting user&#39;s quota is not supported\")",
            "        self.assertStatus(200)",
            "",
            "    def test_edit_own_role(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, role=UserObject.MAINTAINER_ROLE)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit your own role.\")",
            "",
            "    def test_edit_own_mfa(self):",
            "        # Given an administrator",
            "        # When trygin to update your own role",
            "        self._edit_user(username=self.USERNAME, mfa=UserObject.ENABLED_MFA)",
            "        # Then an error is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot change your own two-factor authentication settings.\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "173": [
                "AbstractAdminTest",
                "test_edit_fullname"
            ],
            "179": [
                "AbstractAdminTest",
                "test_edit_fullname"
            ],
            "182": [
                "AbstractAdminTest",
                "test_edit_fullname"
            ],
            "183": [
                "AbstractAdminTest",
                "test_edit_fullname"
            ],
            "184": [
                "AbstractAdminTest",
                "test_edit_fullname"
            ],
            "185": [
                "AbstractAdminTest",
                "test_edit_fullname"
            ],
            "186": [
                "AbstractAdminTest",
                "test_edit_fullname"
            ],
            "187": [
                "AbstractAdminTest"
            ],
            "188": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "189": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "190": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "191": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "192": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "193": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "194": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "195": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "196": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "197": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "198": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "199": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "200": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "201": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "202": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "203": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "204": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "205": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ],
            "206": [
                "AbstractAdminTest",
                "test_add_edit_delete_user_with_encoding"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_prefs_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " from unittest.mock import MagicMock"
            },
            "1": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " import cherrypy"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+from parameterized import parameterized"
            },
            "4": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 28,
                "PatchRowcode": " import rdiffweb.test"
            },
            "6": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " from rdiffweb.core.model import RepoObject, UserObject"
            },
            "7": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "         self.assertIsNotNone(user)"
            },
            "8": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 90,
                "PatchRowcode": "         self.assertEqual(\"test@test.com\", user.email)"
            },
            "9": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 91,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_change_fullname(self):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+    @parameterized.expand("
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        ["
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+            # Invalid"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+            ('@test.com', False),"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+            ('test.com', False),"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+            ('test@te_st.com', False),"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+            ('test@test.com, test2@test.com', False),"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+            # Valid"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+            ('test', True),"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+            ('My Fullname', True),"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+        ]"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+    )"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+    def test_change_fullname(self, new_fullname, expected_valid):"
            },
            "24": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "         # Given an authenticated user"
            },
            "25": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "         # When update the fullname"
            },
            "26": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._set_profile_info(\"test@test.com\", \"My Fullname\")"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+        self._set_profile_info(\"test@test.com\", new_fullname)"
            },
            "28": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 108,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "29": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Profile updated successfully.\")"
            },
            "30": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then database is updated with fullname"
            },
            "31": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"My Fullname\")"
            },
            "32": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()"
            },
            "33": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertEqual(\"My Fullname\", user.fullname)"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+        if expected_valid:"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+            self.assertInBody(\"Profile updated successfully.\")"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+            # Then database is updated with fullname"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+            self.assertInBody(new_fullname)"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+            self.assertEqual(new_fullname, user.fullname)"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+        else:"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+            self.assertNotInBody(\"Profile updated successfully.\")"
            },
            "42": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 117,
                "PatchRowcode": " "
            },
            "43": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 118,
                "PatchRowcode": "     def test_change_fullname_method_get(self):"
            },
            "44": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 119,
                "PatchRowcode": "         # Given an authenticated user"
            },
            "45": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 142,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "46": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": 143,
                "PatchRowcode": "         self.assertInBody(\"Profile updated successfully.\")"
            },
            "47": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 144,
                "PatchRowcode": " "
            },
            "48": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_change_email_with_invalid_email(self):"
            },
            "49": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._set_profile_info(\"@test.com\")"
            },
            "50": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "51": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Invalid email\")"
            },
            "52": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "53": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._set_profile_info(\"test.com\")"
            },
            "54": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "55": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Invalid email\")"
            },
            "56": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "57": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._set_profile_info(\"test\")"
            },
            "58": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "59": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Invalid email\")"
            },
            "60": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "61": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._set_profile_info(\"test@te_st.com\")"
            },
            "62": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "63": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Invalid email\")"
            },
            "64": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "65": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._set_profile_info(\"test@test.com, test2@test.com\")"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+    @parameterized.expand("
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+        ["
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 147,
                "PatchRowcode": "+            # Invalid"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 148,
                "PatchRowcode": "+            ('@test.com', False),"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 149,
                "PatchRowcode": "+            ('test.com', False),"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+            ('test', False),"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 151,
                "PatchRowcode": "+            ('test@te_st.com', False),"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+            ('test@test.com, test2@test.com', False),"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+            # Valid"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+            ('test@test.com', True),"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+        ]"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+    )"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+    def test_change_email_with_invalid_email(self, new_email, expected_valid):"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+        self._set_profile_info(new_email)"
            },
            "80": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 159,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "81": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Invalid email\")"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 160,
                "PatchRowcode": "+        if expected_valid:"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+            self.assertInBody(\"Profile updated successfully.\")"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+            self.assertNotInBody(\"Must be a valid email address.\")"
            },
            "85": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+        else:"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+            self.assertNotInBody(\"Profile updated successfully.\")"
            },
            "87": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+            self.assertInBody(\"Must be a valid email address.\")"
            },
            "88": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": 166,
                "PatchRowcode": " "
            },
            "89": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "     def test_change_email_with_too_long(self):"
            },
            "90": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 168,
                "PatchRowcode": "         self._set_profile_info((\"test1\" * 50) + \"@test.com\")"
            },
            "91": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertInBody(\"Invalid email\")"
            },
            "92": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 169,
                "PatchRowcode": "+        self.assertInBody(\"Email too long.\")"
            },
            "93": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": 170,
                "PatchRowcode": " "
            },
            "94": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "     def test_change_password(self):"
            },
            "95": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": 172,
                "PatchRowcode": "         self.listener.user_password_changed.reset_mock()"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    def test_change_fullname(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"My Fullname\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        self.assertInBody(\"My Fullname\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"My Fullname\", user.fullname)",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_email_with_invalid_email(self):",
            "        self._set_profile_info(\"@test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test@te_st.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test@test.com, test2@test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test', True),",
            "            ('My Fullname', True),",
            "        ]",
            "    )",
            "    def test_change_fullname(self, new_fullname, expected_valid):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", new_fullname)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            # Then database is updated with fullname",
            "            self.assertInBody(new_fullname)",
            "            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "            self.assertEqual(new_fullname, user.fullname)",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test@test.com', True),",
            "        ]",
            "    )",
            "    def test_change_email_with_invalid_email(self, new_email, expected_valid):",
            "        self._set_profile_info(new_email)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            self.assertNotInBody(\"Must be a valid email address.\")",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "            self.assertInBody(\"Must be a valid email address.\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "91": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "94": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "96": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "97": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "98": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "99": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "100": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "129": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "130": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "131": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "132": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "133": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "134": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "135": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "136": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "137": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "138": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "139": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "140": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "141": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "142": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "143": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "144": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "145": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "146": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "148": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ],
            "152": [
                "PagePrefGeneralTest",
                "test_change_email_with_too_long"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/model/_user.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "     __tablename__ = 'users'"
            },
            "1": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "     __table_args__ = {'sqlite_autoincrement': True}"
            },
            "2": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 57,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+    # Value for role."
            },
            "4": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 59,
                "PatchRowcode": "     ADMIN_ROLE = 0"
            },
            "5": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "     MAINTAINER_ROLE = 5"
            },
            "6": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "     USER_ROLE = 10"
            },
            "7": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "         'maintainer': MAINTAINER_ROLE,"
            },
            "8": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "         'user': USER_ROLE,"
            },
            "9": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "     }"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+    # Value for mfa field"
            },
            "11": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "     DISABLED_MFA = 0"
            },
            "12": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "     ENABLED_MFA = 1"
            },
            "13": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 70,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+    # Regex pattern to be used for validation."
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+    PATTERN_EMAIL = r\"[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$\""
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+    PATTERN_FULLNAME = r\"\"\"[^!\"#$%&()*+,./:;<=>?@[\\]_{|}~]+$\"\"\""
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+    PATTERN_USERNAME = r\"[a-zA-Z0-9_.\\-]+$\""
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+"
            },
            "19": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "     userid = Column('UserID', Integer, primary_key=True)"
            },
            "20": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "     _username = Column('Username', String, nullable=False, unique=True)"
            },
            "21": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "     hash_password = Column('Password', String, nullable=False, default=\"\")"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import datetime",
            "import logging",
            "import os",
            "import secrets",
            "import string",
            "",
            "import cherrypy",
            "from sqlalchemy import Column, Integer, SmallInteger, String, and_, event, inspect, or_",
            "from sqlalchemy.exc import IntegrityError",
            "from sqlalchemy.ext.hybrid import hybrid_property",
            "from sqlalchemy.orm import deferred, relationship",
            "from zxcvbn import zxcvbn",
            "",
            "import rdiffweb.tools.db  # noqa",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.passwd import check_password, hash_password",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "from ._repo import RepoObject",
            "from ._sshkey import SshKey",
            "from ._token import Token",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "Base = cherrypy.tools.db.get_base()",
            "",
            "SEP = b'/'",
            "",
            "",
            "class DuplicateSSHKeyError(Exception):",
            "    \"\"\"",
            "    Raised by add_authorizedkey when trying to add the same SSH Key twice.",
            "    \"\"\"",
            "",
            "    pass",
            "",
            "",
            "class UserObject(Base):",
            "    __tablename__ = 'users'",
            "    __table_args__ = {'sqlite_autoincrement': True}",
            "",
            "    ADMIN_ROLE = 0",
            "    MAINTAINER_ROLE = 5",
            "    USER_ROLE = 10",
            "    ROLES = {",
            "        'admin': ADMIN_ROLE,",
            "        'maintainer': MAINTAINER_ROLE,",
            "        'user': USER_ROLE,",
            "    }",
            "    DISABLED_MFA = 0",
            "    ENABLED_MFA = 1",
            "",
            "    userid = Column('UserID', Integer, primary_key=True)",
            "    _username = Column('Username', String, nullable=False, unique=True)",
            "    hash_password = Column('Password', String, nullable=False, default=\"\")",
            "    _user_root = Column('UserRoot', String, nullable=False, default=\"\")",
            "    _is_admin = deferred(",
            "        Column(",
            "            'IsAdmin',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"0\",",
            "            doc=\"DEPRECATED This column is replaced by 'role'\",",
            "        )",
            "    )",
            "    _email = Column('UserEmail', String, nullable=False, default=\"\")",
            "    restore_format = deferred(",
            "        Column(",
            "            'RestoreFormat',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"1\",",
            "            doc=\"DEPRECATED This column is not used anymore\",",
            "        )",
            "    )",
            "    _role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE))",
            "    fullname = Column('fullname', String, nullable=False, default=\"\")",
            "    mfa = Column('mfa', SmallInteger, nullable=False, default=DISABLED_MFA)",
            "    repo_objs = relationship(",
            "        'RepoObject',",
            "        foreign_keys='UserObject.userid',",
            "        primaryjoin='UserObject.userid == RepoObject.userid',",
            "        uselist=True,",
            "        lazy=True,",
            "        order_by=lambda: RepoObject.repopath,",
            "    )",
            "",
            "    @classmethod",
            "    def get_user(cls, user):",
            "        \"\"\"Return a user object.\"\"\"",
            "        return UserObject.query.filter(UserObject.username == user).first()",
            "",
            "    @classmethod",
            "    def create_admin_user(cls, default_username, default_password):",
            "        # Check if admin user exists. If not, created it.",
            "        userobj = UserObject.get_user(default_username)",
            "        if not userobj:",
            "            userobj = cls.add_user(default_username, role=UserObject.ADMIN_ROLE, user_root='/backups')",
            "        # Also make sure to update the password with latest value from config file.",
            "        if default_password and default_password.startswith('{SSHA}'):",
            "            userobj.hash_password = default_password",
            "        elif default_password:",
            "            userobj.hash_password = hash_password(default_password)",
            "        else:",
            "            userobj.hash_password = hash_password('admin123')",
            "        userobj.add()",
            "",
            "    @classmethod",
            "    def add_user(cls, username, password=None, **attrs):",
            "        \"\"\"",
            "        Used to add a new user with an optional password.",
            "        \"\"\"",
            "        assert password is None or isinstance(password, str)",
            "        # Check if user already exists.",
            "        if UserObject.get_user(username):",
            "            raise ValueError(_(\"User %s already exists.\" % (username,)))",
            "",
            "        # Find a database where to add the user",
            "        logger.info(\"adding new user [%s]\", username)",
            "        userobj = UserObject(",
            "            username=username,",
            "            hash_password=hash_password(password) if password else '',",
            "            **attrs,",
            "        ).add()",
            "        # Raise event",
            "        cherrypy.engine.publish('user_added', userobj)",
            "        # Return user object",
            "        return userobj",
            "",
            "    def add_authorizedkey(self, key, comment=None):",
            "        \"\"\"",
            "        Add the given key to the user. Adding the key to his `authorized_keys`",
            "        file if it exists and adding it to database.",
            "        \"\"\"",
            "        # Parse and validate ssh key",
            "        assert key",
            "        key = authorizedkeys.check_publickey(key)",
            "",
            "        # Remove option, replace comments.",
            "        key = authorizedkeys.AuthorizedKey(",
            "            options=None, keytype=key.keytype, key=key.key, comment=comment or key.comment",
            "        )",
            "",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode=\"r+\", encoding='utf-8') as fh:",
            "                if authorizedkeys.exists(fh, key):",
            "                    raise DuplicateSSHKeyError(_(\"SSH key already exists\"))",
            "                logger.info(\"add key [%s] to [%s] authorized_keys\", key, self.username)",
            "                authorizedkeys.add(fh, key)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"add key [%s] to [%s] database\", key, self.username)",
            "            try:",
            "                SshKey(userid=self.userid, fingerprint=key.fingerprint, key=key.getvalue()).add()",
            "            except IntegrityError:",
            "                SshKey.session.rollback()",
            "                raise DuplicateSSHKeyError(",
            "                    _(\"Duplicate key. This key already exists or is associated to another user.\")",
            "                )",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def add_access_token(self, name, expiration_time=None, length=16):",
            "        \"\"\"",
            "        Create a new access token. Return the un-encrypted value of the token.",
            "        \"\"\"",
            "        assert name",
            "        assert length >= 8",
            "        # Generate a random token",
            "        token = ''.join(secrets.choice(string.ascii_lowercase) for i in range(length))",
            "        # Store hash token",
            "        try:",
            "            obj = Token(userid=self.userid, name=name, hash_token=hash_password(token), expiration_time=expiration_time)",
            "            obj.add()",
            "        except IntegrityError:",
            "            Token.session.rollback()",
            "            raise ValueError(_(\"Duplicate token name: %s\") % name)",
            "        cherrypy.engine.publish('access_token_added', self, name)",
            "        return token",
            "",
            "    def valid_user_root(self):",
            "        \"\"\"",
            "        Check if the current user_root is valid and readable",
            "        \"\"\"",
            "        try:",
            "            return os.access(self.user_root, os.F_OK) and os.path.isdir(self.user_root)",
            "        except Exception:",
            "            return False",
            "",
            "    def delete(self, *args, **kwargs):",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "        if self.username == cfg.admin_user:",
            "            raise ValueError(_(\"can't delete admin user\"))",
            "        # FIXME This should be deleted by cascade",
            "        SshKey.query.filter(SshKey.userid == self.userid).delete()",
            "        RepoObject.query.filter(RepoObject.userid == self.userid).delete()",
            "        Token.query.filter(Token.userid == self.userid).delete()",
            "        # Delete ourself",
            "        Base.delete(self)",
            "",
            "    def delete_authorizedkey(self, fingerprint):",
            "        \"\"\"",
            "        Remove the given key from the user. Remove the key from his",
            "        `authorized_keys` file if it exists and from database database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode='r+', encoding='utf-8') as fh:",
            "                logger.info(\"removing key [%s] from [%s] authorized_keys\", fingerprint, self.username)",
            "                authorizedkeys.remove(fh, fingerprint)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"removing key [%s] from [%s] database\", fingerprint, self.username)",
            "            SshKey.query.filter(and_(SshKey.userid == self.userid, SshKey.fingerprint == fingerprint)).delete()",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def delete_access_token(self, name):",
            "        assert name",
            "        if not Token.query.filter(Token.userid == self.userid, Token.name == name).delete():",
            "            raise ValueError(_(\"token name doesn't exists: %s\") % name)",
            "",
            "    @property",
            "    def disk_usage(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_usage', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @property",
            "    def disk_quota(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_quota', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @disk_quota.setter",
            "    def disk_quota(self, value):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return",
            "        cherrypy.engine.publish('set_disk_quota', self, value)",
            "",
            "    @property",
            "    def authorizedkeys(self):",
            "        \"\"\"",
            "        Return an iterator on the authorized key. Either from his",
            "        `authorized_keys` file if it exists or from database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            for k in authorizedkeys.read(filename):",
            "                yield k",
            "",
            "        # Also look in database.",
            "        for record in SshKey.query.filter(SshKey.userid == self.userid).all():",
            "            yield authorizedkeys.check_publickey(record.key)",
            "",
            "    def refresh_repos(self, delete=False):",
            "        \"\"\"",
            "        Return list of repositories object to reflect the filesystem folders.",
            "",
            "        Return a RepoObject for each sub directories under `user_root` with `rdiff-backup-data`.",
            "        \"\"\"",
            "        # Update the repositories by walking in the directory tree.",
            "        def _onerror(unused):",
            "            logger.error('error updating user [%s] repos' % self.username, exc_info=1)",
            "",
            "        # Get application config",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        dirty = False",
            "        records = RepoObject.query.filter(RepoObject.userid == self.userid).order_by(RepoObject.repopath).all()",
            "        user_root = os.fsencode(self.user_root)",
            "        for root, dirs, unused_files in os.walk(user_root, _onerror):",
            "            for name in dirs.copy():",
            "                if name.startswith(b'.'):",
            "                    dirs.remove(name)",
            "            if b'rdiff-backup-data' in dirs:",
            "                repopath = os.path.relpath(root, start=user_root)",
            "                del dirs[:]",
            "                # Handle special scenario when the repo is the",
            "                # user_root",
            "                repopath = b'' if repopath == b'.' else repopath",
            "",
            "                # Check if repo path exists.",
            "                record_match = next((record for record in records if record.repopath == os.fsdecode(repopath)), None)",
            "                if not record_match:",
            "                    # Add repository to database.",
            "                    RepoObject(user=self, repopath=os.fsdecode(repopath)).add()",
            "                    dirty = True",
            "                else:",
            "                    records.remove(record_match)",
            "            if root.count(SEP) - user_root.count(SEP) >= cfg.max_depth:",
            "                del dirs[:]",
            "        # If enabled, remove entried from database",
            "        if delete:",
            "            for record in records:",
            "                RepoObject.query.filter(RepoObject.repoid == record.repoid).delete()",
            "        return dirty",
            "",
            "    @hybrid_property",
            "    def is_admin(self):",
            "        return self.role <= self.ADMIN_ROLE",
            "",
            "    @hybrid_property",
            "    def is_ldap(self):",
            "        return self.hash_password is None or self.hash_password == ''",
            "",
            "    @is_ldap.expression",
            "    def is_ldap(cls):",
            "        return or_(cls.hash_password.is_(None), cls.hash_password == '')",
            "",
            "    @hybrid_property",
            "    def is_maintainer(self):",
            "        return self.role <= self.MAINTAINER_ROLE",
            "",
            "    def set_password(self, password, old_password=None):",
            "        \"\"\"",
            "        Change the user's password. Raise a ValueError if the username or",
            "        the password are invalid.",
            "        \"\"\"",
            "        assert isinstance(password, str)",
            "        assert old_password is None or isinstance(old_password, str)",
            "        if not password:",
            "            raise ValueError(\"password can't be empty\")",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        # Cannot update admin-password if defined",
            "        if self.username == cfg.admin_user and cfg.admin_password:",
            "            raise ValueError(_(\"can't update admin-password defined in configuration file\"))",
            "",
            "        if old_password and not check_password(old_password, self.hash_password):",
            "            raise ValueError(_(\"Wrong password\"))",
            "",
            "        # Check password length",
            "        if cfg.password_min_length > len(password) or len(password) > cfg.password_max_length:",
            "            raise ValueError(",
            "                _('Password must have between %(min)d and %(max)d characters.')",
            "                % {'min': cfg.password_min_length, 'max': cfg.password_max_length}",
            "            )",
            "",
            "        # Verify password score using zxcvbn",
            "        stats = zxcvbn(password)",
            "        if stats.get('score') < cfg.password_score:",
            "            msg = _('Password too weak.')",
            "            warning = stats.get('feedback', {}).get('warning')",
            "            suggestions = stats.get('feedback', {}).get('suggestions')",
            "            if warning:",
            "                msg += ' ' + warning",
            "            if suggestions:",
            "                msg += ' ' + ' '.join(suggestions)",
            "            raise ValueError(msg)",
            "",
            "        logger.info(\"updating user password [%s]\", self.username)",
            "        self.hash_password = hash_password(password)",
            "",
            "    def __eq__(self, other):",
            "        return type(self) == type(other) and inspect(self).key == inspect(other).key",
            "",
            "    @hybrid_property",
            "    def username(self):",
            "        return self._username",
            "",
            "    @username.setter",
            "    def username(self, value):",
            "        oldvalue = self._username",
            "        self._username = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'username': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def role(self):",
            "        if self._role is None:",
            "            return self.USER_ROLE",
            "        return self._role",
            "",
            "    @role.setter",
            "    def role(self, value):",
            "        oldvalue = self._role",
            "        self._role = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'role': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def email(self):",
            "        return self._email",
            "",
            "    @email.setter",
            "    def email(self, value):",
            "        oldvalue = self._email",
            "        self._email = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'email': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def user_root(self):",
            "        return self._user_root",
            "",
            "    @user_root.setter",
            "    def user_root(self, value):",
            "        oldvalue = self._user_root",
            "        self._user_root = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'user_root': (oldvalue, value)})",
            "",
            "    def validate_access_token(self, token):",
            "        \"\"\"",
            "        Check if the given token matches.",
            "        \"\"\"",
            "        for access_token in Token.query.all():",
            "            # If token expired. Let delete it.",
            "            if access_token.is_expired:",
            "                access_token.delete()",
            "                continue",
            "            if check_password(token, access_token.hash_token):",
            "                # When it matches, let update the record.",
            "                access_token.access_time = datetime.datetime.utcnow",
            "                return True",
            "        return False",
            "",
            "",
            "@event.listens_for(UserObject.hash_password, \"set\")",
            "def hash_password_set(target, value, oldvalue, initiator):",
            "    if value and value != oldvalue:",
            "        cherrypy.engine.publish('user_password_changed', target)",
            "",
            "",
            "@event.listens_for(UserObject, 'after_delete')",
            "def user_after_delete(mapper, connection, target):",
            "    \"\"\"",
            "    Publish event when user is deleted.",
            "    \"\"\"",
            "    cherrypy.engine.publish('user_deleted', target.username)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import datetime",
            "import logging",
            "import os",
            "import secrets",
            "import string",
            "",
            "import cherrypy",
            "from sqlalchemy import Column, Integer, SmallInteger, String, and_, event, inspect, or_",
            "from sqlalchemy.exc import IntegrityError",
            "from sqlalchemy.ext.hybrid import hybrid_property",
            "from sqlalchemy.orm import deferred, relationship",
            "from zxcvbn import zxcvbn",
            "",
            "import rdiffweb.tools.db  # noqa",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.passwd import check_password, hash_password",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "from ._repo import RepoObject",
            "from ._sshkey import SshKey",
            "from ._token import Token",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "Base = cherrypy.tools.db.get_base()",
            "",
            "SEP = b'/'",
            "",
            "",
            "class DuplicateSSHKeyError(Exception):",
            "    \"\"\"",
            "    Raised by add_authorizedkey when trying to add the same SSH Key twice.",
            "    \"\"\"",
            "",
            "    pass",
            "",
            "",
            "class UserObject(Base):",
            "    __tablename__ = 'users'",
            "    __table_args__ = {'sqlite_autoincrement': True}",
            "",
            "    # Value for role.",
            "    ADMIN_ROLE = 0",
            "    MAINTAINER_ROLE = 5",
            "    USER_ROLE = 10",
            "    ROLES = {",
            "        'admin': ADMIN_ROLE,",
            "        'maintainer': MAINTAINER_ROLE,",
            "        'user': USER_ROLE,",
            "    }",
            "    # Value for mfa field",
            "    DISABLED_MFA = 0",
            "    ENABLED_MFA = 1",
            "",
            "    # Regex pattern to be used for validation.",
            "    PATTERN_EMAIL = r\"[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$\"",
            "    PATTERN_FULLNAME = r\"\"\"[^!\"#$%&()*+,./:;<=>?@[\\]_{|}~]+$\"\"\"",
            "    PATTERN_USERNAME = r\"[a-zA-Z0-9_.\\-]+$\"",
            "",
            "    userid = Column('UserID', Integer, primary_key=True)",
            "    _username = Column('Username', String, nullable=False, unique=True)",
            "    hash_password = Column('Password', String, nullable=False, default=\"\")",
            "    _user_root = Column('UserRoot', String, nullable=False, default=\"\")",
            "    _is_admin = deferred(",
            "        Column(",
            "            'IsAdmin',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"0\",",
            "            doc=\"DEPRECATED This column is replaced by 'role'\",",
            "        )",
            "    )",
            "    _email = Column('UserEmail', String, nullable=False, default=\"\")",
            "    restore_format = deferred(",
            "        Column(",
            "            'RestoreFormat',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"1\",",
            "            doc=\"DEPRECATED This column is not used anymore\",",
            "        )",
            "    )",
            "    _role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE))",
            "    fullname = Column('fullname', String, nullable=False, default=\"\")",
            "    mfa = Column('mfa', SmallInteger, nullable=False, default=DISABLED_MFA)",
            "    repo_objs = relationship(",
            "        'RepoObject',",
            "        foreign_keys='UserObject.userid',",
            "        primaryjoin='UserObject.userid == RepoObject.userid',",
            "        uselist=True,",
            "        lazy=True,",
            "        order_by=lambda: RepoObject.repopath,",
            "    )",
            "",
            "    @classmethod",
            "    def get_user(cls, user):",
            "        \"\"\"Return a user object.\"\"\"",
            "        return UserObject.query.filter(UserObject.username == user).first()",
            "",
            "    @classmethod",
            "    def create_admin_user(cls, default_username, default_password):",
            "        # Check if admin user exists. If not, created it.",
            "        userobj = UserObject.get_user(default_username)",
            "        if not userobj:",
            "            userobj = cls.add_user(default_username, role=UserObject.ADMIN_ROLE, user_root='/backups')",
            "        # Also make sure to update the password with latest value from config file.",
            "        if default_password and default_password.startswith('{SSHA}'):",
            "            userobj.hash_password = default_password",
            "        elif default_password:",
            "            userobj.hash_password = hash_password(default_password)",
            "        else:",
            "            userobj.hash_password = hash_password('admin123')",
            "        userobj.add()",
            "",
            "    @classmethod",
            "    def add_user(cls, username, password=None, **attrs):",
            "        \"\"\"",
            "        Used to add a new user with an optional password.",
            "        \"\"\"",
            "        assert password is None or isinstance(password, str)",
            "        # Check if user already exists.",
            "        if UserObject.get_user(username):",
            "            raise ValueError(_(\"User %s already exists.\" % (username,)))",
            "",
            "        # Find a database where to add the user",
            "        logger.info(\"adding new user [%s]\", username)",
            "        userobj = UserObject(",
            "            username=username,",
            "            hash_password=hash_password(password) if password else '',",
            "            **attrs,",
            "        ).add()",
            "        # Raise event",
            "        cherrypy.engine.publish('user_added', userobj)",
            "        # Return user object",
            "        return userobj",
            "",
            "    def add_authorizedkey(self, key, comment=None):",
            "        \"\"\"",
            "        Add the given key to the user. Adding the key to his `authorized_keys`",
            "        file if it exists and adding it to database.",
            "        \"\"\"",
            "        # Parse and validate ssh key",
            "        assert key",
            "        key = authorizedkeys.check_publickey(key)",
            "",
            "        # Remove option, replace comments.",
            "        key = authorizedkeys.AuthorizedKey(",
            "            options=None, keytype=key.keytype, key=key.key, comment=comment or key.comment",
            "        )",
            "",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode=\"r+\", encoding='utf-8') as fh:",
            "                if authorizedkeys.exists(fh, key):",
            "                    raise DuplicateSSHKeyError(_(\"SSH key already exists\"))",
            "                logger.info(\"add key [%s] to [%s] authorized_keys\", key, self.username)",
            "                authorizedkeys.add(fh, key)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"add key [%s] to [%s] database\", key, self.username)",
            "            try:",
            "                SshKey(userid=self.userid, fingerprint=key.fingerprint, key=key.getvalue()).add()",
            "            except IntegrityError:",
            "                SshKey.session.rollback()",
            "                raise DuplicateSSHKeyError(",
            "                    _(\"Duplicate key. This key already exists or is associated to another user.\")",
            "                )",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def add_access_token(self, name, expiration_time=None, length=16):",
            "        \"\"\"",
            "        Create a new access token. Return the un-encrypted value of the token.",
            "        \"\"\"",
            "        assert name",
            "        assert length >= 8",
            "        # Generate a random token",
            "        token = ''.join(secrets.choice(string.ascii_lowercase) for i in range(length))",
            "        # Store hash token",
            "        try:",
            "            obj = Token(userid=self.userid, name=name, hash_token=hash_password(token), expiration_time=expiration_time)",
            "            obj.add()",
            "        except IntegrityError:",
            "            Token.session.rollback()",
            "            raise ValueError(_(\"Duplicate token name: %s\") % name)",
            "        cherrypy.engine.publish('access_token_added', self, name)",
            "        return token",
            "",
            "    def valid_user_root(self):",
            "        \"\"\"",
            "        Check if the current user_root is valid and readable",
            "        \"\"\"",
            "        try:",
            "            return os.access(self.user_root, os.F_OK) and os.path.isdir(self.user_root)",
            "        except Exception:",
            "            return False",
            "",
            "    def delete(self, *args, **kwargs):",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "        if self.username == cfg.admin_user:",
            "            raise ValueError(_(\"can't delete admin user\"))",
            "        # FIXME This should be deleted by cascade",
            "        SshKey.query.filter(SshKey.userid == self.userid).delete()",
            "        RepoObject.query.filter(RepoObject.userid == self.userid).delete()",
            "        Token.query.filter(Token.userid == self.userid).delete()",
            "        # Delete ourself",
            "        Base.delete(self)",
            "",
            "    def delete_authorizedkey(self, fingerprint):",
            "        \"\"\"",
            "        Remove the given key from the user. Remove the key from his",
            "        `authorized_keys` file if it exists and from database database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode='r+', encoding='utf-8') as fh:",
            "                logger.info(\"removing key [%s] from [%s] authorized_keys\", fingerprint, self.username)",
            "                authorizedkeys.remove(fh, fingerprint)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"removing key [%s] from [%s] database\", fingerprint, self.username)",
            "            SshKey.query.filter(and_(SshKey.userid == self.userid, SshKey.fingerprint == fingerprint)).delete()",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def delete_access_token(self, name):",
            "        assert name",
            "        if not Token.query.filter(Token.userid == self.userid, Token.name == name).delete():",
            "            raise ValueError(_(\"token name doesn't exists: %s\") % name)",
            "",
            "    @property",
            "    def disk_usage(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_usage', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @property",
            "    def disk_quota(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_quota', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @disk_quota.setter",
            "    def disk_quota(self, value):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return",
            "        cherrypy.engine.publish('set_disk_quota', self, value)",
            "",
            "    @property",
            "    def authorizedkeys(self):",
            "        \"\"\"",
            "        Return an iterator on the authorized key. Either from his",
            "        `authorized_keys` file if it exists or from database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            for k in authorizedkeys.read(filename):",
            "                yield k",
            "",
            "        # Also look in database.",
            "        for record in SshKey.query.filter(SshKey.userid == self.userid).all():",
            "            yield authorizedkeys.check_publickey(record.key)",
            "",
            "    def refresh_repos(self, delete=False):",
            "        \"\"\"",
            "        Return list of repositories object to reflect the filesystem folders.",
            "",
            "        Return a RepoObject for each sub directories under `user_root` with `rdiff-backup-data`.",
            "        \"\"\"",
            "        # Update the repositories by walking in the directory tree.",
            "        def _onerror(unused):",
            "            logger.error('error updating user [%s] repos' % self.username, exc_info=1)",
            "",
            "        # Get application config",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        dirty = False",
            "        records = RepoObject.query.filter(RepoObject.userid == self.userid).order_by(RepoObject.repopath).all()",
            "        user_root = os.fsencode(self.user_root)",
            "        for root, dirs, unused_files in os.walk(user_root, _onerror):",
            "            for name in dirs.copy():",
            "                if name.startswith(b'.'):",
            "                    dirs.remove(name)",
            "            if b'rdiff-backup-data' in dirs:",
            "                repopath = os.path.relpath(root, start=user_root)",
            "                del dirs[:]",
            "                # Handle special scenario when the repo is the",
            "                # user_root",
            "                repopath = b'' if repopath == b'.' else repopath",
            "",
            "                # Check if repo path exists.",
            "                record_match = next((record for record in records if record.repopath == os.fsdecode(repopath)), None)",
            "                if not record_match:",
            "                    # Add repository to database.",
            "                    RepoObject(user=self, repopath=os.fsdecode(repopath)).add()",
            "                    dirty = True",
            "                else:",
            "                    records.remove(record_match)",
            "            if root.count(SEP) - user_root.count(SEP) >= cfg.max_depth:",
            "                del dirs[:]",
            "        # If enabled, remove entried from database",
            "        if delete:",
            "            for record in records:",
            "                RepoObject.query.filter(RepoObject.repoid == record.repoid).delete()",
            "        return dirty",
            "",
            "    @hybrid_property",
            "    def is_admin(self):",
            "        return self.role <= self.ADMIN_ROLE",
            "",
            "    @hybrid_property",
            "    def is_ldap(self):",
            "        return self.hash_password is None or self.hash_password == ''",
            "",
            "    @is_ldap.expression",
            "    def is_ldap(cls):",
            "        return or_(cls.hash_password.is_(None), cls.hash_password == '')",
            "",
            "    @hybrid_property",
            "    def is_maintainer(self):",
            "        return self.role <= self.MAINTAINER_ROLE",
            "",
            "    def set_password(self, password, old_password=None):",
            "        \"\"\"",
            "        Change the user's password. Raise a ValueError if the username or",
            "        the password are invalid.",
            "        \"\"\"",
            "        assert isinstance(password, str)",
            "        assert old_password is None or isinstance(old_password, str)",
            "        if not password:",
            "            raise ValueError(\"password can't be empty\")",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        # Cannot update admin-password if defined",
            "        if self.username == cfg.admin_user and cfg.admin_password:",
            "            raise ValueError(_(\"can't update admin-password defined in configuration file\"))",
            "",
            "        if old_password and not check_password(old_password, self.hash_password):",
            "            raise ValueError(_(\"Wrong password\"))",
            "",
            "        # Check password length",
            "        if cfg.password_min_length > len(password) or len(password) > cfg.password_max_length:",
            "            raise ValueError(",
            "                _('Password must have between %(min)d and %(max)d characters.')",
            "                % {'min': cfg.password_min_length, 'max': cfg.password_max_length}",
            "            )",
            "",
            "        # Verify password score using zxcvbn",
            "        stats = zxcvbn(password)",
            "        if stats.get('score') < cfg.password_score:",
            "            msg = _('Password too weak.')",
            "            warning = stats.get('feedback', {}).get('warning')",
            "            suggestions = stats.get('feedback', {}).get('suggestions')",
            "            if warning:",
            "                msg += ' ' + warning",
            "            if suggestions:",
            "                msg += ' ' + ' '.join(suggestions)",
            "            raise ValueError(msg)",
            "",
            "        logger.info(\"updating user password [%s]\", self.username)",
            "        self.hash_password = hash_password(password)",
            "",
            "    def __eq__(self, other):",
            "        return type(self) == type(other) and inspect(self).key == inspect(other).key",
            "",
            "    @hybrid_property",
            "    def username(self):",
            "        return self._username",
            "",
            "    @username.setter",
            "    def username(self, value):",
            "        oldvalue = self._username",
            "        self._username = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'username': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def role(self):",
            "        if self._role is None:",
            "            return self.USER_ROLE",
            "        return self._role",
            "",
            "    @role.setter",
            "    def role(self, value):",
            "        oldvalue = self._role",
            "        self._role = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'role': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def email(self):",
            "        return self._email",
            "",
            "    @email.setter",
            "    def email(self, value):",
            "        oldvalue = self._email",
            "        self._email = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'email': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def user_root(self):",
            "        return self._user_root",
            "",
            "    @user_root.setter",
            "    def user_root(self, value):",
            "        oldvalue = self._user_root",
            "        self._user_root = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'user_root': (oldvalue, value)})",
            "",
            "    def validate_access_token(self, token):",
            "        \"\"\"",
            "        Check if the given token matches.",
            "        \"\"\"",
            "        for access_token in Token.query.all():",
            "            # If token expired. Let delete it.",
            "            if access_token.is_expired:",
            "                access_token.delete()",
            "                continue",
            "            if check_password(token, access_token.hash_token):",
            "                # When it matches, let update the record.",
            "                access_token.access_time = datetime.datetime.utcnow",
            "                return True",
            "        return False",
            "",
            "",
            "@event.listens_for(UserObject.hash_password, \"set\")",
            "def hash_password_set(target, value, oldvalue, initiator):",
            "    if value and value != oldvalue:",
            "        cherrypy.engine.publish('user_password_changed', target)",
            "",
            "",
            "@event.listens_for(UserObject, 'after_delete')",
            "def user_after_delete(mapper, connection, target):",
            "    \"\"\"",
            "    Publish event when user is deleted.",
            "    \"\"\"",
            "    cherrypy.engine.publish('user_deleted', target.username)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "django.contrib.admin.options.ModelAdmin",
            "rdiffweb.core.model._user.UserObject.__table_args__",
            "rdiffweb.core.model._user.UserObject.ROLES",
            "rdiffweb.core.model._user.UserObject.self",
            "rdiffweb.core.model._user.UserObject.add_user"
        ]
    }
}