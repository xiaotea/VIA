{
    "superset/views/database/views.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " from flask_appbuilder import expose, SimpleFormView"
            },
            "1": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " from flask_appbuilder.models.sqla.interface import SQLAInterface"
            },
            "2": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " from flask_appbuilder.security.decorators import has_access"
            },
            "3": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from flask_babel import lazy_gettext as _"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+from flask_babel import gettext as __, lazy_gettext as _"
            },
            "5": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " from werkzeug.wrappers import Response"
            },
            "6": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " from wtforms.fields import StringField"
            },
            "7": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": " from wtforms.validators import ValidationError"
            },
            "8": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": 133,
                "PatchRowcode": "         csv_table = Table(table=form.name.data, schema=form.schema.data)"
            },
            "9": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 134,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 135,
                "PatchRowcode": "         if not schema_allows_file_upload(database, csv_table.schema):"
            },
            "11": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = _("
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+            message = __("
            },
            "13": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "                 'Database \"%(database_name)s\" schema \"%(schema_name)s\" '"
            },
            "14": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": 138,
                "PatchRowcode": "                 \"is not allowed for csv uploads. Please contact your Superset Admin.\","
            },
            "15": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 139,
                "PatchRowcode": "                 database_name=database.database_name,"
            },
            "16": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": 219,
                "PatchRowcode": "             db.session.commit()"
            },
            "17": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": 220,
                "PatchRowcode": "         except Exception as ex:  # pylint: disable=broad-except"
            },
            "18": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": 221,
                "PatchRowcode": "             db.session.rollback()"
            },
            "19": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = _("
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 222,
                "PatchRowcode": "+            message = __("
            },
            "21": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": 223,
                "PatchRowcode": "                 'Unable to upload CSV file \"%(filename)s\" to table '"
            },
            "22": {
                "beforePatchRowNumber": 224,
                "afterPatchRowNumber": 224,
                "PatchRowcode": "                 '\"%(table_name)s\" in database \"%(db_name)s\". '"
            },
            "23": {
                "beforePatchRowNumber": 225,
                "afterPatchRowNumber": 225,
                "PatchRowcode": "                 \"Error message: %(error_msg)s\","
            },
            "24": {
                "beforePatchRowNumber": 234,
                "afterPatchRowNumber": 234,
                "PatchRowcode": "             return redirect(\"/csvtodatabaseview/form\")"
            },
            "25": {
                "beforePatchRowNumber": 235,
                "afterPatchRowNumber": 235,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 236,
                "afterPatchRowNumber": 236,
                "PatchRowcode": "         # Go back to welcome page / splash screen"
            },
            "27": {
                "beforePatchRowNumber": 237,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        message = _("
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 237,
                "PatchRowcode": "+        message = __("
            },
            "29": {
                "beforePatchRowNumber": 238,
                "afterPatchRowNumber": 238,
                "PatchRowcode": "             'CSV file \"%(csv_filename)s\" uploaded to table \"%(table_name)s\" in '"
            },
            "30": {
                "beforePatchRowNumber": 239,
                "afterPatchRowNumber": 239,
                "PatchRowcode": "             'database \"%(db_name)s\"',"
            },
            "31": {
                "beforePatchRowNumber": 240,
                "afterPatchRowNumber": 240,
                "PatchRowcode": "             csv_filename=form.csv_file.data.filename,"
            },
            "32": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": 269,
                "PatchRowcode": "         excel_table = Table(table=form.name.data, schema=form.schema.data)"
            },
            "33": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 270,
                "PatchRowcode": " "
            },
            "34": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": 271,
                "PatchRowcode": "         if not schema_allows_file_upload(database, excel_table.schema):"
            },
            "35": {
                "beforePatchRowNumber": 272,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = _("
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 272,
                "PatchRowcode": "+            message = __("
            },
            "37": {
                "beforePatchRowNumber": 273,
                "afterPatchRowNumber": 273,
                "PatchRowcode": "                 'Database \"%(database_name)s\" schema \"%(schema_name)s\" '"
            },
            "38": {
                "beforePatchRowNumber": 274,
                "afterPatchRowNumber": 274,
                "PatchRowcode": "                 \"is not allowed for excel uploads. Please contact your Superset Admin.\","
            },
            "39": {
                "beforePatchRowNumber": 275,
                "afterPatchRowNumber": 275,
                "PatchRowcode": "                 database_name=database.database_name,"
            },
            "40": {
                "beforePatchRowNumber": 356,
                "afterPatchRowNumber": 356,
                "PatchRowcode": "             db.session.commit()"
            },
            "41": {
                "beforePatchRowNumber": 357,
                "afterPatchRowNumber": 357,
                "PatchRowcode": "         except Exception as ex:  # pylint: disable=broad-except"
            },
            "42": {
                "beforePatchRowNumber": 358,
                "afterPatchRowNumber": 358,
                "PatchRowcode": "             db.session.rollback()"
            },
            "43": {
                "beforePatchRowNumber": 359,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = _("
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 359,
                "PatchRowcode": "+            message = __("
            },
            "45": {
                "beforePatchRowNumber": 360,
                "afterPatchRowNumber": 360,
                "PatchRowcode": "                 'Unable to upload Excel file \"%(filename)s\" to table '"
            },
            "46": {
                "beforePatchRowNumber": 361,
                "afterPatchRowNumber": 361,
                "PatchRowcode": "                 '\"%(table_name)s\" in database \"%(db_name)s\". '"
            },
            "47": {
                "beforePatchRowNumber": 362,
                "afterPatchRowNumber": 362,
                "PatchRowcode": "                 \"Error message: %(error_msg)s\","
            },
            "48": {
                "beforePatchRowNumber": 371,
                "afterPatchRowNumber": 371,
                "PatchRowcode": "             return redirect(\"/exceltodatabaseview/form\")"
            },
            "49": {
                "beforePatchRowNumber": 372,
                "afterPatchRowNumber": 372,
                "PatchRowcode": " "
            },
            "50": {
                "beforePatchRowNumber": 373,
                "afterPatchRowNumber": 373,
                "PatchRowcode": "         # Go back to welcome page / splash screen"
            },
            "51": {
                "beforePatchRowNumber": 374,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        message = _("
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 374,
                "PatchRowcode": "+        message = __("
            },
            "53": {
                "beforePatchRowNumber": 375,
                "afterPatchRowNumber": 375,
                "PatchRowcode": "             'Excel file \"%(excel_filename)s\" uploaded to table \"%(table_name)s\" in '"
            },
            "54": {
                "beforePatchRowNumber": 376,
                "afterPatchRowNumber": 376,
                "PatchRowcode": "             'database \"%(db_name)s\"',"
            },
            "55": {
                "beforePatchRowNumber": 377,
                "afterPatchRowNumber": 377,
                "PatchRowcode": "             excel_filename=form.excel_file.data.filename,"
            },
            "56": {
                "beforePatchRowNumber": 416,
                "afterPatchRowNumber": 416,
                "PatchRowcode": "             ]"
            },
            "57": {
                "beforePatchRowNumber": 417,
                "afterPatchRowNumber": 417,
                "PatchRowcode": " "
            },
            "58": {
                "beforePatchRowNumber": 418,
                "afterPatchRowNumber": 418,
                "PatchRowcode": "         if len(file_type) > 1:"
            },
            "59": {
                "beforePatchRowNumber": 419,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = _("
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 419,
                "PatchRowcode": "+            message = __("
            },
            "61": {
                "beforePatchRowNumber": 420,
                "afterPatchRowNumber": 420,
                "PatchRowcode": "                 \"Multiple file extensions are not allowed for columnar uploads.\""
            },
            "62": {
                "beforePatchRowNumber": 421,
                "afterPatchRowNumber": 421,
                "PatchRowcode": "                 \" Please make sure all files are of the same extension.\","
            },
            "63": {
                "beforePatchRowNumber": 422,
                "afterPatchRowNumber": 422,
                "PatchRowcode": "             )"
            },
            "64": {
                "beforePatchRowNumber": 429,
                "afterPatchRowNumber": 429,
                "PatchRowcode": "         }"
            },
            "65": {
                "beforePatchRowNumber": 430,
                "afterPatchRowNumber": 430,
                "PatchRowcode": " "
            },
            "66": {
                "beforePatchRowNumber": 431,
                "afterPatchRowNumber": 431,
                "PatchRowcode": "         if not schema_allows_file_upload(database, columnar_table.schema):"
            },
            "67": {
                "beforePatchRowNumber": 432,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = _("
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 432,
                "PatchRowcode": "+            message = __("
            },
            "69": {
                "beforePatchRowNumber": 433,
                "afterPatchRowNumber": 433,
                "PatchRowcode": "                 'Database \"%(database_name)s\" schema \"%(schema_name)s\" '"
            },
            "70": {
                "beforePatchRowNumber": 434,
                "afterPatchRowNumber": 434,
                "PatchRowcode": "                 \"is not allowed for columnar uploads. \""
            },
            "71": {
                "beforePatchRowNumber": 435,
                "afterPatchRowNumber": 435,
                "PatchRowcode": "                 \"Please contact your Superset Admin.\","
            },
            "72": {
                "beforePatchRowNumber": 497,
                "afterPatchRowNumber": 497,
                "PatchRowcode": "             db.session.commit()"
            },
            "73": {
                "beforePatchRowNumber": 498,
                "afterPatchRowNumber": 498,
                "PatchRowcode": "         except Exception as ex:  # pylint: disable=broad-except"
            },
            "74": {
                "beforePatchRowNumber": 499,
                "afterPatchRowNumber": 499,
                "PatchRowcode": "             db.session.rollback()"
            },
            "75": {
                "beforePatchRowNumber": 500,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = _("
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 500,
                "PatchRowcode": "+            message = __("
            },
            "77": {
                "beforePatchRowNumber": 501,
                "afterPatchRowNumber": 501,
                "PatchRowcode": "                 'Unable to upload Columnar file \"%(filename)s\" to table '"
            },
            "78": {
                "beforePatchRowNumber": 502,
                "afterPatchRowNumber": 502,
                "PatchRowcode": "                 '\"%(table_name)s\" in database \"%(db_name)s\". '"
            },
            "79": {
                "beforePatchRowNumber": 503,
                "afterPatchRowNumber": 503,
                "PatchRowcode": "                 \"Error message: %(error_msg)s\","
            },
            "80": {
                "beforePatchRowNumber": 512,
                "afterPatchRowNumber": 512,
                "PatchRowcode": "             return redirect(\"/columnartodatabaseview/form\")"
            },
            "81": {
                "beforePatchRowNumber": 513,
                "afterPatchRowNumber": 513,
                "PatchRowcode": " "
            },
            "82": {
                "beforePatchRowNumber": 514,
                "afterPatchRowNumber": 514,
                "PatchRowcode": "         # Go back to welcome page / splash screen"
            },
            "83": {
                "beforePatchRowNumber": 515,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        message = _("
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 515,
                "PatchRowcode": "+        message = __("
            },
            "85": {
                "beforePatchRowNumber": 516,
                "afterPatchRowNumber": 516,
                "PatchRowcode": "             'Columnar file \"%(columnar_filename)s\" uploaded to table \"%(table_name)s\" '"
            },
            "86": {
                "beforePatchRowNumber": 517,
                "afterPatchRowNumber": 517,
                "PatchRowcode": "             'in database \"%(db_name)s\"',"
            },
            "87": {
                "beforePatchRowNumber": 518,
                "afterPatchRowNumber": 518,
                "PatchRowcode": "             columnar_filename=[file.filename for file in form.columnar_file.data],"
            }
        },
        "frontPatchFile": [
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "import io",
            "import os",
            "import tempfile",
            "import zipfile",
            "from typing import TYPE_CHECKING",
            "",
            "import pandas as pd",
            "from flask import flash, g, redirect",
            "from flask_appbuilder import expose, SimpleFormView",
            "from flask_appbuilder.models.sqla.interface import SQLAInterface",
            "from flask_appbuilder.security.decorators import has_access",
            "from flask_babel import lazy_gettext as _",
            "from werkzeug.wrappers import Response",
            "from wtforms.fields import StringField",
            "from wtforms.validators import ValidationError",
            "",
            "import superset.models.core as models",
            "from superset import app, db, is_feature_enabled",
            "from superset.connectors.sqla.models import SqlaTable",
            "from superset.constants import MODEL_VIEW_RW_METHOD_PERMISSION_MAP, RouteMethod",
            "from superset.exceptions import CertificateException",
            "from superset.extensions import event_logger",
            "from superset.sql_parse import Table",
            "from superset.superset_typing import FlaskResponse",
            "from superset.utils import core as utils",
            "from superset.views.base import DeleteMixin, SupersetModelView, YamlExportMixin",
            "",
            "from .forms import ColumnarToDatabaseForm, CsvToDatabaseForm, ExcelToDatabaseForm",
            "from .mixins import DatabaseMixin",
            "from .validators import schema_allows_file_upload, sqlalchemy_uri_validator",
            "",
            "if TYPE_CHECKING:",
            "    from werkzeug.datastructures import FileStorage",
            "",
            "config = app.config",
            "stats_logger = config[\"STATS_LOGGER\"]",
            "",
            "",
            "def sqlalchemy_uri_form_validator(_: _, field: StringField) -> None:",
            "    \"\"\"",
            "    Check if user has submitted a valid SQLAlchemy URI",
            "    \"\"\"",
            "",
            "    sqlalchemy_uri_validator(field.data, exception=ValidationError)",
            "",
            "",
            "def certificate_form_validator(_: _, field: StringField) -> None:",
            "    \"\"\"",
            "    Check if user has submitted a valid SSL certificate",
            "    \"\"\"",
            "    if field.data:",
            "        try:",
            "            utils.parse_ssl_cert(field.data)",
            "        except CertificateException as ex:",
            "            raise ValidationError(ex.message) from ex",
            "",
            "",
            "def upload_stream_write(form_file_field: \"FileStorage\", path: str) -> None:",
            "    chunk_size = app.config[\"UPLOAD_CHUNK_SIZE\"]",
            "    with open(path, \"bw\") as file_description:",
            "        while True:",
            "            chunk = form_file_field.stream.read(chunk_size)",
            "            if not chunk:",
            "                break",
            "            file_description.write(chunk)",
            "",
            "",
            "class DatabaseView(",
            "    DatabaseMixin, SupersetModelView, DeleteMixin, YamlExportMixin",
            "):  # pylint: disable=too-many-ancestors",
            "    datamodel = SQLAInterface(models.Database)",
            "",
            "    class_permission_name = \"Database\"",
            "    method_permission_name = MODEL_VIEW_RW_METHOD_PERMISSION_MAP",
            "",
            "    include_route_methods = RouteMethod.CRUD_SET",
            "",
            "    add_template = \"superset/models/database/add.html\"",
            "    edit_template = \"superset/models/database/edit.html\"",
            "    validators_columns = {",
            "        \"sqlalchemy_uri\": [sqlalchemy_uri_form_validator],",
            "        \"server_cert\": [certificate_form_validator],",
            "    }",
            "",
            "    yaml_dict_key = \"databases\"",
            "",
            "    def _delete(self, pk: int) -> None:",
            "        DeleteMixin._delete(self, pk)",
            "",
            "    @expose(\"/list/\")",
            "    @has_access",
            "    def list(self) -> FlaskResponse:",
            "        if not is_feature_enabled(\"ENABLE_REACT_CRUD_VIEWS\"):",
            "            return super().list()",
            "",
            "        return super().render_app_template()",
            "",
            "",
            "class CsvToDatabaseView(SimpleFormView):",
            "    form = CsvToDatabaseForm",
            "    form_template = \"superset/form_view/csv_to_database_view/edit.html\"",
            "    form_title = _(\"CSV to Database configuration\")",
            "    add_columns = [\"database\", \"schema\", \"table_name\"]",
            "",
            "    def form_get(self, form: CsvToDatabaseForm) -> None:",
            "        form.sep.data = \",\"",
            "        form.header.data = 0",
            "        form.mangle_dupe_cols.data = True",
            "        form.skipinitialspace.data = False",
            "        form.skip_blank_lines.data = True",
            "        form.infer_datetime_format.data = True",
            "        form.decimal.data = \".\"",
            "        form.if_exists.data = \"fail\"",
            "",
            "    def form_post(self, form: CsvToDatabaseForm) -> Response:",
            "        database = form.con.data",
            "        csv_table = Table(table=form.name.data, schema=form.schema.data)",
            "",
            "        if not schema_allows_file_upload(database, csv_table.schema):",
            "            message = _(",
            "                'Database \"%(database_name)s\" schema \"%(schema_name)s\" '",
            "                \"is not allowed for csv uploads. Please contact your Superset Admin.\",",
            "                database_name=database.database_name,",
            "                schema_name=csv_table.schema,",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/csvtodatabaseview/form\")",
            "",
            "        try:",
            "            df = pd.concat(",
            "                pd.read_csv(",
            "                    chunksize=1000,",
            "                    encoding=\"utf-8\",",
            "                    filepath_or_buffer=form.csv_file.data,",
            "                    header=form.header.data if form.header.data else 0,",
            "                    index_col=form.index_col.data,",
            "                    infer_datetime_format=form.infer_datetime_format.data,",
            "                    iterator=True,",
            "                    keep_default_na=not form.null_values.data,",
            "                    mangle_dupe_cols=form.mangle_dupe_cols.data,",
            "                    usecols=form.usecols.data if form.usecols.data else None,",
            "                    na_values=form.null_values.data if form.null_values.data else None,",
            "                    nrows=form.nrows.data,",
            "                    parse_dates=form.parse_dates.data,",
            "                    sep=form.sep.data,",
            "                    skip_blank_lines=form.skip_blank_lines.data,",
            "                    skipinitialspace=form.skipinitialspace.data,",
            "                    skiprows=form.skiprows.data,",
            "                )",
            "            )",
            "",
            "            database = (",
            "                db.session.query(models.Database)",
            "                .filter_by(id=form.data.get(\"con\").data.get(\"id\"))",
            "                .one()",
            "            )",
            "",
            "            database.db_engine_spec.df_to_sql(",
            "                database,",
            "                csv_table,",
            "                df,",
            "                to_sql_kwargs={",
            "                    \"chunksize\": 1000,",
            "                    \"if_exists\": form.if_exists.data,",
            "                    \"index\": form.index.data,",
            "                    \"index_label\": form.index_label.data,",
            "                },",
            "            )",
            "",
            "            # Connect table to the database that should be used for exploration.",
            "            # E.g. if hive was used to upload a csv, presto will be a better option",
            "            # to explore the table.",
            "            expore_database = database",
            "            explore_database_id = database.explore_database_id",
            "            if explore_database_id:",
            "                expore_database = (",
            "                    db.session.query(models.Database)",
            "                    .filter_by(id=explore_database_id)",
            "                    .one_or_none()",
            "                    or database",
            "                )",
            "",
            "            sqla_table = (",
            "                db.session.query(SqlaTable)",
            "                .filter_by(",
            "                    table_name=csv_table.table,",
            "                    schema=csv_table.schema,",
            "                    database_id=expore_database.id,",
            "                )",
            "                .one_or_none()",
            "            )",
            "",
            "            if sqla_table:",
            "                sqla_table.fetch_metadata()",
            "            if not sqla_table:",
            "                sqla_table = SqlaTable(table_name=csv_table.table)",
            "                sqla_table.database = expore_database",
            "                sqla_table.database_id = database.id",
            "                sqla_table.owners = [g.user]",
            "                sqla_table.schema = csv_table.schema",
            "                sqla_table.fetch_metadata()",
            "                db.session.add(sqla_table)",
            "            db.session.commit()",
            "        except Exception as ex:  # pylint: disable=broad-except",
            "            db.session.rollback()",
            "            message = _(",
            "                'Unable to upload CSV file \"%(filename)s\" to table '",
            "                '\"%(table_name)s\" in database \"%(db_name)s\". '",
            "                \"Error message: %(error_msg)s\",",
            "                filename=form.csv_file.data.filename,",
            "                table_name=form.name.data,",
            "                db_name=database.database_name,",
            "                error_msg=str(ex),",
            "            )",
            "",
            "            flash(message, \"danger\")",
            "            stats_logger.incr(\"failed_csv_upload\")",
            "            return redirect(\"/csvtodatabaseview/form\")",
            "",
            "        # Go back to welcome page / splash screen",
            "        message = _(",
            "            'CSV file \"%(csv_filename)s\" uploaded to table \"%(table_name)s\" in '",
            "            'database \"%(db_name)s\"',",
            "            csv_filename=form.csv_file.data.filename,",
            "            table_name=str(csv_table),",
            "            db_name=sqla_table.database.database_name,",
            "        )",
            "        flash(message, \"info\")",
            "        event_logger.log_with_context(",
            "            action=\"successful_csv_upload\",",
            "            database=form.con.data.name,",
            "            schema=form.schema.data,",
            "            table=form.name.data,",
            "        )",
            "        return redirect(\"/tablemodelview/list/\")",
            "",
            "",
            "class ExcelToDatabaseView(SimpleFormView):",
            "    form = ExcelToDatabaseForm",
            "    form_template = \"superset/form_view/excel_to_database_view/edit.html\"",
            "    form_title = _(\"Excel to Database configuration\")",
            "    add_columns = [\"database\", \"schema\", \"table_name\"]",
            "",
            "    def form_get(self, form: ExcelToDatabaseForm) -> None:",
            "        form.header.data = 0",
            "        form.mangle_dupe_cols.data = True",
            "        form.decimal.data = \".\"",
            "        form.if_exists.data = \"fail\"",
            "        form.sheet_name.data = \"\"",
            "",
            "    def form_post(self, form: ExcelToDatabaseForm) -> Response:",
            "        database = form.con.data",
            "        excel_table = Table(table=form.name.data, schema=form.schema.data)",
            "",
            "        if not schema_allows_file_upload(database, excel_table.schema):",
            "            message = _(",
            "                'Database \"%(database_name)s\" schema \"%(schema_name)s\" '",
            "                \"is not allowed for excel uploads. Please contact your Superset Admin.\",",
            "                database_name=database.database_name,",
            "                schema_name=excel_table.schema,",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/exceltodatabaseview/form\")",
            "",
            "        uploaded_tmp_file_path = (",
            "            tempfile.NamedTemporaryFile(  # pylint: disable=consider-using-with",
            "                dir=app.config[\"UPLOAD_FOLDER\"],",
            "                suffix=os.path.splitext(form.excel_file.data.filename)[1].lower(),",
            "                delete=False,",
            "            ).name",
            "        )",
            "",
            "        try:",
            "            utils.ensure_path_exists(config[\"UPLOAD_FOLDER\"])",
            "            upload_stream_write(form.excel_file.data, uploaded_tmp_file_path)",
            "",
            "            df = pd.read_excel(",
            "                header=form.header.data if form.header.data else 0,",
            "                index_col=form.index_col.data,",
            "                io=form.excel_file.data,",
            "                keep_default_na=not form.null_values.data,",
            "                mangle_dupe_cols=form.mangle_dupe_cols.data,",
            "                na_values=form.null_values.data if form.null_values.data else None,",
            "                parse_dates=form.parse_dates.data,",
            "                skiprows=form.skiprows.data,",
            "                sheet_name=form.sheet_name.data if form.sheet_name.data else 0,",
            "            )",
            "",
            "            database = (",
            "                db.session.query(models.Database)",
            "                .filter_by(id=form.data.get(\"con\").data.get(\"id\"))",
            "                .one()",
            "            )",
            "",
            "            database.db_engine_spec.df_to_sql(",
            "                database,",
            "                excel_table,",
            "                df,",
            "                to_sql_kwargs={",
            "                    \"chunksize\": 1000,",
            "                    \"if_exists\": form.if_exists.data,",
            "                    \"index\": form.index.data,",
            "                    \"index_label\": form.index_label.data,",
            "                },",
            "            )",
            "",
            "            # Connect table to the database that should be used for exploration.",
            "            # E.g. if hive was used to upload a excel, presto will be a better option",
            "            # to explore the table.",
            "            expore_database = database",
            "            explore_database_id = database.explore_database_id",
            "            if explore_database_id:",
            "                expore_database = (",
            "                    db.session.query(models.Database)",
            "                    .filter_by(id=explore_database_id)",
            "                    .one_or_none()",
            "                    or database",
            "                )",
            "",
            "            sqla_table = (",
            "                db.session.query(SqlaTable)",
            "                .filter_by(",
            "                    table_name=excel_table.table,",
            "                    schema=excel_table.schema,",
            "                    database_id=expore_database.id,",
            "                )",
            "                .one_or_none()",
            "            )",
            "",
            "            if sqla_table:",
            "                sqla_table.fetch_metadata()",
            "            if not sqla_table:",
            "                sqla_table = SqlaTable(table_name=excel_table.table)",
            "                sqla_table.database = expore_database",
            "                sqla_table.database_id = database.id",
            "                sqla_table.owners = [g.user]",
            "                sqla_table.schema = excel_table.schema",
            "                sqla_table.fetch_metadata()",
            "                db.session.add(sqla_table)",
            "            db.session.commit()",
            "        except Exception as ex:  # pylint: disable=broad-except",
            "            db.session.rollback()",
            "            message = _(",
            "                'Unable to upload Excel file \"%(filename)s\" to table '",
            "                '\"%(table_name)s\" in database \"%(db_name)s\". '",
            "                \"Error message: %(error_msg)s\",",
            "                filename=form.excel_file.data.filename,",
            "                table_name=form.name.data,",
            "                db_name=database.database_name,",
            "                error_msg=str(ex),",
            "            )",
            "",
            "            flash(message, \"danger\")",
            "            stats_logger.incr(\"failed_excel_upload\")",
            "            return redirect(\"/exceltodatabaseview/form\")",
            "",
            "        # Go back to welcome page / splash screen",
            "        message = _(",
            "            'Excel file \"%(excel_filename)s\" uploaded to table \"%(table_name)s\" in '",
            "            'database \"%(db_name)s\"',",
            "            excel_filename=form.excel_file.data.filename,",
            "            table_name=str(excel_table),",
            "            db_name=sqla_table.database.database_name,",
            "        )",
            "        flash(message, \"info\")",
            "        event_logger.log_with_context(",
            "            action=\"successful_excel_upload\",",
            "            database=form.con.data.name,",
            "            schema=form.schema.data,",
            "            table=form.name.data,",
            "        )",
            "        return redirect(\"/tablemodelview/list/\")",
            "",
            "",
            "class ColumnarToDatabaseView(SimpleFormView):",
            "    form = ColumnarToDatabaseForm",
            "    form_template = \"superset/form_view/columnar_to_database_view/edit.html\"",
            "    form_title = _(\"Columnar to Database configuration\")",
            "    add_columns = [\"database\", \"schema\", \"table_name\"]",
            "",
            "    def form_get(self, form: ColumnarToDatabaseForm) -> None:",
            "        form.if_exists.data = \"fail\"",
            "",
            "    def form_post(  # pylint: disable=too-many-locals",
            "        self, form: ColumnarToDatabaseForm",
            "    ) -> Response:",
            "        database = form.con.data",
            "        columnar_table = Table(table=form.name.data, schema=form.schema.data)",
            "        files = form.columnar_file.data",
            "        file_type = {file.filename.split(\".\")[-1] for file in files}",
            "",
            "        if file_type == {\"zip\"}:",
            "            zipfile_ob = zipfile.ZipFile(  # pylint: disable=consider-using-with",
            "                form.columnar_file.data[0]",
            "            )  # pylint: disable=consider-using-with",
            "            file_type = {filename.split(\".\")[-1] for filename in zipfile_ob.namelist()}",
            "            files = [",
            "                io.BytesIO((zipfile_ob.open(filename).read(), filename)[0])",
            "                for filename in zipfile_ob.namelist()",
            "            ]",
            "",
            "        if len(file_type) > 1:",
            "            message = _(",
            "                \"Multiple file extensions are not allowed for columnar uploads.\"",
            "                \" Please make sure all files are of the same extension.\",",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/columnartodatabaseview/form\")",
            "",
            "        read = pd.read_parquet",
            "        kwargs = {",
            "            \"columns\": form.usecols.data if form.usecols.data else None,",
            "        }",
            "",
            "        if not schema_allows_file_upload(database, columnar_table.schema):",
            "            message = _(",
            "                'Database \"%(database_name)s\" schema \"%(schema_name)s\" '",
            "                \"is not allowed for columnar uploads. \"",
            "                \"Please contact your Superset Admin.\",",
            "                database_name=database.database_name,",
            "                schema_name=columnar_table.schema,",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/columnartodatabaseview/form\")",
            "",
            "        try:",
            "            chunks = [read(file, **kwargs) for file in files]",
            "            df = pd.concat(chunks)",
            "",
            "            database = (",
            "                db.session.query(models.Database)",
            "                .filter_by(id=form.data.get(\"con\").data.get(\"id\"))",
            "                .one()",
            "            )",
            "",
            "            database.db_engine_spec.df_to_sql(",
            "                database,",
            "                columnar_table,",
            "                df,",
            "                to_sql_kwargs={",
            "                    \"chunksize\": 1000,",
            "                    \"if_exists\": form.if_exists.data,",
            "                    \"index\": form.index.data,",
            "                    \"index_label\": form.index_label.data,",
            "                },",
            "            )",
            "",
            "            # Connect table to the database that should be used for exploration.",
            "            # E.g. if hive was used to upload a csv, presto will be a better option",
            "            # to explore the table.",
            "            expore_database = database",
            "            explore_database_id = database.explore_database_id",
            "            if explore_database_id:",
            "                expore_database = (",
            "                    db.session.query(models.Database)",
            "                    .filter_by(id=explore_database_id)",
            "                    .one_or_none()",
            "                    or database",
            "                )",
            "",
            "            sqla_table = (",
            "                db.session.query(SqlaTable)",
            "                .filter_by(",
            "                    table_name=columnar_table.table,",
            "                    schema=columnar_table.schema,",
            "                    database_id=expore_database.id,",
            "                )",
            "                .one_or_none()",
            "            )",
            "",
            "            if sqla_table:",
            "                sqla_table.fetch_metadata()",
            "            if not sqla_table:",
            "                sqla_table = SqlaTable(table_name=columnar_table.table)",
            "                sqla_table.database = expore_database",
            "                sqla_table.database_id = database.id",
            "                sqla_table.owners = [g.user]",
            "                sqla_table.schema = columnar_table.schema",
            "                sqla_table.fetch_metadata()",
            "                db.session.add(sqla_table)",
            "            db.session.commit()",
            "        except Exception as ex:  # pylint: disable=broad-except",
            "            db.session.rollback()",
            "            message = _(",
            "                'Unable to upload Columnar file \"%(filename)s\" to table '",
            "                '\"%(table_name)s\" in database \"%(db_name)s\". '",
            "                \"Error message: %(error_msg)s\",",
            "                filename=[file.filename for file in form.columnar_file.data],",
            "                table_name=form.name.data,",
            "                db_name=database.database_name,",
            "                error_msg=str(ex),",
            "            )",
            "",
            "            flash(message, \"danger\")",
            "            stats_logger.incr(\"failed_columnar_upload\")",
            "            return redirect(\"/columnartodatabaseview/form\")",
            "",
            "        # Go back to welcome page / splash screen",
            "        message = _(",
            "            'Columnar file \"%(columnar_filename)s\" uploaded to table \"%(table_name)s\" '",
            "            'in database \"%(db_name)s\"',",
            "            columnar_filename=[file.filename for file in form.columnar_file.data],",
            "            table_name=str(columnar_table),",
            "            db_name=sqla_table.database.database_name,",
            "        )",
            "        flash(message, \"info\")",
            "        event_logger.log_with_context(",
            "            action=\"successful_columnar_upload\",",
            "            database=form.con.data.name,",
            "            schema=form.schema.data,",
            "            table=form.name.data,",
            "        )",
            "        return redirect(\"/tablemodelview/list/\")"
        ],
        "afterPatchFile": [
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "import io",
            "import os",
            "import tempfile",
            "import zipfile",
            "from typing import TYPE_CHECKING",
            "",
            "import pandas as pd",
            "from flask import flash, g, redirect",
            "from flask_appbuilder import expose, SimpleFormView",
            "from flask_appbuilder.models.sqla.interface import SQLAInterface",
            "from flask_appbuilder.security.decorators import has_access",
            "from flask_babel import gettext as __, lazy_gettext as _",
            "from werkzeug.wrappers import Response",
            "from wtforms.fields import StringField",
            "from wtforms.validators import ValidationError",
            "",
            "import superset.models.core as models",
            "from superset import app, db, is_feature_enabled",
            "from superset.connectors.sqla.models import SqlaTable",
            "from superset.constants import MODEL_VIEW_RW_METHOD_PERMISSION_MAP, RouteMethod",
            "from superset.exceptions import CertificateException",
            "from superset.extensions import event_logger",
            "from superset.sql_parse import Table",
            "from superset.superset_typing import FlaskResponse",
            "from superset.utils import core as utils",
            "from superset.views.base import DeleteMixin, SupersetModelView, YamlExportMixin",
            "",
            "from .forms import ColumnarToDatabaseForm, CsvToDatabaseForm, ExcelToDatabaseForm",
            "from .mixins import DatabaseMixin",
            "from .validators import schema_allows_file_upload, sqlalchemy_uri_validator",
            "",
            "if TYPE_CHECKING:",
            "    from werkzeug.datastructures import FileStorage",
            "",
            "config = app.config",
            "stats_logger = config[\"STATS_LOGGER\"]",
            "",
            "",
            "def sqlalchemy_uri_form_validator(_: _, field: StringField) -> None:",
            "    \"\"\"",
            "    Check if user has submitted a valid SQLAlchemy URI",
            "    \"\"\"",
            "",
            "    sqlalchemy_uri_validator(field.data, exception=ValidationError)",
            "",
            "",
            "def certificate_form_validator(_: _, field: StringField) -> None:",
            "    \"\"\"",
            "    Check if user has submitted a valid SSL certificate",
            "    \"\"\"",
            "    if field.data:",
            "        try:",
            "            utils.parse_ssl_cert(field.data)",
            "        except CertificateException as ex:",
            "            raise ValidationError(ex.message) from ex",
            "",
            "",
            "def upload_stream_write(form_file_field: \"FileStorage\", path: str) -> None:",
            "    chunk_size = app.config[\"UPLOAD_CHUNK_SIZE\"]",
            "    with open(path, \"bw\") as file_description:",
            "        while True:",
            "            chunk = form_file_field.stream.read(chunk_size)",
            "            if not chunk:",
            "                break",
            "            file_description.write(chunk)",
            "",
            "",
            "class DatabaseView(",
            "    DatabaseMixin, SupersetModelView, DeleteMixin, YamlExportMixin",
            "):  # pylint: disable=too-many-ancestors",
            "    datamodel = SQLAInterface(models.Database)",
            "",
            "    class_permission_name = \"Database\"",
            "    method_permission_name = MODEL_VIEW_RW_METHOD_PERMISSION_MAP",
            "",
            "    include_route_methods = RouteMethod.CRUD_SET",
            "",
            "    add_template = \"superset/models/database/add.html\"",
            "    edit_template = \"superset/models/database/edit.html\"",
            "    validators_columns = {",
            "        \"sqlalchemy_uri\": [sqlalchemy_uri_form_validator],",
            "        \"server_cert\": [certificate_form_validator],",
            "    }",
            "",
            "    yaml_dict_key = \"databases\"",
            "",
            "    def _delete(self, pk: int) -> None:",
            "        DeleteMixin._delete(self, pk)",
            "",
            "    @expose(\"/list/\")",
            "    @has_access",
            "    def list(self) -> FlaskResponse:",
            "        if not is_feature_enabled(\"ENABLE_REACT_CRUD_VIEWS\"):",
            "            return super().list()",
            "",
            "        return super().render_app_template()",
            "",
            "",
            "class CsvToDatabaseView(SimpleFormView):",
            "    form = CsvToDatabaseForm",
            "    form_template = \"superset/form_view/csv_to_database_view/edit.html\"",
            "    form_title = _(\"CSV to Database configuration\")",
            "    add_columns = [\"database\", \"schema\", \"table_name\"]",
            "",
            "    def form_get(self, form: CsvToDatabaseForm) -> None:",
            "        form.sep.data = \",\"",
            "        form.header.data = 0",
            "        form.mangle_dupe_cols.data = True",
            "        form.skipinitialspace.data = False",
            "        form.skip_blank_lines.data = True",
            "        form.infer_datetime_format.data = True",
            "        form.decimal.data = \".\"",
            "        form.if_exists.data = \"fail\"",
            "",
            "    def form_post(self, form: CsvToDatabaseForm) -> Response:",
            "        database = form.con.data",
            "        csv_table = Table(table=form.name.data, schema=form.schema.data)",
            "",
            "        if not schema_allows_file_upload(database, csv_table.schema):",
            "            message = __(",
            "                'Database \"%(database_name)s\" schema \"%(schema_name)s\" '",
            "                \"is not allowed for csv uploads. Please contact your Superset Admin.\",",
            "                database_name=database.database_name,",
            "                schema_name=csv_table.schema,",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/csvtodatabaseview/form\")",
            "",
            "        try:",
            "            df = pd.concat(",
            "                pd.read_csv(",
            "                    chunksize=1000,",
            "                    encoding=\"utf-8\",",
            "                    filepath_or_buffer=form.csv_file.data,",
            "                    header=form.header.data if form.header.data else 0,",
            "                    index_col=form.index_col.data,",
            "                    infer_datetime_format=form.infer_datetime_format.data,",
            "                    iterator=True,",
            "                    keep_default_na=not form.null_values.data,",
            "                    mangle_dupe_cols=form.mangle_dupe_cols.data,",
            "                    usecols=form.usecols.data if form.usecols.data else None,",
            "                    na_values=form.null_values.data if form.null_values.data else None,",
            "                    nrows=form.nrows.data,",
            "                    parse_dates=form.parse_dates.data,",
            "                    sep=form.sep.data,",
            "                    skip_blank_lines=form.skip_blank_lines.data,",
            "                    skipinitialspace=form.skipinitialspace.data,",
            "                    skiprows=form.skiprows.data,",
            "                )",
            "            )",
            "",
            "            database = (",
            "                db.session.query(models.Database)",
            "                .filter_by(id=form.data.get(\"con\").data.get(\"id\"))",
            "                .one()",
            "            )",
            "",
            "            database.db_engine_spec.df_to_sql(",
            "                database,",
            "                csv_table,",
            "                df,",
            "                to_sql_kwargs={",
            "                    \"chunksize\": 1000,",
            "                    \"if_exists\": form.if_exists.data,",
            "                    \"index\": form.index.data,",
            "                    \"index_label\": form.index_label.data,",
            "                },",
            "            )",
            "",
            "            # Connect table to the database that should be used for exploration.",
            "            # E.g. if hive was used to upload a csv, presto will be a better option",
            "            # to explore the table.",
            "            expore_database = database",
            "            explore_database_id = database.explore_database_id",
            "            if explore_database_id:",
            "                expore_database = (",
            "                    db.session.query(models.Database)",
            "                    .filter_by(id=explore_database_id)",
            "                    .one_or_none()",
            "                    or database",
            "                )",
            "",
            "            sqla_table = (",
            "                db.session.query(SqlaTable)",
            "                .filter_by(",
            "                    table_name=csv_table.table,",
            "                    schema=csv_table.schema,",
            "                    database_id=expore_database.id,",
            "                )",
            "                .one_or_none()",
            "            )",
            "",
            "            if sqla_table:",
            "                sqla_table.fetch_metadata()",
            "            if not sqla_table:",
            "                sqla_table = SqlaTable(table_name=csv_table.table)",
            "                sqla_table.database = expore_database",
            "                sqla_table.database_id = database.id",
            "                sqla_table.owners = [g.user]",
            "                sqla_table.schema = csv_table.schema",
            "                sqla_table.fetch_metadata()",
            "                db.session.add(sqla_table)",
            "            db.session.commit()",
            "        except Exception as ex:  # pylint: disable=broad-except",
            "            db.session.rollback()",
            "            message = __(",
            "                'Unable to upload CSV file \"%(filename)s\" to table '",
            "                '\"%(table_name)s\" in database \"%(db_name)s\". '",
            "                \"Error message: %(error_msg)s\",",
            "                filename=form.csv_file.data.filename,",
            "                table_name=form.name.data,",
            "                db_name=database.database_name,",
            "                error_msg=str(ex),",
            "            )",
            "",
            "            flash(message, \"danger\")",
            "            stats_logger.incr(\"failed_csv_upload\")",
            "            return redirect(\"/csvtodatabaseview/form\")",
            "",
            "        # Go back to welcome page / splash screen",
            "        message = __(",
            "            'CSV file \"%(csv_filename)s\" uploaded to table \"%(table_name)s\" in '",
            "            'database \"%(db_name)s\"',",
            "            csv_filename=form.csv_file.data.filename,",
            "            table_name=str(csv_table),",
            "            db_name=sqla_table.database.database_name,",
            "        )",
            "        flash(message, \"info\")",
            "        event_logger.log_with_context(",
            "            action=\"successful_csv_upload\",",
            "            database=form.con.data.name,",
            "            schema=form.schema.data,",
            "            table=form.name.data,",
            "        )",
            "        return redirect(\"/tablemodelview/list/\")",
            "",
            "",
            "class ExcelToDatabaseView(SimpleFormView):",
            "    form = ExcelToDatabaseForm",
            "    form_template = \"superset/form_view/excel_to_database_view/edit.html\"",
            "    form_title = _(\"Excel to Database configuration\")",
            "    add_columns = [\"database\", \"schema\", \"table_name\"]",
            "",
            "    def form_get(self, form: ExcelToDatabaseForm) -> None:",
            "        form.header.data = 0",
            "        form.mangle_dupe_cols.data = True",
            "        form.decimal.data = \".\"",
            "        form.if_exists.data = \"fail\"",
            "        form.sheet_name.data = \"\"",
            "",
            "    def form_post(self, form: ExcelToDatabaseForm) -> Response:",
            "        database = form.con.data",
            "        excel_table = Table(table=form.name.data, schema=form.schema.data)",
            "",
            "        if not schema_allows_file_upload(database, excel_table.schema):",
            "            message = __(",
            "                'Database \"%(database_name)s\" schema \"%(schema_name)s\" '",
            "                \"is not allowed for excel uploads. Please contact your Superset Admin.\",",
            "                database_name=database.database_name,",
            "                schema_name=excel_table.schema,",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/exceltodatabaseview/form\")",
            "",
            "        uploaded_tmp_file_path = (",
            "            tempfile.NamedTemporaryFile(  # pylint: disable=consider-using-with",
            "                dir=app.config[\"UPLOAD_FOLDER\"],",
            "                suffix=os.path.splitext(form.excel_file.data.filename)[1].lower(),",
            "                delete=False,",
            "            ).name",
            "        )",
            "",
            "        try:",
            "            utils.ensure_path_exists(config[\"UPLOAD_FOLDER\"])",
            "            upload_stream_write(form.excel_file.data, uploaded_tmp_file_path)",
            "",
            "            df = pd.read_excel(",
            "                header=form.header.data if form.header.data else 0,",
            "                index_col=form.index_col.data,",
            "                io=form.excel_file.data,",
            "                keep_default_na=not form.null_values.data,",
            "                mangle_dupe_cols=form.mangle_dupe_cols.data,",
            "                na_values=form.null_values.data if form.null_values.data else None,",
            "                parse_dates=form.parse_dates.data,",
            "                skiprows=form.skiprows.data,",
            "                sheet_name=form.sheet_name.data if form.sheet_name.data else 0,",
            "            )",
            "",
            "            database = (",
            "                db.session.query(models.Database)",
            "                .filter_by(id=form.data.get(\"con\").data.get(\"id\"))",
            "                .one()",
            "            )",
            "",
            "            database.db_engine_spec.df_to_sql(",
            "                database,",
            "                excel_table,",
            "                df,",
            "                to_sql_kwargs={",
            "                    \"chunksize\": 1000,",
            "                    \"if_exists\": form.if_exists.data,",
            "                    \"index\": form.index.data,",
            "                    \"index_label\": form.index_label.data,",
            "                },",
            "            )",
            "",
            "            # Connect table to the database that should be used for exploration.",
            "            # E.g. if hive was used to upload a excel, presto will be a better option",
            "            # to explore the table.",
            "            expore_database = database",
            "            explore_database_id = database.explore_database_id",
            "            if explore_database_id:",
            "                expore_database = (",
            "                    db.session.query(models.Database)",
            "                    .filter_by(id=explore_database_id)",
            "                    .one_or_none()",
            "                    or database",
            "                )",
            "",
            "            sqla_table = (",
            "                db.session.query(SqlaTable)",
            "                .filter_by(",
            "                    table_name=excel_table.table,",
            "                    schema=excel_table.schema,",
            "                    database_id=expore_database.id,",
            "                )",
            "                .one_or_none()",
            "            )",
            "",
            "            if sqla_table:",
            "                sqla_table.fetch_metadata()",
            "            if not sqla_table:",
            "                sqla_table = SqlaTable(table_name=excel_table.table)",
            "                sqla_table.database = expore_database",
            "                sqla_table.database_id = database.id",
            "                sqla_table.owners = [g.user]",
            "                sqla_table.schema = excel_table.schema",
            "                sqla_table.fetch_metadata()",
            "                db.session.add(sqla_table)",
            "            db.session.commit()",
            "        except Exception as ex:  # pylint: disable=broad-except",
            "            db.session.rollback()",
            "            message = __(",
            "                'Unable to upload Excel file \"%(filename)s\" to table '",
            "                '\"%(table_name)s\" in database \"%(db_name)s\". '",
            "                \"Error message: %(error_msg)s\",",
            "                filename=form.excel_file.data.filename,",
            "                table_name=form.name.data,",
            "                db_name=database.database_name,",
            "                error_msg=str(ex),",
            "            )",
            "",
            "            flash(message, \"danger\")",
            "            stats_logger.incr(\"failed_excel_upload\")",
            "            return redirect(\"/exceltodatabaseview/form\")",
            "",
            "        # Go back to welcome page / splash screen",
            "        message = __(",
            "            'Excel file \"%(excel_filename)s\" uploaded to table \"%(table_name)s\" in '",
            "            'database \"%(db_name)s\"',",
            "            excel_filename=form.excel_file.data.filename,",
            "            table_name=str(excel_table),",
            "            db_name=sqla_table.database.database_name,",
            "        )",
            "        flash(message, \"info\")",
            "        event_logger.log_with_context(",
            "            action=\"successful_excel_upload\",",
            "            database=form.con.data.name,",
            "            schema=form.schema.data,",
            "            table=form.name.data,",
            "        )",
            "        return redirect(\"/tablemodelview/list/\")",
            "",
            "",
            "class ColumnarToDatabaseView(SimpleFormView):",
            "    form = ColumnarToDatabaseForm",
            "    form_template = \"superset/form_view/columnar_to_database_view/edit.html\"",
            "    form_title = _(\"Columnar to Database configuration\")",
            "    add_columns = [\"database\", \"schema\", \"table_name\"]",
            "",
            "    def form_get(self, form: ColumnarToDatabaseForm) -> None:",
            "        form.if_exists.data = \"fail\"",
            "",
            "    def form_post(  # pylint: disable=too-many-locals",
            "        self, form: ColumnarToDatabaseForm",
            "    ) -> Response:",
            "        database = form.con.data",
            "        columnar_table = Table(table=form.name.data, schema=form.schema.data)",
            "        files = form.columnar_file.data",
            "        file_type = {file.filename.split(\".\")[-1] for file in files}",
            "",
            "        if file_type == {\"zip\"}:",
            "            zipfile_ob = zipfile.ZipFile(  # pylint: disable=consider-using-with",
            "                form.columnar_file.data[0]",
            "            )  # pylint: disable=consider-using-with",
            "            file_type = {filename.split(\".\")[-1] for filename in zipfile_ob.namelist()}",
            "            files = [",
            "                io.BytesIO((zipfile_ob.open(filename).read(), filename)[0])",
            "                for filename in zipfile_ob.namelist()",
            "            ]",
            "",
            "        if len(file_type) > 1:",
            "            message = __(",
            "                \"Multiple file extensions are not allowed for columnar uploads.\"",
            "                \" Please make sure all files are of the same extension.\",",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/columnartodatabaseview/form\")",
            "",
            "        read = pd.read_parquet",
            "        kwargs = {",
            "            \"columns\": form.usecols.data if form.usecols.data else None,",
            "        }",
            "",
            "        if not schema_allows_file_upload(database, columnar_table.schema):",
            "            message = __(",
            "                'Database \"%(database_name)s\" schema \"%(schema_name)s\" '",
            "                \"is not allowed for columnar uploads. \"",
            "                \"Please contact your Superset Admin.\",",
            "                database_name=database.database_name,",
            "                schema_name=columnar_table.schema,",
            "            )",
            "            flash(message, \"danger\")",
            "            return redirect(\"/columnartodatabaseview/form\")",
            "",
            "        try:",
            "            chunks = [read(file, **kwargs) for file in files]",
            "            df = pd.concat(chunks)",
            "",
            "            database = (",
            "                db.session.query(models.Database)",
            "                .filter_by(id=form.data.get(\"con\").data.get(\"id\"))",
            "                .one()",
            "            )",
            "",
            "            database.db_engine_spec.df_to_sql(",
            "                database,",
            "                columnar_table,",
            "                df,",
            "                to_sql_kwargs={",
            "                    \"chunksize\": 1000,",
            "                    \"if_exists\": form.if_exists.data,",
            "                    \"index\": form.index.data,",
            "                    \"index_label\": form.index_label.data,",
            "                },",
            "            )",
            "",
            "            # Connect table to the database that should be used for exploration.",
            "            # E.g. if hive was used to upload a csv, presto will be a better option",
            "            # to explore the table.",
            "            expore_database = database",
            "            explore_database_id = database.explore_database_id",
            "            if explore_database_id:",
            "                expore_database = (",
            "                    db.session.query(models.Database)",
            "                    .filter_by(id=explore_database_id)",
            "                    .one_or_none()",
            "                    or database",
            "                )",
            "",
            "            sqla_table = (",
            "                db.session.query(SqlaTable)",
            "                .filter_by(",
            "                    table_name=columnar_table.table,",
            "                    schema=columnar_table.schema,",
            "                    database_id=expore_database.id,",
            "                )",
            "                .one_or_none()",
            "            )",
            "",
            "            if sqla_table:",
            "                sqla_table.fetch_metadata()",
            "            if not sqla_table:",
            "                sqla_table = SqlaTable(table_name=columnar_table.table)",
            "                sqla_table.database = expore_database",
            "                sqla_table.database_id = database.id",
            "                sqla_table.owners = [g.user]",
            "                sqla_table.schema = columnar_table.schema",
            "                sqla_table.fetch_metadata()",
            "                db.session.add(sqla_table)",
            "            db.session.commit()",
            "        except Exception as ex:  # pylint: disable=broad-except",
            "            db.session.rollback()",
            "            message = __(",
            "                'Unable to upload Columnar file \"%(filename)s\" to table '",
            "                '\"%(table_name)s\" in database \"%(db_name)s\". '",
            "                \"Error message: %(error_msg)s\",",
            "                filename=[file.filename for file in form.columnar_file.data],",
            "                table_name=form.name.data,",
            "                db_name=database.database_name,",
            "                error_msg=str(ex),",
            "            )",
            "",
            "            flash(message, \"danger\")",
            "            stats_logger.incr(\"failed_columnar_upload\")",
            "            return redirect(\"/columnartodatabaseview/form\")",
            "",
            "        # Go back to welcome page / splash screen",
            "        message = __(",
            "            'Columnar file \"%(columnar_filename)s\" uploaded to table \"%(table_name)s\" '",
            "            'in database \"%(db_name)s\"',",
            "            columnar_filename=[file.filename for file in form.columnar_file.data],",
            "            table_name=str(columnar_table),",
            "            db_name=sqla_table.database.database_name,",
            "        )",
            "        flash(message, \"info\")",
            "        event_logger.log_with_context(",
            "            action=\"successful_columnar_upload\",",
            "            database=form.con.data.name,",
            "            schema=form.schema.data,",
            "            table=form.name.data,",
            "        )",
            "        return redirect(\"/tablemodelview/list/\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "28": [],
            "136": [
                "CsvToDatabaseView",
                "form_post"
            ],
            "222": [
                "CsvToDatabaseView",
                "form_post"
            ],
            "237": [
                "CsvToDatabaseView",
                "form_post"
            ],
            "272": [
                "ExcelToDatabaseView",
                "form_post"
            ],
            "359": [
                "ExcelToDatabaseView",
                "form_post"
            ],
            "374": [
                "ExcelToDatabaseView",
                "form_post"
            ],
            "419": [
                "ColumnarToDatabaseView",
                "form_post"
            ],
            "432": [
                "ColumnarToDatabaseView",
                "form_post"
            ],
            "500": [
                "ColumnarToDatabaseView",
                "form_post"
            ],
            "515": [
                "ColumnarToDatabaseView",
                "form_post"
            ]
        },
        "addLocation": []
    }
}