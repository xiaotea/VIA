{
    "s3file/forms.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import uuid"
            },
            "1": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from django.conf import settings"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+from django.core import signing"
            },
            "4": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from django.utils.functional import cached_property"
            },
            "5": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from storages.utils import safe_join"
            },
            "6": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 17,
                "PatchRowcode": "     \"\"\"FileInput that uses JavaScript to directly upload to Amazon S3.\"\"\""
            },
            "8": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 19,
                "PatchRowcode": "     needs_multipart_form = False"
            },
            "10": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    upload_path = str("
            },
            "11": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        getattr(settings, \"S3FILE_UPLOAD_PATH\", pathlib.PurePosixPath(\"tmp\", \"s3file\"))"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 20,
                "PatchRowcode": "+    upload_path = safe_join("
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+        str(storage.aws_location),"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+        str("
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+            getattr("
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+                settings, \"S3FILE_UPLOAD_PATH\", pathlib.PurePosixPath(\"tmp\", \"s3file\")"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+            )"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+        ),"
            },
            "19": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 27,
                "PatchRowcode": "     )"
            },
            "20": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    upload_path = safe_join(str(storage.location), upload_path)"
            },
            "21": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 28,
                "PatchRowcode": "     expires = settings.SESSION_COOKIE_AGE"
            },
            "22": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "     @property"
            },
            "24": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "             \"data-fields-%s\" % key: value for key, value in response[\"fields\"].items()"
            },
            "25": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         }"
            },
            "26": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "         defaults[\"data-url\"] = response[\"url\"]"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+        signer = signing.Signer("
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+            salt=f\"{S3FileInputMixin.__module__}.{S3FileInputMixin.__name__}\""
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+        )"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+        print(self.upload_folder)"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+        defaults[\"data-s3f-signature\"] = signer.signature(self.upload_folder)"
            },
            "32": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 58,
                "PatchRowcode": "         defaults.update(attrs)"
            },
            "33": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 59,
                "PatchRowcode": " "
            },
            "34": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "         try:"
            }
        },
        "frontPatchFile": [
            "import base64",
            "import logging",
            "import pathlib",
            "import uuid",
            "",
            "from django.conf import settings",
            "from django.utils.functional import cached_property",
            "from storages.utils import safe_join",
            "",
            "from s3file.storages import storage",
            "",
            "logger = logging.getLogger(\"s3file\")",
            "",
            "",
            "class S3FileInputMixin:",
            "    \"\"\"FileInput that uses JavaScript to directly upload to Amazon S3.\"\"\"",
            "",
            "    needs_multipart_form = False",
            "    upload_path = str(",
            "        getattr(settings, \"S3FILE_UPLOAD_PATH\", pathlib.PurePosixPath(\"tmp\", \"s3file\"))",
            "    )",
            "    upload_path = safe_join(str(storage.location), upload_path)",
            "    expires = settings.SESSION_COOKIE_AGE",
            "",
            "    @property",
            "    def bucket_name(self):",
            "        return storage.bucket.name",
            "",
            "    @property",
            "    def client(self):",
            "        return storage.connection.meta.client",
            "",
            "    def build_attrs(self, *args, **kwargs):",
            "        attrs = super().build_attrs(*args, **kwargs)",
            "",
            "        accept = attrs.get(\"accept\")",
            "        response = self.client.generate_presigned_post(",
            "            self.bucket_name,",
            "            str(pathlib.PurePosixPath(self.upload_folder, \"${filename}\")),",
            "            Conditions=self.get_conditions(accept),",
            "            ExpiresIn=self.expires,",
            "        )",
            "",
            "        defaults = {",
            "            \"data-fields-%s\" % key: value for key, value in response[\"fields\"].items()",
            "        }",
            "        defaults[\"data-url\"] = response[\"url\"]",
            "        defaults.update(attrs)",
            "",
            "        try:",
            "            defaults[\"class\"] += \" s3file\"",
            "        except KeyError:",
            "            defaults[\"class\"] = \"s3file\"",
            "        return defaults",
            "",
            "    def get_conditions(self, accept):",
            "        conditions = [",
            "            {\"bucket\": self.bucket_name},",
            "            [\"starts-with\", \"$key\", str(self.upload_folder)],",
            "            {\"success_action_status\": \"201\"},",
            "        ]",
            "        if accept and \",\" not in accept:",
            "            top_type, sub_type = accept.split(\"/\", 1)",
            "            if sub_type == \"*\":",
            "                conditions.append([\"starts-with\", \"$Content-Type\", \"%s/\" % top_type])",
            "            else:",
            "                conditions.append({\"Content-Type\": accept})",
            "        else:",
            "            conditions.append([\"starts-with\", \"$Content-Type\", \"\"])",
            "",
            "        return conditions",
            "",
            "    @cached_property",
            "    def upload_folder(self):",
            "        return str(",
            "            pathlib.PurePosixPath(",
            "                self.upload_path,",
            "                base64.urlsafe_b64encode(uuid.uuid4().bytes)",
            "                .decode(\"utf-8\")",
            "                .rstrip(\"=\\n\"),",
            "            )",
            "        )  # S3 uses POSIX paths",
            "",
            "    class Media:",
            "        js = (\"s3file/js/s3file.js\" if settings.DEBUG else \"s3file/js/s3file.min.js\",)"
        ],
        "afterPatchFile": [
            "import base64",
            "import logging",
            "import pathlib",
            "import uuid",
            "",
            "from django.conf import settings",
            "from django.core import signing",
            "from django.utils.functional import cached_property",
            "from storages.utils import safe_join",
            "",
            "from s3file.storages import storage",
            "",
            "logger = logging.getLogger(\"s3file\")",
            "",
            "",
            "class S3FileInputMixin:",
            "    \"\"\"FileInput that uses JavaScript to directly upload to Amazon S3.\"\"\"",
            "",
            "    needs_multipart_form = False",
            "    upload_path = safe_join(",
            "        str(storage.aws_location),",
            "        str(",
            "            getattr(",
            "                settings, \"S3FILE_UPLOAD_PATH\", pathlib.PurePosixPath(\"tmp\", \"s3file\")",
            "            )",
            "        ),",
            "    )",
            "    expires = settings.SESSION_COOKIE_AGE",
            "",
            "    @property",
            "    def bucket_name(self):",
            "        return storage.bucket.name",
            "",
            "    @property",
            "    def client(self):",
            "        return storage.connection.meta.client",
            "",
            "    def build_attrs(self, *args, **kwargs):",
            "        attrs = super().build_attrs(*args, **kwargs)",
            "",
            "        accept = attrs.get(\"accept\")",
            "        response = self.client.generate_presigned_post(",
            "            self.bucket_name,",
            "            str(pathlib.PurePosixPath(self.upload_folder, \"${filename}\")),",
            "            Conditions=self.get_conditions(accept),",
            "            ExpiresIn=self.expires,",
            "        )",
            "",
            "        defaults = {",
            "            \"data-fields-%s\" % key: value for key, value in response[\"fields\"].items()",
            "        }",
            "        defaults[\"data-url\"] = response[\"url\"]",
            "        signer = signing.Signer(",
            "            salt=f\"{S3FileInputMixin.__module__}.{S3FileInputMixin.__name__}\"",
            "        )",
            "        print(self.upload_folder)",
            "        defaults[\"data-s3f-signature\"] = signer.signature(self.upload_folder)",
            "        defaults.update(attrs)",
            "",
            "        try:",
            "            defaults[\"class\"] += \" s3file\"",
            "        except KeyError:",
            "            defaults[\"class\"] = \"s3file\"",
            "        return defaults",
            "",
            "    def get_conditions(self, accept):",
            "        conditions = [",
            "            {\"bucket\": self.bucket_name},",
            "            [\"starts-with\", \"$key\", str(self.upload_folder)],",
            "            {\"success_action_status\": \"201\"},",
            "        ]",
            "        if accept and \",\" not in accept:",
            "            top_type, sub_type = accept.split(\"/\", 1)",
            "            if sub_type == \"*\":",
            "                conditions.append([\"starts-with\", \"$Content-Type\", \"%s/\" % top_type])",
            "            else:",
            "                conditions.append({\"Content-Type\": accept})",
            "        else:",
            "            conditions.append([\"starts-with\", \"$Content-Type\", \"\"])",
            "",
            "        return conditions",
            "",
            "    @cached_property",
            "    def upload_folder(self):",
            "        return str(",
            "            pathlib.PurePosixPath(",
            "                self.upload_path,",
            "                base64.urlsafe_b64encode(uuid.uuid4().bytes)",
            "                .decode(\"utf-8\")",
            "                .rstrip(\"=\\n\"),",
            "            )",
            "        )  # S3 uses POSIX paths",
            "",
            "    class Media:",
            "        js = (\"s3file/js/s3file.js\" if settings.DEBUG else \"s3file/js/s3file.min.js\",)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "19": [
                "S3FileInputMixin"
            ],
            "20": [
                "S3FileInputMixin"
            ],
            "22": [
                "S3FileInputMixin"
            ]
        },
        "addLocation": []
    },
    "s3file/middleware.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " import logging"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " import pathlib"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from s3file.storages import local_dev, storage"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from django.core import signing"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+from django.core.exceptions import PermissionDenied, SuspiciousFileOperation"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from django.utils.crypto import constant_time_compare"
            },
            "7": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from . import views"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+from .forms import S3FileInputMixin"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+from .storages import local_dev, storage"
            },
            "11": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " "
            },
            "12": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " logger = logging.getLogger(\"s3file\")"
            },
            "13": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 19,
                "PatchRowcode": "     def __call__(self, request):"
            },
            "15": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 20,
                "PatchRowcode": "         file_fields = request.POST.getlist(\"s3file\")"
            },
            "16": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 21,
                "PatchRowcode": "         for field_name in file_fields:"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 23,
                "PatchRowcode": "             paths = request.POST.getlist(field_name)"
            },
            "19": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            request.FILES.setlist(field_name, list(self.get_files_from_storage(paths)))"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+            if paths:"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+                try:"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+                    signature = request.POST[f\"{field_name}-s3f-signature\"]"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+                except KeyError:"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+                    raise PermissionDenied(\"No signature provided.\")"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+                try:"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+                    request.FILES.setlist("
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+                        field_name, list(self.get_files_from_storage(paths, signature))"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+                    )"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+                except SuspiciousFileOperation as e:"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+                    raise PermissionDenied(\"Illegal file name!\") from e"
            },
            "31": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "         if local_dev and request.path == \"/__s3_mock__/\":"
            },
            "33": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "             return views.S3MockView.as_view()(request)"
            },
            "34": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            },
            "35": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "         return self.get_response(request)"
            },
            "36": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 41,
                "PatchRowcode": "     @staticmethod"
            },
            "38": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def get_files_from_storage(paths):"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+    def get_files_from_storage(paths, signature):"
            },
            "40": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 43,
                "PatchRowcode": "         \"\"\"Return S3 file where the name does not include the path.\"\"\""
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+        try:"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+            location = storage.aws_location"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+        except AttributeError:"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+            location = storage.location"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 48,
                "PatchRowcode": "+        signer = signing.Signer("
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+            salt=f\"{S3FileInputMixin.__module__}.{S3FileInputMixin.__name__}\""
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+        )"
            },
            "48": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         for path in paths:"
            },
            "49": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "             path = pathlib.PurePosixPath(path)"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+            print(path)"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+            print(signer.signature(path.parent), signature)"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+            if not constant_time_compare(signer.signature(path.parent), signature):"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+                raise PermissionDenied(\"Illegal signature!\")"
            },
            "54": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 57,
                "PatchRowcode": "             try:"
            },
            "55": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                location = storage.aws_location"
            },
            "56": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            except AttributeError:"
            },
            "57": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                location = storage.location"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+                relative_path = str(path.relative_to(location))"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+            except ValueError as e:"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+                raise SuspiciousFileOperation("
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+                    f\"Path is not inside the designated upload location: {path}\""
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+                ) from e"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+"
            },
            "64": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "             try:"
            },
            "65": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                f = storage.open(str(path.relative_to(location)))"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+                f = storage.open(relative_path)"
            },
            "67": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "                 f.name = path.name"
            },
            "68": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "                 yield f"
            },
            "69": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "             except (OSError, ValueError):"
            }
        },
        "frontPatchFile": [
            "import logging",
            "import pathlib",
            "",
            "from s3file.storages import local_dev, storage",
            "",
            "from . import views",
            "",
            "logger = logging.getLogger(\"s3file\")",
            "",
            "",
            "class S3FileMiddleware:",
            "    def __init__(self, get_response):",
            "        self.get_response = get_response",
            "",
            "    def __call__(self, request):",
            "        file_fields = request.POST.getlist(\"s3file\")",
            "        for field_name in file_fields:",
            "            paths = request.POST.getlist(field_name)",
            "            request.FILES.setlist(field_name, list(self.get_files_from_storage(paths)))",
            "",
            "        if local_dev and request.path == \"/__s3_mock__/\":",
            "            return views.S3MockView.as_view()(request)",
            "",
            "        return self.get_response(request)",
            "",
            "    @staticmethod",
            "    def get_files_from_storage(paths):",
            "        \"\"\"Return S3 file where the name does not include the path.\"\"\"",
            "        for path in paths:",
            "            path = pathlib.PurePosixPath(path)",
            "            try:",
            "                location = storage.aws_location",
            "            except AttributeError:",
            "                location = storage.location",
            "            try:",
            "                f = storage.open(str(path.relative_to(location)))",
            "                f.name = path.name",
            "                yield f",
            "            except (OSError, ValueError):",
            "                logger.exception(\"File not found: %s\", path)"
        ],
        "afterPatchFile": [
            "import logging",
            "import pathlib",
            "",
            "from django.core import signing",
            "from django.core.exceptions import PermissionDenied, SuspiciousFileOperation",
            "from django.utils.crypto import constant_time_compare",
            "",
            "from . import views",
            "from .forms import S3FileInputMixin",
            "from .storages import local_dev, storage",
            "",
            "logger = logging.getLogger(\"s3file\")",
            "",
            "",
            "class S3FileMiddleware:",
            "    def __init__(self, get_response):",
            "        self.get_response = get_response",
            "",
            "    def __call__(self, request):",
            "        file_fields = request.POST.getlist(\"s3file\")",
            "        for field_name in file_fields:",
            "",
            "            paths = request.POST.getlist(field_name)",
            "            if paths:",
            "                try:",
            "                    signature = request.POST[f\"{field_name}-s3f-signature\"]",
            "                except KeyError:",
            "                    raise PermissionDenied(\"No signature provided.\")",
            "                try:",
            "                    request.FILES.setlist(",
            "                        field_name, list(self.get_files_from_storage(paths, signature))",
            "                    )",
            "                except SuspiciousFileOperation as e:",
            "                    raise PermissionDenied(\"Illegal file name!\") from e",
            "",
            "        if local_dev and request.path == \"/__s3_mock__/\":",
            "            return views.S3MockView.as_view()(request)",
            "",
            "        return self.get_response(request)",
            "",
            "    @staticmethod",
            "    def get_files_from_storage(paths, signature):",
            "        \"\"\"Return S3 file where the name does not include the path.\"\"\"",
            "        try:",
            "            location = storage.aws_location",
            "        except AttributeError:",
            "            location = storage.location",
            "        signer = signing.Signer(",
            "            salt=f\"{S3FileInputMixin.__module__}.{S3FileInputMixin.__name__}\"",
            "        )",
            "        for path in paths:",
            "            path = pathlib.PurePosixPath(path)",
            "            print(path)",
            "            print(signer.signature(path.parent), signature)",
            "            if not constant_time_compare(signer.signature(path.parent), signature):",
            "                raise PermissionDenied(\"Illegal signature!\")",
            "            try:",
            "                relative_path = str(path.relative_to(location))",
            "            except ValueError as e:",
            "                raise SuspiciousFileOperation(",
            "                    f\"Path is not inside the designated upload location: {path}\"",
            "                ) from e",
            "",
            "            try:",
            "                f = storage.open(relative_path)",
            "                f.name = path.name",
            "                yield f",
            "            except (OSError, ValueError):",
            "                logger.exception(\"File not found: %s\", path)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "4": [],
            "19": [
                "S3FileMiddleware",
                "__call__"
            ],
            "27": [
                "S3FileMiddleware",
                "get_files_from_storage"
            ],
            "32": [
                "S3FileMiddleware",
                "get_files_from_storage"
            ],
            "33": [
                "S3FileMiddleware",
                "get_files_from_storage"
            ],
            "34": [
                "S3FileMiddleware",
                "get_files_from_storage"
            ],
            "36": [
                "S3FileMiddleware",
                "get_files_from_storage"
            ]
        },
        "addLocation": []
    },
    "s3file/views.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " import hashlib"
            },
            "1": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import hmac"
            },
            "2": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import logging"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+from pathlib import Path"
            },
            "4": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from django import http"
            },
            "6": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from django.conf import settings"
            }
        },
        "frontPatchFile": [
            "import base64",
            "import hashlib",
            "import hmac",
            "import logging",
            "",
            "from django import http",
            "from django.conf import settings",
            "from django.core.files.storage import default_storage",
            "from django.views import generic",
            "",
            "logger = logging.getLogger(\"s3file\")",
            "",
            "",
            "class S3MockView(generic.View):",
            "    def post(self, request):",
            "        success_action_status = request.POST.get(\"success_action_status\", 201)",
            "        try:",
            "            file = request.FILES[\"file\"]",
            "            key = request.POST[\"key\"]",
            "            date = request.POST[\"x-amz-date\"]",
            "            signature = request.POST[\"x-amz-signature\"]",
            "            policy = request.POST[\"policy\"]",
            "        except KeyError:",
            "            logger.exception(\"bad request\")",
            "            return http.HttpResponseBadRequest()",
            "",
            "        try:",
            "            signature = base64.b64decode(signature.encode())",
            "            policy = base64.b64decode(policy.encode())",
            "",
            "            calc_sign = hmac.new(",
            "                settings.SECRET_KEY.encode(), policy + date.encode(), \"sha256\"",
            "            ).digest()",
            "        except ValueError:",
            "            logger.exception(\"bad request\")",
            "            return http.HttpResponseBadRequest()",
            "",
            "        if not hmac.compare_digest(signature, calc_sign):",
            "            logger.warning(\"bad signature\")",
            "            return http.HttpResponseForbidden()",
            "",
            "        key = key.replace(\"${filename}\", file.name)",
            "        etag = hashlib.md5(file.read()).hexdigest()  # nosec",
            "        file.seek(0)",
            "        key = default_storage.save(key, file)",
            "        return http.HttpResponse(",
            "            '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'",
            "            \"<PostResponse>\"",
            "            f\"<Location>{settings.MEDIA_URL}{key}</Location>\"",
            "            f\"<Bucket>{getattr(settings, 'AWS_STORAGE_BUCKET_NAME')}</Bucket>\"",
            "            f\"<Key>{key}</Key>\"",
            "            f'<ETag>\"{etag}\"</ETag>'",
            "            \"</PostResponse>\",",
            "            status=success_action_status,",
            "        )"
        ],
        "afterPatchFile": [
            "import base64",
            "import hashlib",
            "import hmac",
            "import logging",
            "from pathlib import Path",
            "",
            "from django import http",
            "from django.conf import settings",
            "from django.core.files.storage import default_storage",
            "from django.views import generic",
            "",
            "logger = logging.getLogger(\"s3file\")",
            "",
            "",
            "class S3MockView(generic.View):",
            "    def post(self, request):",
            "        success_action_status = request.POST.get(\"success_action_status\", 201)",
            "        try:",
            "            file = request.FILES[\"file\"]",
            "            key = request.POST[\"key\"]",
            "            date = request.POST[\"x-amz-date\"]",
            "            signature = request.POST[\"x-amz-signature\"]",
            "            policy = request.POST[\"policy\"]",
            "        except KeyError:",
            "            logger.exception(\"bad request\")",
            "            return http.HttpResponseBadRequest()",
            "",
            "        try:",
            "            signature = base64.b64decode(signature.encode())",
            "            policy = base64.b64decode(policy.encode())",
            "",
            "            calc_sign = hmac.new(",
            "                settings.SECRET_KEY.encode(), policy + date.encode(), \"sha256\"",
            "            ).digest()",
            "        except ValueError:",
            "            logger.exception(\"bad request\")",
            "            return http.HttpResponseBadRequest()",
            "",
            "        if not hmac.compare_digest(signature, calc_sign):",
            "            logger.warning(\"bad signature\")",
            "            return http.HttpResponseForbidden()",
            "",
            "        key = key.replace(\"${filename}\", file.name)",
            "        etag = hashlib.md5(file.read()).hexdigest()  # nosec",
            "        file.seek(0)",
            "        key = default_storage.save(key, file)",
            "        return http.HttpResponse(",
            "            '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'",
            "            \"<PostResponse>\"",
            "            f\"<Location>{settings.MEDIA_URL}{key}</Location>\"",
            "            f\"<Bucket>{getattr(settings, 'AWS_STORAGE_BUCKET_NAME')}</Bucket>\"",
            "            f\"<Key>{key}</Key>\"",
            "            f'<ETag>\"{etag}\"</ETag>'",
            "            \"</PostResponse>\",",
            "            status=success_action_status,",
            "        )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": []
    }
}