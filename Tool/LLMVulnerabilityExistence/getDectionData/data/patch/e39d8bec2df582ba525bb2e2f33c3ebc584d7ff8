{
    "pollbot/middlewares.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " import logging"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from aiohttp import web"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import os"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+import string"
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " logger = logging.getLogger(__package__)"
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 61,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 62,
                "PatchRowcode": " async def handle_404(request, response):"
            },
            "9": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "     if 'json' not in response.headers['Content-Type']:"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        # This traling slash redirect has caused security issues."
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+        # If it continues to be problematic, consider:"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+        #  - only redirect \"/v1/.../\"?"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+        #  - remove the redirect entirely; use duplicate routes instead, in app.py"
            },
            "14": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "         if request.path.endswith('/'):"
            },
            "15": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return web.HTTPFound('/' + request.path.strip('/'))"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+            return web.HTTPFound('/' + request.path.strip('/'+string.whitespace))"
            },
            "17": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "         return web.json_response({"
            },
            "18": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "             \"status\": 404,"
            },
            "19": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "             \"message\": \"Page '{}' not found\".format(request.path)"
            }
        },
        "frontPatchFile": [
            "import logging",
            "from aiohttp import web",
            "import os",
            "",
            "logger = logging.getLogger(__package__)",
            "",
            "",
            "def setup_middlewares(app):",
            "    error_middleware = error_pages({404: handle_404,",
            "                                    500: handle_500})",
            "    app.middlewares.append(error_middleware)",
            "    app.middlewares.append(cache_control_middleware)",
            "",
            "",
            "# Cache-Control middleware",
            "CACHE_MAX_AGE = int(os.getenv(\"CACHE_MAX_AGE\", \"30\"))",
            "NO_CACHE_ENDPOINTS = ['/v1/', '/v1/__version__', '/v1/__heartbeat__', '/v1/__lbheartbeat__']",
            "",
            "",
            "async def cache_control_middleware(app, handler):",
            "    async def middleware_handler(request):",
            "        response = await handler(request)",
            "        cache_control_value = \"public; max-age={}\".format(CACHE_MAX_AGE)",
            "        if request.path in NO_CACHE_ENDPOINTS or CACHE_MAX_AGE <= 0:",
            "            cache_control_value = \"no-cache\"",
            "        response.headers.setdefault(\"Cache-Control\", cache_control_value)",
            "        return response",
            "    return middleware_handler",
            "",
            "",
            "# Error page middlewares",
            "def error_pages(overrides):",
            "    async def middleware(app, handler):",
            "        async def middleware_handler(request):",
            "            try:",
            "                response = await handler(request)",
            "                override = overrides.get(response.status)",
            "                if override is None:",
            "                    return response",
            "                else:",
            "                    return await override(request, response)",
            "            except web.HTTPException as ex:",
            "                override = overrides.get(ex.status)",
            "                if override is None:",
            "                    return await handle_any(request, ex)",
            "                else:",
            "                    return await override(request, ex)",
            "            except Exception as ex:",
            "                return await handle_500(request, error=ex)",
            "        return middleware_handler",
            "    return middleware",
            "",
            "",
            "async def handle_any(request, response):",
            "    return web.json_response({",
            "        \"status\": response.status,",
            "        \"message\": response.reason",
            "    }, status=response.status)",
            "",
            "",
            "async def handle_404(request, response):",
            "    if 'json' not in response.headers['Content-Type']:",
            "        if request.path.endswith('/'):",
            "            return web.HTTPFound('/' + request.path.strip('/'))",
            "        return web.json_response({",
            "            \"status\": 404,",
            "            \"message\": \"Page '{}' not found\".format(request.path)",
            "        }, status=404)",
            "    return response",
            "",
            "",
            "async def handle_500(request, response=None, error=None):",
            "    logger.exception(error)",
            "    return web.json_response({",
            "            \"status\": 503,",
            "            \"message\": \"Service currently unavailable\"",
            "        }, status=503)"
        ],
        "afterPatchFile": [
            "import logging",
            "from aiohttp import web",
            "import os",
            "import string",
            "",
            "logger = logging.getLogger(__package__)",
            "",
            "",
            "def setup_middlewares(app):",
            "    error_middleware = error_pages({404: handle_404,",
            "                                    500: handle_500})",
            "    app.middlewares.append(error_middleware)",
            "    app.middlewares.append(cache_control_middleware)",
            "",
            "",
            "# Cache-Control middleware",
            "CACHE_MAX_AGE = int(os.getenv(\"CACHE_MAX_AGE\", \"30\"))",
            "NO_CACHE_ENDPOINTS = ['/v1/', '/v1/__version__', '/v1/__heartbeat__', '/v1/__lbheartbeat__']",
            "",
            "",
            "async def cache_control_middleware(app, handler):",
            "    async def middleware_handler(request):",
            "        response = await handler(request)",
            "        cache_control_value = \"public; max-age={}\".format(CACHE_MAX_AGE)",
            "        if request.path in NO_CACHE_ENDPOINTS or CACHE_MAX_AGE <= 0:",
            "            cache_control_value = \"no-cache\"",
            "        response.headers.setdefault(\"Cache-Control\", cache_control_value)",
            "        return response",
            "    return middleware_handler",
            "",
            "",
            "# Error page middlewares",
            "def error_pages(overrides):",
            "    async def middleware(app, handler):",
            "        async def middleware_handler(request):",
            "            try:",
            "                response = await handler(request)",
            "                override = overrides.get(response.status)",
            "                if override is None:",
            "                    return response",
            "                else:",
            "                    return await override(request, response)",
            "            except web.HTTPException as ex:",
            "                override = overrides.get(ex.status)",
            "                if override is None:",
            "                    return await handle_any(request, ex)",
            "                else:",
            "                    return await override(request, ex)",
            "            except Exception as ex:",
            "                return await handle_500(request, error=ex)",
            "        return middleware_handler",
            "    return middleware",
            "",
            "",
            "async def handle_any(request, response):",
            "    return web.json_response({",
            "        \"status\": response.status,",
            "        \"message\": response.reason",
            "    }, status=response.status)",
            "",
            "",
            "async def handle_404(request, response):",
            "    if 'json' not in response.headers['Content-Type']:",
            "        # This traling slash redirect has caused security issues.",
            "        # If it continues to be problematic, consider:",
            "        #  - only redirect \"/v1/.../\"?",
            "        #  - remove the redirect entirely; use duplicate routes instead, in app.py",
            "        if request.path.endswith('/'):",
            "            return web.HTTPFound('/' + request.path.strip('/'+string.whitespace))",
            "        return web.json_response({",
            "            \"status\": 404,",
            "            \"message\": \"Page '{}' not found\".format(request.path)",
            "        }, status=404)",
            "    return response",
            "",
            "",
            "async def handle_500(request, response=None, error=None):",
            "    logger.exception(error)",
            "    return web.json_response({",
            "            \"status\": 503,",
            "            \"message\": \"Service currently unavailable\"",
            "        }, status=503)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "64": []
        },
        "addLocation": []
    }
}