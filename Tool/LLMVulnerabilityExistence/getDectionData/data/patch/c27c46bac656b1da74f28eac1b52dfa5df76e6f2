{
    "rdiffweb/controller/page_mfa.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "                     \"Multi-factor authentication is enabled for your account, but your account does not have a valid email address to send the verification code to. Check your account settings with your administrator.\""
            },
            "1": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "                 )"
            },
            "2": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": 107,
                "PatchRowcode": "             )"
            },
            "3": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        else:"
            },
            "4": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            code = cherrypy.tools.auth_mfa.generate_code()"
            },
            "5": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            body = self.app.templates.compile_template("
            },
            "6": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}"
            },
            "7": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            )"
            },
            "8": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)"
            },
            "9": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            flash(_(\"A new verification code has been sent to your email.\"))"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+            return"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+        code = cherrypy.tools.auth_mfa.generate_code()"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+        body = self.app.templates.compile_template("
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+        )"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+        flash(_(\"A new verification code has been sent to your email.\"))"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import BooleanField, StringField, SubmitField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.tools.auth_form import LOGIN_PERSISTENT",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class MfaForm(CherryForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        description=_('Enter the code to verify your identity.'),",
            "        render_kw={",
            "            \"class\": \"form-control-lg\",",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    persistent = BooleanField(",
            "        _('Remember me'),",
            "        default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),",
            "    )",
            "    submit = SubmitField(",
            "        _('Sign in'),",
            "        render_kw={\"class\": \"btn-primary btn-lg btn-block\"},",
            "    )",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link btn-sm btn-block\"},",
            "    )",
            "",
            "    def validate_code(self, field):",
            "        # Code is required when submit.",
            "        if self.submit.data:",
            "            if not self.code.data:",
            "                raise ValueError(_('Invalid verification code.'))",
            "            # Validate verification code.",
            "            if not cherrypy.tools.auth_mfa.verify_code(code=self.code.data, persistent=self.persistent.data):",
            "                raise ValueError(_('Invalid verification code.'))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.submit.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class MfaPage(Controller):",
            "    @cherrypy.expose()",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def index(self, **kwargs):",
            "        form = MfaForm()",
            "",
            "        # Validate MFA",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.submit.data:",
            "                    cherrypy.tools.auth_mfa.redirect_to_original_url()",
            "                elif form.resend_code.data:",
            "                    self.send_code()",
            "        if cherrypy.tools.auth_mfa.is_code_expired():",
            "            # Send verification code if previous code expired.",
            "            self.send_code()",
            "        params = {",
            "            'form': form,",
            "        }",
            "        # Add welcome message to params. Try to load translated message.",
            "        welcome_msg = self.app.cfg.welcome_msg",
            "        if welcome_msg:",
            "            params[\"welcome_msg\"] = welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = welcome_msg.get(locale, params[\"welcome_msg\"])",
            "        return self._compile_template(\"mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        # Send verification code by email",
            "        userobj = cherrypy.serving.request.currentuser",
            "        if not userobj.email:",
            "            flash(",
            "                _(",
            "                    \"Multi-factor authentication is enabled for your account, but your account does not have a valid email address to send the verification code to. Check your account settings with your administrator.\"",
            "                )",
            "            )",
            "        else:",
            "            code = cherrypy.tools.auth_mfa.generate_code()",
            "            body = self.app.templates.compile_template(",
            "                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "            )",
            "            cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "            flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import BooleanField, StringField, SubmitField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.tools.auth_form import LOGIN_PERSISTENT",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class MfaForm(CherryForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        description=_('Enter the code to verify your identity.'),",
            "        render_kw={",
            "            \"class\": \"form-control-lg\",",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    persistent = BooleanField(",
            "        _('Remember me'),",
            "        default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),",
            "    )",
            "    submit = SubmitField(",
            "        _('Sign in'),",
            "        render_kw={\"class\": \"btn-primary btn-lg btn-block\"},",
            "    )",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link btn-sm btn-block\"},",
            "    )",
            "",
            "    def validate_code(self, field):",
            "        # Code is required when submit.",
            "        if self.submit.data:",
            "            if not self.code.data:",
            "                raise ValueError(_('Invalid verification code.'))",
            "            # Validate verification code.",
            "            if not cherrypy.tools.auth_mfa.verify_code(code=self.code.data, persistent=self.persistent.data):",
            "                raise ValueError(_('Invalid verification code.'))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.submit.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class MfaPage(Controller):",
            "    @cherrypy.expose()",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def index(self, **kwargs):",
            "        form = MfaForm()",
            "",
            "        # Validate MFA",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.submit.data:",
            "                    cherrypy.tools.auth_mfa.redirect_to_original_url()",
            "                elif form.resend_code.data:",
            "                    self.send_code()",
            "        if cherrypy.tools.auth_mfa.is_code_expired():",
            "            # Send verification code if previous code expired.",
            "            self.send_code()",
            "        params = {",
            "            'form': form,",
            "        }",
            "        # Add welcome message to params. Try to load translated message.",
            "        welcome_msg = self.app.cfg.welcome_msg",
            "        if welcome_msg:",
            "            params[\"welcome_msg\"] = welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = welcome_msg.get(locale, params[\"welcome_msg\"])",
            "        return self._compile_template(\"mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        # Send verification code by email",
            "        userobj = cherrypy.serving.request.currentuser",
            "        if not userobj.email:",
            "            flash(",
            "                _(",
            "                    \"Multi-factor authentication is enabled for your account, but your account does not have a valid email address to send the verification code to. Check your account settings with your administrator.\"",
            "                )",
            "            )",
            "            return",
            "        code = cherrypy.tools.auth_mfa.generate_code()",
            "        body = self.app.templates.compile_template(",
            "            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "        )",
            "        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "        flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "108": [
                "MfaPage",
                "send_code"
            ],
            "109": [
                "MfaPage",
                "send_code"
            ],
            "110": [
                "MfaPage",
                "send_code"
            ],
            "111": [
                "MfaPage",
                "send_code"
            ],
            "112": [
                "MfaPage",
                "send_code"
            ],
            "113": [
                "MfaPage",
                "send_code"
            ],
            "114": [
                "MfaPage",
                "send_code"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_pref_mfa.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "             return"
            },
            "1": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": 127,
                "PatchRowcode": "         code = cherrypy.tools.auth_mfa.generate_code()"
            },
            "2": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 128,
                "PatchRowcode": "         body = self.app.templates.compile_template("
            },
            "3": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}"
            },
            "5": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": 130,
                "PatchRowcode": "         )"
            },
            "6": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": 131,
                "PatchRowcode": "         cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)"
            },
            "7": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": 132,
                "PatchRowcode": "         flash(_(\"A new verification code has been sent to your email.\"))"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms.fields import SelectField, StringField, SubmitField",
            "from wtforms.widgets import HiddenInput",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class AbstractMfaForm(CherryForm):",
            "    def __init__(self, obj, **kwargs):",
            "        assert obj",
            "        super().__init__(obj=obj, **kwargs)",
            "        # Keep only one of the enable or disable button",
            "        if obj.mfa:",
            "            self.enable_mfa.widget = HiddenInput()",
            "            self.enable_mfa.data = ''",
            "        else:",
            "            self.disable_mfa.widget = HiddenInput()",
            "            self.disable_mfa.data = ''",
            "",
            "",
            "class MfaStatusForm(AbstractMfaForm):",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA) Status'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        render_kw={'readonly': True, 'disabled': True, 'data-beta': '1'},",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "",
            "",
            "class MfaToggleForm(AbstractMfaForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        render_kw={",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link\"},",
            "    )",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def populate_obj(self, userobj):",
            "        # Enable or disable MFA only when a code is provided.",
            "        if self.enable_mfa.data:",
            "            userobj.mfa = UserObject.ENABLED_MFA",
            "            flash(_(\"Two-Factor authentication enabled successfully.\"), level='success')",
            "        elif self.disable_mfa.data:",
            "            userobj.mfa = UserObject.DISABLED_MFA",
            "            flash(_(\"Two-Factor authentication disabled successfully.\"), level='success')",
            "",
            "    def validate_code(self, field):",
            "        # Code is required for enable_mfa and disable_mfa",
            "        if self.enable_mfa.data or self.disable_mfa.data:",
            "            if not self.code.data:",
            "                raise ValueError(_(\"Enter the verification code to continue.\"))",
            "            # Validate code",
            "            if not cherrypy.tools.auth_mfa.verify_code(self.code.data, False):",
            "                raise ValueError(_(\"Invalid verification code.\"))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.enable_mfa.data or self.disable_mfa.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class PagePrefMfa(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        form = MfaToggleForm(obj=self.app.currentuser)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.resend_code.data:",
            "                    self.send_code()",
            "                elif form.enable_mfa.data or form.disable_mfa.data:",
            "                    form.populate_obj(self.app.currentuser)",
            "                    form = MfaStatusForm(obj=self.app.currentuser)",
            "            # Send verification code if previous code expired.",
            "            elif cherrypy.tools.auth_mfa.is_code_expired():",
            "                self.send_code()",
            "        else:",
            "            form = MfaStatusForm(obj=self.app.currentuser)",
            "        params = {",
            "            'form': form,",
            "        }",
            "        return self._compile_template(\"prefs_mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        userobj = self.app.currentuser",
            "        if not userobj.email:",
            "            flash(_(\"To continue, you must set up an email address for your account.\"), level='warning')",
            "            return",
            "        code = cherrypy.tools.auth_mfa.generate_code()",
            "        body = self.app.templates.compile_template(",
            "            \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "        )",
            "        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "        flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms.fields import SelectField, StringField, SubmitField",
            "from wtforms.widgets import HiddenInput",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class AbstractMfaForm(CherryForm):",
            "    def __init__(self, obj, **kwargs):",
            "        assert obj",
            "        super().__init__(obj=obj, **kwargs)",
            "        # Keep only one of the enable or disable button",
            "        if obj.mfa:",
            "            self.enable_mfa.widget = HiddenInput()",
            "            self.enable_mfa.data = ''",
            "        else:",
            "            self.disable_mfa.widget = HiddenInput()",
            "            self.disable_mfa.data = ''",
            "",
            "",
            "class MfaStatusForm(AbstractMfaForm):",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA) Status'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        render_kw={'readonly': True, 'disabled': True, 'data-beta': '1'},",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "",
            "",
            "class MfaToggleForm(AbstractMfaForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        render_kw={",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link\"},",
            "    )",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def populate_obj(self, userobj):",
            "        # Enable or disable MFA only when a code is provided.",
            "        if self.enable_mfa.data:",
            "            userobj.mfa = UserObject.ENABLED_MFA",
            "            flash(_(\"Two-Factor authentication enabled successfully.\"), level='success')",
            "        elif self.disable_mfa.data:",
            "            userobj.mfa = UserObject.DISABLED_MFA",
            "            flash(_(\"Two-Factor authentication disabled successfully.\"), level='success')",
            "",
            "    def validate_code(self, field):",
            "        # Code is required for enable_mfa and disable_mfa",
            "        if self.enable_mfa.data or self.disable_mfa.data:",
            "            if not self.code.data:",
            "                raise ValueError(_(\"Enter the verification code to continue.\"))",
            "            # Validate code",
            "            if not cherrypy.tools.auth_mfa.verify_code(self.code.data, False):",
            "                raise ValueError(_(\"Invalid verification code.\"))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.enable_mfa.data or self.disable_mfa.data or self.resend_code.data):",
            "            raise ValueError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class PagePrefMfa(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        form = MfaToggleForm(obj=self.app.currentuser)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.resend_code.data:",
            "                    self.send_code()",
            "                elif form.enable_mfa.data or form.disable_mfa.data:",
            "                    form.populate_obj(self.app.currentuser)",
            "                    form = MfaStatusForm(obj=self.app.currentuser)",
            "            # Send verification code if previous code expired.",
            "            elif cherrypy.tools.auth_mfa.is_code_expired():",
            "                self.send_code()",
            "        else:",
            "            form = MfaStatusForm(obj=self.app.currentuser)",
            "        params = {",
            "            'form': form,",
            "        }",
            "        return self._compile_template(\"prefs_mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        userobj = self.app.currentuser",
            "        if not userobj.email:",
            "            flash(_(\"To continue, you must set up an email address for your account.\"), level='warning')",
            "            return",
            "        code = cherrypy.tools.auth_mfa.generate_code()",
            "        body = self.app.templates.compile_template(",
            "            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "        )",
            "        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "        flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "129": [
                "PagePrefMfa",
                "send_code"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_prefs_mfa.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " # You should have received a copy of the GNU General Public License"
            },
            "1": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " # along with this program.  If not, see <http://www.gnu.org/licenses/>."
            },
            "2": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from unittest.mock import MagicMock"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 18,
                "PatchRowcode": "+from unittest.mock import ANY, MagicMock"
            },
            "5": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " import cherrypy"
            },
            "7": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from parameterized import parameterized"
            },
            "8": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "         userobj = UserObject.get_user(self.USERNAME)"
            },
            "9": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "         userobj.email = 'admin@example.com'"
            },
            "10": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "         userobj.add()"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+        # Register a listener on email"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+        self.listener = MagicMock()"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    def tearDown(self):"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+        return super().tearDown()"
            },
            "18": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 44,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "     def _set_mfa(self, mfa):"
            },
            "20": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "         # Define mfa for user"
            },
            "21": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "         userobj = UserObject.get_user(self.USERNAME)"
            },
            "22": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "         userobj.mfa = mfa"
            },
            "23": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "         userobj.add()"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+        # Reset mock."
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+        self.listener.queue_email.reset_mock()"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+        # Leave to disable mfa"
            },
            "27": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "         if mfa == UserObject.DISABLED_MFA:"
            },
            "28": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "             return"
            },
            "29": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "         # Generate a code for login if required"
            },
            "30": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.listener = MagicMock()"
            },
            "31": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)"
            },
            "32": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        try:"
            },
            "33": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage(\"/mfa/\")"
            },
            "34": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertStatus(200)"
            },
            "35": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertInBody(\"A new verification code has been sent to your email.\")"
            },
            "36": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # Extract code from email between <strong> and </strong>"
            },
            "37": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.listener.queue_email.assert_called_once()"
            },
            "38": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = self.listener.queue_email.call_args[1]['message']"
            },
            "39": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            code = message.split('<strong>', 1)[1].split('</strong>')[0]"
            },
            "40": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # Login to MFA"
            },
            "41": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage(\"/mfa/\", method='POST', body={'code': code, 'submit': '1'})"
            },
            "42": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertStatus(303)"
            },
            "43": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        finally:"
            },
            "44": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+        self.getPage(\"/mfa/\")"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+        self.assertInBody(\"A new verification code has been sent to your email.\")"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+        # Extract code from email between <strong> and </strong>"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+        self.listener.queue_email.assert_called_once()"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+        message = self.listener.queue_email.call_args[1]['message']"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+        code = message.split('<strong>', 1)[1].split('</strong>')[0]"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+        # Login to MFA"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        self.getPage(\"/mfa/\", method='POST', body={'code': code, 'submit': '1'})"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+        self.assertStatus(303)"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+        # Clear mock."
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+        self.listener.queue_email.reset_mock()"
            },
            "57": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 68,
                "PatchRowcode": " "
            },
            "58": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "     def _get_code(self, action):"
            },
            "59": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "         assert action in ['enable_mfa', 'disable_mfa', 'resend_code']"
            },
            "60": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Register an email listeer to capture email send"
            },
            "61": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.listener = MagicMock()"
            },
            "62": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)"
            },
            "63": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "         # Query MFA page to generate a code"
            },
            "64": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        try:"
            },
            "65": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.getPage(\"/prefs/mfa\", method='POST', body={action: '1'})"
            },
            "66": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertStatus(200)"
            },
            "67": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertInBody(\"A new verification code has been sent to your email.\")"
            },
            "68": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # Extract code from email between <strong> and </strong>"
            },
            "69": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.listener.queue_email.assert_called_once()"
            },
            "70": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message = self.listener.queue_email.call_args[1]['message']"
            },
            "71": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return message.split('<strong>', 1)[1].split('</strong>')[0]"
            },
            "72": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        finally:"
            },
            "73": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1'})"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+        self.assertInBody(\"A new verification code has been sent to your email.\")"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+        # Extract code from email between <strong> and </strong>"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 76,
                "PatchRowcode": "+        self.listener.queue_email.assert_called_once()"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+        message = self.listener.queue_email.call_args[1]['message']"
            },
            "80": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 78,
                "PatchRowcode": "+        self.listener.queue_email.reset_mock()"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+        return message.split('<strong>', 1)[1].split('</strong>')[0]"
            },
            "82": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 80,
                "PatchRowcode": " "
            },
            "83": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "     def test_get(self):"
            },
            "84": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "         # When getting the page"
            },
            "85": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 86,
                "PatchRowcode": " "
            },
            "86": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "     @parameterized.expand("
            },
            "87": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "         ["
            },
            "88": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            ('enable_mfa', UserObject.DISABLED_MFA, UserObject.ENABLED_MFA),"
            },
            "89": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            ('disable_mfa', UserObject.ENABLED_MFA, UserObject.DISABLED_MFA),"
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+            ('enable_mfa', UserObject.DISABLED_MFA, UserObject.ENABLED_MFA, \"Two-Factor Authentication turned on\"),"
            },
            "91": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+            ('disable_mfa', UserObject.ENABLED_MFA, UserObject.DISABLED_MFA, \"Two-Factor Authentication turned off\"),"
            },
            "92": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "         ]"
            },
            "93": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "     )"
            },
            "94": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_with_valid_code(self, action, initial_mfa, expected_mfa):"
            },
            "95": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+    def test_with_valid_code(self, action, initial_mfa, expected_mfa, expected_subject):"
            },
            "96": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "         # Define mfa for user"
            },
            "97": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         self._set_mfa(initial_mfa)"
            },
            "98": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "         # Given a user with email requesting a code"
            },
            "99": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "100": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "         userobj = UserObject.get_user(self.USERNAME)"
            },
            "101": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 103,
                "PatchRowcode": "         self.assertEqual(userobj.mfa, expected_mfa)"
            },
            "102": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Then no email get sent"
            },
            "103": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+        # Then no verification code get sent"
            },
            "104": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "         self.assertNotInBody(\"A new verification code has been sent to your email.\")"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+        # Then an email confirmation get send"
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+        self.listener.queue_email.assert_called_once_with(to=ANY, subject=expected_subject, message=ANY)"
            },
            "107": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 108,
                "PatchRowcode": "         # Then next page request is still working."
            },
            "108": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 109,
                "PatchRowcode": "         self.getPage('/')"
            },
            "109": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 110,
                "PatchRowcode": "         self.assertStatus(200)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class PagePrefMfaTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        # Define email for all test",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = 'admin@example.com'",
            "        userobj.add()",
            "",
            "    def _set_mfa(self, mfa):",
            "        # Define mfa for user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.mfa = mfa",
            "        userobj.add()",
            "        if mfa == UserObject.DISABLED_MFA:",
            "            return",
            "        # Generate a code for login if required",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        try:",
            "            self.getPage(\"/mfa/\")",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"A new verification code has been sent to your email.\")",
            "            # Extract code from email between <strong> and </strong>",
            "            self.listener.queue_email.assert_called_once()",
            "            message = self.listener.queue_email.call_args[1]['message']",
            "            code = message.split('<strong>', 1)[1].split('</strong>')[0]",
            "            # Login to MFA",
            "            self.getPage(\"/mfa/\", method='POST', body={'code': code, 'submit': '1'})",
            "            self.assertStatus(303)",
            "        finally:",
            "            cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "",
            "    def _get_code(self, action):",
            "        assert action in ['enable_mfa', 'disable_mfa', 'resend_code']",
            "        # Register an email listeer to capture email send",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        # Query MFA page to generate a code",
            "        try:",
            "            self.getPage(\"/prefs/mfa\", method='POST', body={action: '1'})",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"A new verification code has been sent to your email.\")",
            "            # Extract code from email between <strong> and </strong>",
            "            self.listener.queue_email.assert_called_once()",
            "            message = self.listener.queue_email.call_args[1]['message']",
            "            return message.split('<strong>', 1)[1].split('</strong>')[0]",
            "        finally:",
            "            cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "",
            "    def test_get(self):",
            "        # When getting the page",
            "        self.getPage(\"/prefs/mfa\")",
            "        # Then the page is return without error",
            "        self.assertStatus(200)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('enable_mfa', UserObject.DISABLED_MFA, UserObject.ENABLED_MFA),",
            "            ('disable_mfa', UserObject.ENABLED_MFA, UserObject.DISABLED_MFA),",
            "        ]",
            "    )",
            "    def test_with_valid_code(self, action, initial_mfa, expected_mfa):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # Given a user with email requesting a code",
            "        code = self._get_code(action=action)",
            "        # When sending a valid code",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1', 'code': code})",
            "        # Then mfa get enabled or disable accordingly",
            "        self.assertStatus(200)",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertEqual(userobj.mfa, expected_mfa)",
            "        # Then no email get sent",
            "        self.assertNotInBody(\"A new verification code has been sent to your email.\")",
            "        # Then next page request is still working.",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('enable_mfa', UserObject.DISABLED_MFA, UserObject.DISABLED_MFA),",
            "            ('disable_mfa', UserObject.ENABLED_MFA, UserObject.ENABLED_MFA),",
            "        ]",
            "    )",
            "    def test_with_invalid_code(self, action, initial_mfa, expected_mfa):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # Given a user with email requesting a code",
            "        self._get_code(action=action)",
            "        # When sending an invalid code",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1', 'code': '1234567'})",
            "        # Then mfa get enabled or disable accordingly",
            "        self.assertStatus(200)",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertEqual(userobj.mfa, expected_mfa)",
            "        # Then next page request is still working.",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('enable_mfa', UserObject.DISABLED_MFA),",
            "            ('disable_mfa', UserObject.ENABLED_MFA),",
            "        ]",
            "    )",
            "    def test_without_email(self, action, initial_mfa):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # Given a user without email requesting a code",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = ''",
            "        userobj.add()",
            "        # When trying to enable or disable mfa",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1'})",
            "        # Then an error is return to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"To continue, you must set up an email address for your account.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            (UserObject.DISABLED_MFA,),",
            "            (UserObject.ENABLED_MFA,),",
            "        ]",
            "    )",
            "    def test_resend_code(self, initial_mfa):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # When requesting a new code.",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={'resend_code': '1'})",
            "        # Then a new code get sent.",
            "        self.assertInBody(\"A new verification code has been sent to your email.\")"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "from unittest.mock import ANY, MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import UserObject",
            "",
            "",
            "class PagePrefMfaTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        # Define email for all test",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = 'admin@example.com'",
            "        userobj.add()",
            "        # Register a listener on email",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def _set_mfa(self, mfa):",
            "        # Define mfa for user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.mfa = mfa",
            "        userobj.add()",
            "        # Reset mock.",
            "        self.listener.queue_email.reset_mock()",
            "        # Leave to disable mfa",
            "        if mfa == UserObject.DISABLED_MFA:",
            "            return",
            "        # Generate a code for login if required",
            "        self.getPage(\"/mfa/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"A new verification code has been sent to your email.\")",
            "        # Extract code from email between <strong> and </strong>",
            "        self.listener.queue_email.assert_called_once()",
            "        message = self.listener.queue_email.call_args[1]['message']",
            "        code = message.split('<strong>', 1)[1].split('</strong>')[0]",
            "        # Login to MFA",
            "        self.getPage(\"/mfa/\", method='POST', body={'code': code, 'submit': '1'})",
            "        self.assertStatus(303)",
            "        # Clear mock.",
            "        self.listener.queue_email.reset_mock()",
            "",
            "    def _get_code(self, action):",
            "        assert action in ['enable_mfa', 'disable_mfa', 'resend_code']",
            "        # Query MFA page to generate a code",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1'})",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"A new verification code has been sent to your email.\")",
            "        # Extract code from email between <strong> and </strong>",
            "        self.listener.queue_email.assert_called_once()",
            "        message = self.listener.queue_email.call_args[1]['message']",
            "        self.listener.queue_email.reset_mock()",
            "        return message.split('<strong>', 1)[1].split('</strong>')[0]",
            "",
            "    def test_get(self):",
            "        # When getting the page",
            "        self.getPage(\"/prefs/mfa\")",
            "        # Then the page is return without error",
            "        self.assertStatus(200)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('enable_mfa', UserObject.DISABLED_MFA, UserObject.ENABLED_MFA, \"Two-Factor Authentication turned on\"),",
            "            ('disable_mfa', UserObject.ENABLED_MFA, UserObject.DISABLED_MFA, \"Two-Factor Authentication turned off\"),",
            "        ]",
            "    )",
            "    def test_with_valid_code(self, action, initial_mfa, expected_mfa, expected_subject):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # Given a user with email requesting a code",
            "        code = self._get_code(action=action)",
            "        # When sending a valid code",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1', 'code': code})",
            "        # Then mfa get enabled or disable accordingly",
            "        self.assertStatus(200)",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertEqual(userobj.mfa, expected_mfa)",
            "        # Then no verification code get sent",
            "        self.assertNotInBody(\"A new verification code has been sent to your email.\")",
            "        # Then an email confirmation get send",
            "        self.listener.queue_email.assert_called_once_with(to=ANY, subject=expected_subject, message=ANY)",
            "        # Then next page request is still working.",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('enable_mfa', UserObject.DISABLED_MFA, UserObject.DISABLED_MFA),",
            "            ('disable_mfa', UserObject.ENABLED_MFA, UserObject.ENABLED_MFA),",
            "        ]",
            "    )",
            "    def test_with_invalid_code(self, action, initial_mfa, expected_mfa):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # Given a user with email requesting a code",
            "        self._get_code(action=action)",
            "        # When sending an invalid code",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1', 'code': '1234567'})",
            "        # Then mfa get enabled or disable accordingly",
            "        self.assertStatus(200)",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertEqual(userobj.mfa, expected_mfa)",
            "        # Then next page request is still working.",
            "        self.getPage('/')",
            "        self.assertStatus(200)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            ('enable_mfa', UserObject.DISABLED_MFA),",
            "            ('disable_mfa', UserObject.ENABLED_MFA),",
            "        ]",
            "    )",
            "    def test_without_email(self, action, initial_mfa):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # Given a user without email requesting a code",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = ''",
            "        userobj.add()",
            "        # When trying to enable or disable mfa",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={action: '1'})",
            "        # Then an error is return to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"To continue, you must set up an email address for your account.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            (UserObject.DISABLED_MFA,),",
            "            (UserObject.ENABLED_MFA,),",
            "        ]",
            "    )",
            "    def test_resend_code(self, initial_mfa):",
            "        # Define mfa for user",
            "        self._set_mfa(initial_mfa)",
            "        # When requesting a new code.",
            "        self.getPage(\"/prefs/mfa\", method='POST', body={'resend_code': '1'})",
            "        # Then a new code get sent.",
            "        self.assertInBody(\"A new verification code has been sent to your email.\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "18": [],
            "46": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "47": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "48": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "49": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "50": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "51": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "52": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "53": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "54": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "55": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "56": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "57": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "58": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "59": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "60": [
                "PagePrefMfaTest",
                "_set_mfa"
            ],
            "64": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "65": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "66": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "68": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "69": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "70": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "71": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "72": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "73": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "74": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "75": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "76": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "77": [
                "PagePrefMfaTest",
                "_get_code"
            ],
            "87": [
                "PagePrefMfaTest"
            ],
            "88": [
                "PagePrefMfaTest"
            ],
            "91": [
                "PagePrefMfaTest",
                "test_with_valid_code"
            ],
            "102": [
                "PagePrefMfaTest",
                "test_with_valid_code"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/config.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": 159,
                "PatchRowcode": "         '--emailsendchangednotification',"
            },
            "1": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 160,
                "PatchRowcode": "         help='True to send notification when sensitive information get change in user profile.',"
            },
            "2": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 161,
                "PatchRowcode": "         action='store_true',"
            },
            "3": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        default=False,"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+        default=True,"
            },
            "5": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": 163,
                "PatchRowcode": "     )"
            },
            "6": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": 164,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": 165,
                "PatchRowcode": "     parser.add_argument("
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import argparse",
            "import logging",
            "import re",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import configargparse",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Get rdiffweb version.",
            "try:",
            "    VERSION = pkg_resources.get_distribution(\"rdiffweb\").version",
            "except pkg_resources.DistributionNotFound:",
            "    VERSION = \"DEV\"",
            "",
            "",
            "def get_parser():",
            "    # Get global config argument parser",
            "    parser = configargparse.ArgumentParser(",
            "        prog='rdiffweb',",
            "        description='Web interface to browse and restore rdiff-backup repositories.',",
            "        default_config_files=['/etc/rdiffweb/rdw.conf', '/etc/rdiffweb/rdw.conf.d/*.conf'],",
            "        add_env_var_help=True,",
            "        auto_env_var_prefix='RDIFFWEB_',",
            "        config_file_parser_class=ConfigFileParser,",
            "        conflict_handler='resolve',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-f', '--config', is_config_file=True, metavar='FILE', help='location of Rdiffweb configuration file'",
            "    )",
            "",
            "    parser.add(",
            "        '--database-uri',",
            "        '--sqlitedb-file',",
            "        '--sqlitedbfile',",
            "        metavar='URI',",
            "        help=\"\"\"Location of the database used for persistence. SQLite and PostgreSQL",
            "            database are supported officially. To use a SQLite database you may",
            "            define the location using a file path or a URI.",
            "            e.g.: /srv/rdiffweb/file.db or sqlite:///srv/rdiffweb/file.db`.",
            "            To use PostgreSQL server you must provide",
            "            a URI similar to postgresql://user:pass@10.255.1.34/dbname and you",
            "            must install required dependencies.",
            "            By default, Rdiffweb uses a SQLite embedded database located at",
            "            /etc/rdiffweb/rdw.db.\"\"\",",
            "        default='/etc/rdiffweb/rdw.db',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-d',",
            "        '--debug',",
            "        action='store_true',",
            "        help='enable rdiffweb debug mode - change the log level to DEBUG, print exception stack trace to the web interface and show SQL query in logs',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-user',",
            "        '--adminuser',",
            "        metavar='USERNAME',",
            "        help='administrator username. The administrator user get created on startup if the database is empty.',",
            "        default='admin',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-password',",
            "        metavar='USERNAME',",
            "        help=\"\"\"administrator encrypted password as SSHA. Read online",
            "            documentation to know more about how to encrypt your password",
            "            into SSHA or use http://projects.marsching.org/weave4j/util/genpassword.php",
            "            When defined, administrator password cannot be updated using the web interface.",
            "            When undefined, default administrator password is `admin123` and",
            "            it can be updated using the web interface.\"\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--default-theme',",
            "        '--defaulttheme',",
            "        help='define the default theme. Either: default, blue or orange. Define the CSS file to be loaded in the web interface. You may manually edit a CSS file to customize it. The location is similar to `/usr/local/lib/python3.9/dist-packages/rdiffweb/static/`',",
            "        choices=['default', 'blue', 'orange'],",
            "        default='default',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--environment',",
            "        choices=['development', 'production'],",
            "        help='define the type of environment: development, production. This is used to limit the information shown to the user when an error occur.',",
            "        default='production',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-encryption',",
            "        '--emailencryption',",
            "        choices=['none', 'ssl', 'starttls'],",
            "        help='type of encryption to be used when establishing communication with SMTP server. Default: none',",
            "        default='none',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-host',",
            "        '--emailhost',",
            "        metavar='HOST',",
            "        help='SMTP server used to send email in the form <host>:<port>. If the port is not provided, default to standard port 25 or 465 is used. e.g.: smtp.gmail.com:587',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-sender',",
            "        '--emailsender',",
            "        metavar='EMAIL',",
            "        help='email addres used for the `from:` field when sending email.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-notification-time',",
            "        '--emailnotificationtime',",
            "        metavar='TIME',",
            "        help='time when the email notifcation should be sent for inactive backups. e.g.: 22:00 Default value: 23:00',",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-username',",
            "        '--emailusername',",
            "        metavar='USERNAME',",
            "        help='username used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-password',",
            "        '--emailpassword',",
            "        metavar='PASSWORD',",
            "        help='password used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-send-changed-notification',",
            "        '--emailsendchangednotification',",
            "        help='True to send notification when sensitive information get change in user profile.',",
            "        action='store_true',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--favicon',",
            "        help='location of an icon to be used as a favicon displayed in web browser.',",
            "        default=pkg_resources.resource_filename('rdiffweb', 'static/favicon.ico'),",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-name', '--footername', help=argparse.SUPPRESS, default='rdiffweb'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-url', '--footerurl', help=argparse.SUPPRESS, default='https://rdiffweb.org/'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--header-logo',",
            "        '--headerlogo',",
            "        help='location of an image (preferably a .png) to be used as a replacement for the rdiffweb logo.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--header-name',",
            "        '--headername',",
            "        help='application name displayed in the title bar and header menu.',",
            "        default='Rdiffweb',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-missing-user',",
            "        '--addmissinguser',",
            "        action='store_true',",
            "        help='enable creation of users from LDAP when the credential are valid.',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-role',",
            "        help='default role used when creating users from LDAP. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='user',",
            "        choices=['admin', 'maintainer', 'user'],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-userroot',",
            "        help='default user root directory used when creating users from LDAP. LDAP attributes may be used to define the default location. e.g.: `/backups/{uid[0]}/`. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-uri',",
            "        '--ldapuri',",
            "        help='URL to the LDAP server used to validate user credentials. e.g.: ldap://localhost:389',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-base-dn',",
            "        '--ldapbasedn',",
            "        metavar='DN',",
            "        help='DN of the branch of the directory where all searches should start from. e.g.: dc=my,dc=domain',",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-scope',",
            "        '--ldapscope',",
            "        help='scope of the search. Can be either base, onelevel or subtree',",
            "        choices=['base', 'onelevel', 'subtree'],",
            "        default=\"subtree\",",
            "    )",
            "",
            "    parser.add_argument('--ldap-tls', '--ldaptls', action='store_true', help='enable TLS')",
            "",
            "    parser.add_argument(",
            "        '--ldap-username-attribute',",
            "        '--ldapattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"The attribute to search username. If no attributes are provided, the default is to use `uid`. It's a good idea to choose an attribute that will be unique across all entries in the subtree you will be using.\",",
            "        default='uid',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-filter',",
            "        '--ldapfilter',",
            "        help=\"search filter to limit LDAP lookup. If not provided, defaults to (objectClass=*), which searches for all objects in the tree.\",",
            "        default='(objectClass=*)',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-required-group',",
            "        '--ldaprequiredgroup',",
            "        metavar='GROUPNAME',",
            "        help=\"name of the group of which the user must be a member to access rdiffweb. Should be used with ldap-group-attribute and ldap-group-attribute-is-dn.\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute',",
            "        '--ldapgroupattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"name of the attribute defining the groups of which the user is a member. Should be used with ldap-required-group and ldap-group-attribute-is-dn.\",",
            "        default='member',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute-is-dn',",
            "        '--ldapgroupattributeisdn',",
            "        help=\"True if the content of the attribute `ldap-group-attribute` is a DN.\",",
            "        action='store_true',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-dn',",
            "        '--ldapbinddn',",
            "        metavar='DN',",
            "        help=\"optional DN used to bind to the server when searching for entries. If not provided, will use an anonymous bind.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-password',",
            "        '--ldapbindpassword',",
            "        metavar='PASSWORD',",
            "        help=\"password to use in conjunction with LdapBindDn. Note that the bind password is probably sensitive data, and should be properly protected. You should only use the LdapBindDn and LdapBindPassword if you absolutely need them to search the directory.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-version',",
            "        '--ldapversion',",
            "        '--ldapprotocolversion',",
            "        help=\"version of LDAP in use either 2 or 3. Default to 3.\",",
            "        default=3,",
            "        type=int,",
            "        choices=[2, 3],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-network-timeout',",
            "        '--ldapnetworktimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP connection\",",
            "        default=100,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-timeout',",
            "        '--ldaptimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP request\",",
            "        default=300,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-encoding',",
            "        '--ldapencoding',",
            "        metavar='ENCODING',",
            "        help=\"encoding used by your LDAP server.\",",
            "        default=\"utf-8\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-access-file', '--logaccessfile', metavar='FILE', help='location of Rdiffweb log access file.'",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-file',",
            "        '--logfile',",
            "        metavar='FILE',",
            "        help='location of Rdiffweb log file. Print log to the console if not define in config file.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-level',",
            "        '--loglevel',",
            "        help='Define the log level.',",
            "        choices=['ERROR', 'WARN', 'INFO', 'DEBUG'],",
            "        default='INFO',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--max-depth',",
            "        '--maxdepth',",
            "        metavar='DEPTH',",
            "        help=\"define the maximum folder depthness to search into the user's root directory to find repositories. This is commonly used if you repositories are organised with multiple sub-folder.\",",
            "        type=int,",
            "        default=3,",
            "    )",
            "",
            "    parser.add('--quota-set-cmd', '--quotasetcmd', metavar='COMMAND', help=\"command line to set the user's quota.\")",
            "",
            "    parser.add('--quota-get-cmd', '--quotagetcmd', metavar='COMMAND', help=\"command line to get the user's quota.\")",
            "",
            "    parser.add(",
            "        '--quota-used-cmd', '--quotausedcmd', metavar='COMMAND', help=\"Command line to get user's quota disk usage.\"",
            "    )",
            "",
            "    parser.add(",
            "        '--remove-older-time',",
            "        '--removeoldertime',",
            "        metavar='TIME',",
            "        help=\"Time when to execute the remove older scheduled job. e.g.: 22:30\",",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add('--server-host', '--serverhost', metavar='IP', default='127.0.0.1', help='IP address to listen to')",
            "",
            "    parser.add(",
            "        '--server-port',",
            "        '--serverport',",
            "        metavar='PORT',",
            "        help='port to listen to for HTTP request',",
            "        default='8080',",
            "        type=int,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit-dir',",
            "        '--session-dir',",
            "        '--sessiondir',",
            "        metavar='FOLDER',",
            "        help='location where to store rate-limit information. When undefined, the data is kept in memory. `--session-dir` are deprecated and kept for backward compatibility.',",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit',",
            "        metavar='LIMIT',",
            "        type=int,",
            "        default=20,",
            "        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API.',",
            "    )",
            "",
            "    parser.add(",
            "        '--session-idle-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the amount of time a session will remain active in case there is no activity in the session. User Session will be revoke after this period of inactivity, unless the user selected \"remember me\". Default 5 minutes.',",
            "        default=5,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-absolute-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time a session can be active. After this period, user is forced to (re)authenticate, unless the user selected \"remember me\". Default 20 minutes.',",
            "        default=20,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-persistent-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time to remember and trust a user device. This timeout is used when user select \"remember me\". Default 30 days.',",
            "        default=43200,",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-certificate',",
            "        '--sslcertificate',",
            "        metavar='CERT',",
            "        help='location of the SSL Certification to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-private-key',",
            "        '--sslprivatekey',",
            "        metavar='KEY',",
            "        help='location of the SSL Private Key to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--tempdir',",
            "        metavar='FOLDER',",
            "        help='alternate temporary folder to be used when restoring files. Might be useful if the default location has limited disk space. Default to TEMPDIR environment or `/tmp`.',",
            "    )",
            "",
            "    parser.add(",
            "        '--disable-ssh-keys',",
            "        action='store_true',",
            "        help='used to hide SSH Key management to avoid users to add or remove SSH Key using the web application',",
            "        default=False,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-min-length',",
            "        type=int,",
            "        help=\"Minimum length of the user's password\",",
            "        default=8,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-max-length',",
            "        type=int,",
            "        help=\"Maximum length of the user's password\",",
            "        default=128,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-score',",
            "        type=lambda x: max(1, min(int(x), 4)),",
            "        help=\"Minimum zxcvbn's score for password. Value from 1 to 4. Default value 2. Read more about it here: https://github.com/dropbox/zxcvbn\",",
            "        default=2,",
            "    )",
            "",
            "    parser.add_argument('--version', action='version', version='%(prog)s ' + VERSION)",
            "",
            "    # Here we append a list of arguments for each locale.",
            "    flags = ['--welcome-msg'] + ['--welcome-msg-' + i for i in ['ca', 'en', 'es', 'fr', 'ru']] + ['--welcomemsg']",
            "    parser.add_argument(",
            "        *flags,",
            "        metavar='HTML',",
            "        help='replace the welcome message displayed in the login page for default locale or for a specific locale',",
            "        action=LocaleAction",
            "    )",
            "    return parser",
            "",
            "",
            "def parse_args(args=None, config_file_contents=None):",
            "    args = sys.argv[1:] if args is None else args",
            "    return get_parser().parse_args(args, config_file_contents=config_file_contents)",
            "",
            "",
            "class LocaleAction(argparse.Action):",
            "    \"\"\"",
            "    Custom Action to support defining arguments with locale.",
            "    \"\"\"",
            "",
            "    def __init__(self, option_strings, dest, nargs=None, **kwargs):",
            "        super(LocaleAction, self).__init__(option_strings, dest, **kwargs)",
            "",
            "    def __call__(self, parser, namespace, value, option_string=None):",
            "        if option_string[-3] == '-':",
            "            # When using arguments, we can extract the locale from the argument key",
            "            locale = option_string[-2:]",
            "        elif value[2] == ':':",
            "            # When using config file, the locale could be extract from the value e.g. fr:message",
            "            locale = value[0:2]",
            "            value = value[3:]",
            "        else:",
            "            locale = ''",
            "        # Create a dictionary with locale.",
            "        items = getattr(namespace, self.dest) or {}",
            "        items[locale] = value",
            "        setattr(namespace, self.dest, items)",
            "",
            "",
            "class ConfigFileParser(object):",
            "    \"\"\"",
            "    Custom config file parser to support rdiffweb config file format.",
            "    \"\"\"",
            "",
            "    def get_syntax_description(self):",
            "        msg = \"Configuration file syntax allows: key=value, flag=true.\"",
            "        return msg",
            "",
            "    def parse(self, stream):",
            "        \"\"\"",
            "        Used to read the rdiffweb config file as dict.",
            "        \"\"\"",
            "",
            "        result = OrderedDict()",
            "",
            "        for i, line in enumerate(stream):",
            "            line = re.compile(\"(.*?)#.*\").sub(r'\\1', line).strip()",
            "            if not line:",
            "                continue",
            "            if '=' not in line:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "            split_line = line.partition('=')",
            "            if not len(split_line) == 3:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "",
            "            # Get key a& value",
            "            key = split_line[0].lower().strip().replace('_', '-')",
            "            value = split_line[2].strip()",
            "",
            "            # Support welcome-msg locale for backward compatibility",
            "            m = re.match(\"welcome-?msg\\\\[(ca|en|es|fr|ru)\\\\]\", key.lower())",
            "            if m:",
            "                key = \"welcome-msg-\" + m.group(1)",
            "                value = m.group(1) + \":\" + value",
            "",
            "            result[key] = value",
            "",
            "        # This dictionary is read by cherrypy. So create appropriate structure.",
            "        return result",
            "",
            "",
            "class Option(object):",
            "    def __init__(self, key):",
            "        assert key",
            "        self.key = key",
            "",
            "    def __get__(self, instance, owner):",
            "        \"\"\"",
            "        Return a property to wrap the given option.",
            "        \"\"\"",
            "        return self.get(instance)",
            "",
            "    def get(self, instance=None):",
            "        \"\"\"",
            "        Return the value of this options.",
            "        \"\"\"",
            "        if isinstance(instance, Application):",
            "            app = instance",
            "        else:",
            "            app = cherrypy.request.app or getattr(instance, 'app', None)",
            "        assert app, \"Option() can't get reference to app\"",
            "        assert app.cfg, \"Option() can't get reference to app.cfg\"",
            "        return getattr(app.cfg, self.key)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import argparse",
            "import logging",
            "import re",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import configargparse",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Get rdiffweb version.",
            "try:",
            "    VERSION = pkg_resources.get_distribution(\"rdiffweb\").version",
            "except pkg_resources.DistributionNotFound:",
            "    VERSION = \"DEV\"",
            "",
            "",
            "def get_parser():",
            "    # Get global config argument parser",
            "    parser = configargparse.ArgumentParser(",
            "        prog='rdiffweb',",
            "        description='Web interface to browse and restore rdiff-backup repositories.',",
            "        default_config_files=['/etc/rdiffweb/rdw.conf', '/etc/rdiffweb/rdw.conf.d/*.conf'],",
            "        add_env_var_help=True,",
            "        auto_env_var_prefix='RDIFFWEB_',",
            "        config_file_parser_class=ConfigFileParser,",
            "        conflict_handler='resolve',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-f', '--config', is_config_file=True, metavar='FILE', help='location of Rdiffweb configuration file'",
            "    )",
            "",
            "    parser.add(",
            "        '--database-uri',",
            "        '--sqlitedb-file',",
            "        '--sqlitedbfile',",
            "        metavar='URI',",
            "        help=\"\"\"Location of the database used for persistence. SQLite and PostgreSQL",
            "            database are supported officially. To use a SQLite database you may",
            "            define the location using a file path or a URI.",
            "            e.g.: /srv/rdiffweb/file.db or sqlite:///srv/rdiffweb/file.db`.",
            "            To use PostgreSQL server you must provide",
            "            a URI similar to postgresql://user:pass@10.255.1.34/dbname and you",
            "            must install required dependencies.",
            "            By default, Rdiffweb uses a SQLite embedded database located at",
            "            /etc/rdiffweb/rdw.db.\"\"\",",
            "        default='/etc/rdiffweb/rdw.db',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-d',",
            "        '--debug',",
            "        action='store_true',",
            "        help='enable rdiffweb debug mode - change the log level to DEBUG, print exception stack trace to the web interface and show SQL query in logs',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-user',",
            "        '--adminuser',",
            "        metavar='USERNAME',",
            "        help='administrator username. The administrator user get created on startup if the database is empty.',",
            "        default='admin',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-password',",
            "        metavar='USERNAME',",
            "        help=\"\"\"administrator encrypted password as SSHA. Read online",
            "            documentation to know more about how to encrypt your password",
            "            into SSHA or use http://projects.marsching.org/weave4j/util/genpassword.php",
            "            When defined, administrator password cannot be updated using the web interface.",
            "            When undefined, default administrator password is `admin123` and",
            "            it can be updated using the web interface.\"\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--default-theme',",
            "        '--defaulttheme',",
            "        help='define the default theme. Either: default, blue or orange. Define the CSS file to be loaded in the web interface. You may manually edit a CSS file to customize it. The location is similar to `/usr/local/lib/python3.9/dist-packages/rdiffweb/static/`',",
            "        choices=['default', 'blue', 'orange'],",
            "        default='default',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--environment',",
            "        choices=['development', 'production'],",
            "        help='define the type of environment: development, production. This is used to limit the information shown to the user when an error occur.',",
            "        default='production',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-encryption',",
            "        '--emailencryption',",
            "        choices=['none', 'ssl', 'starttls'],",
            "        help='type of encryption to be used when establishing communication with SMTP server. Default: none',",
            "        default='none',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-host',",
            "        '--emailhost',",
            "        metavar='HOST',",
            "        help='SMTP server used to send email in the form <host>:<port>. If the port is not provided, default to standard port 25 or 465 is used. e.g.: smtp.gmail.com:587',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-sender',",
            "        '--emailsender',",
            "        metavar='EMAIL',",
            "        help='email addres used for the `from:` field when sending email.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-notification-time',",
            "        '--emailnotificationtime',",
            "        metavar='TIME',",
            "        help='time when the email notifcation should be sent for inactive backups. e.g.: 22:00 Default value: 23:00',",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-username',",
            "        '--emailusername',",
            "        metavar='USERNAME',",
            "        help='username used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-password',",
            "        '--emailpassword',",
            "        metavar='PASSWORD',",
            "        help='password used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-send-changed-notification',",
            "        '--emailsendchangednotification',",
            "        help='True to send notification when sensitive information get change in user profile.',",
            "        action='store_true',",
            "        default=True,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--favicon',",
            "        help='location of an icon to be used as a favicon displayed in web browser.',",
            "        default=pkg_resources.resource_filename('rdiffweb', 'static/favicon.ico'),",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-name', '--footername', help=argparse.SUPPRESS, default='rdiffweb'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-url', '--footerurl', help=argparse.SUPPRESS, default='https://rdiffweb.org/'",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--header-logo',",
            "        '--headerlogo',",
            "        help='location of an image (preferably a .png) to be used as a replacement for the rdiffweb logo.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--header-name',",
            "        '--headername',",
            "        help='application name displayed in the title bar and header menu.',",
            "        default='Rdiffweb',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-missing-user',",
            "        '--addmissinguser',",
            "        action='store_true',",
            "        help='enable creation of users from LDAP when the credential are valid.',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-role',",
            "        help='default role used when creating users from LDAP. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='user',",
            "        choices=['admin', 'maintainer', 'user'],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-userroot',",
            "        help='default user root directory used when creating users from LDAP. LDAP attributes may be used to define the default location. e.g.: `/backups/{uid[0]}/`. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-uri',",
            "        '--ldapuri',",
            "        help='URL to the LDAP server used to validate user credentials. e.g.: ldap://localhost:389',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-base-dn',",
            "        '--ldapbasedn',",
            "        metavar='DN',",
            "        help='DN of the branch of the directory where all searches should start from. e.g.: dc=my,dc=domain',",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-scope',",
            "        '--ldapscope',",
            "        help='scope of the search. Can be either base, onelevel or subtree',",
            "        choices=['base', 'onelevel', 'subtree'],",
            "        default=\"subtree\",",
            "    )",
            "",
            "    parser.add_argument('--ldap-tls', '--ldaptls', action='store_true', help='enable TLS')",
            "",
            "    parser.add_argument(",
            "        '--ldap-username-attribute',",
            "        '--ldapattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"The attribute to search username. If no attributes are provided, the default is to use `uid`. It's a good idea to choose an attribute that will be unique across all entries in the subtree you will be using.\",",
            "        default='uid',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-filter',",
            "        '--ldapfilter',",
            "        help=\"search filter to limit LDAP lookup. If not provided, defaults to (objectClass=*), which searches for all objects in the tree.\",",
            "        default='(objectClass=*)',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-required-group',",
            "        '--ldaprequiredgroup',",
            "        metavar='GROUPNAME',",
            "        help=\"name of the group of which the user must be a member to access rdiffweb. Should be used with ldap-group-attribute and ldap-group-attribute-is-dn.\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute',",
            "        '--ldapgroupattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"name of the attribute defining the groups of which the user is a member. Should be used with ldap-required-group and ldap-group-attribute-is-dn.\",",
            "        default='member',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute-is-dn',",
            "        '--ldapgroupattributeisdn',",
            "        help=\"True if the content of the attribute `ldap-group-attribute` is a DN.\",",
            "        action='store_true',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-dn',",
            "        '--ldapbinddn',",
            "        metavar='DN',",
            "        help=\"optional DN used to bind to the server when searching for entries. If not provided, will use an anonymous bind.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-password',",
            "        '--ldapbindpassword',",
            "        metavar='PASSWORD',",
            "        help=\"password to use in conjunction with LdapBindDn. Note that the bind password is probably sensitive data, and should be properly protected. You should only use the LdapBindDn and LdapBindPassword if you absolutely need them to search the directory.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-version',",
            "        '--ldapversion',",
            "        '--ldapprotocolversion',",
            "        help=\"version of LDAP in use either 2 or 3. Default to 3.\",",
            "        default=3,",
            "        type=int,",
            "        choices=[2, 3],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-network-timeout',",
            "        '--ldapnetworktimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP connection\",",
            "        default=100,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-timeout',",
            "        '--ldaptimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP request\",",
            "        default=300,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-encoding',",
            "        '--ldapencoding',",
            "        metavar='ENCODING',",
            "        help=\"encoding used by your LDAP server.\",",
            "        default=\"utf-8\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-access-file', '--logaccessfile', metavar='FILE', help='location of Rdiffweb log access file.'",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-file',",
            "        '--logfile',",
            "        metavar='FILE',",
            "        help='location of Rdiffweb log file. Print log to the console if not define in config file.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-level',",
            "        '--loglevel',",
            "        help='Define the log level.',",
            "        choices=['ERROR', 'WARN', 'INFO', 'DEBUG'],",
            "        default='INFO',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--max-depth',",
            "        '--maxdepth',",
            "        metavar='DEPTH',",
            "        help=\"define the maximum folder depthness to search into the user's root directory to find repositories. This is commonly used if you repositories are organised with multiple sub-folder.\",",
            "        type=int,",
            "        default=3,",
            "    )",
            "",
            "    parser.add('--quota-set-cmd', '--quotasetcmd', metavar='COMMAND', help=\"command line to set the user's quota.\")",
            "",
            "    parser.add('--quota-get-cmd', '--quotagetcmd', metavar='COMMAND', help=\"command line to get the user's quota.\")",
            "",
            "    parser.add(",
            "        '--quota-used-cmd', '--quotausedcmd', metavar='COMMAND', help=\"Command line to get user's quota disk usage.\"",
            "    )",
            "",
            "    parser.add(",
            "        '--remove-older-time',",
            "        '--removeoldertime',",
            "        metavar='TIME',",
            "        help=\"Time when to execute the remove older scheduled job. e.g.: 22:30\",",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add('--server-host', '--serverhost', metavar='IP', default='127.0.0.1', help='IP address to listen to')",
            "",
            "    parser.add(",
            "        '--server-port',",
            "        '--serverport',",
            "        metavar='PORT',",
            "        help='port to listen to for HTTP request',",
            "        default='8080',",
            "        type=int,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit-dir',",
            "        '--session-dir',",
            "        '--sessiondir',",
            "        metavar='FOLDER',",
            "        help='location where to store rate-limit information. When undefined, the data is kept in memory. `--session-dir` are deprecated and kept for backward compatibility.',",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit',",
            "        metavar='LIMIT',",
            "        type=int,",
            "        default=20,",
            "        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API.',",
            "    )",
            "",
            "    parser.add(",
            "        '--session-idle-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the amount of time a session will remain active in case there is no activity in the session. User Session will be revoke after this period of inactivity, unless the user selected \"remember me\". Default 5 minutes.',",
            "        default=5,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-absolute-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time a session can be active. After this period, user is forced to (re)authenticate, unless the user selected \"remember me\". Default 20 minutes.',",
            "        default=20,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-persistent-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time to remember and trust a user device. This timeout is used when user select \"remember me\". Default 30 days.',",
            "        default=43200,",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-certificate',",
            "        '--sslcertificate',",
            "        metavar='CERT',",
            "        help='location of the SSL Certification to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-private-key',",
            "        '--sslprivatekey',",
            "        metavar='KEY',",
            "        help='location of the SSL Private Key to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--tempdir',",
            "        metavar='FOLDER',",
            "        help='alternate temporary folder to be used when restoring files. Might be useful if the default location has limited disk space. Default to TEMPDIR environment or `/tmp`.',",
            "    )",
            "",
            "    parser.add(",
            "        '--disable-ssh-keys',",
            "        action='store_true',",
            "        help='used to hide SSH Key management to avoid users to add or remove SSH Key using the web application',",
            "        default=False,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-min-length',",
            "        type=int,",
            "        help=\"Minimum length of the user's password\",",
            "        default=8,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-max-length',",
            "        type=int,",
            "        help=\"Maximum length of the user's password\",",
            "        default=128,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-score',",
            "        type=lambda x: max(1, min(int(x), 4)),",
            "        help=\"Minimum zxcvbn's score for password. Value from 1 to 4. Default value 2. Read more about it here: https://github.com/dropbox/zxcvbn\",",
            "        default=2,",
            "    )",
            "",
            "    parser.add_argument('--version', action='version', version='%(prog)s ' + VERSION)",
            "",
            "    # Here we append a list of arguments for each locale.",
            "    flags = ['--welcome-msg'] + ['--welcome-msg-' + i for i in ['ca', 'en', 'es', 'fr', 'ru']] + ['--welcomemsg']",
            "    parser.add_argument(",
            "        *flags,",
            "        metavar='HTML',",
            "        help='replace the welcome message displayed in the login page for default locale or for a specific locale',",
            "        action=LocaleAction",
            "    )",
            "    return parser",
            "",
            "",
            "def parse_args(args=None, config_file_contents=None):",
            "    args = sys.argv[1:] if args is None else args",
            "    return get_parser().parse_args(args, config_file_contents=config_file_contents)",
            "",
            "",
            "class LocaleAction(argparse.Action):",
            "    \"\"\"",
            "    Custom Action to support defining arguments with locale.",
            "    \"\"\"",
            "",
            "    def __init__(self, option_strings, dest, nargs=None, **kwargs):",
            "        super(LocaleAction, self).__init__(option_strings, dest, **kwargs)",
            "",
            "    def __call__(self, parser, namespace, value, option_string=None):",
            "        if option_string[-3] == '-':",
            "            # When using arguments, we can extract the locale from the argument key",
            "            locale = option_string[-2:]",
            "        elif value[2] == ':':",
            "            # When using config file, the locale could be extract from the value e.g. fr:message",
            "            locale = value[0:2]",
            "            value = value[3:]",
            "        else:",
            "            locale = ''",
            "        # Create a dictionary with locale.",
            "        items = getattr(namespace, self.dest) or {}",
            "        items[locale] = value",
            "        setattr(namespace, self.dest, items)",
            "",
            "",
            "class ConfigFileParser(object):",
            "    \"\"\"",
            "    Custom config file parser to support rdiffweb config file format.",
            "    \"\"\"",
            "",
            "    def get_syntax_description(self):",
            "        msg = \"Configuration file syntax allows: key=value, flag=true.\"",
            "        return msg",
            "",
            "    def parse(self, stream):",
            "        \"\"\"",
            "        Used to read the rdiffweb config file as dict.",
            "        \"\"\"",
            "",
            "        result = OrderedDict()",
            "",
            "        for i, line in enumerate(stream):",
            "            line = re.compile(\"(.*?)#.*\").sub(r'\\1', line).strip()",
            "            if not line:",
            "                continue",
            "            if '=' not in line:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "            split_line = line.partition('=')",
            "            if not len(split_line) == 3:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "",
            "            # Get key a& value",
            "            key = split_line[0].lower().strip().replace('_', '-')",
            "            value = split_line[2].strip()",
            "",
            "            # Support welcome-msg locale for backward compatibility",
            "            m = re.match(\"welcome-?msg\\\\[(ca|en|es|fr|ru)\\\\]\", key.lower())",
            "            if m:",
            "                key = \"welcome-msg-\" + m.group(1)",
            "                value = m.group(1) + \":\" + value",
            "",
            "            result[key] = value",
            "",
            "        # This dictionary is read by cherrypy. So create appropriate structure.",
            "        return result",
            "",
            "",
            "class Option(object):",
            "    def __init__(self, key):",
            "        assert key",
            "        self.key = key",
            "",
            "    def __get__(self, instance, owner):",
            "        \"\"\"",
            "        Return a property to wrap the given option.",
            "        \"\"\"",
            "        return self.get(instance)",
            "",
            "    def get(self, instance=None):",
            "        \"\"\"",
            "        Return the value of this options.",
            "        \"\"\"",
            "        if isinstance(instance, Application):",
            "            app = instance",
            "        else:",
            "            app = cherrypy.request.app or getattr(instance, 'app', None)",
            "        assert app, \"Option() can't get reference to app\"",
            "        assert app.cfg, \"Option() can't get reference to app.cfg\"",
            "        return getattr(app.cfg, self.key)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "162": [
                "get_parser"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/model/_user.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " from sqlalchemy import Column, Integer, SmallInteger, String, and_, event, inspect, or_"
            },
            "1": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " from sqlalchemy.exc import IntegrityError"
            },
            "2": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " from sqlalchemy.ext.hybrid import hybrid_property"
            },
            "3": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from sqlalchemy.orm import deferred, relationship"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+from sqlalchemy.orm import deferred, relationship, validates"
            },
            "5": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 28,
                "PatchRowcode": " from zxcvbn import zxcvbn"
            },
            "6": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " import rdiffweb.tools.db  # noqa"
            },
            "8": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "     PATTERN_USERNAME = r\"[a-zA-Z0-9_.\\-]+$\""
            },
            "9": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 75,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "     userid = Column('UserID', Integer, primary_key=True)"
            },
            "11": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    _username = Column('Username', String, nullable=False, unique=True)"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+    username = Column('Username', String, nullable=False, unique=True)"
            },
            "13": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "     hash_password = Column('Password', String, nullable=False, default=\"\")"
            },
            "14": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    _user_root = Column('UserRoot', String, nullable=False, default=\"\")"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+    user_root = Column('UserRoot', String, nullable=False, default=\"\")"
            },
            "16": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "     _is_admin = deferred("
            },
            "17": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "         Column("
            },
            "18": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "             'IsAdmin',"
            },
            "19": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 86,
                "PatchRowcode": "             doc=\"DEPRECATED This column is replaced by 'role'\","
            },
            "20": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "         )"
            },
            "21": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "     )"
            },
            "22": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    _email = Column('UserEmail', String, nullable=False, default=\"\")"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+    email = Column('UserEmail', String, nullable=False, default=\"\")"
            },
            "24": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 90,
                "PatchRowcode": "     restore_format = deferred("
            },
            "25": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "         Column("
            },
            "26": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "             'RestoreFormat',"
            },
            "27": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "             doc=\"DEPRECATED This column is not used anymore\","
            },
            "28": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "         )"
            },
            "29": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "     )"
            },
            "30": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    _role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE))"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+    role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE), default=USER_ROLE)"
            },
            "32": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "     fullname = Column('fullname', String, nullable=False, default=\"\")"
            },
            "33": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "     mfa = Column('mfa', SmallInteger, nullable=False, default=DISABLED_MFA)"
            },
            "34": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "     repo_objs = relationship("
            },
            "35": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 129,
                "PatchRowcode": "         userobj.add()"
            },
            "36": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": 130,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": 131,
                "PatchRowcode": "     @classmethod"
            },
            "38": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def add_user(cls, username, password=None, **attrs):"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+    def add_user(cls, username, password=None, role=USER_ROLE, **attrs):"
            },
            "40": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": 133,
                "PatchRowcode": "         \"\"\""
            },
            "41": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 134,
                "PatchRowcode": "         Used to add a new user with an optional password."
            },
            "42": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 135,
                "PatchRowcode": "         \"\"\""
            },
            "43": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": 143,
                "PatchRowcode": "         userobj = UserObject("
            },
            "44": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": 144,
                "PatchRowcode": "             username=username,"
            },
            "45": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": 145,
                "PatchRowcode": "             hash_password=hash_password(password) if password else '',"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+            role=role,"
            },
            "47": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "             **attrs,"
            },
            "48": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 148,
                "PatchRowcode": "         ).add()"
            },
            "49": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": 149,
                "PatchRowcode": "         # Raise event"
            },
            "50": {
                "beforePatchRowNumber": 383,
                "afterPatchRowNumber": 384,
                "PatchRowcode": "     def __eq__(self, other):"
            },
            "51": {
                "beforePatchRowNumber": 384,
                "afterPatchRowNumber": 385,
                "PatchRowcode": "         return type(self) == type(other) and inspect(self).key == inspect(other).key"
            },
            "52": {
                "beforePatchRowNumber": 385,
                "afterPatchRowNumber": 386,
                "PatchRowcode": " "
            },
            "53": {
                "beforePatchRowNumber": 386,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @hybrid_property"
            },
            "54": {
                "beforePatchRowNumber": 387,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def username(self):"
            },
            "55": {
                "beforePatchRowNumber": 388,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return self._username"
            },
            "56": {
                "beforePatchRowNumber": 389,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "57": {
                "beforePatchRowNumber": 390,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @username.setter"
            },
            "58": {
                "beforePatchRowNumber": 391,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def username(self, value):"
            },
            "59": {
                "beforePatchRowNumber": 392,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        oldvalue = self._username"
            },
            "60": {
                "beforePatchRowNumber": 393,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._username = value"
            },
            "61": {
                "beforePatchRowNumber": 394,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if oldvalue != value:"
            },
            "62": {
                "beforePatchRowNumber": 395,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.engine.publish('user_attr_changed', self, {'username': (oldvalue, value)})"
            },
            "63": {
                "beforePatchRowNumber": 396,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "64": {
                "beforePatchRowNumber": 397,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @hybrid_property"
            },
            "65": {
                "beforePatchRowNumber": 398,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def role(self):"
            },
            "66": {
                "beforePatchRowNumber": 399,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if self._role is None:"
            },
            "67": {
                "beforePatchRowNumber": 400,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return self.USER_ROLE"
            },
            "68": {
                "beforePatchRowNumber": 401,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return self._role"
            },
            "69": {
                "beforePatchRowNumber": 402,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "70": {
                "beforePatchRowNumber": 403,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @role.setter"
            },
            "71": {
                "beforePatchRowNumber": 404,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def role(self, value):"
            },
            "72": {
                "beforePatchRowNumber": 405,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        oldvalue = self._role"
            },
            "73": {
                "beforePatchRowNumber": 406,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._role = value"
            },
            "74": {
                "beforePatchRowNumber": 407,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if oldvalue != value:"
            },
            "75": {
                "beforePatchRowNumber": 408,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.engine.publish('user_attr_changed', self, {'role': (oldvalue, value)})"
            },
            "76": {
                "beforePatchRowNumber": 409,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "77": {
                "beforePatchRowNumber": 410,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @hybrid_property"
            },
            "78": {
                "beforePatchRowNumber": 411,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def email(self):"
            },
            "79": {
                "beforePatchRowNumber": 412,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return self._email"
            },
            "80": {
                "beforePatchRowNumber": 413,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "81": {
                "beforePatchRowNumber": 414,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @email.setter"
            },
            "82": {
                "beforePatchRowNumber": 415,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def email(self, value):"
            },
            "83": {
                "beforePatchRowNumber": 416,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        oldvalue = self._email"
            },
            "84": {
                "beforePatchRowNumber": 417,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._email = value"
            },
            "85": {
                "beforePatchRowNumber": 418,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if oldvalue != value:"
            },
            "86": {
                "beforePatchRowNumber": 419,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.engine.publish('user_attr_changed', self, {'email': (oldvalue, value)})"
            },
            "87": {
                "beforePatchRowNumber": 420,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "88": {
                "beforePatchRowNumber": 421,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @hybrid_property"
            },
            "89": {
                "beforePatchRowNumber": 422,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def user_root(self):"
            },
            "90": {
                "beforePatchRowNumber": 423,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return self._user_root"
            },
            "91": {
                "beforePatchRowNumber": 424,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "92": {
                "beforePatchRowNumber": 425,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    @user_root.setter"
            },
            "93": {
                "beforePatchRowNumber": 426,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def user_root(self, value):"
            },
            "94": {
                "beforePatchRowNumber": 427,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        oldvalue = self._user_root"
            },
            "95": {
                "beforePatchRowNumber": 428,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self._user_root = value"
            },
            "96": {
                "beforePatchRowNumber": 429,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if oldvalue != value:"
            },
            "97": {
                "beforePatchRowNumber": 430,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            cherrypy.engine.publish('user_attr_changed', self, {'user_root': (oldvalue, value)})"
            },
            "98": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 387,
                "PatchRowcode": "+    @validates('username')"
            },
            "99": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 388,
                "PatchRowcode": "+    def validates_username(self, key, value):"
            },
            "100": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 389,
                "PatchRowcode": "+        if self.username:"
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 390,
                "PatchRowcode": "+            raise ValueError('Username cannot be modified.')"
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 391,
                "PatchRowcode": "+        return value"
            },
            "103": {
                "beforePatchRowNumber": 431,
                "afterPatchRowNumber": 392,
                "PatchRowcode": " "
            },
            "104": {
                "beforePatchRowNumber": 432,
                "afterPatchRowNumber": 393,
                "PatchRowcode": "     def validate_access_token(self, token):"
            },
            "105": {
                "beforePatchRowNumber": 433,
                "afterPatchRowNumber": 394,
                "PatchRowcode": "         \"\"\""
            },
            "106": {
                "beforePatchRowNumber": 460,
                "afterPatchRowNumber": 421,
                "PatchRowcode": "     Publish event when user is deleted."
            },
            "107": {
                "beforePatchRowNumber": 461,
                "afterPatchRowNumber": 422,
                "PatchRowcode": "     \"\"\""
            },
            "108": {
                "beforePatchRowNumber": 462,
                "afterPatchRowNumber": 423,
                "PatchRowcode": "     cherrypy.engine.publish('user_deleted', target.username)"
            },
            "109": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 424,
                "PatchRowcode": "+"
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 425,
                "PatchRowcode": "+"
            },
            "111": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 426,
                "PatchRowcode": "+@event.listens_for(UserObject, 'after_update')"
            },
            "112": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 427,
                "PatchRowcode": "+def user_attr_changed(mapper, connection, target):"
            },
            "113": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 428,
                "PatchRowcode": "+    changes = {}"
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 429,
                "PatchRowcode": "+    state = inspect(target)"
            },
            "115": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 430,
                "PatchRowcode": "+    for attr in state.attrs:"
            },
            "116": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 431,
                "PatchRowcode": "+        if attr.key in ['user_root', 'email', 'role', 'mfa']:"
            },
            "117": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 432,
                "PatchRowcode": "+            hist = attr.load_history()"
            },
            "118": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 433,
                "PatchRowcode": "+            if hist.has_changes():"
            },
            "119": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 434,
                "PatchRowcode": "+                changes[attr.key] = ("
            },
            "120": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 435,
                "PatchRowcode": "+                    hist.deleted[0] if len(hist.deleted) >= 1 else None,"
            },
            "121": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 436,
                "PatchRowcode": "+                    hist.added[0] if len(hist.added) >= 1 else None,"
            },
            "122": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 437,
                "PatchRowcode": "+                )"
            },
            "123": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 438,
                "PatchRowcode": "+    if changes:"
            },
            "124": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 439,
                "PatchRowcode": "+        cherrypy.engine.publish('user_attr_changed', target, changes)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import datetime",
            "import logging",
            "import os",
            "import secrets",
            "import string",
            "",
            "import cherrypy",
            "from sqlalchemy import Column, Integer, SmallInteger, String, and_, event, inspect, or_",
            "from sqlalchemy.exc import IntegrityError",
            "from sqlalchemy.ext.hybrid import hybrid_property",
            "from sqlalchemy.orm import deferred, relationship",
            "from zxcvbn import zxcvbn",
            "",
            "import rdiffweb.tools.db  # noqa",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.passwd import check_password, hash_password",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "from ._repo import RepoObject",
            "from ._sshkey import SshKey",
            "from ._token import Token",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "Base = cherrypy.tools.db.get_base()",
            "",
            "SEP = b'/'",
            "",
            "",
            "class DuplicateSSHKeyError(Exception):",
            "    \"\"\"",
            "    Raised by add_authorizedkey when trying to add the same SSH Key twice.",
            "    \"\"\"",
            "",
            "    pass",
            "",
            "",
            "class UserObject(Base):",
            "    __tablename__ = 'users'",
            "    __table_args__ = {'sqlite_autoincrement': True}",
            "",
            "    # Value for role.",
            "    ADMIN_ROLE = 0",
            "    MAINTAINER_ROLE = 5",
            "    USER_ROLE = 10",
            "    ROLES = {",
            "        'admin': ADMIN_ROLE,",
            "        'maintainer': MAINTAINER_ROLE,",
            "        'user': USER_ROLE,",
            "    }",
            "    # Value for mfa field",
            "    DISABLED_MFA = 0",
            "    ENABLED_MFA = 1",
            "",
            "    # Regex pattern to be used for validation.",
            "    PATTERN_EMAIL = r\"[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$\"",
            "    PATTERN_FULLNAME = r\"\"\"[^!\"#$%&()*+,./:;<=>?@[\\]_{|}~]+$\"\"\"",
            "    PATTERN_USERNAME = r\"[a-zA-Z0-9_.\\-]+$\"",
            "",
            "    userid = Column('UserID', Integer, primary_key=True)",
            "    _username = Column('Username', String, nullable=False, unique=True)",
            "    hash_password = Column('Password', String, nullable=False, default=\"\")",
            "    _user_root = Column('UserRoot', String, nullable=False, default=\"\")",
            "    _is_admin = deferred(",
            "        Column(",
            "            'IsAdmin',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"0\",",
            "            doc=\"DEPRECATED This column is replaced by 'role'\",",
            "        )",
            "    )",
            "    _email = Column('UserEmail', String, nullable=False, default=\"\")",
            "    restore_format = deferred(",
            "        Column(",
            "            'RestoreFormat',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"1\",",
            "            doc=\"DEPRECATED This column is not used anymore\",",
            "        )",
            "    )",
            "    _role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE))",
            "    fullname = Column('fullname', String, nullable=False, default=\"\")",
            "    mfa = Column('mfa', SmallInteger, nullable=False, default=DISABLED_MFA)",
            "    repo_objs = relationship(",
            "        'RepoObject',",
            "        foreign_keys='UserObject.userid',",
            "        primaryjoin='UserObject.userid == RepoObject.userid',",
            "        uselist=True,",
            "        lazy=True,",
            "        order_by=lambda: RepoObject.repopath,",
            "    )",
            "",
            "    @classmethod",
            "    def get_user(cls, user):",
            "        \"\"\"Return a user object.\"\"\"",
            "        return UserObject.query.filter(UserObject.username == user).first()",
            "",
            "    @classmethod",
            "    def create_admin_user(cls, default_username, default_password):",
            "        # Check if admin user exists. If not, created it.",
            "        userobj = UserObject.get_user(default_username)",
            "        if not userobj:",
            "            userobj = cls.add_user(default_username, role=UserObject.ADMIN_ROLE, user_root='/backups')",
            "        # Also make sure to update the password with latest value from config file.",
            "        if default_password and default_password.startswith('{SSHA}'):",
            "            userobj.hash_password = default_password",
            "        elif default_password:",
            "            userobj.hash_password = hash_password(default_password)",
            "        else:",
            "            userobj.hash_password = hash_password('admin123')",
            "        userobj.add()",
            "",
            "    @classmethod",
            "    def add_user(cls, username, password=None, **attrs):",
            "        \"\"\"",
            "        Used to add a new user with an optional password.",
            "        \"\"\"",
            "        assert password is None or isinstance(password, str)",
            "        # Check if user already exists.",
            "        if UserObject.get_user(username):",
            "            raise ValueError(_(\"User %s already exists.\" % (username,)))",
            "",
            "        # Find a database where to add the user",
            "        logger.info(\"adding new user [%s]\", username)",
            "        userobj = UserObject(",
            "            username=username,",
            "            hash_password=hash_password(password) if password else '',",
            "            **attrs,",
            "        ).add()",
            "        # Raise event",
            "        cherrypy.engine.publish('user_added', userobj)",
            "        # Return user object",
            "        return userobj",
            "",
            "    def add_authorizedkey(self, key, comment=None):",
            "        \"\"\"",
            "        Add the given key to the user. Adding the key to his `authorized_keys`",
            "        file if it exists and adding it to database.",
            "        \"\"\"",
            "        # Parse and validate ssh key",
            "        assert key",
            "        key = authorizedkeys.check_publickey(key)",
            "",
            "        # Remove option, replace comments.",
            "        key = authorizedkeys.AuthorizedKey(",
            "            options=None, keytype=key.keytype, key=key.key, comment=comment or key.comment",
            "        )",
            "",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode=\"r+\", encoding='utf-8') as fh:",
            "                if authorizedkeys.exists(fh, key):",
            "                    raise DuplicateSSHKeyError(_(\"SSH key already exists\"))",
            "                logger.info(\"add key [%s] to [%s] authorized_keys\", key, self.username)",
            "                authorizedkeys.add(fh, key)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"add key [%s] to [%s] database\", key, self.username)",
            "            try:",
            "                SshKey(userid=self.userid, fingerprint=key.fingerprint, key=key.getvalue()).add()",
            "            except IntegrityError:",
            "                SshKey.session.rollback()",
            "                raise DuplicateSSHKeyError(",
            "                    _(\"Duplicate key. This key already exists or is associated to another user.\")",
            "                )",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def add_access_token(self, name, expiration_time=None, length=16):",
            "        \"\"\"",
            "        Create a new access token. Return the un-encrypted value of the token.",
            "        \"\"\"",
            "        assert name",
            "        assert length >= 8",
            "        # Generate a random token",
            "        token = ''.join(secrets.choice(string.ascii_lowercase) for i in range(length))",
            "        # Store hash token",
            "        try:",
            "            obj = Token(userid=self.userid, name=name, hash_token=hash_password(token), expiration_time=expiration_time)",
            "            obj.add()",
            "        except IntegrityError:",
            "            Token.session.rollback()",
            "            raise ValueError(_(\"Duplicate token name: %s\") % name)",
            "        cherrypy.engine.publish('access_token_added', self, name)",
            "        return token",
            "",
            "    def valid_user_root(self):",
            "        \"\"\"",
            "        Check if the current user_root is valid and readable",
            "        \"\"\"",
            "        try:",
            "            return os.access(self.user_root, os.F_OK) and os.path.isdir(self.user_root)",
            "        except Exception:",
            "            return False",
            "",
            "    def delete(self, *args, **kwargs):",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "        if self.username == cfg.admin_user:",
            "            raise ValueError(_(\"can't delete admin user\"))",
            "        # FIXME This should be deleted by cascade",
            "        SshKey.query.filter(SshKey.userid == self.userid).delete()",
            "        RepoObject.query.filter(RepoObject.userid == self.userid).delete()",
            "        Token.query.filter(Token.userid == self.userid).delete()",
            "        # Delete ourself",
            "        Base.delete(self)",
            "",
            "    def delete_authorizedkey(self, fingerprint):",
            "        \"\"\"",
            "        Remove the given key from the user. Remove the key from his",
            "        `authorized_keys` file if it exists and from database database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode='r+', encoding='utf-8') as fh:",
            "                logger.info(\"removing key [%s] from [%s] authorized_keys\", fingerprint, self.username)",
            "                authorizedkeys.remove(fh, fingerprint)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"removing key [%s] from [%s] database\", fingerprint, self.username)",
            "            SshKey.query.filter(and_(SshKey.userid == self.userid, SshKey.fingerprint == fingerprint)).delete()",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def delete_access_token(self, name):",
            "        assert name",
            "        if not Token.query.filter(Token.userid == self.userid, Token.name == name).delete():",
            "            raise ValueError(_(\"token name doesn't exists: %s\") % name)",
            "",
            "    @property",
            "    def disk_usage(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_usage', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @property",
            "    def disk_quota(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_quota', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @disk_quota.setter",
            "    def disk_quota(self, value):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return",
            "        cherrypy.engine.publish('set_disk_quota', self, value)",
            "",
            "    @property",
            "    def authorizedkeys(self):",
            "        \"\"\"",
            "        Return an iterator on the authorized key. Either from his",
            "        `authorized_keys` file if it exists or from database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            for k in authorizedkeys.read(filename):",
            "                yield k",
            "",
            "        # Also look in database.",
            "        for record in SshKey.query.filter(SshKey.userid == self.userid).all():",
            "            yield authorizedkeys.check_publickey(record.key)",
            "",
            "    def refresh_repos(self, delete=False):",
            "        \"\"\"",
            "        Return list of repositories object to reflect the filesystem folders.",
            "",
            "        Return a RepoObject for each sub directories under `user_root` with `rdiff-backup-data`.",
            "        \"\"\"",
            "        # Update the repositories by walking in the directory tree.",
            "        def _onerror(unused):",
            "            logger.error('error updating user [%s] repos' % self.username, exc_info=1)",
            "",
            "        # Get application config",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        dirty = False",
            "        records = RepoObject.query.filter(RepoObject.userid == self.userid).order_by(RepoObject.repopath).all()",
            "        user_root = os.fsencode(self.user_root)",
            "        for root, dirs, unused_files in os.walk(user_root, _onerror):",
            "            for name in dirs.copy():",
            "                if name.startswith(b'.'):",
            "                    dirs.remove(name)",
            "            if b'rdiff-backup-data' in dirs:",
            "                repopath = os.path.relpath(root, start=user_root)",
            "                del dirs[:]",
            "                # Handle special scenario when the repo is the",
            "                # user_root",
            "                repopath = b'' if repopath == b'.' else repopath",
            "",
            "                # Check if repo path exists.",
            "                record_match = next((record for record in records if record.repopath == os.fsdecode(repopath)), None)",
            "                if not record_match:",
            "                    # Add repository to database.",
            "                    RepoObject(user=self, repopath=os.fsdecode(repopath)).add()",
            "                    dirty = True",
            "                else:",
            "                    records.remove(record_match)",
            "            if root.count(SEP) - user_root.count(SEP) >= cfg.max_depth:",
            "                del dirs[:]",
            "        # If enabled, remove entried from database",
            "        if delete:",
            "            for record in records:",
            "                RepoObject.query.filter(RepoObject.repoid == record.repoid).delete()",
            "        return dirty",
            "",
            "    @hybrid_property",
            "    def is_admin(self):",
            "        return self.role <= self.ADMIN_ROLE",
            "",
            "    @hybrid_property",
            "    def is_ldap(self):",
            "        return self.hash_password is None or self.hash_password == ''",
            "",
            "    @is_ldap.expression",
            "    def is_ldap(cls):",
            "        return or_(cls.hash_password.is_(None), cls.hash_password == '')",
            "",
            "    @hybrid_property",
            "    def is_maintainer(self):",
            "        return self.role <= self.MAINTAINER_ROLE",
            "",
            "    def set_password(self, password):",
            "        \"\"\"",
            "        Change the user's password. Raise a ValueError if the username or",
            "        the password are invalid.",
            "        \"\"\"",
            "        assert isinstance(password, str)",
            "        if not password:",
            "            raise ValueError(\"password can't be empty\")",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        # Cannot update admin-password if defined",
            "        if self.username == cfg.admin_user and cfg.admin_password:",
            "            raise ValueError(_(\"can't update admin-password defined in configuration file\"))",
            "",
            "        # Check password length",
            "        if cfg.password_min_length > len(password) or len(password) > cfg.password_max_length:",
            "            raise ValueError(",
            "                _('Password must have between %(min)d and %(max)d characters.')",
            "                % {'min': cfg.password_min_length, 'max': cfg.password_max_length}",
            "            )",
            "",
            "        # Verify password score using zxcvbn",
            "        stats = zxcvbn(password)",
            "        if stats.get('score') < cfg.password_score:",
            "            msg = _('Password too weak.')",
            "            warning = stats.get('feedback', {}).get('warning')",
            "            suggestions = stats.get('feedback', {}).get('suggestions')",
            "            if warning:",
            "                msg += ' ' + warning",
            "            if suggestions:",
            "                msg += ' ' + ' '.join(suggestions)",
            "            raise ValueError(msg)",
            "",
            "        logger.info(\"updating user password [%s]\", self.username)",
            "        self.hash_password = hash_password(password)",
            "",
            "    def __eq__(self, other):",
            "        return type(self) == type(other) and inspect(self).key == inspect(other).key",
            "",
            "    @hybrid_property",
            "    def username(self):",
            "        return self._username",
            "",
            "    @username.setter",
            "    def username(self, value):",
            "        oldvalue = self._username",
            "        self._username = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'username': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def role(self):",
            "        if self._role is None:",
            "            return self.USER_ROLE",
            "        return self._role",
            "",
            "    @role.setter",
            "    def role(self, value):",
            "        oldvalue = self._role",
            "        self._role = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'role': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def email(self):",
            "        return self._email",
            "",
            "    @email.setter",
            "    def email(self, value):",
            "        oldvalue = self._email",
            "        self._email = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'email': (oldvalue, value)})",
            "",
            "    @hybrid_property",
            "    def user_root(self):",
            "        return self._user_root",
            "",
            "    @user_root.setter",
            "    def user_root(self, value):",
            "        oldvalue = self._user_root",
            "        self._user_root = value",
            "        if oldvalue != value:",
            "            cherrypy.engine.publish('user_attr_changed', self, {'user_root': (oldvalue, value)})",
            "",
            "    def validate_access_token(self, token):",
            "        \"\"\"",
            "        Check if the given token matches.",
            "        \"\"\"",
            "        for access_token in Token.query.all():",
            "            # If token expired. Let delete it.",
            "            if access_token.is_expired:",
            "                access_token.delete()",
            "                continue",
            "            if check_password(token, access_token.hash_token):",
            "                # When it matches, let update the record.",
            "                access_token.access_time = datetime.datetime.utcnow",
            "                return True",
            "        return False",
            "",
            "    def validate_password(self, password):",
            "        return check_password(password, self.hash_password)",
            "",
            "",
            "@event.listens_for(UserObject.hash_password, \"set\")",
            "def hash_password_set(target, value, oldvalue, initiator):",
            "    if value and value != oldvalue:",
            "        cherrypy.engine.publish('user_password_changed', target)",
            "",
            "",
            "@event.listens_for(UserObject, 'after_delete')",
            "def user_after_delete(mapper, connection, target):",
            "    \"\"\"",
            "    Publish event when user is deleted.",
            "    \"\"\"",
            "    cherrypy.engine.publish('user_deleted', target.username)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import datetime",
            "import logging",
            "import os",
            "import secrets",
            "import string",
            "",
            "import cherrypy",
            "from sqlalchemy import Column, Integer, SmallInteger, String, and_, event, inspect, or_",
            "from sqlalchemy.exc import IntegrityError",
            "from sqlalchemy.ext.hybrid import hybrid_property",
            "from sqlalchemy.orm import deferred, relationship, validates",
            "from zxcvbn import zxcvbn",
            "",
            "import rdiffweb.tools.db  # noqa",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.passwd import check_password, hash_password",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "from ._repo import RepoObject",
            "from ._sshkey import SshKey",
            "from ._token import Token",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "Base = cherrypy.tools.db.get_base()",
            "",
            "SEP = b'/'",
            "",
            "",
            "class DuplicateSSHKeyError(Exception):",
            "    \"\"\"",
            "    Raised by add_authorizedkey when trying to add the same SSH Key twice.",
            "    \"\"\"",
            "",
            "    pass",
            "",
            "",
            "class UserObject(Base):",
            "    __tablename__ = 'users'",
            "    __table_args__ = {'sqlite_autoincrement': True}",
            "",
            "    # Value for role.",
            "    ADMIN_ROLE = 0",
            "    MAINTAINER_ROLE = 5",
            "    USER_ROLE = 10",
            "    ROLES = {",
            "        'admin': ADMIN_ROLE,",
            "        'maintainer': MAINTAINER_ROLE,",
            "        'user': USER_ROLE,",
            "    }",
            "    # Value for mfa field",
            "    DISABLED_MFA = 0",
            "    ENABLED_MFA = 1",
            "",
            "    # Regex pattern to be used for validation.",
            "    PATTERN_EMAIL = r\"[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$\"",
            "    PATTERN_FULLNAME = r\"\"\"[^!\"#$%&()*+,./:;<=>?@[\\]_{|}~]+$\"\"\"",
            "    PATTERN_USERNAME = r\"[a-zA-Z0-9_.\\-]+$\"",
            "",
            "    userid = Column('UserID', Integer, primary_key=True)",
            "    username = Column('Username', String, nullable=False, unique=True)",
            "    hash_password = Column('Password', String, nullable=False, default=\"\")",
            "    user_root = Column('UserRoot', String, nullable=False, default=\"\")",
            "    _is_admin = deferred(",
            "        Column(",
            "            'IsAdmin',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"0\",",
            "            doc=\"DEPRECATED This column is replaced by 'role'\",",
            "        )",
            "    )",
            "    email = Column('UserEmail', String, nullable=False, default=\"\")",
            "    restore_format = deferred(",
            "        Column(",
            "            'RestoreFormat',",
            "            SmallInteger,",
            "            nullable=False,",
            "            server_default=\"1\",",
            "            doc=\"DEPRECATED This column is not used anymore\",",
            "        )",
            "    )",
            "    role = Column('role', SmallInteger, nullable=False, server_default=str(USER_ROLE), default=USER_ROLE)",
            "    fullname = Column('fullname', String, nullable=False, default=\"\")",
            "    mfa = Column('mfa', SmallInteger, nullable=False, default=DISABLED_MFA)",
            "    repo_objs = relationship(",
            "        'RepoObject',",
            "        foreign_keys='UserObject.userid',",
            "        primaryjoin='UserObject.userid == RepoObject.userid',",
            "        uselist=True,",
            "        lazy=True,",
            "        order_by=lambda: RepoObject.repopath,",
            "    )",
            "",
            "    @classmethod",
            "    def get_user(cls, user):",
            "        \"\"\"Return a user object.\"\"\"",
            "        return UserObject.query.filter(UserObject.username == user).first()",
            "",
            "    @classmethod",
            "    def create_admin_user(cls, default_username, default_password):",
            "        # Check if admin user exists. If not, created it.",
            "        userobj = UserObject.get_user(default_username)",
            "        if not userobj:",
            "            userobj = cls.add_user(default_username, role=UserObject.ADMIN_ROLE, user_root='/backups')",
            "        # Also make sure to update the password with latest value from config file.",
            "        if default_password and default_password.startswith('{SSHA}'):",
            "            userobj.hash_password = default_password",
            "        elif default_password:",
            "            userobj.hash_password = hash_password(default_password)",
            "        else:",
            "            userobj.hash_password = hash_password('admin123')",
            "        userobj.add()",
            "",
            "    @classmethod",
            "    def add_user(cls, username, password=None, role=USER_ROLE, **attrs):",
            "        \"\"\"",
            "        Used to add a new user with an optional password.",
            "        \"\"\"",
            "        assert password is None or isinstance(password, str)",
            "        # Check if user already exists.",
            "        if UserObject.get_user(username):",
            "            raise ValueError(_(\"User %s already exists.\" % (username,)))",
            "",
            "        # Find a database where to add the user",
            "        logger.info(\"adding new user [%s]\", username)",
            "        userobj = UserObject(",
            "            username=username,",
            "            hash_password=hash_password(password) if password else '',",
            "            role=role,",
            "            **attrs,",
            "        ).add()",
            "        # Raise event",
            "        cherrypy.engine.publish('user_added', userobj)",
            "        # Return user object",
            "        return userobj",
            "",
            "    def add_authorizedkey(self, key, comment=None):",
            "        \"\"\"",
            "        Add the given key to the user. Adding the key to his `authorized_keys`",
            "        file if it exists and adding it to database.",
            "        \"\"\"",
            "        # Parse and validate ssh key",
            "        assert key",
            "        key = authorizedkeys.check_publickey(key)",
            "",
            "        # Remove option, replace comments.",
            "        key = authorizedkeys.AuthorizedKey(",
            "            options=None, keytype=key.keytype, key=key.key, comment=comment or key.comment",
            "        )",
            "",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode=\"r+\", encoding='utf-8') as fh:",
            "                if authorizedkeys.exists(fh, key):",
            "                    raise DuplicateSSHKeyError(_(\"SSH key already exists\"))",
            "                logger.info(\"add key [%s] to [%s] authorized_keys\", key, self.username)",
            "                authorizedkeys.add(fh, key)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"add key [%s] to [%s] database\", key, self.username)",
            "            try:",
            "                SshKey(userid=self.userid, fingerprint=key.fingerprint, key=key.getvalue()).add()",
            "            except IntegrityError:",
            "                SshKey.session.rollback()",
            "                raise DuplicateSSHKeyError(",
            "                    _(\"Duplicate key. This key already exists or is associated to another user.\")",
            "                )",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def add_access_token(self, name, expiration_time=None, length=16):",
            "        \"\"\"",
            "        Create a new access token. Return the un-encrypted value of the token.",
            "        \"\"\"",
            "        assert name",
            "        assert length >= 8",
            "        # Generate a random token",
            "        token = ''.join(secrets.choice(string.ascii_lowercase) for i in range(length))",
            "        # Store hash token",
            "        try:",
            "            obj = Token(userid=self.userid, name=name, hash_token=hash_password(token), expiration_time=expiration_time)",
            "            obj.add()",
            "        except IntegrityError:",
            "            Token.session.rollback()",
            "            raise ValueError(_(\"Duplicate token name: %s\") % name)",
            "        cherrypy.engine.publish('access_token_added', self, name)",
            "        return token",
            "",
            "    def valid_user_root(self):",
            "        \"\"\"",
            "        Check if the current user_root is valid and readable",
            "        \"\"\"",
            "        try:",
            "            return os.access(self.user_root, os.F_OK) and os.path.isdir(self.user_root)",
            "        except Exception:",
            "            return False",
            "",
            "    def delete(self, *args, **kwargs):",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "        if self.username == cfg.admin_user:",
            "            raise ValueError(_(\"can't delete admin user\"))",
            "        # FIXME This should be deleted by cascade",
            "        SshKey.query.filter(SshKey.userid == self.userid).delete()",
            "        RepoObject.query.filter(RepoObject.userid == self.userid).delete()",
            "        Token.query.filter(Token.userid == self.userid).delete()",
            "        # Delete ourself",
            "        Base.delete(self)",
            "",
            "    def delete_authorizedkey(self, fingerprint):",
            "        \"\"\"",
            "        Remove the given key from the user. Remove the key from his",
            "        `authorized_keys` file if it exists and from database database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            with open(filename, mode='r+', encoding='utf-8') as fh:",
            "                logger.info(\"removing key [%s] from [%s] authorized_keys\", fingerprint, self.username)",
            "                authorizedkeys.remove(fh, fingerprint)",
            "        else:",
            "            # Also look in database.",
            "            logger.info(\"removing key [%s] from [%s] database\", fingerprint, self.username)",
            "            SshKey.query.filter(and_(SshKey.userid == self.userid, SshKey.fingerprint == fingerprint)).delete()",
            "        cherrypy.engine.publish('user_attr_changed', self, {'authorizedkeys': True})",
            "",
            "    def delete_access_token(self, name):",
            "        assert name",
            "        if not Token.query.filter(Token.userid == self.userid, Token.name == name).delete():",
            "            raise ValueError(_(\"token name doesn't exists: %s\") % name)",
            "",
            "    @property",
            "    def disk_usage(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_usage', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @property",
            "    def disk_quota(self):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return 0",
            "        values = cherrypy.engine.publish('get_disk_quota', self)",
            "        # Return the first not None value",
            "        return next((v for v in values if v is not None), 0)",
            "",
            "    @disk_quota.setter",
            "    def disk_quota(self, value):",
            "        # Skip if user_root is invalid.",
            "        if not self.user_root or not os.path.exists(self.user_root):",
            "            return",
            "        cherrypy.engine.publish('set_disk_quota', self, value)",
            "",
            "    @property",
            "    def authorizedkeys(self):",
            "        \"\"\"",
            "        Return an iterator on the authorized key. Either from his",
            "        `authorized_keys` file if it exists or from database.",
            "        \"\"\"",
            "        # If a filename exists, use it by default.",
            "        filename = os.path.join(self.user_root, '.ssh', 'authorized_keys')",
            "        if os.path.isfile(filename):",
            "            for k in authorizedkeys.read(filename):",
            "                yield k",
            "",
            "        # Also look in database.",
            "        for record in SshKey.query.filter(SshKey.userid == self.userid).all():",
            "            yield authorizedkeys.check_publickey(record.key)",
            "",
            "    def refresh_repos(self, delete=False):",
            "        \"\"\"",
            "        Return list of repositories object to reflect the filesystem folders.",
            "",
            "        Return a RepoObject for each sub directories under `user_root` with `rdiff-backup-data`.",
            "        \"\"\"",
            "        # Update the repositories by walking in the directory tree.",
            "        def _onerror(unused):",
            "            logger.error('error updating user [%s] repos' % self.username, exc_info=1)",
            "",
            "        # Get application config",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        dirty = False",
            "        records = RepoObject.query.filter(RepoObject.userid == self.userid).order_by(RepoObject.repopath).all()",
            "        user_root = os.fsencode(self.user_root)",
            "        for root, dirs, unused_files in os.walk(user_root, _onerror):",
            "            for name in dirs.copy():",
            "                if name.startswith(b'.'):",
            "                    dirs.remove(name)",
            "            if b'rdiff-backup-data' in dirs:",
            "                repopath = os.path.relpath(root, start=user_root)",
            "                del dirs[:]",
            "                # Handle special scenario when the repo is the",
            "                # user_root",
            "                repopath = b'' if repopath == b'.' else repopath",
            "",
            "                # Check if repo path exists.",
            "                record_match = next((record for record in records if record.repopath == os.fsdecode(repopath)), None)",
            "                if not record_match:",
            "                    # Add repository to database.",
            "                    RepoObject(user=self, repopath=os.fsdecode(repopath)).add()",
            "                    dirty = True",
            "                else:",
            "                    records.remove(record_match)",
            "            if root.count(SEP) - user_root.count(SEP) >= cfg.max_depth:",
            "                del dirs[:]",
            "        # If enabled, remove entried from database",
            "        if delete:",
            "            for record in records:",
            "                RepoObject.query.filter(RepoObject.repoid == record.repoid).delete()",
            "        return dirty",
            "",
            "    @hybrid_property",
            "    def is_admin(self):",
            "        return self.role <= self.ADMIN_ROLE",
            "",
            "    @hybrid_property",
            "    def is_ldap(self):",
            "        return self.hash_password is None or self.hash_password == ''",
            "",
            "    @is_ldap.expression",
            "    def is_ldap(cls):",
            "        return or_(cls.hash_password.is_(None), cls.hash_password == '')",
            "",
            "    @hybrid_property",
            "    def is_maintainer(self):",
            "        return self.role <= self.MAINTAINER_ROLE",
            "",
            "    def set_password(self, password):",
            "        \"\"\"",
            "        Change the user's password. Raise a ValueError if the username or",
            "        the password are invalid.",
            "        \"\"\"",
            "        assert isinstance(password, str)",
            "        if not password:",
            "            raise ValueError(\"password can't be empty\")",
            "        cfg = cherrypy.tree.apps[''].cfg",
            "",
            "        # Cannot update admin-password if defined",
            "        if self.username == cfg.admin_user and cfg.admin_password:",
            "            raise ValueError(_(\"can't update admin-password defined in configuration file\"))",
            "",
            "        # Check password length",
            "        if cfg.password_min_length > len(password) or len(password) > cfg.password_max_length:",
            "            raise ValueError(",
            "                _('Password must have between %(min)d and %(max)d characters.')",
            "                % {'min': cfg.password_min_length, 'max': cfg.password_max_length}",
            "            )",
            "",
            "        # Verify password score using zxcvbn",
            "        stats = zxcvbn(password)",
            "        if stats.get('score') < cfg.password_score:",
            "            msg = _('Password too weak.')",
            "            warning = stats.get('feedback', {}).get('warning')",
            "            suggestions = stats.get('feedback', {}).get('suggestions')",
            "            if warning:",
            "                msg += ' ' + warning",
            "            if suggestions:",
            "                msg += ' ' + ' '.join(suggestions)",
            "            raise ValueError(msg)",
            "",
            "        logger.info(\"updating user password [%s]\", self.username)",
            "        self.hash_password = hash_password(password)",
            "",
            "    def __eq__(self, other):",
            "        return type(self) == type(other) and inspect(self).key == inspect(other).key",
            "",
            "    @validates('username')",
            "    def validates_username(self, key, value):",
            "        if self.username:",
            "            raise ValueError('Username cannot be modified.')",
            "        return value",
            "",
            "    def validate_access_token(self, token):",
            "        \"\"\"",
            "        Check if the given token matches.",
            "        \"\"\"",
            "        for access_token in Token.query.all():",
            "            # If token expired. Let delete it.",
            "            if access_token.is_expired:",
            "                access_token.delete()",
            "                continue",
            "            if check_password(token, access_token.hash_token):",
            "                # When it matches, let update the record.",
            "                access_token.access_time = datetime.datetime.utcnow",
            "                return True",
            "        return False",
            "",
            "    def validate_password(self, password):",
            "        return check_password(password, self.hash_password)",
            "",
            "",
            "@event.listens_for(UserObject.hash_password, \"set\")",
            "def hash_password_set(target, value, oldvalue, initiator):",
            "    if value and value != oldvalue:",
            "        cherrypy.engine.publish('user_password_changed', target)",
            "",
            "",
            "@event.listens_for(UserObject, 'after_delete')",
            "def user_after_delete(mapper, connection, target):",
            "    \"\"\"",
            "    Publish event when user is deleted.",
            "    \"\"\"",
            "    cherrypy.engine.publish('user_deleted', target.username)",
            "",
            "",
            "@event.listens_for(UserObject, 'after_update')",
            "def user_attr_changed(mapper, connection, target):",
            "    changes = {}",
            "    state = inspect(target)",
            "    for attr in state.attrs:",
            "        if attr.key in ['user_root', 'email', 'role', 'mfa']:",
            "            hist = attr.load_history()",
            "            if hist.has_changes():",
            "                changes[attr.key] = (",
            "                    hist.deleted[0] if len(hist.deleted) >= 1 else None,",
            "                    hist.added[0] if len(hist.added) >= 1 else None,",
            "                )",
            "    if changes:",
            "        cherrypy.engine.publish('user_attr_changed', target, changes)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "27": [],
            "77": [
                "UserObject"
            ],
            "79": [
                "UserObject"
            ],
            "89": [
                "UserObject"
            ],
            "99": [
                "UserObject"
            ],
            "132": [
                "UserObject",
                "add_user"
            ],
            "386": [
                "UserObject"
            ],
            "387": [
                "UserObject",
                "username"
            ],
            "388": [
                "UserObject",
                "username"
            ],
            "389": [
                "UserObject"
            ],
            "390": [
                "UserObject"
            ],
            "391": [
                "UserObject",
                "username"
            ],
            "392": [
                "UserObject",
                "username"
            ],
            "393": [
                "UserObject",
                "username"
            ],
            "394": [
                "UserObject",
                "username"
            ],
            "395": [
                "UserObject",
                "username"
            ],
            "396": [
                "UserObject"
            ],
            "397": [
                "UserObject"
            ],
            "398": [
                "UserObject",
                "role"
            ],
            "399": [
                "UserObject",
                "role"
            ],
            "400": [
                "UserObject",
                "role"
            ],
            "401": [
                "UserObject",
                "role"
            ],
            "402": [
                "UserObject"
            ],
            "403": [
                "UserObject"
            ],
            "404": [
                "UserObject",
                "role"
            ],
            "405": [
                "UserObject",
                "role"
            ],
            "406": [
                "UserObject",
                "role"
            ],
            "407": [
                "UserObject",
                "role"
            ],
            "408": [
                "UserObject",
                "role"
            ],
            "409": [
                "UserObject"
            ],
            "410": [
                "UserObject"
            ],
            "411": [
                "UserObject",
                "email"
            ],
            "412": [
                "UserObject",
                "email"
            ],
            "413": [
                "UserObject"
            ],
            "414": [
                "UserObject"
            ],
            "415": [
                "UserObject",
                "email"
            ],
            "416": [
                "UserObject",
                "email"
            ],
            "417": [
                "UserObject",
                "email"
            ],
            "418": [
                "UserObject",
                "email"
            ],
            "419": [
                "UserObject",
                "email"
            ],
            "420": [
                "UserObject"
            ],
            "421": [
                "UserObject"
            ],
            "422": [
                "UserObject",
                "user_root"
            ],
            "423": [
                "UserObject",
                "user_root"
            ],
            "424": [
                "UserObject"
            ],
            "425": [
                "UserObject"
            ],
            "426": [
                "UserObject",
                "user_root"
            ],
            "427": [
                "UserObject",
                "user_root"
            ],
            "428": [
                "UserObject",
                "user_root"
            ],
            "429": [
                "UserObject",
                "user_root"
            ],
            "430": [
                "UserObject",
                "user_root"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/model/tests/test_user.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " class UserObjectTest(rdiffweb.test.WebCase):"
            },
            "3": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "4": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    default_config = {"
            },
            "5": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        'email-send-changed-notification': True,"
            },
            "6": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    }"
            },
            "7": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "8": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "     def _read_ssh_key(self):"
            },
            "9": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "         \"\"\"Readthe pub key from test packages\"\"\""
            },
            "10": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 41,
                "PatchRowcode": "         filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_publickey_ssh_rsa.pub')"
            },
            "11": {
                "beforePatchRowNumber": 174,
                "afterPatchRowNumber": 169,
                "PatchRowcode": "         user.refresh_repos()"
            },
            "12": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 170,
                "PatchRowcode": "         self.listener.user_attr_changed.assert_called_with(user, {'user_root': ('', self.testcases)})"
            },
            "13": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "         self.listener.user_attr_changed.reset_mock()"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 172,
                "PatchRowcode": "+        user = UserObject.get_user('larry')"
            },
            "15": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": 173,
                "PatchRowcode": "         user.role = UserObject.ADMIN_ROLE"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 174,
                "PatchRowcode": "+        user.add()"
            },
            "17": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": 175,
                "PatchRowcode": "         self.listener.user_attr_changed.assert_called_with("
            },
            "18": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 176,
                "PatchRowcode": "             user, {'role': (UserObject.USER_ROLE, UserObject.ADMIN_ROLE)}"
            },
            "19": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 177,
                "PatchRowcode": "         )"
            },
            "20": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 178,
                "PatchRowcode": "         self.listener.user_attr_changed.reset_mock()"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 179,
                "PatchRowcode": "+        user = UserObject.get_user('larry')"
            },
            "22": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": 180,
                "PatchRowcode": "         user.email = 'larry@gmail.com'"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 181,
                "PatchRowcode": "+        user.add()"
            },
            "24": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": 182,
                "PatchRowcode": "         self.listener.user_attr_changed.assert_called_with(user, {'email': ('', 'larry@gmail.com')})"
            },
            "25": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "         self.listener.user_attr_changed.reset_mock()"
            },
            "26": {
                "beforePatchRowNumber": 185,
                "afterPatchRowNumber": 184,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on June 30, 2022",
            "",
            "Module to test `user` model.",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "import datetime",
            "import os",
            "from io import StringIO, open",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "import pkg_resources",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError, RepoObject, Token, UserObject",
            "from rdiffweb.core.passwd import check_password",
            "",
            "",
            "class UserObjectTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'email-send-changed-notification': True,",
            "    }",
            "",
            "    def _read_ssh_key(self):",
            "        \"\"\"Readthe pub key from test packages\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_publickey_ssh_rsa.pub')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.readline()",
            "",
            "    def _read_authorized_keys(self):",
            "        \"\"\"Read the content of test_authorized_keys\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_authorized_keys')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.read()",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('access_token_added', self.listener.access_token_added, priority=50)",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_mail, priority=50)",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_login', self.listener.user_login, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('access_token_added', self.listener.access_token_added)",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_mail)",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_login', self.listener.user_login)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def test_add_user(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_updated_by_listener(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        # Given a listener with side effet",
            "        def change_user_obj(userobj):",
            "            userobj.user_root = '/new/value'",
            "",
            "        self.listener.user_added.side_effect = change_user_obj",
            "        # When adding user",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Then lister get called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "        # Then object was updated by listener",
            "        self.assertEqual('/new/value', userobj.user_root)",
            "",
            "    def test_add_user_with_duplicate(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        UserObject.add_user('denise')",
            "        self.listener.user_added.reset_mock()",
            "        with self.assertRaises(ValueError):",
            "            UserObject.add_user('denise')",
            "        # Check if listener called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_user_with_password(self):",
            "        \"\"\"Add user to database with password.\"\"\"",
            "        userobj = UserObject.add_user('jo', 'password')",
            "        self.assertIsNotNone(UserObject.get_user('jo'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_delete_admin_user(self):",
            "        # Trying to delete admin user should raise an error.",
            "        userobj = UserObject.get_user('admin')",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete()",
            "",
            "    def test_users(self):",
            "        # Check admin exists",
            "        self.assertEqual(1, UserObject.query.count())",
            "        # Create user.",
            "        UserObject.add_user('annik')",
            "        users = UserObject.query.all()",
            "        self.assertEqual(2, len(users))",
            "        self.assertEqual('annik', users[1].username)",
            "        # Then 2 user exists",
            "        self.assertEqual(2, UserObject.query.count())",
            "",
            "    def test_get_user(self):",
            "        # Create new user",
            "        user = UserObject.add_user('bernie', 'my-password')",
            "        user.user_root = self.testcases",
            "        user.role = UserObject.ADMIN_ROLE",
            "        user.email = 'bernie@gmail.com'",
            "        user.refresh_repos()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        user.repo_objs[0].maxage = -1",
            "        user.repo_objs[1].maxage = 3",
            "",
            "        # Get user record.",
            "        obj = UserObject.get_user('bernie')",
            "        self.assertIsNotNone(obj)",
            "        self.assertEqual('bernie', obj.username)",
            "        self.assertEqual('bernie@gmail.com', obj.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in obj.repo_objs]))",
            "        self.assertEqual(self.testcases, obj.user_root)",
            "        self.assertEqual(True, obj.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, obj.role)",
            "",
            "        # Get repo object",
            "        self.assertEqual('broker-repo', obj.repo_objs[0].name)",
            "        self.assertEqual(-1, obj.repo_objs[0].maxage)",
            "        self.assertEqual('testcases', obj.repo_objs[1].name)",
            "        self.assertEqual(3, obj.repo_objs[1].maxage)",
            "",
            "    def test_get_user_with_invalid_user(self):",
            "        self.assertIsNone(UserObject.get_user('invalid'))",
            "",
            "    def test_get_set(self):",
            "        user = UserObject.add_user('larry', 'password')",
            "",
            "        self.assertEqual('', user.email)",
            "        self.assertEqual([], user.repo_objs)",
            "        self.assertEqual('', user.user_root)",
            "        self.assertEqual(False, user.is_admin)",
            "        self.assertEqual(UserObject.USER_ROLE, user.role)",
            "",
            "        user.user_root = self.testcases",
            "        user.refresh_repos()",
            "        self.listener.user_attr_changed.assert_called_with(user, {'user_root': ('', self.testcases)})",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user.role = UserObject.ADMIN_ROLE",
            "        self.listener.user_attr_changed.assert_called_with(",
            "            user, {'role': (UserObject.USER_ROLE, UserObject.ADMIN_ROLE)}",
            "        )",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user.email = 'larry@gmail.com'",
            "        self.listener.user_attr_changed.assert_called_with(user, {'email': ('', 'larry@gmail.com')})",
            "        self.listener.user_attr_changed.reset_mock()",
            "",
            "        self.assertEqual('larry@gmail.com', user.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        self.assertEqual(self.testcases, user.user_root)",
            "        self.assertEqual(True, user.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, user.role)",
            "",
            "    def test_set_password_update(self):",
            "        # Given a user in database with a password",
            "        userobj = UserObject.add_user('annik', 'password')",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When updating the user's password",
            "        userobj.set_password('new_password')",
            "        # Then password is SSHA",
            "        self.assertTrue(check_password('new_password', userobj.hash_password))",
            "        # Check if listener called",
            "        self.listener.user_password_changed.assert_called_once_with(userobj)",
            "",
            "    def test_delete_user(self):",
            "        # Given an existing user in database",
            "        userobj = UserObject.add_user('vicky')",
            "        self.assertIsNotNone(UserObject.get_user('vicky'))",
            "        # When deleting that user",
            "        userobj.delete()",
            "        # Then user it no longer in database",
            "        self.assertIsNone(UserObject.get_user('vicky'))",
            "        # Then listner was called",
            "        self.listener.user_deleted.assert_called_once_with('vicky')",
            "",
            "    def test_set_password_empty(self):",
            "        \"\"\"Expect error when trying to update password of invalid user.\"\"\"",
            "        userobj = UserObject.add_user('john')",
            "        with self.assertRaises(ValueError):",
            "            self.assertFalse(userobj.set_password(''))",
            "",
            "    def test_disk_quota(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.disk_quota",
            "",
            "    def test_disk_usage(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        disk_usage = userobj.disk_usage",
            "        self.assertIsInstance(disk_usage, int)",
            "",
            "    def test_add_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user without an authorizedkey file.",
            "        \"\"\"",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys), \"expecting one key\")",
            "        self.assertEqual(\"3c:99:ed:a7:82:a8:71:09:2c:15:3d:78:4a:8c:11:99\", keys[0].fingerprint)",
            "",
            "    def test_add_authorizedkey_duplicate(self):",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "        # Add the same key",
            "        with self.assertRaises(DuplicateSSHKeyError):",
            "            userobj.add_authorizedkey(key)",
            "",
            "    def test_add_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user with an authorizedkey file.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "",
            "        # Create empty authorized_keys file",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        open(filename, 'a').close()",
            "",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # Validate",
            "        with open(filename, 'r') as fh:",
            "            self.assertEqual(key, fh.read())",
            "",
            "    def test_delete_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user without authorizedkey file.",
            "        \"\"\"",
            "        # Update user with ssh keys.",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        for k in authorizedkeys.read(StringIO(data)):",
            "            try:",
            "                userobj.add_authorizedkey(k.getvalue())",
            "            except ValueError:",
            "                # Some ssh key in the testing file are not valid.",
            "                pass",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(2, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys))",
            "",
            "    def test_delete_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user with authorizedkey file.",
            "        \"\"\"",
            "        # Create authorized_keys file",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        with open(filename, 'w') as f:",
            "            f.write(data)",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(5, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(4, len(keys))",
            "",
            "    def test_repo_objs(self):",
            "        # Given a user with a list of repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        repos = sorted(userobj.repo_objs, key=lambda r: r.name)",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in repos])",
            "        # When deleting a repository empty list",
            "        repos[1].delete()",
            "        # Then the repository is removed from the list.",
            "        self.assertEqual(['broker-repo'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_without_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos()",
            "        # Then the list invlaid the invalid repo and new repos",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_single_repo(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.user_root = os.path.join(self.testcases, 'testcases')",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual([''], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_add_access_token(self):",
            "        # Given a user with an email",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = 'test@examples.com'",
            "        userobj.add()",
            "        # When adding a new token",
            "        token = userobj.add_access_token('test')",
            "        # Then a new token get created",
            "        self.assertTrue(token)",
            "        tokenobj = Token.query.filter(Token.userid == userobj.userid).first()",
            "        self.assertTrue(tokenobj)",
            "        self.assertEqual(None, tokenobj.expiration_time)",
            "        self.assertEqual(None, tokenobj.access_time)",
            "        # Then an email is sent to the user.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "        self.listener.queue_mail.assert_called_once()",
            "",
            "    def test_add_access_token_duplicate_name(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When adding a new token with the same name",
            "        with self.assertRaises(ValueError):",
            "            userobj.add_access_token('test')",
            "        # Then token is not created",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # Then an email is not sent.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "",
            "    def test_delete_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an access token",
            "        userobj.delete_access_token('test')",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_access_token_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an invalid access token",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete_access_token('invalid')",
            "        # Then Token not deleted",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_user_remove_access_tokens(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.add_user('testuser', 'password')",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting the user",
            "        userobj.delete()",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is valid",
            "        self.assertTrue(userobj.validate_access_token(token))",
            "",
            "    def test_verify_access_token_with_expired(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token(",
            "            'test', expiration_time=datetime.datetime.now() - datetime.timedelta(seconds=1)",
            "        )",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token(token))",
            "        # Then token get removed",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token_with_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test', expiration_time=datetime.datetime.now())",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token('invalid'))",
            "",
            "",
            "class UserObjectWithAdminPassword(rdiffweb.test.WebCase):",
            "",
            "    # password: test",
            "    default_config = {'admin-password': '{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e'}",
            "",
            "    def setUp(self):",
            "        # Do nothing - We need to skip the default setup to avoid deleting the records.",
            "        pass",
            "",
            "    def test_create_admin_user(self):",
            "        # Given admin-password is configure",
            "        # When database get created",
            "        # Then admin user get created with 'test' password",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertIsNotNone(userobj)",
            "        self.assertEqual('{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e', userobj.hash_password)",
            "        self.assertTrue(check_password('test', userobj.hash_password))",
            "",
            "    def test_set_password(self):",
            "        # Given admin-password is configure",
            "        # When trying to update admin password",
            "        # Then an exception is raised",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        with self.assertRaises(ValueError):",
            "            userobj.set_password('newpassword')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on June 30, 2022",
            "",
            "Module to test `user` model.",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "import datetime",
            "import os",
            "from io import StringIO, open",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "import pkg_resources",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.model import DuplicateSSHKeyError, RepoObject, Token, UserObject",
            "from rdiffweb.core.passwd import check_password",
            "",
            "",
            "class UserObjectTest(rdiffweb.test.WebCase):",
            "    def _read_ssh_key(self):",
            "        \"\"\"Readthe pub key from test packages\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_publickey_ssh_rsa.pub')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.readline()",
            "",
            "    def _read_authorized_keys(self):",
            "        \"\"\"Read the content of test_authorized_keys\"\"\"",
            "        filename = pkg_resources.resource_filename('rdiffweb.core.tests', 'test_authorized_keys')",
            "        with open(filename, 'r', encoding='utf8') as f:",
            "            return f.read()",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('access_token_added', self.listener.access_token_added, priority=50)",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_mail, priority=50)",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_login', self.listener.user_login, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('access_token_added', self.listener.access_token_added)",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_mail)",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_login', self.listener.user_login)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def test_add_user(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_updated_by_listener(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        # Given a listener with side effet",
            "        def change_user_obj(userobj):",
            "            userobj.user_root = '/new/value'",
            "",
            "        self.listener.user_added.side_effect = change_user_obj",
            "        # When adding user",
            "        userobj = UserObject.add_user('joe')",
            "        self.assertIsNotNone(userobj)",
            "        self.assertIsNotNone(UserObject.get_user('joe'))",
            "        # Then lister get called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "        # Then object was updated by listener",
            "        self.assertEqual('/new/value', userobj.user_root)",
            "",
            "    def test_add_user_with_duplicate(self):",
            "        \"\"\"Add user to database.\"\"\"",
            "        UserObject.add_user('denise')",
            "        self.listener.user_added.reset_mock()",
            "        with self.assertRaises(ValueError):",
            "            UserObject.add_user('denise')",
            "        # Check if listener called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_user_with_password(self):",
            "        \"\"\"Add user to database with password.\"\"\"",
            "        userobj = UserObject.add_user('jo', 'password')",
            "        self.assertIsNotNone(UserObject.get_user('jo'))",
            "        # Check if listener called",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_delete_admin_user(self):",
            "        # Trying to delete admin user should raise an error.",
            "        userobj = UserObject.get_user('admin')",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete()",
            "",
            "    def test_users(self):",
            "        # Check admin exists",
            "        self.assertEqual(1, UserObject.query.count())",
            "        # Create user.",
            "        UserObject.add_user('annik')",
            "        users = UserObject.query.all()",
            "        self.assertEqual(2, len(users))",
            "        self.assertEqual('annik', users[1].username)",
            "        # Then 2 user exists",
            "        self.assertEqual(2, UserObject.query.count())",
            "",
            "    def test_get_user(self):",
            "        # Create new user",
            "        user = UserObject.add_user('bernie', 'my-password')",
            "        user.user_root = self.testcases",
            "        user.role = UserObject.ADMIN_ROLE",
            "        user.email = 'bernie@gmail.com'",
            "        user.refresh_repos()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        user.repo_objs[0].maxage = -1",
            "        user.repo_objs[1].maxage = 3",
            "",
            "        # Get user record.",
            "        obj = UserObject.get_user('bernie')",
            "        self.assertIsNotNone(obj)",
            "        self.assertEqual('bernie', obj.username)",
            "        self.assertEqual('bernie@gmail.com', obj.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in obj.repo_objs]))",
            "        self.assertEqual(self.testcases, obj.user_root)",
            "        self.assertEqual(True, obj.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, obj.role)",
            "",
            "        # Get repo object",
            "        self.assertEqual('broker-repo', obj.repo_objs[0].name)",
            "        self.assertEqual(-1, obj.repo_objs[0].maxage)",
            "        self.assertEqual('testcases', obj.repo_objs[1].name)",
            "        self.assertEqual(3, obj.repo_objs[1].maxage)",
            "",
            "    def test_get_user_with_invalid_user(self):",
            "        self.assertIsNone(UserObject.get_user('invalid'))",
            "",
            "    def test_get_set(self):",
            "        user = UserObject.add_user('larry', 'password')",
            "",
            "        self.assertEqual('', user.email)",
            "        self.assertEqual([], user.repo_objs)",
            "        self.assertEqual('', user.user_root)",
            "        self.assertEqual(False, user.is_admin)",
            "        self.assertEqual(UserObject.USER_ROLE, user.role)",
            "",
            "        user.user_root = self.testcases",
            "        user.refresh_repos()",
            "        self.listener.user_attr_changed.assert_called_with(user, {'user_root': ('', self.testcases)})",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user = UserObject.get_user('larry')",
            "        user.role = UserObject.ADMIN_ROLE",
            "        user.add()",
            "        self.listener.user_attr_changed.assert_called_with(",
            "            user, {'role': (UserObject.USER_ROLE, UserObject.ADMIN_ROLE)}",
            "        )",
            "        self.listener.user_attr_changed.reset_mock()",
            "        user = UserObject.get_user('larry')",
            "        user.email = 'larry@gmail.com'",
            "        user.add()",
            "        self.listener.user_attr_changed.assert_called_with(user, {'email': ('', 'larry@gmail.com')})",
            "        self.listener.user_attr_changed.reset_mock()",
            "",
            "        self.assertEqual('larry@gmail.com', user.email)",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in user.repo_objs]))",
            "        self.assertEqual(self.testcases, user.user_root)",
            "        self.assertEqual(True, user.is_admin)",
            "        self.assertEqual(UserObject.ADMIN_ROLE, user.role)",
            "",
            "    def test_set_password_update(self):",
            "        # Given a user in database with a password",
            "        userobj = UserObject.add_user('annik', 'password')",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When updating the user's password",
            "        userobj.set_password('new_password')",
            "        # Then password is SSHA",
            "        self.assertTrue(check_password('new_password', userobj.hash_password))",
            "        # Check if listener called",
            "        self.listener.user_password_changed.assert_called_once_with(userobj)",
            "",
            "    def test_delete_user(self):",
            "        # Given an existing user in database",
            "        userobj = UserObject.add_user('vicky')",
            "        self.assertIsNotNone(UserObject.get_user('vicky'))",
            "        # When deleting that user",
            "        userobj.delete()",
            "        # Then user it no longer in database",
            "        self.assertIsNone(UserObject.get_user('vicky'))",
            "        # Then listner was called",
            "        self.listener.user_deleted.assert_called_once_with('vicky')",
            "",
            "    def test_set_password_empty(self):",
            "        \"\"\"Expect error when trying to update password of invalid user.\"\"\"",
            "        userobj = UserObject.add_user('john')",
            "        with self.assertRaises(ValueError):",
            "            self.assertFalse(userobj.set_password(''))",
            "",
            "    def test_disk_quota(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.disk_quota",
            "",
            "    def test_disk_usage(self):",
            "        \"\"\"",
            "        Just make a call to the function.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        disk_usage = userobj.disk_usage",
            "        self.assertIsInstance(disk_usage, int)",
            "",
            "    def test_add_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user without an authorizedkey file.",
            "        \"\"\"",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys), \"expecting one key\")",
            "        self.assertEqual(\"3c:99:ed:a7:82:a8:71:09:2c:15:3d:78:4a:8c:11:99\", keys[0].fingerprint)",
            "",
            "    def test_add_authorizedkey_duplicate(self):",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        # Add the key to the user",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_authorizedkey(key)",
            "        # Add the same key",
            "        with self.assertRaises(DuplicateSSHKeyError):",
            "            userobj.add_authorizedkey(key)",
            "",
            "    def test_add_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Add an ssh key for a user with an authorizedkey file.",
            "        \"\"\"",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "",
            "        # Create empty authorized_keys file",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        open(filename, 'a').close()",
            "",
            "        # Read the pub key",
            "        key = self._read_ssh_key()",
            "        userobj.add_authorizedkey(key)",
            "",
            "        # Validate",
            "        with open(filename, 'r') as fh:",
            "            self.assertEqual(key, fh.read())",
            "",
            "    def test_delete_authorizedkey_without_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user without authorizedkey file.",
            "        \"\"\"",
            "        # Update user with ssh keys.",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        for k in authorizedkeys.read(StringIO(data)):",
            "            try:",
            "                userobj.add_authorizedkey(k.getvalue())",
            "            except ValueError:",
            "                # Some ssh key in the testing file are not valid.",
            "                pass",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(2, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(1, len(keys))",
            "",
            "    def test_delete_authorizedkey_with_file(self):",
            "        \"\"\"",
            "        Remove an ssh key for a user with authorizedkey file.",
            "        \"\"\"",
            "        # Create authorized_keys file",
            "        data = self._read_authorized_keys()",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        os.mkdir(os.path.join(userobj.user_root, '.ssh'))",
            "        filename = os.path.join(userobj.user_root, '.ssh', 'authorized_keys')",
            "        with open(filename, 'w') as f:",
            "            f.write(data)",
            "",
            "        # Get the keys",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(5, len(keys))",
            "",
            "        # Remove a key",
            "        userobj.delete_authorizedkey(\"9a:f1:69:3c:bc:5a:cd:02:5e:33:bc:cd:c0:01:eb:4c\")",
            "",
            "        # Validate",
            "        keys = list(userobj.authorizedkeys)",
            "        self.assertEqual(4, len(keys))",
            "",
            "    def test_repo_objs(self):",
            "        # Given a user with a list of repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        repos = sorted(userobj.repo_objs, key=lambda r: r.name)",
            "        self.assertEqual(['broker-repo', 'testcases'], [r.name for r in repos])",
            "        # When deleting a repository empty list",
            "        repos[1].delete()",
            "        # Then the repository is removed from the list.",
            "        self.assertEqual(['broker-repo'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_without_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos()",
            "        # Then the list invlaid the invalid repo and new repos",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_delete(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject.query.delete()",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['invalid'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_refresh_repos_with_single_repo(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.user_root = os.path.join(self.testcases, 'testcases')",
            "        # When updating the repository list without deletion",
            "        userobj.refresh_repos(delete=True)",
            "        # Then the list invlaid the invalid repo and new repos",
            "        userobj.expire()",
            "        self.assertEqual([''], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_add_access_token(self):",
            "        # Given a user with an email",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.email = 'test@examples.com'",
            "        userobj.add()",
            "        # When adding a new token",
            "        token = userobj.add_access_token('test')",
            "        # Then a new token get created",
            "        self.assertTrue(token)",
            "        tokenobj = Token.query.filter(Token.userid == userobj.userid).first()",
            "        self.assertTrue(tokenobj)",
            "        self.assertEqual(None, tokenobj.expiration_time)",
            "        self.assertEqual(None, tokenobj.access_time)",
            "        # Then an email is sent to the user.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "        self.listener.queue_mail.assert_called_once()",
            "",
            "    def test_add_access_token_duplicate_name(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When adding a new token with the same name",
            "        with self.assertRaises(ValueError):",
            "            userobj.add_access_token('test')",
            "        # Then token is not created",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # Then an email is not sent.",
            "        self.listener.access_token_added.assert_called_once_with(userobj, 'test')",
            "",
            "    def test_delete_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an access token",
            "        userobj.delete_access_token('test')",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_access_token_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting an invalid access token",
            "        with self.assertRaises(ValueError):",
            "            userobj.delete_access_token('invalid')",
            "        # Then Token not deleted",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_delete_user_remove_access_tokens(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.add_user('testuser', 'password')",
            "        userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When deleting the user",
            "        userobj.delete()",
            "        # Then Token get deleted",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token('test')",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is valid",
            "        self.assertTrue(userobj.validate_access_token(token))",
            "",
            "    def test_verify_access_token_with_expired(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        token = userobj.add_access_token(",
            "            'test', expiration_time=datetime.datetime.now() - datetime.timedelta(seconds=1)",
            "        )",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token(token))",
            "        # Then token get removed",
            "        self.assertEqual(0, Token.query.filter(Token.userid == userobj.userid).count())",
            "",
            "    def test_verify_access_token_with_invalid(self):",
            "        # Given a user with an existing token",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        userobj.add_access_token('test', expiration_time=datetime.datetime.now())",
            "        self.assertEqual(1, Token.query.filter(Token.userid == userobj.userid).count())",
            "        # When validating the token",
            "        # Then token is invalid",
            "        self.assertFalse(userobj.validate_access_token('invalid'))",
            "",
            "",
            "class UserObjectWithAdminPassword(rdiffweb.test.WebCase):",
            "",
            "    # password: test",
            "    default_config = {'admin-password': '{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e'}",
            "",
            "    def setUp(self):",
            "        # Do nothing - We need to skip the default setup to avoid deleting the records.",
            "        pass",
            "",
            "    def test_create_admin_user(self):",
            "        # Given admin-password is configure",
            "        # When database get created",
            "        # Then admin user get created with 'test' password",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        self.assertIsNotNone(userobj)",
            "        self.assertEqual('{SSHA}wbSK4hlEX7mtGJplFi2oN6ABm6Y3Bo1e', userobj.hash_password)",
            "        self.assertTrue(check_password('test', userobj.hash_password))",
            "",
            "    def test_set_password(self):",
            "        # Given admin-password is configure",
            "        # When trying to update admin password",
            "        # Then an exception is raised",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        with self.assertRaises(ValueError):",
            "            userobj.set_password('newpassword')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "39": [
                "UserObjectTest"
            ],
            "40": [
                "UserObjectTest"
            ],
            "41": [
                "UserObjectTest"
            ],
            "42": [
                "UserObjectTest"
            ],
            "43": [
                "UserObjectTest"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/notification.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "             return"
            },
            "1": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 79,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "         # Leave if the mail was not changed."
            },
            "3": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if 'email' not in attrs:"
            },
            "4": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return"
            },
            "5": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "6": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        old_email = attrs['email'][0]"
            },
            "7": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if not old_email:"
            },
            "8": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)"
            },
            "9": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return"
            },
            "10": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "11": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # If the email attributes was changed, send a mail notification."
            },
            "12": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        body = self.app.templates.compile_template("
            },
            "13": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"email_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}"
            },
            "14": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        )"
            },
            "15": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.bus.publish('queue_mail', to=old_email, subject=_(\"Email address changed\"), message=body)"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+        if 'email' in attrs:"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+            old_email = attrs['email'][0]"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+            if not old_email:"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+                return"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+            # If the email attributes was changed, send a mail notification."
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+            subject = _(\"Email address changed\")"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+            body = self.app.templates.compile_template("
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+                \"email_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+            )"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+            self.bus.publish('queue_mail', to=old_email, subject=str(subject), message=body)"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        if 'mfa' in attrs:"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+            if not userobj.email:"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+                return"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+            subject = ("
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+                _(\"Two-Factor Authentication turned off\")"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+                if userobj.mfa == UserObject.DISABLED_MFA"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+                else _(\"Two-Factor Authentication turned on\")"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+            )"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+            body = self.app.templates.compile_template("
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+            )"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+            self.bus.publish('queue_mail', to=userobj.email, subject=str(subject), message=body)"
            },
            "41": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 106,
                "PatchRowcode": " "
            },
            "42": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 107,
                "PatchRowcode": "     def user_password_changed(self, userobj):"
            },
            "43": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 108,
                "PatchRowcode": "         if not self.send_changed:"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugin used to send email to users when their repository is getting too old.",
            "User can control the notification period.",
            "\"\"\"",
            "",
            "import datetime",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy.process.plugins import SimplePlugin",
            "",
            "from rdiffweb.core import librdiff",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class NotificationPlugin(SimplePlugin):",
            "    \"\"\"",
            "    Send email notification when a repository get too old (without a backup).",
            "    \"\"\"",
            "",
            "    execution_time = '23:00'",
            "",
            "    send_changed = False",
            "",
            "    def start(self):",
            "        self.bus.log('Start Notification plugin')",
            "        self.bus.publish('schedule_job', self.execution_time, self.notification_job)",
            "        self.bus.subscribe('access_token_added', self.access_token_added)",
            "        self.bus.subscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.subscribe('user_password_changed', self.user_password_changed)",
            "",
            "    def stop(self):",
            "        self.bus.log('Stop Notification plugin')",
            "        self.bus.publish('unschedule_job', self.notification_job)",
            "        self.bus.unsubscribe('access_token_added', self.access_token_added)",
            "        self.bus.unsubscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.unsubscribe('user_password_changed', self.user_password_changed)",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.tree.apps['']",
            "",
            "    def access_token_added(self, userobj, name):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # Send a mail notification",
            "        body = self.app.templates.compile_template(",
            "            \"access_token_added.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'name': name}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"A new access token has been created\"), message=body)",
            "",
            "    def user_attr_changed(self, userobj, attrs={}):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        # Leave if the mail was not changed.",
            "        if 'email' not in attrs:",
            "            return",
            "",
            "        old_email = attrs['email'][0]",
            "        if not old_email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # If the email attributes was changed, send a mail notification.",
            "        body = self.app.templates.compile_template(",
            "            \"email_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "        )",
            "        self.bus.publish('queue_mail', to=old_email, subject=_(\"Email address changed\"), message=body)",
            "",
            "    def user_password_changed(self, userobj):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # If the email attributes was changed, send a mail notification.",
            "        body = self.app.templates.compile_template(",
            "            \"password_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"Password changed\"), message=body)",
            "",
            "    def notification_job(self):",
            "        \"\"\"",
            "        Loop trough all the user repository and send notifications.",
            "        \"\"\"",
            "",
            "        now = librdiff.RdiffTime()",
            "",
            "        def _user_repos():",
            "            \"\"\"Return a generator trought user repos to be notified.\"\"\"",
            "            for user in UserObject.query.all():",
            "                # Check if user has email.",
            "                if not user.email:",
            "                    continue",
            "                # Identify old repo for current user.",
            "                old_repos = []",
            "                for repo in user.repo_objs:",
            "                    # Check if repo has age configured (in days)",
            "                    maxage = repo.maxage",
            "                    if not maxage or maxage <= 0:",
            "                        continue",
            "                    # Check repo age.",
            "                    if repo.last_backup_date is None or repo.last_backup_date < (now - datetime.timedelta(days=maxage)):",
            "                        old_repos.append(repo)",
            "                # Return an item only if user had old repo",
            "                if old_repos:",
            "                    yield user, old_repos",
            "",
            "        # For each candidate, send mail.",
            "        for user, repos in _user_repos():",
            "            parms = {'user': user, 'repos': repos}",
            "            body = self.app.templates.compile_template(\"email_notification.html\", **parms)",
            "            cherrypy.engine.publish('queue_mail', to=user.email, subject=_(\"Notification\"), message=body)",
            "",
            "",
            "cherrypy.notification = NotificationPlugin(cherrypy.engine)",
            "cherrypy.notification.subscribe()",
            "",
            "cherrypy.config.namespaces['notification'] = lambda key, value: setattr(cherrypy.notification, key, value)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugin used to send email to users when their repository is getting too old.",
            "User can control the notification period.",
            "\"\"\"",
            "",
            "import datetime",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy.process.plugins import SimplePlugin",
            "",
            "from rdiffweb.core import librdiff",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class NotificationPlugin(SimplePlugin):",
            "    \"\"\"",
            "    Send email notification when a repository get too old (without a backup).",
            "    \"\"\"",
            "",
            "    execution_time = '23:00'",
            "",
            "    send_changed = False",
            "",
            "    def start(self):",
            "        self.bus.log('Start Notification plugin')",
            "        self.bus.publish('schedule_job', self.execution_time, self.notification_job)",
            "        self.bus.subscribe('access_token_added', self.access_token_added)",
            "        self.bus.subscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.subscribe('user_password_changed', self.user_password_changed)",
            "",
            "    def stop(self):",
            "        self.bus.log('Stop Notification plugin')",
            "        self.bus.publish('unschedule_job', self.notification_job)",
            "        self.bus.unsubscribe('access_token_added', self.access_token_added)",
            "        self.bus.unsubscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.unsubscribe('user_password_changed', self.user_password_changed)",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.tree.apps['']",
            "",
            "    def access_token_added(self, userobj, name):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # Send a mail notification",
            "        body = self.app.templates.compile_template(",
            "            \"access_token_added.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'name': name}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"A new access token has been created\"), message=body)",
            "",
            "    def user_attr_changed(self, userobj, attrs={}):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        # Leave if the mail was not changed.",
            "        if 'email' in attrs:",
            "            old_email = attrs['email'][0]",
            "            if not old_email:",
            "                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "                return",
            "            # If the email attributes was changed, send a mail notification.",
            "            subject = _(\"Email address changed\")",
            "            body = self.app.templates.compile_template(",
            "                \"email_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "            )",
            "            self.bus.publish('queue_mail', to=old_email, subject=str(subject), message=body)",
            "",
            "        if 'mfa' in attrs:",
            "            if not userobj.email:",
            "                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "                return",
            "            subject = (",
            "                _(\"Two-Factor Authentication turned off\")",
            "                if userobj.mfa == UserObject.DISABLED_MFA",
            "                else _(\"Two-Factor Authentication turned on\")",
            "            )",
            "            body = self.app.templates.compile_template(",
            "                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "            )",
            "            self.bus.publish('queue_mail', to=userobj.email, subject=str(subject), message=body)",
            "",
            "    def user_password_changed(self, userobj):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # If the email attributes was changed, send a mail notification.",
            "        body = self.app.templates.compile_template(",
            "            \"password_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"Password changed\"), message=body)",
            "",
            "    def notification_job(self):",
            "        \"\"\"",
            "        Loop trough all the user repository and send notifications.",
            "        \"\"\"",
            "",
            "        now = librdiff.RdiffTime()",
            "",
            "        def _user_repos():",
            "            \"\"\"Return a generator trought user repos to be notified.\"\"\"",
            "            for user in UserObject.query.all():",
            "                # Check if user has email.",
            "                if not user.email:",
            "                    continue",
            "                # Identify old repo for current user.",
            "                old_repos = []",
            "                for repo in user.repo_objs:",
            "                    # Check if repo has age configured (in days)",
            "                    maxage = repo.maxage",
            "                    if not maxage or maxage <= 0:",
            "                        continue",
            "                    # Check repo age.",
            "                    if repo.last_backup_date is None or repo.last_backup_date < (now - datetime.timedelta(days=maxage)):",
            "                        old_repos.append(repo)",
            "                # Return an item only if user had old repo",
            "                if old_repos:",
            "                    yield user, old_repos",
            "",
            "        # For each candidate, send mail.",
            "        for user, repos in _user_repos():",
            "            parms = {'user': user, 'repos': repos}",
            "            body = self.app.templates.compile_template(\"email_notification.html\", **parms)",
            "            cherrypy.engine.publish('queue_mail', to=user.email, subject=_(\"Notification\"), message=body)",
            "",
            "",
            "cherrypy.notification = NotificationPlugin(cherrypy.engine)",
            "cherrypy.notification.subscribe()",
            "",
            "cherrypy.config.namespaces['notification'] = lambda key, value: setattr(cherrypy.notification, key, value)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "81": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "82": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "83": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "84": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "85": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "86": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "87": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "88": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "89": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "90": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "91": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "92": [
                "NotificationPlugin",
                "user_attr_changed"
            ],
            "93": [
                "NotificationPlugin",
                "user_attr_changed"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/tests/test_notification.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 118,
                "PatchRowcode": "         # Given a user with an email address"
            },
            "1": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 119,
                "PatchRowcode": "         user = UserObject.get_user(self.USERNAME)"
            },
            "2": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 120,
                "PatchRowcode": "         user.email = 'original_email@test.com'"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+        user.add()"
            },
            "4": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 122,
                "PatchRowcode": "         self.listener.queue_email.reset_mock()"
            },
            "5": {
                "beforePatchRowNumber": 122,
                "afterPatchRowNumber": 123,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 123,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "         # When updating the user's email"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+        user = UserObject.get_user(self.USERNAME)"
            },
            "8": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "         user.email = 'email_changed@test.com'"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+        user.add()"
            },
            "10": {
                "beforePatchRowNumber": 125,
                "afterPatchRowNumber": 128,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 129,
                "PatchRowcode": "         # Then a email is queue to notify the user."
            },
            "12": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": 130,
                "PatchRowcode": "         self.listener.queue_email.assert_called_once_with("
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "\"\"\"",
            "Created on Feb 13, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.core.notification",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class NotificationJobTest(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_notification_job(self):",
            "        \"\"\"",
            "        Run the notification and check if mails are sent",
            "        \"\"\"",
            "        # Given a user with an email address and a repository with a maxage",
            "        # Set user config",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = 1",
            "        repo.add()",
            "        # When running notification_job",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then an email is queue for this user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>testcases</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_undefined_last_backup_date(self):",
            "        # Given a valid user with a repository configured for notification",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add()",
            "        # Given a repo with last_backup_date None",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == 'broker-repo').first()",
            "        repo.maxage = 1",
            "        repo.add()",
            "        self.assertIsNone(repo.last_backup_date)",
            "",
            "        # When Notification job is running",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then a notification is sent to the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>broker-repo</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_without_notification(self):",
            "        # Given a valid user with a repository configured without notification (-1)",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = -1",
            "        repo.add()",
            "",
            "        # Call notification.",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Expect it to be called.",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "",
            "class NotificationPluginTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'email-send-changed-notification': True,",
            "    }",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_email_changed(self):",
            "        # Given a user with an email address",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'original_email@test.com'",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email",
            "        user.email = 'email_changed@test.com'",
            "",
            "        # Then a email is queue to notify the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='original_email@test.com',",
            "            subject='Email address changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the email address associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_email_updated_with_same_value(self):",
            "        # Given a user with an email",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'email_changed@test.com'",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email with the same value",
            "        user.email = 'email_changed@test.com'",
            "",
            "        # Then no email are sent to the user",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "    def test_password_change_notification(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password",
            "        user.set_password('new_password')",
            "",
            "        # Then a email is send to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_password_change_with_same_value(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        user.set_password('new_password')",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password with the same value",
            "        user.set_password('new_password')",
            "",
            "        # Then an email is sent to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "\"\"\"",
            "Created on Feb 13, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.core.notification",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class NotificationJobTest(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_notification_job(self):",
            "        \"\"\"",
            "        Run the notification and check if mails are sent",
            "        \"\"\"",
            "        # Given a user with an email address and a repository with a maxage",
            "        # Set user config",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = 1",
            "        repo.add()",
            "        # When running notification_job",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then an email is queue for this user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>testcases</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_undefined_last_backup_date(self):",
            "        # Given a valid user with a repository configured for notification",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add()",
            "        # Given a repo with last_backup_date None",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == 'broker-repo').first()",
            "        repo.maxage = 1",
            "        repo.add()",
            "        self.assertIsNone(repo.last_backup_date)",
            "",
            "        # When Notification job is running",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then a notification is sent to the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>broker-repo</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_without_notification(self):",
            "        # Given a valid user with a repository configured without notification (-1)",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = -1",
            "        repo.add()",
            "",
            "        # Call notification.",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Expect it to be called.",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "",
            "class NotificationPluginTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'email-send-changed-notification': True,",
            "    }",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_email_changed(self):",
            "        # Given a user with an email address",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'original_email@test.com'",
            "        user.add()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'email_changed@test.com'",
            "        user.add()",
            "",
            "        # Then a email is queue to notify the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='original_email@test.com',",
            "            subject='Email address changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the email address associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_email_updated_with_same_value(self):",
            "        # Given a user with an email",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'email_changed@test.com'",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email with the same value",
            "        user.email = 'email_changed@test.com'",
            "",
            "        # Then no email are sent to the user",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "    def test_password_change_notification(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password",
            "        user.set_password('new_password')",
            "",
            "        # Then a email is send to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_password_change_with_same_value(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        user.set_password('new_password')",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password with the same value",
            "        user.set_password('new_password')",
            "",
            "        # Then an email is sent to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "ckan.tests.logic.action.test_create.TestResourceCreate.test_mimetype_by_upload_by_filename"
        ]
    }
}