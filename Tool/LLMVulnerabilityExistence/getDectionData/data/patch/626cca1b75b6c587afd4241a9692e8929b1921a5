{
    "rdiffweb/controller/pref_sshkeys.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "     title = StringField("
            },
            "1": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         _('Title'),"
            },
            "2": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "         description=_('The title is an optional description to identify the key. e.g.: bob@thinkpad-t530'),"
            },
            "3": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        validators=[validators.data_required()],"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+        validators=["
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+            validators.data_required(),"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+            validators.length("
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+                max=256,"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+                message=_('Title too long.'),"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+            ),"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+        ],"
            },
            "11": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "     )"
            },
            "12": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "     key = StringField("
            },
            "13": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "         _('Key'),"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugins to allows users to configure the SSH keys using the web",
            "interface. Basically it's a UI for `~/.ssh/authorized_keys`. For this",
            "plugin to work properly, the users home directory need to match a real",
            "user home.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "from wtforms import validators",
            "from wtforms.fields.core import StringField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets.core import TextArea",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.store import DuplicateSSHKeyError",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "_logger = logging.getLogger(__name__)",
            "",
            "",
            "def validate_key(unused_form, field):",
            "    \"\"\"Custom validator to check the SSH Key.\"\"\"",
            "    try:",
            "        authorizedkeys.check_publickey(field.data)",
            "    except ValueError:",
            "        raise ValidationError(_(\"Invalid SSH key.\"))",
            "",
            "",
            "class SshForm(CherryForm):",
            "    title = StringField(",
            "        _('Title'),",
            "        description=_('The title is an optional description to identify the key. e.g.: bob@thinkpad-t530'),",
            "        validators=[validators.data_required()],",
            "    )",
            "    key = StringField(",
            "        _('Key'),",
            "        widget=TextArea(),",
            "        description=_(",
            "            \"Enter a SSH public key. It should start with 'ssh-dss', 'ssh-ed25519', 'ssh-rsa', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384' or 'ecdsa-sha2-nistp521'.\"",
            "        ),",
            "        validators=[validators.data_required(), validate_key],",
            "    )",
            "    fingerprint = StringField('Fingerprint')",
            "",
            "",
            "class DeleteSshForm(CherryForm):",
            "    fingerprint = StringField('Fingerprint')",
            "",
            "",
            "class SSHKeysPlugin(Controller):",
            "    \"\"\"",
            "    Plugin to configure SSH keys.",
            "    \"\"\"",
            "",
            "    panel_id = 'sshkeys'",
            "",
            "    panel_name = _('SSH Keys')",
            "",
            "    def _add_key(self, action, form):",
            "        assert action == 'add'",
            "        assert form",
            "        if not form.validate():",
            "            for unused, messages in form.errors.items():",
            "                for message in messages:",
            "                    flash(message, level='warning')",
            "            return",
            "        try:",
            "            self.app.currentuser.add_authorizedkey(key=form.key.data, comment=form.title.data)",
            "        except DuplicateSSHKeyError as e:",
            "            flash(str(e), level='error')",
            "        except Exception:",
            "            flash(_(\"Unknown error while adding the SSH Key\"), level='error')",
            "            _logger.warning(\"error adding ssh key\", exc_info=1)",
            "",
            "    def _delete_key(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        if not form.validate():",
            "            for unused, messages in form.errors.items():",
            "                for message in messages:",
            "                    flash(message, level='warning')",
            "            return",
            "        is_maintainer()",
            "        try:",
            "            self.app.currentuser.delete_authorizedkey(form.fingerprint.data)",
            "        except Exception:",
            "            flash(_(\"Unknown error while removing the SSH Key\"), level='error')",
            "            _logger.warning(\"error removing ssh key\", exc_info=1)",
            "",
            "    def render_prefs_panel(self, panelid, action=None, **kwargs):  # @UnusedVariable",
            "",
            "        # Handle action",
            "        form = SshForm()",
            "        delete_form = DeleteSshForm()",
            "        if action == \"add\" and form.is_submitted():",
            "            self._add_key(action, form)",
            "        elif action == 'delete' and delete_form.is_submitted():",
            "            self._delete_key(action, DeleteSshForm())",
            "",
            "        # Get SSH keys if file exists.",
            "        params = {'form': form}",
            "        try:",
            "            params[\"sshkeys\"] = [",
            "                {'title': key.comment or (key.keytype + ' ' + key.key[:18]), 'fingerprint': key.fingerprint}",
            "                for key in self.app.currentuser.authorizedkeys",
            "            ]",
            "        except IOError:",
            "            params[\"sshkeys\"] = []",
            "            flash(_(\"Failed to get SSH keys\"), level='error')",
            "            _logger.warning(\"error reading SSH keys\", exc_info=1)",
            "",
            "        return \"prefs_sshkeys.html\", params"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugins to allows users to configure the SSH keys using the web",
            "interface. Basically it's a UI for `~/.ssh/authorized_keys`. For this",
            "plugin to work properly, the users home directory need to match a real",
            "user home.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "from wtforms import validators",
            "from wtforms.fields.core import StringField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets.core import TextArea",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.controller.filter_authorization import is_maintainer",
            "from rdiffweb.core import authorizedkeys",
            "from rdiffweb.core.store import DuplicateSSHKeyError",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "_logger = logging.getLogger(__name__)",
            "",
            "",
            "def validate_key(unused_form, field):",
            "    \"\"\"Custom validator to check the SSH Key.\"\"\"",
            "    try:",
            "        authorizedkeys.check_publickey(field.data)",
            "    except ValueError:",
            "        raise ValidationError(_(\"Invalid SSH key.\"))",
            "",
            "",
            "class SshForm(CherryForm):",
            "    title = StringField(",
            "        _('Title'),",
            "        description=_('The title is an optional description to identify the key. e.g.: bob@thinkpad-t530'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(",
            "                max=256,",
            "                message=_('Title too long.'),",
            "            ),",
            "        ],",
            "    )",
            "    key = StringField(",
            "        _('Key'),",
            "        widget=TextArea(),",
            "        description=_(",
            "            \"Enter a SSH public key. It should start with 'ssh-dss', 'ssh-ed25519', 'ssh-rsa', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384' or 'ecdsa-sha2-nistp521'.\"",
            "        ),",
            "        validators=[validators.data_required(), validate_key],",
            "    )",
            "    fingerprint = StringField('Fingerprint')",
            "",
            "",
            "class DeleteSshForm(CherryForm):",
            "    fingerprint = StringField('Fingerprint')",
            "",
            "",
            "class SSHKeysPlugin(Controller):",
            "    \"\"\"",
            "    Plugin to configure SSH keys.",
            "    \"\"\"",
            "",
            "    panel_id = 'sshkeys'",
            "",
            "    panel_name = _('SSH Keys')",
            "",
            "    def _add_key(self, action, form):",
            "        assert action == 'add'",
            "        assert form",
            "        if not form.validate():",
            "            for unused, messages in form.errors.items():",
            "                for message in messages:",
            "                    flash(message, level='warning')",
            "            return",
            "        try:",
            "            self.app.currentuser.add_authorizedkey(key=form.key.data, comment=form.title.data)",
            "        except DuplicateSSHKeyError as e:",
            "            flash(str(e), level='error')",
            "        except Exception:",
            "            flash(_(\"Unknown error while adding the SSH Key\"), level='error')",
            "            _logger.warning(\"error adding ssh key\", exc_info=1)",
            "",
            "    def _delete_key(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        if not form.validate():",
            "            for unused, messages in form.errors.items():",
            "                for message in messages:",
            "                    flash(message, level='warning')",
            "            return",
            "        is_maintainer()",
            "        try:",
            "            self.app.currentuser.delete_authorizedkey(form.fingerprint.data)",
            "        except Exception:",
            "            flash(_(\"Unknown error while removing the SSH Key\"), level='error')",
            "            _logger.warning(\"error removing ssh key\", exc_info=1)",
            "",
            "    def render_prefs_panel(self, panelid, action=None, **kwargs):  # @UnusedVariable",
            "",
            "        # Handle action",
            "        form = SshForm()",
            "        delete_form = DeleteSshForm()",
            "        if action == \"add\" and form.is_submitted():",
            "            self._add_key(action, form)",
            "        elif action == 'delete' and delete_form.is_submitted():",
            "            self._delete_key(action, DeleteSshForm())",
            "",
            "        # Get SSH keys if file exists.",
            "        params = {'form': form}",
            "        try:",
            "            params[\"sshkeys\"] = [",
            "                {'title': key.comment or (key.keytype + ' ' + key.key[:18]), 'fingerprint': key.fingerprint}",
            "                for key in self.app.currentuser.authorizedkeys",
            "            ]",
            "        except IOError:",
            "            params[\"sshkeys\"] = []",
            "            flash(_(\"Failed to get SSH keys\"), level='error')",
            "            _logger.warning(\"error reading SSH keys\", exc_info=1)",
            "",
            "        return \"prefs_sshkeys.html\", params"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "53": [
                "SshForm"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_prefs_ssh.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "         # Then ssh key is not added"
            },
            "1": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "         self.assertEqual(0, len(list(user.authorizedkeys)))"
            },
            "2": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 113,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+    def test_add_with_title_too_long(self):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+        # Given an authenticated user without any ssh keys"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+        user = self.app.store.get_user('admin')"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+        for key in user.authorizedkeys:"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+            user.delete_authorizedkey(key.fingerprint)"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+        self.assertEqual(0, len(list(user.authorizedkeys)))"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 120,
                "PatchRowcode": "+        # When adding a key with title too long."
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+        self._add_ssh_key("
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+            \"title\" * 52,"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 123,
                "PatchRowcode": "+            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\","
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 124,
                "PatchRowcode": "+        )"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+        # Then page return with error"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 126,
                "PatchRowcode": "+        self.assertStatus('200 OK')"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+        self.assertInBody('Title too long.')"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+        # Then key is not added"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+        self.assertEqual(0, len(list(user.authorizedkeys)))"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 131,
                "PatchRowcode": "     def test_delete(self):"
            },
            "21": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 132,
                "PatchRowcode": "         # Delete existing keys"
            },
            "22": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 133,
                "PatchRowcode": "         user = self.app.store.get_user('admin')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Jan 1, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "",
            "",
            "import rdiffweb.test",
            "",
            "PREFS_SSHKEYS = \"/prefs/sshkeys/\"",
            "",
            "",
            "class SSHKeysTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def _delete_ssh_key(self, fingerprint):",
            "        b = {'action': 'delete', 'fingerprint': fingerprint}",
            "        self.getPage(PREFS_SSHKEYS, method='POST', body=b)",
            "",
            "    def _add_ssh_key(self, title, key):",
            "        b = {'action': 'add', 'title': title, 'key': key}",
            "        self.getPage(PREFS_SSHKEYS, method='POST', body=b)",
            "",
            "    def test_page(self):",
            "        self.getPage(PREFS_SSHKEYS)",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_add(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Show page",
            "        self.getPage(PREFS_SSHKEYS)",
            "        self.assertInBody(\"test@mysshkey\")",
            "        self.assertInBody(\"4d:42:8b:35:e5:55:71:f7:b3:0d:58:f9:b1:2c:9e:91\")",
            "",
            "    def test_add_duplicate(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertNotInBody(\"Duplicate key.\")",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Duplicate key.\")",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "    def test_add_invalid(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "",
            "        # Add key",
            "        self._add_ssh_key(\"test@mysshkey\", \"lkjasdfoiuwerlk\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Invalid SSH key.\")",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "    def test_add_get_method(self):",
            "        # Given an authenticated user",
            "        user = self.app.store.get_user('admin')",
            "        # When querying a page with parameters (HTTP GET)",
            "        self.getPage(",
            "            \"/prefs/sshkeys?action=add&title=ssh1&key=ssh-rsa+AAAAB3NzaC1yc2EAAAADAQABAAAAgQCzurRNVKwb0ZJCmUgGenoe4vth5gnHxgnzjHSUO8r7IZiouB6DAciiVUAryV6MQm5trwIXNo0QDwFxyX99exIwUlDu3OzhZHKKbb721hCID17AWZMAQIgxQdu6b27s5YgJXsaxXWvEO2lSRVOnVXoCSI7mK5St%2FCJ8O1OdXivNIQ%3D%3D+noname%0D%0A\"",
            "        )",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then ssh key is not added",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "    def test_delete(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Delete Key",
            "        self._delete_ssh_key(\"4d:42:8b:35:e5:55:71:f7:b3:0d:58:f9:b1:2c:9e:91\")",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "    def test_delete_invalid(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Delete Key",
            "        self._delete_ssh_key(\"invalid\")",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Jan 1, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "",
            "",
            "import rdiffweb.test",
            "",
            "PREFS_SSHKEYS = \"/prefs/sshkeys/\"",
            "",
            "",
            "class SSHKeysTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def _delete_ssh_key(self, fingerprint):",
            "        b = {'action': 'delete', 'fingerprint': fingerprint}",
            "        self.getPage(PREFS_SSHKEYS, method='POST', body=b)",
            "",
            "    def _add_ssh_key(self, title, key):",
            "        b = {'action': 'add', 'title': title, 'key': key}",
            "        self.getPage(PREFS_SSHKEYS, method='POST', body=b)",
            "",
            "    def test_page(self):",
            "        self.getPage(PREFS_SSHKEYS)",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_add(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Show page",
            "        self.getPage(PREFS_SSHKEYS)",
            "        self.assertInBody(\"test@mysshkey\")",
            "        self.assertInBody(\"4d:42:8b:35:e5:55:71:f7:b3:0d:58:f9:b1:2c:9e:91\")",
            "",
            "    def test_add_duplicate(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertNotInBody(\"Duplicate key.\")",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody(\"Duplicate key.\")",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "    def test_add_invalid(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "",
            "        # Add key",
            "        self._add_ssh_key(\"test@mysshkey\", \"lkjasdfoiuwerlk\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Invalid SSH key.\")",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "    def test_add_get_method(self):",
            "        # Given an authenticated user",
            "        user = self.app.store.get_user('admin')",
            "        # When querying a page with parameters (HTTP GET)",
            "        self.getPage(",
            "            \"/prefs/sshkeys?action=add&title=ssh1&key=ssh-rsa+AAAAB3NzaC1yc2EAAAADAQABAAAAgQCzurRNVKwb0ZJCmUgGenoe4vth5gnHxgnzjHSUO8r7IZiouB6DAciiVUAryV6MQm5trwIXNo0QDwFxyX99exIwUlDu3OzhZHKKbb721hCID17AWZMAQIgxQdu6b27s5YgJXsaxXWvEO2lSRVOnVXoCSI7mK5St%2FCJ8O1OdXivNIQ%3D%3D+noname%0D%0A\"",
            "        )",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then ssh key is not added",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "    def test_add_with_title_too_long(self):",
            "        # Given an authenticated user without any ssh keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "        # When adding a key with title too long.",
            "        self._add_ssh_key(",
            "            \"title\" * 52,",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        # Then page return with error",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Title too long.')",
            "        # Then key is not added",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "    def test_delete(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Delete Key",
            "        self._delete_ssh_key(\"4d:42:8b:35:e5:55:71:f7:b3:0d:58:f9:b1:2c:9e:91\")",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "    def test_delete_invalid(self):",
            "        # Delete existing keys",
            "        user = self.app.store.get_user('admin')",
            "        for key in user.authorizedkeys:",
            "            user.delete_authorizedkey(key.fingerprint)",
            "        self.assertEqual(0, len(list(user.authorizedkeys)))",
            "",
            "        # Add a new key",
            "        self._add_ssh_key(",
            "            \"test@mysshkey\",",
            "            \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSEN5VTn9MLituZvdYTZMbZEaMxe0UuU7BelxHkvxzSpVWtazrIBEc3KZjtVoK9F3+0kd26P4DzSQuPUl3yZDgyZZeXrF6p2GlEA7A3tPuOEsAQ9c0oTiDYktq5/Go8vD+XAZKLd//qmCWW1Jg4datkWchMKJzbHUgBrBH015FDbGvGDWYTfVyb8I9H+LQ0GmbTHsuTu63DhPODncMtWPuS9be/flb4EEojMIx5Vce0SNO9Eih38W7jTvNWxZb75k5yfPJxBULRnS5v/fPnDVVtD3JSGybSwKoMdsMX5iImAeNhqnvd8gBu1f0IycUQexTbJXk1rPiRcF13SjKrfXz ikus060@ikus060-t530\",",
            "        )",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))",
            "",
            "        # Delete Key",
            "        self._delete_ssh_key(\"invalid\")",
            "        self.assertStatus('200 OK')",
            "        self.assertEqual(1, len(list(user.authorizedkeys)))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.tests.test_page_prefs_ssh.SSHKeysTest.self",
            "knowledge_repo.app.routes.comment"
        ]
    }
}