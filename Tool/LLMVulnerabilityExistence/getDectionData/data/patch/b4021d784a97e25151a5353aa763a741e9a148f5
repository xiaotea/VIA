{
    "dcnnt/plugins/notifications.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " import logging"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " import subprocess"
            },
            "2": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 3,
                "PatchRowcode": "+from shlex import quote"
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " "
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from .base import Plugin"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from ..common import *"
            },
            "6": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "                         except Exception as e:"
            },
            "7": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "                             self.log(e, logging.WARNING)"
            },
            "8": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "                     icon = icon_path if icon_data else ''"
            },
            "9": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    command = cmd.format(uin=uin, name=name, icon=icon, text=text, title=title, package=package)"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+                    command = cmd.format(uin=quote(uin), name=quote(name), icon=quote(icon), text=quote(text), title=quote(title), package=quote(package))"
            },
            "11": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 58,
                "PatchRowcode": "                     self.log('Execute: \"{}\"'.format(command))"
            },
            "12": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 59,
                "PatchRowcode": "                     subprocess.call(command, shell=True)"
            }
        },
        "frontPatchFile": [
            "import logging",
            "import subprocess",
            "",
            "from .base import Plugin",
            "from ..common import *",
            "",
            "",
            "class NotificationsPlugin(Plugin):",
            "    \"\"\"Receive notifications from phone\"\"\"",
            "    MARK = b'nots'",
            "    NAME = 'NotificationsPlugin'",
            "    MAIN_CONF = dict()",
            "    DEVICE_CONFS = dict()",
            "    CONFIG_SCHEMA = DictEntry('rcmd.conf.json', 'Configuration for remote commands file', False, entries=(",
            "        IntEntry('uin', 'UIN of device for which config will be applied', True, 1, 0xFFFFFFF, None),",
            "        DirEntry('icon_dir', 'Directory to notification icons', True, '$DCNNT_RUNTIME_DIR', True, False),",
            "        TemplateEntry('cmd', 'Template of notification show command',",
            "                      False, 0, 4096, \"notify-send -i '{icon}' '{title}' '{text}'\", replacements=(",
            "                          Rep('uin', 'UIN of device which send notification', True),",
            "                          Rep('name', 'Name of device which send notification', True),",
            "                          Rep('package', 'Name of Android package  which create notification', True),",
            "                          Rep('icon', 'Path to saved notification icon', True),",
            "                          Rep('title', 'Title of notification', True),",
            "                          Rep('text', 'Main content of notification', True),",
            "                      ))",
            "    ))",
            "",
            "    def __init__(self, app, handler, device):",
            "        super().__init__(app, handler, device)",
            "",
            "    def main(self):",
            "        while True:",
            "            request = self.rpc_read()",
            "            self.log(request)",
            "            if request is None:",
            "                self.log('No more requests, stop handler')",
            "                return",
            "            cmd = self.conf('cmd')",
            "            if not cmd:",
            "                return",
            "            if request.method == 'notification':",
            "                icon_data = self.read() if request.params.get('packageIcon', False) else None",
            "                if request.params.get('event') == 'posted':",
            "                    text, package = map(request.params.get, ('text', 'package'))",
            "                    title = request.params.get('title', 'NULL')",
            "                    name, uin = self.device.name, self.device.uin",
            "                    if text is None:",
            "                        text = ''",
            "                    icon_path = os.path.join(self.conf('icon_dir'), f'{package}.{self.device.uin}.icon.png')",
            "                    if bool(icon_data):",
            "                        try:",
            "                            open(icon_path, 'wb').write(icon_data)",
            "                        except Exception as e:",
            "                            self.log(e, logging.WARNING)",
            "                    icon = icon_path if icon_data else ''",
            "                    command = cmd.format(uin=uin, name=name, icon=icon, text=text, title=title, package=package)",
            "                    self.log('Execute: \"{}\"'.format(command))",
            "                    subprocess.call(command, shell=True)"
        ],
        "afterPatchFile": [
            "import logging",
            "import subprocess",
            "from shlex import quote",
            "",
            "from .base import Plugin",
            "from ..common import *",
            "",
            "",
            "class NotificationsPlugin(Plugin):",
            "    \"\"\"Receive notifications from phone\"\"\"",
            "    MARK = b'nots'",
            "    NAME = 'NotificationsPlugin'",
            "    MAIN_CONF = dict()",
            "    DEVICE_CONFS = dict()",
            "    CONFIG_SCHEMA = DictEntry('rcmd.conf.json', 'Configuration for remote commands file', False, entries=(",
            "        IntEntry('uin', 'UIN of device for which config will be applied', True, 1, 0xFFFFFFF, None),",
            "        DirEntry('icon_dir', 'Directory to notification icons', True, '$DCNNT_RUNTIME_DIR', True, False),",
            "        TemplateEntry('cmd', 'Template of notification show command',",
            "                      False, 0, 4096, \"notify-send -i '{icon}' '{title}' '{text}'\", replacements=(",
            "                          Rep('uin', 'UIN of device which send notification', True),",
            "                          Rep('name', 'Name of device which send notification', True),",
            "                          Rep('package', 'Name of Android package  which create notification', True),",
            "                          Rep('icon', 'Path to saved notification icon', True),",
            "                          Rep('title', 'Title of notification', True),",
            "                          Rep('text', 'Main content of notification', True),",
            "                      ))",
            "    ))",
            "",
            "    def __init__(self, app, handler, device):",
            "        super().__init__(app, handler, device)",
            "",
            "    def main(self):",
            "        while True:",
            "            request = self.rpc_read()",
            "            self.log(request)",
            "            if request is None:",
            "                self.log('No more requests, stop handler')",
            "                return",
            "            cmd = self.conf('cmd')",
            "            if not cmd:",
            "                return",
            "            if request.method == 'notification':",
            "                icon_data = self.read() if request.params.get('packageIcon', False) else None",
            "                if request.params.get('event') == 'posted':",
            "                    text, package = map(request.params.get, ('text', 'package'))",
            "                    title = request.params.get('title', 'NULL')",
            "                    name, uin = self.device.name, self.device.uin",
            "                    if text is None:",
            "                        text = ''",
            "                    icon_path = os.path.join(self.conf('icon_dir'), f'{package}.{self.device.uin}.icon.png')",
            "                    if bool(icon_data):",
            "                        try:",
            "                            open(icon_path, 'wb').write(icon_data)",
            "                        except Exception as e:",
            "                            self.log(e, logging.WARNING)",
            "                    icon = icon_path if icon_data else ''",
            "                    command = cmd.format(uin=quote(uin), name=quote(name), icon=quote(icon), text=quote(text), title=quote(title), package=quote(package))",
            "                    self.log('Execute: \"{}\"'.format(command))",
            "                    subprocess.call(command, shell=True)"
        ],
        "action": [
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "56": [
                "NotificationsPlugin",
                "main"
            ]
        },
        "addLocation": []
    }
}