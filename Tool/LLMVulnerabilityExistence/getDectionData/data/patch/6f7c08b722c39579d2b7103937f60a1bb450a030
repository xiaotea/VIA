{
    "src/plone/restapi/deserializer/local_roles.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "         # roles"
            },
            "1": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "         roles_reindex = False"
            },
            "2": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "         new_roles = data.get(\"entries\", None)"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+        managed_roles = frozenset([r['id'] for r in sharing_view.roles()])"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+"
            },
            "5": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "         if new_roles is not None:"
            },
            "6": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "             # the roles are converted into a FrozenSet so we have to filter"
            },
            "7": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "             # the data structure we get."
            },
            "8": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "             for user in new_roles:"
            },
            "9": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "                 roles_list = [key for key in user[\"roles\"] if user[\"roles\"][key]]"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+                # Limit roles to ones the user is allowed to delegate"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+                roles_list = set(roles_list).intersection(managed_roles)"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+"
            },
            "14": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "                 user[\"roles\"] = roles_list"
            },
            "15": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "             roles_reindex = sharing_view.update_role_settings(new_roles, reindex=False)"
            },
            "16": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 63,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from AccessControl.interfaces import IRoleManager",
            "from plone.restapi.deserializer import json_body",
            "from plone.restapi.interfaces import IDeserializeFromJson",
            "from Products.CMFCore.interfaces import ICatalogAware",
            "from Products.CMFPlone.interfaces import IPloneSiteRoot",
            "from zope.component import adapter",
            "from zope.component import getMultiAdapter",
            "from zope.event import notify",
            "from zope.interface import implementer",
            "from zope.interface import Interface",
            "",
            "",
            "try:",
            "    from plone.app.workflow.events import LocalrolesModifiedEvent",
            "",
            "    LOCALROLES_MODIFIED_EVENT_AVAILABLE = True",
            "except ImportError:",
            "    # Plone < 4.3.4",
            "    LOCALROLES_MODIFIED_EVENT_AVAILABLE = False",
            "",
            "",
            "marker = object()",
            "",
            "",
            "@implementer(IDeserializeFromJson)",
            "@adapter(IRoleManager, Interface)",
            "class DeserializeFromJson(object):",
            "    \"\"\"JSON deserializer for local roles",
            "    \"\"\"",
            "",
            "    def __init__(self, context, request):",
            "        self.context = context",
            "        self.request = request",
            "",
            "    def __call__(self):",
            "        data = json_body(self.request)",
            "        sharing_view = getMultiAdapter((self.context, self.request), name=\"sharing\")",
            "",
            "        # inherit roles",
            "        inherit_reindex = False",
            "        # block can be None, so we might get False or None, so we test",
            "        # for a marker.",
            "        inherit = data.get(\"inherit\", marker)",
            "        if inherit is not marker:",
            "            inherit_reindex = sharing_view.update_inherit(status=inherit, reindex=False)",
            "        # roles",
            "        roles_reindex = False",
            "        new_roles = data.get(\"entries\", None)",
            "        if new_roles is not None:",
            "            # the roles are converted into a FrozenSet so we have to filter",
            "            # the data structure we get.",
            "            for user in new_roles:",
            "                roles_list = [key for key in user[\"roles\"] if user[\"roles\"][key]]",
            "                user[\"roles\"] = roles_list",
            "            roles_reindex = sharing_view.update_role_settings(new_roles, reindex=False)",
            "",
            "        # reindex object security",
            "        can_reindex = ICatalogAware(self.context, None) or IPloneSiteRoot.providedBy(",
            "            self.context",
            "        )",
            "        if can_reindex and (inherit_reindex or roles_reindex):",
            "            self.context.reindexObjectSecurity()",
            "            if LOCALROLES_MODIFIED_EVENT_AVAILABLE:",
            "                notify(LocalrolesModifiedEvent(self.context, self.request))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from AccessControl.interfaces import IRoleManager",
            "from plone.restapi.deserializer import json_body",
            "from plone.restapi.interfaces import IDeserializeFromJson",
            "from Products.CMFCore.interfaces import ICatalogAware",
            "from Products.CMFPlone.interfaces import IPloneSiteRoot",
            "from zope.component import adapter",
            "from zope.component import getMultiAdapter",
            "from zope.event import notify",
            "from zope.interface import implementer",
            "from zope.interface import Interface",
            "",
            "",
            "try:",
            "    from plone.app.workflow.events import LocalrolesModifiedEvent",
            "",
            "    LOCALROLES_MODIFIED_EVENT_AVAILABLE = True",
            "except ImportError:",
            "    # Plone < 4.3.4",
            "    LOCALROLES_MODIFIED_EVENT_AVAILABLE = False",
            "",
            "",
            "marker = object()",
            "",
            "",
            "@implementer(IDeserializeFromJson)",
            "@adapter(IRoleManager, Interface)",
            "class DeserializeFromJson(object):",
            "    \"\"\"JSON deserializer for local roles",
            "    \"\"\"",
            "",
            "    def __init__(self, context, request):",
            "        self.context = context",
            "        self.request = request",
            "",
            "    def __call__(self):",
            "        data = json_body(self.request)",
            "        sharing_view = getMultiAdapter((self.context, self.request), name=\"sharing\")",
            "",
            "        # inherit roles",
            "        inherit_reindex = False",
            "        # block can be None, so we might get False or None, so we test",
            "        # for a marker.",
            "        inherit = data.get(\"inherit\", marker)",
            "        if inherit is not marker:",
            "            inherit_reindex = sharing_view.update_inherit(status=inherit, reindex=False)",
            "        # roles",
            "        roles_reindex = False",
            "        new_roles = data.get(\"entries\", None)",
            "        managed_roles = frozenset([r['id'] for r in sharing_view.roles()])",
            "",
            "        if new_roles is not None:",
            "            # the roles are converted into a FrozenSet so we have to filter",
            "            # the data structure we get.",
            "            for user in new_roles:",
            "                roles_list = [key for key in user[\"roles\"] if user[\"roles\"][key]]",
            "",
            "                # Limit roles to ones the user is allowed to delegate",
            "                roles_list = set(roles_list).intersection(managed_roles)",
            "",
            "                user[\"roles\"] = roles_list",
            "            roles_reindex = sharing_view.update_role_settings(new_roles, reindex=False)",
            "",
            "        # reindex object security",
            "        can_reindex = ICatalogAware(self.context, None) or IPloneSiteRoot.providedBy(",
            "            self.context",
            "        )",
            "        if can_reindex and (inherit_reindex or roles_reindex):",
            "            self.context.reindexObjectSecurity()",
            "            if LOCALROLES_MODIFIED_EVENT_AVAILABLE:",
            "                notify(LocalrolesModifiedEvent(self.context, self.request))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "jose.jwe"
        ]
    },
    "src/plone/restapi/tests/test_content_local_roles.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from plone.app.testing import SITE_OWNER_NAME"
            },
            "1": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from plone.app.testing import SITE_OWNER_PASSWORD"
            },
            "2": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from plone.app.testing import TEST_USER_ID"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+from plone.app.testing import TEST_USER_NAME"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+from plone.app.testing import TEST_USER_PASSWORD"
            },
            "5": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from plone.restapi.serializer.local_roles import SerializeLocalRolesToJson"
            },
            "6": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from plone.restapi.testing import PLONE_RESTAPI_DX_FUNCTIONAL_TESTING"
            },
            "7": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from Products.CMFCore.utils import getToolByName"
            },
            "8": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": 267,
                "PatchRowcode": "             ],"
            },
            "9": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": 268,
                "PatchRowcode": "         )"
            },
            "10": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": 269,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 270,
                "PatchRowcode": "+    def test_may_only_manage_roles_already_held(self):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 271,
                "PatchRowcode": "+        # Grant Editor role to our test user (which gives them the required"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 272,
                "PatchRowcode": "+        # \"plone.DelegateRoles\" permission to manage local roles at all)"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 273,
                "PatchRowcode": "+        api.user.grant_roles(username=TEST_USER_ID, obj=self.portal.folder1,"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 274,
                "PatchRowcode": "+                             roles=['Editor'])"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 275,
                "PatchRowcode": "+        transaction.commit()"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 276,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 277,
                "PatchRowcode": "+        # Guard assertion - our test user starts with a limited set of roles"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 278,
                "PatchRowcode": "+        existing_roles = api.user.get_roles(username=TEST_USER_ID,"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 279,
                "PatchRowcode": "+                                            obj=self.portal.folder1)"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 280,
                "PatchRowcode": "+        self.assertEqual("
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 281,
                "PatchRowcode": "+            sorted(['Member', 'Authenticated', 'Editor']),"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 282,
                "PatchRowcode": "+            sorted(existing_roles))"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 283,
                "PatchRowcode": "+"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 284,
                "PatchRowcode": "+        # Attempt to gain additional roles not already held"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 285,
                "PatchRowcode": "+        response = requests.post("
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 286,
                "PatchRowcode": "+            self.portal.folder1.absolute_url() + \"/@sharing\","
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 287,
                "PatchRowcode": "+            headers={\"Accept\": \"application/json\"},"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 288,
                "PatchRowcode": "+            auth=(TEST_USER_NAME, TEST_USER_PASSWORD),"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 289,
                "PatchRowcode": "+            json={"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 290,
                "PatchRowcode": "+                \"entries\": ["
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 291,
                "PatchRowcode": "+                    {"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 292,
                "PatchRowcode": "+                        u\"id\": TEST_USER_ID,"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 293,
                "PatchRowcode": "+                        u\"roles\": {"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 294,
                "PatchRowcode": "+                            u\"Contributor\": True,"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 295,
                "PatchRowcode": "+                            u\"Editor\": True,"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 296,
                "PatchRowcode": "+                            u\"Reader\": True,"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 297,
                "PatchRowcode": "+                            u\"Publisher\": True,"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 298,
                "PatchRowcode": "+                            u\"Reviewer\": True,"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 299,
                "PatchRowcode": "+                            u\"Manager\": True,"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 300,
                "PatchRowcode": "+                        },"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 301,
                "PatchRowcode": "+                        u\"type\": u\"user\","
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 302,
                "PatchRowcode": "+                    }"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 303,
                "PatchRowcode": "+                ]"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 304,
                "PatchRowcode": "+            },"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 305,
                "PatchRowcode": "+        )"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 306,
                "PatchRowcode": "+"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 307,
                "PatchRowcode": "+        transaction.commit()"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 308,
                "PatchRowcode": "+"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 309,
                "PatchRowcode": "+        self.assertEqual(response.status_code, 204)"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 310,
                "PatchRowcode": "+        new_roles = api.user.get_roles(username=TEST_USER_ID,"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 311,
                "PatchRowcode": "+                                       obj=self.portal.folder1)"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 312,
                "PatchRowcode": "+"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 313,
                "PatchRowcode": "+        # New roles should not contain any new roles that the user didn't"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 314,
                "PatchRowcode": "+        # have permission to delegate."
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 315,
                "PatchRowcode": "+        self.assertNotIn(u'Manager', new_roles)"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 316,
                "PatchRowcode": "+        self.assertNotIn(u'Publisher', new_roles)"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 317,
                "PatchRowcode": "+        self.assertNotIn(u'Reviewer', new_roles)"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 318,
                "PatchRowcode": "+        self.assertNotIn(u'Contributor', new_roles)"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 319,
                "PatchRowcode": "+"
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 320,
                "PatchRowcode": "+        # 'Reader' gets added because the permission to delegate it is"
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 321,
                "PatchRowcode": "+        # assigned to 'Editor' by default (see p.a.workflow.permissions)"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 322,
                "PatchRowcode": "+        self.assertEqual("
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 323,
                "PatchRowcode": "+            sorted(['Member', 'Authenticated', 'Editor', 'Reader']),"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 324,
                "PatchRowcode": "+            sorted(new_roles))"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 325,
                "PatchRowcode": "+"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 326,
                "PatchRowcode": "+    def test_unmanaged_existing_roles_are_retained_on_update(self):"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 327,
                "PatchRowcode": "+        \"\"\"Make sure that existing roles don't get dropped when a user that"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 328,
                "PatchRowcode": "+        doesn't manage that roles updates local roles for another user that"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 329,
                "PatchRowcode": "+        already holds that role."
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 330,
                "PatchRowcode": "+        \"\"\""
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 331,
                "PatchRowcode": "+        # Create another user that holds the Reviewer role, which is not"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 332,
                "PatchRowcode": "+        # managed by our test user"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 333,
                "PatchRowcode": "+        api.user.create(username='peter', email='peter@example.org',"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 334,
                "PatchRowcode": "+                        password='secret', roles=('Member', ))"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 335,
                "PatchRowcode": "+"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 336,
                "PatchRowcode": "+        api.user.grant_roles(username='peter', obj=self.portal.folder1,"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 337,
                "PatchRowcode": "+                             roles=['Reviewer'])"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 338,
                "PatchRowcode": "+        transaction.commit()"
            },
            "80": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 339,
                "PatchRowcode": "+"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 340,
                "PatchRowcode": "+        peters_existing_roles = api.user.get_roles(username='peter',"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 341,
                "PatchRowcode": "+                                                   obj=self.portal.folder1)"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 342,
                "PatchRowcode": "+        self.assertEqual(sorted(['Member', 'Reviewer', 'Authenticated']),"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 343,
                "PatchRowcode": "+                         sorted(peters_existing_roles))"
            },
            "85": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 344,
                "PatchRowcode": "+"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 345,
                "PatchRowcode": "+        # Grant Editor role to our test user (which gives them the required"
            },
            "87": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 346,
                "PatchRowcode": "+        # \"plone.DelegateRoles\" permission to manage local roles at all)"
            },
            "88": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 347,
                "PatchRowcode": "+        api.user.grant_roles(username=TEST_USER_ID, obj=self.portal.folder1,"
            },
            "89": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 348,
                "PatchRowcode": "+                             roles=['Editor'])"
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 349,
                "PatchRowcode": "+        transaction.commit()"
            },
            "91": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 350,
                "PatchRowcode": "+"
            },
            "92": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 351,
                "PatchRowcode": "+        # Guard assertion - our test user doesn't have/manage Reviewer"
            },
            "93": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 352,
                "PatchRowcode": "+        existing_roles = api.user.get_roles(username=TEST_USER_ID,"
            },
            "94": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 353,
                "PatchRowcode": "+                                            obj=self.portal.folder1)"
            },
            "95": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 354,
                "PatchRowcode": "+        self.assertEqual("
            },
            "96": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 355,
                "PatchRowcode": "+            sorted(['Member', 'Authenticated', 'Editor']),"
            },
            "97": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 356,
                "PatchRowcode": "+            sorted(existing_roles))"
            },
            "98": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 357,
                "PatchRowcode": "+"
            },
            "99": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 358,
                "PatchRowcode": "+        # Test user now gives Editor to peter. This should not lead to"
            },
            "100": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 359,
                "PatchRowcode": "+        # peter losing the Reviewer role."
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 360,
                "PatchRowcode": "+        response = requests.post("
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 361,
                "PatchRowcode": "+            self.portal.folder1.absolute_url() + \"/@sharing\","
            },
            "103": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 362,
                "PatchRowcode": "+            headers={\"Accept\": \"application/json\"},"
            },
            "104": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 363,
                "PatchRowcode": "+            auth=(TEST_USER_NAME, TEST_USER_PASSWORD),"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 364,
                "PatchRowcode": "+            json={"
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 365,
                "PatchRowcode": "+                \"entries\": ["
            },
            "107": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 366,
                "PatchRowcode": "+                    {"
            },
            "108": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 367,
                "PatchRowcode": "+                        u\"id\": \"peter\","
            },
            "109": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 368,
                "PatchRowcode": "+                        u\"roles\": {"
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 369,
                "PatchRowcode": "+                            u\"Contributor\": False,"
            },
            "111": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 370,
                "PatchRowcode": "+                            u\"Editor\": True,"
            },
            "112": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 371,
                "PatchRowcode": "+                            u\"Reader\": True,"
            },
            "113": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 372,
                "PatchRowcode": "+                            u\"Publisher\": False,"
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 373,
                "PatchRowcode": "+                            u\"Reviewer\": True,"
            },
            "115": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 374,
                "PatchRowcode": "+                            u\"Manager\": False,"
            },
            "116": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 375,
                "PatchRowcode": "+                        },"
            },
            "117": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 376,
                "PatchRowcode": "+                        u\"type\": u\"user\","
            },
            "118": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 377,
                "PatchRowcode": "+                    }"
            },
            "119": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 378,
                "PatchRowcode": "+                ]"
            },
            "120": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 379,
                "PatchRowcode": "+            },"
            },
            "121": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 380,
                "PatchRowcode": "+        )"
            },
            "122": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 381,
                "PatchRowcode": "+"
            },
            "123": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 382,
                "PatchRowcode": "+        transaction.commit()"
            },
            "124": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 383,
                "PatchRowcode": "+"
            },
            "125": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 384,
                "PatchRowcode": "+        self.assertEqual(response.status_code, 204)"
            },
            "126": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 385,
                "PatchRowcode": "+        new_roles = api.user.get_roles(username='peter',"
            },
            "127": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 386,
                "PatchRowcode": "+                                       obj=self.portal.folder1)"
            },
            "128": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 387,
                "PatchRowcode": "+"
            },
            "129": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 388,
                "PatchRowcode": "+        self.assertIn(u'Reviewer', new_roles)"
            },
            "130": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 389,
                "PatchRowcode": "+        self.assertEqual("
            },
            "131": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 390,
                "PatchRowcode": "+            sorted(['Member', 'Authenticated', 'Editor', 'Reader', 'Reviewer']),"
            },
            "132": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 391,
                "PatchRowcode": "+            sorted(new_roles))"
            },
            "133": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 392,
                "PatchRowcode": "+"
            },
            "134": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": 393,
                "PatchRowcode": "     def test_unset_local_roles_for_user(self):"
            },
            "135": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": 394,
                "PatchRowcode": "         api.user.grant_roles("
            },
            "136": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 395,
                "PatchRowcode": "             username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Reviewer\", \"Reader\"]"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from Acquisition import aq_base",
            "from plone import api",
            "from plone.app.testing import login",
            "from plone.app.testing import setRoles",
            "from plone.app.testing import SITE_OWNER_NAME",
            "from plone.app.testing import SITE_OWNER_PASSWORD",
            "from plone.app.testing import TEST_USER_ID",
            "from plone.restapi.serializer.local_roles import SerializeLocalRolesToJson",
            "from plone.restapi.testing import PLONE_RESTAPI_DX_FUNCTIONAL_TESTING",
            "from Products.CMFCore.utils import getToolByName",
            "from zope.component import getGlobalSiteManager",
            "",
            "import requests",
            "import transaction",
            "import unittest",
            "",
            "",
            "def sorted_roles(roles):",
            "    results = []",
            "    for line in roles:",
            "        line = list(line)",
            "        line[1] = sorted(line[1])",
            "        results.append(line)",
            "    return results",
            "",
            "",
            "class TestFolderCreate(unittest.TestCase):",
            "",
            "    layer = PLONE_RESTAPI_DX_FUNCTIONAL_TESTING",
            "",
            "    def setUp(self):",
            "        self.app = self.layer[\"app\"]",
            "        self.portal = self.layer[\"portal\"]",
            "        setRoles(self.portal, TEST_USER_ID, [\"Member\"])",
            "        login(self.portal, SITE_OWNER_NAME)",
            "        self.portal.invokeFactory(\"Folder\", id=\"folder1\", title=\"My Folder\")",
            "        wftool = getToolByName(self.portal, \"portal_workflow\")",
            "        wftool.doActionFor(self.portal.folder1, \"publish\")",
            "",
            "        self.portal.folder1.invokeFactory(\"Document\", id=\"doc1\", title=\"My Document\")",
            "",
            "        transaction.commit()",
            "",
            "    def _get_ac_local_roles_block(self, obj):",
            "        return bool(",
            "            getattr(aq_base(self.portal.folder1), \"__ac_local_roles_block__\", False)",
            "        )",
            "",
            "    def test_sharing_search(self):",
            "        \"\"\"A request to @sharing should support the search parameter. \"\"\"",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        non_search_entries = response.json()[\"entries\"]",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing?search=admin\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        search_entries = response.json()[\"entries\"]",
            "",
            "        # Did we find anything?",
            "        self.assertNotEqual(len(non_search_entries), len(search_entries))",
            "",
            "    def test_sharing_search_roundtrip(self):",
            "        \"\"\"Search for a user and use save roles",
            "        \"\"\"",
            "        # Make sure we don't already have admin",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        self.assertNotIn(\"admin\", [x[\"id\"] for x in response.json()[\"entries\"]])",
            "",
            "        # Now find admin and set roles",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing?search=admin\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        roles = [x for x in response.json()[\"entries\"] if x[\"id\"] == \"admin\"]",
            "        roles = roles[0][\"roles\"]",
            "",
            "        new_roles = dict([(key, not val) for key, val in roles.items()])",
            "        payload = {\"entries\": [{\"id\": \"admin\", \"roles\": new_roles}]}",
            "",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json=payload,",
            "        )",
            "        self.assertEqual(204, response.status_code)",
            "",
            "        # Now we should have admin in @sharing",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        self.assertIn(\"admin\", [x[\"id\"] for x in response.json()[\"entries\"]])",
            "",
            "        # with the same roles as set",
            "        roles = [x for x in response.json()[\"entries\"] if x[\"id\"] == \"admin\"]",
            "        roles = roles[0][\"roles\"]",
            "        self.assertEqual(new_roles, roles)",
            "",
            "    def test_sharing_titles_are_translated(self):",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\", \"Accept-Language\": \"de\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        available_roles = response.json()[\"available_roles\"]",
            "        self.assertEqual(",
            "            [",
            "                {u\"id\": u\"Contributor\", u\"title\": u\"Kann hinzuf\\xfcgen\"},",
            "                {u\"id\": u\"Editor\", u\"title\": u\"Kann bearbeiten\"},",
            "                {u\"id\": u\"Reader\", u\"title\": u\"Kann ansehen\"},",
            "                {u\"id\": u\"Reviewer\", u\"title\": u\"Kann ver\\xf6ffentlichen\"},",
            "            ],",
            "            available_roles,",
            "        )",
            "",
            "    def test_sharing_requires_delegate_roles_permission(self):",
            "        \"\"\"A response for an object without any roles assigned\"\"\"",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "    def test_get_local_roles_none_assigned(self):",
            "        \"\"\"A response for an object without any roles assigned\"\"\"",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(",
            "            response.json(),",
            "            {",
            "                u\"available_roles\": [",
            "                    {u\"id\": u\"Contributor\", u\"title\": u\"Can add\"},",
            "                    {u\"id\": u\"Editor\", u\"title\": u\"Can edit\"},",
            "                    {u\"id\": u\"Reader\", u\"title\": u\"Can view\"},",
            "                    {u\"id\": u\"Reviewer\", u\"title\": u\"Can review\"},",
            "                ],",
            "                u\"entries\": [",
            "                    {",
            "                        u\"disabled\": False,",
            "                        u\"id\": u\"AuthenticatedUsers\",",
            "                        u\"login\": None,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": False,",
            "                        },",
            "                        u\"title\": u\"Logged-in users\",",
            "                        u\"type\": u\"group\",",
            "                    }",
            "                ],",
            "                u\"inherit\": True,",
            "            },",
            "        )",
            "",
            "    def test_get_local_roles_with_user(self):",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Reviewer\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(",
            "            response.json(),",
            "            {",
            "                u\"available_roles\": [",
            "                    {u\"id\": u\"Contributor\", u\"title\": u\"Can add\"},",
            "                    {u\"id\": u\"Editor\", u\"title\": u\"Can edit\"},",
            "                    {u\"id\": u\"Reader\", u\"title\": u\"Can view\"},",
            "                    {u\"id\": u\"Reviewer\", u\"title\": u\"Can review\"},",
            "                ],",
            "                u\"entries\": [",
            "                    {",
            "                        u\"disabled\": False,",
            "                        u\"id\": u\"AuthenticatedUsers\",",
            "                        u\"login\": None,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": False,",
            "                        },",
            "                        u\"title\": u\"Logged-in users\",",
            "                        u\"type\": u\"group\",",
            "                    },",
            "                    {",
            "                        u\"disabled\": False,",
            "                        u\"id\": u\"test_user_1_\",",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"title\": u\"test-user\",",
            "                        u\"type\": u\"user\",",
            "                    },",
            "                ],",
            "                u\"inherit\": True,",
            "            },",
            "        )",
            "",
            "    def test_set_local_roles_for_user(self):",
            "",
            "        pas = getToolByName(self.portal, \"acl_users\")",
            "        self.assertEqual(",
            "            pas.getLocalRolesForDisplay(self.portal.folder1),",
            "            ((\"admin\", (\"Owner\",), \"user\", \"admin\"),),",
            "        )",
            "",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": TEST_USER_ID,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": True,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(",
            "            sorted_roles(pas.getLocalRolesForDisplay(self.portal.folder1)),",
            "            [",
            "                [\"admin\", [\"Owner\"], \"user\", \"admin\"],",
            "                [\"test-user\", [u\"Reader\", u\"Reviewer\"], \"user\", u\"test_user_1_\"],",
            "            ],",
            "        )",
            "",
            "    def test_unset_local_roles_for_user(self):",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Reviewer\", \"Reader\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        pas = getToolByName(self.portal, \"acl_users\")",
            "        self.assertEqual(",
            "            sorted_roles(pas.getLocalRolesForDisplay(self.portal.folder1)),",
            "            [",
            "                [\"admin\", [\"Owner\"], \"user\", \"admin\"],",
            "                [\"test-user\", [\"Reader\", \"Reviewer\"], \"user\", \"test_user_1_\"],",
            "            ],",
            "        )",
            "",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": TEST_USER_ID,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(",
            "            pas.getLocalRolesForDisplay(self.portal.folder1),",
            "            (",
            "                (\"admin\", (\"Owner\",), \"user\", \"admin\"),",
            "                (\"test-user\", (u\"Reviewer\",), \"user\", u\"test_user_1_\"),",
            "            ),",
            "        )",
            "",
            "    def test_set_local_roles_on_site_root(self):",
            "",
            "        pas = getToolByName(self.portal, \"acl_users\")",
            "        self.assertEqual(",
            "            pas.getLocalRolesForDisplay(self.portal),",
            "            ((\"admin\", (\"Owner\",), \"user\", \"admin\"),),",
            "        )",
            "",
            "        response = requests.post(",
            "            self.portal.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": TEST_USER_ID,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": True,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(",
            "            sorted_roles(pas.getLocalRolesForDisplay(self.portal)),",
            "            [",
            "                [\"admin\", [\"Owner\"], \"user\", \"admin\"],",
            "                [\"test-user\", [u\"Reader\", u\"Reviewer\"], \"user\", u\"test_user_1_\"],",
            "            ],",
            "        )",
            "",
            "    def test_get_local_roles_inherit_roles(self):",
            "        # __ac_local_roles_block__ specifies to block inheritance:",
            "        # https://docs.plone.org/develop/plone/security/local_roles.html",
            "        self.portal.folder1.__ac_local_roles_block__ = True",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.json()[\"inherit\"], False)",
            "",
            "    def test_set_local_roles_inherit(self):",
            "        self.assertEqual(self._get_ac_local_roles_block(self.portal.folder1), False)",
            "",
            "        # block local roles",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={\"inherit\": False},",
            "        )",
            "",
            "        transaction.commit()",
            "        self.assertEqual(self._get_ac_local_roles_block(self.portal.folder1), True)",
            "        # unblock local roles",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={\"inherit\": True},",
            "        )",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(self._get_ac_local_roles_block(self.portal.folder1), False)",
            "",
            "    def test_get_available_roles(self):",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Reviewer\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        response = response.json()",
            "        self.assertIn(\"available_roles\", response)",
            "        self.assertIn(",
            "            {\"id\": \"Reader\", \"title\": \"Can view\"}, response[\"available_roles\"]",
            "        )",
            "",
            "    def test_inherited_global(self):",
            "        api.user.grant_roles(username=TEST_USER_ID, roles=[\"Reviewer\"])",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Editor\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.doc1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        response = response.json()",
            "        # find our entry",
            "        entry = [x for x in response[\"entries\"] if x[\"id\"] == TEST_USER_ID][0]",
            "",
            "        self.assertEqual(\"global\", entry[\"roles\"][\"Reviewer\"])",
            "        self.assertEqual(\"acquired\", entry[\"roles\"][\"Editor\"])",
            "",
            "    def test_inherited_global_via_search(self):",
            "        api.user.create(email=\"jos@henken.local\", username=\"jos\")",
            "        api.user.grant_roles(username=\"jos\", roles=[\"Reviewer\"])",
            "        api.user.grant_roles(username=\"jos\", roles=[\"Editor\"], obj=self.portal.folder1)",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.doc1.absolute_url() + \"/@sharing?search=jos\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        response = response.json()",
            "        # find our entry",
            "        entry = [x for x in response[\"entries\"] if x[\"id\"] == \"jos\"][0]",
            "",
            "        self.assertEqual(\"global\", entry[\"roles\"][\"Reviewer\"])",
            "        self.assertEqual(\"acquired\", entry[\"roles\"][\"Editor\"])",
            "",
            "    def test_no_serializer_available_returns_501(self):",
            "        # This test unregisters the local_roles adapter. The testrunner can",
            "        # not auto-revert this on test tearDown. Therefore if we ever run",
            "        # into test isolation issues. Start to look here first.",
            "        gsm = getGlobalSiteManager()",
            "        gsm.unregisterAdapter(SerializeLocalRolesToJson, name=\"local_roles\")",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 501)",
            "        response = response.json()",
            "        self.assertIn(\"error\", response)",
            "        self.assertEqual(u\"No serializer available.\", response[\"error\"][\"message\"])",
            "",
            "        # we need to re-register the adapter here for following tests",
            "        gsm.registerAdapter(SerializeLocalRolesToJson, name=\"local_roles\")"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from Acquisition import aq_base",
            "from plone import api",
            "from plone.app.testing import login",
            "from plone.app.testing import setRoles",
            "from plone.app.testing import SITE_OWNER_NAME",
            "from plone.app.testing import SITE_OWNER_PASSWORD",
            "from plone.app.testing import TEST_USER_ID",
            "from plone.app.testing import TEST_USER_NAME",
            "from plone.app.testing import TEST_USER_PASSWORD",
            "from plone.restapi.serializer.local_roles import SerializeLocalRolesToJson",
            "from plone.restapi.testing import PLONE_RESTAPI_DX_FUNCTIONAL_TESTING",
            "from Products.CMFCore.utils import getToolByName",
            "from zope.component import getGlobalSiteManager",
            "",
            "import requests",
            "import transaction",
            "import unittest",
            "",
            "",
            "def sorted_roles(roles):",
            "    results = []",
            "    for line in roles:",
            "        line = list(line)",
            "        line[1] = sorted(line[1])",
            "        results.append(line)",
            "    return results",
            "",
            "",
            "class TestFolderCreate(unittest.TestCase):",
            "",
            "    layer = PLONE_RESTAPI_DX_FUNCTIONAL_TESTING",
            "",
            "    def setUp(self):",
            "        self.app = self.layer[\"app\"]",
            "        self.portal = self.layer[\"portal\"]",
            "        setRoles(self.portal, TEST_USER_ID, [\"Member\"])",
            "        login(self.portal, SITE_OWNER_NAME)",
            "        self.portal.invokeFactory(\"Folder\", id=\"folder1\", title=\"My Folder\")",
            "        wftool = getToolByName(self.portal, \"portal_workflow\")",
            "        wftool.doActionFor(self.portal.folder1, \"publish\")",
            "",
            "        self.portal.folder1.invokeFactory(\"Document\", id=\"doc1\", title=\"My Document\")",
            "",
            "        transaction.commit()",
            "",
            "    def _get_ac_local_roles_block(self, obj):",
            "        return bool(",
            "            getattr(aq_base(self.portal.folder1), \"__ac_local_roles_block__\", False)",
            "        )",
            "",
            "    def test_sharing_search(self):",
            "        \"\"\"A request to @sharing should support the search parameter. \"\"\"",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        non_search_entries = response.json()[\"entries\"]",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing?search=admin\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        search_entries = response.json()[\"entries\"]",
            "",
            "        # Did we find anything?",
            "        self.assertNotEqual(len(non_search_entries), len(search_entries))",
            "",
            "    def test_sharing_search_roundtrip(self):",
            "        \"\"\"Search for a user and use save roles",
            "        \"\"\"",
            "        # Make sure we don't already have admin",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        self.assertNotIn(\"admin\", [x[\"id\"] for x in response.json()[\"entries\"]])",
            "",
            "        # Now find admin and set roles",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing?search=admin\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        roles = [x for x in response.json()[\"entries\"] if x[\"id\"] == \"admin\"]",
            "        roles = roles[0][\"roles\"]",
            "",
            "        new_roles = dict([(key, not val) for key, val in roles.items()])",
            "        payload = {\"entries\": [{\"id\": \"admin\", \"roles\": new_roles}]}",
            "",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json=payload,",
            "        )",
            "        self.assertEqual(204, response.status_code)",
            "",
            "        # Now we should have admin in @sharing",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        self.assertIn(\"admin\", [x[\"id\"] for x in response.json()[\"entries\"]])",
            "",
            "        # with the same roles as set",
            "        roles = [x for x in response.json()[\"entries\"] if x[\"id\"] == \"admin\"]",
            "        roles = roles[0][\"roles\"]",
            "        self.assertEqual(new_roles, roles)",
            "",
            "    def test_sharing_titles_are_translated(self):",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\", \"Accept-Language\": \"de\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        available_roles = response.json()[\"available_roles\"]",
            "        self.assertEqual(",
            "            [",
            "                {u\"id\": u\"Contributor\", u\"title\": u\"Kann hinzuf\\xfcgen\"},",
            "                {u\"id\": u\"Editor\", u\"title\": u\"Kann bearbeiten\"},",
            "                {u\"id\": u\"Reader\", u\"title\": u\"Kann ansehen\"},",
            "                {u\"id\": u\"Reviewer\", u\"title\": u\"Kann ver\\xf6ffentlichen\"},",
            "            ],",
            "            available_roles,",
            "        )",
            "",
            "    def test_sharing_requires_delegate_roles_permission(self):",
            "        \"\"\"A response for an object without any roles assigned\"\"\"",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "    def test_get_local_roles_none_assigned(self):",
            "        \"\"\"A response for an object without any roles assigned\"\"\"",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(",
            "            response.json(),",
            "            {",
            "                u\"available_roles\": [",
            "                    {u\"id\": u\"Contributor\", u\"title\": u\"Can add\"},",
            "                    {u\"id\": u\"Editor\", u\"title\": u\"Can edit\"},",
            "                    {u\"id\": u\"Reader\", u\"title\": u\"Can view\"},",
            "                    {u\"id\": u\"Reviewer\", u\"title\": u\"Can review\"},",
            "                ],",
            "                u\"entries\": [",
            "                    {",
            "                        u\"disabled\": False,",
            "                        u\"id\": u\"AuthenticatedUsers\",",
            "                        u\"login\": None,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": False,",
            "                        },",
            "                        u\"title\": u\"Logged-in users\",",
            "                        u\"type\": u\"group\",",
            "                    }",
            "                ],",
            "                u\"inherit\": True,",
            "            },",
            "        )",
            "",
            "    def test_get_local_roles_with_user(self):",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Reviewer\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(",
            "            response.json(),",
            "            {",
            "                u\"available_roles\": [",
            "                    {u\"id\": u\"Contributor\", u\"title\": u\"Can add\"},",
            "                    {u\"id\": u\"Editor\", u\"title\": u\"Can edit\"},",
            "                    {u\"id\": u\"Reader\", u\"title\": u\"Can view\"},",
            "                    {u\"id\": u\"Reviewer\", u\"title\": u\"Can review\"},",
            "                ],",
            "                u\"entries\": [",
            "                    {",
            "                        u\"disabled\": False,",
            "                        u\"id\": u\"AuthenticatedUsers\",",
            "                        u\"login\": None,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": False,",
            "                        },",
            "                        u\"title\": u\"Logged-in users\",",
            "                        u\"type\": u\"group\",",
            "                    },",
            "                    {",
            "                        u\"disabled\": False,",
            "                        u\"id\": u\"test_user_1_\",",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"title\": u\"test-user\",",
            "                        u\"type\": u\"user\",",
            "                    },",
            "                ],",
            "                u\"inherit\": True,",
            "            },",
            "        )",
            "",
            "    def test_set_local_roles_for_user(self):",
            "",
            "        pas = getToolByName(self.portal, \"acl_users\")",
            "        self.assertEqual(",
            "            pas.getLocalRolesForDisplay(self.portal.folder1),",
            "            ((\"admin\", (\"Owner\",), \"user\", \"admin\"),),",
            "        )",
            "",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": TEST_USER_ID,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": True,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(",
            "            sorted_roles(pas.getLocalRolesForDisplay(self.portal.folder1)),",
            "            [",
            "                [\"admin\", [\"Owner\"], \"user\", \"admin\"],",
            "                [\"test-user\", [u\"Reader\", u\"Reviewer\"], \"user\", u\"test_user_1_\"],",
            "            ],",
            "        )",
            "",
            "    def test_may_only_manage_roles_already_held(self):",
            "        # Grant Editor role to our test user (which gives them the required",
            "        # \"plone.DelegateRoles\" permission to manage local roles at all)",
            "        api.user.grant_roles(username=TEST_USER_ID, obj=self.portal.folder1,",
            "                             roles=['Editor'])",
            "        transaction.commit()",
            "",
            "        # Guard assertion - our test user starts with a limited set of roles",
            "        existing_roles = api.user.get_roles(username=TEST_USER_ID,",
            "                                            obj=self.portal.folder1)",
            "        self.assertEqual(",
            "            sorted(['Member', 'Authenticated', 'Editor']),",
            "            sorted(existing_roles))",
            "",
            "        # Attempt to gain additional roles not already held",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(TEST_USER_NAME, TEST_USER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": TEST_USER_ID,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": True,",
            "                            u\"Editor\": True,",
            "                            u\"Reader\": True,",
            "                            u\"Publisher\": True,",
            "                            u\"Reviewer\": True,",
            "                            u\"Manager\": True,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        new_roles = api.user.get_roles(username=TEST_USER_ID,",
            "                                       obj=self.portal.folder1)",
            "",
            "        # New roles should not contain any new roles that the user didn't",
            "        # have permission to delegate.",
            "        self.assertNotIn(u'Manager', new_roles)",
            "        self.assertNotIn(u'Publisher', new_roles)",
            "        self.assertNotIn(u'Reviewer', new_roles)",
            "        self.assertNotIn(u'Contributor', new_roles)",
            "",
            "        # 'Reader' gets added because the permission to delegate it is",
            "        # assigned to 'Editor' by default (see p.a.workflow.permissions)",
            "        self.assertEqual(",
            "            sorted(['Member', 'Authenticated', 'Editor', 'Reader']),",
            "            sorted(new_roles))",
            "",
            "    def test_unmanaged_existing_roles_are_retained_on_update(self):",
            "        \"\"\"Make sure that existing roles don't get dropped when a user that",
            "        doesn't manage that roles updates local roles for another user that",
            "        already holds that role.",
            "        \"\"\"",
            "        # Create another user that holds the Reviewer role, which is not",
            "        # managed by our test user",
            "        api.user.create(username='peter', email='peter@example.org',",
            "                        password='secret', roles=('Member', ))",
            "",
            "        api.user.grant_roles(username='peter', obj=self.portal.folder1,",
            "                             roles=['Reviewer'])",
            "        transaction.commit()",
            "",
            "        peters_existing_roles = api.user.get_roles(username='peter',",
            "                                                   obj=self.portal.folder1)",
            "        self.assertEqual(sorted(['Member', 'Reviewer', 'Authenticated']),",
            "                         sorted(peters_existing_roles))",
            "",
            "        # Grant Editor role to our test user (which gives them the required",
            "        # \"plone.DelegateRoles\" permission to manage local roles at all)",
            "        api.user.grant_roles(username=TEST_USER_ID, obj=self.portal.folder1,",
            "                             roles=['Editor'])",
            "        transaction.commit()",
            "",
            "        # Guard assertion - our test user doesn't have/manage Reviewer",
            "        existing_roles = api.user.get_roles(username=TEST_USER_ID,",
            "                                            obj=self.portal.folder1)",
            "        self.assertEqual(",
            "            sorted(['Member', 'Authenticated', 'Editor']),",
            "            sorted(existing_roles))",
            "",
            "        # Test user now gives Editor to peter. This should not lead to",
            "        # peter losing the Reviewer role.",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(TEST_USER_NAME, TEST_USER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": \"peter\",",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": True,",
            "                            u\"Reader\": True,",
            "                            u\"Publisher\": False,",
            "                            u\"Reviewer\": True,",
            "                            u\"Manager\": False,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        new_roles = api.user.get_roles(username='peter',",
            "                                       obj=self.portal.folder1)",
            "",
            "        self.assertIn(u'Reviewer', new_roles)",
            "        self.assertEqual(",
            "            sorted(['Member', 'Authenticated', 'Editor', 'Reader', 'Reviewer']),",
            "            sorted(new_roles))",
            "",
            "    def test_unset_local_roles_for_user(self):",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Reviewer\", \"Reader\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        pas = getToolByName(self.portal, \"acl_users\")",
            "        self.assertEqual(",
            "            sorted_roles(pas.getLocalRolesForDisplay(self.portal.folder1)),",
            "            [",
            "                [\"admin\", [\"Owner\"], \"user\", \"admin\"],",
            "                [\"test-user\", [\"Reader\", \"Reviewer\"], \"user\", \"test_user_1_\"],",
            "            ],",
            "        )",
            "",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": TEST_USER_ID,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": False,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(",
            "            pas.getLocalRolesForDisplay(self.portal.folder1),",
            "            (",
            "                (\"admin\", (\"Owner\",), \"user\", \"admin\"),",
            "                (\"test-user\", (u\"Reviewer\",), \"user\", u\"test_user_1_\"),",
            "            ),",
            "        )",
            "",
            "    def test_set_local_roles_on_site_root(self):",
            "",
            "        pas = getToolByName(self.portal, \"acl_users\")",
            "        self.assertEqual(",
            "            pas.getLocalRolesForDisplay(self.portal),",
            "            ((\"admin\", (\"Owner\",), \"user\", \"admin\"),),",
            "        )",
            "",
            "        response = requests.post(",
            "            self.portal.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={",
            "                \"entries\": [",
            "                    {",
            "                        u\"id\": TEST_USER_ID,",
            "                        u\"roles\": {",
            "                            u\"Contributor\": False,",
            "                            u\"Editor\": False,",
            "                            u\"Reader\": True,",
            "                            u\"Reviewer\": True,",
            "                        },",
            "                        u\"type\": u\"user\",",
            "                    }",
            "                ]",
            "            },",
            "        )",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(",
            "            sorted_roles(pas.getLocalRolesForDisplay(self.portal)),",
            "            [",
            "                [\"admin\", [\"Owner\"], \"user\", \"admin\"],",
            "                [\"test-user\", [u\"Reader\", u\"Reviewer\"], \"user\", u\"test_user_1_\"],",
            "            ],",
            "        )",
            "",
            "    def test_get_local_roles_inherit_roles(self):",
            "        # __ac_local_roles_block__ specifies to block inheritance:",
            "        # https://docs.plone.org/develop/plone/security/local_roles.html",
            "        self.portal.folder1.__ac_local_roles_block__ = True",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.json()[\"inherit\"], False)",
            "",
            "    def test_set_local_roles_inherit(self):",
            "        self.assertEqual(self._get_ac_local_roles_block(self.portal.folder1), False)",
            "",
            "        # block local roles",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={\"inherit\": False},",
            "        )",
            "",
            "        transaction.commit()",
            "        self.assertEqual(self._get_ac_local_roles_block(self.portal.folder1), True)",
            "        # unblock local roles",
            "        response = requests.post(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "            json={\"inherit\": True},",
            "        )",
            "        transaction.commit()",
            "",
            "        self.assertEqual(response.status_code, 204)",
            "        self.assertEqual(self._get_ac_local_roles_block(self.portal.folder1), False)",
            "",
            "    def test_get_available_roles(self):",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Reviewer\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 200)",
            "        response = response.json()",
            "        self.assertIn(\"available_roles\", response)",
            "        self.assertIn(",
            "            {\"id\": \"Reader\", \"title\": \"Can view\"}, response[\"available_roles\"]",
            "        )",
            "",
            "    def test_inherited_global(self):",
            "        api.user.grant_roles(username=TEST_USER_ID, roles=[\"Reviewer\"])",
            "        api.user.grant_roles(",
            "            username=TEST_USER_ID, obj=self.portal.folder1, roles=[\"Editor\"]",
            "        )",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.doc1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        response = response.json()",
            "        # find our entry",
            "        entry = [x for x in response[\"entries\"] if x[\"id\"] == TEST_USER_ID][0]",
            "",
            "        self.assertEqual(\"global\", entry[\"roles\"][\"Reviewer\"])",
            "        self.assertEqual(\"acquired\", entry[\"roles\"][\"Editor\"])",
            "",
            "    def test_inherited_global_via_search(self):",
            "        api.user.create(email=\"jos@henken.local\", username=\"jos\")",
            "        api.user.grant_roles(username=\"jos\", roles=[\"Reviewer\"])",
            "        api.user.grant_roles(username=\"jos\", roles=[\"Editor\"], obj=self.portal.folder1)",
            "        transaction.commit()",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.doc1.absolute_url() + \"/@sharing?search=jos\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "        response = response.json()",
            "        # find our entry",
            "        entry = [x for x in response[\"entries\"] if x[\"id\"] == \"jos\"][0]",
            "",
            "        self.assertEqual(\"global\", entry[\"roles\"][\"Reviewer\"])",
            "        self.assertEqual(\"acquired\", entry[\"roles\"][\"Editor\"])",
            "",
            "    def test_no_serializer_available_returns_501(self):",
            "        # This test unregisters the local_roles adapter. The testrunner can",
            "        # not auto-revert this on test tearDown. Therefore if we ever run",
            "        # into test isolation issues. Start to look here first.",
            "        gsm = getGlobalSiteManager()",
            "        gsm.unregisterAdapter(SerializeLocalRolesToJson, name=\"local_roles\")",
            "",
            "        response = requests.get(",
            "            self.portal.folder1.absolute_url() + \"/@sharing\",",
            "            headers={\"Accept\": \"application/json\"},",
            "            auth=(SITE_OWNER_NAME, SITE_OWNER_PASSWORD),",
            "        )",
            "",
            "        self.assertEqual(response.status_code, 501)",
            "        response = response.json()",
            "        self.assertIn(\"error\", response)",
            "        self.assertEqual(u\"No serializer available.\", response[\"error\"][\"message\"])",
            "",
            "        # we need to re-register the adapter here for following tests",
            "        gsm.registerAdapter(SerializeLocalRolesToJson, name=\"local_roles\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "jose.jwe",
            "src.plone.restapi.tests.test_content_local_roles.TestFolderCreate.self"
        ]
    }
}