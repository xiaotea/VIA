{
    "archivy/helpers.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import elasticsearch"
            },
            "1": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " import yaml"
            },
            "2": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from elasticsearch import Elasticsearch"
            },
            "3": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from flask import current_app, g"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+from flask import current_app, g, request"
            },
            "5": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from tinydb import TinyDB, Query, operations"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+from urllib.parse import urlparse, urljoin"
            },
            "7": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from archivy.config import BaseHooks, Config"
            },
            "9": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 230,
                "afterPatchRowNumber": 231,
                "PatchRowcode": "         return True"
            },
            "11": {
                "beforePatchRowNumber": 231,
                "afterPatchRowNumber": 232,
                "PatchRowcode": "     except FileExistsError:"
            },
            "12": {
                "beforePatchRowNumber": 232,
                "afterPatchRowNumber": 233,
                "PatchRowcode": "         return False"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 234,
                "PatchRowcode": "+"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 235,
                "PatchRowcode": "+"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 236,
                "PatchRowcode": "+def is_safe_redirect_url(target):"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 237,
                "PatchRowcode": "+    host_url = urlparse(request.host_url)"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 238,
                "PatchRowcode": "+    redirect_url = urlparse(urljoin(request.host_url, target))"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 239,
                "PatchRowcode": "+    return ("
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 240,
                "PatchRowcode": "+        redirect_url.scheme in (\"http\", \"https\")"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 241,
                "PatchRowcode": "+        and host_url.netloc == redirect_url.netloc"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 242,
                "PatchRowcode": "+    )"
            }
        },
        "frontPatchFile": [
            "from pathlib import Path",
            "import sys",
            "import os",
            "",
            "import elasticsearch",
            "import yaml",
            "from elasticsearch import Elasticsearch",
            "from flask import current_app, g",
            "from tinydb import TinyDB, Query, operations",
            "",
            "from archivy.config import BaseHooks, Config",
            "",
            "",
            "def load_config(path=\"\"):",
            "    \"\"\"Loads `config.yml` file safely and deserializes it to a python dict.\"\"\"",
            "    path = path or current_app.config[\"INTERNAL_DIR\"]",
            "    with (Path(path) / \"config.yml\").open() as f:",
            "        return yaml.load(f.read(), Loader=yaml.SafeLoader)",
            "",
            "",
            "def config_diff(curr_key, curr_val, parent_dict, defaults):",
            "    \"\"\"",
            "    This function diffs the user config with the defaults to only save what is actually different.",
            "",
            "    Returns 1 if the current element or its nested elements are different and have been preserved.",
            "    \"\"\"",
            "    if type(curr_val) is dict:",
            "        # the any call here diffs all nested children of the current dict and returns whether any have modifications",
            "        if not any(",
            "            [",
            "                config_diff(k, v, curr_val, defaults[curr_key])",
            "                for k, v in list(curr_val.items())",
            "            ]",
            "        ):",
            "            parent_dict.pop(curr_key)",
            "            return 0",
            "    else:",
            "        if defaults[curr_key] == curr_val:",
            "            parent_dict.pop(curr_key)",
            "            return 0",
            "    return 1",
            "",
            "",
            "def write_config(config: dict):",
            "    \"\"\"",
            "    Writes a new config dict to a `config.yml` file that will override defaults.",
            "    Compares user config with defaults to only save changes.",
            "    \"\"\"",
            "    defaults = vars(Config())",
            "    for k, v in list(config.items()):",
            "        if k != \"SECRET_KEY\":",
            "            config_diff(k, v, config, defaults)",
            "    with (Path(current_app.config[\"INTERNAL_DIR\"]) / \"config.yml\").open(\"w\") as f:",
            "        yaml.dump(config, f)",
            "",
            "",
            "def load_hooks():",
            "    try:",
            "        user_hooks = (Path(current_app.config[\"USER_DIR\"]) / \"hooks.py\").open()",
            "    except FileNotFoundError:",
            "        return BaseHooks()",
            "",
            "    user_locals = {}",
            "    exec(user_hooks.read(), globals(), user_locals)",
            "    user_hooks.close()",
            "    return user_locals.get(\"Hooks\", BaseHooks)()",
            "",
            "",
            "def load_scraper():",
            "    try:",
            "        user_scraping = (Path(current_app.config[\"USER_DIR\"]) / \"scraping.py\").open()",
            "    except FileNotFoundError:",
            "        return {}",
            "    user_locals = {}",
            "    exec(user_scraping.read(), globals(), user_locals)",
            "    user_scraping.close()",
            "    return user_locals.get(\"PATTERNS\", {})",
            "",
            "",
            "def get_db(force_reconnect=False):",
            "    \"\"\"",
            "    Returns the database object that you can use to",
            "    store data persistently",
            "    \"\"\"",
            "    if \"db\" not in g or force_reconnect:",
            "        g.db = TinyDB(str(Path(current_app.config[\"INTERNAL_DIR\"]) / \"db.json\"))",
            "",
            "    return g.db",
            "",
            "",
            "def get_max_id():",
            "    \"\"\"Returns the current maximum id of dataobjs in the database.\"\"\"",
            "    db = get_db()",
            "    max_id = db.search(Query().name == \"max_id\")",
            "    if not max_id:",
            "        db.insert({\"name\": \"max_id\", \"val\": 0})",
            "        return 0",
            "    return max_id[0][\"val\"]",
            "",
            "",
            "def set_max_id(val):",
            "    \"\"\"Sets a new max_id\"\"\"",
            "    db = get_db()",
            "    db.update(operations.set(\"val\", val), Query().name == \"max_id\")",
            "",
            "",
            "def test_es_connection(es):",
            "    \"\"\"Tests health and presence of connection to elasticsearch.\"\"\"",
            "    try:",
            "        health = es.cluster.health()",
            "    except elasticsearch.exceptions.ConnectionError:",
            "        current_app.logger.error(",
            "            \"Elasticsearch does not seem to be running on \"",
            "            f\"{current_app.config['SEARCH_CONF']['url']}. Please start \"",
            "            \"it, for example with: sudo service elasticsearch restart\"",
            "        )",
            "        current_app.logger.error(",
            "            \"You can disable Elasticsearch by modifying the `enabled` variable \"",
            "            f\"in {str(Path(current_app.config['INTERNAL_DIR']) / 'config.yml')}\"",
            "        )",
            "        sys.exit(1)",
            "",
            "    if health[\"status\"] not in (\"yellow\", \"green\"):",
            "        current_app.logger.warning(",
            "            \"Elasticsearch reports that it is not working \"",
            "            \"properly. Search might not work. You can disable \"",
            "            \"Elasticsearch by setting ELASTICSEARCH_ENABLED to 0.\"",
            "        )",
            "",
            "",
            "def get_elastic_client(error_if_invalid=True):",
            "    \"\"\"Returns the elasticsearch client you can use to search and insert / delete data\"\"\"",
            "    if (",
            "        not current_app.config[\"SEARCH_CONF\"][\"enabled\"]",
            "        or current_app.config[\"SEARCH_CONF\"][\"engine\"] != \"elasticsearch\"",
            "    ) and error_if_invalid:",
            "        return None",
            "",
            "    auth_setup = (",
            "        current_app.config[\"SEARCH_CONF\"][\"es_user\"]",
            "        and current_app.config[\"SEARCH_CONF\"][\"es_password\"]",
            "    )",
            "    if auth_setup:",
            "        es = Elasticsearch(",
            "            current_app.config[\"SEARCH_CONF\"][\"url\"],",
            "            http_auth=(",
            "                current_app.config[\"SEARCH_CONF\"][\"es_user\"],",
            "                current_app.config[\"SEARCH_CONF\"][\"es_password\"],",
            "            ),",
            "        )",
            "    else:",
            "        es = Elasticsearch(current_app.config[\"SEARCH_CONF\"][\"url\"])",
            "    if error_if_invalid:",
            "        test_es_connection(es)",
            "    else:",
            "        try:",
            "            es.cluster.health()",
            "        except elasticsearch.exceptions.ConnectionError:",
            "            return False",
            "    return es",
            "",
            "",
            "def create_plugin_dir(name):",
            "    \"\"\"Creates a sample plugin directory\"\"\"",
            "    raw_name = name.replace(\"archivy_\", \"\").replace(\"archivy-\", \"\")",
            "    try:",
            "        os.makedirs(f\"{name}/{name}\")",
            "",
            "        # Creates requirements.txt.",
            "        with open(f\"{name}/requirements.txt\", \"w\") as fp:",
            "            fp.writelines([\"archivy\", \"\\nclick\"])",
            "",
            "        # Creates an empty readme file to be filled",
            "        with open(f\"{name}/README.md\", \"w+\") as fp:",
            "            fp.writelines(",
            "                [",
            "                    f\"# {name}\",",
            "                    \"\\n\\n## Install\",",
            "                    \"\\n\\nYou need to have `archivy` already installed.\",",
            "                    f\"\\n\\nRun `pip install archivy_{name}`\",",
            "                    \"\\n\\n## Usage\",",
            "                ]",
            "            )",
            "",
            "        # Creates a setup.py file",
            "        with open(f\"{name}/setup.py\", \"w\") as setup_f:",
            "            setup_f.writelines(",
            "                [",
            "                    \"from setuptools import setup, find_packages\",",
            "                    '\\n\\nwith open(\"README.md\", \"r\") as fh:',",
            "                    \"\\n\\tlong_description = fh.read()\",",
            "                    '\\n\\nwith open(\"requirements.txt\", encoding=\"utf-8\") as f:',",
            "                    '\\n\\tall_reqs = f.read().split(\"\\\\n\")',",
            "                    \"\\n\\tinstall_requires = [x.strip() for x in all_reqs]\",",
            "                    \"\\n\\n#Fill in the details below for distribution purposes\"",
            "                    f'\\nsetup(\\n\\tname=\"{name}\",',",
            "                    '\\n\\tversion=\"0.0.1\",',",
            "                    '\\n\\tauthor=\"\",',",
            "                    '\\n\\tauthor_email=\"\",',",
            "                    '\\n\\tdescription=\"\",',",
            "                    \"\\n\\tlong_description=long_description,\",",
            "                    '\\n\\tlong_description_content_type=\"text/markdown\",',",
            "                    '\\n\\tclassifiers=[\"Programming Language :: Python :: 3\"],'",
            "                    \"\\n\\tpackages=find_packages(),\",",
            "                    \"\\n\\tinstall_requires=install_requires,\",",
            "                    f'\\n\\tentry_points=\"\"\"\\n\\t\\t[archivy.plugins]'",
            "                    f'\\n\\t\\t{raw_name}={name}:{raw_name}\"\"\"\\n)',",
            "                ]",
            "            )",
            "",
            "        # Creating a basic __init__.py file where the main function of the plugin goes",
            "        with open(f\"{name}/{name}/__init__.py\", \"w\") as fp:",
            "            fp.writelines(",
            "                [",
            "                    \"import archivy\",",
            "                    \"\\nimport click\",",
            "                    \"\\n\\n# Fill in the functionality for the commands (see https://archivy.github.io/plugins/)\",",
            "                    \"\\n@click.group()\",",
            "                    f\"\\ndef {raw_name}():\",",
            "                    \"\\n\\tpass\",",
            "                    f\"\\n\\n@{raw_name}.command()\",",
            "                    \"\\ndef command1():\",",
            "                    \"\\n\\tpass\",",
            "                    f\"\\n\\n@{raw_name}.command()\",",
            "                    \"\\ndef command2():\",",
            "                    \"\\n\\tpass\",",
            "                ]",
            "            )",
            "",
            "        return True",
            "    except FileExistsError:",
            "        return False"
        ],
        "afterPatchFile": [
            "from pathlib import Path",
            "import sys",
            "import os",
            "",
            "import elasticsearch",
            "import yaml",
            "from elasticsearch import Elasticsearch",
            "from flask import current_app, g, request",
            "from tinydb import TinyDB, Query, operations",
            "from urllib.parse import urlparse, urljoin",
            "",
            "from archivy.config import BaseHooks, Config",
            "",
            "",
            "def load_config(path=\"\"):",
            "    \"\"\"Loads `config.yml` file safely and deserializes it to a python dict.\"\"\"",
            "    path = path or current_app.config[\"INTERNAL_DIR\"]",
            "    with (Path(path) / \"config.yml\").open() as f:",
            "        return yaml.load(f.read(), Loader=yaml.SafeLoader)",
            "",
            "",
            "def config_diff(curr_key, curr_val, parent_dict, defaults):",
            "    \"\"\"",
            "    This function diffs the user config with the defaults to only save what is actually different.",
            "",
            "    Returns 1 if the current element or its nested elements are different and have been preserved.",
            "    \"\"\"",
            "    if type(curr_val) is dict:",
            "        # the any call here diffs all nested children of the current dict and returns whether any have modifications",
            "        if not any(",
            "            [",
            "                config_diff(k, v, curr_val, defaults[curr_key])",
            "                for k, v in list(curr_val.items())",
            "            ]",
            "        ):",
            "            parent_dict.pop(curr_key)",
            "            return 0",
            "    else:",
            "        if defaults[curr_key] == curr_val:",
            "            parent_dict.pop(curr_key)",
            "            return 0",
            "    return 1",
            "",
            "",
            "def write_config(config: dict):",
            "    \"\"\"",
            "    Writes a new config dict to a `config.yml` file that will override defaults.",
            "    Compares user config with defaults to only save changes.",
            "    \"\"\"",
            "    defaults = vars(Config())",
            "    for k, v in list(config.items()):",
            "        if k != \"SECRET_KEY\":",
            "            config_diff(k, v, config, defaults)",
            "    with (Path(current_app.config[\"INTERNAL_DIR\"]) / \"config.yml\").open(\"w\") as f:",
            "        yaml.dump(config, f)",
            "",
            "",
            "def load_hooks():",
            "    try:",
            "        user_hooks = (Path(current_app.config[\"USER_DIR\"]) / \"hooks.py\").open()",
            "    except FileNotFoundError:",
            "        return BaseHooks()",
            "",
            "    user_locals = {}",
            "    exec(user_hooks.read(), globals(), user_locals)",
            "    user_hooks.close()",
            "    return user_locals.get(\"Hooks\", BaseHooks)()",
            "",
            "",
            "def load_scraper():",
            "    try:",
            "        user_scraping = (Path(current_app.config[\"USER_DIR\"]) / \"scraping.py\").open()",
            "    except FileNotFoundError:",
            "        return {}",
            "    user_locals = {}",
            "    exec(user_scraping.read(), globals(), user_locals)",
            "    user_scraping.close()",
            "    return user_locals.get(\"PATTERNS\", {})",
            "",
            "",
            "def get_db(force_reconnect=False):",
            "    \"\"\"",
            "    Returns the database object that you can use to",
            "    store data persistently",
            "    \"\"\"",
            "    if \"db\" not in g or force_reconnect:",
            "        g.db = TinyDB(str(Path(current_app.config[\"INTERNAL_DIR\"]) / \"db.json\"))",
            "",
            "    return g.db",
            "",
            "",
            "def get_max_id():",
            "    \"\"\"Returns the current maximum id of dataobjs in the database.\"\"\"",
            "    db = get_db()",
            "    max_id = db.search(Query().name == \"max_id\")",
            "    if not max_id:",
            "        db.insert({\"name\": \"max_id\", \"val\": 0})",
            "        return 0",
            "    return max_id[0][\"val\"]",
            "",
            "",
            "def set_max_id(val):",
            "    \"\"\"Sets a new max_id\"\"\"",
            "    db = get_db()",
            "    db.update(operations.set(\"val\", val), Query().name == \"max_id\")",
            "",
            "",
            "def test_es_connection(es):",
            "    \"\"\"Tests health and presence of connection to elasticsearch.\"\"\"",
            "    try:",
            "        health = es.cluster.health()",
            "    except elasticsearch.exceptions.ConnectionError:",
            "        current_app.logger.error(",
            "            \"Elasticsearch does not seem to be running on \"",
            "            f\"{current_app.config['SEARCH_CONF']['url']}. Please start \"",
            "            \"it, for example with: sudo service elasticsearch restart\"",
            "        )",
            "        current_app.logger.error(",
            "            \"You can disable Elasticsearch by modifying the `enabled` variable \"",
            "            f\"in {str(Path(current_app.config['INTERNAL_DIR']) / 'config.yml')}\"",
            "        )",
            "        sys.exit(1)",
            "",
            "    if health[\"status\"] not in (\"yellow\", \"green\"):",
            "        current_app.logger.warning(",
            "            \"Elasticsearch reports that it is not working \"",
            "            \"properly. Search might not work. You can disable \"",
            "            \"Elasticsearch by setting ELASTICSEARCH_ENABLED to 0.\"",
            "        )",
            "",
            "",
            "def get_elastic_client(error_if_invalid=True):",
            "    \"\"\"Returns the elasticsearch client you can use to search and insert / delete data\"\"\"",
            "    if (",
            "        not current_app.config[\"SEARCH_CONF\"][\"enabled\"]",
            "        or current_app.config[\"SEARCH_CONF\"][\"engine\"] != \"elasticsearch\"",
            "    ) and error_if_invalid:",
            "        return None",
            "",
            "    auth_setup = (",
            "        current_app.config[\"SEARCH_CONF\"][\"es_user\"]",
            "        and current_app.config[\"SEARCH_CONF\"][\"es_password\"]",
            "    )",
            "    if auth_setup:",
            "        es = Elasticsearch(",
            "            current_app.config[\"SEARCH_CONF\"][\"url\"],",
            "            http_auth=(",
            "                current_app.config[\"SEARCH_CONF\"][\"es_user\"],",
            "                current_app.config[\"SEARCH_CONF\"][\"es_password\"],",
            "            ),",
            "        )",
            "    else:",
            "        es = Elasticsearch(current_app.config[\"SEARCH_CONF\"][\"url\"])",
            "    if error_if_invalid:",
            "        test_es_connection(es)",
            "    else:",
            "        try:",
            "            es.cluster.health()",
            "        except elasticsearch.exceptions.ConnectionError:",
            "            return False",
            "    return es",
            "",
            "",
            "def create_plugin_dir(name):",
            "    \"\"\"Creates a sample plugin directory\"\"\"",
            "    raw_name = name.replace(\"archivy_\", \"\").replace(\"archivy-\", \"\")",
            "    try:",
            "        os.makedirs(f\"{name}/{name}\")",
            "",
            "        # Creates requirements.txt.",
            "        with open(f\"{name}/requirements.txt\", \"w\") as fp:",
            "            fp.writelines([\"archivy\", \"\\nclick\"])",
            "",
            "        # Creates an empty readme file to be filled",
            "        with open(f\"{name}/README.md\", \"w+\") as fp:",
            "            fp.writelines(",
            "                [",
            "                    f\"# {name}\",",
            "                    \"\\n\\n## Install\",",
            "                    \"\\n\\nYou need to have `archivy` already installed.\",",
            "                    f\"\\n\\nRun `pip install archivy_{name}`\",",
            "                    \"\\n\\n## Usage\",",
            "                ]",
            "            )",
            "",
            "        # Creates a setup.py file",
            "        with open(f\"{name}/setup.py\", \"w\") as setup_f:",
            "            setup_f.writelines(",
            "                [",
            "                    \"from setuptools import setup, find_packages\",",
            "                    '\\n\\nwith open(\"README.md\", \"r\") as fh:',",
            "                    \"\\n\\tlong_description = fh.read()\",",
            "                    '\\n\\nwith open(\"requirements.txt\", encoding=\"utf-8\") as f:',",
            "                    '\\n\\tall_reqs = f.read().split(\"\\\\n\")',",
            "                    \"\\n\\tinstall_requires = [x.strip() for x in all_reqs]\",",
            "                    \"\\n\\n#Fill in the details below for distribution purposes\"",
            "                    f'\\nsetup(\\n\\tname=\"{name}\",',",
            "                    '\\n\\tversion=\"0.0.1\",',",
            "                    '\\n\\tauthor=\"\",',",
            "                    '\\n\\tauthor_email=\"\",',",
            "                    '\\n\\tdescription=\"\",',",
            "                    \"\\n\\tlong_description=long_description,\",",
            "                    '\\n\\tlong_description_content_type=\"text/markdown\",',",
            "                    '\\n\\tclassifiers=[\"Programming Language :: Python :: 3\"],'",
            "                    \"\\n\\tpackages=find_packages(),\",",
            "                    \"\\n\\tinstall_requires=install_requires,\",",
            "                    f'\\n\\tentry_points=\"\"\"\\n\\t\\t[archivy.plugins]'",
            "                    f'\\n\\t\\t{raw_name}={name}:{raw_name}\"\"\"\\n)',",
            "                ]",
            "            )",
            "",
            "        # Creating a basic __init__.py file where the main function of the plugin goes",
            "        with open(f\"{name}/{name}/__init__.py\", \"w\") as fp:",
            "            fp.writelines(",
            "                [",
            "                    \"import archivy\",",
            "                    \"\\nimport click\",",
            "                    \"\\n\\n# Fill in the functionality for the commands (see https://archivy.github.io/plugins/)\",",
            "                    \"\\n@click.group()\",",
            "                    f\"\\ndef {raw_name}():\",",
            "                    \"\\n\\tpass\",",
            "                    f\"\\n\\n@{raw_name}.command()\",",
            "                    \"\\ndef command1():\",",
            "                    \"\\n\\tpass\",",
            "                    f\"\\n\\n@{raw_name}.command()\",",
            "                    \"\\ndef command2():\",",
            "                    \"\\n\\tpass\",",
            "                ]",
            "            )",
            "",
            "        return True",
            "    except FileExistsError:",
            "        return False",
            "",
            "",
            "def is_safe_redirect_url(target):",
            "    host_url = urlparse(request.host_url)",
            "    redirect_url = urlparse(urljoin(request.host_url, target))",
            "    return (",
            "        redirect_url.scheme in (\"http\", \"https\")",
            "        and host_url.netloc == redirect_url.netloc",
            "    )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "8": []
        },
        "addLocation": []
    },
    "archivy/routes.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " from archivy.models import DataObj, User"
            },
            "2": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from archivy import data, app, forms, csrf"
            },
            "3": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from archivy.helpers import get_db, write_config"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+from archivy.helpers import get_db, write_config, is_safe_redirect_url"
            },
            "5": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " from archivy.tags import get_all_tags"
            },
            "6": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " from archivy.search import search, search_frontmatter_tags"
            },
            "7": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " from archivy.config import Config"
            },
            "8": {
                "beforePatchRowNumber": 264,
                "afterPatchRowNumber": 264,
                "PatchRowcode": "             flash(\"Login successful!\", \"success\")"
            },
            "9": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": 265,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": 266,
                "PatchRowcode": "             next_url = request.args.get(\"next\")"
            },
            "11": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return redirect(next_url or \"/\")"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 267,
                "PatchRowcode": "+            if next_url and is_safe_redirect_url(next_url):"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 268,
                "PatchRowcode": "+                return redirect(next_url)"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 269,
                "PatchRowcode": "+            else:"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 270,
                "PatchRowcode": "+                return redirect(\"/\")"
            },
            "16": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": 271,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": 272,
                "PatchRowcode": "         flash(\"Invalid credentials\", \"error\")"
            },
            "18": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 273,
                "PatchRowcode": "         return redirect(\"/login\")"
            }
        },
        "frontPatchFile": [
            "from pathlib import Path",
            "from os.path import sep",
            "from pkg_resources import require",
            "from shutil import which",
            "",
            "import frontmatter",
            "from flask import (",
            "    render_template,",
            "    flash,",
            "    redirect,",
            "    request,",
            "    url_for,",
            "    send_file,",
            "    send_from_directory,",
            ")",
            "from flask_login import login_user, current_user, logout_user",
            "from tinydb import Query",
            "from werkzeug.security import check_password_hash, generate_password_hash",
            "",
            "from archivy.models import DataObj, User",
            "from archivy import data, app, forms, csrf",
            "from archivy.helpers import get_db, write_config",
            "from archivy.tags import get_all_tags",
            "from archivy.search import search, search_frontmatter_tags",
            "from archivy.config import Config",
            "",
            "import re",
            "",
            "",
            "@app.context_processor",
            "def pass_defaults():",
            "    dataobjs = data.get_items(load_content=False)",
            "    version = require(\"archivy\")[0].version",
            "    SEP = sep",
            "    # check windows parsing for js (https://github.com/Uzay-G/archivy/issues/115)",
            "    if SEP == \"\\\\\":",
            "        SEP += \"\\\\\"",
            "    return dict(dataobjs=dataobjs, SEP=SEP, version=version)",
            "",
            "",
            "@app.before_request",
            "def check_perms():",
            "    allowed_path = (",
            "        request.path.startswith(\"/login\")",
            "        or request.path.startswith(\"/static\")",
            "        or request.path.startswith(\"/api/login\")",
            "    )",
            "    if not current_user.is_authenticated and not allowed_path:",
            "        return redirect(url_for(\"login\", next=request.path))",
            "    return",
            "",
            "",
            "@app.route(\"/\")",
            "@app.route(\"/index\")",
            "def index():",
            "    path = request.args.get(\"path\", \"\").lstrip(\"/\")",
            "    try:",
            "        files = data.get_items(path=path)",
            "    except FileNotFoundError:",
            "        flash(\"Directory does not exist.\", \"error\")",
            "        return redirect(\"/\")",
            "",
            "    return render_template(",
            "        \"home.html\",",
            "        title=path or \"root\",",
            "        search_enabled=app.config[\"SEARCH_CONF\"][\"enabled\"],",
            "        dir=files,",
            "        current_path=path,",
            "        new_folder_form=forms.NewFolderForm(),",
            "        delete_form=forms.DeleteFolderForm(),",
            "        rename_form=forms.RenameDirectoryForm(),",
            "        view_only=0,",
            "        search_engine=app.config[\"SEARCH_CONF\"][\"engine\"],",
            "    )",
            "",
            "",
            "# TODO: refactor two following methods",
            "@app.route(\"/bookmarks/new\", methods=[\"GET\", \"POST\"])",
            "def new_bookmark():",
            "    default_dir = app.config.get(\"DEFAULT_BOOKMARKS_DIR\", \"root directory\")",
            "    form = forms.NewBookmarkForm(path=default_dir)",
            "    form.path.choices = [(\"\", \"root directory\")] + [",
            "        (pathname, pathname) for pathname in data.get_dirs()",
            "    ]",
            "    if form.validate_on_submit():",
            "        path = form.path.data",
            "        tags = form.tags.data.split(\",\") if form.tags.data != \"\" else []",
            "        tags = [tag.strip() for tag in tags]",
            "        bookmark = DataObj(url=form.url.data, tags=tags, path=path, type=\"bookmark\")",
            "        bookmark.process_bookmark_url()",
            "        bookmark_id = bookmark.insert()",
            "        if bookmark_id:",
            "            flash(\"Bookmark Saved!\", \"success\")",
            "            return redirect(f\"/dataobj/{bookmark_id}\")",
            "        else:",
            "            flash(bookmark.error, \"error\")",
            "            return redirect(\"/bookmarks/new\")",
            "    # for bookmarklet",
            "    form.url.data = request.args.get(\"url\", \"\")",
            "    path = request.args.get(\"path\", default_dir).strip(\"/\")",
            "    # handle empty argument",
            "    form.path.data = path",
            "    return render_template(\"dataobjs/new.html\", title=\"New Bookmark\", form=form)",
            "",
            "",
            "@app.route(\"/notes/new\", methods=[\"GET\", \"POST\"])",
            "def new_note():",
            "    form = forms.NewNoteForm()",
            "    default_dir = \"root directory\"",
            "    form.path.choices = [(\"\", default_dir)] + [",
            "        (pathname, pathname) for pathname in data.get_dirs()",
            "    ]",
            "    if form.validate_on_submit():",
            "        path = form.path.data",
            "        tags = form.tags.data.split(\",\") if form.tags.data != \"\" else []",
            "        tags = [tag.strip() for tag in tags]",
            "        note = DataObj(title=form.title.data, path=path, tags=tags, type=\"note\")",
            "        note_id = note.insert()",
            "        if note_id:",
            "            flash(\"Note Saved!\", \"success\")",
            "            return redirect(f\"/dataobj/{note_id}\")",
            "    path = request.args.get(\"path\", default_dir).strip(\"/\")",
            "    # handle empty argument",
            "    form.path.data = path",
            "    return render_template(\"/dataobjs/new.html\", title=\"New Note\", form=form)",
            "",
            "",
            "@app.route(\"/tags\")",
            "def show_all_tags():",
            "    if not app.config[\"SEARCH_CONF\"][\"engine\"] == \"ripgrep\" and not which(\"rg\"):",
            "        flash(\"Ripgrep must be installed to view pages about embedded tags.\", \"error\")",
            "        return redirect(\"/\")",
            "    tags = sorted(get_all_tags(force=True))",
            "    return render_template(\"tags/all.html\", title=\"All Tags\", tags=tags)",
            "",
            "",
            "@app.route(\"/tags/<tag_name>\")",
            "def show_tag(tag_name):",
            "    if not app.config[\"SEARCH_CONF\"][\"enabled\"] and not which(\"rg\"):",
            "        flash(",
            "            \"Search (for example ripgrep) must be installed to view pages about embedded tags.\",",
            "            \"error\",",
            "        )",
            "        return redirect(\"/\")",
            "",
            "    results = search(f\"#{tag_name}#\", strict=True)",
            "    res_ids = set(",
            "        [item[\"id\"] for item in results]",
            "    )  # avoid duplication of results between context-aware embedded tags and metadata ones",
            "    for res in search_frontmatter_tags(tag_name):",
            "        if res[\"id\"] not in res_ids:",
            "            results.append(res)",
            "",
            "    return render_template(",
            "        \"tags/show.html\",",
            "        title=f\"Tags - {tag_name}\",",
            "        tag_name=tag_name,",
            "        search_result=results,",
            "    )",
            "",
            "",
            "@app.route(\"/dataobj/<int:dataobj_id>\")",
            "def show_dataobj(dataobj_id):",
            "    dataobj = data.get_item(dataobj_id)",
            "    get_title_id_pairs = lambda x: (x[\"title\"], x[\"id\"])",
            "    titles = list(",
            "        map(get_title_id_pairs, data.get_items(structured=False, load_content=False))",
            "    )",
            "",
            "    if not dataobj:",
            "        flash(\"Data could not be found!\", \"error\")",
            "        return redirect(\"/\")",
            "",
            "    if request.args.get(\"raw\") == \"1\":",
            "        return frontmatter.dumps(dataobj)",
            "",
            "    backlinks = []",
            "    if app.config[\"SEARCH_CONF\"][\"enabled\"]:",
            "        if app.config[\"SEARCH_CONF\"][\"engine\"] == \"ripgrep\":",
            "            query = f\"\\|{dataobj_id}]]\"",
            "        else:",
            "            query = f\"|{dataobj_id})]]\"",
            "        backlinks = search(query, strict=True)",
            "",
            "    # Form for moving data into another folder",
            "    move_form = forms.MoveItemForm()",
            "    move_form.path.choices = [(\"\", \"root directory\")] + [",
            "        (pathname, pathname) for pathname in data.get_dirs()",
            "    ]",
            "",
            "    post_title_form = forms.TitleForm()",
            "    post_title_form.title.data = dataobj[\"title\"]",
            "",
            "    # Get all tags",
            "    tag_list = get_all_tags()",
            "    # and the ones present in this dataobj",
            "    embedded_tags = set()",
            "    PATTERN = r\"(?:^|\\n| )#(?:[-_a-zA-Z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u00ff0-9]+)#\"",
            "    for match in re.finditer(PATTERN, dataobj.content):",
            "        embedded_tags.add(match.group(0).replace(\"#\", \"\").lstrip())",
            "",
            "    return render_template(",
            "        \"dataobjs/show.html\",",
            "        title=dataobj[\"title\"],",
            "        dataobj=dataobj,",
            "        backlinks=backlinks,",
            "        current_path=dataobj[\"dir\"],",
            "        form=forms.DeleteDataForm(),",
            "        view_only=0,",
            "        search_enabled=app.config[\"SEARCH_CONF\"][\"enabled\"],",
            "        post_title_form=post_title_form,",
            "        move_form=move_form,",
            "        tag_list=tag_list,",
            "        embedded_tags=embedded_tags,",
            "        titles=titles,",
            "    )",
            "",
            "",
            "@app.route(\"/dataobj/move/<int:dataobj_id>\", methods=[\"POST\"])",
            "def move_item(dataobj_id):",
            "    form = forms.MoveItemForm()",
            "    out_dir = form.path.data if form.path.data != \"\" else \"root directory\"",
            "    if form.path.data == None:",
            "        flash(\"No path specified.\")",
            "        return redirect(f\"/dataobj/{dataobj_id}\")",
            "    try:",
            "        if data.move_item(dataobj_id, form.path.data):",
            "            flash(f\"Data successfully moved to {out_dir}.\", \"success\")",
            "            return redirect(f\"/dataobj/{dataobj_id}\")",
            "        else:",
            "            flash(f\"Data could not be moved to {out_dir}.\", \"error\")",
            "            return redirect(f\"/dataobj/{dataobj_id}\")",
            "    except FileNotFoundError:",
            "        flash(\"Data not found.\", \"error\")",
            "        return redirect(\"/\")",
            "    except FileExistsError:",
            "        flash(\"Data already in target directory.\", \"error\")",
            "        return redirect(f\"/dataobj/{dataobj_id}\")",
            "",
            "",
            "@app.route(\"/dataobj/delete/<int:dataobj_id>\", methods=[\"POST\"])",
            "def delete_data(dataobj_id):",
            "    try:",
            "        data.delete_item(dataobj_id)",
            "    except BaseException:",
            "        flash(\"Data could not be found!\", \"error\")",
            "        return redirect(\"/\")",
            "    flash(\"Data deleted!\", \"success\")",
            "    return redirect(\"/\")",
            "",
            "",
            "@app.route(\"/login\", methods=[\"GET\", \"POST\"])",
            "def login():",
            "    form = forms.UserForm()",
            "    if form.validate_on_submit():",
            "        db = get_db()",
            "        user = db.search(",
            "            (Query().username == form.username.data) & (Query().type == \"user\")",
            "        )",
            "",
            "        if user and check_password_hash(user[0][\"hashed_password\"], form.password.data):",
            "            user = User.from_db(user[0])",
            "            login_user(user, remember=True)",
            "            flash(\"Login successful!\", \"success\")",
            "",
            "            next_url = request.args.get(\"next\")",
            "            return redirect(next_url or \"/\")",
            "",
            "        flash(\"Invalid credentials\", \"error\")",
            "        return redirect(\"/login\")",
            "    return render_template(\"users/login.html\", form=form, title=\"Login\")",
            "",
            "",
            "@app.route(\"/logout\", methods=[\"DELETE\", \"GET\"])",
            "def logout():",
            "    logout_user()",
            "    flash(\"Logged out successfully\", \"success\")",
            "    return redirect(\"/\")",
            "",
            "",
            "@app.route(\"/user/edit\", methods=[\"GET\", \"POST\"])",
            "def edit_user():",
            "    form = forms.UserForm()",
            "    if form.validate_on_submit():",
            "        db = get_db()",
            "        db.update(",
            "            {",
            "                \"username\": form.username.data,",
            "                \"hashed_password\": generate_password_hash(form.password.data),",
            "            },",
            "            doc_ids=[current_user.id],",
            "        )",
            "        flash(\"Information saved!\", \"success\")",
            "        return redirect(\"/\")",
            "    form.username.data = current_user.username",
            "    return render_template(\"users/edit.html\", form=form, title=\"Edit Profile\")",
            "",
            "",
            "@app.route(\"/folders/create\", methods=[\"POST\"])",
            "def create_folder():",
            "    form = forms.NewFolderForm()",
            "    if form.validate_on_submit():",
            "        path = Path(form.parent_dir.data.strip(\"/\")) / form.new_dir.data",
            "        new_path = data.create_dir(str(path))",
            "        flash(\"Folder successfully created.\", \"success\")",
            "        return redirect(f\"/?path={new_path}\")",
            "    flash(\"Could not create folder.\", \"error\")",
            "    return redirect(request.referrer or \"/\")",
            "",
            "",
            "@app.route(\"/folders/delete\", methods=[\"POST\"])",
            "def delete_folder():",
            "    form = forms.DeleteFolderForm()",
            "    if form.validate_on_submit():",
            "        if data.delete_dir(form.dir_name.data):",
            "            flash(\"Folder successfully deleted.\", \"success\")",
            "            return redirect(\"/\")",
            "        else:",
            "            flash(\"Folder not found.\", \"error\")",
            "            return redirect(request.referrer or \"/\", 404)",
            "    flash(\"Could not delete folder.\", \"error\")",
            "    return redirect(request.referrer or \"/\")",
            "",
            "",
            "@app.route(\"/folders/rename\", methods=[\"POST\"])",
            "def rename_folder():",
            "    form = forms.RenameDirectoryForm()",
            "    if form.validate_on_submit():",
            "        try:",
            "            new_path = data.rename_folder(form.current_path.data, form.new_name.data)",
            "            if not new_path:",
            "                flash(\"Invalid input.\", \"error\")",
            "            else:",
            "                flash(\"Renamed successfully.\", \"success\")",
            "                return redirect(f\"/?path={new_path}\")",
            "        except FileNotFoundError:",
            "            flash(\"Directory not found.\", \"error\")",
            "        except FileExistsError:",
            "            flash(\"Target directory exists.\", \"error\")",
            "    return redirect(\"/\")",
            "",
            "",
            "@app.route(\"/bookmarklet\")",
            "def bookmarklet():",
            "    return render_template(\"bookmarklet.html\", title=\"Bookmarklet\")",
            "",
            "",
            "@app.route(\"/images/<filename>\")",
            "def serve_image(filename):",
            "    if filename and data.valid_image_filename(filename):",
            "        image_path = data.image_exists(filename)",
            "        if image_path:",
            "            return send_file(image_path)",
            "        else:",
            "            return \"Image not found\", 404",
            "    else:",
            "        return \"Invalid file request\", 413",
            "",
            "",
            "@app.route(\"/static/custom.css\")",
            "def custom_css():",
            "    if not app.config[\"THEME_CONF\"].get(\"use_custom_css\", False):",
            "        return \"\"",
            "    return send_from_directory(",
            "        Path(app.config[\"USER_DIR\"]) / \"css\",",
            "        app.config[\"THEME_CONF\"][\"custom_css_file\"],",
            "    )",
            "",
            "",
            "@app.route(\"/config\", methods=[\"GET\", \"POST\"])",
            "def config():",
            "    \"\"\"",
            "    Web View to edit and update configuration.",
            "    \"\"\"",
            "",
            "    def update_config_value(key, val, dictionary):",
            "        if key != \"SECRET_KEY\":",
            "            if type(val) is dict:",
            "                for k, v in val.items():",
            "                    update_config_value(k, v, dictionary[key])",
            "            else:",
            "                dictionary[key] = val",
            "",
            "    form = forms.config_form(app.config)",
            "    default = vars(Config())",
            "    if form.validate_on_submit():",
            "        changed_config = Config()",
            "        changed_config.override(form.data)",
            "        for k, v in vars(changed_config).items():",
            "            # propagate changes to configuration",
            "            update_config_value(k, v, app.config)",
            "        write_config(vars(changed_config))  # save to filesystem config",
            "        flash(\"Config successfully updated.\", \"success\")",
            "    elif request.method == \"POST\":",
            "        flash(\"Could not update config.\", \"error\")",
            "    return render_template(",
            "        \"config.html\", conf=form, default=default, title=\"Edit Config\"",
            "    )",
            "",
            "",
            "@csrf.exempt  # exempt from CSRF to be able to submit info directly from bookmarklet",
            "@app.route(\"/save_from_bookmarklet\", methods=[\"POST\"])",
            "def save_raw_url():",
            "    \"\"\"",
            "    Used in the bookmarklet - Saves a URL by taking its raw HTML.",
            "",
            "    POST parameters:",
            "    - html",
            "    - url",
            "    \"\"\"",
            "    html = request.form.get(\"html\")",
            "    if not html:",
            "        return \"No HTML provided\", 400",
            "    bookmark = DataObj(url=request.form.get(\"url\"), type=\"bookmark\")",
            "    bookmark.process_bookmark_url(html)",
            "    if bookmark.insert():",
            "        return redirect(f\"/dataobj/{bookmark.id}\")",
            "    else:",
            "        return \"Could not save bookmark\", 500"
        ],
        "afterPatchFile": [
            "from pathlib import Path",
            "from os.path import sep",
            "from pkg_resources import require",
            "from shutil import which",
            "",
            "import frontmatter",
            "from flask import (",
            "    render_template,",
            "    flash,",
            "    redirect,",
            "    request,",
            "    url_for,",
            "    send_file,",
            "    send_from_directory,",
            ")",
            "from flask_login import login_user, current_user, logout_user",
            "from tinydb import Query",
            "from werkzeug.security import check_password_hash, generate_password_hash",
            "",
            "from archivy.models import DataObj, User",
            "from archivy import data, app, forms, csrf",
            "from archivy.helpers import get_db, write_config, is_safe_redirect_url",
            "from archivy.tags import get_all_tags",
            "from archivy.search import search, search_frontmatter_tags",
            "from archivy.config import Config",
            "",
            "import re",
            "",
            "",
            "@app.context_processor",
            "def pass_defaults():",
            "    dataobjs = data.get_items(load_content=False)",
            "    version = require(\"archivy\")[0].version",
            "    SEP = sep",
            "    # check windows parsing for js (https://github.com/Uzay-G/archivy/issues/115)",
            "    if SEP == \"\\\\\":",
            "        SEP += \"\\\\\"",
            "    return dict(dataobjs=dataobjs, SEP=SEP, version=version)",
            "",
            "",
            "@app.before_request",
            "def check_perms():",
            "    allowed_path = (",
            "        request.path.startswith(\"/login\")",
            "        or request.path.startswith(\"/static\")",
            "        or request.path.startswith(\"/api/login\")",
            "    )",
            "    if not current_user.is_authenticated and not allowed_path:",
            "        return redirect(url_for(\"login\", next=request.path))",
            "    return",
            "",
            "",
            "@app.route(\"/\")",
            "@app.route(\"/index\")",
            "def index():",
            "    path = request.args.get(\"path\", \"\").lstrip(\"/\")",
            "    try:",
            "        files = data.get_items(path=path)",
            "    except FileNotFoundError:",
            "        flash(\"Directory does not exist.\", \"error\")",
            "        return redirect(\"/\")",
            "",
            "    return render_template(",
            "        \"home.html\",",
            "        title=path or \"root\",",
            "        search_enabled=app.config[\"SEARCH_CONF\"][\"enabled\"],",
            "        dir=files,",
            "        current_path=path,",
            "        new_folder_form=forms.NewFolderForm(),",
            "        delete_form=forms.DeleteFolderForm(),",
            "        rename_form=forms.RenameDirectoryForm(),",
            "        view_only=0,",
            "        search_engine=app.config[\"SEARCH_CONF\"][\"engine\"],",
            "    )",
            "",
            "",
            "# TODO: refactor two following methods",
            "@app.route(\"/bookmarks/new\", methods=[\"GET\", \"POST\"])",
            "def new_bookmark():",
            "    default_dir = app.config.get(\"DEFAULT_BOOKMARKS_DIR\", \"root directory\")",
            "    form = forms.NewBookmarkForm(path=default_dir)",
            "    form.path.choices = [(\"\", \"root directory\")] + [",
            "        (pathname, pathname) for pathname in data.get_dirs()",
            "    ]",
            "    if form.validate_on_submit():",
            "        path = form.path.data",
            "        tags = form.tags.data.split(\",\") if form.tags.data != \"\" else []",
            "        tags = [tag.strip() for tag in tags]",
            "        bookmark = DataObj(url=form.url.data, tags=tags, path=path, type=\"bookmark\")",
            "        bookmark.process_bookmark_url()",
            "        bookmark_id = bookmark.insert()",
            "        if bookmark_id:",
            "            flash(\"Bookmark Saved!\", \"success\")",
            "            return redirect(f\"/dataobj/{bookmark_id}\")",
            "        else:",
            "            flash(bookmark.error, \"error\")",
            "            return redirect(\"/bookmarks/new\")",
            "    # for bookmarklet",
            "    form.url.data = request.args.get(\"url\", \"\")",
            "    path = request.args.get(\"path\", default_dir).strip(\"/\")",
            "    # handle empty argument",
            "    form.path.data = path",
            "    return render_template(\"dataobjs/new.html\", title=\"New Bookmark\", form=form)",
            "",
            "",
            "@app.route(\"/notes/new\", methods=[\"GET\", \"POST\"])",
            "def new_note():",
            "    form = forms.NewNoteForm()",
            "    default_dir = \"root directory\"",
            "    form.path.choices = [(\"\", default_dir)] + [",
            "        (pathname, pathname) for pathname in data.get_dirs()",
            "    ]",
            "    if form.validate_on_submit():",
            "        path = form.path.data",
            "        tags = form.tags.data.split(\",\") if form.tags.data != \"\" else []",
            "        tags = [tag.strip() for tag in tags]",
            "        note = DataObj(title=form.title.data, path=path, tags=tags, type=\"note\")",
            "        note_id = note.insert()",
            "        if note_id:",
            "            flash(\"Note Saved!\", \"success\")",
            "            return redirect(f\"/dataobj/{note_id}\")",
            "    path = request.args.get(\"path\", default_dir).strip(\"/\")",
            "    # handle empty argument",
            "    form.path.data = path",
            "    return render_template(\"/dataobjs/new.html\", title=\"New Note\", form=form)",
            "",
            "",
            "@app.route(\"/tags\")",
            "def show_all_tags():",
            "    if not app.config[\"SEARCH_CONF\"][\"engine\"] == \"ripgrep\" and not which(\"rg\"):",
            "        flash(\"Ripgrep must be installed to view pages about embedded tags.\", \"error\")",
            "        return redirect(\"/\")",
            "    tags = sorted(get_all_tags(force=True))",
            "    return render_template(\"tags/all.html\", title=\"All Tags\", tags=tags)",
            "",
            "",
            "@app.route(\"/tags/<tag_name>\")",
            "def show_tag(tag_name):",
            "    if not app.config[\"SEARCH_CONF\"][\"enabled\"] and not which(\"rg\"):",
            "        flash(",
            "            \"Search (for example ripgrep) must be installed to view pages about embedded tags.\",",
            "            \"error\",",
            "        )",
            "        return redirect(\"/\")",
            "",
            "    results = search(f\"#{tag_name}#\", strict=True)",
            "    res_ids = set(",
            "        [item[\"id\"] for item in results]",
            "    )  # avoid duplication of results between context-aware embedded tags and metadata ones",
            "    for res in search_frontmatter_tags(tag_name):",
            "        if res[\"id\"] not in res_ids:",
            "            results.append(res)",
            "",
            "    return render_template(",
            "        \"tags/show.html\",",
            "        title=f\"Tags - {tag_name}\",",
            "        tag_name=tag_name,",
            "        search_result=results,",
            "    )",
            "",
            "",
            "@app.route(\"/dataobj/<int:dataobj_id>\")",
            "def show_dataobj(dataobj_id):",
            "    dataobj = data.get_item(dataobj_id)",
            "    get_title_id_pairs = lambda x: (x[\"title\"], x[\"id\"])",
            "    titles = list(",
            "        map(get_title_id_pairs, data.get_items(structured=False, load_content=False))",
            "    )",
            "",
            "    if not dataobj:",
            "        flash(\"Data could not be found!\", \"error\")",
            "        return redirect(\"/\")",
            "",
            "    if request.args.get(\"raw\") == \"1\":",
            "        return frontmatter.dumps(dataobj)",
            "",
            "    backlinks = []",
            "    if app.config[\"SEARCH_CONF\"][\"enabled\"]:",
            "        if app.config[\"SEARCH_CONF\"][\"engine\"] == \"ripgrep\":",
            "            query = f\"\\|{dataobj_id}]]\"",
            "        else:",
            "            query = f\"|{dataobj_id})]]\"",
            "        backlinks = search(query, strict=True)",
            "",
            "    # Form for moving data into another folder",
            "    move_form = forms.MoveItemForm()",
            "    move_form.path.choices = [(\"\", \"root directory\")] + [",
            "        (pathname, pathname) for pathname in data.get_dirs()",
            "    ]",
            "",
            "    post_title_form = forms.TitleForm()",
            "    post_title_form.title.data = dataobj[\"title\"]",
            "",
            "    # Get all tags",
            "    tag_list = get_all_tags()",
            "    # and the ones present in this dataobj",
            "    embedded_tags = set()",
            "    PATTERN = r\"(?:^|\\n| )#(?:[-_a-zA-Z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u00ff0-9]+)#\"",
            "    for match in re.finditer(PATTERN, dataobj.content):",
            "        embedded_tags.add(match.group(0).replace(\"#\", \"\").lstrip())",
            "",
            "    return render_template(",
            "        \"dataobjs/show.html\",",
            "        title=dataobj[\"title\"],",
            "        dataobj=dataobj,",
            "        backlinks=backlinks,",
            "        current_path=dataobj[\"dir\"],",
            "        form=forms.DeleteDataForm(),",
            "        view_only=0,",
            "        search_enabled=app.config[\"SEARCH_CONF\"][\"enabled\"],",
            "        post_title_form=post_title_form,",
            "        move_form=move_form,",
            "        tag_list=tag_list,",
            "        embedded_tags=embedded_tags,",
            "        titles=titles,",
            "    )",
            "",
            "",
            "@app.route(\"/dataobj/move/<int:dataobj_id>\", methods=[\"POST\"])",
            "def move_item(dataobj_id):",
            "    form = forms.MoveItemForm()",
            "    out_dir = form.path.data if form.path.data != \"\" else \"root directory\"",
            "    if form.path.data == None:",
            "        flash(\"No path specified.\")",
            "        return redirect(f\"/dataobj/{dataobj_id}\")",
            "    try:",
            "        if data.move_item(dataobj_id, form.path.data):",
            "            flash(f\"Data successfully moved to {out_dir}.\", \"success\")",
            "            return redirect(f\"/dataobj/{dataobj_id}\")",
            "        else:",
            "            flash(f\"Data could not be moved to {out_dir}.\", \"error\")",
            "            return redirect(f\"/dataobj/{dataobj_id}\")",
            "    except FileNotFoundError:",
            "        flash(\"Data not found.\", \"error\")",
            "        return redirect(\"/\")",
            "    except FileExistsError:",
            "        flash(\"Data already in target directory.\", \"error\")",
            "        return redirect(f\"/dataobj/{dataobj_id}\")",
            "",
            "",
            "@app.route(\"/dataobj/delete/<int:dataobj_id>\", methods=[\"POST\"])",
            "def delete_data(dataobj_id):",
            "    try:",
            "        data.delete_item(dataobj_id)",
            "    except BaseException:",
            "        flash(\"Data could not be found!\", \"error\")",
            "        return redirect(\"/\")",
            "    flash(\"Data deleted!\", \"success\")",
            "    return redirect(\"/\")",
            "",
            "",
            "@app.route(\"/login\", methods=[\"GET\", \"POST\"])",
            "def login():",
            "    form = forms.UserForm()",
            "    if form.validate_on_submit():",
            "        db = get_db()",
            "        user = db.search(",
            "            (Query().username == form.username.data) & (Query().type == \"user\")",
            "        )",
            "",
            "        if user and check_password_hash(user[0][\"hashed_password\"], form.password.data):",
            "            user = User.from_db(user[0])",
            "            login_user(user, remember=True)",
            "            flash(\"Login successful!\", \"success\")",
            "",
            "            next_url = request.args.get(\"next\")",
            "            if next_url and is_safe_redirect_url(next_url):",
            "                return redirect(next_url)",
            "            else:",
            "                return redirect(\"/\")",
            "",
            "        flash(\"Invalid credentials\", \"error\")",
            "        return redirect(\"/login\")",
            "    return render_template(\"users/login.html\", form=form, title=\"Login\")",
            "",
            "",
            "@app.route(\"/logout\", methods=[\"DELETE\", \"GET\"])",
            "def logout():",
            "    logout_user()",
            "    flash(\"Logged out successfully\", \"success\")",
            "    return redirect(\"/\")",
            "",
            "",
            "@app.route(\"/user/edit\", methods=[\"GET\", \"POST\"])",
            "def edit_user():",
            "    form = forms.UserForm()",
            "    if form.validate_on_submit():",
            "        db = get_db()",
            "        db.update(",
            "            {",
            "                \"username\": form.username.data,",
            "                \"hashed_password\": generate_password_hash(form.password.data),",
            "            },",
            "            doc_ids=[current_user.id],",
            "        )",
            "        flash(\"Information saved!\", \"success\")",
            "        return redirect(\"/\")",
            "    form.username.data = current_user.username",
            "    return render_template(\"users/edit.html\", form=form, title=\"Edit Profile\")",
            "",
            "",
            "@app.route(\"/folders/create\", methods=[\"POST\"])",
            "def create_folder():",
            "    form = forms.NewFolderForm()",
            "    if form.validate_on_submit():",
            "        path = Path(form.parent_dir.data.strip(\"/\")) / form.new_dir.data",
            "        new_path = data.create_dir(str(path))",
            "        flash(\"Folder successfully created.\", \"success\")",
            "        return redirect(f\"/?path={new_path}\")",
            "    flash(\"Could not create folder.\", \"error\")",
            "    return redirect(request.referrer or \"/\")",
            "",
            "",
            "@app.route(\"/folders/delete\", methods=[\"POST\"])",
            "def delete_folder():",
            "    form = forms.DeleteFolderForm()",
            "    if form.validate_on_submit():",
            "        if data.delete_dir(form.dir_name.data):",
            "            flash(\"Folder successfully deleted.\", \"success\")",
            "            return redirect(\"/\")",
            "        else:",
            "            flash(\"Folder not found.\", \"error\")",
            "            return redirect(request.referrer or \"/\", 404)",
            "    flash(\"Could not delete folder.\", \"error\")",
            "    return redirect(request.referrer or \"/\")",
            "",
            "",
            "@app.route(\"/folders/rename\", methods=[\"POST\"])",
            "def rename_folder():",
            "    form = forms.RenameDirectoryForm()",
            "    if form.validate_on_submit():",
            "        try:",
            "            new_path = data.rename_folder(form.current_path.data, form.new_name.data)",
            "            if not new_path:",
            "                flash(\"Invalid input.\", \"error\")",
            "            else:",
            "                flash(\"Renamed successfully.\", \"success\")",
            "                return redirect(f\"/?path={new_path}\")",
            "        except FileNotFoundError:",
            "            flash(\"Directory not found.\", \"error\")",
            "        except FileExistsError:",
            "            flash(\"Target directory exists.\", \"error\")",
            "    return redirect(\"/\")",
            "",
            "",
            "@app.route(\"/bookmarklet\")",
            "def bookmarklet():",
            "    return render_template(\"bookmarklet.html\", title=\"Bookmarklet\")",
            "",
            "",
            "@app.route(\"/images/<filename>\")",
            "def serve_image(filename):",
            "    if filename and data.valid_image_filename(filename):",
            "        image_path = data.image_exists(filename)",
            "        if image_path:",
            "            return send_file(image_path)",
            "        else:",
            "            return \"Image not found\", 404",
            "    else:",
            "        return \"Invalid file request\", 413",
            "",
            "",
            "@app.route(\"/static/custom.css\")",
            "def custom_css():",
            "    if not app.config[\"THEME_CONF\"].get(\"use_custom_css\", False):",
            "        return \"\"",
            "    return send_from_directory(",
            "        Path(app.config[\"USER_DIR\"]) / \"css\",",
            "        app.config[\"THEME_CONF\"][\"custom_css_file\"],",
            "    )",
            "",
            "",
            "@app.route(\"/config\", methods=[\"GET\", \"POST\"])",
            "def config():",
            "    \"\"\"",
            "    Web View to edit and update configuration.",
            "    \"\"\"",
            "",
            "    def update_config_value(key, val, dictionary):",
            "        if key != \"SECRET_KEY\":",
            "            if type(val) is dict:",
            "                for k, v in val.items():",
            "                    update_config_value(k, v, dictionary[key])",
            "            else:",
            "                dictionary[key] = val",
            "",
            "    form = forms.config_form(app.config)",
            "    default = vars(Config())",
            "    if form.validate_on_submit():",
            "        changed_config = Config()",
            "        changed_config.override(form.data)",
            "        for k, v in vars(changed_config).items():",
            "            # propagate changes to configuration",
            "            update_config_value(k, v, app.config)",
            "        write_config(vars(changed_config))  # save to filesystem config",
            "        flash(\"Config successfully updated.\", \"success\")",
            "    elif request.method == \"POST\":",
            "        flash(\"Could not update config.\", \"error\")",
            "    return render_template(",
            "        \"config.html\", conf=form, default=default, title=\"Edit Config\"",
            "    )",
            "",
            "",
            "@csrf.exempt  # exempt from CSRF to be able to submit info directly from bookmarklet",
            "@app.route(\"/save_from_bookmarklet\", methods=[\"POST\"])",
            "def save_raw_url():",
            "    \"\"\"",
            "    Used in the bookmarklet - Saves a URL by taking its raw HTML.",
            "",
            "    POST parameters:",
            "    - html",
            "    - url",
            "    \"\"\"",
            "    html = request.form.get(\"html\")",
            "    if not html:",
            "        return \"No HTML provided\", 400",
            "    bookmark = DataObj(url=request.form.get(\"url\"), type=\"bookmark\")",
            "    bookmark.process_bookmark_url(html)",
            "    if bookmark.insert():",
            "        return redirect(f\"/dataobj/{bookmark.id}\")",
            "    else:",
            "        return \"Could not save bookmark\", 500"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "22": [],
            "267": [
                "login"
            ]
        },
        "addLocation": []
    }
}