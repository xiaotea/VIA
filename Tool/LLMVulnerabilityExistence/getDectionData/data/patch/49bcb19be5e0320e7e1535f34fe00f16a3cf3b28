{
    "gerapy/server/core/views.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from pathlib import Path"
            },
            "1": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from urllib.parse import unquote"
            },
            "2": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import base64"
            },
            "3": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-import json, os, requests, time, pytz, pymongo"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+import json"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+import os"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+import requests"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+import time"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+import pytz"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+import pymongo"
            },
            "10": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from shutil import rmtree"
            },
            "11": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from requests.exceptions import ConnectionError"
            },
            "12": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from os.path import join, exists"
            },
            "13": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": 178,
                "PatchRowcode": "         client = Client.objects.get(id=client_id)"
            },
            "14": {
                "beforePatchRowNumber": 174,
                "afterPatchRowNumber": 179,
                "PatchRowcode": "         scrapyd = get_scrapyd(client)"
            },
            "15": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 180,
                "PatchRowcode": "         spiders = scrapyd.list_spiders(project_name)"
            },
            "16": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        spiders = [{'name': spider, 'id': index + 1} for index, spider in enumerate(spiders)]"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 181,
                "PatchRowcode": "+        spiders = [{'name': spider, 'id': index + 1}"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+                   for index, spider in enumerate(spiders)]"
            },
            "19": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": 183,
                "PatchRowcode": "         return JsonResponse(spiders)"
            },
            "20": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": 184,
                "PatchRowcode": " "
            },
            "21": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 185,
                "PatchRowcode": " "
            },
            "22": {
                "beforePatchRowNumber": 242,
                "afterPatchRowNumber": 248,
                "PatchRowcode": "     if request.method == 'GET':"
            },
            "23": {
                "beforePatchRowNumber": 243,
                "afterPatchRowNumber": 249,
                "PatchRowcode": "         project = Project.objects.get(name=project_name)"
            },
            "24": {
                "beforePatchRowNumber": 244,
                "afterPatchRowNumber": 250,
                "PatchRowcode": "         project = model_to_dict(project)"
            },
            "25": {
                "beforePatchRowNumber": 245,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        project['configuration'] = json.loads(project['configuration']) if project['configuration'] else None"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+        project['configuration'] = json.loads("
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+            project['configuration']) if project['configuration'] else None"
            },
            "28": {
                "beforePatchRowNumber": 246,
                "afterPatchRowNumber": 253,
                "PatchRowcode": "         return JsonResponse(project)"
            },
            "29": {
                "beforePatchRowNumber": 247,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    "
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 254,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": 255,
                "PatchRowcode": "     # update configuration"
            },
            "32": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": 256,
                "PatchRowcode": "     elif request.method == 'POST':"
            },
            "33": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": 257,
                "PatchRowcode": "         project = Project.objects.filter(name=project_name)"
            },
            "34": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": 258,
                "PatchRowcode": "         data = json.loads(request.body)"
            },
            "35": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        configuration = json.dumps(data.get('configuration'), ensure_ascii=False)"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 259,
                "PatchRowcode": "+        configuration = json.dumps("
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 260,
                "PatchRowcode": "+            data.get('configuration'), ensure_ascii=False)"
            },
            "38": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": 261,
                "PatchRowcode": "         project.update(**{'configuration': configuration})"
            },
            "39": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "40": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": 262,
                "PatchRowcode": "         # for safe protection"
            },
            "41": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        project_name = re.sub('[\\!\\@\\#\\$\\;\\&\\*\\~\\\"\\'\\{\\}\\]\\[\\-\\+\\%\\^]+', '', project_name)"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 263,
                "PatchRowcode": "+        project_name = re.sub("
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 264,
                "PatchRowcode": "+            '[\\s\\!\\@\\#\\$\\;\\&\\*\\~\\\"\\'\\{\\}\\]\\[\\-\\+\\%\\^]+', '', project_name)"
            },
            "44": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": 265,
                "PatchRowcode": "         # execute generate cmd"
            },
            "45": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cmd = ' '.join(['gerapy', 'generate', project_name])"
            },
            "46": {
                "beforePatchRowNumber": 259,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 266,
                "PatchRowcode": "+        cmd = ['gerapy', 'generate', project_name]"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 267,
                "PatchRowcode": "+        p = Popen(cmd, shell=False, stdin=PIPE, stdout=PIPE, stderr=PIPE)"
            },
            "49": {
                "beforePatchRowNumber": 260,
                "afterPatchRowNumber": 268,
                "PatchRowcode": "         stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())"
            },
            "50": {
                "beforePatchRowNumber": 261,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 269,
                "PatchRowcode": "+"
            },
            "52": {
                "beforePatchRowNumber": 262,
                "afterPatchRowNumber": 270,
                "PatchRowcode": "         if not stderr:"
            },
            "53": {
                "beforePatchRowNumber": 263,
                "afterPatchRowNumber": 271,
                "PatchRowcode": "             return JsonResponse({'status': '1'})"
            },
            "54": {
                "beforePatchRowNumber": 264,
                "afterPatchRowNumber": 272,
                "PatchRowcode": "         else:"
            },
            "55": {
                "beforePatchRowNumber": 294,
                "afterPatchRowNumber": 302,
                "PatchRowcode": "         data['configurable'] = 1"
            },
            "56": {
                "beforePatchRowNumber": 295,
                "afterPatchRowNumber": 303,
                "PatchRowcode": "         project, result = Project.objects.update_or_create(**data)"
            },
            "57": {
                "beforePatchRowNumber": 296,
                "afterPatchRowNumber": 304,
                "PatchRowcode": "         # generate a single project folder"
            },
            "58": {
                "beforePatchRowNumber": 297,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        path = join(os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER)), data['name'])"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 305,
                "PatchRowcode": "+        path = join(os.path.abspath("
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 306,
                "PatchRowcode": "+            join(os.getcwd(), PROJECTS_FOLDER)), data['name'])"
            },
            "61": {
                "beforePatchRowNumber": 298,
                "afterPatchRowNumber": 307,
                "PatchRowcode": "         os.mkdir(path)"
            },
            "62": {
                "beforePatchRowNumber": 299,
                "afterPatchRowNumber": 308,
                "PatchRowcode": "         return JsonResponse(model_to_dict(project))"
            },
            "63": {
                "beforePatchRowNumber": 300,
                "afterPatchRowNumber": 309,
                "PatchRowcode": " "
            },
            "64": {
                "beforePatchRowNumber": 334,
                "afterPatchRowNumber": 343,
                "PatchRowcode": "         if not address.startswith('http'):"
            },
            "65": {
                "beforePatchRowNumber": 335,
                "afterPatchRowNumber": 344,
                "PatchRowcode": "             return JsonResponse({'status': False})"
            },
            "66": {
                "beforePatchRowNumber": 336,
                "afterPatchRowNumber": 345,
                "PatchRowcode": "         address = address + '.git' if not address.endswith('.git') else address"
            },
            "67": {
                "beforePatchRowNumber": 337,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cmd = 'git clone {address} {target}'.format(address=address, target=join(PROJECTS_FOLDER, Path(address).stem))"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 346,
                "PatchRowcode": "+        cmd = ['git', 'clone', 'address', join(PROJECTS_FOLDER, Path(address).stem)]"
            },
            "69": {
                "beforePatchRowNumber": 338,
                "afterPatchRowNumber": 347,
                "PatchRowcode": "         logger.debug('clone cmd %s', cmd)"
            },
            "70": {
                "beforePatchRowNumber": 339,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 348,
                "PatchRowcode": "+        p = Popen(cmd, shell=False, stdin=PIPE, stdout=PIPE, stderr=PIPE)"
            },
            "72": {
                "beforePatchRowNumber": 340,
                "afterPatchRowNumber": 349,
                "PatchRowcode": "         stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())"
            },
            "73": {
                "beforePatchRowNumber": 341,
                "afterPatchRowNumber": 350,
                "PatchRowcode": "         logger.debug('clone run result %s', stdout)"
            },
            "74": {
                "beforePatchRowNumber": 342,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if stderr: logger.error(stderr)"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 351,
                "PatchRowcode": "+        if stderr:"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 352,
                "PatchRowcode": "+            logger.error(stderr)"
            },
            "77": {
                "beforePatchRowNumber": 343,
                "afterPatchRowNumber": 353,
                "PatchRowcode": "         return JsonResponse({'status': True}) if not stderr else JsonResponse({'status': False})"
            },
            "78": {
                "beforePatchRowNumber": 344,
                "afterPatchRowNumber": 354,
                "PatchRowcode": " "
            },
            "79": {
                "beforePatchRowNumber": 345,
                "afterPatchRowNumber": 355,
                "PatchRowcode": " "
            },
            "80": {
                "beforePatchRowNumber": 393,
                "afterPatchRowNumber": 403,
                "PatchRowcode": "                 return JsonResponse({'message': 'Connect Error'}, status=500)"
            },
            "81": {
                "beforePatchRowNumber": 394,
                "afterPatchRowNumber": 404,
                "PatchRowcode": "             if len(versions) > 0:"
            },
            "82": {
                "beforePatchRowNumber": 395,
                "afterPatchRowNumber": 405,
                "PatchRowcode": "                 version = versions[-1]"
            },
            "83": {
                "beforePatchRowNumber": 396,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                deployed_at = timezone.datetime.fromtimestamp(int(version), tz=pytz.timezone(TIME_ZONE))"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 406,
                "PatchRowcode": "+                deployed_at = timezone.datetime.fromtimestamp("
            },
            "85": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 407,
                "PatchRowcode": "+                    int(version), tz=pytz.timezone(TIME_ZONE))"
            },
            "86": {
                "beforePatchRowNumber": 397,
                "afterPatchRowNumber": 408,
                "PatchRowcode": "             else:"
            },
            "87": {
                "beforePatchRowNumber": 398,
                "afterPatchRowNumber": 409,
                "PatchRowcode": "                 deployed_at = None"
            },
            "88": {
                "beforePatchRowNumber": 399,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at)"
            },
            "89": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 410,
                "PatchRowcode": "+            deploy, result = Deploy.objects.update_or_create("
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 411,
                "PatchRowcode": "+                client=client, project=project, deployed_at=deployed_at)"
            },
            "91": {
                "beforePatchRowNumber": 400,
                "afterPatchRowNumber": 412,
                "PatchRowcode": "         # return deploy json info"
            },
            "92": {
                "beforePatchRowNumber": 401,
                "afterPatchRowNumber": 413,
                "PatchRowcode": "         return JsonResponse(model_to_dict(deploy))"
            },
            "93": {
                "beforePatchRowNumber": 402,
                "afterPatchRowNumber": 414,
                "PatchRowcode": " "
            },
            "94": {
                "beforePatchRowNumber": 446,
                "afterPatchRowNumber": 458,
                "PatchRowcode": "     # get project folder"
            },
            "95": {
                "beforePatchRowNumber": 447,
                "afterPatchRowNumber": 459,
                "PatchRowcode": "     path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))"
            },
            "96": {
                "beforePatchRowNumber": 448,
                "afterPatchRowNumber": 460,
                "PatchRowcode": "     project_path = join(path, project_name)"
            },
            "97": {
                "beforePatchRowNumber": 449,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    "
            },
            "98": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 461,
                "PatchRowcode": "+"
            },
            "99": {
                "beforePatchRowNumber": 450,
                "afterPatchRowNumber": 462,
                "PatchRowcode": "     # get build version"
            },
            "100": {
                "beforePatchRowNumber": 451,
                "afterPatchRowNumber": 463,
                "PatchRowcode": "     if request.method == 'GET':"
            },
            "101": {
                "beforePatchRowNumber": 452,
                "afterPatchRowNumber": 464,
                "PatchRowcode": "         egg = find_egg(project_path)"
            },
            "102": {
                "beforePatchRowNumber": 470,
                "afterPatchRowNumber": 482,
                "PatchRowcode": "         # transfer model to dict then dumps it to json"
            },
            "103": {
                "beforePatchRowNumber": 471,
                "afterPatchRowNumber": 483,
                "PatchRowcode": "         data = model_to_dict(model)"
            },
            "104": {
                "beforePatchRowNumber": 472,
                "afterPatchRowNumber": 484,
                "PatchRowcode": "         return JsonResponse(data)"
            },
            "105": {
                "beforePatchRowNumber": 473,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    "
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 485,
                "PatchRowcode": "+"
            },
            "107": {
                "beforePatchRowNumber": 474,
                "afterPatchRowNumber": 486,
                "PatchRowcode": "     # build operation manually by clicking button"
            },
            "108": {
                "beforePatchRowNumber": 475,
                "afterPatchRowNumber": 487,
                "PatchRowcode": "     elif request.method == 'POST':"
            },
            "109": {
                "beforePatchRowNumber": 476,
                "afterPatchRowNumber": 488,
                "PatchRowcode": "         data = json.loads(request.body)"
            },
            "110": {
                "beforePatchRowNumber": 483,
                "afterPatchRowNumber": 495,
                "PatchRowcode": "         built_at = timezone.now()"
            },
            "111": {
                "beforePatchRowNumber": 484,
                "afterPatchRowNumber": 496,
                "PatchRowcode": "         # if project does not exists in db, create it"
            },
            "112": {
                "beforePatchRowNumber": 485,
                "afterPatchRowNumber": 497,
                "PatchRowcode": "         if not Project.objects.filter(name=project_name):"
            },
            "113": {
                "beforePatchRowNumber": 486,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            Project(name=project_name, description=description, built_at=built_at, egg=egg).save()"
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 498,
                "PatchRowcode": "+            Project(name=project_name, description=description,"
            },
            "115": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 499,
                "PatchRowcode": "+                    built_at=built_at, egg=egg).save()"
            },
            "116": {
                "beforePatchRowNumber": 487,
                "afterPatchRowNumber": 500,
                "PatchRowcode": "             model = Project.objects.get(name=project_name)"
            },
            "117": {
                "beforePatchRowNumber": 488,
                "afterPatchRowNumber": 501,
                "PatchRowcode": "         # if project exists, update egg, description, built_at info"
            },
            "118": {
                "beforePatchRowNumber": 489,
                "afterPatchRowNumber": 502,
                "PatchRowcode": "         else:"
            },
            "119": {
                "beforePatchRowNumber": 526,
                "afterPatchRowNumber": 539,
                "PatchRowcode": "         body = data.get('body', '')"
            },
            "120": {
                "beforePatchRowNumber": 527,
                "afterPatchRowNumber": 540,
                "PatchRowcode": "         if args.get('method').lower() != 'get':"
            },
            "121": {
                "beforePatchRowNumber": 528,
                "afterPatchRowNumber": 541,
                "PatchRowcode": "             args['body'] = \"'\" + json.dumps(body, ensure_ascii=False) + \"'\""
            },
            "122": {
                "beforePatchRowNumber": 529,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "123": {
                "beforePatchRowNumber": 530,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        args_cmd = ' '.join("
            },
            "124": {
                "beforePatchRowNumber": 531,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            ['--{arg} {value}'.format(arg=arg, value=value) for arg, value in args.items()])"
            },
            "125": {
                "beforePatchRowNumber": 532,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        logger.debug('args cmd %s', args_cmd)"
            },
            "126": {
                "beforePatchRowNumber": 533,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cmd = 'gerapy parse {args_cmd} {project_path} {spider_name}'.format("
            },
            "127": {
                "beforePatchRowNumber": 534,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            args_cmd=args_cmd,"
            },
            "128": {
                "beforePatchRowNumber": 535,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            project_path=project_path,"
            },
            "129": {
                "beforePatchRowNumber": 536,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            spider_name=spider_name"
            },
            "130": {
                "beforePatchRowNumber": 537,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        )"
            },
            "131": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 542,
                "PatchRowcode": "+"
            },
            "132": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 543,
                "PatchRowcode": "+        args_array = []"
            },
            "133": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 544,
                "PatchRowcode": "+        for arg, value in args.items():"
            },
            "134": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 545,
                "PatchRowcode": "+            args_array.append(f'--{arg}')"
            },
            "135": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 546,
                "PatchRowcode": "+            args_array.append(f'{value}')"
            },
            "136": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 547,
                "PatchRowcode": "+        cmd = ['gerapy', 'parse'] + args_array + [project_path] + [spider_name]"
            },
            "137": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 548,
                "PatchRowcode": "+        print('cmd', cmd)"
            },
            "138": {
                "beforePatchRowNumber": 538,
                "afterPatchRowNumber": 549,
                "PatchRowcode": "         logger.debug('parse cmd %s', cmd)"
            },
            "139": {
                "beforePatchRowNumber": 539,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE, close_fds=True)"
            },
            "140": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 550,
                "PatchRowcode": "+        p = Popen(cmd, shell=False, stdin=PIPE,"
            },
            "141": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 551,
                "PatchRowcode": "+                         stdout=PIPE, stderr=PIPE, close_fds=True)"
            },
            "142": {
                "beforePatchRowNumber": 540,
                "afterPatchRowNumber": 552,
                "PatchRowcode": "         stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())"
            },
            "143": {
                "beforePatchRowNumber": 541,
                "afterPatchRowNumber": 553,
                "PatchRowcode": "         logger.debug('stdout %s, stderr %s', stdout, stderr)"
            },
            "144": {
                "beforePatchRowNumber": 542,
                "afterPatchRowNumber": 554,
                "PatchRowcode": "         if not stderr:"
            },
            "145": {
                "beforePatchRowNumber": 645,
                "afterPatchRowNumber": 657,
                "PatchRowcode": "                 job['status'] = status"
            },
            "146": {
                "beforePatchRowNumber": 646,
                "afterPatchRowNumber": 658,
                "PatchRowcode": "                 jobs.append(job)"
            },
            "147": {
                "beforePatchRowNumber": 647,
                "afterPatchRowNumber": 659,
                "PatchRowcode": "         return JsonResponse(jobs)"
            },
            "148": {
                "beforePatchRowNumber": 648,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    "
            },
            "149": {
                "beforePatchRowNumber": 649,
                "afterPatchRowNumber": 660,
                "PatchRowcode": " "
            },
            "150": {
                "beforePatchRowNumber": 650,
                "afterPatchRowNumber": 661,
                "PatchRowcode": " "
            },
            "151": {
                "beforePatchRowNumber": 651,
                "afterPatchRowNumber": 662,
                "PatchRowcode": " @api_view(['GET'])"
            },
            "152": {
                "beforePatchRowNumber": 663,
                "afterPatchRowNumber": 674,
                "PatchRowcode": "     if request.method == 'GET':"
            },
            "153": {
                "beforePatchRowNumber": 664,
                "afterPatchRowNumber": 675,
                "PatchRowcode": "         client = Client.objects.get(id=client_id)"
            },
            "154": {
                "beforePatchRowNumber": 665,
                "afterPatchRowNumber": 676,
                "PatchRowcode": "         # get log url"
            },
            "155": {
                "beforePatchRowNumber": 666,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        url = log_url(client.ip, client.port, project_name, spider_name, job_id)"
            },
            "156": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 677,
                "PatchRowcode": "+        url = log_url(client.ip, client.port,"
            },
            "157": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 678,
                "PatchRowcode": "+                      project_name, spider_name, job_id)"
            },
            "158": {
                "beforePatchRowNumber": 667,
                "afterPatchRowNumber": 679,
                "PatchRowcode": "         # get last 1000 bytes of log"
            },
            "159": {
                "beforePatchRowNumber": 668,
                "afterPatchRowNumber": 680,
                "PatchRowcode": "         response = requests.get(url, timeout=5, headers={"
            },
            "160": {
                "beforePatchRowNumber": 669,
                "afterPatchRowNumber": 681,
                "PatchRowcode": "             'Range': 'bytes=-1000'"
            },
            "161": {
                "beforePatchRowNumber": 765,
                "afterPatchRowNumber": 777,
                "PatchRowcode": "     if request.method == 'POST':"
            },
            "162": {
                "beforePatchRowNumber": 766,
                "afterPatchRowNumber": 778,
                "PatchRowcode": "         data = json.loads(request.body)"
            },
            "163": {
                "beforePatchRowNumber": 767,
                "afterPatchRowNumber": 779,
                "PatchRowcode": "         data = data['form']"
            },
            "164": {
                "beforePatchRowNumber": 768,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        data['configuration'] = json.dumps(data['configuration'], ensure_ascii=False)"
            },
            "165": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 780,
                "PatchRowcode": "+        data['configuration'] = json.dumps("
            },
            "166": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 781,
                "PatchRowcode": "+            data['configuration'], ensure_ascii=False)"
            },
            "167": {
                "beforePatchRowNumber": 769,
                "afterPatchRowNumber": 782,
                "PatchRowcode": "         monitor = Monitor.objects.create(**data)"
            },
            "168": {
                "beforePatchRowNumber": 770,
                "afterPatchRowNumber": 783,
                "PatchRowcode": "         return JsonResponse(model_to_dict(monitor))"
            },
            "169": {
                "beforePatchRowNumber": 771,
                "afterPatchRowNumber": 784,
                "PatchRowcode": " "
            },
            "170": {
                "beforePatchRowNumber": 785,
                "afterPatchRowNumber": 798,
                "PatchRowcode": "                                    name=data.get('name'),"
            },
            "171": {
                "beforePatchRowNumber": 786,
                "afterPatchRowNumber": 799,
                "PatchRowcode": "                                    spider=data.get('spider'),"
            },
            "172": {
                "beforePatchRowNumber": 787,
                "afterPatchRowNumber": 800,
                "PatchRowcode": "                                    trigger=data.get('trigger'),"
            },
            "173": {
                "beforePatchRowNumber": 788,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                                   configuration=json.dumps(data.get('configuration'), ensure_ascii=False),"
            },
            "174": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 801,
                "PatchRowcode": "+                                   configuration=json.dumps("
            },
            "175": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 802,
                "PatchRowcode": "+                                       data.get('configuration'), ensure_ascii=False),"
            },
            "176": {
                "beforePatchRowNumber": 789,
                "afterPatchRowNumber": 803,
                "PatchRowcode": "                                    modified=1)"
            },
            "177": {
                "beforePatchRowNumber": 790,
                "afterPatchRowNumber": 804,
                "PatchRowcode": "         return JsonResponse({'result': '1', 'data': model_to_dict(task)})"
            },
            "178": {
                "beforePatchRowNumber": 791,
                "afterPatchRowNumber": 805,
                "PatchRowcode": " "
            },
            "179": {
                "beforePatchRowNumber": 803,
                "afterPatchRowNumber": 817,
                "PatchRowcode": "         task = Task.objects.filter(id=task_id)"
            },
            "180": {
                "beforePatchRowNumber": 804,
                "afterPatchRowNumber": 818,
                "PatchRowcode": "         data = json.loads(request.body)"
            },
            "181": {
                "beforePatchRowNumber": 805,
                "afterPatchRowNumber": 819,
                "PatchRowcode": "         data['clients'] = json.dumps(data.get('clients'), ensure_ascii=False)"
            },
            "182": {
                "beforePatchRowNumber": 806,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        data['configuration'] = json.dumps(data.get('configuration'), ensure_ascii=False)"
            },
            "183": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 820,
                "PatchRowcode": "+        data['configuration'] = json.dumps("
            },
            "184": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 821,
                "PatchRowcode": "+            data.get('configuration'), ensure_ascii=False)"
            },
            "185": {
                "beforePatchRowNumber": 807,
                "afterPatchRowNumber": 822,
                "PatchRowcode": "         data['modified'] = 1"
            },
            "186": {
                "beforePatchRowNumber": 808,
                "afterPatchRowNumber": 823,
                "PatchRowcode": "         task.update(**data)"
            },
            "187": {
                "beforePatchRowNumber": 809,
                "afterPatchRowNumber": 824,
                "PatchRowcode": "         return JsonResponse(model_to_dict(Task.objects.get(id=task_id)))"
            },
            "188": {
                "beforePatchRowNumber": 823,
                "afterPatchRowNumber": 838,
                "PatchRowcode": "         clients = clients_of_task(task)"
            },
            "189": {
                "beforePatchRowNumber": 824,
                "afterPatchRowNumber": 839,
                "PatchRowcode": "         for client in clients:"
            },
            "190": {
                "beforePatchRowNumber": 825,
                "afterPatchRowNumber": 840,
                "PatchRowcode": "             job_id = get_job_id(client, task)"
            },
            "191": {
                "beforePatchRowNumber": 826,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            DjangoJob.objects.filter(name=job_id).delete()"
            },
            "192": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 841,
                "PatchRowcode": "+            DjangoJob.objects.filter(id=job_id).delete()"
            },
            "193": {
                "beforePatchRowNumber": 827,
                "afterPatchRowNumber": 842,
                "PatchRowcode": "         # delete task"
            },
            "194": {
                "beforePatchRowNumber": 828,
                "afterPatchRowNumber": 843,
                "PatchRowcode": "         Task.objects.filter(id=task_id).delete()"
            },
            "195": {
                "beforePatchRowNumber": 829,
                "afterPatchRowNumber": 844,
                "PatchRowcode": "         return JsonResponse({'result': '1'})"
            },
            "196": {
                "beforePatchRowNumber": 830,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    "
            },
            "197": {
                "beforePatchRowNumber": 831,
                "afterPatchRowNumber": 845,
                "PatchRowcode": " "
            },
            "198": {
                "beforePatchRowNumber": 832,
                "afterPatchRowNumber": 846,
                "PatchRowcode": " "
            },
            "199": {
                "beforePatchRowNumber": 833,
                "afterPatchRowNumber": 847,
                "PatchRowcode": " @api_view(['GET'])"
            },
            "200": {
                "beforePatchRowNumber": 875,
                "afterPatchRowNumber": 889,
                "PatchRowcode": "         clients = clients_of_task(task)"
            },
            "201": {
                "beforePatchRowNumber": 876,
                "afterPatchRowNumber": 890,
                "PatchRowcode": "         for client in clients:"
            },
            "202": {
                "beforePatchRowNumber": 877,
                "afterPatchRowNumber": 891,
                "PatchRowcode": "             job_id = get_job_id(client, task)"
            },
            "203": {
                "beforePatchRowNumber": 878,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            jobs = DjangoJob.objects.filter(name=job_id)"
            },
            "204": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 892,
                "PatchRowcode": "+            jobs = DjangoJob.objects.filter(id=job_id)"
            },
            "205": {
                "beforePatchRowNumber": 879,
                "afterPatchRowNumber": 893,
                "PatchRowcode": "             logger.debug('jobs from djangojob %s', jobs)"
            },
            "206": {
                "beforePatchRowNumber": 880,
                "afterPatchRowNumber": 894,
                "PatchRowcode": "             # if job does not exist, for date mode exceed time"
            },
            "207": {
                "beforePatchRowNumber": 881,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if not jobs: continue"
            },
            "208": {
                "beforePatchRowNumber": 882,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            job = DjangoJob.objects.get(name=job_id)"
            },
            "209": {
                "beforePatchRowNumber": 883,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            executions = serialize('json', DjangoJobExecution.objects.filter(job=job))"
            },
            "210": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 895,
                "PatchRowcode": "+            if not jobs:"
            },
            "211": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 896,
                "PatchRowcode": "+                continue"
            },
            "212": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 897,
                "PatchRowcode": "+            job = DjangoJob.objects.get(id=job_id)"
            },
            "213": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 898,
                "PatchRowcode": "+            executions = serialize("
            },
            "214": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 899,
                "PatchRowcode": "+                'json', DjangoJobExecution.objects.filter(job=job))"
            },
            "215": {
                "beforePatchRowNumber": 884,
                "afterPatchRowNumber": 900,
                "PatchRowcode": "             result.append({"
            },
            "216": {
                "beforePatchRowNumber": 885,
                "afterPatchRowNumber": 901,
                "PatchRowcode": "                 'client': model_to_dict(client),"
            },
            "217": {
                "beforePatchRowNumber": 886,
                "afterPatchRowNumber": 902,
                "PatchRowcode": "                 'next': job.next_run_time,"
            }
        },
        "frontPatchFile": [
            "import re",
            "from pathlib import Path",
            "from urllib.parse import unquote",
            "import base64",
            "import json, os, requests, time, pytz, pymongo",
            "from shutil import rmtree",
            "from requests.exceptions import ConnectionError",
            "from os.path import join, exists",
            "from django.shortcuts import render",
            "from django.core.serializers import serialize",
            "from django.http import HttpResponse",
            "from django.forms.models import model_to_dict",
            "from django.utils import timezone",
            "from rest_framework.decorators import api_view, permission_classes",
            "from rest_framework.permissions import IsAuthenticated",
            "from subprocess import Popen, PIPE",
            "from gerapy import get_logger",
            "from gerapy.server.core.response import JsonResponse",
            "from gerapy.cmd.init import PROJECTS_FOLDER",
            "from gerapy.server.server.settings import TIME_ZONE",
            "from gerapy.server.core.models import Client, Project, Deploy, Monitor, Task",
            "from gerapy.server.core.build import build_project, find_egg",
            "from gerapy.server.core.utils import IGNORES, scrapyd_url, log_url, get_tree, get_scrapyd, process_html, bytes2str, \\",
            "    clients_of_task, get_job_id",
            "from django_apscheduler.models import DjangoJob, DjangoJobExecution",
            "from django.core.files.storage import FileSystemStorage",
            "import zipfile",
            "",
            "logger = get_logger(__name__)",
            "",
            "",
            "@api_view(['GET'])",
            "# @permission_classes([IsAuthenticated])",
            "def index(request):",
            "    \"\"\"",
            "    render index page",
            "    :param request: request object",
            "    :return: page",
            "    \"\"\"",
            "    return render(request, 'index.html')",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def index_status(request):",
            "    \"\"\"",
            "    index statistics",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        clients = Client.objects.all()",
            "        data = {",
            "            'success': 0,",
            "            'error': 0,",
            "            'project': 0,",
            "        }",
            "        # clients info",
            "        for client in clients:",
            "            try:",
            "                requests.get(scrapyd_url(client.ip, client.port), timeout=1)",
            "                data['success'] += 1",
            "            except ConnectionError:",
            "                data['error'] += 1",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        files = os.listdir(path)",
            "        # projects info",
            "        for file in files:",
            "            if os.path.isdir(join(path, file)) and not file in IGNORES:",
            "                data['project'] += 1",
            "        return JsonResponse(data)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def client_index(request):",
            "    \"\"\"",
            "    get client list",
            "    :param request: request object",
            "    :return: client list",
            "    \"\"\"",
            "    return HttpResponse(serialize('json', Client.objects.order_by('-id')))",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def client_info(request, client_id):",
            "    \"\"\"",
            "    get client info",
            "    :param request: request object",
            "    :param id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def client_status(request, client_id):",
            "    \"\"\"",
            "    get client status",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        # get client object",
            "        client = Client.objects.get(id=client_id)",
            "        requests.get(scrapyd_url(client.ip, client.port), timeout=3)",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def client_update(request, client_id):",
            "    \"\"\"",
            "    update client info",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        client = Client.objects.filter(id=client_id)",
            "        data = json.loads(request.body)",
            "        client.update(**data)",
            "        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def client_create(request):",
            "    \"\"\"",
            "    create a client",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        client = Client.objects.create(**data)",
            "        return JsonResponse(model_to_dict(client))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def client_remove(request, client_id):",
            "    \"\"\"",
            "    remove a client",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        client = Client.objects.get(id=client_id)",
            "        # delete deploy",
            "        Deploy.objects.filter(client=client).delete()",
            "        # delete client",
            "        Client.objects.filter(id=client_id).delete()",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def spider_list(request, client_id, project_name):",
            "    \"\"\"",
            "    get spider list from one client",
            "    :param request: request Object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        spiders = scrapyd.list_spiders(project_name)",
            "        spiders = [{'name': spider, 'id': index + 1} for index, spider in enumerate(spiders)]",
            "        return JsonResponse(spiders)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def spider_start(request, client_id, project_name, spider_name):",
            "    \"\"\"",
            "    start a spider",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :param spider_name: spider name",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        job = scrapyd.schedule(project_name, spider_name)",
            "        return JsonResponse({'job': job})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_list(request, client_id):",
            "    \"\"\"",
            "    project deployed list on one client",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        projects = scrapyd.list_projects()",
            "        return JsonResponse(projects)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_index(request):",
            "    \"\"\"",
            "    project index list",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        files = os.listdir(path)",
            "        project_list = []",
            "        for file in files:",
            "            if os.path.isdir(join(path, file)) and not file in IGNORES:",
            "                project_list.append({'name': file})",
            "        return JsonResponse(project_list)",
            "",
            "",
            "@api_view(['GET', 'POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_configure(request, project_name):",
            "    \"\"\"",
            "    get configuration",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: json",
            "    \"\"\"",
            "    # get configuration",
            "    if request.method == 'GET':",
            "        project = Project.objects.get(name=project_name)",
            "        project = model_to_dict(project)",
            "        project['configuration'] = json.loads(project['configuration']) if project['configuration'] else None",
            "        return JsonResponse(project)",
            "    ",
            "    # update configuration",
            "    elif request.method == 'POST':",
            "        project = Project.objects.filter(name=project_name)",
            "        data = json.loads(request.body)",
            "        configuration = json.dumps(data.get('configuration'), ensure_ascii=False)",
            "        project.update(**{'configuration': configuration})",
            "        ",
            "        # for safe protection",
            "        project_name = re.sub('[\\!\\@\\#\\$\\;\\&\\*\\~\\\"\\'\\{\\}\\]\\[\\-\\+\\%\\^]+', '', project_name)",
            "        # execute generate cmd",
            "        cmd = ' '.join(['gerapy', 'generate', project_name])",
            "        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)",
            "        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())",
            "        ",
            "        if not stderr:",
            "            return JsonResponse({'status': '1'})",
            "        else:",
            "            return JsonResponse({'status': '0', 'message': stderr})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_tree(request, project_name):",
            "    \"\"\"",
            "    get file tree of project",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: json of tree",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        # get tree data",
            "        tree = get_tree(join(path, project_name))",
            "        return JsonResponse(tree)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_create(request):",
            "    \"\"\"",
            "    create a configurable project",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        data['configurable'] = 1",
            "        project, result = Project.objects.update_or_create(**data)",
            "        # generate a single project folder",
            "        path = join(os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER)), data['name'])",
            "        os.mkdir(path)",
            "        return JsonResponse(model_to_dict(project))",
            "",
            "",
            "@api_view(['POST'])",
            "# @permission_classes([IsAuthenticated])",
            "def project_upload(request):",
            "    \"\"\"",
            "    upload project",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        file = request.FILES['file']",
            "        file_name = file.name",
            "        fs = FileSystemStorage(PROJECTS_FOLDER)",
            "        zip_file_name = fs.save(file_name, file)",
            "        logger.debug('zip file name %s', zip_file_name)",
            "        # extract zip file",
            "        with zipfile.ZipFile(join(PROJECTS_FOLDER, zip_file_name), 'r') as zip_ref:",
            "            zip_ref.extractall(PROJECTS_FOLDER)",
            "        logger.debug('extracted files to %s', PROJECTS_FOLDER)",
            "        return JsonResponse({'status': True})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_clone(request):",
            "    \"\"\"",
            "    clone project from github",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        address = data.get('address')",
            "        if not address.startswith('http'):",
            "            return JsonResponse({'status': False})",
            "        address = address + '.git' if not address.endswith('.git') else address",
            "        cmd = 'git clone {address} {target}'.format(address=address, target=join(PROJECTS_FOLDER, Path(address).stem))",
            "        logger.debug('clone cmd %s', cmd)",
            "        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)",
            "        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())",
            "        logger.debug('clone run result %s', stdout)",
            "        if stderr: logger.error(stderr)",
            "        return JsonResponse({'status': True}) if not stderr else JsonResponse({'status': False})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_remove(request, project_name):",
            "    \"\"\"",
            "    remove project from disk and db",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: result of remove",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        # delete deployments",
            "        project = Project.objects.get(name=project_name)",
            "        Deploy.objects.filter(project=project).delete()",
            "        # delete project",
            "        result = Project.objects.filter(name=project_name).delete()",
            "        # get project path",
            "        path = join(os.path.abspath(os.getcwd()), PROJECTS_FOLDER)",
            "        project_path = join(path, project_name)",
            "        # delete project file tree",
            "        if exists(project_path):",
            "            rmtree(project_path)",
            "        return JsonResponse({'result': result})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_version(request, client_id, project_name):",
            "    \"\"\"",
            "    get project deploy version",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: deploy version of project",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        # get client and project model",
            "        client = Client.objects.get(id=client_id)",
            "        project = Project.objects.get(name=project_name)",
            "        scrapyd = get_scrapyd(client)",
            "        # if deploy info exists in db, return it",
            "        if Deploy.objects.filter(client=client, project=project):",
            "            deploy = Deploy.objects.get(client=client, project=project)",
            "        # if deploy info does not exists in db, create deploy info",
            "        else:",
            "            try:",
            "                versions = scrapyd.list_versions(project_name)",
            "            except ConnectionError:",
            "                return JsonResponse({'message': 'Connect Error'}, status=500)",
            "            if len(versions) > 0:",
            "                version = versions[-1]",
            "                deployed_at = timezone.datetime.fromtimestamp(int(version), tz=pytz.timezone(TIME_ZONE))",
            "            else:",
            "                deployed_at = None",
            "            deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at)",
            "        # return deploy json info",
            "        return JsonResponse(model_to_dict(deploy))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_deploy(request, client_id, project_name):",
            "    \"\"\"",
            "    deploy project operation",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: json of deploy result",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        # get project folder",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        project_path = join(path, project_name)",
            "        # find egg file",
            "        egg = find_egg(project_path)",
            "        if not egg:",
            "            return JsonResponse({'message': 'egg not found'}, status=500)",
            "        egg_file = open(join(project_path, egg), 'rb')",
            "        # get client and project model",
            "        client = Client.objects.get(id=client_id)",
            "        project = Project.objects.get(name=project_name)",
            "        # execute deploy operation",
            "        scrapyd = get_scrapyd(client)",
            "        scrapyd.add_version(project_name, int(time.time()), egg_file.read())",
            "        # update deploy info",
            "        deployed_at = timezone.now()",
            "        Deploy.objects.filter(client=client, project=project).delete()",
            "        deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at,",
            "                                                         description=project.description)",
            "        return JsonResponse(model_to_dict(deploy))",
            "",
            "",
            "@api_view(['GET', 'POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_build(request, project_name):",
            "    \"\"\"",
            "    get build info or execute build operation",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: json",
            "    \"\"\"",
            "    # get project folder",
            "    path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "    project_path = join(path, project_name)",
            "    ",
            "    # get build version",
            "    if request.method == 'GET':",
            "        egg = find_egg(project_path)",
            "        # if built, save or update project to db",
            "        if egg:",
            "            built_at = timezone.datetime.fromtimestamp(os.path.getmtime(join(project_path, egg)),",
            "                                                       tz=pytz.timezone(TIME_ZONE))",
            "            if not Project.objects.filter(name=project_name):",
            "                Project(name=project_name, built_at=built_at, egg=egg).save()",
            "                model = Project.objects.get(name=project_name)",
            "            else:",
            "                model = Project.objects.get(name=project_name)",
            "                model.built_at = built_at",
            "                model.egg = egg",
            "                model.save()",
            "        # if not built, just save project name to db",
            "        else:",
            "            if not Project.objects.filter(name=project_name):",
            "                Project(name=project_name).save()",
            "            model = Project.objects.get(name=project_name)",
            "        # transfer model to dict then dumps it to json",
            "        data = model_to_dict(model)",
            "        return JsonResponse(data)",
            "    ",
            "    # build operation manually by clicking button",
            "    elif request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        description = data['description']",
            "        build_project(project_name)",
            "        egg = find_egg(project_path)",
            "        if not egg:",
            "            return JsonResponse({'message': 'egg not found'}, status=500)",
            "        # update built_at info",
            "        built_at = timezone.now()",
            "        # if project does not exists in db, create it",
            "        if not Project.objects.filter(name=project_name):",
            "            Project(name=project_name, description=description, built_at=built_at, egg=egg).save()",
            "            model = Project.objects.get(name=project_name)",
            "        # if project exists, update egg, description, built_at info",
            "        else:",
            "            model = Project.objects.get(name=project_name)",
            "            model.built_at = built_at",
            "            model.egg = egg",
            "            model.description = description",
            "            model.save()",
            "        # transfer model to dict then dumps it to json",
            "        data = model_to_dict(model)",
            "        return JsonResponse(data)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_parse(request, project_name):",
            "    \"\"\"",
            "    parse project",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: requests, items, response",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        project_path = join(PROJECTS_FOLDER, project_name)",
            "        data = json.loads(request.body)",
            "        logger.debug('post data %s', data)",
            "        spider_name = data.get('spider')",
            "        args = {",
            "            'start': data.get('start', False),",
            "            'method': data.get('method', 'GET'),",
            "            'url': data.get('url'),",
            "            'callback': data.get('callback'),",
            "            'cookies': \"'\" + json.dumps(data.get('cookies', {}), ensure_ascii=False) + \"'\",",
            "            'headers': \"'\" + json.dumps(data.get('headers', {}), ensure_ascii=False) + \"'\",",
            "            'meta': \"'\" + json.dumps(data.get('meta', {}), ensure_ascii=False) + \"'\",",
            "            'dont_filter': data.get('dont_filter', False),",
            "            'priority': data.get('priority', 0),",
            "        }",
            "        # set request body",
            "        body = data.get('body', '')",
            "        if args.get('method').lower() != 'get':",
            "            args['body'] = \"'\" + json.dumps(body, ensure_ascii=False) + \"'\"",
            "        ",
            "        args_cmd = ' '.join(",
            "            ['--{arg} {value}'.format(arg=arg, value=value) for arg, value in args.items()])",
            "        logger.debug('args cmd %s', args_cmd)",
            "        cmd = 'gerapy parse {args_cmd} {project_path} {spider_name}'.format(",
            "            args_cmd=args_cmd,",
            "            project_path=project_path,",
            "            spider_name=spider_name",
            "        )",
            "        logger.debug('parse cmd %s', cmd)",
            "        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE, close_fds=True)",
            "        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())",
            "        logger.debug('stdout %s, stderr %s', stdout, stderr)",
            "        if not stderr:",
            "            return JsonResponse({'status': True, 'result': json.loads(stdout)})",
            "        else:",
            "            return JsonResponse({'status': False, 'message': stderr})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_read(request):",
            "    \"\"\"",
            "    get content of project file",
            "    :param request: request object",
            "    :return: file content",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['label'])",
            "        # binary file",
            "        with open(path, 'rb') as f:",
            "            return HttpResponse(f.read().decode('utf-8'))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_update(request):",
            "    \"\"\"",
            "    update project file",
            "    :param request: request object",
            "    :return: result of update",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['label'])",
            "        code = data['code']",
            "        with open(path, 'w', encoding='utf-8') as f:",
            "            f.write(code)",
            "            return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_create(request):",
            "    \"\"\"",
            "    create project file",
            "    :param request: request object",
            "    :return: result of create",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['name'])",
            "        open(path, 'w', encoding='utf-8').close()",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_delete(request):",
            "    \"\"\"",
            "    delete project file",
            "    :param request: request object",
            "    :return: result of delete",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['label'])",
            "        result = os.remove(path)",
            "        return JsonResponse({'result': result})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_rename(request):",
            "    \"\"\"",
            "    rename file name",
            "    :param request: request object",
            "    :return: result of rename",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        pre = join(data['path'], data['pre'])",
            "        new = join(data['path'], data['new'])",
            "        os.rename(pre, new)",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def job_list(request, client_id, project_name):",
            "    \"\"\"",
            "    get job list of project from one client",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: list of jobs",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.list_jobs(project_name)",
            "        jobs = []",
            "        statuses = ['pending', 'running', 'finished']",
            "        for status in statuses:",
            "            for job in result.get(status):",
            "                job['status'] = status",
            "                jobs.append(job)",
            "        return JsonResponse(jobs)",
            "    ",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def job_log(request, client_id, project_name, spider_name, job_id):",
            "    \"\"\"",
            "    get log of jog",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :param spider_name: spider name",
            "    :param job_id: job id",
            "    :return: log of job",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        # get log url",
            "        url = log_url(client.ip, client.port, project_name, spider_name, job_id)",
            "        # get last 1000 bytes of log",
            "        response = requests.get(url, timeout=5, headers={",
            "            'Range': 'bytes=-1000'",
            "        }, auth=(client.username, client.password) if client.auth else None)",
            "        # Get encoding",
            "        encoding = response.apparent_encoding",
            "        # log not found",
            "        if response.status_code == 404:",
            "            return JsonResponse({'message': 'Log Not Found'}, status=404)",
            "        # bytes to string",
            "        text = response.content.decode(encoding, errors='replace')",
            "        return HttpResponse(text)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def job_cancel(request, client_id, project_name, job_id):",
            "    \"\"\"",
            "    cancel a job",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :param job_id: job id",
            "    :return: json of cancel",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.cancel(project_name, job_id)",
            "        return JsonResponse(result)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def del_version(request, client_id, project, version):",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.delete_version(project=project, version=version)",
            "        return JsonResponse(result)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def del_project(request, client_id, project):",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.delete_project(project=project)",
            "        return JsonResponse(result)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def monitor_db_list(request):",
            "    \"\"\"",
            "    get monitor db list",
            "    :param request: request object",
            "    :return: json of db list",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        url = data['url']",
            "        type = data['type']",
            "        if type == 'MongoDB':",
            "            client = pymongo.MongoClient(url)",
            "            dbs = client.list_database_names()",
            "            return JsonResponse(dbs)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def monitor_collection_list(request):",
            "    \"\"\"",
            "    get monitor collection list",
            "    :param request: request object",
            "    :return: json of collection list",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        url = data['url']",
            "        db = data['db']",
            "        type = data['type']",
            "        if type == 'MongoDB':",
            "            client = pymongo.MongoClient(url)",
            "            db = client[db]",
            "            collections = db.collection_names()",
            "            return JsonResponse(collections)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def monitor_create(request):",
            "    \"\"\"",
            "    create a monitor",
            "    :param request: request object",
            "    :return: json of create",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        data = data['form']",
            "        data['configuration'] = json.dumps(data['configuration'], ensure_ascii=False)",
            "        monitor = Monitor.objects.create(**data)",
            "        return JsonResponse(model_to_dict(monitor))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def task_create(request):",
            "    \"\"\"",
            "    add task",
            "    :param request: request object",
            "    :return: Bool",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        task = Task.objects.create(clients=json.dumps(data.get('clients'), ensure_ascii=False),",
            "                                   project=data.get('project'),",
            "                                   name=data.get('name'),",
            "                                   spider=data.get('spider'),",
            "                                   trigger=data.get('trigger'),",
            "                                   configuration=json.dumps(data.get('configuration'), ensure_ascii=False),",
            "                                   modified=1)",
            "        return JsonResponse({'result': '1', 'data': model_to_dict(task)})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def task_update(request, task_id):",
            "    \"\"\"",
            "    update task info",
            "    :param request: request object",
            "    :param task_id: task id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        task = Task.objects.filter(id=task_id)",
            "        data = json.loads(request.body)",
            "        data['clients'] = json.dumps(data.get('clients'), ensure_ascii=False)",
            "        data['configuration'] = json.dumps(data.get('configuration'), ensure_ascii=False)",
            "        data['modified'] = 1",
            "        task.update(**data)",
            "        return JsonResponse(model_to_dict(Task.objects.get(id=task_id)))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def task_remove(request, task_id):",
            "    \"\"\"",
            "    remove task by task_id",
            "    :param request:",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        # delete job from DjangoJob",
            "        task = Task.objects.get(id=task_id)",
            "        clients = clients_of_task(task)",
            "        for client in clients:",
            "            job_id = get_job_id(client, task)",
            "            DjangoJob.objects.filter(name=job_id).delete()",
            "        # delete task",
            "        Task.objects.filter(id=task_id).delete()",
            "        return JsonResponse({'result': '1'})",
            "    ",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def task_info(request, task_id):",
            "    \"\"\"",
            "    get task info",
            "    :param request: request object",
            "    :param task_id: task id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        task = Task.objects.get(id=task_id)",
            "        data = model_to_dict(task)",
            "        data['clients'] = json.loads(data.get('clients'))",
            "        data['configuration'] = json.loads(data.get('configuration'))",
            "        return JsonResponse({'data': data})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def task_index(request):",
            "    \"\"\"",
            "    get all tasks",
            "    :param request:",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        tasks = Task.objects.values()",
            "        return JsonResponse({'result': '1', 'data': tasks})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def task_status(request, task_id):",
            "    \"\"\"",
            "    get task status info",
            "    :param request: request object",
            "    :param task_id: task id",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        result = []",
            "        task = Task.objects.get(id=task_id)",
            "        clients = clients_of_task(task)",
            "        for client in clients:",
            "            job_id = get_job_id(client, task)",
            "            jobs = DjangoJob.objects.filter(name=job_id)",
            "            logger.debug('jobs from djangojob %s', jobs)",
            "            # if job does not exist, for date mode exceed time",
            "            if not jobs: continue",
            "            job = DjangoJob.objects.get(name=job_id)",
            "            executions = serialize('json', DjangoJobExecution.objects.filter(job=job))",
            "            result.append({",
            "                'client': model_to_dict(client),",
            "                'next': job.next_run_time,",
            "                'executions': json.loads(executions)",
            "            })",
            "        return JsonResponse({'data': result})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def render_html(request):",
            "    \"\"\"",
            "    render html with url",
            "    :param request:",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        url = request.GET.get('url')",
            "        url = unquote(base64.b64decode(url).decode('utf-8'))",
            "        js = request.GET.get('js', 0)",
            "        script = request.GET.get('script')",
            "        response = requests.get(url, timeout=5)",
            "        response.encoding = response.apparent_encoding",
            "        html = process_html(response.text)",
            "        return HttpResponse(html)"
        ],
        "afterPatchFile": [
            "import re",
            "from pathlib import Path",
            "from urllib.parse import unquote",
            "import base64",
            "import json",
            "import os",
            "import requests",
            "import time",
            "import pytz",
            "import pymongo",
            "from shutil import rmtree",
            "from requests.exceptions import ConnectionError",
            "from os.path import join, exists",
            "from django.shortcuts import render",
            "from django.core.serializers import serialize",
            "from django.http import HttpResponse",
            "from django.forms.models import model_to_dict",
            "from django.utils import timezone",
            "from rest_framework.decorators import api_view, permission_classes",
            "from rest_framework.permissions import IsAuthenticated",
            "from subprocess import Popen, PIPE",
            "from gerapy import get_logger",
            "from gerapy.server.core.response import JsonResponse",
            "from gerapy.cmd.init import PROJECTS_FOLDER",
            "from gerapy.server.server.settings import TIME_ZONE",
            "from gerapy.server.core.models import Client, Project, Deploy, Monitor, Task",
            "from gerapy.server.core.build import build_project, find_egg",
            "from gerapy.server.core.utils import IGNORES, scrapyd_url, log_url, get_tree, get_scrapyd, process_html, bytes2str, \\",
            "    clients_of_task, get_job_id",
            "from django_apscheduler.models import DjangoJob, DjangoJobExecution",
            "from django.core.files.storage import FileSystemStorage",
            "import zipfile",
            "",
            "logger = get_logger(__name__)",
            "",
            "",
            "@api_view(['GET'])",
            "# @permission_classes([IsAuthenticated])",
            "def index(request):",
            "    \"\"\"",
            "    render index page",
            "    :param request: request object",
            "    :return: page",
            "    \"\"\"",
            "    return render(request, 'index.html')",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def index_status(request):",
            "    \"\"\"",
            "    index statistics",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        clients = Client.objects.all()",
            "        data = {",
            "            'success': 0,",
            "            'error': 0,",
            "            'project': 0,",
            "        }",
            "        # clients info",
            "        for client in clients:",
            "            try:",
            "                requests.get(scrapyd_url(client.ip, client.port), timeout=1)",
            "                data['success'] += 1",
            "            except ConnectionError:",
            "                data['error'] += 1",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        files = os.listdir(path)",
            "        # projects info",
            "        for file in files:",
            "            if os.path.isdir(join(path, file)) and not file in IGNORES:",
            "                data['project'] += 1",
            "        return JsonResponse(data)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def client_index(request):",
            "    \"\"\"",
            "    get client list",
            "    :param request: request object",
            "    :return: client list",
            "    \"\"\"",
            "    return HttpResponse(serialize('json', Client.objects.order_by('-id')))",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def client_info(request, client_id):",
            "    \"\"\"",
            "    get client info",
            "    :param request: request object",
            "    :param id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def client_status(request, client_id):",
            "    \"\"\"",
            "    get client status",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        # get client object",
            "        client = Client.objects.get(id=client_id)",
            "        requests.get(scrapyd_url(client.ip, client.port), timeout=3)",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def client_update(request, client_id):",
            "    \"\"\"",
            "    update client info",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        client = Client.objects.filter(id=client_id)",
            "        data = json.loads(request.body)",
            "        client.update(**data)",
            "        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def client_create(request):",
            "    \"\"\"",
            "    create a client",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        client = Client.objects.create(**data)",
            "        return JsonResponse(model_to_dict(client))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def client_remove(request, client_id):",
            "    \"\"\"",
            "    remove a client",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        client = Client.objects.get(id=client_id)",
            "        # delete deploy",
            "        Deploy.objects.filter(client=client).delete()",
            "        # delete client",
            "        Client.objects.filter(id=client_id).delete()",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def spider_list(request, client_id, project_name):",
            "    \"\"\"",
            "    get spider list from one client",
            "    :param request: request Object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        spiders = scrapyd.list_spiders(project_name)",
            "        spiders = [{'name': spider, 'id': index + 1}",
            "                   for index, spider in enumerate(spiders)]",
            "        return JsonResponse(spiders)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def spider_start(request, client_id, project_name, spider_name):",
            "    \"\"\"",
            "    start a spider",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :param spider_name: spider name",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        job = scrapyd.schedule(project_name, spider_name)",
            "        return JsonResponse({'job': job})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_list(request, client_id):",
            "    \"\"\"",
            "    project deployed list on one client",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        projects = scrapyd.list_projects()",
            "        return JsonResponse(projects)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_index(request):",
            "    \"\"\"",
            "    project index list",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        files = os.listdir(path)",
            "        project_list = []",
            "        for file in files:",
            "            if os.path.isdir(join(path, file)) and not file in IGNORES:",
            "                project_list.append({'name': file})",
            "        return JsonResponse(project_list)",
            "",
            "",
            "@api_view(['GET', 'POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_configure(request, project_name):",
            "    \"\"\"",
            "    get configuration",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: json",
            "    \"\"\"",
            "    # get configuration",
            "    if request.method == 'GET':",
            "        project = Project.objects.get(name=project_name)",
            "        project = model_to_dict(project)",
            "        project['configuration'] = json.loads(",
            "            project['configuration']) if project['configuration'] else None",
            "        return JsonResponse(project)",
            "",
            "    # update configuration",
            "    elif request.method == 'POST':",
            "        project = Project.objects.filter(name=project_name)",
            "        data = json.loads(request.body)",
            "        configuration = json.dumps(",
            "            data.get('configuration'), ensure_ascii=False)",
            "        project.update(**{'configuration': configuration})",
            "        # for safe protection",
            "        project_name = re.sub(",
            "            '[\\s\\!\\@\\#\\$\\;\\&\\*\\~\\\"\\'\\{\\}\\]\\[\\-\\+\\%\\^]+', '', project_name)",
            "        # execute generate cmd",
            "        cmd = ['gerapy', 'generate', project_name]",
            "        p = Popen(cmd, shell=False, stdin=PIPE, stdout=PIPE, stderr=PIPE)",
            "        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())",
            "",
            "        if not stderr:",
            "            return JsonResponse({'status': '1'})",
            "        else:",
            "            return JsonResponse({'status': '0', 'message': stderr})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_tree(request, project_name):",
            "    \"\"\"",
            "    get file tree of project",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: json of tree",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        # get tree data",
            "        tree = get_tree(join(path, project_name))",
            "        return JsonResponse(tree)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_create(request):",
            "    \"\"\"",
            "    create a configurable project",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        data['configurable'] = 1",
            "        project, result = Project.objects.update_or_create(**data)",
            "        # generate a single project folder",
            "        path = join(os.path.abspath(",
            "            join(os.getcwd(), PROJECTS_FOLDER)), data['name'])",
            "        os.mkdir(path)",
            "        return JsonResponse(model_to_dict(project))",
            "",
            "",
            "@api_view(['POST'])",
            "# @permission_classes([IsAuthenticated])",
            "def project_upload(request):",
            "    \"\"\"",
            "    upload project",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        file = request.FILES['file']",
            "        file_name = file.name",
            "        fs = FileSystemStorage(PROJECTS_FOLDER)",
            "        zip_file_name = fs.save(file_name, file)",
            "        logger.debug('zip file name %s', zip_file_name)",
            "        # extract zip file",
            "        with zipfile.ZipFile(join(PROJECTS_FOLDER, zip_file_name), 'r') as zip_ref:",
            "            zip_ref.extractall(PROJECTS_FOLDER)",
            "        logger.debug('extracted files to %s', PROJECTS_FOLDER)",
            "        return JsonResponse({'status': True})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_clone(request):",
            "    \"\"\"",
            "    clone project from github",
            "    :param request: request object",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        address = data.get('address')",
            "        if not address.startswith('http'):",
            "            return JsonResponse({'status': False})",
            "        address = address + '.git' if not address.endswith('.git') else address",
            "        cmd = ['git', 'clone', 'address', join(PROJECTS_FOLDER, Path(address).stem)]",
            "        logger.debug('clone cmd %s', cmd)",
            "        p = Popen(cmd, shell=False, stdin=PIPE, stdout=PIPE, stderr=PIPE)",
            "        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())",
            "        logger.debug('clone run result %s', stdout)",
            "        if stderr:",
            "            logger.error(stderr)",
            "        return JsonResponse({'status': True}) if not stderr else JsonResponse({'status': False})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_remove(request, project_name):",
            "    \"\"\"",
            "    remove project from disk and db",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: result of remove",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        # delete deployments",
            "        project = Project.objects.get(name=project_name)",
            "        Deploy.objects.filter(project=project).delete()",
            "        # delete project",
            "        result = Project.objects.filter(name=project_name).delete()",
            "        # get project path",
            "        path = join(os.path.abspath(os.getcwd()), PROJECTS_FOLDER)",
            "        project_path = join(path, project_name)",
            "        # delete project file tree",
            "        if exists(project_path):",
            "            rmtree(project_path)",
            "        return JsonResponse({'result': result})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def project_version(request, client_id, project_name):",
            "    \"\"\"",
            "    get project deploy version",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: deploy version of project",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        # get client and project model",
            "        client = Client.objects.get(id=client_id)",
            "        project = Project.objects.get(name=project_name)",
            "        scrapyd = get_scrapyd(client)",
            "        # if deploy info exists in db, return it",
            "        if Deploy.objects.filter(client=client, project=project):",
            "            deploy = Deploy.objects.get(client=client, project=project)",
            "        # if deploy info does not exists in db, create deploy info",
            "        else:",
            "            try:",
            "                versions = scrapyd.list_versions(project_name)",
            "            except ConnectionError:",
            "                return JsonResponse({'message': 'Connect Error'}, status=500)",
            "            if len(versions) > 0:",
            "                version = versions[-1]",
            "                deployed_at = timezone.datetime.fromtimestamp(",
            "                    int(version), tz=pytz.timezone(TIME_ZONE))",
            "            else:",
            "                deployed_at = None",
            "            deploy, result = Deploy.objects.update_or_create(",
            "                client=client, project=project, deployed_at=deployed_at)",
            "        # return deploy json info",
            "        return JsonResponse(model_to_dict(deploy))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_deploy(request, client_id, project_name):",
            "    \"\"\"",
            "    deploy project operation",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: json of deploy result",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        # get project folder",
            "        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "        project_path = join(path, project_name)",
            "        # find egg file",
            "        egg = find_egg(project_path)",
            "        if not egg:",
            "            return JsonResponse({'message': 'egg not found'}, status=500)",
            "        egg_file = open(join(project_path, egg), 'rb')",
            "        # get client and project model",
            "        client = Client.objects.get(id=client_id)",
            "        project = Project.objects.get(name=project_name)",
            "        # execute deploy operation",
            "        scrapyd = get_scrapyd(client)",
            "        scrapyd.add_version(project_name, int(time.time()), egg_file.read())",
            "        # update deploy info",
            "        deployed_at = timezone.now()",
            "        Deploy.objects.filter(client=client, project=project).delete()",
            "        deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at,",
            "                                                         description=project.description)",
            "        return JsonResponse(model_to_dict(deploy))",
            "",
            "",
            "@api_view(['GET', 'POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_build(request, project_name):",
            "    \"\"\"",
            "    get build info or execute build operation",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: json",
            "    \"\"\"",
            "    # get project folder",
            "    path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))",
            "    project_path = join(path, project_name)",
            "",
            "    # get build version",
            "    if request.method == 'GET':",
            "        egg = find_egg(project_path)",
            "        # if built, save or update project to db",
            "        if egg:",
            "            built_at = timezone.datetime.fromtimestamp(os.path.getmtime(join(project_path, egg)),",
            "                                                       tz=pytz.timezone(TIME_ZONE))",
            "            if not Project.objects.filter(name=project_name):",
            "                Project(name=project_name, built_at=built_at, egg=egg).save()",
            "                model = Project.objects.get(name=project_name)",
            "            else:",
            "                model = Project.objects.get(name=project_name)",
            "                model.built_at = built_at",
            "                model.egg = egg",
            "                model.save()",
            "        # if not built, just save project name to db",
            "        else:",
            "            if not Project.objects.filter(name=project_name):",
            "                Project(name=project_name).save()",
            "            model = Project.objects.get(name=project_name)",
            "        # transfer model to dict then dumps it to json",
            "        data = model_to_dict(model)",
            "        return JsonResponse(data)",
            "",
            "    # build operation manually by clicking button",
            "    elif request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        description = data['description']",
            "        build_project(project_name)",
            "        egg = find_egg(project_path)",
            "        if not egg:",
            "            return JsonResponse({'message': 'egg not found'}, status=500)",
            "        # update built_at info",
            "        built_at = timezone.now()",
            "        # if project does not exists in db, create it",
            "        if not Project.objects.filter(name=project_name):",
            "            Project(name=project_name, description=description,",
            "                    built_at=built_at, egg=egg).save()",
            "            model = Project.objects.get(name=project_name)",
            "        # if project exists, update egg, description, built_at info",
            "        else:",
            "            model = Project.objects.get(name=project_name)",
            "            model.built_at = built_at",
            "            model.egg = egg",
            "            model.description = description",
            "            model.save()",
            "        # transfer model to dict then dumps it to json",
            "        data = model_to_dict(model)",
            "        return JsonResponse(data)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_parse(request, project_name):",
            "    \"\"\"",
            "    parse project",
            "    :param request: request object",
            "    :param project_name: project name",
            "    :return: requests, items, response",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        project_path = join(PROJECTS_FOLDER, project_name)",
            "        data = json.loads(request.body)",
            "        logger.debug('post data %s', data)",
            "        spider_name = data.get('spider')",
            "        args = {",
            "            'start': data.get('start', False),",
            "            'method': data.get('method', 'GET'),",
            "            'url': data.get('url'),",
            "            'callback': data.get('callback'),",
            "            'cookies': \"'\" + json.dumps(data.get('cookies', {}), ensure_ascii=False) + \"'\",",
            "            'headers': \"'\" + json.dumps(data.get('headers', {}), ensure_ascii=False) + \"'\",",
            "            'meta': \"'\" + json.dumps(data.get('meta', {}), ensure_ascii=False) + \"'\",",
            "            'dont_filter': data.get('dont_filter', False),",
            "            'priority': data.get('priority', 0),",
            "        }",
            "        # set request body",
            "        body = data.get('body', '')",
            "        if args.get('method').lower() != 'get':",
            "            args['body'] = \"'\" + json.dumps(body, ensure_ascii=False) + \"'\"",
            "",
            "        args_array = []",
            "        for arg, value in args.items():",
            "            args_array.append(f'--{arg}')",
            "            args_array.append(f'{value}')",
            "        cmd = ['gerapy', 'parse'] + args_array + [project_path] + [spider_name]",
            "        print('cmd', cmd)",
            "        logger.debug('parse cmd %s', cmd)",
            "        p = Popen(cmd, shell=False, stdin=PIPE,",
            "                         stdout=PIPE, stderr=PIPE, close_fds=True)",
            "        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())",
            "        logger.debug('stdout %s, stderr %s', stdout, stderr)",
            "        if not stderr:",
            "            return JsonResponse({'status': True, 'result': json.loads(stdout)})",
            "        else:",
            "            return JsonResponse({'status': False, 'message': stderr})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_read(request):",
            "    \"\"\"",
            "    get content of project file",
            "    :param request: request object",
            "    :return: file content",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['label'])",
            "        # binary file",
            "        with open(path, 'rb') as f:",
            "            return HttpResponse(f.read().decode('utf-8'))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_update(request):",
            "    \"\"\"",
            "    update project file",
            "    :param request: request object",
            "    :return: result of update",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['label'])",
            "        code = data['code']",
            "        with open(path, 'w', encoding='utf-8') as f:",
            "            f.write(code)",
            "            return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_create(request):",
            "    \"\"\"",
            "    create project file",
            "    :param request: request object",
            "    :return: result of create",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['name'])",
            "        open(path, 'w', encoding='utf-8').close()",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_delete(request):",
            "    \"\"\"",
            "    delete project file",
            "    :param request: request object",
            "    :return: result of delete",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        path = join(data['path'], data['label'])",
            "        result = os.remove(path)",
            "        return JsonResponse({'result': result})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def project_file_rename(request):",
            "    \"\"\"",
            "    rename file name",
            "    :param request: request object",
            "    :return: result of rename",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        pre = join(data['path'], data['pre'])",
            "        new = join(data['path'], data['new'])",
            "        os.rename(pre, new)",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def job_list(request, client_id, project_name):",
            "    \"\"\"",
            "    get job list of project from one client",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :return: list of jobs",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.list_jobs(project_name)",
            "        jobs = []",
            "        statuses = ['pending', 'running', 'finished']",
            "        for status in statuses:",
            "            for job in result.get(status):",
            "                job['status'] = status",
            "                jobs.append(job)",
            "        return JsonResponse(jobs)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def job_log(request, client_id, project_name, spider_name, job_id):",
            "    \"\"\"",
            "    get log of jog",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :param spider_name: spider name",
            "    :param job_id: job id",
            "    :return: log of job",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        # get log url",
            "        url = log_url(client.ip, client.port,",
            "                      project_name, spider_name, job_id)",
            "        # get last 1000 bytes of log",
            "        response = requests.get(url, timeout=5, headers={",
            "            'Range': 'bytes=-1000'",
            "        }, auth=(client.username, client.password) if client.auth else None)",
            "        # Get encoding",
            "        encoding = response.apparent_encoding",
            "        # log not found",
            "        if response.status_code == 404:",
            "            return JsonResponse({'message': 'Log Not Found'}, status=404)",
            "        # bytes to string",
            "        text = response.content.decode(encoding, errors='replace')",
            "        return HttpResponse(text)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def job_cancel(request, client_id, project_name, job_id):",
            "    \"\"\"",
            "    cancel a job",
            "    :param request: request object",
            "    :param client_id: client id",
            "    :param project_name: project name",
            "    :param job_id: job id",
            "    :return: json of cancel",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.cancel(project_name, job_id)",
            "        return JsonResponse(result)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def del_version(request, client_id, project, version):",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.delete_version(project=project, version=version)",
            "        return JsonResponse(result)",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def del_project(request, client_id, project):",
            "    if request.method == 'GET':",
            "        client = Client.objects.get(id=client_id)",
            "        scrapyd = get_scrapyd(client)",
            "        result = scrapyd.delete_project(project=project)",
            "        return JsonResponse(result)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def monitor_db_list(request):",
            "    \"\"\"",
            "    get monitor db list",
            "    :param request: request object",
            "    :return: json of db list",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        url = data['url']",
            "        type = data['type']",
            "        if type == 'MongoDB':",
            "            client = pymongo.MongoClient(url)",
            "            dbs = client.list_database_names()",
            "            return JsonResponse(dbs)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def monitor_collection_list(request):",
            "    \"\"\"",
            "    get monitor collection list",
            "    :param request: request object",
            "    :return: json of collection list",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        url = data['url']",
            "        db = data['db']",
            "        type = data['type']",
            "        if type == 'MongoDB':",
            "            client = pymongo.MongoClient(url)",
            "            db = client[db]",
            "            collections = db.collection_names()",
            "            return JsonResponse(collections)",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def monitor_create(request):",
            "    \"\"\"",
            "    create a monitor",
            "    :param request: request object",
            "    :return: json of create",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        data = data['form']",
            "        data['configuration'] = json.dumps(",
            "            data['configuration'], ensure_ascii=False)",
            "        monitor = Monitor.objects.create(**data)",
            "        return JsonResponse(model_to_dict(monitor))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def task_create(request):",
            "    \"\"\"",
            "    add task",
            "    :param request: request object",
            "    :return: Bool",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        data = json.loads(request.body)",
            "        task = Task.objects.create(clients=json.dumps(data.get('clients'), ensure_ascii=False),",
            "                                   project=data.get('project'),",
            "                                   name=data.get('name'),",
            "                                   spider=data.get('spider'),",
            "                                   trigger=data.get('trigger'),",
            "                                   configuration=json.dumps(",
            "                                       data.get('configuration'), ensure_ascii=False),",
            "                                   modified=1)",
            "        return JsonResponse({'result': '1', 'data': model_to_dict(task)})",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def task_update(request, task_id):",
            "    \"\"\"",
            "    update task info",
            "    :param request: request object",
            "    :param task_id: task id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        task = Task.objects.filter(id=task_id)",
            "        data = json.loads(request.body)",
            "        data['clients'] = json.dumps(data.get('clients'), ensure_ascii=False)",
            "        data['configuration'] = json.dumps(",
            "            data.get('configuration'), ensure_ascii=False)",
            "        data['modified'] = 1",
            "        task.update(**data)",
            "        return JsonResponse(model_to_dict(Task.objects.get(id=task_id)))",
            "",
            "",
            "@api_view(['POST'])",
            "@permission_classes([IsAuthenticated])",
            "def task_remove(request, task_id):",
            "    \"\"\"",
            "    remove task by task_id",
            "    :param request:",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'POST':",
            "        # delete job from DjangoJob",
            "        task = Task.objects.get(id=task_id)",
            "        clients = clients_of_task(task)",
            "        for client in clients:",
            "            job_id = get_job_id(client, task)",
            "            DjangoJob.objects.filter(id=job_id).delete()",
            "        # delete task",
            "        Task.objects.filter(id=task_id).delete()",
            "        return JsonResponse({'result': '1'})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def task_info(request, task_id):",
            "    \"\"\"",
            "    get task info",
            "    :param request: request object",
            "    :param task_id: task id",
            "    :return: json",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        task = Task.objects.get(id=task_id)",
            "        data = model_to_dict(task)",
            "        data['clients'] = json.loads(data.get('clients'))",
            "        data['configuration'] = json.loads(data.get('configuration'))",
            "        return JsonResponse({'data': data})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def task_index(request):",
            "    \"\"\"",
            "    get all tasks",
            "    :param request:",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        tasks = Task.objects.values()",
            "        return JsonResponse({'result': '1', 'data': tasks})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def task_status(request, task_id):",
            "    \"\"\"",
            "    get task status info",
            "    :param request: request object",
            "    :param task_id: task id",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        result = []",
            "        task = Task.objects.get(id=task_id)",
            "        clients = clients_of_task(task)",
            "        for client in clients:",
            "            job_id = get_job_id(client, task)",
            "            jobs = DjangoJob.objects.filter(id=job_id)",
            "            logger.debug('jobs from djangojob %s', jobs)",
            "            # if job does not exist, for date mode exceed time",
            "            if not jobs:",
            "                continue",
            "            job = DjangoJob.objects.get(id=job_id)",
            "            executions = serialize(",
            "                'json', DjangoJobExecution.objects.filter(job=job))",
            "            result.append({",
            "                'client': model_to_dict(client),",
            "                'next': job.next_run_time,",
            "                'executions': json.loads(executions)",
            "            })",
            "        return JsonResponse({'data': result})",
            "",
            "",
            "@api_view(['GET'])",
            "@permission_classes([IsAuthenticated])",
            "def render_html(request):",
            "    \"\"\"",
            "    render html with url",
            "    :param request:",
            "    :return:",
            "    \"\"\"",
            "    if request.method == 'GET':",
            "        url = request.GET.get('url')",
            "        url = unquote(base64.b64decode(url).decode('utf-8'))",
            "        js = request.GET.get('js', 0)",
            "        script = request.GET.get('script')",
            "        response = requests.get(url, timeout=5)",
            "        response.encoding = response.apparent_encoding",
            "        html = process_html(response.text)",
            "        return HttpResponse(html)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "5": [],
            "176": [
                "spider_list"
            ],
            "245": [
                "project_configure"
            ],
            "247": [
                "project_configure"
            ],
            "252": [
                "project_configure"
            ],
            "254": [
                "project_configure"
            ],
            "256": [
                "project_configure"
            ],
            "258": [
                "project_configure"
            ],
            "259": [
                "project_configure"
            ],
            "261": [
                "project_configure"
            ],
            "297": [
                "project_create"
            ],
            "337": [
                "project_clone"
            ],
            "339": [
                "project_clone"
            ],
            "342": [
                "project_clone"
            ],
            "396": [
                "project_version"
            ],
            "399": [
                "project_version"
            ],
            "449": [
                "project_build"
            ],
            "473": [
                "project_build"
            ],
            "486": [
                "project_build"
            ],
            "529": [
                "project_parse"
            ],
            "530": [
                "project_parse"
            ],
            "531": [
                "project_parse"
            ],
            "532": [
                "project_parse"
            ],
            "533": [
                "project_parse"
            ],
            "534": [
                "project_parse"
            ],
            "535": [
                "project_parse"
            ],
            "536": [
                "project_parse"
            ],
            "537": [
                "project_parse"
            ],
            "539": [
                "project_parse"
            ],
            "648": [],
            "666": [
                "job_log"
            ],
            "768": [
                "monitor_create"
            ],
            "788": [
                "task_create"
            ],
            "806": [
                "task_update"
            ],
            "826": [
                "task_remove"
            ],
            "830": [],
            "878": [
                "task_status"
            ],
            "881": [
                "task_status"
            ],
            "882": [
                "task_status"
            ],
            "883": [
                "task_status"
            ]
        },
        "addLocation": []
    }
}