{
    "setup.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " setup("
            },
            "2": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": "     name='jupyterhub-systemdspawner',"
            },
            "3": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    version='0.14',"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+    version='0.15.0',"
            },
            "5": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": "     description='JupyterHub Spawner using systemd for resource isolation',"
            },
            "6": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": "     long_description='See https://github.com/jupyterhub/systemdspawner for more info',"
            },
            "7": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": "     url='https://github.com/jupyterhub/systemdspawner',"
            }
        },
        "frontPatchFile": [
            "from setuptools import setup",
            "",
            "setup(",
            "    name='jupyterhub-systemdspawner',",
            "    version='0.14',",
            "    description='JupyterHub Spawner using systemd for resource isolation',",
            "    long_description='See https://github.com/jupyterhub/systemdspawner for more info',",
            "    url='https://github.com/jupyterhub/systemdspawner',",
            "    author='Yuvi Panda',",
            "    author_email='yuvipanda@gmail.com',",
            "    license='3 Clause BSD',",
            "    packages=['systemdspawner'],",
            "    entry_points={",
            "        'jupyterhub.spawners': [",
            "            'systemdspawner = systemdspawner:SystemdSpawner',",
            "        ],",
            "    },",
            "    install_requires=[",
            "        'jupyterhub>=0.9',",
            "        'tornado>=5.0'",
            "    ],",
            ")"
        ],
        "afterPatchFile": [
            "from setuptools import setup",
            "",
            "setup(",
            "    name='jupyterhub-systemdspawner',",
            "    version='0.15.0',",
            "    description='JupyterHub Spawner using systemd for resource isolation',",
            "    long_description='See https://github.com/jupyterhub/systemdspawner for more info',",
            "    url='https://github.com/jupyterhub/systemdspawner',",
            "    author='Yuvi Panda',",
            "    author_email='yuvipanda@gmail.com',",
            "    license='3 Clause BSD',",
            "    packages=['systemdspawner'],",
            "    entry_points={",
            "        'jupyterhub.spawners': [",
            "            'systemdspawner = systemdspawner:SystemdSpawner',",
            "        ],",
            "    },",
            "    install_requires=[",
            "        'jupyterhub>=0.9',",
            "        'tornado>=5.0'",
            "    ],",
            ")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "5": []
        },
        "addLocation": []
    },
    "systemdspawner/systemd.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " Contains functions to start, stop & poll systemd services."
            },
            "1": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " Probably not very useful outside this spawner."
            },
            "2": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " \"\"\""
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+"
            },
            "4": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " import asyncio"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+import os"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+import re"
            },
            "7": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " import shlex"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+import warnings"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+# light validation of environment variable keys"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+env_pat = re.compile(\"[A-Za-z_]+\")"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 16,
                "PatchRowcode": "+"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 17,
                "PatchRowcode": "+RUN_ROOT = \"/run\""
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 18,
                "PatchRowcode": "+"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+def ensure_environment_directory(environment_file_directory):"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 20,
                "PatchRowcode": "+    \"\"\"Ensure directory for environment files exists and is private\"\"\""
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+    # ensure directory exists"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+    os.makedirs(environment_file_directory, mode=0o700, exist_ok=True)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+    # validate permissions"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+    mode = os.stat(environment_file_directory).st_mode"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+    if mode & 0o077:"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+        warnings.warn("
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+            f\"Fixing permissions on environment directory {environment_file_directory}: {oct(mode)}\","
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+            RuntimeWarning,"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+        )"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+        os.chmod(environment_file_directory, 0o700)"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+    else:"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+        return"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+    # Check again after supposedly fixing."
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+    # Some filesystems can have weird issues, preventing this from having desired effect"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+    mode = os.stat(environment_file_directory).st_mode"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 36,
                "PatchRowcode": "+    if mode & 0o077:"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+        warnings.warn("
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+            f\"Bad permissions on environment directory {environment_file_directory}: {oct(mode)}\","
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+            RuntimeWarning,"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+        )"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+def make_environment_file(environment_file_directory, unit_name, environment_variables):"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+    \"\"\"Make a systemd environment file"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+    - ensures environment directory exists and is private"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+    - writes private environment file"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 48,
                "PatchRowcode": "+    - returns path to created environment file"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+    \"\"\""
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+    ensure_environment_directory(environment_file_directory)"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+    env_file = os.path.join(environment_file_directory, f\"{unit_name}.env\")"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+    env_lines = []"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+    for key, value in sorted(environment_variables.items()):"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+        assert env_pat.match(key), f\"{key} not a valid environment variable\""
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+        env_lines.append(f\"{key}={shlex.quote(value)}\")"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+    env_lines.append(\"\")  # trailing newline"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+    with open(env_file, mode=\"w\") as f:"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+        # make the file itself private as well"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+        os.fchmod(f.fileno(), 0o400)"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+        f.write(\"\\n\".join(env_lines))"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+    return env_file"
            },
            "59": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 63,
                "PatchRowcode": " "
            },
            "60": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 64,
                "PatchRowcode": " "
            },
            "61": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 65,
                "PatchRowcode": " async def start_transient_service("
            },
            "62": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "     slice=None,"
            },
            "63": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 75,
                "PatchRowcode": " ):"
            },
            "64": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "     \"\"\""
            },
            "65": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    Start a systemd transient service with given paramters"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+    Start a systemd transient service with given parameters"
            },
            "67": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "     \"\"\""
            },
            "68": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 79,
                "PatchRowcode": " "
            },
            "69": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "     run_cmd = ["
            },
            "70": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "         'systemd-run',"
            },
            "71": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "         '--unit', unit_name,"
            },
            "72": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "     ]"
            },
            "73": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 84,
                "PatchRowcode": " "
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+    if properties is None:"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+        properties = {}"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+    else:"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+        properties = properties.copy()"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+    # ensure there is a runtime directory where we can put our env file"
            },
            "80": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+    # If already set, can be space-separated list of paths"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+    runtime_directories = properties.setdefault(\"RuntimeDirectory\", unit_name).split()"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+    # runtime directories are always resolved relative to `/run`"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+    # grab the first item, if more than one"
            },
            "85": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+    runtime_dir = os.path.join(RUN_ROOT, runtime_directories[0])"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+    # make runtime directories private by default"
            },
            "87": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+    properties.setdefault(\"RuntimeDirectoryMode\", \"700\")"
            },
            "88": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+    # preserve runtime directories across restarts"
            },
            "89": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+    # allows `systemctl restart` to load the env"
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+    properties.setdefault(\"RuntimeDirectoryPreserve\", \"restart\")"
            },
            "91": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+"
            },
            "92": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 103,
                "PatchRowcode": "     if properties:"
            },
            "93": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 104,
                "PatchRowcode": "         for key, value in properties.items():"
            },
            "94": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "             if isinstance(value, list):"
            },
            "95": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 109,
                "PatchRowcode": "                 run_cmd.append('--property={}={}'.format(key, value))"
            },
            "96": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 110,
                "PatchRowcode": " "
            },
            "97": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "     if environment_variables:"
            },
            "98": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        run_cmd += ["
            },
            "99": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            '--setenv={}={}'.format(key, value)"
            },
            "100": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            for key, value in environment_variables.items()"
            },
            "101": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ]"
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+        environment_file = make_environment_file("
            },
            "103": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+            runtime_dir, unit_name, environment_variables"
            },
            "104": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+        )"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+        run_cmd.append(f\"--property=EnvironmentFile={environment_file}\")"
            },
            "106": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 116,
                "PatchRowcode": " "
            },
            "107": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "     # Explicitly check if uid / gid are not None, since 0 is valid value for both"
            },
            "108": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 118,
                "PatchRowcode": "     if uid is not None:"
            },
            "109": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 123,
                "PatchRowcode": " "
            },
            "110": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "     if slice is not None:"
            },
            "111": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 125,
                "PatchRowcode": "         run_cmd += ['--slice={}'.format(slice)]"
            },
            "112": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    "
            },
            "113": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 126,
                "PatchRowcode": "+"
            },
            "114": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 127,
                "PatchRowcode": "     # We unfortunately have to resort to doing cd with bash, since WorkingDirectory property"
            },
            "115": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 128,
                "PatchRowcode": "     # of systemd units can't be set for transient units via systemd-run until systemd v227."
            },
            "116": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 129,
                "PatchRowcode": "     # Centos 7 has systemd 219, and will probably never upgrade - so we need to support them."
            }
        },
        "frontPatchFile": [
            "\"\"\"",
            "Systemd service utilities.",
            "",
            "Contains functions to start, stop & poll systemd services.",
            "Probably not very useful outside this spawner.",
            "\"\"\"",
            "import asyncio",
            "import shlex",
            "",
            "",
            "async def start_transient_service(",
            "    unit_name,",
            "    cmd,",
            "    args,",
            "    working_dir,",
            "    environment_variables=None,",
            "    properties=None,",
            "    uid=None,",
            "    gid=None,",
            "    slice=None,",
            "):",
            "    \"\"\"",
            "    Start a systemd transient service with given paramters",
            "    \"\"\"",
            "",
            "    run_cmd = [",
            "        'systemd-run',",
            "        '--unit', unit_name,",
            "    ]",
            "",
            "    if properties:",
            "        for key, value in properties.items():",
            "            if isinstance(value, list):",
            "                run_cmd += ['--property={}={}'.format(key, v) for v in value]",
            "            else:",
            "                # A string!",
            "                run_cmd.append('--property={}={}'.format(key, value))",
            "",
            "    if environment_variables:",
            "        run_cmd += [",
            "            '--setenv={}={}'.format(key, value)",
            "            for key, value in environment_variables.items()",
            "        ]",
            "",
            "    # Explicitly check if uid / gid are not None, since 0 is valid value for both",
            "    if uid is not None:",
            "        run_cmd += ['--uid', str(uid)]",
            "",
            "    if gid is not None:",
            "        run_cmd += ['--gid', str(gid)]",
            "",
            "    if slice is not None:",
            "        run_cmd += ['--slice={}'.format(slice)]",
            "    ",
            "    # We unfortunately have to resort to doing cd with bash, since WorkingDirectory property",
            "    # of systemd units can't be set for transient units via systemd-run until systemd v227.",
            "    # Centos 7 has systemd 219, and will probably never upgrade - so we need to support them.",
            "    run_cmd += [",
            "        '/bin/bash',",
            "        '-c',",
            "        \"cd {wd} && exec {cmd} {args}\".format(",
            "            wd=shlex.quote(working_dir),",
            "            cmd=' '.join([shlex.quote(c) for c in cmd]),",
            "            args=' '.join([shlex.quote(a) for a in args])",
            "        )",
            "    ]",
            "",
            "    proc = await asyncio.create_subprocess_exec(*run_cmd)",
            "",
            "    return await proc.wait()",
            "",
            "",
            "async def service_running(unit_name):",
            "    \"\"\"",
            "    Return true if service with given name is running (active).",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'is-active',",
            "        unit_name,",
            "        # hide stdout, but don't capture stderr at all",
            "        stdout=asyncio.subprocess.DEVNULL",
            "    )",
            "    ret = await proc.wait()",
            "",
            "    return ret == 0",
            "",
            "",
            "async def service_failed(unit_name):",
            "    \"\"\"",
            "    Return true if service with given name is in a failed state.",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'is-failed',",
            "        unit_name,",
            "        # hide stdout, but don't capture stderr at all",
            "        stdout=asyncio.subprocess.DEVNULL",
            "    )",
            "    ret = await proc.wait()",
            "",
            "    return ret == 0",
            "",
            "",
            "async def stop_service(unit_name):",
            "    \"\"\"",
            "    Stop service with given name.",
            "",
            "    Throws CalledProcessError if stopping fails",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'stop',",
            "        unit_name",
            "    )",
            "    await proc.wait()",
            "",
            "",
            "async def reset_service(unit_name):",
            "    \"\"\"",
            "    Reset service with given name.",
            "",
            "    Throws CalledProcessError if resetting fails",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'reset-failed',",
            "        unit_name",
            "    )",
            "    await proc.wait()"
        ],
        "afterPatchFile": [
            "\"\"\"",
            "Systemd service utilities.",
            "",
            "Contains functions to start, stop & poll systemd services.",
            "Probably not very useful outside this spawner.",
            "\"\"\"",
            "",
            "import asyncio",
            "import os",
            "import re",
            "import shlex",
            "import warnings",
            "",
            "# light validation of environment variable keys",
            "env_pat = re.compile(\"[A-Za-z_]+\")",
            "",
            "RUN_ROOT = \"/run\"",
            "",
            "def ensure_environment_directory(environment_file_directory):",
            "    \"\"\"Ensure directory for environment files exists and is private\"\"\"",
            "    # ensure directory exists",
            "    os.makedirs(environment_file_directory, mode=0o700, exist_ok=True)",
            "    # validate permissions",
            "    mode = os.stat(environment_file_directory).st_mode",
            "    if mode & 0o077:",
            "        warnings.warn(",
            "            f\"Fixing permissions on environment directory {environment_file_directory}: {oct(mode)}\",",
            "            RuntimeWarning,",
            "        )",
            "        os.chmod(environment_file_directory, 0o700)",
            "    else:",
            "        return",
            "    # Check again after supposedly fixing.",
            "    # Some filesystems can have weird issues, preventing this from having desired effect",
            "    mode = os.stat(environment_file_directory).st_mode",
            "    if mode & 0o077:",
            "        warnings.warn(",
            "            f\"Bad permissions on environment directory {environment_file_directory}: {oct(mode)}\",",
            "            RuntimeWarning,",
            "        )",
            "",
            "",
            "def make_environment_file(environment_file_directory, unit_name, environment_variables):",
            "    \"\"\"Make a systemd environment file",
            "",
            "    - ensures environment directory exists and is private",
            "    - writes private environment file",
            "    - returns path to created environment file",
            "    \"\"\"",
            "    ensure_environment_directory(environment_file_directory)",
            "    env_file = os.path.join(environment_file_directory, f\"{unit_name}.env\")",
            "    env_lines = []",
            "    for key, value in sorted(environment_variables.items()):",
            "        assert env_pat.match(key), f\"{key} not a valid environment variable\"",
            "        env_lines.append(f\"{key}={shlex.quote(value)}\")",
            "    env_lines.append(\"\")  # trailing newline",
            "    with open(env_file, mode=\"w\") as f:",
            "        # make the file itself private as well",
            "        os.fchmod(f.fileno(), 0o400)",
            "        f.write(\"\\n\".join(env_lines))",
            "",
            "    return env_file",
            "",
            "",
            "async def start_transient_service(",
            "    unit_name,",
            "    cmd,",
            "    args,",
            "    working_dir,",
            "    environment_variables=None,",
            "    properties=None,",
            "    uid=None,",
            "    gid=None,",
            "    slice=None,",
            "):",
            "    \"\"\"",
            "    Start a systemd transient service with given parameters",
            "    \"\"\"",
            "",
            "    run_cmd = [",
            "        'systemd-run',",
            "        '--unit', unit_name,",
            "    ]",
            "",
            "    if properties is None:",
            "        properties = {}",
            "    else:",
            "        properties = properties.copy()",
            "",
            "    # ensure there is a runtime directory where we can put our env file",
            "    # If already set, can be space-separated list of paths",
            "    runtime_directories = properties.setdefault(\"RuntimeDirectory\", unit_name).split()",
            "",
            "    # runtime directories are always resolved relative to `/run`",
            "    # grab the first item, if more than one",
            "    runtime_dir = os.path.join(RUN_ROOT, runtime_directories[0])",
            "    # make runtime directories private by default",
            "    properties.setdefault(\"RuntimeDirectoryMode\", \"700\")",
            "    # preserve runtime directories across restarts",
            "    # allows `systemctl restart` to load the env",
            "    properties.setdefault(\"RuntimeDirectoryPreserve\", \"restart\")",
            "",
            "    if properties:",
            "        for key, value in properties.items():",
            "            if isinstance(value, list):",
            "                run_cmd += ['--property={}={}'.format(key, v) for v in value]",
            "            else:",
            "                # A string!",
            "                run_cmd.append('--property={}={}'.format(key, value))",
            "",
            "    if environment_variables:",
            "        environment_file = make_environment_file(",
            "            runtime_dir, unit_name, environment_variables",
            "        )",
            "        run_cmd.append(f\"--property=EnvironmentFile={environment_file}\")",
            "",
            "    # Explicitly check if uid / gid are not None, since 0 is valid value for both",
            "    if uid is not None:",
            "        run_cmd += ['--uid', str(uid)]",
            "",
            "    if gid is not None:",
            "        run_cmd += ['--gid', str(gid)]",
            "",
            "    if slice is not None:",
            "        run_cmd += ['--slice={}'.format(slice)]",
            "",
            "    # We unfortunately have to resort to doing cd with bash, since WorkingDirectory property",
            "    # of systemd units can't be set for transient units via systemd-run until systemd v227.",
            "    # Centos 7 has systemd 219, and will probably never upgrade - so we need to support them.",
            "    run_cmd += [",
            "        '/bin/bash',",
            "        '-c',",
            "        \"cd {wd} && exec {cmd} {args}\".format(",
            "            wd=shlex.quote(working_dir),",
            "            cmd=' '.join([shlex.quote(c) for c in cmd]),",
            "            args=' '.join([shlex.quote(a) for a in args])",
            "        )",
            "    ]",
            "",
            "    proc = await asyncio.create_subprocess_exec(*run_cmd)",
            "",
            "    return await proc.wait()",
            "",
            "",
            "async def service_running(unit_name):",
            "    \"\"\"",
            "    Return true if service with given name is running (active).",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'is-active',",
            "        unit_name,",
            "        # hide stdout, but don't capture stderr at all",
            "        stdout=asyncio.subprocess.DEVNULL",
            "    )",
            "    ret = await proc.wait()",
            "",
            "    return ret == 0",
            "",
            "",
            "async def service_failed(unit_name):",
            "    \"\"\"",
            "    Return true if service with given name is in a failed state.",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'is-failed',",
            "        unit_name,",
            "        # hide stdout, but don't capture stderr at all",
            "        stdout=asyncio.subprocess.DEVNULL",
            "    )",
            "    ret = await proc.wait()",
            "",
            "    return ret == 0",
            "",
            "",
            "async def stop_service(unit_name):",
            "    \"\"\"",
            "    Stop service with given name.",
            "",
            "    Throws CalledProcessError if stopping fails",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'stop',",
            "        unit_name",
            "    )",
            "    await proc.wait()",
            "",
            "",
            "async def reset_service(unit_name):",
            "    \"\"\"",
            "    Reset service with given name.",
            "",
            "    Throws CalledProcessError if resetting fails",
            "    \"\"\"",
            "    proc = await asyncio.create_subprocess_exec(",
            "        'systemctl',",
            "        'reset-failed',",
            "        unit_name",
            "    )",
            "    await proc.wait()"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "-1",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "23": [],
            "40": [],
            "41": [],
            "42": [],
            "43": [],
            "54": []
        },
        "addLocation": [
            "applications.admin.controllers.default.git_pull",
            "systemdspawner.systemd.start_transient_service"
        ]
    }
}