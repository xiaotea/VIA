{
    "django/contrib/csrf/middleware.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "             if getattr(callback, 'csrf_exempt', False):"
            },
            "1": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": "                 return None"
            },
            "2": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if request.is_ajax():"
            },
            "4": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                return None"
            },
            "5": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "6": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "             try:"
            },
            "7": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 41,
                "PatchRowcode": "                 session_id = request.COOKIES[settings.SESSION_COOKIE_NAME]"
            },
            "8": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 42,
                "PatchRowcode": "             except KeyError:"
            },
            "9": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 45,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "             csrf_token = _make_token(session_id)"
            },
            "11": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "             # check incoming token"
            },
            "12": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            try:"
            },
            "13": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                request_csrf_token = request.POST['csrfmiddlewaretoken']"
            },
            "14": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            except KeyError:"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 48,
                "PatchRowcode": "+            request_csrf_token = request.POST.get('csrfmiddlewaretoken', '')"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+            if request_csrf_token == \"\":"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+                # Fall back to X-CSRFToken, to make things easier for AJAX"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+                request_csrf_token = request.META.get('HTTP_X_CSRFTOKEN', '')"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+            if request_csrf_token == \"\":"
            },
            "21": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "                 return HttpResponseForbidden(_ERROR_MSG)"
            },
            "22": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 55,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "             if request_csrf_token != csrf_token:"
            }
        },
        "frontPatchFile": [
            "\"\"\"",
            "Cross Site Request Forgery Middleware.",
            "",
            "This module provides a middleware that implements protection",
            "against request forgeries from other sites.",
            "\"\"\"",
            "",
            "import re",
            "import itertools",
            "try:",
            "    from functools import wraps",
            "except ImportError:",
            "    from django.utils.functional import wraps  # Python 2.3, 2.4 fallback.",
            "",
            "from django.conf import settings",
            "from django.http import HttpResponseForbidden",
            "from django.utils.hashcompat import md5_constructor",
            "from django.utils.safestring import mark_safe",
            "",
            "_ERROR_MSG = mark_safe('<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\"><body><h1>403 Forbidden</h1><p>Cross Site Request Forgery detected. Request aborted.</p></body></html>')",
            "",
            "_POST_FORM_RE = \\",
            "    re.compile(r'(<form\\W[^>]*\\bmethod\\s*=\\s*(\\'|\"|)POST(\\'|\"|)\\b[^>]*>)', re.IGNORECASE)",
            "",
            "_HTML_TYPES = ('text/html', 'application/xhtml+xml')",
            "",
            "def _make_token(session_id):",
            "    return md5_constructor(settings.SECRET_KEY + session_id).hexdigest()",
            "",
            "class CsrfViewMiddleware(object):",
            "    \"\"\"",
            "    Middleware that requires a present and correct csrfmiddlewaretoken",
            "    for POST requests that have an active session.",
            "    \"\"\"",
            "    def process_view(self, request, callback, callback_args, callback_kwargs):",
            "        if request.method == 'POST':",
            "            if getattr(callback, 'csrf_exempt', False):",
            "                return None",
            "",
            "            if request.is_ajax():",
            "                return None",
            "",
            "            try:",
            "                session_id = request.COOKIES[settings.SESSION_COOKIE_NAME]",
            "            except KeyError:",
            "                # No session, no check required",
            "                return None",
            "",
            "            csrf_token = _make_token(session_id)",
            "            # check incoming token",
            "            try:",
            "                request_csrf_token = request.POST['csrfmiddlewaretoken']",
            "            except KeyError:",
            "                return HttpResponseForbidden(_ERROR_MSG)",
            "",
            "            if request_csrf_token != csrf_token:",
            "                return HttpResponseForbidden(_ERROR_MSG)",
            "",
            "        return None",
            "",
            "class CsrfResponseMiddleware(object):",
            "    \"\"\"",
            "    Middleware that post-processes a response to add a",
            "    csrfmiddlewaretoken if the response/request have an active",
            "    session.",
            "    \"\"\"",
            "    def process_response(self, request, response):",
            "        if getattr(response, 'csrf_exempt', False):",
            "            return response",
            "",
            "        csrf_token = None",
            "        try:",
            "            # This covers a corner case in which the outgoing response",
            "            # both contains a form and sets a session cookie.  This",
            "            # really should not be needed, since it is best if views",
            "            # that create a new session (login pages) also do a",
            "            # redirect, as is done by all such view functions in",
            "            # Django.",
            "            cookie = response.cookies[settings.SESSION_COOKIE_NAME]",
            "            csrf_token = _make_token(cookie.value)",
            "        except KeyError:",
            "            # Normal case - look for existing session cookie",
            "            try:",
            "                session_id = request.COOKIES[settings.SESSION_COOKIE_NAME]",
            "                csrf_token = _make_token(session_id)",
            "            except KeyError:",
            "                # no incoming or outgoing cookie",
            "                pass",
            "",
            "        if csrf_token is not None and \\",
            "                response['Content-Type'].split(';')[0] in _HTML_TYPES:",
            "",
            "            # ensure we don't add the 'id' attribute twice (HTML validity)",
            "            idattributes = itertools.chain((\"id='csrfmiddlewaretoken'\",),",
            "                                            itertools.repeat(''))",
            "            def add_csrf_field(match):",
            "                \"\"\"Returns the matched <form> tag plus the added <input> element\"\"\"",
            "                return mark_safe(match.group() + \"<div style='display:none;'>\" + \\",
            "                \"<input type='hidden' \" + idattributes.next() + \\",
            "                \" name='csrfmiddlewaretoken' value='\" + csrf_token + \\",
            "                \"' /></div>\")",
            "",
            "            # Modify any POST forms",
            "            response.content, n = _POST_FORM_RE.subn(add_csrf_field, response.content)",
            "            if n > 0:",
            "                # Since the content has been modified, any Etag will now be",
            "                # incorrect.  We could recalculate, but only is we assume that",
            "                # the Etag was set by CommonMiddleware. The safest thing is just",
            "                # to delete. See bug #9163",
            "                del response['ETag']",
            "        return response",
            "",
            "class CsrfMiddleware(CsrfViewMiddleware, CsrfResponseMiddleware):",
            "    \"\"\"Django middleware that adds protection against Cross Site",
            "    Request Forgeries by adding hidden form fields to POST forms and",
            "    checking requests for the correct value.",
            "",
            "    In the list of middlewares, SessionMiddleware is required, and",
            "    must come after this middleware.  CsrfMiddleWare must come after",
            "    compression middleware.",
            "",
            "    If a session ID cookie is present, it is hashed with the",
            "    SECRET_KEY setting to create an authentication token.  This token",
            "    is added to all outgoing POST forms and is expected on all",
            "    incoming POST requests that have a session ID cookie.",
            "",
            "    If you are setting cookies directly, instead of using Django's",
            "    session framework, this middleware will not work.",
            "",
            "    CsrfMiddleWare is composed of two middleware, CsrfViewMiddleware",
            "    and CsrfResponseMiddleware which can be used independently.",
            "    \"\"\"",
            "    pass",
            "",
            "def csrf_response_exempt(view_func):",
            "    \"\"\"",
            "    Modifies a view function so that its response is exempt",
            "    from the post-processing of the CSRF middleware.",
            "    \"\"\"",
            "    def wrapped_view(*args, **kwargs):",
            "        resp = view_func(*args, **kwargs)",
            "        resp.csrf_exempt = True",
            "        return resp",
            "    return wraps(view_func)(wrapped_view)",
            "",
            "def csrf_view_exempt(view_func):",
            "    \"\"\"",
            "    Marks a view function as being exempt from CSRF view protection.",
            "    \"\"\"",
            "    # We could just do view_func.csrf_exempt = True, but decorators",
            "    # are nicer if they don't have side-effects, so we return a new",
            "    # function.",
            "    def wrapped_view(*args, **kwargs):",
            "        return view_func(*args, **kwargs)",
            "    wrapped_view.csrf_exempt = True",
            "    return wraps(view_func)(wrapped_view)",
            "",
            "def csrf_exempt(view_func):",
            "    \"\"\"",
            "    Marks a view function as being exempt from the CSRF checks",
            "    and post processing.",
            "",
            "    This is the same as using both the csrf_view_exempt and",
            "    csrf_response_exempt decorators.",
            "    \"\"\"",
            "    return csrf_response_exempt(csrf_view_exempt(view_func))"
        ],
        "afterPatchFile": [
            "\"\"\"",
            "Cross Site Request Forgery Middleware.",
            "",
            "This module provides a middleware that implements protection",
            "against request forgeries from other sites.",
            "\"\"\"",
            "",
            "import re",
            "import itertools",
            "try:",
            "    from functools import wraps",
            "except ImportError:",
            "    from django.utils.functional import wraps  # Python 2.3, 2.4 fallback.",
            "",
            "from django.conf import settings",
            "from django.http import HttpResponseForbidden",
            "from django.utils.hashcompat import md5_constructor",
            "from django.utils.safestring import mark_safe",
            "",
            "_ERROR_MSG = mark_safe('<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\"><body><h1>403 Forbidden</h1><p>Cross Site Request Forgery detected. Request aborted.</p></body></html>')",
            "",
            "_POST_FORM_RE = \\",
            "    re.compile(r'(<form\\W[^>]*\\bmethod\\s*=\\s*(\\'|\"|)POST(\\'|\"|)\\b[^>]*>)', re.IGNORECASE)",
            "",
            "_HTML_TYPES = ('text/html', 'application/xhtml+xml')",
            "",
            "def _make_token(session_id):",
            "    return md5_constructor(settings.SECRET_KEY + session_id).hexdigest()",
            "",
            "class CsrfViewMiddleware(object):",
            "    \"\"\"",
            "    Middleware that requires a present and correct csrfmiddlewaretoken",
            "    for POST requests that have an active session.",
            "    \"\"\"",
            "    def process_view(self, request, callback, callback_args, callback_kwargs):",
            "        if request.method == 'POST':",
            "            if getattr(callback, 'csrf_exempt', False):",
            "                return None",
            "",
            "            try:",
            "                session_id = request.COOKIES[settings.SESSION_COOKIE_NAME]",
            "            except KeyError:",
            "                # No session, no check required",
            "                return None",
            "",
            "            csrf_token = _make_token(session_id)",
            "            # check incoming token",
            "            request_csrf_token = request.POST.get('csrfmiddlewaretoken', '')",
            "            if request_csrf_token == \"\":",
            "                # Fall back to X-CSRFToken, to make things easier for AJAX",
            "                request_csrf_token = request.META.get('HTTP_X_CSRFTOKEN', '')",
            "",
            "            if request_csrf_token == \"\":",
            "                return HttpResponseForbidden(_ERROR_MSG)",
            "",
            "            if request_csrf_token != csrf_token:",
            "                return HttpResponseForbidden(_ERROR_MSG)",
            "",
            "        return None",
            "",
            "class CsrfResponseMiddleware(object):",
            "    \"\"\"",
            "    Middleware that post-processes a response to add a",
            "    csrfmiddlewaretoken if the response/request have an active",
            "    session.",
            "    \"\"\"",
            "    def process_response(self, request, response):",
            "        if getattr(response, 'csrf_exempt', False):",
            "            return response",
            "",
            "        csrf_token = None",
            "        try:",
            "            # This covers a corner case in which the outgoing response",
            "            # both contains a form and sets a session cookie.  This",
            "            # really should not be needed, since it is best if views",
            "            # that create a new session (login pages) also do a",
            "            # redirect, as is done by all such view functions in",
            "            # Django.",
            "            cookie = response.cookies[settings.SESSION_COOKIE_NAME]",
            "            csrf_token = _make_token(cookie.value)",
            "        except KeyError:",
            "            # Normal case - look for existing session cookie",
            "            try:",
            "                session_id = request.COOKIES[settings.SESSION_COOKIE_NAME]",
            "                csrf_token = _make_token(session_id)",
            "            except KeyError:",
            "                # no incoming or outgoing cookie",
            "                pass",
            "",
            "        if csrf_token is not None and \\",
            "                response['Content-Type'].split(';')[0] in _HTML_TYPES:",
            "",
            "            # ensure we don't add the 'id' attribute twice (HTML validity)",
            "            idattributes = itertools.chain((\"id='csrfmiddlewaretoken'\",),",
            "                                            itertools.repeat(''))",
            "            def add_csrf_field(match):",
            "                \"\"\"Returns the matched <form> tag plus the added <input> element\"\"\"",
            "                return mark_safe(match.group() + \"<div style='display:none;'>\" + \\",
            "                \"<input type='hidden' \" + idattributes.next() + \\",
            "                \" name='csrfmiddlewaretoken' value='\" + csrf_token + \\",
            "                \"' /></div>\")",
            "",
            "            # Modify any POST forms",
            "            response.content, n = _POST_FORM_RE.subn(add_csrf_field, response.content)",
            "            if n > 0:",
            "                # Since the content has been modified, any Etag will now be",
            "                # incorrect.  We could recalculate, but only is we assume that",
            "                # the Etag was set by CommonMiddleware. The safest thing is just",
            "                # to delete. See bug #9163",
            "                del response['ETag']",
            "        return response",
            "",
            "class CsrfMiddleware(CsrfViewMiddleware, CsrfResponseMiddleware):",
            "    \"\"\"Django middleware that adds protection against Cross Site",
            "    Request Forgeries by adding hidden form fields to POST forms and",
            "    checking requests for the correct value.",
            "",
            "    In the list of middlewares, SessionMiddleware is required, and",
            "    must come after this middleware.  CsrfMiddleWare must come after",
            "    compression middleware.",
            "",
            "    If a session ID cookie is present, it is hashed with the",
            "    SECRET_KEY setting to create an authentication token.  This token",
            "    is added to all outgoing POST forms and is expected on all",
            "    incoming POST requests that have a session ID cookie.",
            "",
            "    If you are setting cookies directly, instead of using Django's",
            "    session framework, this middleware will not work.",
            "",
            "    CsrfMiddleWare is composed of two middleware, CsrfViewMiddleware",
            "    and CsrfResponseMiddleware which can be used independently.",
            "    \"\"\"",
            "    pass",
            "",
            "def csrf_response_exempt(view_func):",
            "    \"\"\"",
            "    Modifies a view function so that its response is exempt",
            "    from the post-processing of the CSRF middleware.",
            "    \"\"\"",
            "    def wrapped_view(*args, **kwargs):",
            "        resp = view_func(*args, **kwargs)",
            "        resp.csrf_exempt = True",
            "        return resp",
            "    return wraps(view_func)(wrapped_view)",
            "",
            "def csrf_view_exempt(view_func):",
            "    \"\"\"",
            "    Marks a view function as being exempt from CSRF view protection.",
            "    \"\"\"",
            "    # We could just do view_func.csrf_exempt = True, but decorators",
            "    # are nicer if they don't have side-effects, so we return a new",
            "    # function.",
            "    def wrapped_view(*args, **kwargs):",
            "        return view_func(*args, **kwargs)",
            "    wrapped_view.csrf_exempt = True",
            "    return wraps(view_func)(wrapped_view)",
            "",
            "def csrf_exempt(view_func):",
            "    \"\"\"",
            "    Marks a view function as being exempt from the CSRF checks",
            "    and post processing.",
            "",
            "    This is the same as using both the csrf_view_exempt and",
            "    csrf_response_exempt decorators.",
            "    \"\"\"",
            "    return csrf_response_exempt(csrf_view_exempt(view_func))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "40": [
                "CsrfViewMiddleware",
                "process_view"
            ],
            "41": [
                "CsrfViewMiddleware",
                "process_view"
            ],
            "42": [
                "CsrfViewMiddleware",
                "process_view"
            ],
            "51": [
                "CsrfViewMiddleware",
                "process_view"
            ],
            "52": [
                "CsrfViewMiddleware",
                "process_view"
            ],
            "53": [
                "CsrfViewMiddleware",
                "process_view"
            ]
        },
        "addLocation": []
    },
    "django/contrib/csrf/tests.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 135,
                "PatchRowcode": "         req2 = CsrfMiddleware().process_view(req, csrf_exempt(self.get_view()), (), {})"
            },
            "1": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 136,
                "PatchRowcode": "         self.assertEquals(None, req2)"
            },
            "2": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 137,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def test_ajax_exemption(self):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+    def test_csrf_token_in_header(self):"
            },
            "5": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 139,
                "PatchRowcode": "         \"\"\""
            },
            "6": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        Check that AJAX requests are automatically exempted."
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+        Check that we can pass in the token in a header instead of in the form"
            },
            "8": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": 141,
                "PatchRowcode": "         \"\"\""
            },
            "9": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": 142,
                "PatchRowcode": "         req = self._get_POST_session_request()"
            },
            "10": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        req.META['HTTP_X_REQUESTED_WITH'] = 'XMLHttpRequest'"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+        req.META['HTTP_X_CSRFTOKEN'] = _make_token(self._session_id)"
            },
            "12": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": 144,
                "PatchRowcode": "         req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})"
            },
            "13": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": 145,
                "PatchRowcode": "         self.assertEquals(None, req2)"
            },
            "14": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": 146,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "",
            "from django.test import TestCase",
            "from django.http import HttpRequest, HttpResponse, HttpResponseForbidden",
            "from django.contrib.csrf.middleware import CsrfMiddleware, _make_token, csrf_exempt",
            "from django.conf import settings",
            "from django.template import Template",
            "",
            "",
            "def post_form_response():",
            "    resp = HttpResponse(content=\"\"\"",
            "<html><body><form method=\"post\"><input type=\"text\" /></form></body></html>",
            "\"\"\", mimetype=\"text/html\")",
            "    return resp",
            "",
            "def test_view(request):",
            "    return post_form_response()",
            "",
            "class CsrfMiddlewareTest(TestCase):",
            "",
            "    _session_id = \"1\"",
            "",
            "    def _get_GET_no_session_request(self):",
            "        return HttpRequest()",
            "",
            "    def _get_GET_session_request(self):",
            "        req = self._get_GET_no_session_request()",
            "        req.COOKIES[settings.SESSION_COOKIE_NAME] = self._session_id",
            "        return req",
            "",
            "    def _get_POST_session_request(self):",
            "        req = self._get_GET_session_request()",
            "        req.method = \"POST\"",
            "        return req",
            "",
            "    def _get_POST_no_session_request(self):",
            "        req = self._get_GET_no_session_request()",
            "        req.method = \"POST\"",
            "        return req",
            "",
            "    def _get_POST_session_request_with_token(self):",
            "        req = self._get_POST_session_request()",
            "        req.POST['csrfmiddlewaretoken'] = _make_token(self._session_id)",
            "        return req",
            "",
            "    def _get_post_form_response(self):",
            "        return post_form_response()",
            "",
            "    def _get_new_session_response(self):",
            "        resp = self._get_post_form_response()",
            "        resp.cookies[settings.SESSION_COOKIE_NAME] = self._session_id",
            "        return resp",
            "",
            "    def _check_token_present(self, response):",
            "        self.assertContains(response, \"name='csrfmiddlewaretoken' value='%s'\" % _make_token(self._session_id))",
            "",
            "    def get_view(self):",
            "        return test_view",
            "",
            "    # Check the post processing",
            "    def test_process_response_no_session(self):",
            "        \"\"\"",
            "        Check the post-processor does nothing if no session active",
            "        \"\"\"",
            "        req = self._get_GET_no_session_request()",
            "        resp = self._get_post_form_response()",
            "        resp_content = resp.content # needed because process_response modifies resp",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertEquals(resp_content, resp2.content)",
            "",
            "    def test_process_response_existing_session(self):",
            "        \"\"\"",
            "        Check that the token is inserted if there is an existing session",
            "        \"\"\"",
            "        req = self._get_GET_session_request()",
            "        resp = self._get_post_form_response()",
            "        resp_content = resp.content # needed because process_response modifies resp",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertNotEqual(resp_content, resp2.content)",
            "        self._check_token_present(resp2)",
            "",
            "    def test_process_response_new_session(self):",
            "        \"\"\"",
            "        Check that the token is inserted if there is a new session being started",
            "        \"\"\"",
            "        req = self._get_GET_no_session_request() # no session in request",
            "        resp = self._get_new_session_response() # but new session started",
            "        resp_content = resp.content # needed because process_response modifies resp",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertNotEqual(resp_content, resp2.content)",
            "        self._check_token_present(resp2)",
            "",
            "    def test_process_response_exempt_view(self):",
            "        \"\"\"",
            "        Check that no post processing is done for an exempt view",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        resp = csrf_exempt(self.get_view())(req)",
            "        resp_content = resp.content",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertEquals(resp_content, resp2.content)",
            "",
            "    # Check the request processing",
            "    def test_process_request_no_session(self):",
            "        \"\"\"",
            "        Check that if no session is present, the middleware does nothing.",
            "        to the incoming request.",
            "        \"\"\"",
            "        req = self._get_POST_no_session_request()",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_process_request_session_no_token(self):",
            "        \"\"\"",
            "        Check that if a session is present but no token, we get a 'forbidden'",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(HttpResponseForbidden, req2.__class__)",
            "",
            "    def test_process_request_session_and_token(self):",
            "        \"\"\"",
            "        Check that if a session is present and a token, the middleware lets it through",
            "        \"\"\"",
            "        req = self._get_POST_session_request_with_token()",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_process_request_session_no_token_exempt_view(self):",
            "        \"\"\"",
            "        Check that if a session is present and no token, but the csrf_exempt",
            "        decorator has been applied to the view, the middleware lets it through",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        req2 = CsrfMiddleware().process_view(req, csrf_exempt(self.get_view()), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_ajax_exemption(self):",
            "        \"\"\"",
            "        Check that AJAX requests are automatically exempted.",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        req.META['HTTP_X_REQUESTED_WITH'] = 'XMLHttpRequest'",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_template_tag_noop(self):",
            "        \"\"\"",
            "        Check that the {% csrf_token %} works in 1.1.2 and later",
            "        \"\"\"",
            "        self.assertEquals(u\"\", Template(\"{% csrf_token %}\").render({}))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "",
            "from django.test import TestCase",
            "from django.http import HttpRequest, HttpResponse, HttpResponseForbidden",
            "from django.contrib.csrf.middleware import CsrfMiddleware, _make_token, csrf_exempt",
            "from django.conf import settings",
            "from django.template import Template",
            "",
            "",
            "def post_form_response():",
            "    resp = HttpResponse(content=\"\"\"",
            "<html><body><form method=\"post\"><input type=\"text\" /></form></body></html>",
            "\"\"\", mimetype=\"text/html\")",
            "    return resp",
            "",
            "def test_view(request):",
            "    return post_form_response()",
            "",
            "class CsrfMiddlewareTest(TestCase):",
            "",
            "    _session_id = \"1\"",
            "",
            "    def _get_GET_no_session_request(self):",
            "        return HttpRequest()",
            "",
            "    def _get_GET_session_request(self):",
            "        req = self._get_GET_no_session_request()",
            "        req.COOKIES[settings.SESSION_COOKIE_NAME] = self._session_id",
            "        return req",
            "",
            "    def _get_POST_session_request(self):",
            "        req = self._get_GET_session_request()",
            "        req.method = \"POST\"",
            "        return req",
            "",
            "    def _get_POST_no_session_request(self):",
            "        req = self._get_GET_no_session_request()",
            "        req.method = \"POST\"",
            "        return req",
            "",
            "    def _get_POST_session_request_with_token(self):",
            "        req = self._get_POST_session_request()",
            "        req.POST['csrfmiddlewaretoken'] = _make_token(self._session_id)",
            "        return req",
            "",
            "    def _get_post_form_response(self):",
            "        return post_form_response()",
            "",
            "    def _get_new_session_response(self):",
            "        resp = self._get_post_form_response()",
            "        resp.cookies[settings.SESSION_COOKIE_NAME] = self._session_id",
            "        return resp",
            "",
            "    def _check_token_present(self, response):",
            "        self.assertContains(response, \"name='csrfmiddlewaretoken' value='%s'\" % _make_token(self._session_id))",
            "",
            "    def get_view(self):",
            "        return test_view",
            "",
            "    # Check the post processing",
            "    def test_process_response_no_session(self):",
            "        \"\"\"",
            "        Check the post-processor does nothing if no session active",
            "        \"\"\"",
            "        req = self._get_GET_no_session_request()",
            "        resp = self._get_post_form_response()",
            "        resp_content = resp.content # needed because process_response modifies resp",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertEquals(resp_content, resp2.content)",
            "",
            "    def test_process_response_existing_session(self):",
            "        \"\"\"",
            "        Check that the token is inserted if there is an existing session",
            "        \"\"\"",
            "        req = self._get_GET_session_request()",
            "        resp = self._get_post_form_response()",
            "        resp_content = resp.content # needed because process_response modifies resp",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertNotEqual(resp_content, resp2.content)",
            "        self._check_token_present(resp2)",
            "",
            "    def test_process_response_new_session(self):",
            "        \"\"\"",
            "        Check that the token is inserted if there is a new session being started",
            "        \"\"\"",
            "        req = self._get_GET_no_session_request() # no session in request",
            "        resp = self._get_new_session_response() # but new session started",
            "        resp_content = resp.content # needed because process_response modifies resp",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertNotEqual(resp_content, resp2.content)",
            "        self._check_token_present(resp2)",
            "",
            "    def test_process_response_exempt_view(self):",
            "        \"\"\"",
            "        Check that no post processing is done for an exempt view",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        resp = csrf_exempt(self.get_view())(req)",
            "        resp_content = resp.content",
            "        resp2 = CsrfMiddleware().process_response(req, resp)",
            "        self.assertEquals(resp_content, resp2.content)",
            "",
            "    # Check the request processing",
            "    def test_process_request_no_session(self):",
            "        \"\"\"",
            "        Check that if no session is present, the middleware does nothing.",
            "        to the incoming request.",
            "        \"\"\"",
            "        req = self._get_POST_no_session_request()",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_process_request_session_no_token(self):",
            "        \"\"\"",
            "        Check that if a session is present but no token, we get a 'forbidden'",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(HttpResponseForbidden, req2.__class__)",
            "",
            "    def test_process_request_session_and_token(self):",
            "        \"\"\"",
            "        Check that if a session is present and a token, the middleware lets it through",
            "        \"\"\"",
            "        req = self._get_POST_session_request_with_token()",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_process_request_session_no_token_exempt_view(self):",
            "        \"\"\"",
            "        Check that if a session is present and no token, but the csrf_exempt",
            "        decorator has been applied to the view, the middleware lets it through",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        req2 = CsrfMiddleware().process_view(req, csrf_exempt(self.get_view()), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_csrf_token_in_header(self):",
            "        \"\"\"",
            "        Check that we can pass in the token in a header instead of in the form",
            "        \"\"\"",
            "        req = self._get_POST_session_request()",
            "        req.META['HTTP_X_CSRFTOKEN'] = _make_token(self._session_id)",
            "        req2 = CsrfMiddleware().process_view(req, self.get_view(), (), {})",
            "        self.assertEquals(None, req2)",
            "",
            "    def test_template_tag_noop(self):",
            "        \"\"\"",
            "        Check that the {% csrf_token %} works in 1.1.2 and later",
            "        \"\"\"",
            "        self.assertEquals(u\"\", Template(\"{% csrf_token %}\").render({}))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "138": [
                "CsrfMiddlewareTest",
                "test_ajax_exemption"
            ],
            "140": [
                "CsrfMiddlewareTest",
                "test_ajax_exemption"
            ],
            "143": [
                "CsrfMiddlewareTest",
                "test_ajax_exemption"
            ]
        },
        "addLocation": []
    }
}