{
    "src/pretix/api/views/oauth.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " from pretix.api.models import OAuthApplication"
            },
            "2": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " from pretix.base.models import Organizer"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+from pretix.control.views.user import RecentAuthenticationRequiredMixin"
            },
            "4": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " logger = logging.getLogger(__name__)"
            },
            "6": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "             del self.fields['organizers']"
            },
            "8": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 56,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 57,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class AuthorizationView(BaseAuthorizationView):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+class AuthorizationView(RecentAuthenticationRequiredMixin, BaseAuthorizationView):"
            },
            "12": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 59,
                "PatchRowcode": "     template_name = \"pretixcontrol/auth/oauth_authorization.html\""
            },
            "13": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "     form_class = OAuthAllowForm"
            },
            "14": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 61,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "import logging",
            "",
            "from django import forms",
            "from django.conf import settings",
            "from django.utils.translation import gettext as _",
            "from oauth2_provider.exceptions import FatalClientError, OAuthToolkitError",
            "from oauth2_provider.forms import AllowForm",
            "from oauth2_provider.settings import oauth2_settings",
            "from oauth2_provider.views import (",
            "    AuthorizationView as BaseAuthorizationView,",
            "    RevokeTokenView as BaseRevokeTokenView, TokenView as BaseTokenView,",
            ")",
            "",
            "from pretix.api.models import OAuthApplication",
            "from pretix.base.models import Organizer",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class OAuthAllowForm(AllowForm):",
            "    organizers = forms.ModelMultipleChoiceField(",
            "        queryset=Organizer.objects.none(),",
            "        widget=forms.CheckboxSelectMultiple",
            "    )",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        user = kwargs.pop('user')",
            "        scope = kwargs.pop('scope')",
            "        super().__init__(*args, **kwargs)",
            "        self.fields['organizers'].queryset = Organizer.objects.filter(",
            "            pk__in=user.teams.values_list('organizer', flat=True))",
            "        if scope == 'profile':",
            "            del self.fields['organizers']",
            "",
            "",
            "class AuthorizationView(BaseAuthorizationView):",
            "    template_name = \"pretixcontrol/auth/oauth_authorization.html\"",
            "    form_class = OAuthAllowForm",
            "",
            "    def get_form_kwargs(self):",
            "        kwargs = super().get_form_kwargs()",
            "        kwargs['user'] = self.request.user",
            "        kwargs['scope'] = self.request.GET.get('scope')",
            "        return kwargs",
            "",
            "    def get_context_data(self, **kwargs):",
            "        ctx = super().get_context_data(**kwargs)",
            "        ctx['settings'] = settings",
            "        return ctx",
            "",
            "    def validate_authorization_request(self, request):",
            "        require_approval = request.GET.get(\"approval_prompt\", oauth2_settings.REQUEST_APPROVAL_PROMPT)",
            "        if require_approval != 'force' and request.GET.get('scope') != 'profile':",
            "            raise FatalClientError('Combnination of require_approval and scope values not allowed.')",
            "        return super().validate_authorization_request(request)",
            "",
            "    def create_authorization_response(self, request, scopes, credentials, allow, organizers=None):",
            "        credentials[\"organizers\"] = organizers or []",
            "        return super().create_authorization_response(request, scopes, credentials, allow)",
            "",
            "    def form_valid(self, form):",
            "        client_id = form.cleaned_data[\"client_id\"]",
            "        application = OAuthApplication.objects.get(client_id=client_id)",
            "        credentials = {",
            "            \"client_id\": form.cleaned_data.get(\"client_id\"),",
            "            \"redirect_uri\": form.cleaned_data.get(\"redirect_uri\"),",
            "            \"response_type\": form.cleaned_data.get(\"response_type\", None),",
            "            \"state\": form.cleaned_data.get(\"state\", None),",
            "        }",
            "        scopes = form.cleaned_data.get(\"scope\")",
            "        allow = form.cleaned_data.get(\"allow\")",
            "",
            "        try:",
            "            uri, headers, body, status = self.create_authorization_response(",
            "                request=self.request, scopes=scopes, credentials=credentials, allow=allow,",
            "                organizers=form.cleaned_data.get(\"organizers\")",
            "            )",
            "        except OAuthToolkitError as error:",
            "            return self.error_response(error, application)",
            "",
            "        self.success_url = uri",
            "        logger.debug(\"Success url for the request: {0}\".format(self.success_url))",
            "",
            "        msgs = [",
            "            _('The application \"{application_name}\" has been authorized to access your account.').format(",
            "                application_name=application.name",
            "            )",
            "        ]",
            "        self.request.user.send_security_notice(msgs)",
            "        self.request.user.log_action('pretix.user.oauth.authorized', user=self.request.user, data={",
            "            'application_id': application.pk,",
            "            'application_name': application.name,",
            "        })",
            "",
            "        return self.redirect(self.success_url, application)",
            "",
            "",
            "class TokenView(BaseTokenView):",
            "    pass",
            "",
            "",
            "class RevokeTokenView(BaseRevokeTokenView):",
            "    pass"
        ],
        "afterPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "import logging",
            "",
            "from django import forms",
            "from django.conf import settings",
            "from django.utils.translation import gettext as _",
            "from oauth2_provider.exceptions import FatalClientError, OAuthToolkitError",
            "from oauth2_provider.forms import AllowForm",
            "from oauth2_provider.settings import oauth2_settings",
            "from oauth2_provider.views import (",
            "    AuthorizationView as BaseAuthorizationView,",
            "    RevokeTokenView as BaseRevokeTokenView, TokenView as BaseTokenView,",
            ")",
            "",
            "from pretix.api.models import OAuthApplication",
            "from pretix.base.models import Organizer",
            "from pretix.control.views.user import RecentAuthenticationRequiredMixin",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class OAuthAllowForm(AllowForm):",
            "    organizers = forms.ModelMultipleChoiceField(",
            "        queryset=Organizer.objects.none(),",
            "        widget=forms.CheckboxSelectMultiple",
            "    )",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        user = kwargs.pop('user')",
            "        scope = kwargs.pop('scope')",
            "        super().__init__(*args, **kwargs)",
            "        self.fields['organizers'].queryset = Organizer.objects.filter(",
            "            pk__in=user.teams.values_list('organizer', flat=True))",
            "        if scope == 'profile':",
            "            del self.fields['organizers']",
            "",
            "",
            "class AuthorizationView(RecentAuthenticationRequiredMixin, BaseAuthorizationView):",
            "    template_name = \"pretixcontrol/auth/oauth_authorization.html\"",
            "    form_class = OAuthAllowForm",
            "",
            "    def get_form_kwargs(self):",
            "        kwargs = super().get_form_kwargs()",
            "        kwargs['user'] = self.request.user",
            "        kwargs['scope'] = self.request.GET.get('scope')",
            "        return kwargs",
            "",
            "    def get_context_data(self, **kwargs):",
            "        ctx = super().get_context_data(**kwargs)",
            "        ctx['settings'] = settings",
            "        return ctx",
            "",
            "    def validate_authorization_request(self, request):",
            "        require_approval = request.GET.get(\"approval_prompt\", oauth2_settings.REQUEST_APPROVAL_PROMPT)",
            "        if require_approval != 'force' and request.GET.get('scope') != 'profile':",
            "            raise FatalClientError('Combnination of require_approval and scope values not allowed.')",
            "        return super().validate_authorization_request(request)",
            "",
            "    def create_authorization_response(self, request, scopes, credentials, allow, organizers=None):",
            "        credentials[\"organizers\"] = organizers or []",
            "        return super().create_authorization_response(request, scopes, credentials, allow)",
            "",
            "    def form_valid(self, form):",
            "        client_id = form.cleaned_data[\"client_id\"]",
            "        application = OAuthApplication.objects.get(client_id=client_id)",
            "        credentials = {",
            "            \"client_id\": form.cleaned_data.get(\"client_id\"),",
            "            \"redirect_uri\": form.cleaned_data.get(\"redirect_uri\"),",
            "            \"response_type\": form.cleaned_data.get(\"response_type\", None),",
            "            \"state\": form.cleaned_data.get(\"state\", None),",
            "        }",
            "        scopes = form.cleaned_data.get(\"scope\")",
            "        allow = form.cleaned_data.get(\"allow\")",
            "",
            "        try:",
            "            uri, headers, body, status = self.create_authorization_response(",
            "                request=self.request, scopes=scopes, credentials=credentials, allow=allow,",
            "                organizers=form.cleaned_data.get(\"organizers\")",
            "            )",
            "        except OAuthToolkitError as error:",
            "            return self.error_response(error, application)",
            "",
            "        self.success_url = uri",
            "        logger.debug(\"Success url for the request: {0}\".format(self.success_url))",
            "",
            "        msgs = [",
            "            _('The application \"{application_name}\" has been authorized to access your account.').format(",
            "                application_name=application.name",
            "            )",
            "        ]",
            "        self.request.user.send_security_notice(msgs)",
            "        self.request.user.log_action('pretix.user.oauth.authorized', user=self.request.user, data={",
            "            'application_id': application.pk,",
            "            'application_name': application.name,",
            "        })",
            "",
            "        return self.redirect(self.success_url, application)",
            "",
            "",
            "class TokenView(BaseTokenView):",
            "    pass",
            "",
            "",
            "class RevokeTokenView(BaseRevokeTokenView):",
            "    pass"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "57": [
                "AuthorizationView"
            ]
        },
        "addLocation": []
    },
    "src/pretix/control/middleware.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "         url = resolve(request.path_info)"
            },
            "1": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 113,
                "PatchRowcode": "         url_name = url.url_name"
            },
            "2": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 114,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if not request.path.startswith(get_script_prefix() + 'control'):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+        if not request.path.startswith(get_script_prefix() + 'control') and not (url.namespace.startswith(\"api-\") and url_name == \"authorize\"):"
            },
            "5": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 116,
                "PatchRowcode": "             # This middleware should only touch the /control subpath"
            },
            "6": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "             return self.get_response(request)"
            },
            "7": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 118,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "",
            "# This file is based on an earlier version of pretix which was released under the Apache License 2.0. The full text of",
            "# the Apache License 2.0 can be obtained at <http://www.apache.org/licenses/LICENSE-2.0>.",
            "#",
            "# This file may have since been changed and any changes are released under the terms of AGPLv3 as described above. A",
            "# full history of changes and contributors is available at <https://github.com/pretix/pretix>.",
            "#",
            "# This file contains Apache-licensed contributions copyrighted by: Tobias Kunze",
            "#",
            "# Unless required by applicable law or agreed to in writing, software distributed under the Apache License 2.0 is",
            "# distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations under the License.",
            "",
            "from urllib.parse import quote, urljoin, urlparse",
            "",
            "from django.conf import settings",
            "from django.contrib.auth import REDIRECT_FIELD_NAME, logout",
            "from django.http import Http404",
            "from django.shortcuts import get_object_or_404, redirect, resolve_url",
            "from django.template.response import TemplateResponse",
            "from django.urls import get_script_prefix, resolve, reverse",
            "from django.utils.encoding import force_str",
            "from django.utils.translation import gettext as _",
            "from django_scopes import scope",
            "",
            "from pretix.base.models import Event, Organizer",
            "from pretix.base.models.auth import SuperuserPermissionSet, User",
            "from pretix.helpers.security import (",
            "    SessionInvalid, SessionReauthRequired, assert_session_valid,",
            ")",
            "",
            "",
            "class PermissionMiddleware:",
            "    \"\"\"",
            "    This middleware enforces all requests to the control app to require login.",
            "    Additionally, it enforces all requests to \"control:event.\" URLs",
            "    to be for an event the user has basic access to.",
            "    \"\"\"",
            "",
            "    EXCEPTIONS = (",
            "        \"auth.login\",",
            "        \"auth.login.2fa\",",
            "        \"auth.register\",",
            "        \"auth.forgot\",",
            "        \"auth.forgot.recover\",",
            "        \"auth.invite\",",
            "        \"user.settings.notifications.off\",",
            "    )",
            "",
            "    EXCEPTIONS_FORCED_PW_CHANGE = (",
            "        \"user.settings\",",
            "        \"auth.logout\"",
            "    )",
            "",
            "    EXCEPTIONS_2FA = (",
            "        \"user.settings.2fa\",",
            "        \"user.settings.2fa.add\",",
            "        \"user.settings.2fa.enable\",",
            "        \"user.settings.2fa.disable\",",
            "        \"user.settings.2fa.regenemergency\",",
            "        \"user.settings.2fa.confirm.totp\",",
            "        \"user.settings.2fa.confirm.u2f\",",
            "        \"user.settings.2fa.delete\",",
            "        \"auth.logout\",",
            "        \"user.reauth\"",
            "    )",
            "",
            "    def __init__(self, get_response=None):",
            "        self.get_response = get_response",
            "        super().__init__()",
            "",
            "    def _login_redirect(self, request):",
            "        # Taken from django/contrib/auth/decorators.py",
            "        path = request.build_absolute_uri()",
            "        # urlparse chokes on lazy objects in Python 3, force to str",
            "        resolved_login_url = force_str(",
            "            resolve_url(settings.LOGIN_URL_CONTROL))",
            "        # If the login url is the same scheme and net location then just",
            "        # use the path as the \"next\" url.",
            "        login_scheme, login_netloc = urlparse(resolved_login_url)[:2]",
            "        current_scheme, current_netloc = urlparse(path)[:2]",
            "        if ((not login_scheme or login_scheme == current_scheme) and",
            "                (not login_netloc or login_netloc == current_netloc)):",
            "            path = request.get_full_path()",
            "        from django.contrib.auth.views import redirect_to_login",
            "",
            "        return redirect_to_login(",
            "            path, resolved_login_url, REDIRECT_FIELD_NAME)",
            "",
            "    def __call__(self, request):",
            "        url = resolve(request.path_info)",
            "        url_name = url.url_name",
            "",
            "        if not request.path.startswith(get_script_prefix() + 'control'):",
            "            # This middleware should only touch the /control subpath",
            "            return self.get_response(request)",
            "",
            "        if hasattr(request, 'organizer'):",
            "            # If the user is on a organizer's subdomain, he should be redirected to pretix",
            "            return redirect(urljoin(settings.SITE_URL, request.get_full_path()))",
            "        if url_name in self.EXCEPTIONS:",
            "            return self.get_response(request)",
            "        if not request.user.is_authenticated:",
            "            return self._login_redirect(request)",
            "",
            "        try:",
            "            # If this logic is updated, make sure to also update the logic in pretix/api/auth/permission.py",
            "            assert_session_valid(request)",
            "        except SessionInvalid:",
            "            logout(request)",
            "            return self._login_redirect(request)",
            "        except SessionReauthRequired:",
            "            if url_name not in ('user.reauth', 'auth.logout'):",
            "                return redirect(reverse('control:user.reauth') + '?next=' + quote(request.get_full_path()))",
            "",
            "        if request.user.needs_password_change and url_name not in self.EXCEPTIONS_FORCED_PW_CHANGE:",
            "            return redirect(reverse('control:user.settings') + '?next=' + quote(request.get_full_path()))",
            "",
            "        if not request.user.require_2fa and settings.PRETIX_OBLIGATORY_2FA \\",
            "                and url_name not in self.EXCEPTIONS_2FA:",
            "            return redirect(reverse('control:user.settings.2fa'))",
            "",
            "        if 'event' in url.kwargs and 'organizer' in url.kwargs:",
            "            if url.kwargs['organizer'] == '-' and url.kwargs['event'] == '-':",
            "                # This is a hack that just takes the user to ANY event. It's useful to link to features in support",
            "                # or documentation.",
            "                ev = request.user.get_events_with_any_permission().order_by('-date_from').first()",
            "                if not ev:",
            "                    raise Http404(_(\"The selected event was not found or you \"",
            "                                    \"have no permission to administrate it.\"))",
            "                k = dict(url.kwargs)",
            "                k['organizer'] = ev.organizer.slug",
            "                k['event'] = ev.slug",
            "                return redirect(reverse(url.view_name, kwargs=k, args=url.args))",
            "",
            "            with scope(organizer=None):",
            "                request.event = Event.objects.filter(",
            "                    slug=url.kwargs['event'],",
            "                    organizer__slug=url.kwargs['organizer'],",
            "                ).select_related('organizer').first()",
            "            if not request.event or not request.user.has_event_permission(request.event.organizer, request.event,",
            "                                                                          request=request):",
            "                raise Http404(_(\"The selected event was not found or you \"",
            "                                \"have no permission to administrate it.\"))",
            "            request.organizer = request.event.organizer",
            "            if request.user.has_active_staff_session(request.session.session_key):",
            "                request.eventpermset = SuperuserPermissionSet()",
            "            else:",
            "                request.eventpermset = request.user.get_event_permission_set(request.organizer, request.event)",
            "        elif 'organizer' in url.kwargs:",
            "            if url.kwargs['organizer'] == '-':",
            "                # This is a hack that just takes the user to ANY organizer. It's useful to link to features in support",
            "                # or documentation.",
            "                org = request.user.get_organizers_with_any_permission().first()",
            "                if not org:",
            "                    raise Http404(_(\"The selected organizer was not found or you \"",
            "                                    \"have no permission to administrate it.\"))",
            "                k = dict(url.kwargs)",
            "                k['organizer'] = org.slug",
            "                return redirect(reverse(url.view_name, kwargs=k, args=url.args))",
            "",
            "            request.organizer = Organizer.objects.filter(",
            "                slug=url.kwargs['organizer'],",
            "            ).first()",
            "            if not request.organizer or not request.user.has_organizer_permission(request.organizer, request=request):",
            "                raise Http404(_(\"The selected organizer was not found or you \"",
            "                                \"have no permission to administrate it.\"))",
            "            if request.user.has_active_staff_session(request.session.session_key):",
            "                request.orgapermset = SuperuserPermissionSet()",
            "            else:",
            "                request.orgapermset = request.user.get_organizer_permission_set(request.organizer)",
            "",
            "        with scope(organizer=getattr(request, 'organizer', None)):",
            "            r = self.get_response(request)",
            "            if isinstance(r, TemplateResponse):",
            "                r = r.render()",
            "            return r",
            "",
            "",
            "class AuditLogMiddleware:",
            "",
            "    def __init__(self, get_response):",
            "        self.get_response = get_response",
            "",
            "    def __call__(self, request):",
            "        if request.path.startswith(get_script_prefix() + 'control') and request.user.is_authenticated:",
            "            if getattr(request.user, \"is_hijacked\", False):",
            "                hijack_history = request.session.get('hijack_history', False)",
            "                hijacker = get_object_or_404(User, pk=hijack_history[0])",
            "                ss = hijacker.get_active_staff_session(request.session.get('hijacker_session'))",
            "                if ss:",
            "                    ss.logs.create(",
            "                        url=request.path,",
            "                        method=request.method,",
            "                        impersonating=request.user",
            "                    )",
            "            else:",
            "                ss = request.user.get_active_staff_session(request.session.session_key)",
            "                if ss:",
            "                    ss.logs.create(",
            "                        url=request.path,",
            "                        method=request.method",
            "                    )",
            "",
            "        response = self.get_response(request)",
            "        return response"
        ],
        "afterPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "",
            "# This file is based on an earlier version of pretix which was released under the Apache License 2.0. The full text of",
            "# the Apache License 2.0 can be obtained at <http://www.apache.org/licenses/LICENSE-2.0>.",
            "#",
            "# This file may have since been changed and any changes are released under the terms of AGPLv3 as described above. A",
            "# full history of changes and contributors is available at <https://github.com/pretix/pretix>.",
            "#",
            "# This file contains Apache-licensed contributions copyrighted by: Tobias Kunze",
            "#",
            "# Unless required by applicable law or agreed to in writing, software distributed under the Apache License 2.0 is",
            "# distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations under the License.",
            "",
            "from urllib.parse import quote, urljoin, urlparse",
            "",
            "from django.conf import settings",
            "from django.contrib.auth import REDIRECT_FIELD_NAME, logout",
            "from django.http import Http404",
            "from django.shortcuts import get_object_or_404, redirect, resolve_url",
            "from django.template.response import TemplateResponse",
            "from django.urls import get_script_prefix, resolve, reverse",
            "from django.utils.encoding import force_str",
            "from django.utils.translation import gettext as _",
            "from django_scopes import scope",
            "",
            "from pretix.base.models import Event, Organizer",
            "from pretix.base.models.auth import SuperuserPermissionSet, User",
            "from pretix.helpers.security import (",
            "    SessionInvalid, SessionReauthRequired, assert_session_valid,",
            ")",
            "",
            "",
            "class PermissionMiddleware:",
            "    \"\"\"",
            "    This middleware enforces all requests to the control app to require login.",
            "    Additionally, it enforces all requests to \"control:event.\" URLs",
            "    to be for an event the user has basic access to.",
            "    \"\"\"",
            "",
            "    EXCEPTIONS = (",
            "        \"auth.login\",",
            "        \"auth.login.2fa\",",
            "        \"auth.register\",",
            "        \"auth.forgot\",",
            "        \"auth.forgot.recover\",",
            "        \"auth.invite\",",
            "        \"user.settings.notifications.off\",",
            "    )",
            "",
            "    EXCEPTIONS_FORCED_PW_CHANGE = (",
            "        \"user.settings\",",
            "        \"auth.logout\"",
            "    )",
            "",
            "    EXCEPTIONS_2FA = (",
            "        \"user.settings.2fa\",",
            "        \"user.settings.2fa.add\",",
            "        \"user.settings.2fa.enable\",",
            "        \"user.settings.2fa.disable\",",
            "        \"user.settings.2fa.regenemergency\",",
            "        \"user.settings.2fa.confirm.totp\",",
            "        \"user.settings.2fa.confirm.u2f\",",
            "        \"user.settings.2fa.delete\",",
            "        \"auth.logout\",",
            "        \"user.reauth\"",
            "    )",
            "",
            "    def __init__(self, get_response=None):",
            "        self.get_response = get_response",
            "        super().__init__()",
            "",
            "    def _login_redirect(self, request):",
            "        # Taken from django/contrib/auth/decorators.py",
            "        path = request.build_absolute_uri()",
            "        # urlparse chokes on lazy objects in Python 3, force to str",
            "        resolved_login_url = force_str(",
            "            resolve_url(settings.LOGIN_URL_CONTROL))",
            "        # If the login url is the same scheme and net location then just",
            "        # use the path as the \"next\" url.",
            "        login_scheme, login_netloc = urlparse(resolved_login_url)[:2]",
            "        current_scheme, current_netloc = urlparse(path)[:2]",
            "        if ((not login_scheme or login_scheme == current_scheme) and",
            "                (not login_netloc or login_netloc == current_netloc)):",
            "            path = request.get_full_path()",
            "        from django.contrib.auth.views import redirect_to_login",
            "",
            "        return redirect_to_login(",
            "            path, resolved_login_url, REDIRECT_FIELD_NAME)",
            "",
            "    def __call__(self, request):",
            "        url = resolve(request.path_info)",
            "        url_name = url.url_name",
            "",
            "        if not request.path.startswith(get_script_prefix() + 'control') and not (url.namespace.startswith(\"api-\") and url_name == \"authorize\"):",
            "            # This middleware should only touch the /control subpath",
            "            return self.get_response(request)",
            "",
            "        if hasattr(request, 'organizer'):",
            "            # If the user is on a organizer's subdomain, he should be redirected to pretix",
            "            return redirect(urljoin(settings.SITE_URL, request.get_full_path()))",
            "        if url_name in self.EXCEPTIONS:",
            "            return self.get_response(request)",
            "        if not request.user.is_authenticated:",
            "            return self._login_redirect(request)",
            "",
            "        try:",
            "            # If this logic is updated, make sure to also update the logic in pretix/api/auth/permission.py",
            "            assert_session_valid(request)",
            "        except SessionInvalid:",
            "            logout(request)",
            "            return self._login_redirect(request)",
            "        except SessionReauthRequired:",
            "            if url_name not in ('user.reauth', 'auth.logout'):",
            "                return redirect(reverse('control:user.reauth') + '?next=' + quote(request.get_full_path()))",
            "",
            "        if request.user.needs_password_change and url_name not in self.EXCEPTIONS_FORCED_PW_CHANGE:",
            "            return redirect(reverse('control:user.settings') + '?next=' + quote(request.get_full_path()))",
            "",
            "        if not request.user.require_2fa and settings.PRETIX_OBLIGATORY_2FA \\",
            "                and url_name not in self.EXCEPTIONS_2FA:",
            "            return redirect(reverse('control:user.settings.2fa'))",
            "",
            "        if 'event' in url.kwargs and 'organizer' in url.kwargs:",
            "            if url.kwargs['organizer'] == '-' and url.kwargs['event'] == '-':",
            "                # This is a hack that just takes the user to ANY event. It's useful to link to features in support",
            "                # or documentation.",
            "                ev = request.user.get_events_with_any_permission().order_by('-date_from').first()",
            "                if not ev:",
            "                    raise Http404(_(\"The selected event was not found or you \"",
            "                                    \"have no permission to administrate it.\"))",
            "                k = dict(url.kwargs)",
            "                k['organizer'] = ev.organizer.slug",
            "                k['event'] = ev.slug",
            "                return redirect(reverse(url.view_name, kwargs=k, args=url.args))",
            "",
            "            with scope(organizer=None):",
            "                request.event = Event.objects.filter(",
            "                    slug=url.kwargs['event'],",
            "                    organizer__slug=url.kwargs['organizer'],",
            "                ).select_related('organizer').first()",
            "            if not request.event or not request.user.has_event_permission(request.event.organizer, request.event,",
            "                                                                          request=request):",
            "                raise Http404(_(\"The selected event was not found or you \"",
            "                                \"have no permission to administrate it.\"))",
            "            request.organizer = request.event.organizer",
            "            if request.user.has_active_staff_session(request.session.session_key):",
            "                request.eventpermset = SuperuserPermissionSet()",
            "            else:",
            "                request.eventpermset = request.user.get_event_permission_set(request.organizer, request.event)",
            "        elif 'organizer' in url.kwargs:",
            "            if url.kwargs['organizer'] == '-':",
            "                # This is a hack that just takes the user to ANY organizer. It's useful to link to features in support",
            "                # or documentation.",
            "                org = request.user.get_organizers_with_any_permission().first()",
            "                if not org:",
            "                    raise Http404(_(\"The selected organizer was not found or you \"",
            "                                    \"have no permission to administrate it.\"))",
            "                k = dict(url.kwargs)",
            "                k['organizer'] = org.slug",
            "                return redirect(reverse(url.view_name, kwargs=k, args=url.args))",
            "",
            "            request.organizer = Organizer.objects.filter(",
            "                slug=url.kwargs['organizer'],",
            "            ).first()",
            "            if not request.organizer or not request.user.has_organizer_permission(request.organizer, request=request):",
            "                raise Http404(_(\"The selected organizer was not found or you \"",
            "                                \"have no permission to administrate it.\"))",
            "            if request.user.has_active_staff_session(request.session.session_key):",
            "                request.orgapermset = SuperuserPermissionSet()",
            "            else:",
            "                request.orgapermset = request.user.get_organizer_permission_set(request.organizer)",
            "",
            "        with scope(organizer=getattr(request, 'organizer', None)):",
            "            r = self.get_response(request)",
            "            if isinstance(r, TemplateResponse):",
            "                r = r.render()",
            "            return r",
            "",
            "",
            "class AuditLogMiddleware:",
            "",
            "    def __init__(self, get_response):",
            "        self.get_response = get_response",
            "",
            "    def __call__(self, request):",
            "        if request.path.startswith(get_script_prefix() + 'control') and request.user.is_authenticated:",
            "            if getattr(request.user, \"is_hijacked\", False):",
            "                hijack_history = request.session.get('hijack_history', False)",
            "                hijacker = get_object_or_404(User, pk=hijack_history[0])",
            "                ss = hijacker.get_active_staff_session(request.session.get('hijacker_session'))",
            "                if ss:",
            "                    ss.logs.create(",
            "                        url=request.path,",
            "                        method=request.method,",
            "                        impersonating=request.user",
            "                    )",
            "            else:",
            "                ss = request.user.get_active_staff_session(request.session.session_key)",
            "                if ss:",
            "                    ss.logs.create(",
            "                        url=request.path,",
            "                        method=request.method",
            "                    )",
            "",
            "        response = self.get_response(request)",
            "        return response"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "115": [
                "PermissionMiddleware",
                "__call__"
            ]
        },
        "addLocation": []
    },
    "src/tests/api/test_auth.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " # You should have received a copy of the GNU Affero General Public License along with this program.  If not, see"
            },
            "1": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " # <https://www.gnu.org/licenses/>."
            },
            "2": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " #"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+import time"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+"
            },
            "5": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " import pytest"
            },
            "6": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " from pretix.base.models import Organizer"
            },
            "8": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "     assert len(resp.data['results']) == 1"
            },
            "9": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 51,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 52,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+@pytest.mark.django_db"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+def test_session_auth_relative_timeout(client, user, team):"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+    client.login(email=user.email, password='dummy')"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+    session = client.session"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+    session['pretix_auth_long_session'] = False"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+    session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+    session.save()"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+    resp = client.get('/api/v1/organizers/')"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+    assert resp.status_code == 403"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+"
            },
            "24": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 66,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "25": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 67,
                "PatchRowcode": " def test_token_invalid(client):"
            },
            "26": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "     client.credentials(HTTP_AUTHORIZATION='Token ABCDE')"
            }
        },
        "frontPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "import pytest",
            "",
            "from pretix.base.models import Organizer",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_no_auth(client):",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_session_auth_no_teams(client, user):",
            "    client.login(email=user.email, password='dummy')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 0",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_session_auth_with_teams(client, user, team):",
            "    team.members.add(user)",
            "    Organizer.objects.create(name='Other dummy', slug='dummy2')",
            "    client.login(email=user.email, password='dummy')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 1",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_invalid(client):",
            "    client.credentials(HTTP_AUTHORIZATION='Token ABCDE')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_auth_valid(client, team):",
            "    Organizer.objects.create(name='Other dummy', slug='dummy2')",
            "    t = team.tokens.create(name='Foo')",
            "    client.credentials(HTTP_AUTHORIZATION='Token ' + t.token)",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 1",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_auth_inactive(client, team):",
            "    Organizer.objects.create(name='Other dummy', slug='dummy2')",
            "    t = team.tokens.create(name='Foo', active=False)",
            "    client.credentials(HTTP_AUTHORIZATION='Token ' + t.token)",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_invalid(client):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ABCDE')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_auth_valid(client, device):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ' + device.api_token)",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 1",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_auth_revoked(client, device):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ' + device.api_token)",
            "    device.revoked = True",
            "    device.save()",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "    assert str(resp.data['detail']) == \"Device access has been revoked.\"",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_auth_security_profile(client, device):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ' + device.api_token)",
            "    device.security_profile = \"pretixscan\"",
            "    device.save()",
            "    resp = client.get('/api/v1/organizers/dummy/giftcards/')",
            "    assert resp.status_code == 403",
            "    device.security_profile = \"pretixpos\"",
            "    device.save()",
            "    resp = client.get('/api/v1/organizers/dummy/giftcards/')",
            "    assert resp.status_code == 200"
        ],
        "afterPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "import time",
            "",
            "import pytest",
            "",
            "from pretix.base.models import Organizer",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_no_auth(client):",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_session_auth_no_teams(client, user):",
            "    client.login(email=user.email, password='dummy')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 0",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_session_auth_with_teams(client, user, team):",
            "    team.members.add(user)",
            "    Organizer.objects.create(name='Other dummy', slug='dummy2')",
            "    client.login(email=user.email, password='dummy')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 1",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_session_auth_relative_timeout(client, user, team):",
            "    client.login(email=user.email, password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6",
            "    session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60",
            "    session.save()",
            "",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 403",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_invalid(client):",
            "    client.credentials(HTTP_AUTHORIZATION='Token ABCDE')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_auth_valid(client, team):",
            "    Organizer.objects.create(name='Other dummy', slug='dummy2')",
            "    t = team.tokens.create(name='Foo')",
            "    client.credentials(HTTP_AUTHORIZATION='Token ' + t.token)",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 1",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_auth_inactive(client, team):",
            "    Organizer.objects.create(name='Other dummy', slug='dummy2')",
            "    t = team.tokens.create(name='Foo', active=False)",
            "    client.credentials(HTTP_AUTHORIZATION='Token ' + t.token)",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_invalid(client):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ABCDE')",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_auth_valid(client, device):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ' + device.api_token)",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 200",
            "    assert len(resp.data['results']) == 1",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_auth_revoked(client, device):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ' + device.api_token)",
            "    device.revoked = True",
            "    device.save()",
            "    resp = client.get('/api/v1/organizers/')",
            "    assert resp.status_code == 401",
            "    assert str(resp.data['detail']) == \"Device access has been revoked.\"",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_device_auth_security_profile(client, device):",
            "    client.credentials(HTTP_AUTHORIZATION='Device ' + device.api_token)",
            "    device.security_profile = \"pretixscan\"",
            "    device.save()",
            "    resp = client.get('/api/v1/organizers/dummy/giftcards/')",
            "    assert resp.status_code == 403",
            "    device.security_profile = \"pretixpos\"",
            "    device.save()",
            "    resp = client.get('/api/v1/organizers/dummy/giftcards/')",
            "    assert resp.status_code == 200"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "tensorflow.python.keras.engine.functional_test"
        ]
    },
    "src/tests/api/test_oauth.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " import base64"
            },
            "2": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " import json"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+import time"
            },
            "4": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " from urllib.parse import quote"
            },
            "5": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " import pytest"
            },
            "7": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "     assert resp['Location'].startswith('/control/login')"
            },
            "8": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 89,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 90,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+@pytest.mark.django_db"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+def test_authorize_require_login_after_absolute_timeout(client, admin_user, application: OAuthApplication):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+    client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+    session = client.session"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+    session['pretix_auth_long_session'] = False"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+    session.save()"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+        application.client_id, quote('https://example.org')"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+    ))"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+    assert resp.status_code == 302"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+    assert resp['Location'].startswith('/control/login')"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+    session = client.session"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+    session.save()"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+        application.client_id, quote(application.redirect_uris)"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+    ))"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+    assert resp.status_code == 302"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+@pytest.mark.django_db"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+def test_authorize_require_recent_auth(client, admin_user, application: OAuthApplication):"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+    client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+    session = client.session"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+    session['pretix_auth_long_session'] = True"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time()) - 3600 - 60"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 120,
                "PatchRowcode": "+    session['pretix_auth_last_used'] = int(time.time())"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+    session.save()"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 123,
                "PatchRowcode": "+    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 124,
                "PatchRowcode": "+        application.client_id, quote('https://example.org')"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+    ))"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 126,
                "PatchRowcode": "+    assert resp.status_code == 302"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+    assert resp['Location'].startswith('/control/reauth')"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+    session.save()"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+        application.client_id, quote(application.redirect_uris)"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+    ))"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+    assert resp.status_code == 302"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+@pytest.mark.django_db"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+def test_authorize_require_login_after_relative_timeout(client, admin_user, application: OAuthApplication):"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+    client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+    session = client.session"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 141,
                "PatchRowcode": "+    session['pretix_auth_long_session'] = False"
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 142,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time()) - 3600 * 3 - 60"
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+    session.save()"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+        application.client_id, quote('https://example.org')"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 147,
                "PatchRowcode": "+    ))"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 148,
                "PatchRowcode": "+    assert resp.status_code == 302"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 149,
                "PatchRowcode": "+    assert resp['Location'].startswith('/control/reauth')"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 151,
                "PatchRowcode": "+    session = client.session"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+    session.save()"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+        application.client_id, quote(application.redirect_uris)"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+    ))"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+    assert resp.status_code == 302"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 159,
                "PatchRowcode": "+"
            },
            "79": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 160,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "80": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 161,
                "PatchRowcode": " def test_authorize_invalid_redirect_uri(client, admin_user, application: OAuthApplication):"
            },
            "81": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 162,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+    session = client.session"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+    session.save()"
            },
            "85": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "86": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "         application.client_id, quote('https://example.org')"
            },
            "87": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 168,
                "PatchRowcode": "     ))"
            },
            "88": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 172,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "89": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 173,
                "PatchRowcode": " def test_authorize_missing_response_type(client, admin_user, application: OAuthApplication):"
            },
            "90": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 174,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "91": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 175,
                "PatchRowcode": "+    session = client.session"
            },
            "92": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 176,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "93": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 177,
                "PatchRowcode": "+    session.save()"
            },
            "94": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 178,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % ("
            },
            "95": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 179,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "96": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 180,
                "PatchRowcode": "     ))"
            },
            "97": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": 185,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "98": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": 186,
                "PatchRowcode": " def test_authorize_require_organizer(client, admin_user, organizer, application: OAuthApplication):"
            },
            "99": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 187,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "100": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 188,
                "PatchRowcode": "+    session = client.session"
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 189,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 190,
                "PatchRowcode": "+    session.save()"
            },
            "103": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 191,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "104": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 192,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "105": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 193,
                "PatchRowcode": "     ))"
            },
            "106": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 207,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "107": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 208,
                "PatchRowcode": " def test_authorize_denied(client, admin_user, organizer, application: OAuthApplication):"
            },
            "108": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": 209,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "109": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 210,
                "PatchRowcode": "+    session = client.session"
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 211,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "111": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 212,
                "PatchRowcode": "+    session.save()"
            },
            "112": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": 213,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "113": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": 214,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "114": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": 215,
                "PatchRowcode": "     ))"
            },
            "115": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": 228,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "116": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 229,
                "PatchRowcode": " def test_authorize_disallow_response_token(client, admin_user, organizer, application: OAuthApplication):"
            },
            "117": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": 230,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "118": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 231,
                "PatchRowcode": "+    session = client.session"
            },
            "119": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 232,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "120": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 233,
                "PatchRowcode": "+    session.save()"
            },
            "121": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": 234,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=token' % ("
            },
            "122": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 235,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "123": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 236,
                "PatchRowcode": "     ))"
            },
            "124": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 241,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "125": {
                "beforePatchRowNumber": 157,
                "afterPatchRowNumber": 242,
                "PatchRowcode": " def test_authorize_read_scope(client, admin_user, organizer, application: OAuthApplication):"
            },
            "126": {
                "beforePatchRowNumber": 158,
                "afterPatchRowNumber": 243,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "127": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 244,
                "PatchRowcode": "+    session = client.session"
            },
            "128": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 245,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "129": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 246,
                "PatchRowcode": "+    session.save()"
            },
            "130": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": 247,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "131": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 248,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "132": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 249,
                "PatchRowcode": "     ))"
            },
            "133": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 268,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "134": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 269,
                "PatchRowcode": " def test_authorize_state(client, admin_user, organizer, application: OAuthApplication):"
            },
            "135": {
                "beforePatchRowNumber": 182,
                "afterPatchRowNumber": 270,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "136": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 271,
                "PatchRowcode": "+    session = client.session"
            },
            "137": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 272,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "138": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 273,
                "PatchRowcode": "+    session.save()"
            },
            "139": {
                "beforePatchRowNumber": 183,
                "afterPatchRowNumber": 274,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code&state=asdadf' % ("
            },
            "140": {
                "beforePatchRowNumber": 184,
                "afterPatchRowNumber": 275,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "141": {
                "beforePatchRowNumber": 185,
                "afterPatchRowNumber": 276,
                "PatchRowcode": "     ))"
            },
            "142": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": 291,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "143": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": 292,
                "PatchRowcode": " def test_authorize_default_scope(client, admin_user, organizer, application: OAuthApplication):"
            },
            "144": {
                "beforePatchRowNumber": 202,
                "afterPatchRowNumber": 293,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "145": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 294,
                "PatchRowcode": "+    session = client.session"
            },
            "146": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 295,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "147": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 296,
                "PatchRowcode": "+    session.save()"
            },
            "148": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": 297,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "149": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": 298,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "150": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": 299,
                "PatchRowcode": "     ))"
            },
            "151": {
                "beforePatchRowNumber": 225,
                "afterPatchRowNumber": 319,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "152": {
                "beforePatchRowNumber": 226,
                "afterPatchRowNumber": 320,
                "PatchRowcode": " def test_token_from_code_without_auth(client, admin_user, organizer, application: OAuthApplication):"
            },
            "153": {
                "beforePatchRowNumber": 227,
                "afterPatchRowNumber": 321,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "154": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 322,
                "PatchRowcode": "+    session = client.session"
            },
            "155": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 323,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "156": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 324,
                "PatchRowcode": "+    session.save()"
            },
            "157": {
                "beforePatchRowNumber": 228,
                "afterPatchRowNumber": 325,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "158": {
                "beforePatchRowNumber": 229,
                "afterPatchRowNumber": 326,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "159": {
                "beforePatchRowNumber": 230,
                "afterPatchRowNumber": 327,
                "PatchRowcode": "     ))"
            },
            "160": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": 349,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "161": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": 350,
                "PatchRowcode": " def test_token_from_code(client, admin_user, organizer, application: OAuthApplication):"
            },
            "162": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": 351,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "163": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 352,
                "PatchRowcode": "+    session = client.session"
            },
            "164": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 353,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "165": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 354,
                "PatchRowcode": "+    session.save()"
            },
            "166": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": 355,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "167": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": 356,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "168": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": 357,
                "PatchRowcode": "     ))"
            },
            "169": {
                "beforePatchRowNumber": 291,
                "afterPatchRowNumber": 391,
                "PatchRowcode": "     t2.members.add(admin_user)"
            },
            "170": {
                "beforePatchRowNumber": 292,
                "afterPatchRowNumber": 392,
                "PatchRowcode": " "
            },
            "171": {
                "beforePatchRowNumber": 293,
                "afterPatchRowNumber": 393,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "172": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 394,
                "PatchRowcode": "+    session = client.session"
            },
            "173": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 395,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "174": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 396,
                "PatchRowcode": "+    session.save()"
            },
            "175": {
                "beforePatchRowNumber": 294,
                "afterPatchRowNumber": 397,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "176": {
                "beforePatchRowNumber": 295,
                "afterPatchRowNumber": 398,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "177": {
                "beforePatchRowNumber": 296,
                "afterPatchRowNumber": 399,
                "PatchRowcode": "     ))"
            },
            "178": {
                "beforePatchRowNumber": 335,
                "afterPatchRowNumber": 438,
                "PatchRowcode": "     t2.members.add(admin_user)"
            },
            "179": {
                "beforePatchRowNumber": 336,
                "afterPatchRowNumber": 439,
                "PatchRowcode": " "
            },
            "180": {
                "beforePatchRowNumber": 337,
                "afterPatchRowNumber": 440,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "181": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 441,
                "PatchRowcode": "+    session = client.session"
            },
            "182": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 442,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "183": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 443,
                "PatchRowcode": "+    session.save()"
            },
            "184": {
                "beforePatchRowNumber": 338,
                "afterPatchRowNumber": 444,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "185": {
                "beforePatchRowNumber": 339,
                "afterPatchRowNumber": 445,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "186": {
                "beforePatchRowNumber": 340,
                "afterPatchRowNumber": 446,
                "PatchRowcode": "     ))"
            },
            "187": {
                "beforePatchRowNumber": 376,
                "afterPatchRowNumber": 482,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "188": {
                "beforePatchRowNumber": 377,
                "afterPatchRowNumber": 483,
                "PatchRowcode": " def test_token_refresh(client, admin_user, organizer, application: OAuthApplication):"
            },
            "189": {
                "beforePatchRowNumber": 378,
                "afterPatchRowNumber": 484,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "190": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 485,
                "PatchRowcode": "+    session = client.session"
            },
            "191": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 486,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "192": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 487,
                "PatchRowcode": "+    session.save()"
            },
            "193": {
                "beforePatchRowNumber": 379,
                "afterPatchRowNumber": 488,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "194": {
                "beforePatchRowNumber": 380,
                "afterPatchRowNumber": 489,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "195": {
                "beforePatchRowNumber": 381,
                "afterPatchRowNumber": 490,
                "PatchRowcode": "     ))"
            },
            "196": {
                "beforePatchRowNumber": 418,
                "afterPatchRowNumber": 527,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "197": {
                "beforePatchRowNumber": 419,
                "afterPatchRowNumber": 528,
                "PatchRowcode": " def test_allow_write(client, admin_user, organizer, application: OAuthApplication):"
            },
            "198": {
                "beforePatchRowNumber": 420,
                "afterPatchRowNumber": 529,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "199": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 530,
                "PatchRowcode": "+    session = client.session"
            },
            "200": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 531,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "201": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 532,
                "PatchRowcode": "+    session.save()"
            },
            "202": {
                "beforePatchRowNumber": 421,
                "afterPatchRowNumber": 533,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "203": {
                "beforePatchRowNumber": 422,
                "afterPatchRowNumber": 534,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "204": {
                "beforePatchRowNumber": 423,
                "afterPatchRowNumber": 535,
                "PatchRowcode": "     ))"
            },
            "205": {
                "beforePatchRowNumber": 450,
                "afterPatchRowNumber": 562,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "206": {
                "beforePatchRowNumber": 451,
                "afterPatchRowNumber": 563,
                "PatchRowcode": " def test_allow_read_only(client, admin_user, organizer, application: OAuthApplication):"
            },
            "207": {
                "beforePatchRowNumber": 452,
                "afterPatchRowNumber": 564,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "208": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 565,
                "PatchRowcode": "+    session = client.session"
            },
            "209": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 566,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "210": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 567,
                "PatchRowcode": "+    session.save()"
            },
            "211": {
                "beforePatchRowNumber": 453,
                "afterPatchRowNumber": 568,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "212": {
                "beforePatchRowNumber": 454,
                "afterPatchRowNumber": 569,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "213": {
                "beforePatchRowNumber": 455,
                "afterPatchRowNumber": 570,
                "PatchRowcode": "     ))"
            },
            "214": {
                "beforePatchRowNumber": 482,
                "afterPatchRowNumber": 597,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "215": {
                "beforePatchRowNumber": 483,
                "afterPatchRowNumber": 598,
                "PatchRowcode": " def test_token_revoke_refresh_token(client, admin_user, organizer, application: OAuthApplication):"
            },
            "216": {
                "beforePatchRowNumber": 484,
                "afterPatchRowNumber": 599,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "217": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 600,
                "PatchRowcode": "+    session = client.session"
            },
            "218": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 601,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "219": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 602,
                "PatchRowcode": "+    session.save()"
            },
            "220": {
                "beforePatchRowNumber": 485,
                "afterPatchRowNumber": 603,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "221": {
                "beforePatchRowNumber": 486,
                "afterPatchRowNumber": 604,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "222": {
                "beforePatchRowNumber": 487,
                "afterPatchRowNumber": 605,
                "PatchRowcode": "     ))"
            },
            "223": {
                "beforePatchRowNumber": 526,
                "afterPatchRowNumber": 644,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "224": {
                "beforePatchRowNumber": 527,
                "afterPatchRowNumber": 645,
                "PatchRowcode": " def test_token_revoke_access_token(client, admin_user, organizer, application: OAuthApplication):"
            },
            "225": {
                "beforePatchRowNumber": 528,
                "afterPatchRowNumber": 646,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "226": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 647,
                "PatchRowcode": "+    session = client.session"
            },
            "227": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 648,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "228": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 649,
                "PatchRowcode": "+    session.save()"
            },
            "229": {
                "beforePatchRowNumber": 529,
                "afterPatchRowNumber": 650,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "230": {
                "beforePatchRowNumber": 530,
                "afterPatchRowNumber": 651,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "231": {
                "beforePatchRowNumber": 531,
                "afterPatchRowNumber": 652,
                "PatchRowcode": "     ))"
            },
            "232": {
                "beforePatchRowNumber": 574,
                "afterPatchRowNumber": 695,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "233": {
                "beforePatchRowNumber": 575,
                "afterPatchRowNumber": 696,
                "PatchRowcode": " def test_user_revoke(client, admin_user, organizer, application: OAuthApplication):"
            },
            "234": {
                "beforePatchRowNumber": 576,
                "afterPatchRowNumber": 697,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "235": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 698,
                "PatchRowcode": "+    session = client.session"
            },
            "236": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 699,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "237": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 700,
                "PatchRowcode": "+    session.save()"
            },
            "238": {
                "beforePatchRowNumber": 577,
                "afterPatchRowNumber": 701,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % ("
            },
            "239": {
                "beforePatchRowNumber": 578,
                "afterPatchRowNumber": 702,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "240": {
                "beforePatchRowNumber": 579,
                "afterPatchRowNumber": 703,
                "PatchRowcode": "     ))"
            },
            "241": {
                "beforePatchRowNumber": 603,
                "afterPatchRowNumber": 727,
                "PatchRowcode": " "
            },
            "242": {
                "beforePatchRowNumber": 604,
                "afterPatchRowNumber": 728,
                "PatchRowcode": "     at = OAuthAccessToken.objects.get(token=access_token)"
            },
            "243": {
                "beforePatchRowNumber": 605,
                "afterPatchRowNumber": 729,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "244": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 730,
                "PatchRowcode": "+    session = client.session"
            },
            "245": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 731,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "246": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 732,
                "PatchRowcode": "+    session.save()"
            },
            "247": {
                "beforePatchRowNumber": 606,
                "afterPatchRowNumber": 733,
                "PatchRowcode": "     resp = client.post('/control/settings/oauth/authorized/{}/revoke'.format(at.pk), data={"
            },
            "248": {
                "beforePatchRowNumber": 607,
                "afterPatchRowNumber": 734,
                "PatchRowcode": "     })"
            },
            "249": {
                "beforePatchRowNumber": 608,
                "afterPatchRowNumber": 735,
                "PatchRowcode": "     assert resp.status_code == 302"
            },
            "250": {
                "beforePatchRowNumber": 621,
                "afterPatchRowNumber": 748,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "251": {
                "beforePatchRowNumber": 622,
                "afterPatchRowNumber": 749,
                "PatchRowcode": " def test_allow_profile_only(client, admin_user, organizer, application: OAuthApplication):"
            },
            "252": {
                "beforePatchRowNumber": 623,
                "afterPatchRowNumber": 750,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "253": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 751,
                "PatchRowcode": "+    session = client.session"
            },
            "254": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 752,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "255": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 753,
                "PatchRowcode": "+    session.save()"
            },
            "256": {
                "beforePatchRowNumber": 624,
                "afterPatchRowNumber": 754,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code&scope=profile' % ("
            },
            "257": {
                "beforePatchRowNumber": 625,
                "afterPatchRowNumber": 755,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "258": {
                "beforePatchRowNumber": 626,
                "afterPatchRowNumber": 756,
                "PatchRowcode": "     ))"
            },
            "259": {
                "beforePatchRowNumber": 655,
                "afterPatchRowNumber": 785,
                "PatchRowcode": " @pytest.mark.django_db"
            },
            "260": {
                "beforePatchRowNumber": 656,
                "afterPatchRowNumber": 786,
                "PatchRowcode": " def test_reject_other_response_types(client, admin_user, organizer, application: OAuthApplication):"
            },
            "261": {
                "beforePatchRowNumber": 657,
                "afterPatchRowNumber": 787,
                "PatchRowcode": "     client.login(email='dummy@dummy.dummy', password='dummy')"
            },
            "262": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 788,
                "PatchRowcode": "+    session = client.session"
            },
            "263": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 789,
                "PatchRowcode": "+    session['pretix_auth_login_time'] = int(time.time())"
            },
            "264": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 790,
                "PatchRowcode": "+    session.save()"
            },
            "265": {
                "beforePatchRowNumber": 658,
                "afterPatchRowNumber": 791,
                "PatchRowcode": "     resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code+id_token' % ("
            },
            "266": {
                "beforePatchRowNumber": 659,
                "afterPatchRowNumber": 792,
                "PatchRowcode": "         application.client_id, quote(application.redirect_uris)"
            },
            "267": {
                "beforePatchRowNumber": 660,
                "afterPatchRowNumber": 793,
                "PatchRowcode": "     ))"
            }
        },
        "frontPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "",
            "# This file is based on an earlier version of pretix which was released under the Apache License 2.0. The full text of",
            "# the Apache License 2.0 can be obtained at <http://www.apache.org/licenses/LICENSE-2.0>.",
            "#",
            "# This file may have since been changed and any changes are released under the terms of AGPLv3 as described above. A",
            "# full history of changes and contributors is available at <https://github.com/pretix/pretix>.",
            "#",
            "# This file contains Apache-licensed contributions copyrighted by: Katharina Bogad, Tobias Kunze",
            "#",
            "# Unless required by applicable law or agreed to in writing, software distributed under the Apache License 2.0 is",
            "# distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations under the License.",
            "",
            "import base64",
            "import json",
            "from urllib.parse import quote",
            "",
            "import pytest",
            "from django.utils.crypto import get_random_string",
            "",
            "from pretix.api.models import (",
            "    OAuthAccessToken, OAuthApplication, OAuthGrant, OAuthRefreshToken,",
            ")",
            "from pretix.base.models import Organizer, Team, User",
            "",
            "",
            "@pytest.fixture",
            "def organizer():",
            "    return Organizer.objects.create(name='Dummy', slug='dummy')",
            "",
            "",
            "@pytest.fixture",
            "def admin_team(organizer):",
            "    return Team.objects.create(organizer=organizer, can_change_teams=True, name='Admin team', all_events=True,",
            "                               can_create_events=True)",
            "",
            "",
            "@pytest.fixture",
            "def admin_user(admin_team):",
            "    u = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "    admin_team.members.add(u)",
            "    return u",
            "",
            "",
            "@pytest.fixture",
            "def application():",
            "    secret = get_random_string(32)",
            "    a = OAuthApplication.objects.create(",
            "        name=\"pretalx\",",
            "        redirect_uris=\"https://pretalx.com\",",
            "        client_type='confidential',",
            "        client_secret=secret,",
            "        authorization_grant_type='authorization-code'",
            "    )",
            "    a._cached_secret = secret",
            "    a.save()",
            "    return a",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_require_login(client, application: OAuthApplication):",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote('https://example.org')",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('/control/login')",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_invalid_redirect_uri(client, admin_user, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote('https://example.org')",
            "    ))",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_missing_response_type(client, admin_user, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'] == 'https://pretalx.com?error=invalid_request&error_description=Missing+response_type+parameter.'",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_require_organizer(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ), data={",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 200",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_denied(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'] == 'https://pretalx.com?error=access_denied'",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_disallow_response_token(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=token' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'] == 'https://pretalx.com?error=unauthorized_client'",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_read_scope(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    grant = OAuthGrant.objects.get(code=code)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "    assert grant.scope == \"read\"",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_state(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code&state=asdadf' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "        'state': 'asdadf'",
            "    })",
            "    assert resp.status_code == 302",
            "    assert 'state=asdadf' in resp['Location']",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_default_scope(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "",
            "    client.logout()",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    grant = OAuthGrant.objects.get(code=code)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "    assert grant.scope == \"read write\"",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_from_code_without_auth(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    })",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_from_code(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    assert data['expires_in'] == 86400",
            "    assert data['token_type'] == \"Bearer\"",
            "    assert data['scope'] == \"read write\"",
            "    access_token = data['access_token']",
            "    grant = OAuthAccessToken.objects.get(token=access_token)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_use_token_for_access_one_organizer(client, admin_user, organizer, application: OAuthApplication):",
            "    o2 = Organizer.objects.create(name='A', slug='a')",
            "    t2 = Team.objects.create(organizer=o2, can_change_teams=True, name='Admin team', all_events=True)",
            "    t2.members.add(admin_user)",
            "",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.get('/api/v1/organizers/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    assert data == {'count': 1, 'next': None, 'previous': None, 'results': [",
            "        {'name': 'Dummy', 'slug': 'dummy', 'public_url': 'http://example.com/dummy/'}",
            "    ]}",
            "    resp = client.get('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    resp = client.get('/api/v1/organizers/a/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 403",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_use_token_for_access_two_organizers(client, admin_user, organizer, application: OAuthApplication):",
            "    o2 = Organizer.objects.create(name='A', slug='a')",
            "    t2 = Team.objects.create(organizer=o2, can_change_teams=True, name='Admin team', all_events=True)",
            "    t2.members.add(admin_user)",
            "",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk), str(o2.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.get('/api/v1/organizers/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    assert data == {'count': 2, 'next': None, 'previous': None, 'results': [",
            "        {'name': 'A', 'slug': 'a', 'public_url': 'http://example.com/a/'},",
            "        {'name': 'Dummy', 'slug': 'dummy', 'public_url': 'http://example.com/dummy/'},",
            "    ]}",
            "    resp = client.get('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    resp = client.get('/api/v1/organizers/a/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_refresh(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    assert not OAuthAccessToken.objects.filter(token=access_token).exists()  # old token revoked",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    grant = OAuthAccessToken.objects.get(token=access_token)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_allow_write(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_allow_read_only(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 403",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_revoke_refresh_token(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/oauth/revoke_token', data={",
            "        'token': refresh_token,",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    assert not OAuthAccessToken.objects.get(token=access_token).is_valid()",
            "    assert not OAuthRefreshToken.objects.filter(token=refresh_token, revoked__isnull=True).exists()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_revoke_access_token(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/oauth/revoke_token', data={",
            "        'token': access_token,",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    assert not OAuthAccessToken.objects.get(token=access_token).is_valid()  # old token revoked",
            "",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    grant = OAuthAccessToken.objects.get(token=access_token)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_user_revoke(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "",
            "    at = OAuthAccessToken.objects.get(token=access_token)",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.post('/control/settings/oauth/authorized/{}/revoke'.format(at.pk), data={",
            "    })",
            "    assert resp.status_code == 302",
            "    client.logout()",
            "    assert not OAuthAccessToken.objects.filter(token=access_token).exists()",
            "    assert OAuthRefreshToken.objects.get(token=refresh_token).revoked",
            "",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_allow_profile_only(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code&scope=profile' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'profile',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.get('/api/v1/organizers/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 403",
            "    resp = client.get('/api/v1/me', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_reject_other_response_types(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code+id_token' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert 'error=unauthorized_client' in resp['Location']",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=id_token' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert 'error=unsupported_response_type' in resp['Location']"
        ],
        "afterPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "",
            "# This file is based on an earlier version of pretix which was released under the Apache License 2.0. The full text of",
            "# the Apache License 2.0 can be obtained at <http://www.apache.org/licenses/LICENSE-2.0>.",
            "#",
            "# This file may have since been changed and any changes are released under the terms of AGPLv3 as described above. A",
            "# full history of changes and contributors is available at <https://github.com/pretix/pretix>.",
            "#",
            "# This file contains Apache-licensed contributions copyrighted by: Katharina Bogad, Tobias Kunze",
            "#",
            "# Unless required by applicable law or agreed to in writing, software distributed under the Apache License 2.0 is",
            "# distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations under the License.",
            "",
            "import base64",
            "import json",
            "import time",
            "from urllib.parse import quote",
            "",
            "import pytest",
            "from django.utils.crypto import get_random_string",
            "",
            "from pretix.api.models import (",
            "    OAuthAccessToken, OAuthApplication, OAuthGrant, OAuthRefreshToken,",
            ")",
            "from pretix.base.models import Organizer, Team, User",
            "",
            "",
            "@pytest.fixture",
            "def organizer():",
            "    return Organizer.objects.create(name='Dummy', slug='dummy')",
            "",
            "",
            "@pytest.fixture",
            "def admin_team(organizer):",
            "    return Team.objects.create(organizer=organizer, can_change_teams=True, name='Admin team', all_events=True,",
            "                               can_create_events=True)",
            "",
            "",
            "@pytest.fixture",
            "def admin_user(admin_team):",
            "    u = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "    admin_team.members.add(u)",
            "    return u",
            "",
            "",
            "@pytest.fixture",
            "def application():",
            "    secret = get_random_string(32)",
            "    a = OAuthApplication.objects.create(",
            "        name=\"pretalx\",",
            "        redirect_uris=\"https://pretalx.com\",",
            "        client_type='confidential',",
            "        client_secret=secret,",
            "        authorization_grant_type='authorization-code'",
            "    )",
            "    a._cached_secret = secret",
            "    a.save()",
            "    return a",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_require_login(client, application: OAuthApplication):",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote('https://example.org')",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('/control/login')",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_require_login_after_absolute_timeout(client, admin_user, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60",
            "    session.save()",
            "",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote('https://example.org')",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('/control/login')",
            "",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_require_recent_auth(client, admin_user, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = True",
            "    session['pretix_auth_login_time'] = int(time.time()) - 3600 - 60",
            "    session['pretix_auth_last_used'] = int(time.time())",
            "    session.save()",
            "",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote('https://example.org')",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('/control/reauth')",
            "",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_require_login_after_relative_timeout(client, admin_user, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = int(time.time()) - 3600 * 3 - 60",
            "    session.save()",
            "",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote('https://example.org')",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('/control/reauth')",
            "",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_invalid_redirect_uri(client, admin_user, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote('https://example.org')",
            "    ))",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_missing_response_type(client, admin_user, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'] == 'https://pretalx.com?error=invalid_request&error_description=Missing+response_type+parameter.'",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_require_organizer(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ), data={",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 200",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_denied(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'] == 'https://pretalx.com?error=access_denied'",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_disallow_response_token(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=token' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert resp['Location'] == 'https://pretalx.com?error=unauthorized_client'",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_read_scope(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    grant = OAuthGrant.objects.get(code=code)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "    assert grant.scope == \"read\"",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_state(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code&state=asdadf' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "        'state': 'asdadf'",
            "    })",
            "    assert resp.status_code == 302",
            "    assert 'state=asdadf' in resp['Location']",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_authorize_default_scope(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "",
            "    client.logout()",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    grant = OAuthGrant.objects.get(code=code)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "    assert grant.scope == \"read write\"",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_from_code_without_auth(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    })",
            "    assert resp.status_code == 401",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_from_code(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    assert data['expires_in'] == 86400",
            "    assert data['token_type'] == \"Bearer\"",
            "    assert data['scope'] == \"read write\"",
            "    access_token = data['access_token']",
            "    grant = OAuthAccessToken.objects.get(token=access_token)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_use_token_for_access_one_organizer(client, admin_user, organizer, application: OAuthApplication):",
            "    o2 = Organizer.objects.create(name='A', slug='a')",
            "    t2 = Team.objects.create(organizer=o2, can_change_teams=True, name='Admin team', all_events=True)",
            "    t2.members.add(admin_user)",
            "",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.get('/api/v1/organizers/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    assert data == {'count': 1, 'next': None, 'previous': None, 'results': [",
            "        {'name': 'Dummy', 'slug': 'dummy', 'public_url': 'http://example.com/dummy/'}",
            "    ]}",
            "    resp = client.get('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    resp = client.get('/api/v1/organizers/a/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 403",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_use_token_for_access_two_organizers(client, admin_user, organizer, application: OAuthApplication):",
            "    o2 = Organizer.objects.create(name='A', slug='a')",
            "    t2 = Team.objects.create(organizer=o2, can_change_teams=True, name='Admin team', all_events=True)",
            "    t2.members.add(admin_user)",
            "",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk), str(o2.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.get('/api/v1/organizers/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    assert data == {'count': 2, 'next': None, 'previous': None, 'results': [",
            "        {'name': 'A', 'slug': 'a', 'public_url': 'http://example.com/a/'},",
            "        {'name': 'Dummy', 'slug': 'dummy', 'public_url': 'http://example.com/dummy/'},",
            "    ]}",
            "    resp = client.get('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "    resp = client.get('/api/v1/organizers/a/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_refresh(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    assert not OAuthAccessToken.objects.filter(token=access_token).exists()  # old token revoked",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    grant = OAuthAccessToken.objects.get(token=access_token)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_allow_write(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_allow_read_only(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/organizers/dummy/events/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 403",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_revoke_refresh_token(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/oauth/revoke_token', data={",
            "        'token': refresh_token,",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    assert not OAuthAccessToken.objects.get(token=access_token).is_valid()",
            "    assert not OAuthRefreshToken.objects.filter(token=refresh_token, revoked__isnull=True).exists()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_token_revoke_access_token(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "    resp = client.post('/api/v1/oauth/revoke_token', data={",
            "        'token': access_token,",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    assert not OAuthAccessToken.objects.get(token=access_token).is_valid()  # old token revoked",
            "",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    grant = OAuthAccessToken.objects.get(token=access_token)",
            "    assert list(grant.organizers.all()) == [organizer]",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_user_revoke(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': str(organizer.pk),",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'read write',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    refresh_token = data['refresh_token']",
            "    access_token = data['access_token']",
            "",
            "    at = OAuthAccessToken.objects.get(token=access_token)",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.post('/control/settings/oauth/authorized/{}/revoke'.format(at.pk), data={",
            "    })",
            "    assert resp.status_code == 302",
            "    client.logout()",
            "    assert not OAuthAccessToken.objects.filter(token=access_token).exists()",
            "    assert OAuthRefreshToken.objects.get(token=refresh_token).revoked",
            "",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'refresh_token': refresh_token,",
            "        'grant_type': 'refresh_token',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 400",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_allow_profile_only(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code&scope=profile' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 200",
            "    resp = client.post('/api/v1/oauth/authorize', data={",
            "        'organizers': [str(organizer.pk)],",
            "        'redirect_uri': application.redirect_uris,",
            "        'scope': 'profile',",
            "        'client_id': application.client_id,",
            "        'response_type': 'code',",
            "        'allow': 'Authorize',",
            "    })",
            "    assert resp.status_code == 302",
            "    assert resp['Location'].startswith('https://pretalx.com?code=')",
            "    code = resp['Location'].split(\"=\")[1]",
            "    client.logout()",
            "    resp = client.post('/api/v1/oauth/token', data={",
            "        'code': code,",
            "        'redirect_uri': application.redirect_uris,",
            "        'grant_type': 'authorization_code',",
            "    }, HTTP_AUTHORIZATION='Basic ' + base64.b64encode(",
            "        ('%s:%s' % (application.client_id, application._cached_secret)).encode()).decode())",
            "    assert resp.status_code == 200",
            "    data = json.loads(resp.content.decode())",
            "    access_token = data['access_token']",
            "    resp = client.get('/api/v1/organizers/', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 403",
            "    resp = client.get('/api/v1/me', HTTP_AUTHORIZATION='Bearer %s' % access_token)",
            "    assert resp.status_code == 200",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_reject_other_response_types(client, admin_user, organizer, application: OAuthApplication):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    session = client.session",
            "    session['pretix_auth_login_time'] = int(time.time())",
            "    session.save()",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=code+id_token' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert 'error=unauthorized_client' in resp['Location']",
            "    resp = client.get('/api/v1/oauth/authorize?client_id=%s&redirect_uri=%s&response_type=id_token' % (",
            "        application.client_id, quote(application.redirect_uris)",
            "    ))",
            "    assert resp.status_code == 302",
            "    assert 'error=unsupported_response_type' in resp['Location']"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "tensorflow.python.keras.engine.functional_test"
        ]
    },
    "src/tests/control/test_auth.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 757,
                "afterPatchRowNumber": 757,
                "PatchRowcode": "         # Regression test added after a security problem in 1.9.1"
            },
            "1": {
                "beforePatchRowNumber": 758,
                "afterPatchRowNumber": 758,
                "PatchRowcode": "         # The problem was that, once the relative timeout happened, the user was redirected"
            },
            "2": {
                "beforePatchRowNumber": 759,
                "afterPatchRowNumber": 759,
                "PatchRowcode": "         # to /control/reauth/, but loading /control/reauth/ was already considered to be"
            },
            "3": {
                "beforePatchRowNumber": 760,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # \"session activitiy\". Therefore, after loding /control/reauth/, the session was no longer"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 760,
                "PatchRowcode": "+        # \"session activity\". Therefore, after loding /control/reauth/, the session was no longer"
            },
            "5": {
                "beforePatchRowNumber": 761,
                "afterPatchRowNumber": 761,
                "PatchRowcode": "         # in the timeout state and the user was able to access pages again without re-entering the"
            },
            "6": {
                "beforePatchRowNumber": 762,
                "afterPatchRowNumber": 762,
                "PatchRowcode": "         # password."
            },
            "7": {
                "beforePatchRowNumber": 763,
                "afterPatchRowNumber": 763,
                "PatchRowcode": "         session = self.client.session"
            }
        },
        "frontPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "",
            "# This file is based on an earlier version of pretix which was released under the Apache License 2.0. The full text of",
            "# the Apache License 2.0 can be obtained at <http://www.apache.org/licenses/LICENSE-2.0>.",
            "#",
            "# This file may have since been changed and any changes are released under the terms of AGPLv3 as described above. A",
            "# full history of changes and contributors is available at <https://github.com/pretix/pretix>.",
            "#",
            "# This file contains Apache-licensed contributions copyrighted by: Jason Estibeiro, Lukas Bockstaller, Maico Timmerman",
            "#",
            "# Unless required by applicable law or agreed to in writing, software distributed under the Apache License 2.0 is",
            "# distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations under the License.",
            "",
            "import time",
            "from datetime import datetime, timedelta",
            "",
            "import pytest",
            "from django.conf import settings",
            "from django.contrib.auth.tokens import (",
            "    PasswordResetTokenGenerator, default_token_generator,",
            ")",
            "from django.core import mail as djmail",
            "from django.test import TestCase, override_settings",
            "from django.utils.timezone import now",
            "from django_otp.oath import TOTP",
            "from django_otp.plugins.otp_totp.models import TOTPDevice",
            "",
            "from pretix.base.models import U2FDevice, User",
            "",
            "",
            "class LoginFormTest(TestCase):",
            "",
            "    def setUp(self):",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "",
            "    def test_wrong_credentials(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foo',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_correct_credentials(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert time.time() - self.client.session['pretix_auth_login_time'] < 60",
            "        assert not self.client.session['pretix_auth_long_session']",
            "",
            "    def test_set_long_session(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "            'keep_logged_in': 'on'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert self.client.session['pretix_auth_long_session']",
            "",
            "    def test_inactive_account(self):",
            "        self.user.is_active = False",
            "        self.user.save()",
            "",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_redirect(self):",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "    def test_redirect_to_2fa(self):",
            "        self.user.require_2fa = True",
            "        self.user.save()",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa?next=/control/events/', response['Location'])",
            "        assert self.client.session['pretix_auth_2fa_user'] == self.user.pk",
            "        assert 'pretix_auth_2fa_time' in self.client.session",
            "",
            "    def test_logged_in(self):",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "        response = self.client.get('/control/login')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        response = self.client.get('/control/login?next=/control/events/')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "        response = self.client.get('/control/login?next=//evilsite.com')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/', response['Location'])",
            "",
            "    def test_logout(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        response = self.client.get('/control/logout')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        response = self.client.get('/control/login')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_wrong_backend(self):",
            "        self.user = User.objects.create_user('hallo@example.com', 'dummy', auth_backend='test_request')",
            "        response = self.client.post('/control/login', {",
            "            'email': 'hallo@example.com',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_backends_shown(self):",
            "        response = self.client.get('/control/login')",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'Form' in response.content",
            "        assert b'pretix.eu User' in response.content",
            "        assert b'Request' not in response.content",
            "",
            "    def test_form_backend(self):",
            "        response = self.client.get('/control/login?backend=test_form')",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'name=\"username\"' in response.content",
            "",
            "        response = self.client.post('/control/login?backend=test_form', {",
            "            'username': 'dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'alert-danger' in response.content",
            "",
            "        response = self.client.post('/control/login?backend=test_form', {",
            "            'username': 'foo',",
            "            'password': 'bar',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.get('/control/')",
            "        assert b'foo' in response.content",
            "",
            "    def test_request_backend(self):",
            "        response = self.client.get('/control/login?backend=test_request')",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'name=\"email\"' in response.content",
            "",
            "        response = self.client.get('/control/login', HTTP_X_LOGIN_EMAIL='hallo@example.org')",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.get('/control/')",
            "        assert b'hallo@example.org' in response.content",
            "",
            "    def test_custom_get_next_url(self):",
            "        response = self.client.get('/control/login?state=/control/events/', HTTP_X_LOGIN_EMAIL='hallo@example.org')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "",
            "class RegistrationFormTest(TestCase):",
            "",
            "    def test_different_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foo',",
            "            'password_repeat': 'foobar'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_user_attribute_similarity_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummydummy',",
            "            'password_repeat': 'dummydummy'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_short_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobar',",
            "            'password_repeat': 'foobar'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_common_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'password',",
            "            'password_repeat': 'password'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'football',",
            "            'password_repeat': 'football'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'jennifer',",
            "            'password_repeat': 'jennifer'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_numeric_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': '12345678',",
            "            'password_repeat': '12345678'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': '23423523452345235',",
            "            'password_repeat': '23423523452345235'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_empty_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': '',",
            "            'password_repeat': ''",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': ''",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_email_duplicate(self):",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_success(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert time.time() - self.client.session['pretix_auth_login_time'] < 60",
            "        assert not self.client.session['pretix_auth_long_session']",
            "",
            "    @override_settings(PRETIX_REGISTRATION=False)",
            "    def test_disabled(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "    @override_settings(PRETIX_AUTH_BACKENDS=['tests.testdummy.auth.TestFormAuthBackend'])",
            "    def test_no_native_auth(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "",
            "@pytest.fixture",
            "def class_monkeypatch(request, monkeypatch):",
            "    request.cls.monkeypatch = monkeypatch",
            "",
            "",
            "@pytest.mark.usefixtures(\"class_monkeypatch\")",
            "class Login2FAFormTest(TestCase):",
            "",
            "    def setUp(self):",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy', require_2fa=True)",
            "        session = self.client.session",
            "        session['pretix_auth_2fa_user'] = self.user.pk",
            "        session['pretix_auth_2fa_time'] = str(int(time.time()))",
            "        session['pretix_auth_long_session'] = False",
            "        session.save()",
            "",
            "    def test_invalid_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_2fa_user'] = self.user.pk + 12",
            "        session['pretix_auth_2fa_time'] = str(int(time.time()))",
            "        session.save()",
            "        response = self.client.get('/control/login/2fa')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login', response['Location'])",
            "",
            "    def test_expired_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_2fa_user'] = self.user.pk + 12",
            "        session['pretix_auth_2fa_time'] = str(int(time.time()) - 3600)",
            "        session.save()",
            "        response = self.client.get('/control/login/2fa')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login', response['Location'])",
            "",
            "    def test_totp_invalid(self):",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        d = TOTPDevice.objects.create(user=self.user, name='test')",
            "        totp = TOTP(d.bin_key, d.step, d.t0, d.digits, d.drift)",
            "        totp.time = time.time()",
            "        response = self.client.post('/control/login/2fa', {",
            "            'token': str(totp.token() + 2)",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa', response['Location'])",
            "",
            "    def test_totp_valid(self):",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        d = TOTPDevice.objects.create(user=self.user, name='test')",
            "        totp = TOTP(d.bin_key, d.step, d.t0, d.digits, d.drift)",
            "        totp.time = time.time()",
            "        response = self.client.post('/control/login/2fa?next=/control/events/', {",
            "            'token': str(totp.token())",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "        assert time.time() - self.client.session['pretix_auth_login_time'] < 60",
            "        assert not self.client.session['pretix_auth_long_session']",
            "",
            "    def test_u2f_invalid(self):",
            "        def fail(*args, **kwargs):",
            "            raise Exception(\"Failed\")",
            "",
            "        m = self.monkeypatch",
            "        m.setattr(\"webauthn.WebAuthnAssertionResponse.verify\", fail)",
            "        U2FDevice.objects.create(",
            "            user=self.user, name='test',",
            "            json_data='{\"appId\": \"https://local.pretix.eu\", \"keyHandle\": '",
            "                      '\"j9Rkpon1J5U3eDQMM8YqAvwEapt-m87V8qdCaImiAqmvTJ'",
            "                      '-sBvnACIKKM6J_RVXF4jPtY0LGyjbHi14sxsoC5g\", \"publ'",
            "                      'icKey\": \"BP5KRLUGvcHbqkCc7eJNXZ9caVXLSk4wjsq'",
            "                      'L-pLEQcNqVp2E4OeDUIxI0ZLOXry9JSrLn1aAGcGowXiIyB7ynj0\"}')",
            "",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        response = self.client.post('/control/login/2fa', {",
            "            'token': '{\"response\": \"true\"}'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa', response['Location'])",
            "",
            "        m.undo()",
            "",
            "    def test_u2f_valid(self):",
            "        m = self.monkeypatch",
            "        m.setattr(\"webauthn.WebAuthnAssertionResponse.verify\", lambda *args, **kwargs: 1)",
            "",
            "        U2FDevice.objects.create(",
            "            user=self.user, name='test',",
            "            json_data='{\"appId\": \"https://local.pretix.eu\", \"keyHandle\": '",
            "                      '\"j9Rkpon1J5U3eDQMM8YqAvwEapt-m87V8qdCaImiAqmvTJ'",
            "                      '-sBvnACIKKM6J_RVXF4jPtY0LGyjbHi14sxsoC5g\", \"publ'",
            "                      'icKey\": \"BP5KRLUGvcHbqkCc7eJNXZ9caVXLSk4wjsq'",
            "                      'L-pLEQcNqVp2E4OeDUIxI0ZLOXry9JSrLn1aAGcGowXiIyB7ynj0\"}')",
            "",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        response = self.client.post('/control/login/2fa', {",
            "            'token': '{\"response\": \"true\"}'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/', response['Location'])",
            "",
            "        m.undo()",
            "",
            "",
            "class FakeRedis(object):",
            "    def get_redis_connection(self, connection_string):",
            "        return self",
            "",
            "    def __init__(self):",
            "        self.storage = {}",
            "",
            "    def pipeline(self):",
            "        return self",
            "",
            "    def hincrbyfloat(self, rkey, key, amount):",
            "        return self",
            "",
            "    def commit(self):",
            "        return self",
            "",
            "    def exists(self, rkey):",
            "        return rkey in self.storage",
            "",
            "    def setex(self, rkey, value, expiration):",
            "        self.storage[rkey] = value",
            "",
            "    def execute(self):",
            "        pass",
            "",
            "",
            "@pytest.mark.usefixtures(\"class_monkeypatch\")",
            "class PasswordRecoveryFormTest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('demo@demo.dummy', 'demo')",
            "",
            "    def test_unknown(self):",
            "        djmail.outbox = []",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'dummy@dummy.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert len(djmail.outbox) == 0",
            "",
            "    def test_email_sent(self):",
            "        djmail.outbox = []",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'demo@demo.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        assert len(djmail.outbox) == 1",
            "        assert djmail.outbox[0].to == [self.user.email]",
            "        assert \"recover?id=%d&token=\" % self.user.id in djmail.outbox[0].body",
            "        assert self.user.all_logentries[0].action_type == 'pretix.control.auth.user.forgot_password.mail_sent'",
            "",
            "    @override_settings(HAS_REDIS=True)",
            "    def test_email_reset_twice_redis(self):",
            "        fake_redis = FakeRedis()",
            "        m = self.monkeypatch",
            "        m.setattr('django_redis.get_redis_connection', fake_redis.get_redis_connection, raising=False)",
            "        m.setattr('pretix.base.metrics.redis', fake_redis, raising=False)",
            "",
            "        djmail.outbox = []",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'demo@demo.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        assert len(djmail.outbox) == 1",
            "        assert djmail.outbox[0].to == [self.user.email]",
            "        assert \"recover?id=%d&token=\" % self.user.id in djmail.outbox[0].body",
            "        assert self.user.all_logentries[0].action_type == 'pretix.control.auth.user.forgot_password.mail_sent'",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'demo@demo.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        assert len(djmail.outbox) == 1",
            "        assert self.user.all_logentries[0].action_type == 'pretix.control.auth.user.forgot_password.denied.repeated'",
            "",
            "    def test_recovery_unknown_user(self):",
            "        response = self.client.get('/control/forgot/recover?id=0&token=foo')",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=0&token=foo',",
            "            {",
            "                'password': 'foobar',",
            "                'password_repeat': 'foobar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_invalid_token(self):",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=foo' % self.user.id)",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=foo' % self.user.id,",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_expired_token(self):",
            "        class Mocked(PasswordResetTokenGenerator):",
            "            def _now(self):",
            "                return datetime.now() - timedelta(seconds=settings.PASSWORD_RESET_TIMEOUT + 3600)",
            "",
            "        generator = Mocked()",
            "        token = generator.make_token(self.user)",
            "        response = self.client.get(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token)",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_success(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('foobarbar'))",
            "",
            "    def test_recovery_valid_token_empty_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': ''",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': '',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_different_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foo',",
            "                'password_repeat': 'foobar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_user_attribute_similarity_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'dummydemo',",
            "                'password_repeat': 'dummydemo'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_short_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobar',",
            "                'password_repeat': 'foobar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_common_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'football',",
            "                'password_repeat': 'football'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_numeric_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': '12345678',",
            "                'password_repeat': '12345678'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    @override_settings(PRETIX_PASSWORD_RESET=False)",
            "    def test_disabled(self):",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'dummy@dummy.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "    @override_settings(PRETIX_AUTH_BACKENDS=['tests.testdummy.auth.TestFormAuthBackend'])",
            "    def test_no_native_auth(self):",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'dummy@dummy.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "",
            "class SessionTimeOutTest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('demo@demo.dummy', 'demo')",
            "        self.client.login(email='demo@demo.dummy', password='demo')",
            "",
            "    def test_log_out_after_absolute_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_dont_logout_before_absolute_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 + 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(PRETIX_LONG_SESSIONS=False)",
            "    def test_ignore_long_session_if_disabled_in_config(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_dont_logout_in_long_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_log_out_after_relative_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_dont_logout_before_relative_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 + 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dont_logout_by_relative_in_long_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 5",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_log_out_after_relative_timeout_really_enforced(self):",
            "        # Regression test added after a security problem in 1.9.1",
            "        # The problem was that, once the relative timeout happened, the user was redirected",
            "        # to /control/reauth/, but loading /control/reauth/ was already considered to be",
            "        # \"session activitiy\". Therefore, after loding /control/reauth/, the session was no longer",
            "        # in the timeout state and the user was able to access pages again without re-entering the",
            "        # password.",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertRedirects(response, '/control/reauth/?next=/control/')",
            "        self.client.get('/control/reauth/?next=/control/')",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_update_session_activity(self):",
            "        t1 = int(time.time()) - 5",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 5",
            "        session['pretix_auth_last_used'] = t1",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        assert self.client.session['pretix_auth_last_used'] > t1",
            "",
            "    def test_pinned_user_agent(self):",
            "        self.client.defaults['HTTP_USER_AGENT'] = 'Mozilla/5.0 (X11; Linux x86_64) ' \\",
            "                                                  'AppleWebKit/537.36 (KHTML, like Gecko) ' \\",
            "                                                  'Chrome/64.0.3282.140 Safari/537.36'",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        self.client.defaults['HTTP_USER_AGENT'] = 'Mozilla/5.0 (X11; Linux x86_64) Something else'",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "",
            "@pytest.fixture",
            "def user():",
            "    user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "    return user",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_impersonate(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    ss = user.staffsession_set.create(date_start=now(), session_key=client.session.session_key)",
            "    t1 = int(time.time()) - 5",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    user2 = User.objects.create_user('dummy2@dummy.dummy', 'dummy')",
            "    response = client.post('/control/users/{user}/impersonate'.format(user=user2.pk), follow=True)",
            "    assert b'dummy2@' in response.content",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 403",
            "    response = client.get('/control/')",
            "    response = client.post('/control/users/impersonate/stop/', follow=True)",
            "    assert b'dummy@' in response.content",
            "    assert b'dummy2@' not in response.content",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 200  # staff session is preserved",
            "    assert ss.logs.filter(url='/control/', impersonating=user2).exists()",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_impersonate_require_recent_auth(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    user.staffsession_set.create(date_start=now(), session_key=client.session.session_key)",
            "    t1 = int(time.time()) - 5 * 3600",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    user2 = User.objects.create_user('dummy2@dummy.dummy', 'dummy')",
            "    response = client.post('/control/users/{user}/impersonate'.format(user=user2.pk), follow=True)",
            "    assert b'dummy2@' not in response.content",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_staff_session(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    t1 = int(time.time()) - 5",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 302",
            "    response = client.post('/control/sudo/')",
            "    assert response['Location'] == '/control/'",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 200",
            "    response = client.get('/control/sudo/stop/', follow=True)",
            "    assert response.status_code == 200",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 302",
            "    assert user.staffsession_set.last().logs.filter(url='/control/global/settings/').exists()",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_staff_session_require_recent_auth(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    t1 = int(time.time()) - 5 * 3600",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    response = client.post('/control/sudo/')",
            "    assert response['Location'].startswith('/control/reauth/')",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_staff_session_require_staff(user, client):",
            "    user.is_staff = False",
            "    user.save()",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    t1 = int(time.time()) - 5",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    response = client.post('/control/sudo/')",
            "    assert response.status_code == 403",
            "",
            "",
            "@override_settings(PRETIX_OBLIGATORY_2FA=True)",
            "class Obligatory2FATest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('demo@demo.dummy', 'demo')",
            "        self.client.login(email='demo@demo.dummy', password='demo')",
            "",
            "    def test_enabled_2fa_not_setup(self):",
            "        response = self.client.get('/control/events/')",
            "        assert response.status_code == 302",
            "        assert response.url == '/control/settings/2fa/'",
            "",
            "    def test_enabled_2fa_setup_not_enabled(self):",
            "        U2FDevice.objects.create(user=self.user, name='test', json_data=\"{}\", confirmed=True)",
            "        self.user.require_2fa = False",
            "        self.user.save()",
            "",
            "        response = self.client.get('/control/events/')",
            "        assert response.status_code == 302",
            "        assert response.url == '/control/settings/2fa/'",
            "",
            "    def test_enabled_2fa_setup_enabled(self):",
            "        U2FDevice.objects.create(user=self.user, name='test', json_data=\"{}\", confirmed=True)",
            "        self.user.require_2fa = True",
            "        self.user.save()",
            "",
            "        response = self.client.get('/control/events/')",
            "        assert response.status_code == 200",
            "",
            "",
            "class PasswordChangeRequiredTest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "",
            "    def test_redirect_to_settings(self):",
            "        self.user.needs_password_change = True",
            "        self.user.save()",
            "        self.client.login(email='dummy@dummy.dummy', password='dummy')",
            "",
            "        response = self.client.get('/control/events/')",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "        assert self.user.needs_password_change is True",
            "        self.assertIn('/control/settings?next=/control/events/', response['Location'])",
            "",
            "    def test_redirect_to_2fa_to_settings(self):",
            "        self.user.require_2fa = True",
            "        self.user.needs_password_change = True",
            "        self.user.save()",
            "",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa?next=/control/events/', response['Location'])",
            "",
            "        d = TOTPDevice.objects.create(user=self.user, name='test')",
            "        totp = TOTP(d.bin_key, d.step, d.t0, d.digits, d.drift)",
            "        totp.time = time.time()",
            "",
            "        self.client.post('/control/login/2fa?next=/control/events/', {",
            "            'token': str(totp.token())",
            "        })",
            "        response = self.client.get('/control/events/')",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/settings?next=/control/events/', response['Location'])"
        ],
        "afterPatchFile": [
            "#",
            "# This file is part of pretix (Community Edition).",
            "#",
            "# Copyright (C) 2014-2020 Raphael Michel and contributors",
            "# Copyright (C) 2020-2021 rami.io GmbH and contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General",
            "# Public License as published by the Free Software Foundation in version 3 of the License.",
            "#",
            "# ADDITIONAL TERMS APPLY: Pursuant to Section 7 of the GNU Affero General Public License, additional terms are",
            "# applicable granting you additional permissions and placing additional restrictions on your usage of this software.",
            "# Please refer to the pretix LICENSE file to obtain the full terms applicable to this work. If you did not receive",
            "# this file, see <https://pretix.eu/about/en/license>.",
            "#",
            "# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied",
            "# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more",
            "# details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License along with this program.  If not, see",
            "# <https://www.gnu.org/licenses/>.",
            "#",
            "",
            "# This file is based on an earlier version of pretix which was released under the Apache License 2.0. The full text of",
            "# the Apache License 2.0 can be obtained at <http://www.apache.org/licenses/LICENSE-2.0>.",
            "#",
            "# This file may have since been changed and any changes are released under the terms of AGPLv3 as described above. A",
            "# full history of changes and contributors is available at <https://github.com/pretix/pretix>.",
            "#",
            "# This file contains Apache-licensed contributions copyrighted by: Jason Estibeiro, Lukas Bockstaller, Maico Timmerman",
            "#",
            "# Unless required by applicable law or agreed to in writing, software distributed under the Apache License 2.0 is",
            "# distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations under the License.",
            "",
            "import time",
            "from datetime import datetime, timedelta",
            "",
            "import pytest",
            "from django.conf import settings",
            "from django.contrib.auth.tokens import (",
            "    PasswordResetTokenGenerator, default_token_generator,",
            ")",
            "from django.core import mail as djmail",
            "from django.test import TestCase, override_settings",
            "from django.utils.timezone import now",
            "from django_otp.oath import TOTP",
            "from django_otp.plugins.otp_totp.models import TOTPDevice",
            "",
            "from pretix.base.models import U2FDevice, User",
            "",
            "",
            "class LoginFormTest(TestCase):",
            "",
            "    def setUp(self):",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "",
            "    def test_wrong_credentials(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foo',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_correct_credentials(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert time.time() - self.client.session['pretix_auth_login_time'] < 60",
            "        assert not self.client.session['pretix_auth_long_session']",
            "",
            "    def test_set_long_session(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "            'keep_logged_in': 'on'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert self.client.session['pretix_auth_long_session']",
            "",
            "    def test_inactive_account(self):",
            "        self.user.is_active = False",
            "        self.user.save()",
            "",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_redirect(self):",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "    def test_redirect_to_2fa(self):",
            "        self.user.require_2fa = True",
            "        self.user.save()",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa?next=/control/events/', response['Location'])",
            "        assert self.client.session['pretix_auth_2fa_user'] == self.user.pk",
            "        assert 'pretix_auth_2fa_time' in self.client.session",
            "",
            "    def test_logged_in(self):",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "        response = self.client.get('/control/login')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        response = self.client.get('/control/login?next=/control/events/')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "        response = self.client.get('/control/login?next=//evilsite.com')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/', response['Location'])",
            "",
            "    def test_logout(self):",
            "        response = self.client.post('/control/login', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        response = self.client.get('/control/logout')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        response = self.client.get('/control/login')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_wrong_backend(self):",
            "        self.user = User.objects.create_user('hallo@example.com', 'dummy', auth_backend='test_request')",
            "        response = self.client.post('/control/login', {",
            "            'email': 'hallo@example.com',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_backends_shown(self):",
            "        response = self.client.get('/control/login')",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'Form' in response.content",
            "        assert b'pretix.eu User' in response.content",
            "        assert b'Request' not in response.content",
            "",
            "    def test_form_backend(self):",
            "        response = self.client.get('/control/login?backend=test_form')",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'name=\"username\"' in response.content",
            "",
            "        response = self.client.post('/control/login?backend=test_form', {",
            "            'username': 'dummy',",
            "            'password': 'dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'alert-danger' in response.content",
            "",
            "        response = self.client.post('/control/login?backend=test_form', {",
            "            'username': 'foo',",
            "            'password': 'bar',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.get('/control/')",
            "        assert b'foo' in response.content",
            "",
            "    def test_request_backend(self):",
            "        response = self.client.get('/control/login?backend=test_request')",
            "        self.assertEqual(response.status_code, 200)",
            "        assert b'name=\"email\"' in response.content",
            "",
            "        response = self.client.get('/control/login', HTTP_X_LOGIN_EMAIL='hallo@example.org')",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.get('/control/')",
            "        assert b'hallo@example.org' in response.content",
            "",
            "    def test_custom_get_next_url(self):",
            "        response = self.client.get('/control/login?state=/control/events/', HTTP_X_LOGIN_EMAIL='hallo@example.org')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "",
            "",
            "class RegistrationFormTest(TestCase):",
            "",
            "    def test_different_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foo',",
            "            'password_repeat': 'foobar'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_user_attribute_similarity_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummydummy',",
            "            'password_repeat': 'dummydummy'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_short_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobar',",
            "            'password_repeat': 'foobar'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_common_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'password',",
            "            'password_repeat': 'password'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'football',",
            "            'password_repeat': 'football'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'jennifer',",
            "            'password_repeat': 'jennifer'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_numeric_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': '12345678',",
            "            'password_repeat': '12345678'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': '23423523452345235',",
            "            'password_repeat': '23423523452345235'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_empty_passwords(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': '',",
            "            'password_repeat': ''",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': ''",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_email_duplicate(self):",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_success(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert time.time() - self.client.session['pretix_auth_login_time'] < 60",
            "        assert not self.client.session['pretix_auth_long_session']",
            "",
            "    @override_settings(PRETIX_REGISTRATION=False)",
            "    def test_disabled(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "    @override_settings(PRETIX_AUTH_BACKENDS=['tests.testdummy.auth.TestFormAuthBackend'])",
            "    def test_no_native_auth(self):",
            "        response = self.client.post('/control/register', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'foobarbar',",
            "            'password_repeat': 'foobarbar'",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "",
            "@pytest.fixture",
            "def class_monkeypatch(request, monkeypatch):",
            "    request.cls.monkeypatch = monkeypatch",
            "",
            "",
            "@pytest.mark.usefixtures(\"class_monkeypatch\")",
            "class Login2FAFormTest(TestCase):",
            "",
            "    def setUp(self):",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy', require_2fa=True)",
            "        session = self.client.session",
            "        session['pretix_auth_2fa_user'] = self.user.pk",
            "        session['pretix_auth_2fa_time'] = str(int(time.time()))",
            "        session['pretix_auth_long_session'] = False",
            "        session.save()",
            "",
            "    def test_invalid_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_2fa_user'] = self.user.pk + 12",
            "        session['pretix_auth_2fa_time'] = str(int(time.time()))",
            "        session.save()",
            "        response = self.client.get('/control/login/2fa')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login', response['Location'])",
            "",
            "    def test_expired_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_2fa_user'] = self.user.pk + 12",
            "        session['pretix_auth_2fa_time'] = str(int(time.time()) - 3600)",
            "        session.save()",
            "        response = self.client.get('/control/login/2fa')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login', response['Location'])",
            "",
            "    def test_totp_invalid(self):",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        d = TOTPDevice.objects.create(user=self.user, name='test')",
            "        totp = TOTP(d.bin_key, d.step, d.t0, d.digits, d.drift)",
            "        totp.time = time.time()",
            "        response = self.client.post('/control/login/2fa', {",
            "            'token': str(totp.token() + 2)",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa', response['Location'])",
            "",
            "    def test_totp_valid(self):",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        d = TOTPDevice.objects.create(user=self.user, name='test')",
            "        totp = TOTP(d.bin_key, d.step, d.t0, d.digits, d.drift)",
            "        totp.time = time.time()",
            "        response = self.client.post('/control/login/2fa?next=/control/events/', {",
            "            'token': str(totp.token())",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/events/', response['Location'])",
            "        assert time.time() - self.client.session['pretix_auth_login_time'] < 60",
            "        assert not self.client.session['pretix_auth_long_session']",
            "",
            "    def test_u2f_invalid(self):",
            "        def fail(*args, **kwargs):",
            "            raise Exception(\"Failed\")",
            "",
            "        m = self.monkeypatch",
            "        m.setattr(\"webauthn.WebAuthnAssertionResponse.verify\", fail)",
            "        U2FDevice.objects.create(",
            "            user=self.user, name='test',",
            "            json_data='{\"appId\": \"https://local.pretix.eu\", \"keyHandle\": '",
            "                      '\"j9Rkpon1J5U3eDQMM8YqAvwEapt-m87V8qdCaImiAqmvTJ'",
            "                      '-sBvnACIKKM6J_RVXF4jPtY0LGyjbHi14sxsoC5g\", \"publ'",
            "                      'icKey\": \"BP5KRLUGvcHbqkCc7eJNXZ9caVXLSk4wjsq'",
            "                      'L-pLEQcNqVp2E4OeDUIxI0ZLOXry9JSrLn1aAGcGowXiIyB7ynj0\"}')",
            "",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        response = self.client.post('/control/login/2fa', {",
            "            'token': '{\"response\": \"true\"}'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa', response['Location'])",
            "",
            "        m.undo()",
            "",
            "    def test_u2f_valid(self):",
            "        m = self.monkeypatch",
            "        m.setattr(\"webauthn.WebAuthnAssertionResponse.verify\", lambda *args, **kwargs: 1)",
            "",
            "        U2FDevice.objects.create(",
            "            user=self.user, name='test',",
            "            json_data='{\"appId\": \"https://local.pretix.eu\", \"keyHandle\": '",
            "                      '\"j9Rkpon1J5U3eDQMM8YqAvwEapt-m87V8qdCaImiAqmvTJ'",
            "                      '-sBvnACIKKM6J_RVXF4jPtY0LGyjbHi14sxsoC5g\", \"publ'",
            "                      'icKey\": \"BP5KRLUGvcHbqkCc7eJNXZ9caVXLSk4wjsq'",
            "                      'L-pLEQcNqVp2E4OeDUIxI0ZLOXry9JSrLn1aAGcGowXiIyB7ynj0\"}')",
            "",
            "        response = self.client.get('/control/login/2fa')",
            "        assert 'token' in response.content.decode()",
            "        response = self.client.post('/control/login/2fa', {",
            "            'token': '{\"response\": \"true\"}'",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/', response['Location'])",
            "",
            "        m.undo()",
            "",
            "",
            "class FakeRedis(object):",
            "    def get_redis_connection(self, connection_string):",
            "        return self",
            "",
            "    def __init__(self):",
            "        self.storage = {}",
            "",
            "    def pipeline(self):",
            "        return self",
            "",
            "    def hincrbyfloat(self, rkey, key, amount):",
            "        return self",
            "",
            "    def commit(self):",
            "        return self",
            "",
            "    def exists(self, rkey):",
            "        return rkey in self.storage",
            "",
            "    def setex(self, rkey, value, expiration):",
            "        self.storage[rkey] = value",
            "",
            "    def execute(self):",
            "        pass",
            "",
            "",
            "@pytest.mark.usefixtures(\"class_monkeypatch\")",
            "class PasswordRecoveryFormTest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('demo@demo.dummy', 'demo')",
            "",
            "    def test_unknown(self):",
            "        djmail.outbox = []",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'dummy@dummy.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "        assert len(djmail.outbox) == 0",
            "",
            "    def test_email_sent(self):",
            "        djmail.outbox = []",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'demo@demo.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        assert len(djmail.outbox) == 1",
            "        assert djmail.outbox[0].to == [self.user.email]",
            "        assert \"recover?id=%d&token=\" % self.user.id in djmail.outbox[0].body",
            "        assert self.user.all_logentries[0].action_type == 'pretix.control.auth.user.forgot_password.mail_sent'",
            "",
            "    @override_settings(HAS_REDIS=True)",
            "    def test_email_reset_twice_redis(self):",
            "        fake_redis = FakeRedis()",
            "        m = self.monkeypatch",
            "        m.setattr('django_redis.get_redis_connection', fake_redis.get_redis_connection, raising=False)",
            "        m.setattr('pretix.base.metrics.redis', fake_redis, raising=False)",
            "",
            "        djmail.outbox = []",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'demo@demo.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        assert len(djmail.outbox) == 1",
            "        assert djmail.outbox[0].to == [self.user.email]",
            "        assert \"recover?id=%d&token=\" % self.user.id in djmail.outbox[0].body",
            "        assert self.user.all_logentries[0].action_type == 'pretix.control.auth.user.forgot_password.mail_sent'",
            "",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'demo@demo.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        assert len(djmail.outbox) == 1",
            "        assert self.user.all_logentries[0].action_type == 'pretix.control.auth.user.forgot_password.denied.repeated'",
            "",
            "    def test_recovery_unknown_user(self):",
            "        response = self.client.get('/control/forgot/recover?id=0&token=foo')",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=0&token=foo',",
            "            {",
            "                'password': 'foobar',",
            "                'password_repeat': 'foobar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_invalid_token(self):",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=foo' % self.user.id)",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=foo' % self.user.id,",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_expired_token(self):",
            "        class Mocked(PasswordResetTokenGenerator):",
            "            def _now(self):",
            "                return datetime.now() - timedelta(seconds=settings.PASSWORD_RESET_TIMEOUT + 3600)",
            "",
            "        generator = Mocked()",
            "        token = generator.make_token(self.user)",
            "        response = self.client.get(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token)",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_success(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 302)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('foobarbar'))",
            "",
            "    def test_recovery_valid_token_empty_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobarbar',",
            "                'password_repeat': ''",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': '',",
            "                'password_repeat': 'foobarbar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_different_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foo',",
            "                'password_repeat': 'foobar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_user_attribute_similarity_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'dummydemo',",
            "                'password_repeat': 'dummydemo'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_short_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'foobar',",
            "                'password_repeat': 'foobar'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_common_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': 'football',",
            "                'password_repeat': 'football'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    def test_recovery_valid_token_numeric_passwords(self):",
            "        token = default_token_generator.make_token(self.user)",
            "        response = self.client.get('/control/forgot/recover?id=%d&token=%s' % (self.user.id, token))",
            "        self.assertEqual(response.status_code, 200)",
            "        response = self.client.post(",
            "            '/control/forgot/recover?id=%d&token=%s' % (self.user.id, token),",
            "            {",
            "                'password': '12345678',",
            "                'password_repeat': '12345678'",
            "            }",
            "        )",
            "        self.assertEqual(response.status_code, 200)",
            "        self.user = User.objects.get(id=self.user.id)",
            "        self.assertTrue(self.user.check_password('demo'))",
            "",
            "    @override_settings(PRETIX_PASSWORD_RESET=False)",
            "    def test_disabled(self):",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'dummy@dummy.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "    @override_settings(PRETIX_AUTH_BACKENDS=['tests.testdummy.auth.TestFormAuthBackend'])",
            "    def test_no_native_auth(self):",
            "        response = self.client.post('/control/forgot', {",
            "            'email': 'dummy@dummy.dummy',",
            "        })",
            "        self.assertEqual(response.status_code, 403)",
            "",
            "",
            "class SessionTimeOutTest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('demo@demo.dummy', 'demo')",
            "        self.client.login(email='demo@demo.dummy', password='demo')",
            "",
            "    def test_log_out_after_absolute_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_dont_logout_before_absolute_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 + 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(PRETIX_LONG_SESSIONS=False)",
            "    def test_ignore_long_session_if_disabled_in_config(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_dont_logout_in_long_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 12 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_log_out_after_relative_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_dont_logout_before_relative_timeout(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 + 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dont_logout_by_relative_in_long_session(self):",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = True",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 5",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_log_out_after_relative_timeout_really_enforced(self):",
            "        # Regression test added after a security problem in 1.9.1",
            "        # The problem was that, once the relative timeout happened, the user was redirected",
            "        # to /control/reauth/, but loading /control/reauth/ was already considered to be",
            "        # \"session activity\". Therefore, after loding /control/reauth/, the session was no longer",
            "        # in the timeout state and the user was able to access pages again without re-entering the",
            "        # password.",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 6",
            "        session['pretix_auth_last_used'] = int(time.time()) - 3600 * 3 - 60",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertRedirects(response, '/control/reauth/?next=/control/')",
            "        self.client.get('/control/reauth/?next=/control/')",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_update_session_activity(self):",
            "        t1 = int(time.time()) - 5",
            "        session = self.client.session",
            "        session['pretix_auth_long_session'] = False",
            "        session['pretix_auth_login_time'] = int(time.time()) - 3600 * 5",
            "        session['pretix_auth_last_used'] = t1",
            "        session.save()",
            "",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        assert self.client.session['pretix_auth_last_used'] > t1",
            "",
            "    def test_pinned_user_agent(self):",
            "        self.client.defaults['HTTP_USER_AGENT'] = 'Mozilla/5.0 (X11; Linux x86_64) ' \\",
            "                                                  'AppleWebKit/537.36 (KHTML, like Gecko) ' \\",
            "                                                  'Chrome/64.0.3282.140 Safari/537.36'",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        self.client.defaults['HTTP_USER_AGENT'] = 'Mozilla/5.0 (X11; Linux x86_64) Something else'",
            "        response = self.client.get('/control/')",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "",
            "@pytest.fixture",
            "def user():",
            "    user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "    return user",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_impersonate(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    ss = user.staffsession_set.create(date_start=now(), session_key=client.session.session_key)",
            "    t1 = int(time.time()) - 5",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    user2 = User.objects.create_user('dummy2@dummy.dummy', 'dummy')",
            "    response = client.post('/control/users/{user}/impersonate'.format(user=user2.pk), follow=True)",
            "    assert b'dummy2@' in response.content",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 403",
            "    response = client.get('/control/')",
            "    response = client.post('/control/users/impersonate/stop/', follow=True)",
            "    assert b'dummy@' in response.content",
            "    assert b'dummy2@' not in response.content",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 200  # staff session is preserved",
            "    assert ss.logs.filter(url='/control/', impersonating=user2).exists()",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_impersonate_require_recent_auth(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    user.staffsession_set.create(date_start=now(), session_key=client.session.session_key)",
            "    t1 = int(time.time()) - 5 * 3600",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    user2 = User.objects.create_user('dummy2@dummy.dummy', 'dummy')",
            "    response = client.post('/control/users/{user}/impersonate'.format(user=user2.pk), follow=True)",
            "    assert b'dummy2@' not in response.content",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_staff_session(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    t1 = int(time.time()) - 5",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 302",
            "    response = client.post('/control/sudo/')",
            "    assert response['Location'] == '/control/'",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 200",
            "    response = client.get('/control/sudo/stop/', follow=True)",
            "    assert response.status_code == 200",
            "    response = client.get('/control/global/settings/')",
            "    assert response.status_code == 302",
            "    assert user.staffsession_set.last().logs.filter(url='/control/global/settings/').exists()",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_staff_session_require_recent_auth(user, client):",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    user.is_staff = True",
            "    user.save()",
            "    t1 = int(time.time()) - 5 * 3600",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    response = client.post('/control/sudo/')",
            "    assert response['Location'].startswith('/control/reauth/')",
            "",
            "",
            "@pytest.mark.django_db",
            "def test_staff_session_require_staff(user, client):",
            "    user.is_staff = False",
            "    user.save()",
            "    client.login(email='dummy@dummy.dummy', password='dummy')",
            "    t1 = int(time.time()) - 5",
            "    session = client.session",
            "    session['pretix_auth_long_session'] = False",
            "    session['pretix_auth_login_time'] = t1",
            "    session['pretix_auth_last_used'] = t1",
            "    session.save()",
            "    response = client.post('/control/sudo/')",
            "    assert response.status_code == 403",
            "",
            "",
            "@override_settings(PRETIX_OBLIGATORY_2FA=True)",
            "class Obligatory2FATest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('demo@demo.dummy', 'demo')",
            "        self.client.login(email='demo@demo.dummy', password='demo')",
            "",
            "    def test_enabled_2fa_not_setup(self):",
            "        response = self.client.get('/control/events/')",
            "        assert response.status_code == 302",
            "        assert response.url == '/control/settings/2fa/'",
            "",
            "    def test_enabled_2fa_setup_not_enabled(self):",
            "        U2FDevice.objects.create(user=self.user, name='test', json_data=\"{}\", confirmed=True)",
            "        self.user.require_2fa = False",
            "        self.user.save()",
            "",
            "        response = self.client.get('/control/events/')",
            "        assert response.status_code == 302",
            "        assert response.url == '/control/settings/2fa/'",
            "",
            "    def test_enabled_2fa_setup_enabled(self):",
            "        U2FDevice.objects.create(user=self.user, name='test', json_data=\"{}\", confirmed=True)",
            "        self.user.require_2fa = True",
            "        self.user.save()",
            "",
            "        response = self.client.get('/control/events/')",
            "        assert response.status_code == 200",
            "",
            "",
            "class PasswordChangeRequiredTest(TestCase):",
            "    def setUp(self):",
            "        super().setUp()",
            "        self.user = User.objects.create_user('dummy@dummy.dummy', 'dummy')",
            "",
            "    def test_redirect_to_settings(self):",
            "        self.user.needs_password_change = True",
            "        self.user.save()",
            "        self.client.login(email='dummy@dummy.dummy', password='dummy')",
            "",
            "        response = self.client.get('/control/events/')",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "        assert self.user.needs_password_change is True",
            "        self.assertIn('/control/settings?next=/control/events/', response['Location'])",
            "",
            "    def test_redirect_to_2fa_to_settings(self):",
            "        self.user.require_2fa = True",
            "        self.user.needs_password_change = True",
            "        self.user.save()",
            "",
            "        response = self.client.post('/control/login?next=/control/events/', {",
            "            'email': 'dummy@dummy.dummy',",
            "            'password': 'dummy',",
            "        })",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/login/2fa?next=/control/events/', response['Location'])",
            "",
            "        d = TOTPDevice.objects.create(user=self.user, name='test')",
            "        totp = TOTP(d.bin_key, d.step, d.t0, d.digits, d.drift)",
            "        totp.time = time.time()",
            "",
            "        self.client.post('/control/login/2fa?next=/control/events/', {",
            "            'token': str(totp.token())",
            "        })",
            "        response = self.client.get('/control/events/')",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertIn('/control/settings?next=/control/events/', response['Location'])"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "760": [
                "SessionTimeOutTest",
                "test_log_out_after_relative_timeout_really_enforced"
            ]
        },
        "addLocation": []
    }
}