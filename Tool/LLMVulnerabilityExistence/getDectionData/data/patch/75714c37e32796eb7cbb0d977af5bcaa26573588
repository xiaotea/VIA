{
    "shuup/admin/utils/urls.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from django.core.exceptions import ImproperlyConfigured"
            },
            "1": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from django.http.response import HttpResponseForbidden"
            },
            "2": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from django.utils.encoding import force_str, force_text"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "4": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " from django.utils.http import urlencode"
            },
            "5": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from django.utils.translation import ugettext_lazy as _"
            },
            "6": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "             # Instead of redirecting to the login page, let the user know what's wrong with"
            },
            "8": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "             # a helpful link."
            },
            "9": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "             raise ("
            },
            "10": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                Problem(_(\"Can't view this page. %(reason)s\") % {\"reason\": reason}).with_link("
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+                Problem(_(\"Can't view this page. %(reason)s\") % {\"reason\": escape(reason)}).with_link("
            },
            "12": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "                     url=resp.url, title=_(\"Log in with different credentials...\")"
            },
            "13": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "                 )"
            },
            "14": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "             )"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "import inspect",
            "import json",
            "import six",
            "import warnings",
            "from django.conf import settings",
            "from django.contrib.auth.views import redirect_to_login",
            "from django.core.exceptions import ImproperlyConfigured",
            "from django.http.response import HttpResponseForbidden",
            "from django.utils.encoding import force_str, force_text",
            "from django.utils.http import urlencode",
            "from django.utils.translation import ugettext_lazy as _",
            "",
            "from shuup.admin.module_registry import get_modules",
            "from shuup.admin.shop_provider import get_shop",
            "from shuup.admin.utils.permissions import get_missing_permissions",
            "from shuup.utils import importing",
            "from shuup.utils.django_compat import NoReverseMatch, URLPattern, get_callable, is_authenticated, reverse",
            "from shuup.utils.excs import Problem",
            "",
            "try:",
            "    from urllib.parse import parse_qsl",
            "except ImportError:  # pragma: no cover",
            "    from urlparse import parse_qsl  # Python 2.7",
            "",
            "",
            "class AdminRegexURLPattern(URLPattern):",
            "    def __init__(self, regex, callback, default_args=None, name=None, require_authentication=True, permissions=()):",
            "        self.permissions = tuple(permissions)",
            "        self.require_authentication = require_authentication",
            "",
            "        if callable(callback):",
            "            callback = self.wrap_with_permissions(callback)",
            "",
            "        from django.urls import re_path",
            "",
            "        repath = re_path(regex, callback, default_args, name)",
            "        pattern = repath.pattern",
            "        super(AdminRegexURLPattern, self).__init__(pattern, callback, default_args, name)",
            "",
            "    def _get_unauth_response(self, request, reason):",
            "        \"\"\"",
            "        Get an error response (or raise a Problem) for a given request and reason message.",
            "",
            "        :type request: Request.",
            "        :param request: HttpRequest",
            "        :type reason: Reason string.",
            "        :param reason: str",
            "        \"\"\"",
            "        if request.is_ajax():",
            "            return HttpResponseForbidden(json.dumps({\"error\": force_text(reason)}))",
            "        error_params = urlencode({\"error\": force_text(reason)})",
            "        login_url = force_str(reverse(\"shuup_admin:login\") + \"?\" + error_params)",
            "        resp = redirect_to_login(next=request.path, login_url=login_url)",
            "        if is_authenticated(request.user):",
            "            # Instead of redirecting to the login page, let the user know what's wrong with",
            "            # a helpful link.",
            "            raise (",
            "                Problem(_(\"Can't view this page. %(reason)s\") % {\"reason\": reason}).with_link(",
            "                    url=resp.url, title=_(\"Log in with different credentials...\")",
            "                )",
            "            )",
            "        return resp",
            "",
            "    def _get_unauth_reason(self, request):",
            "        \"\"\"",
            "        Figure out if there's any reason not to allow the user access to this view via the given request.",
            "",
            "        :type request: Request.",
            "        :param request: HttpRequest",
            "        :rtype: str|None",
            "        \"\"\"",
            "        if self.require_authentication:",
            "            if not is_authenticated(request.user):",
            "                return _(\"Sign in to continue.\")",
            "            elif not getattr(request.user, \"is_staff\", False):",
            "                return _(\"Your account must have `Access to Admin Panel` permissions to access this page.\")",
            "            elif not get_shop(request):",
            "                return _(\"There is no active shop available. Contact support for more details.\")",
            "",
            "        missing_permissions = get_missing_permissions(request.user, self.permissions)",
            "        if missing_permissions:",
            "            return _(\"You do not have the required permissions: %s\") % \", \".join(missing_permissions)",
            "",
            "    def wrap_with_permissions(self, view_func):",
            "        if callable(getattr(view_func, \"as_view\", None)):",
            "            view_func = view_func.as_view()",
            "",
            "        @six.wraps(view_func)",
            "        def _wrapped_view(request, *args, **kwargs):",
            "            unauth_reason = self._get_unauth_reason(request)",
            "            if unauth_reason:",
            "                return self._get_unauth_response(request, unauth_reason)",
            "            return view_func(request, *args, **kwargs)",
            "",
            "        return _wrapped_view",
            "",
            "    @property",
            "    def callback(self):",
            "        if self._callback is not None:",
            "            return self._callback",
            "",
            "        callback = get_callable(self._callback_str)",
            "        self._callback = self.wrap_with_permissions(callback)",
            "        return self._callback",
            "",
            "    @callback.setter",
            "    def callback(self, value):",
            "        self._callback = value",
            "",
            "",
            "def admin_url(regex, view, kwargs=None, name=None, prefix=\"\", require_authentication=True, permissions=None):",
            "    if permissions is None:",
            "        permissions = (name,) if name else ()",
            "",
            "    if isinstance(view, six.string_types):",
            "        if not view:",
            "            raise ImproperlyConfigured(\"Error! Empty URL pattern view name not permitted (for pattern `%r`).\" % regex)",
            "        if prefix:",
            "            view = prefix + \".\" + view",
            "",
            "        view = importing.load(view)",
            "",
            "    return AdminRegexURLPattern(",
            "        regex, view, kwargs, name, require_authentication=require_authentication, permissions=permissions",
            "    )",
            "",
            "",
            "def get_edit_and_list_urls(url_prefix, view_template, name_template, permissions=()):",
            "    \"\"\"",
            "    Get a list of edit/new/list URLs for (presumably) an object type with standardized URLs and names.",
            "",
            "    :param url_prefix: What to prefix the generated URLs with. E.g. `\"^taxes/tax\"`.",
            "    :type url_prefix: str",
            "    :param view_template: A template string for the dotted name of the view class.",
            "                          E.g. \"shuup.admin.modules.taxes.views.Tax%sView\".",
            "    :type view_template: str",
            "    :param name_template: A template string for the URLnames. E.g. \"tax.%s\".",
            "    :type name_template: str",
            "    :return: List of URLs.",
            "    :rtype: list[AdminRegexURLPattern]",
            "    \"\"\"",
            "    if permissions:",
            "        warnings.warn(",
            "            \"Warning! `get_edit_and_list_urls` permissions attribute will be \"",
            "            \"deprecated in Shuup 2.0 as unused for this util.\",",
            "            DeprecationWarning,",
            "        )",
            "",
            "    return [",
            "        admin_url(",
            "            r\"%s/(?P<pk>\\d+)/$\" % url_prefix,",
            "            view_template % \"Edit\",",
            "            name=name_template % \"edit\",",
            "            permissions=(name_template % \"edit\",),",
            "        ),",
            "        admin_url(",
            "            \"%s/new/$\" % url_prefix,",
            "            view_template % \"Edit\",",
            "            name=name_template % \"new\",",
            "            kwargs={\"pk\": None},",
            "            permissions=(name_template % \"new\",),",
            "        ),",
            "        admin_url(",
            "            \"%s/$\" % url_prefix,",
            "            view_template % \"List\",",
            "            name=name_template % \"list\",",
            "            permissions=(name_template % \"list\",),",
            "        ),",
            "        admin_url(",
            "            \"%s/list-settings/\" % url_prefix,",
            "            \"shuup.admin.modules.settings.views.ListSettingsView\",",
            "            name=name_template % \"list_settings\",",
            "            permissions=(name_template % \"list_settings\",),",
            "        ),",
            "    ]",
            "",
            "",
            "class NoModelUrl(ValueError):",
            "    pass",
            "",
            "",
            "def get_model_url(",
            "    object, kind=\"detail\", user=None, required_permissions=None, shop=None, raise_permission_denied=False, **kwargs",
            "):",
            "    \"\"\"",
            "    Get a an admin object URL for the given object or object class by",
            "    interrogating each admin module.",
            "",
            "    If a user is provided, checks whether user has correct permissions",
            "    before returning URL.",
            "",
            "    Raises `NoModelUrl` if lookup fails",
            "",
            "    :param object: Model or object class.",
            "    :type object: class",
            "    :param kind: URL kind. Currently \"new\", \"list\", \"edit\", \"detail\".",
            "    :type kind: str",
            "    :param user: Optional instance to check for permissions.",
            "    :type user: django.contrib.auth.models.User|None",
            "    :param required_permissions: Optional iterable of permission strings.",
            "    :type required_permissions: Iterable[str]|None",
            "    :param shop: The shop that owns the resource.",
            "    :type request: shuup.core.models.Shop|None",
            "    :param raise_permission_denied: raise PermissionDenied exception if the url",
            "        is found but user has not permission. If false, None will be returned instead.",
            "        Default is False.",
            "    :type raise_permission_denied: bool",
            "    :return: Resolved URL.",
            "    :rtype: str",
            "    \"\"\"",
            "    for module in get_modules():",
            "        url = module.get_model_url(object, kind, shop)",
            "",
            "        if not url:",
            "            continue",
            "",
            "        if user is None:",
            "            return url",
            "",
            "        from shuup.utils.django_compat import Resolver404, resolve",
            "",
            "        try:",
            "            if required_permissions is not None:",
            "                warnings.warn(",
            "                    \"Warning! `required_permissions` parameter will be deprecated \"",
            "                    \"in Shuup 2.0 as unused for this util.\",",
            "                    DeprecationWarning,",
            "                )",
            "                permissions = required_permissions",
            "            else:",
            "                resolved = resolve(url)",
            "                from shuup.admin.utils.permissions import get_permissions_for_module_url",
            "",
            "                permissions = get_permissions_for_module_url(module, resolved.url_name)",
            "",
            "            missing_permissions = get_missing_permissions(user, permissions)",
            "",
            "            if not missing_permissions:",
            "                return url",
            "",
            "            if raise_permission_denied:",
            "                from django.core.exceptions import PermissionDenied",
            "",
            "                reason = _(\"Can't view this page. You do not have the required permission(s): `{permissions}`.\").format(",
            "                    permissions=\", \".join(missing_permissions)",
            "                )",
            "                raise PermissionDenied(reason)",
            "",
            "        except Resolver404:",
            "            # what are you doing developer?",
            "            return url",
            "",
            "    raise NoModelUrl(\"Error! Can't get object URL of kind %s: %r.\" % (kind, force_text(object)))",
            "",
            "",
            "def derive_model_url(model_class, urlname_prefix, object, kind):",
            "    \"\"\"",
            "    Try to guess a model URL for the given `object` and `kind`.",
            "",
            "    An utility for people implementing `get_model_url`.",
            "",
            "    :param model_class: The model class the object must be an instance or subclass of.",
            "    :type model_class: class",
            "    :param urlname_prefix: URLname prefix. For instance, `shuup_admin:shop_product.`",
            "    :type urlname_prefix: str",
            "    :param object: The model or model class as passed to `get_model_url`.",
            "    :type object: django.db.models.Model|class",
            "    :param kind: URL kind as passed to `get_model_url`.",
            "    :type kind: str",
            "    :return: Resolved URL or None.",
            "    :rtype: str|None",
            "    \"\"\"",
            "    if not (isinstance(object, model_class) or (inspect.isclass(object) and issubclass(object, model_class))):",
            "        return",
            "",
            "    kind_to_urlnames = {",
            "        \"detail\": (\"%s.detail\" % urlname_prefix, \"%s.edit\" % urlname_prefix),",
            "    }",
            "",
            "    kwarg_sets = [{}]",
            "    if getattr(object, \"pk\", None):",
            "        kwarg_sets.append({\"pk\": object.pk})",
            "",
            "    for urlname in kind_to_urlnames.get(kind, [\"%s.%s\" % (urlname_prefix, kind)]):",
            "        for kwargs in kwarg_sets:",
            "            try:",
            "                return reverse(urlname, kwargs=kwargs)",
            "            except NoReverseMatch:",
            "                pass",
            "    # No match whatsoever.",
            "    return None",
            "",
            "",
            "def manipulate_query_string(url, **qs):",
            "    if \"?\" in url:",
            "        url, current_qs = url.split(\"?\", 1)",
            "        qs = dict(parse_qsl(current_qs), **qs)",
            "    qs = [(key, value) for (key, value) in qs.items() if value is not None]",
            "    if qs:",
            "        return \"%s?%s\" % (url, urlencode(qs))",
            "    else:",
            "        return url",
            "",
            "",
            "def get_model_front_url(request, object):",
            "    \"\"\"",
            "    Get a frontend URL for an object.",
            "",
            "    :param request: Request.",
            "    :type request: HttpRequest",
            "    :param object: A model instance.",
            "    :type object: django.db.models.Model",
            "    :return: URL or None.",
            "    :rtype: str|None",
            "    \"\"\"",
            "    # TODO: This method could use an extension point for alternative frontends.",
            "    if not object.pk:",
            "        return None",
            "    if \"shuup.front\" in settings.INSTALLED_APPS:",
            "        # Best effort to use the default frontend for front URLs.",
            "        try:",
            "            from shuup.front.template_helpers.urls import model_url",
            "",
            "            return model_url({\"request\": request}, object)",
            "        except (ValueError, NoReverseMatch):",
            "            pass",
            "    return None",
            "",
            "",
            "def get_front_url(context):",
            "    \"\"\"",
            "    Get front URL for admin navigation.",
            "",
            "    1. Use front URL from view context if passed.",
            "    2. Fallback to index.",
            "    \"\"\"",
            "    front_url = context.get(\"front_url\")",
            "    if not front_url:",
            "        try:",
            "            front_url = reverse(\"shuup:index\")",
            "        except NoReverseMatch:",
            "            front_url = None",
            "    return front_url"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "import inspect",
            "import json",
            "import six",
            "import warnings",
            "from django.conf import settings",
            "from django.contrib.auth.views import redirect_to_login",
            "from django.core.exceptions import ImproperlyConfigured",
            "from django.http.response import HttpResponseForbidden",
            "from django.utils.encoding import force_str, force_text",
            "from django.utils.html import escape",
            "from django.utils.http import urlencode",
            "from django.utils.translation import ugettext_lazy as _",
            "",
            "from shuup.admin.module_registry import get_modules",
            "from shuup.admin.shop_provider import get_shop",
            "from shuup.admin.utils.permissions import get_missing_permissions",
            "from shuup.utils import importing",
            "from shuup.utils.django_compat import NoReverseMatch, URLPattern, get_callable, is_authenticated, reverse",
            "from shuup.utils.excs import Problem",
            "",
            "try:",
            "    from urllib.parse import parse_qsl",
            "except ImportError:  # pragma: no cover",
            "    from urlparse import parse_qsl  # Python 2.7",
            "",
            "",
            "class AdminRegexURLPattern(URLPattern):",
            "    def __init__(self, regex, callback, default_args=None, name=None, require_authentication=True, permissions=()):",
            "        self.permissions = tuple(permissions)",
            "        self.require_authentication = require_authentication",
            "",
            "        if callable(callback):",
            "            callback = self.wrap_with_permissions(callback)",
            "",
            "        from django.urls import re_path",
            "",
            "        repath = re_path(regex, callback, default_args, name)",
            "        pattern = repath.pattern",
            "        super(AdminRegexURLPattern, self).__init__(pattern, callback, default_args, name)",
            "",
            "    def _get_unauth_response(self, request, reason):",
            "        \"\"\"",
            "        Get an error response (or raise a Problem) for a given request and reason message.",
            "",
            "        :type request: Request.",
            "        :param request: HttpRequest",
            "        :type reason: Reason string.",
            "        :param reason: str",
            "        \"\"\"",
            "        if request.is_ajax():",
            "            return HttpResponseForbidden(json.dumps({\"error\": force_text(reason)}))",
            "        error_params = urlencode({\"error\": force_text(reason)})",
            "        login_url = force_str(reverse(\"shuup_admin:login\") + \"?\" + error_params)",
            "        resp = redirect_to_login(next=request.path, login_url=login_url)",
            "        if is_authenticated(request.user):",
            "            # Instead of redirecting to the login page, let the user know what's wrong with",
            "            # a helpful link.",
            "            raise (",
            "                Problem(_(\"Can't view this page. %(reason)s\") % {\"reason\": escape(reason)}).with_link(",
            "                    url=resp.url, title=_(\"Log in with different credentials...\")",
            "                )",
            "            )",
            "        return resp",
            "",
            "    def _get_unauth_reason(self, request):",
            "        \"\"\"",
            "        Figure out if there's any reason not to allow the user access to this view via the given request.",
            "",
            "        :type request: Request.",
            "        :param request: HttpRequest",
            "        :rtype: str|None",
            "        \"\"\"",
            "        if self.require_authentication:",
            "            if not is_authenticated(request.user):",
            "                return _(\"Sign in to continue.\")",
            "            elif not getattr(request.user, \"is_staff\", False):",
            "                return _(\"Your account must have `Access to Admin Panel` permissions to access this page.\")",
            "            elif not get_shop(request):",
            "                return _(\"There is no active shop available. Contact support for more details.\")",
            "",
            "        missing_permissions = get_missing_permissions(request.user, self.permissions)",
            "        if missing_permissions:",
            "            return _(\"You do not have the required permissions: %s\") % \", \".join(missing_permissions)",
            "",
            "    def wrap_with_permissions(self, view_func):",
            "        if callable(getattr(view_func, \"as_view\", None)):",
            "            view_func = view_func.as_view()",
            "",
            "        @six.wraps(view_func)",
            "        def _wrapped_view(request, *args, **kwargs):",
            "            unauth_reason = self._get_unauth_reason(request)",
            "            if unauth_reason:",
            "                return self._get_unauth_response(request, unauth_reason)",
            "            return view_func(request, *args, **kwargs)",
            "",
            "        return _wrapped_view",
            "",
            "    @property",
            "    def callback(self):",
            "        if self._callback is not None:",
            "            return self._callback",
            "",
            "        callback = get_callable(self._callback_str)",
            "        self._callback = self.wrap_with_permissions(callback)",
            "        return self._callback",
            "",
            "    @callback.setter",
            "    def callback(self, value):",
            "        self._callback = value",
            "",
            "",
            "def admin_url(regex, view, kwargs=None, name=None, prefix=\"\", require_authentication=True, permissions=None):",
            "    if permissions is None:",
            "        permissions = (name,) if name else ()",
            "",
            "    if isinstance(view, six.string_types):",
            "        if not view:",
            "            raise ImproperlyConfigured(\"Error! Empty URL pattern view name not permitted (for pattern `%r`).\" % regex)",
            "        if prefix:",
            "            view = prefix + \".\" + view",
            "",
            "        view = importing.load(view)",
            "",
            "    return AdminRegexURLPattern(",
            "        regex, view, kwargs, name, require_authentication=require_authentication, permissions=permissions",
            "    )",
            "",
            "",
            "def get_edit_and_list_urls(url_prefix, view_template, name_template, permissions=()):",
            "    \"\"\"",
            "    Get a list of edit/new/list URLs for (presumably) an object type with standardized URLs and names.",
            "",
            "    :param url_prefix: What to prefix the generated URLs with. E.g. `\"^taxes/tax\"`.",
            "    :type url_prefix: str",
            "    :param view_template: A template string for the dotted name of the view class.",
            "                          E.g. \"shuup.admin.modules.taxes.views.Tax%sView\".",
            "    :type view_template: str",
            "    :param name_template: A template string for the URLnames. E.g. \"tax.%s\".",
            "    :type name_template: str",
            "    :return: List of URLs.",
            "    :rtype: list[AdminRegexURLPattern]",
            "    \"\"\"",
            "    if permissions:",
            "        warnings.warn(",
            "            \"Warning! `get_edit_and_list_urls` permissions attribute will be \"",
            "            \"deprecated in Shuup 2.0 as unused for this util.\",",
            "            DeprecationWarning,",
            "        )",
            "",
            "    return [",
            "        admin_url(",
            "            r\"%s/(?P<pk>\\d+)/$\" % url_prefix,",
            "            view_template % \"Edit\",",
            "            name=name_template % \"edit\",",
            "            permissions=(name_template % \"edit\",),",
            "        ),",
            "        admin_url(",
            "            \"%s/new/$\" % url_prefix,",
            "            view_template % \"Edit\",",
            "            name=name_template % \"new\",",
            "            kwargs={\"pk\": None},",
            "            permissions=(name_template % \"new\",),",
            "        ),",
            "        admin_url(",
            "            \"%s/$\" % url_prefix,",
            "            view_template % \"List\",",
            "            name=name_template % \"list\",",
            "            permissions=(name_template % \"list\",),",
            "        ),",
            "        admin_url(",
            "            \"%s/list-settings/\" % url_prefix,",
            "            \"shuup.admin.modules.settings.views.ListSettingsView\",",
            "            name=name_template % \"list_settings\",",
            "            permissions=(name_template % \"list_settings\",),",
            "        ),",
            "    ]",
            "",
            "",
            "class NoModelUrl(ValueError):",
            "    pass",
            "",
            "",
            "def get_model_url(",
            "    object, kind=\"detail\", user=None, required_permissions=None, shop=None, raise_permission_denied=False, **kwargs",
            "):",
            "    \"\"\"",
            "    Get a an admin object URL for the given object or object class by",
            "    interrogating each admin module.",
            "",
            "    If a user is provided, checks whether user has correct permissions",
            "    before returning URL.",
            "",
            "    Raises `NoModelUrl` if lookup fails",
            "",
            "    :param object: Model or object class.",
            "    :type object: class",
            "    :param kind: URL kind. Currently \"new\", \"list\", \"edit\", \"detail\".",
            "    :type kind: str",
            "    :param user: Optional instance to check for permissions.",
            "    :type user: django.contrib.auth.models.User|None",
            "    :param required_permissions: Optional iterable of permission strings.",
            "    :type required_permissions: Iterable[str]|None",
            "    :param shop: The shop that owns the resource.",
            "    :type request: shuup.core.models.Shop|None",
            "    :param raise_permission_denied: raise PermissionDenied exception if the url",
            "        is found but user has not permission. If false, None will be returned instead.",
            "        Default is False.",
            "    :type raise_permission_denied: bool",
            "    :return: Resolved URL.",
            "    :rtype: str",
            "    \"\"\"",
            "    for module in get_modules():",
            "        url = module.get_model_url(object, kind, shop)",
            "",
            "        if not url:",
            "            continue",
            "",
            "        if user is None:",
            "            return url",
            "",
            "        from shuup.utils.django_compat import Resolver404, resolve",
            "",
            "        try:",
            "            if required_permissions is not None:",
            "                warnings.warn(",
            "                    \"Warning! `required_permissions` parameter will be deprecated \"",
            "                    \"in Shuup 2.0 as unused for this util.\",",
            "                    DeprecationWarning,",
            "                )",
            "                permissions = required_permissions",
            "            else:",
            "                resolved = resolve(url)",
            "                from shuup.admin.utils.permissions import get_permissions_for_module_url",
            "",
            "                permissions = get_permissions_for_module_url(module, resolved.url_name)",
            "",
            "            missing_permissions = get_missing_permissions(user, permissions)",
            "",
            "            if not missing_permissions:",
            "                return url",
            "",
            "            if raise_permission_denied:",
            "                from django.core.exceptions import PermissionDenied",
            "",
            "                reason = _(\"Can't view this page. You do not have the required permission(s): `{permissions}`.\").format(",
            "                    permissions=\", \".join(missing_permissions)",
            "                )",
            "                raise PermissionDenied(reason)",
            "",
            "        except Resolver404:",
            "            # what are you doing developer?",
            "            return url",
            "",
            "    raise NoModelUrl(\"Error! Can't get object URL of kind %s: %r.\" % (kind, force_text(object)))",
            "",
            "",
            "def derive_model_url(model_class, urlname_prefix, object, kind):",
            "    \"\"\"",
            "    Try to guess a model URL for the given `object` and `kind`.",
            "",
            "    An utility for people implementing `get_model_url`.",
            "",
            "    :param model_class: The model class the object must be an instance or subclass of.",
            "    :type model_class: class",
            "    :param urlname_prefix: URLname prefix. For instance, `shuup_admin:shop_product.`",
            "    :type urlname_prefix: str",
            "    :param object: The model or model class as passed to `get_model_url`.",
            "    :type object: django.db.models.Model|class",
            "    :param kind: URL kind as passed to `get_model_url`.",
            "    :type kind: str",
            "    :return: Resolved URL or None.",
            "    :rtype: str|None",
            "    \"\"\"",
            "    if not (isinstance(object, model_class) or (inspect.isclass(object) and issubclass(object, model_class))):",
            "        return",
            "",
            "    kind_to_urlnames = {",
            "        \"detail\": (\"%s.detail\" % urlname_prefix, \"%s.edit\" % urlname_prefix),",
            "    }",
            "",
            "    kwarg_sets = [{}]",
            "    if getattr(object, \"pk\", None):",
            "        kwarg_sets.append({\"pk\": object.pk})",
            "",
            "    for urlname in kind_to_urlnames.get(kind, [\"%s.%s\" % (urlname_prefix, kind)]):",
            "        for kwargs in kwarg_sets:",
            "            try:",
            "                return reverse(urlname, kwargs=kwargs)",
            "            except NoReverseMatch:",
            "                pass",
            "    # No match whatsoever.",
            "    return None",
            "",
            "",
            "def manipulate_query_string(url, **qs):",
            "    if \"?\" in url:",
            "        url, current_qs = url.split(\"?\", 1)",
            "        qs = dict(parse_qsl(current_qs), **qs)",
            "    qs = [(key, value) for (key, value) in qs.items() if value is not None]",
            "    if qs:",
            "        return \"%s?%s\" % (url, urlencode(qs))",
            "    else:",
            "        return url",
            "",
            "",
            "def get_model_front_url(request, object):",
            "    \"\"\"",
            "    Get a frontend URL for an object.",
            "",
            "    :param request: Request.",
            "    :type request: HttpRequest",
            "    :param object: A model instance.",
            "    :type object: django.db.models.Model",
            "    :return: URL or None.",
            "    :rtype: str|None",
            "    \"\"\"",
            "    # TODO: This method could use an extension point for alternative frontends.",
            "    if not object.pk:",
            "        return None",
            "    if \"shuup.front\" in settings.INSTALLED_APPS:",
            "        # Best effort to use the default frontend for front URLs.",
            "        try:",
            "            from shuup.front.template_helpers.urls import model_url",
            "",
            "            return model_url({\"request\": request}, object)",
            "        except (ValueError, NoReverseMatch):",
            "            pass",
            "    return None",
            "",
            "",
            "def get_front_url(context):",
            "    \"\"\"",
            "    Get front URL for admin navigation.",
            "",
            "    1. Use front URL from view context if passed.",
            "    2. Fallback to index.",
            "    \"\"\"",
            "    front_url = context.get(\"front_url\")",
            "    if not front_url:",
            "        try:",
            "            front_url = reverse(\"shuup:index\")",
            "        except NoReverseMatch:",
            "            front_url = None",
            "    return front_url"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "67": [
                "AdminRegexURLPattern",
                "_get_unauth_response"
            ]
        },
        "addLocation": []
    },
    "shuup/core/basket/command_dispatcher.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from django.core.exceptions import ValidationError"
            },
            "1": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from django.http import HttpResponseRedirect, JsonResponse"
            },
            "2": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from django.shortcuts import redirect"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "4": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from django.utils.translation import ugettext_lazy as _"
            },
            "5": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from shuup.apps.provides import get_provide_objects"
            },
            "7": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "         try:"
            },
            "8": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "             handler = self.get_command_handler(command)"
            },
            "9": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "             if not handler or not callable(handler):"
            },
            "10": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                raise Problem(_(\"Error! Invalid command `%s`.\") % command)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+                raise Problem(_(\"Error! Invalid command `%s`.\") % escape(command))"
            },
            "12": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "             kwargs.pop(\"csrfmiddlewaretoken\", None)  # The CSRF token should never be passed as a kwarg"
            },
            "13": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "             kwargs.pop(\"command\", None)  # Nor the command"
            },
            "14": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "             kwargs.update(request=self.request, basket=self.basket)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "import six",
            "from django.core.exceptions import ValidationError",
            "from django.http import HttpResponseRedirect, JsonResponse",
            "from django.shortcuts import redirect",
            "from django.utils.translation import ugettext_lazy as _",
            "",
            "from shuup.apps.provides import get_provide_objects",
            "from shuup.core.basket import commands",
            "from shuup.core.basket.command_middleware import BaseBasketCommandMiddleware",
            "from shuup.core.signals import get_basket_command_handler",
            "from shuup.utils.django_compat import force_text",
            "from shuup.utils.excs import Problem",
            "",
            "",
            "class BasketCommandDispatcher(object):",
            "    \"\"\"",
            "    BasketCommandDispatcher handles (usually AJAX) requests that somehow update the basket.",
            "    You should never instantiate BasketCommandDispatcher yourself -- instead use",
            "    `get_basket_command_dispatcher()`.",
            "",
            "    All `handle_*` methods are expected to accept `**kwargs`.",
            "    \"\"\"",
            "",
            "    commands_module = commands",
            "",
            "    def __init__(self, request, basket=None):",
            "        \"\"\"",
            "        :type request: HttpRequest",
            "        \"\"\"",
            "        self.request = request",
            "        self.ajax = self.request.is_ajax()",
            "        # :type self.basket: BaseBasket",
            "        self.basket = basket or request.basket",
            "",
            "    def get_command_handler(self, command):",
            "        handler = getattr(self.commands_module, \"handle_%s\" % command.lower(), None)",
            "        if handler and callable(handler):",
            "            return handler",
            "",
            "        for receiver, handler in get_basket_command_handler.send(",
            "            BasketCommandDispatcher, command=command, instance=self",
            "        ):",
            "            if handler and callable(handler):",
            "                return handler",
            "",
            "    def handle(self, command, kwargs=None):",
            "        \"\"\"",
            "        Dispatch and handle processing of the given command.",
            "",
            "        :param command: Name of command to run.",
            "        :type command: unicode",
            "        :param kwargs: Arguments to pass to the command handler. If empty, `request.POST` is used.",
            "        :type kwargs: dict",
            "        :return: response.",
            "        :rtype: HttpResponse",
            "        \"\"\"",
            "",
            "        kwargs = kwargs or dict(six.iteritems(self.request.POST))",
            "        try:",
            "            handler = self.get_command_handler(command)",
            "            if not handler or not callable(handler):",
            "                raise Problem(_(\"Error! Invalid command `%s`.\") % command)",
            "            kwargs.pop(\"csrfmiddlewaretoken\", None)  # The CSRF token should never be passed as a kwarg",
            "            kwargs.pop(\"command\", None)  # Nor the command",
            "            kwargs.update(request=self.request, basket=self.basket)",
            "            kwargs = self.preprocess_kwargs(command, kwargs)",
            "",
            "            response = handler(**kwargs) or {}",
            "",
            "        except (Problem, ValidationError) as exc:",
            "            if not self.ajax:",
            "                raise",
            "            msg = exc.message if hasattr(exc, \"message\") else exc",
            "            response = {",
            "                \"error\": force_text(msg, errors=\"ignore\"),",
            "                \"code\": force_text(getattr(exc, \"code\", None) or \"\", errors=\"ignore\"),",
            "            }",
            "",
            "        response = self.postprocess_response(command, kwargs, response)",
            "",
            "        if self.ajax:",
            "            return JsonResponse(response)",
            "",
            "        return_url = response.get(\"return\") or kwargs.get(\"return\")",
            "        if return_url and return_url.startswith(\"/\"):",
            "            return HttpResponseRedirect(return_url)",
            "        return redirect(\"shuup:basket\")",
            "",
            "    def preprocess_kwargs(self, command, kwargs):",
            "        \"\"\"",
            "        Preprocess kwargs before they are passed to the given `command` handler.",
            "        Useful for subclassing. Must return the new `kwargs`, even if it wasn't",
            "        mutated.",
            "",
            "        :param command: The name of the command about to be run.",
            "        :param kwargs: dict of arguments.",
            "        :return: dict of arguments.",
            "        \"\"\"",
            "",
            "        for basket_command_middleware in get_provide_objects(\"basket_command_middleware\"):",
            "            if not issubclass(basket_command_middleware, BaseBasketCommandMiddleware):",
            "                continue",
            "",
            "            # create a copy",
            "            kwargs = dict(",
            "                basket_command_middleware().preprocess_kwargs(",
            "                    basket=self.basket, request=self.request, command=command, kwargs=kwargs",
            "                )",
            "            )",
            "",
            "        return kwargs",
            "",
            "    def postprocess_response(self, command, kwargs, response):",
            "        \"\"\"",
            "        Postprocess the response dictionary (not a HTTP response!) before it is",
            "        either turned into JSON or otherwise processed (in the case of non-AJAX requests).",
            "",
            "        :param command: The command that was run.",
            "        :param kwargs: The actual kwargs the command was run with.",
            "        :param response: The response the command returned.",
            "        :return: The response to be processed and sent to the client.",
            "        \"\"\"",
            "",
            "        for basket_command_middleware in get_provide_objects(\"basket_command_middleware\"):",
            "            if not issubclass(basket_command_middleware, BaseBasketCommandMiddleware):",
            "                continue",
            "",
            "            response = dict(",
            "                basket_command_middleware().postprocess_response(",
            "                    basket=self.basket, request=self.request, command=command, kwargs=kwargs, response=response",
            "                )",
            "            )",
            "",
            "        return response"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "import six",
            "from django.core.exceptions import ValidationError",
            "from django.http import HttpResponseRedirect, JsonResponse",
            "from django.shortcuts import redirect",
            "from django.utils.html import escape",
            "from django.utils.translation import ugettext_lazy as _",
            "",
            "from shuup.apps.provides import get_provide_objects",
            "from shuup.core.basket import commands",
            "from shuup.core.basket.command_middleware import BaseBasketCommandMiddleware",
            "from shuup.core.signals import get_basket_command_handler",
            "from shuup.utils.django_compat import force_text",
            "from shuup.utils.excs import Problem",
            "",
            "",
            "class BasketCommandDispatcher(object):",
            "    \"\"\"",
            "    BasketCommandDispatcher handles (usually AJAX) requests that somehow update the basket.",
            "    You should never instantiate BasketCommandDispatcher yourself -- instead use",
            "    `get_basket_command_dispatcher()`.",
            "",
            "    All `handle_*` methods are expected to accept `**kwargs`.",
            "    \"\"\"",
            "",
            "    commands_module = commands",
            "",
            "    def __init__(self, request, basket=None):",
            "        \"\"\"",
            "        :type request: HttpRequest",
            "        \"\"\"",
            "        self.request = request",
            "        self.ajax = self.request.is_ajax()",
            "        # :type self.basket: BaseBasket",
            "        self.basket = basket or request.basket",
            "",
            "    def get_command_handler(self, command):",
            "        handler = getattr(self.commands_module, \"handle_%s\" % command.lower(), None)",
            "        if handler and callable(handler):",
            "            return handler",
            "",
            "        for receiver, handler in get_basket_command_handler.send(",
            "            BasketCommandDispatcher, command=command, instance=self",
            "        ):",
            "            if handler and callable(handler):",
            "                return handler",
            "",
            "    def handle(self, command, kwargs=None):",
            "        \"\"\"",
            "        Dispatch and handle processing of the given command.",
            "",
            "        :param command: Name of command to run.",
            "        :type command: unicode",
            "        :param kwargs: Arguments to pass to the command handler. If empty, `request.POST` is used.",
            "        :type kwargs: dict",
            "        :return: response.",
            "        :rtype: HttpResponse",
            "        \"\"\"",
            "",
            "        kwargs = kwargs or dict(six.iteritems(self.request.POST))",
            "        try:",
            "            handler = self.get_command_handler(command)",
            "            if not handler or not callable(handler):",
            "                raise Problem(_(\"Error! Invalid command `%s`.\") % escape(command))",
            "            kwargs.pop(\"csrfmiddlewaretoken\", None)  # The CSRF token should never be passed as a kwarg",
            "            kwargs.pop(\"command\", None)  # Nor the command",
            "            kwargs.update(request=self.request, basket=self.basket)",
            "            kwargs = self.preprocess_kwargs(command, kwargs)",
            "",
            "            response = handler(**kwargs) or {}",
            "",
            "        except (Problem, ValidationError) as exc:",
            "            if not self.ajax:",
            "                raise",
            "            msg = exc.message if hasattr(exc, \"message\") else exc",
            "            response = {",
            "                \"error\": force_text(msg, errors=\"ignore\"),",
            "                \"code\": force_text(getattr(exc, \"code\", None) or \"\", errors=\"ignore\"),",
            "            }",
            "",
            "        response = self.postprocess_response(command, kwargs, response)",
            "",
            "        if self.ajax:",
            "            return JsonResponse(response)",
            "",
            "        return_url = response.get(\"return\") or kwargs.get(\"return\")",
            "        if return_url and return_url.startswith(\"/\"):",
            "            return HttpResponseRedirect(return_url)",
            "        return redirect(\"shuup:basket\")",
            "",
            "    def preprocess_kwargs(self, command, kwargs):",
            "        \"\"\"",
            "        Preprocess kwargs before they are passed to the given `command` handler.",
            "        Useful for subclassing. Must return the new `kwargs`, even if it wasn't",
            "        mutated.",
            "",
            "        :param command: The name of the command about to be run.",
            "        :param kwargs: dict of arguments.",
            "        :return: dict of arguments.",
            "        \"\"\"",
            "",
            "        for basket_command_middleware in get_provide_objects(\"basket_command_middleware\"):",
            "            if not issubclass(basket_command_middleware, BaseBasketCommandMiddleware):",
            "                continue",
            "",
            "            # create a copy",
            "            kwargs = dict(",
            "                basket_command_middleware().preprocess_kwargs(",
            "                    basket=self.basket, request=self.request, command=command, kwargs=kwargs",
            "                )",
            "            )",
            "",
            "        return kwargs",
            "",
            "    def postprocess_response(self, command, kwargs, response):",
            "        \"\"\"",
            "        Postprocess the response dictionary (not a HTTP response!) before it is",
            "        either turned into JSON or otherwise processed (in the case of non-AJAX requests).",
            "",
            "        :param command: The command that was run.",
            "        :param kwargs: The actual kwargs the command was run with.",
            "        :param response: The response the command returned.",
            "        :return: The response to be processed and sent to the client.",
            "        \"\"\"",
            "",
            "        for basket_command_middleware in get_provide_objects(\"basket_command_middleware\"):",
            "            if not issubclass(basket_command_middleware, BaseBasketCommandMiddleware):",
            "                continue",
            "",
            "            response = dict(",
            "                basket_command_middleware().postprocess_response(",
            "                    basket=self.basket, request=self.request, command=command, kwargs=kwargs, response=response",
            "                )",
            "            )",
            "",
            "        return response"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "71": [
                "BasketCommandDispatcher",
                "handle"
            ]
        },
        "addLocation": []
    },
    "shuup/front/checkout/_process.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from collections import OrderedDict"
            },
            "1": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from django.core.exceptions import ImproperlyConfigured"
            },
            "2": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from django.http.response import Http404"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "4": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from shuup.front.basket import get_basket"
            },
            "6": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from shuup.utils.django_compat import reverse"
            },
            "7": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "                     return phase"
            },
            "8": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "             if not phase.should_skip() and not phase.is_valid():  # A past phase is not valid, that's the current one"
            },
            "9": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "                 return phase"
            },
            "10": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        raise Http404(\"Error! Phase with identifier `%s` not found.\" % requested_phase_identifier)  # pragma: no cover"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+        raise Http404(\"Error! Phase with identifier `%s` not found.\" % escape(requested_phase_identifier))"
            },
            "12": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 80,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "     def _get_next_phase(self, phases, current_phase, target_phase):"
            },
            "14": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "         found = False"
            }
        },
        "frontPatchFile": [
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "from collections import OrderedDict",
            "from django.core.exceptions import ImproperlyConfigured",
            "from django.http.response import Http404",
            "",
            "from shuup.front.basket import get_basket",
            "from shuup.utils.django_compat import reverse",
            "from shuup.utils.importing import load",
            "",
            "",
            "class CheckoutProcess(object):",
            "    horizontal_template = True",
            "",
            "    def __init__(self, phase_specs, phase_kwargs, view=None):",
            "        \"\"\"",
            "        Initialize this checkout process.",
            "",
            "        :type phase_specs: list[str]",
            "        :type phase_kwargs: dict",
            "        :type view: shuup.front.checkout.BaseCheckoutView|None",
            "        \"\"\"",
            "        self.phase_specs = phase_specs",
            "        self.phase_kwargs = phase_kwargs",
            "        self.view = view",
            "        self.request = self.phase_kwargs.get(\"request\")",
            "",
            "    @property",
            "    def phases(self):",
            "        \"\"\"",
            "        :rtype: Iterable[CheckoutPhaseViewMixin]",
            "        \"\"\"",
            "        if not getattr(self, \"_phases\", None):",
            "            self._phases = self._load_phases()",
            "        return self._phases",
            "",
            "    def instantiate_phase_class(self, phase_class, **extra_kwargs):",
            "        if not phase_class.identifier:  # pragma: no cover",
            "            raise ImproperlyConfigured(\"Error! Phase `%r` has no identifier.\" % phase_class)",
            "        kwargs = {}",
            "        kwargs.update(self.phase_kwargs)",
            "        kwargs.update(extra_kwargs)",
            "        phase = phase_class(checkout_process=self, horizontal_template=self.horizontal_template, **kwargs)",
            "        return phase",
            "",
            "    def _load_phases(self):",
            "        phases = OrderedDict()",
            "",
            "        for phase_spec in self.phase_specs:",
            "            phase_class = load(phase_spec)",
            "            phase = self.instantiate_phase_class(phase_class)",
            "            phases[phase_class.identifier] = phase",
            "",
            "            # check whether the phase spawns new phases,",
            "            # if so, then let's spawn then and add the phases",
            "            for spawned_phase in phase.spawn_phases(self):",
            "                phases[spawned_phase.identifier] = spawned_phase",
            "",
            "        return list(phases.values())",
            "",
            "    def get_current_phase(self, requested_phase_identifier):",
            "        found = False",
            "        for phase in self.phases:",
            "            if phase.is_valid():",
            "                phase.process()",
            "            if found or not requested_phase_identifier or requested_phase_identifier == phase.identifier:",
            "                found = True  # We're at or past the requested phase",
            "                if not phase.should_skip():",
            "                    return phase",
            "            if not phase.should_skip() and not phase.is_valid():  # A past phase is not valid, that's the current one",
            "                return phase",
            "        raise Http404(\"Error! Phase with identifier `%s` not found.\" % requested_phase_identifier)  # pragma: no cover",
            "",
            "    def _get_next_phase(self, phases, current_phase, target_phase):",
            "        found = False",
            "        for phase in phases:",
            "            if phase.identifier == current_phase.identifier:",
            "                # Found the current one, so any valid phase from here on out is the next one",
            "                found = True",
            "                continue",
            "",
            "            if found and current_phase.identifier != target_phase.identifier:",
            "                return phase",
            "",
            "            if found and not phase.should_skip():",
            "                # Yep, that's the one",
            "                return phase",
            "",
            "    def get_next_phase(self, current_phase, target_phase):",
            "        return self._get_next_phase(self.phases, current_phase, target_phase)",
            "",
            "    def get_previous_phase(self, current_phase, target_phase):",
            "        return self._get_next_phase(reversed(self.phases), current_phase, target_phase)",
            "",
            "    def prepare_current_phase(self, phase_identifier):",
            "        current_phase = self.get_current_phase(phase_identifier)",
            "        self.add_phase_attributes(current_phase)",
            "        self.current_phase = current_phase",
            "        return current_phase",
            "",
            "    def add_phase_attributes(self, target_phase, current_phase=None):",
            "        \"\"\"",
            "        Add phase instance attributes (previous, next, etc) to the given target phase,",
            "        using the optional `current_phase` as the current phase for previous and next.",
            "",
            "        This is exposed as a public API for the benefit of phases that need to do sub-phase",
            "        initialization and dispatching, such as method phases.",
            "        \"\"\"",
            "        current_phase = current_phase or target_phase",
            "        target_phase.previous_phase = self.get_previous_phase(current_phase, target_phase)",
            "        target_phase.next_phase = self.get_next_phase(current_phase, target_phase)",
            "        target_phase.phases = self.phases",
            "        if current_phase in self.phases:",
            "            current_phase_index = self.phases.index(current_phase)",
            "            # Set up attributes that are handy for the phase bar in the templates.",
            "            for i, phase in enumerate(self.phases):",
            "                setattr(phase, \"is_past\", i > current_phase_index)",
            "                setattr(phase, \"is_current\", phase == current_phase)",
            "                setattr(phase, \"is_future\", i < current_phase_index)",
            "                setattr(phase, \"is_previous\", phase == target_phase.previous_phase)",
            "                setattr(phase, \"is_next\", phase == target_phase.next_phase)",
            "        return target_phase",
            "",
            "    def reset(self):",
            "        for phase in self.phases:",
            "            phase.reset()",
            "",
            "    def complete(self):",
            "        \"\"\"",
            "        To be called from a phase (`self.checkout_process.complete()`) when the checkout process is complete.",
            "        \"\"\"",
            "        self.reset()",
            "",
            "    def get_phase_url(self, phase):",
            "        # The self.view is optional for backward compatibility",
            "        if not self.view:",
            "            url_kwargs = {\"phase\": phase.identifier}",
            "            return reverse(\"shuup:checkout\", kwargs=url_kwargs)",
            "        return self.view.get_phase_url(phase)",
            "",
            "    @property",
            "    def basket(self):",
            "        \"\"\"",
            "        The basket used in this checkout process.",
            "",
            "        :rtype: shuup.front.basket.objects.BaseBasket",
            "        \"\"\"",
            "        return get_basket(self.request)",
            "",
            "",
            "class VerticalCheckoutProcess(CheckoutProcess):",
            "    horizontal_template = False"
        ],
        "afterPatchFile": [
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "from collections import OrderedDict",
            "from django.core.exceptions import ImproperlyConfigured",
            "from django.http.response import Http404",
            "from django.utils.html import escape",
            "",
            "from shuup.front.basket import get_basket",
            "from shuup.utils.django_compat import reverse",
            "from shuup.utils.importing import load",
            "",
            "",
            "class CheckoutProcess(object):",
            "    horizontal_template = True",
            "",
            "    def __init__(self, phase_specs, phase_kwargs, view=None):",
            "        \"\"\"",
            "        Initialize this checkout process.",
            "",
            "        :type phase_specs: list[str]",
            "        :type phase_kwargs: dict",
            "        :type view: shuup.front.checkout.BaseCheckoutView|None",
            "        \"\"\"",
            "        self.phase_specs = phase_specs",
            "        self.phase_kwargs = phase_kwargs",
            "        self.view = view",
            "        self.request = self.phase_kwargs.get(\"request\")",
            "",
            "    @property",
            "    def phases(self):",
            "        \"\"\"",
            "        :rtype: Iterable[CheckoutPhaseViewMixin]",
            "        \"\"\"",
            "        if not getattr(self, \"_phases\", None):",
            "            self._phases = self._load_phases()",
            "        return self._phases",
            "",
            "    def instantiate_phase_class(self, phase_class, **extra_kwargs):",
            "        if not phase_class.identifier:  # pragma: no cover",
            "            raise ImproperlyConfigured(\"Error! Phase `%r` has no identifier.\" % phase_class)",
            "        kwargs = {}",
            "        kwargs.update(self.phase_kwargs)",
            "        kwargs.update(extra_kwargs)",
            "        phase = phase_class(checkout_process=self, horizontal_template=self.horizontal_template, **kwargs)",
            "        return phase",
            "",
            "    def _load_phases(self):",
            "        phases = OrderedDict()",
            "",
            "        for phase_spec in self.phase_specs:",
            "            phase_class = load(phase_spec)",
            "            phase = self.instantiate_phase_class(phase_class)",
            "            phases[phase_class.identifier] = phase",
            "",
            "            # check whether the phase spawns new phases,",
            "            # if so, then let's spawn then and add the phases",
            "            for spawned_phase in phase.spawn_phases(self):",
            "                phases[spawned_phase.identifier] = spawned_phase",
            "",
            "        return list(phases.values())",
            "",
            "    def get_current_phase(self, requested_phase_identifier):",
            "        found = False",
            "        for phase in self.phases:",
            "            if phase.is_valid():",
            "                phase.process()",
            "            if found or not requested_phase_identifier or requested_phase_identifier == phase.identifier:",
            "                found = True  # We're at or past the requested phase",
            "                if not phase.should_skip():",
            "                    return phase",
            "            if not phase.should_skip() and not phase.is_valid():  # A past phase is not valid, that's the current one",
            "                return phase",
            "        raise Http404(\"Error! Phase with identifier `%s` not found.\" % escape(requested_phase_identifier))",
            "",
            "    def _get_next_phase(self, phases, current_phase, target_phase):",
            "        found = False",
            "        for phase in phases:",
            "            if phase.identifier == current_phase.identifier:",
            "                # Found the current one, so any valid phase from here on out is the next one",
            "                found = True",
            "                continue",
            "",
            "            if found and current_phase.identifier != target_phase.identifier:",
            "                return phase",
            "",
            "            if found and not phase.should_skip():",
            "                # Yep, that's the one",
            "                return phase",
            "",
            "    def get_next_phase(self, current_phase, target_phase):",
            "        return self._get_next_phase(self.phases, current_phase, target_phase)",
            "",
            "    def get_previous_phase(self, current_phase, target_phase):",
            "        return self._get_next_phase(reversed(self.phases), current_phase, target_phase)",
            "",
            "    def prepare_current_phase(self, phase_identifier):",
            "        current_phase = self.get_current_phase(phase_identifier)",
            "        self.add_phase_attributes(current_phase)",
            "        self.current_phase = current_phase",
            "        return current_phase",
            "",
            "    def add_phase_attributes(self, target_phase, current_phase=None):",
            "        \"\"\"",
            "        Add phase instance attributes (previous, next, etc) to the given target phase,",
            "        using the optional `current_phase` as the current phase for previous and next.",
            "",
            "        This is exposed as a public API for the benefit of phases that need to do sub-phase",
            "        initialization and dispatching, such as method phases.",
            "        \"\"\"",
            "        current_phase = current_phase or target_phase",
            "        target_phase.previous_phase = self.get_previous_phase(current_phase, target_phase)",
            "        target_phase.next_phase = self.get_next_phase(current_phase, target_phase)",
            "        target_phase.phases = self.phases",
            "        if current_phase in self.phases:",
            "            current_phase_index = self.phases.index(current_phase)",
            "            # Set up attributes that are handy for the phase bar in the templates.",
            "            for i, phase in enumerate(self.phases):",
            "                setattr(phase, \"is_past\", i > current_phase_index)",
            "                setattr(phase, \"is_current\", phase == current_phase)",
            "                setattr(phase, \"is_future\", i < current_phase_index)",
            "                setattr(phase, \"is_previous\", phase == target_phase.previous_phase)",
            "                setattr(phase, \"is_next\", phase == target_phase.next_phase)",
            "        return target_phase",
            "",
            "    def reset(self):",
            "        for phase in self.phases:",
            "            phase.reset()",
            "",
            "    def complete(self):",
            "        \"\"\"",
            "        To be called from a phase (`self.checkout_process.complete()`) when the checkout process is complete.",
            "        \"\"\"",
            "        self.reset()",
            "",
            "    def get_phase_url(self, phase):",
            "        # The self.view is optional for backward compatibility",
            "        if not self.view:",
            "            url_kwargs = {\"phase\": phase.identifier}",
            "            return reverse(\"shuup:checkout\", kwargs=url_kwargs)",
            "        return self.view.get_phase_url(phase)",
            "",
            "    @property",
            "    def basket(self):",
            "        \"\"\"",
            "        The basket used in this checkout process.",
            "",
            "        :rtype: shuup.front.basket.objects.BaseBasket",
            "        \"\"\"",
            "        return get_basket(self.request)",
            "",
            "",
            "class VerticalCheckoutProcess(CheckoutProcess):",
            "    horizontal_template = False"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "78": [
                "CheckoutProcess",
                "get_current_phase"
            ]
        },
        "addLocation": []
    },
    "shuup/front/urls.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from django.conf.urls import url"
            },
            "1": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from django.contrib.auth.decorators import login_required"
            },
            "2": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from django.http.response import HttpResponse"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "4": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from django.views.decorators.csrf import csrf_exempt"
            },
            "5": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from django.views.i18n import set_language"
            },
            "6": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from itertools import chain"
            },
            "7": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " def _not_here_yet(request, *args, **kwargs):"
            },
            "10": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    return HttpResponse(\"Not here yet: %s (%r, %r)\" % (request.path, args, kwargs), status=410)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    return HttpResponse(\"Not here yet: %s (%r, %r)\" % (request.path, escape(args), escape(kwargs)), status=410)"
            },
            "12": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 42,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 43,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 44,
                "PatchRowcode": " # Use a different js catalog function in front urlpatterns to prevent forcing"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "from django.conf.urls import url",
            "from django.contrib.auth.decorators import login_required",
            "from django.http.response import HttpResponse",
            "from django.views.decorators.csrf import csrf_exempt",
            "from django.views.i18n import set_language",
            "from itertools import chain",
            "",
            "from shuup.apps.provides import get_provide_objects",
            "",
            "from .views.basket import BasketView",
            "from .views.category import AllCategoriesView, CategoryView",
            "from .views.checkout import get_checkout_view",
            "from .views.dashboard import DashboardView",
            "from .views.index import IndexView",
            "from .views.misc import (",
            "    force_anonymous_contact,",
            "    force_company_contact,",
            "    force_person_contact,",
            "    stop_impersonating,",
            "    toggle_all_seeing,",
            ")",
            "from .views.order import OrderCompleteView",
            "from .views.payment import ProcessPaymentView",
            "from .views.product import ProductDetailView",
            "from .views.upload import media_upload",
            "",
            "# TODO: Check _not_here_yet URLs in this file",
            "",
            "",
            "def _not_here_yet(request, *args, **kwargs):",
            "    return HttpResponse(\"Not here yet: %s (%r, %r)\" % (request.path, args, kwargs), status=410)",
            "",
            "",
            "# Use a different js catalog function in front urlpatterns to prevent forcing",
            "# the shop language settings in admin js catalog.",
            "def front_javascript_catalog_all(request, domain=\"djangojs\"):",
            "    from shuup.utils.i18n import javascript_catalog_all",
            "",
            "    return javascript_catalog_all(request, domain)",
            "",
            "",
            "checkout_view = get_checkout_view()",
            "",
            "",
            "urlpatterns = [",
            "    url(r\"^set-language/$\", csrf_exempt(set_language), name=\"set-language\"),",
            "    url(r\"^i18n.js$\", front_javascript_catalog_all, name=\"js-catalog\"),",
            "    url(r\"^checkout/$\", checkout_view, name=\"checkout\"),",
            "    url(r\"^checkout/(?P<phase>.+)/$\", checkout_view, name=\"checkout\"),",
            "    url(r\"^basket/$\", csrf_exempt(BasketView.as_view()), name=\"basket\"),",
            "    url(r\"^dashboard/$\", login_required(DashboardView.as_view()), name=\"dashboard\"),",
            "    url(r\"^toggle-allseeing/$\", login_required(toggle_all_seeing), name=\"toggle-all-seeing\"),",
            "    url(r\"^force-anonymous-contact/$\", login_required(force_anonymous_contact), name=\"force-anonymous-contact\"),",
            "    url(r\"^force-company-contact/$\", login_required(force_company_contact), name=\"force-company-contact\"),",
            "    url(r\"^force-person-contact/$\", login_required(force_person_contact), name=\"force-person-contact\"),",
            "    url(r\"^stop-impersonating/$\", login_required(stop_impersonating), name=\"stop-impersonating\"),",
            "    url(r\"^upload-media/$\", login_required(media_upload), name=\"media-upload\"),",
            "    url(",
            "        r\"^order/payment/(?P<pk>.+?)/(?P<key>.+?)/$\",",
            "        csrf_exempt(ProcessPaymentView.as_view()),",
            "        kwargs={\"mode\": \"payment\"},",
            "        name=\"order_process_payment\",",
            "    ),",
            "    url(",
            "        r\"^order/process-payment/(?P<pk>.+?)/(?P<key>.+?)/$\",",
            "        csrf_exempt(ProcessPaymentView.as_view()),",
            "        kwargs={\"mode\": \"return\"},",
            "        name=\"order_process_payment_return\",",
            "    ),",
            "    url(",
            "        r\"^order/payment-canceled/(?P<pk>.+?)/(?P<key>.+?)/$\",",
            "        ProcessPaymentView.as_view(),",
            "        kwargs={\"mode\": \"cancel\"},",
            "        name=\"order_payment_canceled\",",
            "    ),",
            "    url(r\"^order/complete/(?P<pk>.+?)/(?P<key>.+?)/$\", csrf_exempt(OrderCompleteView.as_view()), name=\"order_complete\"),",
            "    url(r\"^order/verification/(?P<pk>.+?)/(?P<key>.+?)/$\", _not_here_yet, name=\"order_requires_verification\"),",
            "    url(",
            "        r\"^order/get-attachment/(?P<order_pk>\\d+)/(?P<key>.+?)/(?P<att_pk>\\d+)/\",",
            "        _not_here_yet,",
            "        name=\"secure_attachment\",",
            "    ),",
            "    url(r\"^p/(?P<pk>\\d+)-(?P<slug>.*)/$\", csrf_exempt(ProductDetailView.as_view()), name=\"product\"),",
            "    url(",
            "        r\"^s/(?P<supplier_pk>\\d+)-(?P<pk>\\d+)-(?P<slug>.*)/$\",",
            "        csrf_exempt(ProductDetailView.as_view()),",
            "        name=\"supplier-product\",",
            "    ),",
            "    url(r\"^c/$\", csrf_exempt(AllCategoriesView.as_view()), name=\"all-categories\"),",
            "    url(r\"^c/(?P<pk>\\d+)-(?P<slug>.*)/$\", csrf_exempt(CategoryView.as_view()), name=\"category\"),",
            "]",
            "",
            "# TODO: Document `front_urls_pre`, `front_urls` and `front_urls_post`.",
            "",
            "",
            "def _get_extension_urlpatterns(provide_category):",
            "    return chain(*get_provide_objects(provide_category))",
            "",
            "",
            "app_name = \"shuup\"",
            "urlpatterns = list(",
            "    chain(",
            "        *(",
            "            _get_extension_urlpatterns(\"front_urls_pre\"),",
            "            urlpatterns,",
            "            _get_extension_urlpatterns(\"front_urls\"),",
            "            [url(r\"^$\", IndexView.as_view(), name=\"index\")],",
            "            _get_extension_urlpatterns(\"front_urls_post\"),",
            "        )",
            "    )",
            ")"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from __future__ import unicode_literals",
            "",
            "from django.conf.urls import url",
            "from django.contrib.auth.decorators import login_required",
            "from django.http.response import HttpResponse",
            "from django.utils.html import escape",
            "from django.views.decorators.csrf import csrf_exempt",
            "from django.views.i18n import set_language",
            "from itertools import chain",
            "",
            "from shuup.apps.provides import get_provide_objects",
            "",
            "from .views.basket import BasketView",
            "from .views.category import AllCategoriesView, CategoryView",
            "from .views.checkout import get_checkout_view",
            "from .views.dashboard import DashboardView",
            "from .views.index import IndexView",
            "from .views.misc import (",
            "    force_anonymous_contact,",
            "    force_company_contact,",
            "    force_person_contact,",
            "    stop_impersonating,",
            "    toggle_all_seeing,",
            ")",
            "from .views.order import OrderCompleteView",
            "from .views.payment import ProcessPaymentView",
            "from .views.product import ProductDetailView",
            "from .views.upload import media_upload",
            "",
            "# TODO: Check _not_here_yet URLs in this file",
            "",
            "",
            "def _not_here_yet(request, *args, **kwargs):",
            "    return HttpResponse(\"Not here yet: %s (%r, %r)\" % (request.path, escape(args), escape(kwargs)), status=410)",
            "",
            "",
            "# Use a different js catalog function in front urlpatterns to prevent forcing",
            "# the shop language settings in admin js catalog.",
            "def front_javascript_catalog_all(request, domain=\"djangojs\"):",
            "    from shuup.utils.i18n import javascript_catalog_all",
            "",
            "    return javascript_catalog_all(request, domain)",
            "",
            "",
            "checkout_view = get_checkout_view()",
            "",
            "",
            "urlpatterns = [",
            "    url(r\"^set-language/$\", csrf_exempt(set_language), name=\"set-language\"),",
            "    url(r\"^i18n.js$\", front_javascript_catalog_all, name=\"js-catalog\"),",
            "    url(r\"^checkout/$\", checkout_view, name=\"checkout\"),",
            "    url(r\"^checkout/(?P<phase>.+)/$\", checkout_view, name=\"checkout\"),",
            "    url(r\"^basket/$\", csrf_exempt(BasketView.as_view()), name=\"basket\"),",
            "    url(r\"^dashboard/$\", login_required(DashboardView.as_view()), name=\"dashboard\"),",
            "    url(r\"^toggle-allseeing/$\", login_required(toggle_all_seeing), name=\"toggle-all-seeing\"),",
            "    url(r\"^force-anonymous-contact/$\", login_required(force_anonymous_contact), name=\"force-anonymous-contact\"),",
            "    url(r\"^force-company-contact/$\", login_required(force_company_contact), name=\"force-company-contact\"),",
            "    url(r\"^force-person-contact/$\", login_required(force_person_contact), name=\"force-person-contact\"),",
            "    url(r\"^stop-impersonating/$\", login_required(stop_impersonating), name=\"stop-impersonating\"),",
            "    url(r\"^upload-media/$\", login_required(media_upload), name=\"media-upload\"),",
            "    url(",
            "        r\"^order/payment/(?P<pk>.+?)/(?P<key>.+?)/$\",",
            "        csrf_exempt(ProcessPaymentView.as_view()),",
            "        kwargs={\"mode\": \"payment\"},",
            "        name=\"order_process_payment\",",
            "    ),",
            "    url(",
            "        r\"^order/process-payment/(?P<pk>.+?)/(?P<key>.+?)/$\",",
            "        csrf_exempt(ProcessPaymentView.as_view()),",
            "        kwargs={\"mode\": \"return\"},",
            "        name=\"order_process_payment_return\",",
            "    ),",
            "    url(",
            "        r\"^order/payment-canceled/(?P<pk>.+?)/(?P<key>.+?)/$\",",
            "        ProcessPaymentView.as_view(),",
            "        kwargs={\"mode\": \"cancel\"},",
            "        name=\"order_payment_canceled\",",
            "    ),",
            "    url(r\"^order/complete/(?P<pk>.+?)/(?P<key>.+?)/$\", csrf_exempt(OrderCompleteView.as_view()), name=\"order_complete\"),",
            "    url(r\"^order/verification/(?P<pk>.+?)/(?P<key>.+?)/$\", _not_here_yet, name=\"order_requires_verification\"),",
            "    url(",
            "        r\"^order/get-attachment/(?P<order_pk>\\d+)/(?P<key>.+?)/(?P<att_pk>\\d+)/\",",
            "        _not_here_yet,",
            "        name=\"secure_attachment\",",
            "    ),",
            "    url(r\"^p/(?P<pk>\\d+)-(?P<slug>.*)/$\", csrf_exempt(ProductDetailView.as_view()), name=\"product\"),",
            "    url(",
            "        r\"^s/(?P<supplier_pk>\\d+)-(?P<pk>\\d+)-(?P<slug>.*)/$\",",
            "        csrf_exempt(ProductDetailView.as_view()),",
            "        name=\"supplier-product\",",
            "    ),",
            "    url(r\"^c/$\", csrf_exempt(AllCategoriesView.as_view()), name=\"all-categories\"),",
            "    url(r\"^c/(?P<pk>\\d+)-(?P<slug>.*)/$\", csrf_exempt(CategoryView.as_view()), name=\"category\"),",
            "]",
            "",
            "# TODO: Document `front_urls_pre`, `front_urls` and `front_urls_post`.",
            "",
            "",
            "def _get_extension_urlpatterns(provide_category):",
            "    return chain(*get_provide_objects(provide_category))",
            "",
            "",
            "app_name = \"shuup\"",
            "urlpatterns = list(",
            "    chain(",
            "        *(",
            "            _get_extension_urlpatterns(\"front_urls_pre\"),",
            "            urlpatterns,",
            "            _get_extension_urlpatterns(\"front_urls\"),",
            "            [url(r\"^$\", IndexView.as_view(), name=\"index\")],",
            "            _get_extension_urlpatterns(\"front_urls_post\"),",
            "        )",
            "    )",
            ")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "40": [
                "_not_here_yet"
            ]
        },
        "addLocation": []
    },
    "shuup/utils/excs.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from django.core.exceptions import ValidationError"
            },
            "1": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 2,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "2": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " from shuup.utils.django_compat import force_text"
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "     for obj in obj_list:"
            },
            "6": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "         if isinstance(obj, ValidationError):"
            },
            "7": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "             for msg in obj.messages:"
            },
            "8": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                yield force_text(msg)"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+                yield escape(force_text(msg))"
            },
            "10": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "             continue"
            },
            "11": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "         if isinstance(obj, Exception):"
            },
            "12": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "             if len(obj.args):"
            },
            "13": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                yield force_text(obj.args[0])"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+                yield escape(force_text(obj.args[0]))"
            },
            "15": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "                 continue"
            },
            "16": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        yield force_text(obj)"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+        yield escape(force_text(obj))"
            }
        },
        "frontPatchFile": [
            "from django.core.exceptions import ValidationError",
            "",
            "from shuup.utils.django_compat import force_text",
            "",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "",
            "",
            "class Problem(Exception):",
            "    \"\"\" User-visible exception. \"\"\"",
            "",
            "    message = property(lambda self: self.args[0] if self.args else None)",
            "",
            "    def __init__(self, message, title=None):",
            "        super(Problem, self).__init__(message)",
            "        self.title = title",
            "        self.links = []",
            "",
            "    def with_link(self, url, title):",
            "        \"\"\"",
            "        Append a link to this Problem and return itself.",
            "",
            "        This API is designed after `Exception.with_traceback()`,",
            "        so you can fluently chain this in a `raise` statement::",
            "",
            "            raise Problem(\"Oops\").with_link(\"...\", \"...\")",
            "",
            "        :param url: URL string.",
            "        :type url: str",
            "        :param title: Title text.",
            "        :type title: str",
            "        :return: This same Problem.",
            "        :rtype: shuup.utils.excs.Problem",
            "        \"\"\"",
            "        self.links.append({\"url\": url, \"title\": title})",
            "        return self",
            "",
            "",
            "class ExceptionalResponse(Exception):",
            "    def __init__(self, response):",
            "        self.response = response",
            "        super(ExceptionalResponse, self).__init__(force_text(response))",
            "",
            "",
            "def extract_messages(obj_list):",
            "    \"\"\"",
            "    Extract \"messages\" from a list of exceptions or other objects.",
            "",
            "    For ValidationErrors, `messages` are flattened into the output.",
            "    For Exceptions, `args[0]` is added into the output.",
            "    For other objects, `force_text` is called.",
            "",
            "    :param obj_list: List of exceptions etc.",
            "    :type obj_list: Iterable[object]",
            "    :rtype: Iterable[str]",
            "    \"\"\"",
            "    for obj in obj_list:",
            "        if isinstance(obj, ValidationError):",
            "            for msg in obj.messages:",
            "                yield force_text(msg)",
            "            continue",
            "        if isinstance(obj, Exception):",
            "            if len(obj.args):",
            "                yield force_text(obj.args[0])",
            "                continue",
            "        yield force_text(obj)"
        ],
        "afterPatchFile": [
            "from django.core.exceptions import ValidationError",
            "from django.utils.html import escape",
            "",
            "from shuup.utils.django_compat import force_text",
            "",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "",
            "",
            "class Problem(Exception):",
            "    \"\"\" User-visible exception. \"\"\"",
            "",
            "    message = property(lambda self: self.args[0] if self.args else None)",
            "",
            "    def __init__(self, message, title=None):",
            "        super(Problem, self).__init__(message)",
            "        self.title = title",
            "        self.links = []",
            "",
            "    def with_link(self, url, title):",
            "        \"\"\"",
            "        Append a link to this Problem and return itself.",
            "",
            "        This API is designed after `Exception.with_traceback()`,",
            "        so you can fluently chain this in a `raise` statement::",
            "",
            "            raise Problem(\"Oops\").with_link(\"...\", \"...\")",
            "",
            "        :param url: URL string.",
            "        :type url: str",
            "        :param title: Title text.",
            "        :type title: str",
            "        :return: This same Problem.",
            "        :rtype: shuup.utils.excs.Problem",
            "        \"\"\"",
            "        self.links.append({\"url\": url, \"title\": title})",
            "        return self",
            "",
            "",
            "class ExceptionalResponse(Exception):",
            "    def __init__(self, response):",
            "        self.response = response",
            "        super(ExceptionalResponse, self).__init__(force_text(response))",
            "",
            "",
            "def extract_messages(obj_list):",
            "    \"\"\"",
            "    Extract \"messages\" from a list of exceptions or other objects.",
            "",
            "    For ValidationErrors, `messages` are flattened into the output.",
            "    For Exceptions, `args[0]` is added into the output.",
            "    For other objects, `force_text` is called.",
            "",
            "    :param obj_list: List of exceptions etc.",
            "    :type obj_list: Iterable[object]",
            "    :rtype: Iterable[str]",
            "    \"\"\"",
            "    for obj in obj_list:",
            "        if isinstance(obj, ValidationError):",
            "            for msg in obj.messages:",
            "                yield escape(force_text(msg))",
            "            continue",
            "        if isinstance(obj, Exception):",
            "            if len(obj.args):",
            "                yield escape(force_text(obj.args[0]))",
            "                continue",
            "        yield escape(force_text(obj))"
        ],
        "action": [
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "64": [
                "extract_messages"
            ],
            "68": [
                "extract_messages"
            ],
            "70": [
                "extract_messages"
            ]
        },
        "addLocation": []
    },
    "shuup/xtheme/urls.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " urlpatterns = ["
            },
            "2": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": "     url(r\"^xtheme/editor/$\", EditorView.as_view(), name=\"xtheme_editor\"),"
            },
            "3": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    url(r\"^xtheme/(?P<view>.+)/*$\", extra_view_dispatch, name=\"xtheme_extra_view\"),"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+    url(r\"^xtheme/(?P<view>.+)/?$\", extra_view_dispatch, name=\"xtheme_extra_view\"),"
            },
            "5": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": "     url(r\"^xtheme/$\", command_dispatch, name=\"xtheme\"),"
            },
            "6": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": "     url("
            },
            "7": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": "         r\"^xtheme-prod-hl/(?P<plugin_type>.*)/(?P<cutoff_days>\\d+)/(?P<count>\\d+)/(?P<cache_timeout>\\d+)/$\","
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from django.conf.urls import url",
            "",
            "from shuup.xtheme.views.command import command_dispatch",
            "from shuup.xtheme.views.editor import EditorView",
            "from shuup.xtheme.views.extra import extra_view_dispatch",
            "from shuup.xtheme.views.plugins import (",
            "    get_category_products_highlight,",
            "    get_product_cross_sell_highlight,",
            "    get_product_highlight,",
            "    get_prouduct_selections_highlight,",
            ")",
            "",
            "urlpatterns = [",
            "    url(r\"^xtheme/editor/$\", EditorView.as_view(), name=\"xtheme_editor\"),",
            "    url(r\"^xtheme/(?P<view>.+)/*$\", extra_view_dispatch, name=\"xtheme_extra_view\"),",
            "    url(r\"^xtheme/$\", command_dispatch, name=\"xtheme\"),",
            "    url(",
            "        r\"^xtheme-prod-hl/(?P<plugin_type>.*)/(?P<cutoff_days>\\d+)/(?P<count>\\d+)/(?P<cache_timeout>\\d+)/$\",",
            "        get_product_highlight,",
            "        name=\"xtheme-product-highlight\",",
            "    ),",
            "    url(",
            "        r\"\"\"",
            "            ^xtheme-prod-cross-sell-hl/",
            "            (?P<product_id>.*)/(?P<relation_type>.*)/(?P<use_parents>\\d+)/",
            "            (?P<count>\\d+)/(?P<cache_timeout>\\d+)/$",
            "        \"\"\".strip(),",
            "        get_product_cross_sell_highlight,",
            "        name=\"xtheme-product-cross-sells-highlight\",",
            "    ),",
            "    url(",
            "        r\"^xtheme-cat-products-hl/(?P<category_id>\\d+)/(?P<count>\\d+)/(?P<cache_timeout>\\d+)/$\",",
            "        get_category_products_highlight,",
            "        name=\"xtheme-category-products-highlight\",",
            "    ),",
            "    url(",
            "        r\"^xtheme-prod-selections-hl/(?P<product_ids>.*)/(?P<cache_timeout>\\d+)/$\",",
            "        get_prouduct_selections_highlight,",
            "        name=\"xtheme-product-selections-highlight\",",
            "    ),",
            "]"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from django.conf.urls import url",
            "",
            "from shuup.xtheme.views.command import command_dispatch",
            "from shuup.xtheme.views.editor import EditorView",
            "from shuup.xtheme.views.extra import extra_view_dispatch",
            "from shuup.xtheme.views.plugins import (",
            "    get_category_products_highlight,",
            "    get_product_cross_sell_highlight,",
            "    get_product_highlight,",
            "    get_prouduct_selections_highlight,",
            ")",
            "",
            "urlpatterns = [",
            "    url(r\"^xtheme/editor/$\", EditorView.as_view(), name=\"xtheme_editor\"),",
            "    url(r\"^xtheme/(?P<view>.+)/?$\", extra_view_dispatch, name=\"xtheme_extra_view\"),",
            "    url(r\"^xtheme/$\", command_dispatch, name=\"xtheme\"),",
            "    url(",
            "        r\"^xtheme-prod-hl/(?P<plugin_type>.*)/(?P<cutoff_days>\\d+)/(?P<count>\\d+)/(?P<cache_timeout>\\d+)/$\",",
            "        get_product_highlight,",
            "        name=\"xtheme-product-highlight\",",
            "    ),",
            "    url(",
            "        r\"\"\"",
            "            ^xtheme-prod-cross-sell-hl/",
            "            (?P<product_id>.*)/(?P<relation_type>.*)/(?P<use_parents>\\d+)/",
            "            (?P<count>\\d+)/(?P<cache_timeout>\\d+)/$",
            "        \"\"\".strip(),",
            "        get_product_cross_sell_highlight,",
            "        name=\"xtheme-product-cross-sells-highlight\",",
            "    ),",
            "    url(",
            "        r\"^xtheme-cat-products-hl/(?P<category_id>\\d+)/(?P<count>\\d+)/(?P<cache_timeout>\\d+)/$\",",
            "        get_category_products_highlight,",
            "        name=\"xtheme-category-products-highlight\",",
            "    ),",
            "    url(",
            "        r\"^xtheme-prod-selections-hl/(?P<product_ids>.*)/(?P<cache_timeout>\\d+)/$\",",
            "        get_prouduct_selections_highlight,",
            "        name=\"xtheme-product-selections-highlight\",",
            "    ),",
            "]"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "22": []
        },
        "addLocation": []
    },
    "shuup/xtheme/views/command.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " # This source code is licensed under the OSL-3.0 license found in the"
            },
            "1": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " # LICENSE file in the root directory of this source tree."
            },
            "2": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from django.http.response import HttpResponseRedirect"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "4": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from shuup.utils.excs import Problem"
            },
            "6": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from shuup.xtheme.editing import set_edit_mode"
            },
            "7": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 43,
                "PatchRowcode": "         response = handle_command(request, command)"
            },
            "8": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "         if response:"
            },
            "9": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "             return response"
            },
            "10": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    raise Problem(\"Error! Unknown command: `%r`\" % command)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+    raise Problem(\"Error! Unknown command: `%r`\" % escape(command))"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from django.http.response import HttpResponseRedirect",
            "",
            "from shuup.utils.excs import Problem",
            "from shuup.xtheme.editing import set_edit_mode",
            "",
            "",
            "def handle_command(request, command):",
            "    \"\"\"",
            "    Internal dispatch function.",
            "",
            "    :param request: A request",
            "    :type request: django.http.HttpRequest",
            "    :param command: Command string",
            "    :type command: str",
            "    :return: A response",
            "    :rtype: django.http.HttpResponse",
            "    \"\"\"",
            "    path = request.POST.get(\"path\") or request.META.get(\"HTTP_REFERER\") or \"/\"",
            "    if command == \"edit_on\" or command == \"edit_off\":",
            "        set_edit_mode(request, command.endswith(\"_on\"))",
            "        return HttpResponseRedirect(path)",
            "",
            "",
            "def command_dispatch(request):",
            "    \"\"\"",
            "    Xtheme command dispatch view.",
            "",
            "    :param request: A request",
            "    :type request: django.http.HttpRequest",
            "    :return: A response",
            "    :rtype: django.http.HttpResponse",
            "    \"\"\"",
            "    command = request.POST.get(\"command\")",
            "    if command:",
            "        response = handle_command(request, command)",
            "        if response:",
            "            return response",
            "    raise Problem(\"Error! Unknown command: `%r`\" % command)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from django.http.response import HttpResponseRedirect",
            "from django.utils.html import escape",
            "",
            "from shuup.utils.excs import Problem",
            "from shuup.xtheme.editing import set_edit_mode",
            "",
            "",
            "def handle_command(request, command):",
            "    \"\"\"",
            "    Internal dispatch function.",
            "",
            "    :param request: A request",
            "    :type request: django.http.HttpRequest",
            "    :param command: Command string",
            "    :type command: str",
            "    :return: A response",
            "    :rtype: django.http.HttpResponse",
            "    \"\"\"",
            "    path = request.POST.get(\"path\") or request.META.get(\"HTTP_REFERER\") or \"/\"",
            "    if command == \"edit_on\" or command == \"edit_off\":",
            "        set_edit_mode(request, command.endswith(\"_on\"))",
            "        return HttpResponseRedirect(path)",
            "",
            "",
            "def command_dispatch(request):",
            "    \"\"\"",
            "    Xtheme command dispatch view.",
            "",
            "    :param request: A request",
            "    :type request: django.http.HttpRequest",
            "    :return: A response",
            "    :rtype: django.http.HttpResponse",
            "    \"\"\"",
            "    command = request.POST.get(\"command\")",
            "    if command:",
            "        response = handle_command(request, command)",
            "        if response:",
            "            return response",
            "    raise Problem(\"Error! Unknown command: `%r`\" % escape(command))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "45": [
                "command_dispatch"
            ]
        },
        "addLocation": []
    },
    "shuup/xtheme/views/editor.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " import json"
            },
            "1": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from django.http.response import HttpResponse, HttpResponseRedirect"
            },
            "2": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from django.middleware.csrf import get_token"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "4": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from django.utils.http import urlencode"
            },
            "5": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from django.utils.translation import ugettext_lazy as _"
            },
            "6": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from django.views.generic import TemplateView"
            },
            "7": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "         if command:"
            },
            "8": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "             dispatcher = getattr(self, \"dispatch_%s\" % command, None)"
            },
            "9": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "             if not callable(dispatcher):"
            },
            "10": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                raise Problem(_(\"Unknown command: `%s`.\") % command)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+                raise Problem(_(\"Unknown command: `%s`.\") % escape(command))"
            },
            "12": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "             dispatch_kwargs = dict(request.POST.items())"
            },
            "13": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "             rv = dispatcher(**dispatch_kwargs)"
            },
            "14": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "             if rv:"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "import json",
            "from django.http.response import HttpResponse, HttpResponseRedirect",
            "from django.middleware.csrf import get_token",
            "from django.utils.http import urlencode",
            "from django.utils.translation import ugettext_lazy as _",
            "from django.views.generic import TemplateView",
            "",
            "from shuup.utils.excs import Problem",
            "from shuup.xtheme import XTHEME_GLOBAL_VIEW_NAME",
            "from shuup.xtheme._theme import get_theme_by_identifier",
            "from shuup.xtheme.editing import could_edit",
            "from shuup.xtheme.layout import Layout",
            "from shuup.xtheme.layout.utils import get_provided_layouts",
            "from shuup.xtheme.view_config import ViewConfig",
            "from shuup.xtheme.views.forms import LayoutCellFormGroup",
            "",
            "# since layouts will most likely break with multiple cells per row, we are",
            "# limiting the amount.",
            "ROW_CELL_LIMIT = 4",
            "",
            "",
            "class EditorView(TemplateView):",
            "    template_name = \"shuup/xtheme/editor.jinja\"",
            "    xtheme_injection = False  # We don't need the editing injection here, so opt-out",
            "    changed = False  # Overridden in `save_layout`",
            "",
            "    def _get_default_layout(self):",
            "        try:",
            "            return json.loads(self.request.GET[\"default_config\"])",
            "        except (ValueError, KeyError):",
            "            return None",
            "",
            "    def get_context_data(self, **kwargs):  # doccov: ignore",
            "        ctx = super(EditorView, self).get_context_data(**kwargs)",
            "        ctx[\"layout\"] = self.layout",
            "        ctx[\"csrf_token_str\"] = get_token(self.request)",
            "        # ctx[\"layout_debug\"] = pformat(ctx[\"layout\"].serialize())",
            "        ctx[\"current_cell_coords\"] = self.current_cell_coords",
            "        ctx[\"current_cell\"] = self.current_cell",
            "        ctx[\"form\"] = self.form",
            "        ctx[\"changed\"] = self.changed",
            "        ctx[\"cell_limit\"] = ROW_CELL_LIMIT",
            "        return ctx",
            "",
            "    def dispatch(self, request, *args, **kwargs):  # doccov: ignore",
            "        if not could_edit(request):",
            "            raise Problem(_(\"No access to editing.\"))",
            "        self._populate_vars()",
            "        if self.default_layout:",
            "            self.view_config.save_default_placeholder_layout(self.placeholder_name, self.default_layout)",
            "            # We saved the default layout, so get rid of the humongous GET arg and try again",
            "            get_args = dict(self.request.GET.items())",
            "            get_args.pop(\"default_config\", None)",
            "            global_type = get_args.pop(\"global_type\", None)",
            "            if global_type:",
            "                get_args[\"view\"] = XTHEME_GLOBAL_VIEW_NAME",
            "            # We are overriding the view with XTHEME_GLOBAL_VIEW_NAME if this is a global placeholder",
            "            return HttpResponseRedirect(\"%s?%s\" % (self.request.path, urlencode(get_args)))",
            "        return super(EditorView, self).dispatch(request, *args, **kwargs)",
            "",
            "    def post(self, request, *args, **kwargs):  # doccov: ignore",
            "        command = request.POST.get(\"command\")",
            "        if command:",
            "            dispatcher = getattr(self, \"dispatch_%s\" % command, None)",
            "            if not callable(dispatcher):",
            "                raise Problem(_(\"Unknown command: `%s`.\") % command)",
            "            dispatch_kwargs = dict(request.POST.items())",
            "            rv = dispatcher(**dispatch_kwargs)",
            "            if rv:",
            "                return rv",
            "            self.request.method = \"GET\"  # At this point, we won't want to cause form validation",
            "            self.build_form()  # and it's not a bad idea to rebuild the form",
            "            return super(EditorView, self).get(request, *args, **kwargs)",
            "",
            "        if request.POST.get(\"save\") and self.form and self.form.is_valid():",
            "            self.form.save()",
            "            self.save_layout()",
            "",
            "            # after we save the new layout configs, make sure to reload the saved data in forms",
            "            # so the returned get() response contains updated data",
            "            self.build_form()",
            "",
            "            if request.POST.get(\"publish\") == \"1\":",
            "                return self.dispatch_publish()",
            "",
            "        return self.get(request, *args, **kwargs)",
            "",
            "    def _populate_vars(self):",
            "        theme = get_theme_by_identifier(self.request.GET[\"theme\"], self.request.shop)",
            "        if not theme:",
            "            raise Problem(_(\"Unable to determine the current theme.\"))",
            "        view_name = self.request.GET[\"view\"]",
            "        global_type = self.request.GET.get(\"global_type\", None)",
            "        self.view_config = ViewConfig(",
            "            theme=theme,",
            "            shop=self.request.shop,",
            "            view_name=view_name,",
            "            draft=True,",
            "            global_type=global_type,",
            "        )",
            "",
            "        # Let's store the layout data key for save here",
            "        self.layout_data_key = self.request.GET.get(\"layout_data_key\", None)",
            "",
            "        # Let's use the layout identifier passed by the view to",
            "        # fetch correct layout",
            "        layout_identifier = self.request.GET.get(\"layout_identifier\", None)",
            "        layout_cls = Layout",
            "        for provided_layout in get_provided_layouts():",
            "            if provided_layout.identifier == layout_identifier:",
            "                layout_cls = provided_layout",
            "",
            "        self.placeholder_name = self.request.GET[\"ph\"]",
            "        self.default_layout = self._get_default_layout()",
            "        self.layout = self.view_config.get_placeholder_layout(",
            "            layout_cls=layout_cls,",
            "            placeholder_name=self.placeholder_name,",
            "            default_layout=self.default_layout,",
            "            layout_data_key=self.layout_data_key,",
            "        )",
            "        (x, y) = self.current_cell_coords = (",
            "            int(self.request.GET.get(\"x\", -1)),",
            "            int(self.request.GET.get(\"y\", -1)),",
            "        )",
            "        self.current_cell = self.layout.get_cell(x=x, y=y)",
            "        self.build_form()",
            "",
            "    def build_form(self):",
            "        if not self.current_cell:",
            "            self.form = None",
            "            return",
            "        kwargs = {\"layout_cell\": self.current_cell, \"theme\": self.view_config.theme, \"request\": self.request}",
            "        if self.request.method == \"POST\":",
            "            kwargs[\"data\"] = self.request.POST",
            "            kwargs[\"files\"] = self.request.FILES",
            "        self.form = LayoutCellFormGroup(**kwargs)",
            "",
            "    def save_layout(self, layout=None):",
            "        self.view_config.save_placeholder_layout(layout_data_key=self.layout_data_key, layout=(layout or self.layout))",
            "        self.changed = True",
            "",
            "    def dispatch_add_cell(self, y, **kwargs):",
            "        y = int(y)",
            "        if len(self.layout.rows[y].cells) >= ROW_CELL_LIMIT:",
            "            raise ValueError(_(\"Can't add more than %d cells in one row.\") % ROW_CELL_LIMIT)",
            "",
            "        if not (0 <= y < len(self.layout.rows)):",
            "            # No need to raise an exception, really.",
            "            # It must have been a honest mistake.",
            "            return",
            "        self.layout.rows[y].add_cell()",
            "        self.save_layout()",
            "",
            "    def dispatch_add_row(self, y=None, **kwargs):",
            "        row = self.layout.insert_row(y)",
            "        row.add_cell()  # For convenience, add a cell to the row.",
            "        self.save_layout()",
            "",
            "    def dispatch_del_row(self, y, **kwargs):",
            "        self.layout.delete_row(y)",
            "        self.save_layout()",
            "",
            "    def dispatch_move_row_to_index(self, from_y, to_y, **kwargs):",
            "        self.layout.move_row_to_index(from_y, to_y)",
            "        self.save_layout()",
            "",
            "    def dispatch_move_cell_to_position(self, from_x, from_y, to_x, to_y, **kwargs):",
            "        self.layout.move_cell_to_position(from_x, from_y, to_x, to_y)",
            "        self.save_layout()",
            "",
            "    def dispatch_del_cell(self, x, y, **kwargs):",
            "        self.layout.delete_cell(x, y)",
            "        self.save_layout()",
            "",
            "    def dispatch_change_plugin(self, plugin=\"\", **kwargs):",
            "        if self.current_cell:",
            "            if not plugin:",
            "                plugin = None",
            "            self.current_cell.plugin_identifier = plugin",
            "            self.save_layout()",
            "",
            "    def dispatch_publish(self, **kwargs):",
            "        self.view_config.publish()",
            "        return HttpResponse(\"<html><script>parent.location.reload()</script>%s.</html>\" % _(\"Published\"))",
            "",
            "    def dispatch_revert(self, **kwargs):",
            "        self.view_config.revert()",
            "        return HttpResponse(\"<html><script>parent.location.reload()</script>%s.</html>\" % _(\"Reverted\"))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "import json",
            "from django.http.response import HttpResponse, HttpResponseRedirect",
            "from django.middleware.csrf import get_token",
            "from django.utils.html import escape",
            "from django.utils.http import urlencode",
            "from django.utils.translation import ugettext_lazy as _",
            "from django.views.generic import TemplateView",
            "",
            "from shuup.utils.excs import Problem",
            "from shuup.xtheme import XTHEME_GLOBAL_VIEW_NAME",
            "from shuup.xtheme._theme import get_theme_by_identifier",
            "from shuup.xtheme.editing import could_edit",
            "from shuup.xtheme.layout import Layout",
            "from shuup.xtheme.layout.utils import get_provided_layouts",
            "from shuup.xtheme.view_config import ViewConfig",
            "from shuup.xtheme.views.forms import LayoutCellFormGroup",
            "",
            "# since layouts will most likely break with multiple cells per row, we are",
            "# limiting the amount.",
            "ROW_CELL_LIMIT = 4",
            "",
            "",
            "class EditorView(TemplateView):",
            "    template_name = \"shuup/xtheme/editor.jinja\"",
            "    xtheme_injection = False  # We don't need the editing injection here, so opt-out",
            "    changed = False  # Overridden in `save_layout`",
            "",
            "    def _get_default_layout(self):",
            "        try:",
            "            return json.loads(self.request.GET[\"default_config\"])",
            "        except (ValueError, KeyError):",
            "            return None",
            "",
            "    def get_context_data(self, **kwargs):  # doccov: ignore",
            "        ctx = super(EditorView, self).get_context_data(**kwargs)",
            "        ctx[\"layout\"] = self.layout",
            "        ctx[\"csrf_token_str\"] = get_token(self.request)",
            "        # ctx[\"layout_debug\"] = pformat(ctx[\"layout\"].serialize())",
            "        ctx[\"current_cell_coords\"] = self.current_cell_coords",
            "        ctx[\"current_cell\"] = self.current_cell",
            "        ctx[\"form\"] = self.form",
            "        ctx[\"changed\"] = self.changed",
            "        ctx[\"cell_limit\"] = ROW_CELL_LIMIT",
            "        return ctx",
            "",
            "    def dispatch(self, request, *args, **kwargs):  # doccov: ignore",
            "        if not could_edit(request):",
            "            raise Problem(_(\"No access to editing.\"))",
            "        self._populate_vars()",
            "        if self.default_layout:",
            "            self.view_config.save_default_placeholder_layout(self.placeholder_name, self.default_layout)",
            "            # We saved the default layout, so get rid of the humongous GET arg and try again",
            "            get_args = dict(self.request.GET.items())",
            "            get_args.pop(\"default_config\", None)",
            "            global_type = get_args.pop(\"global_type\", None)",
            "            if global_type:",
            "                get_args[\"view\"] = XTHEME_GLOBAL_VIEW_NAME",
            "            # We are overriding the view with XTHEME_GLOBAL_VIEW_NAME if this is a global placeholder",
            "            return HttpResponseRedirect(\"%s?%s\" % (self.request.path, urlencode(get_args)))",
            "        return super(EditorView, self).dispatch(request, *args, **kwargs)",
            "",
            "    def post(self, request, *args, **kwargs):  # doccov: ignore",
            "        command = request.POST.get(\"command\")",
            "        if command:",
            "            dispatcher = getattr(self, \"dispatch_%s\" % command, None)",
            "            if not callable(dispatcher):",
            "                raise Problem(_(\"Unknown command: `%s`.\") % escape(command))",
            "            dispatch_kwargs = dict(request.POST.items())",
            "            rv = dispatcher(**dispatch_kwargs)",
            "            if rv:",
            "                return rv",
            "            self.request.method = \"GET\"  # At this point, we won't want to cause form validation",
            "            self.build_form()  # and it's not a bad idea to rebuild the form",
            "            return super(EditorView, self).get(request, *args, **kwargs)",
            "",
            "        if request.POST.get(\"save\") and self.form and self.form.is_valid():",
            "            self.form.save()",
            "            self.save_layout()",
            "",
            "            # after we save the new layout configs, make sure to reload the saved data in forms",
            "            # so the returned get() response contains updated data",
            "            self.build_form()",
            "",
            "            if request.POST.get(\"publish\") == \"1\":",
            "                return self.dispatch_publish()",
            "",
            "        return self.get(request, *args, **kwargs)",
            "",
            "    def _populate_vars(self):",
            "        theme = get_theme_by_identifier(self.request.GET[\"theme\"], self.request.shop)",
            "        if not theme:",
            "            raise Problem(_(\"Unable to determine the current theme.\"))",
            "        view_name = self.request.GET[\"view\"]",
            "        global_type = self.request.GET.get(\"global_type\", None)",
            "        self.view_config = ViewConfig(",
            "            theme=theme,",
            "            shop=self.request.shop,",
            "            view_name=view_name,",
            "            draft=True,",
            "            global_type=global_type,",
            "        )",
            "",
            "        # Let's store the layout data key for save here",
            "        self.layout_data_key = self.request.GET.get(\"layout_data_key\", None)",
            "",
            "        # Let's use the layout identifier passed by the view to",
            "        # fetch correct layout",
            "        layout_identifier = self.request.GET.get(\"layout_identifier\", None)",
            "        layout_cls = Layout",
            "        for provided_layout in get_provided_layouts():",
            "            if provided_layout.identifier == layout_identifier:",
            "                layout_cls = provided_layout",
            "",
            "        self.placeholder_name = self.request.GET[\"ph\"]",
            "        self.default_layout = self._get_default_layout()",
            "        self.layout = self.view_config.get_placeholder_layout(",
            "            layout_cls=layout_cls,",
            "            placeholder_name=self.placeholder_name,",
            "            default_layout=self.default_layout,",
            "            layout_data_key=self.layout_data_key,",
            "        )",
            "        (x, y) = self.current_cell_coords = (",
            "            int(self.request.GET.get(\"x\", -1)),",
            "            int(self.request.GET.get(\"y\", -1)),",
            "        )",
            "        self.current_cell = self.layout.get_cell(x=x, y=y)",
            "        self.build_form()",
            "",
            "    def build_form(self):",
            "        if not self.current_cell:",
            "            self.form = None",
            "            return",
            "        kwargs = {\"layout_cell\": self.current_cell, \"theme\": self.view_config.theme, \"request\": self.request}",
            "        if self.request.method == \"POST\":",
            "            kwargs[\"data\"] = self.request.POST",
            "            kwargs[\"files\"] = self.request.FILES",
            "        self.form = LayoutCellFormGroup(**kwargs)",
            "",
            "    def save_layout(self, layout=None):",
            "        self.view_config.save_placeholder_layout(layout_data_key=self.layout_data_key, layout=(layout or self.layout))",
            "        self.changed = True",
            "",
            "    def dispatch_add_cell(self, y, **kwargs):",
            "        y = int(y)",
            "        if len(self.layout.rows[y].cells) >= ROW_CELL_LIMIT:",
            "            raise ValueError(_(\"Can't add more than %d cells in one row.\") % ROW_CELL_LIMIT)",
            "",
            "        if not (0 <= y < len(self.layout.rows)):",
            "            # No need to raise an exception, really.",
            "            # It must have been a honest mistake.",
            "            return",
            "        self.layout.rows[y].add_cell()",
            "        self.save_layout()",
            "",
            "    def dispatch_add_row(self, y=None, **kwargs):",
            "        row = self.layout.insert_row(y)",
            "        row.add_cell()  # For convenience, add a cell to the row.",
            "        self.save_layout()",
            "",
            "    def dispatch_del_row(self, y, **kwargs):",
            "        self.layout.delete_row(y)",
            "        self.save_layout()",
            "",
            "    def dispatch_move_row_to_index(self, from_y, to_y, **kwargs):",
            "        self.layout.move_row_to_index(from_y, to_y)",
            "        self.save_layout()",
            "",
            "    def dispatch_move_cell_to_position(self, from_x, from_y, to_x, to_y, **kwargs):",
            "        self.layout.move_cell_to_position(from_x, from_y, to_x, to_y)",
            "        self.save_layout()",
            "",
            "    def dispatch_del_cell(self, x, y, **kwargs):",
            "        self.layout.delete_cell(x, y)",
            "        self.save_layout()",
            "",
            "    def dispatch_change_plugin(self, plugin=\"\", **kwargs):",
            "        if self.current_cell:",
            "            if not plugin:",
            "                plugin = None",
            "            self.current_cell.plugin_identifier = plugin",
            "            self.save_layout()",
            "",
            "    def dispatch_publish(self, **kwargs):",
            "        self.view_config.publish()",
            "        return HttpResponse(\"<html><script>parent.location.reload()</script>%s.</html>\" % _(\"Published\"))",
            "",
            "    def dispatch_revert(self, **kwargs):",
            "        self.view_config.revert()",
            "        return HttpResponse(\"<html><script>parent.location.reload()</script>%s.</html>\" % _(\"Reverted\"))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "73": [
                "EditorView",
                "post"
            ]
        },
        "addLocation": []
    },
    "shuup/xtheme/views/extra.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from django.core.exceptions import ImproperlyConfigured"
            },
            "1": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from django.core.signals import setting_changed"
            },
            "2": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from django.http.response import HttpResponseNotFound"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+from django.utils.html import escape"
            },
            "4": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from shuup.xtheme._theme import get_current_theme"
            },
            "6": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 57,
                "PatchRowcode": "     theme = getattr(request, \"theme\", None) or get_current_theme(request.shop)"
            },
            "8": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 58,
                "PatchRowcode": "     view_func = get_view_by_name(theme, view)"
            },
            "9": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 59,
                "PatchRowcode": "     if not view_func:"
            },
            "10": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        msg = \"Error! %s/%s: Not found.\" % (getattr(theme, \"identifier\", None), view)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+        msg = \"Error! %s/%s: Not found.\" % (getattr(theme, \"identifier\", None), escape(view))"
            },
            "12": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "         return HttpResponseNotFound(msg)"
            },
            "13": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "     return view_func(request)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from django.core.exceptions import ImproperlyConfigured",
            "from django.core.signals import setting_changed",
            "from django.http.response import HttpResponseNotFound",
            "",
            "from shuup.xtheme._theme import get_current_theme",
            "",
            "_VIEW_CACHE = {}",
            "",
            "",
            "def clear_view_cache(**kwargs):",
            "    _VIEW_CACHE.clear()",
            "",
            "",
            "setting_changed.connect(clear_view_cache, dispatch_uid=\"shuup.xtheme.views.extra.clear_view_cache\")",
            "",
            "",
            "def _get_view_by_name(theme, view_name):",
            "    view = theme.get_view(view_name)",
            "    if hasattr(view, \"as_view\"):  # Handle CBVs",
            "        view = view.as_view()",
            "    if view and not callable(view):",
            "        raise ImproperlyConfigured(\"Error! View `%r` is not callable.\" % view)",
            "    return view",
            "",
            "",
            "def get_view_by_name(theme, view_name):",
            "    if not theme:",
            "        return None",
            "    cache_key = (theme.identifier, view_name)",
            "    if cache_key not in _VIEW_CACHE:",
            "        view = _get_view_by_name(theme, view_name)",
            "        _VIEW_CACHE[cache_key] = view",
            "    else:",
            "        view = _VIEW_CACHE[cache_key]",
            "    return view",
            "",
            "",
            "def extra_view_dispatch(request, view):",
            "    \"\"\"",
            "    Dispatch to an Xtheme extra view.",
            "",
            "    :param request: A request.",
            "    :type request: django.http.HttpRequest",
            "    :param view: View name.",
            "    :type view: str",
            "    :return: A response of some kind.",
            "    :rtype: django.http.HttpResponse",
            "    \"\"\"",
            "    theme = getattr(request, \"theme\", None) or get_current_theme(request.shop)",
            "    view_func = get_view_by_name(theme, view)",
            "    if not view_func:",
            "        msg = \"Error! %s/%s: Not found.\" % (getattr(theme, \"identifier\", None), view)",
            "        return HttpResponseNotFound(msg)",
            "    return view_func(request)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# This file is part of Shuup.",
            "#",
            "# Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.",
            "#",
            "# This source code is licensed under the OSL-3.0 license found in the",
            "# LICENSE file in the root directory of this source tree.",
            "from django.core.exceptions import ImproperlyConfigured",
            "from django.core.signals import setting_changed",
            "from django.http.response import HttpResponseNotFound",
            "from django.utils.html import escape",
            "",
            "from shuup.xtheme._theme import get_current_theme",
            "",
            "_VIEW_CACHE = {}",
            "",
            "",
            "def clear_view_cache(**kwargs):",
            "    _VIEW_CACHE.clear()",
            "",
            "",
            "setting_changed.connect(clear_view_cache, dispatch_uid=\"shuup.xtheme.views.extra.clear_view_cache\")",
            "",
            "",
            "def _get_view_by_name(theme, view_name):",
            "    view = theme.get_view(view_name)",
            "    if hasattr(view, \"as_view\"):  # Handle CBVs",
            "        view = view.as_view()",
            "    if view and not callable(view):",
            "        raise ImproperlyConfigured(\"Error! View `%r` is not callable.\" % view)",
            "    return view",
            "",
            "",
            "def get_view_by_name(theme, view_name):",
            "    if not theme:",
            "        return None",
            "    cache_key = (theme.identifier, view_name)",
            "    if cache_key not in _VIEW_CACHE:",
            "        view = _get_view_by_name(theme, view_name)",
            "        _VIEW_CACHE[cache_key] = view",
            "    else:",
            "        view = _VIEW_CACHE[cache_key]",
            "    return view",
            "",
            "",
            "def extra_view_dispatch(request, view):",
            "    \"\"\"",
            "    Dispatch to an Xtheme extra view.",
            "",
            "    :param request: A request.",
            "    :type request: django.http.HttpRequest",
            "    :param view: View name.",
            "    :type view: str",
            "    :return: A response of some kind.",
            "    :rtype: django.http.HttpResponse",
            "    \"\"\"",
            "    theme = getattr(request, \"theme\", None) or get_current_theme(request.shop)",
            "    view_func = get_view_by_name(theme, view)",
            "    if not view_func:",
            "        msg = \"Error! %s/%s: Not found.\" % (getattr(theme, \"identifier\", None), escape(view))",
            "        return HttpResponseNotFound(msg)",
            "    return view_func(request)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "59": [
                "extra_view_dispatch"
            ]
        },
        "addLocation": []
    }
}