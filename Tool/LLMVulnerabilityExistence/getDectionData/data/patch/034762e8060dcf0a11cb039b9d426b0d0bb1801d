{
    "nova/scheduler/filters/affinity_filter.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": "     def __init__(self):"
            },
            "1": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 26,
                "PatchRowcode": "         self.compute_api = compute.API()"
            },
            "2": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def _affinity_host(self, context, instance_id):"
            },
            "4": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return self.compute_api.get(context, instance_id)['host']"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+    def _all_hosts(self, context):"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+        all_hosts = {}"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+        for instance in self.compute_api.get_all(context):"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+            all_hosts[instance['uuid']] = instance['host']"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+        return all_hosts"
            },
            "10": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " "
            },
            "12": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " class DifferentHostFilter(AffinityFilter):"
            },
            "13": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "         if isinstance(affinity_uuids, basestring):"
            },
            "14": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "             affinity_uuids = [affinity_uuids]"
            },
            "15": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "         if affinity_uuids:"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+            all_hosts = self._all_hosts(context)"
            },
            "17": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "             return not any([i for i in affinity_uuids"
            },
            "18": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                              if self._affinity_host(context, i) == me])"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+                              if all_hosts.get(i) == me])"
            },
            "20": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "         # With no different_host key"
            },
            "21": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         return True"
            },
            "22": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 52,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "         if isinstance(affinity_uuids, basestring):"
            },
            "24": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "             affinity_uuids = [affinity_uuids]"
            },
            "25": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "         if affinity_uuids:"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+            all_hosts = self._all_hosts(context)"
            },
            "27": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "             return any([i for i"
            },
            "28": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "                           in affinity_uuids"
            },
            "29": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                          if self._affinity_host(context, i) == me])"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+                          if all_hosts.get(i) == me])"
            },
            "31": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "         # With no same_host key"
            },
            "32": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "         return True"
            },
            "33": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 74,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# Copyright 2012, Piston Cloud Computing, Inc.",
            "# Copyright 2012, OpenStack LLC.",
            "# All Rights Reserved.",
            "#",
            "# Licensed under the Apache License, Version 2.0 (the \"License\");",
            "# you may not use this file except in compliance with the License.",
            "# You may obtain a copy of the License at",
            "#",
            "# http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing, software",
            "# distributed under the License is distributed on an \"AS IS\" BASIS,",
            "# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.",
            "# See the License for the specific language governing permissions and",
            "# limitations under the License.",
            "",
            "",
            "import netaddr",
            "",
            "from nova.compute import api as compute",
            "from nova.scheduler import filters",
            "",
            "",
            "class AffinityFilter(filters.BaseHostFilter):",
            "    def __init__(self):",
            "        self.compute_api = compute.API()",
            "",
            "    def _affinity_host(self, context, instance_id):",
            "        return self.compute_api.get(context, instance_id)['host']",
            "",
            "",
            "class DifferentHostFilter(AffinityFilter):",
            "    '''Schedule the instance on a different host from a set of instances.'''",
            "",
            "    def host_passes(self, host_state, filter_properties):",
            "        context = filter_properties['context']",
            "        scheduler_hints = filter_properties.get('scheduler_hints') or {}",
            "        me = host_state.host",
            "",
            "        affinity_uuids = scheduler_hints.get('different_host', [])",
            "        if isinstance(affinity_uuids, basestring):",
            "            affinity_uuids = [affinity_uuids]",
            "        if affinity_uuids:",
            "            return not any([i for i in affinity_uuids",
            "                              if self._affinity_host(context, i) == me])",
            "        # With no different_host key",
            "        return True",
            "",
            "",
            "class SameHostFilter(AffinityFilter):",
            "    '''Schedule the instance on the same host as another instance in a set of",
            "    of instances.",
            "    '''",
            "",
            "    def host_passes(self, host_state, filter_properties):",
            "        context = filter_properties['context']",
            "        scheduler_hints = filter_properties.get('scheduler_hints') or {}",
            "        me = host_state.host",
            "",
            "        affinity_uuids = scheduler_hints.get('same_host', [])",
            "        if isinstance(affinity_uuids, basestring):",
            "            affinity_uuids = [affinity_uuids]",
            "        if affinity_uuids:",
            "            return any([i for i",
            "                          in affinity_uuids",
            "                          if self._affinity_host(context, i) == me])",
            "        # With no same_host key",
            "        return True",
            "",
            "",
            "class SimpleCIDRAffinityFilter(AffinityFilter):",
            "    def host_passes(self, host_state, filter_properties):",
            "        scheduler_hints = filter_properties.get('scheduler_hints') or {}",
            "",
            "        affinity_cidr = scheduler_hints.get('cidr', '/24')",
            "        affinity_host_addr = scheduler_hints.get('build_near_host_ip')",
            "        host_ip = host_state.capabilities.get('host_ip')",
            "        if affinity_host_addr:",
            "            affinity_net = netaddr.IPNetwork(str.join('', (affinity_host_addr,",
            "                                                           affinity_cidr)))",
            "",
            "            return netaddr.IPAddress(host_ip) in affinity_net",
            "",
            "        # We don't have an affinity host address.",
            "        return True"
        ],
        "afterPatchFile": [
            "# Copyright 2012, Piston Cloud Computing, Inc.",
            "# Copyright 2012, OpenStack LLC.",
            "# All Rights Reserved.",
            "#",
            "# Licensed under the Apache License, Version 2.0 (the \"License\");",
            "# you may not use this file except in compliance with the License.",
            "# You may obtain a copy of the License at",
            "#",
            "# http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing, software",
            "# distributed under the License is distributed on an \"AS IS\" BASIS,",
            "# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.",
            "# See the License for the specific language governing permissions and",
            "# limitations under the License.",
            "",
            "",
            "import netaddr",
            "",
            "from nova.compute import api as compute",
            "from nova.scheduler import filters",
            "",
            "",
            "class AffinityFilter(filters.BaseHostFilter):",
            "    def __init__(self):",
            "        self.compute_api = compute.API()",
            "",
            "    def _all_hosts(self, context):",
            "        all_hosts = {}",
            "        for instance in self.compute_api.get_all(context):",
            "            all_hosts[instance['uuid']] = instance['host']",
            "        return all_hosts",
            "",
            "",
            "class DifferentHostFilter(AffinityFilter):",
            "    '''Schedule the instance on a different host from a set of instances.'''",
            "",
            "    def host_passes(self, host_state, filter_properties):",
            "        context = filter_properties['context']",
            "        scheduler_hints = filter_properties.get('scheduler_hints') or {}",
            "        me = host_state.host",
            "",
            "        affinity_uuids = scheduler_hints.get('different_host', [])",
            "        if isinstance(affinity_uuids, basestring):",
            "            affinity_uuids = [affinity_uuids]",
            "        if affinity_uuids:",
            "            all_hosts = self._all_hosts(context)",
            "            return not any([i for i in affinity_uuids",
            "                              if all_hosts.get(i) == me])",
            "        # With no different_host key",
            "        return True",
            "",
            "",
            "class SameHostFilter(AffinityFilter):",
            "    '''Schedule the instance on the same host as another instance in a set of",
            "    of instances.",
            "    '''",
            "",
            "    def host_passes(self, host_state, filter_properties):",
            "        context = filter_properties['context']",
            "        scheduler_hints = filter_properties.get('scheduler_hints') or {}",
            "        me = host_state.host",
            "",
            "        affinity_uuids = scheduler_hints.get('same_host', [])",
            "        if isinstance(affinity_uuids, basestring):",
            "            affinity_uuids = [affinity_uuids]",
            "        if affinity_uuids:",
            "            all_hosts = self._all_hosts(context)",
            "            return any([i for i",
            "                          in affinity_uuids",
            "                          if all_hosts.get(i) == me])",
            "        # With no same_host key",
            "        return True",
            "",
            "",
            "class SimpleCIDRAffinityFilter(AffinityFilter):",
            "    def host_passes(self, host_state, filter_properties):",
            "        scheduler_hints = filter_properties.get('scheduler_hints') or {}",
            "",
            "        affinity_cidr = scheduler_hints.get('cidr', '/24')",
            "        affinity_host_addr = scheduler_hints.get('build_near_host_ip')",
            "        host_ip = host_state.capabilities.get('host_ip')",
            "        if affinity_host_addr:",
            "            affinity_net = netaddr.IPNetwork(str.join('', (affinity_host_addr,",
            "                                                           affinity_cidr)))",
            "",
            "            return netaddr.IPAddress(host_ip) in affinity_net",
            "",
            "        # We don't have an affinity host address.",
            "        return True"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "28": [
                "AffinityFilter",
                "_affinity_host"
            ],
            "29": [
                "AffinityFilter",
                "_affinity_host"
            ],
            "45": [
                "DifferentHostFilter",
                "host_passes"
            ],
            "66": [
                "SameHostFilter",
                "host_passes"
            ]
        },
        "addLocation": []
    }
}