{
    "mobsf/DynamicAnalyzer/views/ios/corellium_instance.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 763,
                "afterPatchRowNumber": 763,
                "PatchRowcode": "         if failed:"
            },
            "1": {
                "beforePatchRowNumber": 764,
                "afterPatchRowNumber": 764,
                "PatchRowcode": "             return send_response(failed, api)"
            },
            "2": {
                "beforePatchRowNumber": 765,
                "afterPatchRowNumber": 765,
                "PatchRowcode": "         if not strict_package_check(bundle_id):"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 766,
                "PatchRowcode": "+            # Check bundle_id during call, as the check"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 767,
                "PatchRowcode": "+            # is not done in REST API/URL repath."
            },
            "5": {
                "beforePatchRowNumber": 766,
                "afterPatchRowNumber": 768,
                "PatchRowcode": "             data['message'] = 'Invalid iOS Bundle id'"
            },
            "6": {
                "beforePatchRowNumber": 767,
                "afterPatchRowNumber": 769,
                "PatchRowcode": "             return send_response(data, api)"
            },
            "7": {
                "beforePatchRowNumber": 768,
                "afterPatchRowNumber": 770,
                "PatchRowcode": "         ci = CorelliumInstanceAPI(instance_id)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"Instance Operation APIs.\"\"\"",
            "import logging",
            "import re",
            "import shutil",
            "import time",
            "from base64 import b64encode",
            "from pathlib import Path",
            "",
            "from paramiko.ssh_exception import SSHException",
            "",
            "from django.conf import settings",
            "from django.views.decorators.http import require_http_methods",
            "from django.http import (",
            "    HttpResponse,",
            ")",
            "from django.shortcuts import (",
            "    render,",
            ")",
            "",
            "from mobsf.MobSF.utils import (",
            "    common_check,",
            "    get_md5,",
            "    id_generator,",
            "    is_md5,",
            "    print_n_send_error_response,",
            "    strict_package_check,",
            ")",
            "from mobsf.DynamicAnalyzer.forms import UploadFileForm",
            "from mobsf.DynamicAnalyzer.tools.webproxy import (",
            "    get_http_tools_url,",
            "    stop_httptools,",
            ")",
            "from mobsf.DynamicAnalyzer.views.common.shared import (",
            "    send_response,",
            ")",
            "from mobsf.DynamicAnalyzer.views.ios.corellium_ssh import (",
            "    ssh_execute_cmd,",
            "    ssh_file_download,",
            "    ssh_file_upload,",
            "    ssh_jump_host,",
            ")",
            "from mobsf.DynamicAnalyzer.views.ios.corellium_apis import (",
            "    CorelliumAPI,",
            "    CorelliumAgentAPI,",
            "    CorelliumInstanceAPI,",
            "    CorelliumModelsAPI,",
            "    OK,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "from mobsf.MobSF.views.authorization import (",
            "    Permissions,",
            "    permission_required,",
            ")",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def start_instance(request, api=False):",
            "    \"\"\"Start iOS VM instance.\"\"\"",
            "    logger.info('Starting iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to start instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.start_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Starting VM Instance'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Start iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def stop_instance(request, api=False):",
            "    \"\"\"Stop iOS VM instance.\"\"\"",
            "    logger.info('Stopping iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to stop instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.stop_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Instance stopped'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Stopping iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def unpause_instance(request, api=False):",
            "    \"\"\"Unpause iOS VM instance.\"\"\"",
            "    logger.info('Unpausing iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to unpause instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.unpause_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Instance unpaused'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Unpausing iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def reboot_instance(request, api=False):",
            "    \"\"\"Reboot iOS VM instance.\"\"\"",
            "    logger.info('Rebooting iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to reboot instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.reboot_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Rebooting instance'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Rebooting iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def destroy_instance(request, api=False):",
            "    \"\"\"Destroy iOS VM instance.\"\"\"",
            "    logger.info('Destroying iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to destroy instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.remove_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Destroying instance'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Destroying iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def list_apps(request, api=False):",
            "    \"\"\"List installed apps.\"\"\"",
            "    logger.info('Listing installed applications')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to list installed apps'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        # Get apps in device",
            "        r = ca.list_apps()",
            "        app_list = []",
            "        bundle_ids = []",
            "        if r and r.get('apps'):",
            "            for i in r.get('apps'):",
            "                bundle = i['bundleID']",
            "                bundle_ids.append(f'bundleID={bundle}')",
            "        elif r and r.get('error'):",
            "            data['message'] = r.get('error')",
            "            verbose = r.get('originalError')",
            "            if verbose:",
            "                data['message'] += f' {verbose}'",
            "            return send_response(data, api)",
            "        else:",
            "            data['message'] = 'Failed to list apps'",
            "            return send_response(data, api)",
            "        # Get app icons",
            "        logger.info('Getting all application icons')",
            "        ic = ca.get_icons('&'.join(bundle_ids))",
            "        for i in r.get('apps'):",
            "            bundleid = i['bundleID']",
            "            checksum = get_md5(bundleid.encode('utf-8'))",
            "            dump_file = Path(",
            "                settings.UPLD_DIR) / checksum / 'mobsf_dump_file.txt'",
            "            if ic and ic.get('icons'):",
            "                icon_url = ic['icons'].get(bundleid)",
            "            else:",
            "                icon_url = ''",
            "            app_list.append({",
            "                'applicationType': i['applicationType'],",
            "                'name': i['name'],",
            "                'bundleID': bundleid,",
            "                'icon': icon_url,",
            "                'checksum': checksum,",
            "                'reportExists': dump_file.exists(),",
            "            })",
            "        data = {",
            "            'status': OK,",
            "            'message': app_list}",
            "",
            "    except Exception as exp:",
            "        logger.exception('Listing installed apps')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def get_supported_models(request, api=False):",
            "    \"\"\"Get Supported iOS VM models.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to obtain iOS models'}",
            "    try:",
            "        cm = CorelliumModelsAPI()",
            "        r = cm.get_models()",
            "        if r:",
            "            data = {'status': OK, 'message': r}",
            "    except Exception as exp:",
            "        logger.exception('Obtaining iOS models')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def get_supported_os(request, api=False):",
            "    \"\"\"Get Supported iOS OS versions.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to obtain iOS versions'}",
            "    try:",
            "        model = request.POST['model']",
            "        cm = CorelliumModelsAPI()",
            "        r = cm.get_supported_os(model)",
            "        if r:",
            "            data = {'status': OK, 'message': r}",
            "    except Exception as exp:",
            "        logger.exception('Obtaining iOS versions')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def create_vm_instance(request, api=False):",
            "    \"\"\"Create and iOS VM in Corellium.\"\"\"",
            "    logger.info('Creating Corellium iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to create an iOS VM'}",
            "    try:",
            "        project_id = request.POST['project_id']",
            "        flavor = request.POST['flavor']",
            "        version = request.POST['version']",
            "        name = request.POST.get('name')",
            "        if not name:",
            "            name = 'MobSF iOS'",
            "        if not re.match(r'^[a-zA-Z0-9 _-]+$', name):",
            "            data['message'] = (",
            "                'Invalid VM name. '",
            "                'Can only contain '",
            "                'letters, numbers, '",
            "                'spaces, hyphens, '",
            "                'and underscores')",
            "            return send_response(data, api)",
            "        if not re.match(r'^iphone\\d*\\w+', flavor):",
            "            data['message'] = 'Invalid iOS flavor'",
            "            return send_response(data, api)",
            "        if not re.match(r'^\\d+\\.\\d+\\.*\\d*', version):",
            "            data['message'] = 'Invalid iOS version'",
            "            return send_response(data, api)",
            "        failed = common_check(project_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        c = CorelliumAPI(project_id)",
            "        r = c.create_ios_instance(name, flavor, version)",
            "        if r:",
            "            data = {",
            "                'status': OK,",
            "                'message': f'Created a new instance with id: {r}'}",
            "    except Exception as exp:",
            "        logger.exception('Creating Corellium iOS VM')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# Helpers for AppSync Install Check & IPA Install",
            "",
            "",
            "def check_appsync(target):",
            "    \"\"\"Check and install AppSync Unified.\"\"\"",
            "    check_install = 'apt list --installed | grep \\'ai.akemi.appinst\\''",
            "    # Check if AppSync Unified is installed",
            "    out = ssh_execute_cmd(target, check_install)",
            "    if 'ai.akemi.appinst' not in out:",
            "        # Install AppSync Unified",
            "        logger.info('AppSync Unified is not installed. '",
            "                    'Attempting to install...')",
            "        src_file = '/etc/apt/sources.list.d/cydia.list'",
            "        src = 'deb https://cydia.akemi.ai/ ./'",
            "        install_cmds = [",
            "            f'grep -qxF \\'{src}\\' {src_file} || echo \\'{src}\\' >> {src_file}',",
            "            'apt update',",
            "            'apt install -y --allow-unauthenticated ai.akemi.appinst',",
            "            'launchctl reboot userspace',",
            "        ]",
            "        for i in install_cmds:",
            "            out = ssh_execute_cmd(target, i)",
            "            logger.info(out)",
            "        logger.info('Please wait for 15 seconds for the userspace to reboot.')",
            "        time.sleep(15)",
            "",
            "",
            "def appsync_ipa_install(ssh_string):",
            "    \"\"\"Install app using AppSync Unified.\"\"\"",
            "    target, jumpbox = ssh_jump_host(ssh_string)",
            "    # AppSync Unified install check",
            "    check_appsync(target)   # This will terminate SSH session",
            "    if target:",
            "        target.close()",
            "    if jumpbox:",
            "        jumpbox.close()",
            "    # Install IPA with AppSync United",
            "    logger.info('Attempting to install the IPA '",
            "                'using AppSync Unified.')",
            "    target, jumpbox = ssh_jump_host(ssh_string)",
            "    out = ssh_execute_cmd(target, 'appinst /tmp/app.ipa')",
            "    target.close()",
            "    jumpbox.close()",
            "    if 'Successfully installed' not in out:",
            "        logger.error('AppSync IPA Install Failed.\\n%s', out)",
            "        return out",
            "    logger.info(out)",
            "    return OK",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def setup_environment(request, checksum, api=False):",
            "    \"\"\"Setup iOS Dynamic Analyzer Environment.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to Setup Dynamic Analysis Environment'}",
            "    try:",
            "        if not is_md5(checksum):",
            "            # Additional Check for REST API",
            "            data['message'] = 'Invalid Hash'",
            "            return send_response(data, api)",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if not ca.agent_ready():",
            "            data['message'] = (",
            "                f'Agent is not ready with {instance_id}'",
            "                ', please wait.')",
            "            return send_response(data, api)",
            "        # Unlock iOS Device",
            "        ca.unlock_device()",
            "        # Upload IPA",
            "        ipa_path = Path(settings.UPLD_DIR) / checksum / f'{checksum}.ipa'",
            "        msg = ca.upload_ipa(ipa_path)",
            "        if msg != OK:",
            "            data['message'] = msg",
            "            return send_response(data, api)",
            "        # Install IPA",
            "        msg = ca.install_ipa()",
            "        if msg != OK:",
            "            if 'Please re-sign.' in msg:",
            "                # Try AppSync IPA Install",
            "                ci = CorelliumInstanceAPI(instance_id)",
            "                out = appsync_ipa_install(ci.get_ssh_connection_string())",
            "                if out and out != OK:",
            "                    data['message'] = out",
            "                    return send_response(data, api)",
            "            else:",
            "                # Other install errors",
            "                data['message'] = msg",
            "                return send_response(data, api)",
            "        msg = 'Testing Environment is Ready!'",
            "        logger.info(msg)",
            "        data['status'] = OK",
            "        data['message'] = msg",
            "    except Exception as exp:",
            "        logger.exception('Creating iOS Dynamic Analyzer Environment')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def run_app(request, api=False):",
            "    \"\"\"Run an App.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to run the app'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        bundle_id = request.POST['bundle_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if (ca.agent_ready()",
            "                and ca.unlock_device()",
            "                and ca.run_app(bundle_id) == OK):",
            "            data['status'] = OK",
            "            data['message'] = 'App Started'",
            "    except Exception as exp:",
            "        logger.exception('Failed to run the app')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def stop_app(request, api=False):",
            "    \"\"\"Stop an App.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to stop the app'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        bundle_id = request.POST['bundle_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if (ca.agent_ready()",
            "                and ca.unlock_device()",
            "                and ca.stop_app(bundle_id) == OK):",
            "            data['status'] = OK",
            "            data['message'] = 'App Killed'",
            "    except Exception as exp:",
            "        logger.exception('Failed to stop the app')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def remove_app(request, api=False):",
            "    \"\"\"Remove an app from the device.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to uninstall the app'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        bundle_id = request.POST['bundle_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if (ca.agent_ready()",
            "                and ca.remove_app(bundle_id) == OK):",
            "            data['status'] = OK",
            "            data['message'] = 'App uninstalled'",
            "    except Exception as exp:",
            "        logger.exception('Failed to uninstall the app')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def take_screenshot(request, api=False):",
            "    \"\"\"Take a Screenshot.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to take screenshot'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        save = request.POST.get('save')",
            "        checksum = request.POST.get('checksum')",
            "        dwd = Path(settings.DWD_DIR)",
            "        if save and checksum:",
            "            if not is_md5(checksum):",
            "                data['message'] = 'Invaid MD5 Hash'",
            "                return send_response(data, api)",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.screenshot()",
            "        if r:",
            "            data['status'] = OK",
            "            if save == '1':",
            "                sfile = dwd / f'{checksum}-sshot-{id_generator()}.png'",
            "                sfile.write_bytes(r)",
            "                data['message'] = 'Screenshot saved!'",
            "            else:",
            "                b64dat = b64encode(r).decode('utf-8')",
            "                data['message'] = f'data:image/png;base64,{b64dat}'",
            "    except Exception as exp:",
            "        logger.exception('Failed to take screenshot')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def get_container_path(request, api=False):",
            "    \"\"\"Get App Container path.\"\"\"",
            "    err_msg = 'Failed to get app container path'",
            "    data = {",
            "        'status': 'failed',",
            "        'message': err_msg}",
            "    try:",
            "        bundle_id = request.POST['bundle_id']",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        checksum = get_md5(bundle_id.encode('utf-8'))",
            "        cfile = 'mobsf_app_container_path.txt'",
            "        acfile = Path(settings.UPLD_DIR) / checksum / cfile",
            "        if acfile.exists():",
            "            data['status'] = OK",
            "            data['message'] = acfile.read_text(",
            "                'utf-8').splitlines()[0].strip()",
            "    except Exception as exp:",
            "        logger.exception(err_msg)",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def network_capture(request, api=False):",
            "    \"\"\"Enable/Disable Network Capture.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to enable/disable network capture'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        state = request.POST.get('state')",
            "        if state == 'on':",
            "            msg = 'Enabled'",
            "            logger.info('Enabling Network Capture')",
            "            r = ci.start_network_capture()",
            "        else:",
            "            msg = 'Disabled'",
            "            logger.info('Disabling Network Capture')",
            "            r = ci.stop_network_capture()",
            "        if r != OK:",
            "            data['message'] = r",
            "            return send_response(data, api)",
            "        else:",
            "            data = {",
            "                'status': OK,",
            "                'message': f'{msg} network capture'}",
            "    except Exception as exp:",
            "        logger.exception('Enabling/Disabling network capture')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# File Download",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['GET', 'POST'])",
            "def live_pcap_download(request, api=False):",
            "    \"\"\"Download Network Capture.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to download network capture'}",
            "    try:",
            "        if api:",
            "            instance_id = request.POST['instance_id']",
            "        else:",
            "            instance_id = request.GET['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        pcap = ci.download_network_capture()",
            "        if pcap:",
            "            res = HttpResponse(",
            "                pcap,",
            "                content_type='application/vnd.tcpdump.pcap')",
            "            res['Content-Disposition'] = (",
            "                f'inline; filename={instance_id}-network.pcap')",
            "            return res",
            "        else:",
            "            data['message'] = 'Failed to download pcap'",
            "    except Exception as exp:",
            "        logger.exception('Download network capture')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "",
            "",
            "# AJAX",
            "SSH_TARGET = None",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def ssh_execute(request, api=False):",
            "    \"\"\"Execute commands in VM over SSH.\"\"\"",
            "    global SSH_TARGET",
            "    res = ''",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to execute command'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        cmd = request.POST['cmd']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        if not SSH_TARGET:",
            "            logger.info('Setting up SSH tunnel')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "        try:",
            "            res = ssh_execute_cmd(SSH_TARGET, cmd)",
            "        except SSHException:",
            "            logger.info('SSH session not active, setting up again')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "            res = ssh_execute_cmd(SSH_TARGET, cmd)",
            "        data = {'status': OK, 'message': res}",
            "    except Exception as exp:",
            "        data['message'] = str(exp)",
            "        logger.exception('Executing Commands')",
            "    return send_response(data, api)",
            "# Helper Download app data tarfile",
            "",
            "",
            "def download_app_data(ci, checksum):",
            "    \"\"\"Download App data from device.\"\"\"",
            "    app_dir = Path(settings.UPLD_DIR) / checksum",
            "    container_file = app_dir / 'mobsf_app_container_path.txt'",
            "    if container_file.exists():",
            "        app_container = container_file.read_text(",
            "            'utf-8').splitlines()[0].strip()",
            "        target, jumpbox = ssh_jump_host(",
            "            ci.get_ssh_connection_string())",
            "        tarfile = f'/tmp/{checksum}-app-container.tar'",
            "        localtar = app_dir / f'{checksum}-app-container.tar'",
            "        ssh_execute_cmd(",
            "            target, f'tar -C {app_container} -cvf {tarfile} .')",
            "        with target.open_sftp() as sftp:",
            "            sftp.get(tarfile, localtar)",
            "        target.close()",
            "        jumpbox.close()",
            "        if localtar.exists():",
            "            dst = Path(settings.DWD_DIR) / f'{checksum}-app_data.tar'",
            "            shutil.copyfile(localtar, dst)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def download_data(request, bundle_id, api=False):",
            "    \"\"\"Download Application Data from Device.\"\"\"",
            "    logger.info('Downloading application data')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to Download application data'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        checksum = get_md5(bundle_id.encode('utf-8'))",
            "        # App Container download",
            "        logger.info('Downloading app container data')",
            "        download_app_data(ci, checksum)",
            "        # Stop HTTPS Proxy",
            "        stop_httptools(get_http_tools_url(request))",
            "        # Move HTTP raw logs to download directory",
            "        flows = Path.home() / '.httptools' / 'flows'",
            "        webf = flows / f'{bundle_id}.flow.txt'",
            "        dwd = Path(settings.DWD_DIR)",
            "        dweb = dwd / f'{checksum}-web_traffic.txt'",
            "        if webf.exists():",
            "            shutil.copyfile(webf, dweb)",
            "        # Pcap download",
            "        logger.info('Downloading network capture')",
            "        pcap = ci.download_network_capture()",
            "        if pcap:",
            "            dwd = Path(settings.DWD_DIR)",
            "            pcap_file = dwd / f'{checksum}-network.pcap'",
            "            pcap_file.write_bytes(pcap)",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Downloaded application data',",
            "            }",
            "        else:",
            "            data['message'] = 'Failed to download pcap'",
            "            return send_response(data, api)",
            "    except Exception as exp:",
            "        logger.exception('Downloading application data')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def touch(request, api=False):",
            "    \"\"\"Sending Touch/Swipe/Text Events.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': '',",
            "    }",
            "    try:",
            "        x_axis = request.POST.get('x')",
            "        y_axis = request.POST.get('y')",
            "        event = request.POST.get('event')",
            "",
            "        max_x = request.POST.get('max_x', 0)",
            "        max_y = request.POST.get('max_y', 0)",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        res = ci.device_input(",
            "            event,",
            "            x_axis,",
            "            y_axis,",
            "            max_x,",
            "            max_y)",
            "        if res != 'ok':",
            "            data['message'] = res",
            "        else:",
            "            data = {'status': 'ok'}",
            "    except Exception as exp:",
            "        logger.exception('Sending Touchscreen Events')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX + HTML",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST', 'GET'])",
            "def system_logs(request, api=False):",
            "    \"\"\"Show system logs.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to get system logs',",
            "    }",
            "    try:",
            "        if request.method == 'POST':",
            "            instance_id = request.POST['instance_id']",
            "            failed = common_check(instance_id)",
            "            if failed:",
            "                return send_response(failed, api)",
            "            ci = CorelliumInstanceAPI(instance_id)",
            "            data = {'status': 'ok', 'message': ci.console_log()}",
            "            return send_response(data, api)",
            "        logger.info('Getting system logs')",
            "        instance_id = request.GET['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return print_n_send_error_response(",
            "                request, failed['message'], api)",
            "        template = 'dynamic_analysis/ios/system_logs.html'",
            "        return render(request,",
            "                      template,",
            "                      {'instance_id': instance_id,",
            "                       'version': settings.MOBSF_VER,",
            "                       'title': 'Live System logs'})",
            "    except Exception as exp:",
            "        err = 'Getting system logs'",
            "        logger.exception(err)",
            "        if request.method == 'POST':",
            "            data['message'] = str(exp)",
            "            return send_response(data, api)",
            "        return print_n_send_error_response(request, err, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def upload_file(request, api=False):",
            "    \"\"\"Upload file to device.\"\"\"",
            "    err_msg = 'Failed to upload file'",
            "    data = {",
            "        'status': 'failed',",
            "        'message': err_msg,",
            "    }",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        form = UploadFileForm(request.POST, request.FILES)",
            "        if form.is_valid():",
            "            ci = CorelliumInstanceAPI(instance_id)",
            "            fobject = request.FILES['file']",
            "            ssh_file_upload(",
            "                ci.get_ssh_connection_string(),",
            "                fobject,",
            "                fobject.name)",
            "            data = {'status': 'ok'}",
            "    except Exception as exp:",
            "        logger.exception(err_msg)",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# File Download",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def download_file(request, api=False):",
            "    \"\"\"Download file from device.\"\"\"",
            "    try:",
            "        global SSH_TARGET",
            "        instance_id = request.POST['instance_id']",
            "        rfile = request.POST['file']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        if not SSH_TARGET:",
            "            logger.info('Setting up SSH tunnel')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "        try:",
            "            fl = ssh_file_download(SSH_TARGET, rfile)",
            "        except SSHException:",
            "            logger.info('SSH session not active, setting up again')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "            fl = ssh_file_download(SSH_TARGET, rfile)",
            "        if not fl:",
            "            fl = b'File not found'",
            "    except Exception:",
            "        logger.exception('Failed to download file')",
            "    response = HttpResponse(fl, content_type='application/octet-stream')",
            "    response['Content-Disposition'] = f'inline; filename={Path(rfile).name}'",
            "    return response"
        ],
        "afterPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"Instance Operation APIs.\"\"\"",
            "import logging",
            "import re",
            "import shutil",
            "import time",
            "from base64 import b64encode",
            "from pathlib import Path",
            "",
            "from paramiko.ssh_exception import SSHException",
            "",
            "from django.conf import settings",
            "from django.views.decorators.http import require_http_methods",
            "from django.http import (",
            "    HttpResponse,",
            ")",
            "from django.shortcuts import (",
            "    render,",
            ")",
            "",
            "from mobsf.MobSF.utils import (",
            "    common_check,",
            "    get_md5,",
            "    id_generator,",
            "    is_md5,",
            "    print_n_send_error_response,",
            "    strict_package_check,",
            ")",
            "from mobsf.DynamicAnalyzer.forms import UploadFileForm",
            "from mobsf.DynamicAnalyzer.tools.webproxy import (",
            "    get_http_tools_url,",
            "    stop_httptools,",
            ")",
            "from mobsf.DynamicAnalyzer.views.common.shared import (",
            "    send_response,",
            ")",
            "from mobsf.DynamicAnalyzer.views.ios.corellium_ssh import (",
            "    ssh_execute_cmd,",
            "    ssh_file_download,",
            "    ssh_file_upload,",
            "    ssh_jump_host,",
            ")",
            "from mobsf.DynamicAnalyzer.views.ios.corellium_apis import (",
            "    CorelliumAPI,",
            "    CorelliumAgentAPI,",
            "    CorelliumInstanceAPI,",
            "    CorelliumModelsAPI,",
            "    OK,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "from mobsf.MobSF.views.authorization import (",
            "    Permissions,",
            "    permission_required,",
            ")",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def start_instance(request, api=False):",
            "    \"\"\"Start iOS VM instance.\"\"\"",
            "    logger.info('Starting iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to start instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.start_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Starting VM Instance'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Start iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def stop_instance(request, api=False):",
            "    \"\"\"Stop iOS VM instance.\"\"\"",
            "    logger.info('Stopping iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to stop instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.stop_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Instance stopped'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Stopping iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def unpause_instance(request, api=False):",
            "    \"\"\"Unpause iOS VM instance.\"\"\"",
            "    logger.info('Unpausing iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to unpause instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.unpause_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Instance unpaused'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Unpausing iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def reboot_instance(request, api=False):",
            "    \"\"\"Reboot iOS VM instance.\"\"\"",
            "    logger.info('Rebooting iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to reboot instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.reboot_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Rebooting instance'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Rebooting iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def destroy_instance(request, api=False):",
            "    \"\"\"Destroy iOS VM instance.\"\"\"",
            "    logger.info('Destroying iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to destroy instance'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.remove_instance()",
            "        if r == OK:",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Destroying instance'}",
            "        elif r:",
            "            data['message'] = r",
            "    except Exception as exp:",
            "        logger.exception('Destroying iOS VM instance')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def list_apps(request, api=False):",
            "    \"\"\"List installed apps.\"\"\"",
            "    logger.info('Listing installed applications')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to list installed apps'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        # Get apps in device",
            "        r = ca.list_apps()",
            "        app_list = []",
            "        bundle_ids = []",
            "        if r and r.get('apps'):",
            "            for i in r.get('apps'):",
            "                bundle = i['bundleID']",
            "                bundle_ids.append(f'bundleID={bundle}')",
            "        elif r and r.get('error'):",
            "            data['message'] = r.get('error')",
            "            verbose = r.get('originalError')",
            "            if verbose:",
            "                data['message'] += f' {verbose}'",
            "            return send_response(data, api)",
            "        else:",
            "            data['message'] = 'Failed to list apps'",
            "            return send_response(data, api)",
            "        # Get app icons",
            "        logger.info('Getting all application icons')",
            "        ic = ca.get_icons('&'.join(bundle_ids))",
            "        for i in r.get('apps'):",
            "            bundleid = i['bundleID']",
            "            checksum = get_md5(bundleid.encode('utf-8'))",
            "            dump_file = Path(",
            "                settings.UPLD_DIR) / checksum / 'mobsf_dump_file.txt'",
            "            if ic and ic.get('icons'):",
            "                icon_url = ic['icons'].get(bundleid)",
            "            else:",
            "                icon_url = ''",
            "            app_list.append({",
            "                'applicationType': i['applicationType'],",
            "                'name': i['name'],",
            "                'bundleID': bundleid,",
            "                'icon': icon_url,",
            "                'checksum': checksum,",
            "                'reportExists': dump_file.exists(),",
            "            })",
            "        data = {",
            "            'status': OK,",
            "            'message': app_list}",
            "",
            "    except Exception as exp:",
            "        logger.exception('Listing installed apps')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def get_supported_models(request, api=False):",
            "    \"\"\"Get Supported iOS VM models.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to obtain iOS models'}",
            "    try:",
            "        cm = CorelliumModelsAPI()",
            "        r = cm.get_models()",
            "        if r:",
            "            data = {'status': OK, 'message': r}",
            "    except Exception as exp:",
            "        logger.exception('Obtaining iOS models')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def get_supported_os(request, api=False):",
            "    \"\"\"Get Supported iOS OS versions.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to obtain iOS versions'}",
            "    try:",
            "        model = request.POST['model']",
            "        cm = CorelliumModelsAPI()",
            "        r = cm.get_supported_os(model)",
            "        if r:",
            "            data = {'status': OK, 'message': r}",
            "    except Exception as exp:",
            "        logger.exception('Obtaining iOS versions')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def create_vm_instance(request, api=False):",
            "    \"\"\"Create and iOS VM in Corellium.\"\"\"",
            "    logger.info('Creating Corellium iOS VM instance')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to create an iOS VM'}",
            "    try:",
            "        project_id = request.POST['project_id']",
            "        flavor = request.POST['flavor']",
            "        version = request.POST['version']",
            "        name = request.POST.get('name')",
            "        if not name:",
            "            name = 'MobSF iOS'",
            "        if not re.match(r'^[a-zA-Z0-9 _-]+$', name):",
            "            data['message'] = (",
            "                'Invalid VM name. '",
            "                'Can only contain '",
            "                'letters, numbers, '",
            "                'spaces, hyphens, '",
            "                'and underscores')",
            "            return send_response(data, api)",
            "        if not re.match(r'^iphone\\d*\\w+', flavor):",
            "            data['message'] = 'Invalid iOS flavor'",
            "            return send_response(data, api)",
            "        if not re.match(r'^\\d+\\.\\d+\\.*\\d*', version):",
            "            data['message'] = 'Invalid iOS version'",
            "            return send_response(data, api)",
            "        failed = common_check(project_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        c = CorelliumAPI(project_id)",
            "        r = c.create_ios_instance(name, flavor, version)",
            "        if r:",
            "            data = {",
            "                'status': OK,",
            "                'message': f'Created a new instance with id: {r}'}",
            "    except Exception as exp:",
            "        logger.exception('Creating Corellium iOS VM')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# Helpers for AppSync Install Check & IPA Install",
            "",
            "",
            "def check_appsync(target):",
            "    \"\"\"Check and install AppSync Unified.\"\"\"",
            "    check_install = 'apt list --installed | grep \\'ai.akemi.appinst\\''",
            "    # Check if AppSync Unified is installed",
            "    out = ssh_execute_cmd(target, check_install)",
            "    if 'ai.akemi.appinst' not in out:",
            "        # Install AppSync Unified",
            "        logger.info('AppSync Unified is not installed. '",
            "                    'Attempting to install...')",
            "        src_file = '/etc/apt/sources.list.d/cydia.list'",
            "        src = 'deb https://cydia.akemi.ai/ ./'",
            "        install_cmds = [",
            "            f'grep -qxF \\'{src}\\' {src_file} || echo \\'{src}\\' >> {src_file}',",
            "            'apt update',",
            "            'apt install -y --allow-unauthenticated ai.akemi.appinst',",
            "            'launchctl reboot userspace',",
            "        ]",
            "        for i in install_cmds:",
            "            out = ssh_execute_cmd(target, i)",
            "            logger.info(out)",
            "        logger.info('Please wait for 15 seconds for the userspace to reboot.')",
            "        time.sleep(15)",
            "",
            "",
            "def appsync_ipa_install(ssh_string):",
            "    \"\"\"Install app using AppSync Unified.\"\"\"",
            "    target, jumpbox = ssh_jump_host(ssh_string)",
            "    # AppSync Unified install check",
            "    check_appsync(target)   # This will terminate SSH session",
            "    if target:",
            "        target.close()",
            "    if jumpbox:",
            "        jumpbox.close()",
            "    # Install IPA with AppSync United",
            "    logger.info('Attempting to install the IPA '",
            "                'using AppSync Unified.')",
            "    target, jumpbox = ssh_jump_host(ssh_string)",
            "    out = ssh_execute_cmd(target, 'appinst /tmp/app.ipa')",
            "    target.close()",
            "    jumpbox.close()",
            "    if 'Successfully installed' not in out:",
            "        logger.error('AppSync IPA Install Failed.\\n%s', out)",
            "        return out",
            "    logger.info(out)",
            "    return OK",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def setup_environment(request, checksum, api=False):",
            "    \"\"\"Setup iOS Dynamic Analyzer Environment.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to Setup Dynamic Analysis Environment'}",
            "    try:",
            "        if not is_md5(checksum):",
            "            # Additional Check for REST API",
            "            data['message'] = 'Invalid Hash'",
            "            return send_response(data, api)",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if not ca.agent_ready():",
            "            data['message'] = (",
            "                f'Agent is not ready with {instance_id}'",
            "                ', please wait.')",
            "            return send_response(data, api)",
            "        # Unlock iOS Device",
            "        ca.unlock_device()",
            "        # Upload IPA",
            "        ipa_path = Path(settings.UPLD_DIR) / checksum / f'{checksum}.ipa'",
            "        msg = ca.upload_ipa(ipa_path)",
            "        if msg != OK:",
            "            data['message'] = msg",
            "            return send_response(data, api)",
            "        # Install IPA",
            "        msg = ca.install_ipa()",
            "        if msg != OK:",
            "            if 'Please re-sign.' in msg:",
            "                # Try AppSync IPA Install",
            "                ci = CorelliumInstanceAPI(instance_id)",
            "                out = appsync_ipa_install(ci.get_ssh_connection_string())",
            "                if out and out != OK:",
            "                    data['message'] = out",
            "                    return send_response(data, api)",
            "            else:",
            "                # Other install errors",
            "                data['message'] = msg",
            "                return send_response(data, api)",
            "        msg = 'Testing Environment is Ready!'",
            "        logger.info(msg)",
            "        data['status'] = OK",
            "        data['message'] = msg",
            "    except Exception as exp:",
            "        logger.exception('Creating iOS Dynamic Analyzer Environment')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def run_app(request, api=False):",
            "    \"\"\"Run an App.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to run the app'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        bundle_id = request.POST['bundle_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if (ca.agent_ready()",
            "                and ca.unlock_device()",
            "                and ca.run_app(bundle_id) == OK):",
            "            data['status'] = OK",
            "            data['message'] = 'App Started'",
            "    except Exception as exp:",
            "        logger.exception('Failed to run the app')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def stop_app(request, api=False):",
            "    \"\"\"Stop an App.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to stop the app'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        bundle_id = request.POST['bundle_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if (ca.agent_ready()",
            "                and ca.unlock_device()",
            "                and ca.stop_app(bundle_id) == OK):",
            "            data['status'] = OK",
            "            data['message'] = 'App Killed'",
            "    except Exception as exp:",
            "        logger.exception('Failed to stop the app')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def remove_app(request, api=False):",
            "    \"\"\"Remove an app from the device.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to uninstall the app'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        bundle_id = request.POST['bundle_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ca = CorelliumAgentAPI(instance_id)",
            "        if (ca.agent_ready()",
            "                and ca.remove_app(bundle_id) == OK):",
            "            data['status'] = OK",
            "            data['message'] = 'App uninstalled'",
            "    except Exception as exp:",
            "        logger.exception('Failed to uninstall the app')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def take_screenshot(request, api=False):",
            "    \"\"\"Take a Screenshot.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to take screenshot'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        save = request.POST.get('save')",
            "        checksum = request.POST.get('checksum')",
            "        dwd = Path(settings.DWD_DIR)",
            "        if save and checksum:",
            "            if not is_md5(checksum):",
            "                data['message'] = 'Invaid MD5 Hash'",
            "                return send_response(data, api)",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        r = ci.screenshot()",
            "        if r:",
            "            data['status'] = OK",
            "            if save == '1':",
            "                sfile = dwd / f'{checksum}-sshot-{id_generator()}.png'",
            "                sfile.write_bytes(r)",
            "                data['message'] = 'Screenshot saved!'",
            "            else:",
            "                b64dat = b64encode(r).decode('utf-8')",
            "                data['message'] = f'data:image/png;base64,{b64dat}'",
            "    except Exception as exp:",
            "        logger.exception('Failed to take screenshot')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def get_container_path(request, api=False):",
            "    \"\"\"Get App Container path.\"\"\"",
            "    err_msg = 'Failed to get app container path'",
            "    data = {",
            "        'status': 'failed',",
            "        'message': err_msg}",
            "    try:",
            "        bundle_id = request.POST['bundle_id']",
            "        if not strict_package_check(bundle_id):",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        checksum = get_md5(bundle_id.encode('utf-8'))",
            "        cfile = 'mobsf_app_container_path.txt'",
            "        acfile = Path(settings.UPLD_DIR) / checksum / cfile",
            "        if acfile.exists():",
            "            data['status'] = OK",
            "            data['message'] = acfile.read_text(",
            "                'utf-8').splitlines()[0].strip()",
            "    except Exception as exp:",
            "        logger.exception(err_msg)",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def network_capture(request, api=False):",
            "    \"\"\"Enable/Disable Network Capture.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to enable/disable network capture'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        state = request.POST.get('state')",
            "        if state == 'on':",
            "            msg = 'Enabled'",
            "            logger.info('Enabling Network Capture')",
            "            r = ci.start_network_capture()",
            "        else:",
            "            msg = 'Disabled'",
            "            logger.info('Disabling Network Capture')",
            "            r = ci.stop_network_capture()",
            "        if r != OK:",
            "            data['message'] = r",
            "            return send_response(data, api)",
            "        else:",
            "            data = {",
            "                'status': OK,",
            "                'message': f'{msg} network capture'}",
            "    except Exception as exp:",
            "        logger.exception('Enabling/Disabling network capture')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# File Download",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['GET', 'POST'])",
            "def live_pcap_download(request, api=False):",
            "    \"\"\"Download Network Capture.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to download network capture'}",
            "    try:",
            "        if api:",
            "            instance_id = request.POST['instance_id']",
            "        else:",
            "            instance_id = request.GET['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        pcap = ci.download_network_capture()",
            "        if pcap:",
            "            res = HttpResponse(",
            "                pcap,",
            "                content_type='application/vnd.tcpdump.pcap')",
            "            res['Content-Disposition'] = (",
            "                f'inline; filename={instance_id}-network.pcap')",
            "            return res",
            "        else:",
            "            data['message'] = 'Failed to download pcap'",
            "    except Exception as exp:",
            "        logger.exception('Download network capture')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "",
            "",
            "# AJAX",
            "SSH_TARGET = None",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def ssh_execute(request, api=False):",
            "    \"\"\"Execute commands in VM over SSH.\"\"\"",
            "    global SSH_TARGET",
            "    res = ''",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to execute command'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        cmd = request.POST['cmd']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        if not SSH_TARGET:",
            "            logger.info('Setting up SSH tunnel')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "        try:",
            "            res = ssh_execute_cmd(SSH_TARGET, cmd)",
            "        except SSHException:",
            "            logger.info('SSH session not active, setting up again')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "            res = ssh_execute_cmd(SSH_TARGET, cmd)",
            "        data = {'status': OK, 'message': res}",
            "    except Exception as exp:",
            "        data['message'] = str(exp)",
            "        logger.exception('Executing Commands')",
            "    return send_response(data, api)",
            "# Helper Download app data tarfile",
            "",
            "",
            "def download_app_data(ci, checksum):",
            "    \"\"\"Download App data from device.\"\"\"",
            "    app_dir = Path(settings.UPLD_DIR) / checksum",
            "    container_file = app_dir / 'mobsf_app_container_path.txt'",
            "    if container_file.exists():",
            "        app_container = container_file.read_text(",
            "            'utf-8').splitlines()[0].strip()",
            "        target, jumpbox = ssh_jump_host(",
            "            ci.get_ssh_connection_string())",
            "        tarfile = f'/tmp/{checksum}-app-container.tar'",
            "        localtar = app_dir / f'{checksum}-app-container.tar'",
            "        ssh_execute_cmd(",
            "            target, f'tar -C {app_container} -cvf {tarfile} .')",
            "        with target.open_sftp() as sftp:",
            "            sftp.get(tarfile, localtar)",
            "        target.close()",
            "        jumpbox.close()",
            "        if localtar.exists():",
            "            dst = Path(settings.DWD_DIR) / f'{checksum}-app_data.tar'",
            "            shutil.copyfile(localtar, dst)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def download_data(request, bundle_id, api=False):",
            "    \"\"\"Download Application Data from Device.\"\"\"",
            "    logger.info('Downloading application data')",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to Download application data'}",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        if not strict_package_check(bundle_id):",
            "            # Check bundle_id during call, as the check",
            "            # is not done in REST API/URL repath.",
            "            data['message'] = 'Invalid iOS Bundle id'",
            "            return send_response(data, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        checksum = get_md5(bundle_id.encode('utf-8'))",
            "        # App Container download",
            "        logger.info('Downloading app container data')",
            "        download_app_data(ci, checksum)",
            "        # Stop HTTPS Proxy",
            "        stop_httptools(get_http_tools_url(request))",
            "        # Move HTTP raw logs to download directory",
            "        flows = Path.home() / '.httptools' / 'flows'",
            "        webf = flows / f'{bundle_id}.flow.txt'",
            "        dwd = Path(settings.DWD_DIR)",
            "        dweb = dwd / f'{checksum}-web_traffic.txt'",
            "        if webf.exists():",
            "            shutil.copyfile(webf, dweb)",
            "        # Pcap download",
            "        logger.info('Downloading network capture')",
            "        pcap = ci.download_network_capture()",
            "        if pcap:",
            "            dwd = Path(settings.DWD_DIR)",
            "            pcap_file = dwd / f'{checksum}-network.pcap'",
            "            pcap_file.write_bytes(pcap)",
            "            data = {",
            "                'status': OK,",
            "                'message': 'Downloaded application data',",
            "            }",
            "        else:",
            "            data['message'] = 'Failed to download pcap'",
            "            return send_response(data, api)",
            "    except Exception as exp:",
            "        logger.exception('Downloading application data')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def touch(request, api=False):",
            "    \"\"\"Sending Touch/Swipe/Text Events.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': '',",
            "    }",
            "    try:",
            "        x_axis = request.POST.get('x')",
            "        y_axis = request.POST.get('y')",
            "        event = request.POST.get('event')",
            "",
            "        max_x = request.POST.get('max_x', 0)",
            "        max_y = request.POST.get('max_y', 0)",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        res = ci.device_input(",
            "            event,",
            "            x_axis,",
            "            y_axis,",
            "            max_x,",
            "            max_y)",
            "        if res != 'ok':",
            "            data['message'] = res",
            "        else:",
            "            data = {'status': 'ok'}",
            "    except Exception as exp:",
            "        logger.exception('Sending Touchscreen Events')",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# AJAX + HTML",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST', 'GET'])",
            "def system_logs(request, api=False):",
            "    \"\"\"Show system logs.\"\"\"",
            "    data = {",
            "        'status': 'failed',",
            "        'message': 'Failed to get system logs',",
            "    }",
            "    try:",
            "        if request.method == 'POST':",
            "            instance_id = request.POST['instance_id']",
            "            failed = common_check(instance_id)",
            "            if failed:",
            "                return send_response(failed, api)",
            "            ci = CorelliumInstanceAPI(instance_id)",
            "            data = {'status': 'ok', 'message': ci.console_log()}",
            "            return send_response(data, api)",
            "        logger.info('Getting system logs')",
            "        instance_id = request.GET['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return print_n_send_error_response(",
            "                request, failed['message'], api)",
            "        template = 'dynamic_analysis/ios/system_logs.html'",
            "        return render(request,",
            "                      template,",
            "                      {'instance_id': instance_id,",
            "                       'version': settings.MOBSF_VER,",
            "                       'title': 'Live System logs'})",
            "    except Exception as exp:",
            "        err = 'Getting system logs'",
            "        logger.exception(err)",
            "        if request.method == 'POST':",
            "            data['message'] = str(exp)",
            "            return send_response(data, api)",
            "        return print_n_send_error_response(request, err, api)",
            "# AJAX",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def upload_file(request, api=False):",
            "    \"\"\"Upload file to device.\"\"\"",
            "    err_msg = 'Failed to upload file'",
            "    data = {",
            "        'status': 'failed',",
            "        'message': err_msg,",
            "    }",
            "    try:",
            "        instance_id = request.POST['instance_id']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        form = UploadFileForm(request.POST, request.FILES)",
            "        if form.is_valid():",
            "            ci = CorelliumInstanceAPI(instance_id)",
            "            fobject = request.FILES['file']",
            "            ssh_file_upload(",
            "                ci.get_ssh_connection_string(),",
            "                fobject,",
            "                fobject.name)",
            "            data = {'status': 'ok'}",
            "    except Exception as exp:",
            "        logger.exception(err_msg)",
            "        data['message'] = str(exp)",
            "    return send_response(data, api)",
            "# File Download",
            "",
            "",
            "@login_required",
            "@permission_required(Permissions.SCAN)",
            "@require_http_methods(['POST'])",
            "def download_file(request, api=False):",
            "    \"\"\"Download file from device.\"\"\"",
            "    try:",
            "        global SSH_TARGET",
            "        instance_id = request.POST['instance_id']",
            "        rfile = request.POST['file']",
            "        failed = common_check(instance_id)",
            "        if failed:",
            "            return send_response(failed, api)",
            "        ci = CorelliumInstanceAPI(instance_id)",
            "        if not SSH_TARGET:",
            "            logger.info('Setting up SSH tunnel')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "        try:",
            "            fl = ssh_file_download(SSH_TARGET, rfile)",
            "        except SSHException:",
            "            logger.info('SSH session not active, setting up again')",
            "            SSH_TARGET, _jmp = ssh_jump_host(",
            "                ci.get_ssh_connection_string())",
            "            fl = ssh_file_download(SSH_TARGET, rfile)",
            "        if not fl:",
            "            fl = b'File not found'",
            "    except Exception:",
            "        logger.exception('Failed to download file')",
            "    response = HttpResponse(fl, content_type='application/octet-stream')",
            "    response['Content-Disposition'] = f'inline; filename={Path(rfile).name}'",
            "    return response"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": []
    },
    "mobsf/DynamicAnalyzer/views/ios/report.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "         else:"
            },
            "1": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "             dev = ''"
            },
            "2": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         if not strict_package_check(bundle_id):"
            },
            "3": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # We need this check since bundleid"
            },
            "4": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # is not validated in REST API"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+            # bundle_id is not validated in REST API."
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+            # Also bundleid is not strictly validated"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+            # in URL path."
            },
            "8": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "             return print_n_send_error_response("
            },
            "9": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "                 request,"
            },
            "10": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 57,
                "PatchRowcode": "                 'Invalid iOS Bundle id',"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"Dynamic Analyzer Reporting.\"\"\"",
            "import logging",
            "from pathlib import Path",
            "",
            "from django.conf import settings",
            "from django.shortcuts import render",
            "from django.template.defaulttags import register",
            "",
            "import mobsf.MalwareAnalyzer.views.Trackers as Trackers",
            "from mobsf.DynamicAnalyzer.views.ios.analysis import (",
            "    get_screenshots,",
            "    ios_api_analysis,",
            "    run_analysis,",
            ")",
            "from mobsf.MobSF.utils import (",
            "    base64_decode,",
            "    common_check,",
            "    get_md5,",
            "    key,",
            "    pretty_json,",
            "    print_n_send_error_response,",
            "    replace,",
            "    strict_package_check,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "",
            "",
            "logger = logging.getLogger(__name__)",
            "register.filter('key', key)",
            "register.filter('replace', replace)",
            "register.filter('pretty_json', pretty_json)",
            "register.filter('base64_decode', base64_decode)",
            "",
            "",
            "@login_required",
            "def ios_view_report(request, bundle_id, api=False):",
            "    \"\"\"Dynamic Analysis Report Generation.\"\"\"",
            "    logger.info('iOS Dynamic Analysis Report Generation')",
            "    try:",
            "        if api:",
            "            instance_id = request.POST.get('instance_id')",
            "        else:",
            "            instance_id = request.GET.get('instance_id')",
            "        if instance_id and not common_check(instance_id):",
            "            dev = instance_id",
            "        else:",
            "            dev = ''",
            "        if not strict_package_check(bundle_id):",
            "            # We need this check since bundleid",
            "            # is not validated in REST API",
            "            return print_n_send_error_response(",
            "                request,",
            "                'Invalid iOS Bundle id',",
            "                api)",
            "        checksum = get_md5(bundle_id.encode('utf-8'))",
            "        app_dir = Path(settings.UPLD_DIR) / checksum",
            "        download_dir = settings.DWD_DIR",
            "        tools_dir = settings.TOOLS_DIR",
            "        frida_log = app_dir / 'mobsf_frida_out.txt'",
            "        if not frida_log.exists():",
            "            msg = ('Dynamic Analysis report is not available '",
            "                   'for this app. Perform Dynamic Analysis '",
            "                   'and generate the report.')",
            "            return print_n_send_error_response(request, msg, api)",
            "        api_analysis = ios_api_analysis(app_dir)",
            "        dump_analaysis = run_analysis(app_dir, bundle_id, checksum)",
            "        trk = Trackers.Trackers(checksum, app_dir, tools_dir)",
            "        trackers = trk.get_trackers_domains_or_deps(",
            "            dump_analaysis['domains'], None)",
            "        screenshots = get_screenshots(checksum, download_dir)",
            "        context = {",
            "            'hash': checksum,",
            "            'version': settings.MOBSF_VER,",
            "            'title': 'iOS Dynamic Analysis Report',",
            "            'instance_id': dev,",
            "            'bundleid': bundle_id,",
            "            'trackers': trackers,",
            "            'screenshots': screenshots,",
            "            'frida_logs': frida_log.exists(),",
            "        }",
            "        context.update(api_analysis)",
            "        context.update(dump_analaysis)",
            "        template = 'dynamic_analysis/ios/dynamic_report.html'",
            "        if api:",
            "            return context",
            "        return render(request, template, context)",
            "    except Exception as exp:",
            "        logger.exception('Dynamic Analysis Report Generation')",
            "        err = f'Error Generating Dynamic Analysis Report. {str(exp)}'",
            "        return print_n_send_error_response(request, err, api)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"Dynamic Analyzer Reporting.\"\"\"",
            "import logging",
            "from pathlib import Path",
            "",
            "from django.conf import settings",
            "from django.shortcuts import render",
            "from django.template.defaulttags import register",
            "",
            "import mobsf.MalwareAnalyzer.views.Trackers as Trackers",
            "from mobsf.DynamicAnalyzer.views.ios.analysis import (",
            "    get_screenshots,",
            "    ios_api_analysis,",
            "    run_analysis,",
            ")",
            "from mobsf.MobSF.utils import (",
            "    base64_decode,",
            "    common_check,",
            "    get_md5,",
            "    key,",
            "    pretty_json,",
            "    print_n_send_error_response,",
            "    replace,",
            "    strict_package_check,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "",
            "",
            "logger = logging.getLogger(__name__)",
            "register.filter('key', key)",
            "register.filter('replace', replace)",
            "register.filter('pretty_json', pretty_json)",
            "register.filter('base64_decode', base64_decode)",
            "",
            "",
            "@login_required",
            "def ios_view_report(request, bundle_id, api=False):",
            "    \"\"\"Dynamic Analysis Report Generation.\"\"\"",
            "    logger.info('iOS Dynamic Analysis Report Generation')",
            "    try:",
            "        if api:",
            "            instance_id = request.POST.get('instance_id')",
            "        else:",
            "            instance_id = request.GET.get('instance_id')",
            "        if instance_id and not common_check(instance_id):",
            "            dev = instance_id",
            "        else:",
            "            dev = ''",
            "        if not strict_package_check(bundle_id):",
            "            # bundle_id is not validated in REST API.",
            "            # Also bundleid is not strictly validated",
            "            # in URL path.",
            "            return print_n_send_error_response(",
            "                request,",
            "                'Invalid iOS Bundle id',",
            "                api)",
            "        checksum = get_md5(bundle_id.encode('utf-8'))",
            "        app_dir = Path(settings.UPLD_DIR) / checksum",
            "        download_dir = settings.DWD_DIR",
            "        tools_dir = settings.TOOLS_DIR",
            "        frida_log = app_dir / 'mobsf_frida_out.txt'",
            "        if not frida_log.exists():",
            "            msg = ('Dynamic Analysis report is not available '",
            "                   'for this app. Perform Dynamic Analysis '",
            "                   'and generate the report.')",
            "            return print_n_send_error_response(request, msg, api)",
            "        api_analysis = ios_api_analysis(app_dir)",
            "        dump_analaysis = run_analysis(app_dir, bundle_id, checksum)",
            "        trk = Trackers.Trackers(checksum, app_dir, tools_dir)",
            "        trackers = trk.get_trackers_domains_or_deps(",
            "            dump_analaysis['domains'], None)",
            "        screenshots = get_screenshots(checksum, download_dir)",
            "        context = {",
            "            'hash': checksum,",
            "            'version': settings.MOBSF_VER,",
            "            'title': 'iOS Dynamic Analysis Report',",
            "            'instance_id': dev,",
            "            'bundleid': bundle_id,",
            "            'trackers': trackers,",
            "            'screenshots': screenshots,",
            "            'frida_logs': frida_log.exists(),",
            "        }",
            "        context.update(api_analysis)",
            "        context.update(dump_analaysis)",
            "        template = 'dynamic_analysis/ios/dynamic_report.html'",
            "        if api:",
            "            return context",
            "        return render(request, template, context)",
            "    except Exception as exp:",
            "        logger.exception('Dynamic Analysis Report Generation')",
            "        err = f'Error Generating Dynamic Analysis Report. {str(exp)}'",
            "        return print_n_send_error_response(request, err, api)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "52": [
                "ios_view_report"
            ],
            "53": [
                "ios_view_report"
            ]
        },
        "addLocation": []
    },
    "mobsf/MobSF/init.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " logger = logging.getLogger(__name__)"
            },
            "2": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-VERSION = '4.3.0'"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+VERSION = '4.3.1'"
            },
            "5": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " BANNER = r\"\"\""
            },
            "6": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": "   __  __       _    ____  _____       _  _    _____ "
            },
            "7": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": "  |  \\/  | ___ | |__/ ___||  ___|_   _| || |  |___ / "
            }
        },
        "frontPatchFile": [
            "\"\"\"Initialize on first run.\"\"\"",
            "import logging",
            "import os",
            "import random",
            "import subprocess",
            "import sys",
            "import shutil",
            "import threading",
            "from hashlib import sha256",
            "from pathlib import Path",
            "from importlib import (",
            "    machinery,",
            "    util,",
            ")",
            "",
            "from mobsf.MobSF.tools_download import install_jadx",
            "from mobsf.install.windows.setup import windows_config_local",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "VERSION = '4.3.0'",
            "BANNER = r\"\"\"",
            "  __  __       _    ____  _____       _  _    _____ ",
            " |  \\/  | ___ | |__/ ___||  ___|_   _| || |  |___ / ",
            " | |\\/| |/ _ \\| '_ \\___ \\| |_  \\ \\ / / || |_   |_ \\ ",
            " | |  | | (_) | |_) |__) |  _|  \\ V /|__   _| ___) |",
            " |_|  |_|\\___/|_.__/____/|_|     \\_/    |_|(_)____/ ",
            "\"\"\"  # noqa: W291",
            "# ASCII Font: Standard",
            "",
            "",
            "def first_run(secret_file, base_dir, mobsf_home):",
            "    # Based on https://gist.github.com/ndarville/3452907#file-secret-key-gen-py",
            "    base_dir = Path(base_dir)",
            "    mobsf_home = Path(mobsf_home)",
            "    secret_file = Path(secret_file)",
            "    if os.getenv('MOBSF_SECRET_KEY'):",
            "        secret_key = os.environ['MOBSF_SECRET_KEY']",
            "    elif secret_file.exists() and secret_file.is_file():",
            "        secret_key = secret_file.read_text().strip()",
            "    else:",
            "        try:",
            "            secret_key = get_random()",
            "            secret_file.write_text(secret_key)",
            "        except IOError:",
            "            raise Exception('Secret file generation failed' % secret_file)",
            "        # Run Once",
            "        make_migrations(base_dir)",
            "        migrate(base_dir)",
            "        # Install JADX",
            "        thread = threading.Thread(",
            "            target=install_jadx,",
            "            name='install_jadx',",
            "            args=(mobsf_home.as_posix(),))",
            "        thread.start()",
            "        # Windows Setup",
            "        windows_config_local(mobsf_home.as_posix())",
            "    return secret_key",
            "",
            "",
            "def create_user_conf(mobsf_home, base_dir):",
            "    try:",
            "        config_path = mobsf_home / 'config.py'",
            "        if not config_path.exists():",
            "            sample_conf = base_dir / 'MobSF' / 'settings.py'",
            "            dat = sample_conf.read_text().splitlines()",
            "            config = []",
            "            add = False",
            "            for line in dat:",
            "                if '^CONFIG-START^' in line:",
            "                    add = True",
            "                if '^CONFIG-END^' in line:",
            "                    break",
            "                if add:",
            "                    config.append(line.lstrip())",
            "            config.pop(0)",
            "            conf_str = '\\n'.join(config)",
            "            config_path.write_text(conf_str)",
            "    except Exception:",
            "        logger.exception('Cannot create config file')",
            "",
            "",
            "def django_operation(cmds, base_dir):",
            "    \"\"\"Generic Function for Djano operations.\"\"\"",
            "    manage = base_dir.parent / 'manage.py'",
            "    if manage.exists() and manage.is_file():",
            "        # Bail out for package",
            "        return",
            "    print(manage)",
            "    args = [sys.executable, manage.as_posix()]",
            "    args.extend(cmds)",
            "    subprocess.call(args)",
            "",
            "",
            "def make_migrations(base_dir):",
            "    \"\"\"Create Database Migrations.\"\"\"",
            "    try:",
            "        django_operation(['makemigrations'], base_dir)",
            "        django_operation(['makemigrations', 'StaticAnalyzer'], base_dir)",
            "    except Exception:",
            "        logger.exception('Cannot Make Migrations')",
            "",
            "",
            "def migrate(base_dir):",
            "    \"\"\"Migrate Database.\"\"\"",
            "    try:",
            "        django_operation(['migrate'], base_dir)",
            "        django_operation(['migrate', '--run-syncdb'], base_dir)",
            "        django_operation(['create_roles'], base_dir)",
            "    except Exception:",
            "        logger.exception('Cannot Migrate')",
            "",
            "",
            "def get_random():",
            "    choice = 'abcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*(-_=+)'",
            "    return ''.join([random.SystemRandom().choice(choice) for i in range(50)])",
            "",
            "",
            "def get_mobsf_home(use_home, base_dir):",
            "    try:",
            "        base_dir = Path(base_dir)",
            "        mobsf_home = ''",
            "        if use_home:",
            "            mobsf_home = Path.home() / '.MobSF'",
            "            custom_home = os.getenv('MOBSF_HOME_DIR')",
            "            if custom_home:",
            "                p = Path(custom_home)",
            "                if p.exists() and p.is_absolute() and p.is_dir():",
            "                    mobsf_home = p",
            "            # MobSF Home Directory",
            "            if not mobsf_home.exists():",
            "                mobsf_home.mkdir(parents=True, exist_ok=True)",
            "            create_user_conf(mobsf_home, base_dir)",
            "        else:",
            "            mobsf_home = base_dir",
            "        # Download Directory",
            "        dwd_dir = mobsf_home / 'downloads'",
            "        dwd_dir.mkdir(parents=True, exist_ok=True)",
            "        # Screenshot Directory",
            "        screen_dir = mobsf_home / 'screen'",
            "        screen_dir.mkdir(parents=True, exist_ok=True)",
            "        # Upload Directory",
            "        upload_dir = mobsf_home / 'uploads'",
            "        upload_dir.mkdir(parents=True, exist_ok=True)",
            "        # Downloaded tools",
            "        downloaded_tools_dir = mobsf_home / 'tools'",
            "        downloaded_tools_dir.mkdir(parents=True, exist_ok=True)",
            "        # Signatures Directory",
            "        sig_dir = mobsf_home / 'signatures'",
            "        sig_dir.mkdir(parents=True, exist_ok=True)",
            "        if use_home:",
            "            src = Path(base_dir) / 'signatures'",
            "            try:",
            "                shutil.copytree(src, sig_dir, dirs_exist_ok=True)",
            "            except Exception:",
            "                pass",
            "        return mobsf_home.as_posix()",
            "    except Exception:",
            "        logger.exception('Creating MobSF Home Directory')",
            "",
            "",
            "def get_mobsf_version():",
            "    return BANNER, VERSION, f'v{VERSION}'",
            "",
            "",
            "def load_source(modname, filename):",
            "    loader = machinery.SourceFileLoader(modname, filename)",
            "    spec = util.spec_from_file_location(modname, filename, loader=loader)",
            "    module = util.module_from_spec(spec)",
            "    loader.exec_module(module)",
            "    return module",
            "",
            "",
            "def get_docker_secret_by_file(secret_key):",
            "    try:",
            "        secret_path = os.environ.get(secret_key)",
            "        path = Path(secret_path)",
            "        if path.exists() and path.is_file():",
            "            return path.read_text().strip()",
            "    except Exception:",
            "        logger.exception('Cannot read secret from %s', secret_path)",
            "    raise Exception('Cannot read secret from file')",
            "",
            "",
            "def get_secret_from_file_or_env(env_secret_key):",
            "    docker_secret_key = f'{env_secret_key}_FILE'",
            "    if os.environ.get(docker_secret_key):",
            "        return get_docker_secret_by_file(docker_secret_key)",
            "    else:",
            "        return os.environ[env_secret_key]",
            "",
            "",
            "def api_key(home_dir):",
            "    \"\"\"Print REST API Key.\"\"\"",
            "    # Form Docker Secrets",
            "    if os.environ.get('MOBSF_API_KEY_FILE'):",
            "        logger.info('\\nAPI Key read from docker secrets')",
            "        try:",
            "            return get_docker_secret_by_file('MOBSF_API_KEY_FILE')",
            "        except Exception:",
            "            logger.exception('Cannot read API Key from docker secrets')",
            "    # From Environment Variable",
            "    if os.environ.get('MOBSF_API_KEY'):",
            "        logger.info('\\nAPI Key read from environment variable')",
            "        return os.environ['MOBSF_API_KEY']",
            "    home_dir = Path(home_dir)",
            "    secret_file = home_dir / 'secret'",
            "    if secret_file.exists() and secret_file.is_file():",
            "        try:",
            "            _api_key = secret_file.read_bytes().strip()",
            "            return sha256(_api_key).hexdigest()",
            "        except Exception:",
            "            logger.exception('Cannot Read API Key')",
            "    return None"
        ],
        "afterPatchFile": [
            "\"\"\"Initialize on first run.\"\"\"",
            "import logging",
            "import os",
            "import random",
            "import subprocess",
            "import sys",
            "import shutil",
            "import threading",
            "from hashlib import sha256",
            "from pathlib import Path",
            "from importlib import (",
            "    machinery,",
            "    util,",
            ")",
            "",
            "from mobsf.MobSF.tools_download import install_jadx",
            "from mobsf.install.windows.setup import windows_config_local",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "VERSION = '4.3.1'",
            "BANNER = r\"\"\"",
            "  __  __       _    ____  _____       _  _    _____ ",
            " |  \\/  | ___ | |__/ ___||  ___|_   _| || |  |___ / ",
            " | |\\/| |/ _ \\| '_ \\___ \\| |_  \\ \\ / / || |_   |_ \\ ",
            " | |  | | (_) | |_) |__) |  _|  \\ V /|__   _| ___) |",
            " |_|  |_|\\___/|_.__/____/|_|     \\_/    |_|(_)____/ ",
            "\"\"\"  # noqa: W291",
            "# ASCII Font: Standard",
            "",
            "",
            "def first_run(secret_file, base_dir, mobsf_home):",
            "    # Based on https://gist.github.com/ndarville/3452907#file-secret-key-gen-py",
            "    base_dir = Path(base_dir)",
            "    mobsf_home = Path(mobsf_home)",
            "    secret_file = Path(secret_file)",
            "    if os.getenv('MOBSF_SECRET_KEY'):",
            "        secret_key = os.environ['MOBSF_SECRET_KEY']",
            "    elif secret_file.exists() and secret_file.is_file():",
            "        secret_key = secret_file.read_text().strip()",
            "    else:",
            "        try:",
            "            secret_key = get_random()",
            "            secret_file.write_text(secret_key)",
            "        except IOError:",
            "            raise Exception('Secret file generation failed' % secret_file)",
            "        # Run Once",
            "        make_migrations(base_dir)",
            "        migrate(base_dir)",
            "        # Install JADX",
            "        thread = threading.Thread(",
            "            target=install_jadx,",
            "            name='install_jadx',",
            "            args=(mobsf_home.as_posix(),))",
            "        thread.start()",
            "        # Windows Setup",
            "        windows_config_local(mobsf_home.as_posix())",
            "    return secret_key",
            "",
            "",
            "def create_user_conf(mobsf_home, base_dir):",
            "    try:",
            "        config_path = mobsf_home / 'config.py'",
            "        if not config_path.exists():",
            "            sample_conf = base_dir / 'MobSF' / 'settings.py'",
            "            dat = sample_conf.read_text().splitlines()",
            "            config = []",
            "            add = False",
            "            for line in dat:",
            "                if '^CONFIG-START^' in line:",
            "                    add = True",
            "                if '^CONFIG-END^' in line:",
            "                    break",
            "                if add:",
            "                    config.append(line.lstrip())",
            "            config.pop(0)",
            "            conf_str = '\\n'.join(config)",
            "            config_path.write_text(conf_str)",
            "    except Exception:",
            "        logger.exception('Cannot create config file')",
            "",
            "",
            "def django_operation(cmds, base_dir):",
            "    \"\"\"Generic Function for Djano operations.\"\"\"",
            "    manage = base_dir.parent / 'manage.py'",
            "    if manage.exists() and manage.is_file():",
            "        # Bail out for package",
            "        return",
            "    print(manage)",
            "    args = [sys.executable, manage.as_posix()]",
            "    args.extend(cmds)",
            "    subprocess.call(args)",
            "",
            "",
            "def make_migrations(base_dir):",
            "    \"\"\"Create Database Migrations.\"\"\"",
            "    try:",
            "        django_operation(['makemigrations'], base_dir)",
            "        django_operation(['makemigrations', 'StaticAnalyzer'], base_dir)",
            "    except Exception:",
            "        logger.exception('Cannot Make Migrations')",
            "",
            "",
            "def migrate(base_dir):",
            "    \"\"\"Migrate Database.\"\"\"",
            "    try:",
            "        django_operation(['migrate'], base_dir)",
            "        django_operation(['migrate', '--run-syncdb'], base_dir)",
            "        django_operation(['create_roles'], base_dir)",
            "    except Exception:",
            "        logger.exception('Cannot Migrate')",
            "",
            "",
            "def get_random():",
            "    choice = 'abcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*(-_=+)'",
            "    return ''.join([random.SystemRandom().choice(choice) for i in range(50)])",
            "",
            "",
            "def get_mobsf_home(use_home, base_dir):",
            "    try:",
            "        base_dir = Path(base_dir)",
            "        mobsf_home = ''",
            "        if use_home:",
            "            mobsf_home = Path.home() / '.MobSF'",
            "            custom_home = os.getenv('MOBSF_HOME_DIR')",
            "            if custom_home:",
            "                p = Path(custom_home)",
            "                if p.exists() and p.is_absolute() and p.is_dir():",
            "                    mobsf_home = p",
            "            # MobSF Home Directory",
            "            if not mobsf_home.exists():",
            "                mobsf_home.mkdir(parents=True, exist_ok=True)",
            "            create_user_conf(mobsf_home, base_dir)",
            "        else:",
            "            mobsf_home = base_dir",
            "        # Download Directory",
            "        dwd_dir = mobsf_home / 'downloads'",
            "        dwd_dir.mkdir(parents=True, exist_ok=True)",
            "        # Screenshot Directory",
            "        screen_dir = mobsf_home / 'screen'",
            "        screen_dir.mkdir(parents=True, exist_ok=True)",
            "        # Upload Directory",
            "        upload_dir = mobsf_home / 'uploads'",
            "        upload_dir.mkdir(parents=True, exist_ok=True)",
            "        # Downloaded tools",
            "        downloaded_tools_dir = mobsf_home / 'tools'",
            "        downloaded_tools_dir.mkdir(parents=True, exist_ok=True)",
            "        # Signatures Directory",
            "        sig_dir = mobsf_home / 'signatures'",
            "        sig_dir.mkdir(parents=True, exist_ok=True)",
            "        if use_home:",
            "            src = Path(base_dir) / 'signatures'",
            "            try:",
            "                shutil.copytree(src, sig_dir, dirs_exist_ok=True)",
            "            except Exception:",
            "                pass",
            "        return mobsf_home.as_posix()",
            "    except Exception:",
            "        logger.exception('Creating MobSF Home Directory')",
            "",
            "",
            "def get_mobsf_version():",
            "    return BANNER, VERSION, f'v{VERSION}'",
            "",
            "",
            "def load_source(modname, filename):",
            "    loader = machinery.SourceFileLoader(modname, filename)",
            "    spec = util.spec_from_file_location(modname, filename, loader=loader)",
            "    module = util.module_from_spec(spec)",
            "    loader.exec_module(module)",
            "    return module",
            "",
            "",
            "def get_docker_secret_by_file(secret_key):",
            "    try:",
            "        secret_path = os.environ.get(secret_key)",
            "        path = Path(secret_path)",
            "        if path.exists() and path.is_file():",
            "            return path.read_text().strip()",
            "    except Exception:",
            "        logger.exception('Cannot read secret from %s', secret_path)",
            "    raise Exception('Cannot read secret from file')",
            "",
            "",
            "def get_secret_from_file_or_env(env_secret_key):",
            "    docker_secret_key = f'{env_secret_key}_FILE'",
            "    if os.environ.get(docker_secret_key):",
            "        return get_docker_secret_by_file(docker_secret_key)",
            "    else:",
            "        return os.environ[env_secret_key]",
            "",
            "",
            "def api_key(home_dir):",
            "    \"\"\"Print REST API Key.\"\"\"",
            "    # Form Docker Secrets",
            "    if os.environ.get('MOBSF_API_KEY_FILE'):",
            "        logger.info('\\nAPI Key read from docker secrets')",
            "        try:",
            "            return get_docker_secret_by_file('MOBSF_API_KEY_FILE')",
            "        except Exception:",
            "            logger.exception('Cannot read API Key from docker secrets')",
            "    # From Environment Variable",
            "    if os.environ.get('MOBSF_API_KEY'):",
            "        logger.info('\\nAPI Key read from environment variable')",
            "        return os.environ['MOBSF_API_KEY']",
            "    home_dir = Path(home_dir)",
            "    secret_file = home_dir / 'secret'",
            "    if secret_file.exists() and secret_file.is_file():",
            "        try:",
            "            _api_key = secret_file.read_bytes().strip()",
            "            return sha256(_api_key).hexdigest()",
            "        except Exception:",
            "            logger.exception('Cannot Read API Key')",
            "    return None"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "21": [
                "VERSION"
            ]
        },
        "addLocation": []
    },
    "mobsf/MobSF/urls.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 52,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 53,
                "PatchRowcode": " from . import settings"
            },
            "2": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 54,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-bundle_id_regex = r'(?P<bundle_id>([a-zA-Z0-9]{1}[\\w.-]{1,255}))$'"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+bundle_id_regex = r'(?P<bundle_id>.+)$'"
            },
            "5": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 56,
                "PatchRowcode": " checksum_regex = r'(?P<checksum>[0-9a-f]{32})'"
            },
            "6": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 57,
                "PatchRowcode": " paginate = r'(?P<page_size>[0-9]{1,10})/(?P<page_number>[0-9]{1,10})'"
            },
            "7": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 58,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "from django.urls import re_path",
            "",
            "from mobsf.DynamicAnalyzer.views.common import (",
            "    device,",
            "    frida,",
            ")",
            "from mobsf.DynamicAnalyzer.views.android import dynamic_analyzer as dz",
            "from mobsf.DynamicAnalyzer.views.android import (",
            "    operations,",
            "    report,",
            "    tests_common,",
            "    tests_frida,",
            ")",
            "from mobsf.DynamicAnalyzer.views.ios import dynamic_analyzer as idz",
            "from mobsf.DynamicAnalyzer.views.ios import (",
            "    corellium_instance as instance,",
            "    report as ios_view_report,",
            "    tests_frida as ios_tests_frida,",
            ")",
            "from mobsf.MobSF import utils",
            "from mobsf.MobSF.security import (",
            "    init_exec_hooks,",
            "    store_exec_hashes_at_first_run,",
            ")",
            "from mobsf.MobSF.views import (",
            "    authentication,",
            "    authorization,",
            "    home,",
            "    saml2,",
            ")",
            "from mobsf.MobSF.views.api import api_static_analysis as api_sz",
            "from mobsf.MobSF.views.api import api_android_dynamic_analysis as api_dz",
            "from mobsf.MobSF.views.api import api_ios_dynamic_analysis as api_idz",
            "from mobsf.StaticAnalyzer import tests",
            "from mobsf.StaticAnalyzer.views.common import (",
            "    appsec,",
            "    async_task,",
            "    pdf,",
            "    shared_func,",
            "    suppression,",
            ")",
            "from mobsf.StaticAnalyzer.views.android.views import (",
            "    find,",
            "    manifest_view,",
            "    source_tree,",
            "    view_source,",
            ")",
            "from mobsf.StaticAnalyzer.views.windows import windows",
            "from mobsf.StaticAnalyzer.views.android import static_analyzer as android_sa",
            "from mobsf.StaticAnalyzer.views.ios import static_analyzer as ios_sa",
            "from mobsf.StaticAnalyzer.views.ios.views import view_source as io_view_source",
            "",
            "from . import settings",
            "",
            "bundle_id_regex = r'(?P<bundle_id>([a-zA-Z0-9]{1}[\\w.-]{1,255}))$'",
            "checksum_regex = r'(?P<checksum>[0-9a-f]{32})'",
            "paginate = r'(?P<page_size>[0-9]{1,10})/(?P<page_number>[0-9]{1,10})'",
            "",
            "urlpatterns = [",
            "    re_path(r'^login/$',",
            "            authentication.login_view,",
            "            name='login'),",
            "    re_path(r'^logout$',",
            "            authentication.logout_view,",
            "            name='logout'),",
            "    re_path(r'^change_password/$',",
            "            authentication.change_password,",
            "            name='change_password'),",
            "    re_path(r'^users/$',",
            "            authorization.users,",
            "            name='users'),",
            "    re_path(r'^create_user/$',",
            "            authorization.create_user,",
            "            name='create_user'),",
            "    re_path(r'^delete_user/$',",
            "            authorization.delete_user,",
            "            name='delete_user'),",
            "    # SAML2",
            "    re_path(r'^sso/$',",
            "            saml2.saml_login,",
            "            name='saml_login'),",
            "    re_path(r'^sso/acs/$',",
            "            saml2.saml_acs,",
            "            name='saml_acs'),",
            "    # REST API",
            "    # Static Analysis",
            "    re_path(r'^api/v1/upload$', api_sz.api_upload),",
            "    re_path(r'^api/v1/scan$', api_sz.api_scan),",
            "    re_path(r'^api/v1/search$', api_sz.api_search),",
            "    re_path(r'^api/v1/scan_logs$', api_sz.api_scan_logs),",
            "    re_path(r'^api/v1/tasks$', api_sz.api_tasks),",
            "    re_path(r'^api/v1/delete_scan$', api_sz.api_delete_scan),",
            "    re_path(r'^api/v1/download_pdf$', api_sz.api_pdf_report),",
            "    re_path(r'^api/v1/report_json$', api_sz.api_json_report),",
            "    re_path(r'^api/v1/view_source$', api_sz.api_view_source,",
            "            name='api_view_source'),",
            "    re_path(r'^api/v1/scans$', api_sz.api_recent_scans),",
            "    re_path(r'^api/v1/compare$', api_sz.api_compare),",
            "    re_path(r'^api/v1/scorecard$', api_sz.api_scorecard),",
            "    # Static Suppression",
            "    re_path(r'^api/v1/suppress_by_rule$', api_sz.api_suppress_by_rule_id),",
            "    re_path(r'^api/v1/suppress_by_files$', api_sz.api_suppress_by_files),",
            "    re_path(r'^api/v1/list_suppressions$', api_sz.api_list_suppressions),",
            "    re_path(r'^api/v1/delete_suppression$', api_sz.api_delete_suppression),",
            "    # Dynamic Analysis",
            "    re_path(r'^api/v1/dynamic/get_apps$', api_dz.api_get_apps),",
            "    re_path(r'^api/v1/dynamic/start_analysis$', api_dz.api_start_analysis),",
            "    re_path(r'^api/v1/dynamic/stop_analysis$', api_dz.api_stop_analysis),",
            "    re_path(r'^api/v1/dynamic/report_json$', api_dz.api_dynamic_report),",
            "    # Android Specific",
            "    re_path(r'^api/v1/android/logcat$', api_dz.api_logcat),",
            "    re_path(r'^api/v1/android/mobsfy$', api_dz.api_mobsfy),",
            "    re_path(r'^api/v1/android/adb_command$', api_dz.api_adb_execute),",
            "    re_path(r'^api/v1/android/root_ca$', api_dz.api_root_ca),",
            "    re_path(r'^api/v1/android/global_proxy$', api_dz.api_global_proxy),",
            "    re_path(r'^api/v1/android/activity$', api_dz.api_act_tester),",
            "    re_path(r'^api/v1/android/start_activity$', api_dz.api_start_activity),",
            "    re_path(r'^api/v1/android/tls_tests$', api_dz.api_tls_tester),",
            "    # Frida",
            "    re_path(r'^api/v1/frida/instrument$', api_dz.api_instrument),",
            "    re_path(r'^api/v1/frida/api_monitor$', api_dz.api_api_monitor),",
            "    re_path(r'^api/v1/frida/get_dependencies$', api_dz.api_get_dependencies),",
            "    # Shared",
            "    re_path(r'^api/v1/frida/logs$', api_dz.api_frida_logs),",
            "    re_path(r'^api/v1/frida/list_scripts$', api_dz.api_list_frida_scripts),",
            "    re_path(r'^api/v1/frida/get_script$', api_dz.api_get_script),",
            "    re_path(r'^api/v1/dynamic/view_source$', api_dz.api_dynamic_view_file),",
            "    # iOS Specific",
            "    re_path(r'^api/v1/ios/corellium_supported_models$',",
            "            api_idz.api_corellium_get_supported_models),",
            "    re_path(r'^api/v1/ios/corellium_ios_versions$',",
            "            api_idz.api_corellium_get_supported_ios_versions),",
            "    re_path(r'^api/v1/ios/corellium_create_ios_instance$',",
            "            api_idz.api_corellium_create_ios_instance),",
            "    re_path(r'^api/v1/ios/dynamic_analysis$',",
            "            api_idz.api_ios_dynamic_analysis),",
            "    re_path(r'^api/v1/ios/corellium_start_instance$',",
            "            api_idz.api_corellium_start_instance),",
            "    re_path(r'^api/v1/ios/corellium_stop_instance$',",
            "            api_idz.api_corellium_stop_instance),",
            "    re_path(r'^api/v1/ios/corellium_unpause_instance$',",
            "            api_idz.api_corellium_unpause_instance),",
            "    re_path(r'^api/v1/ios/corellium_reboot_instance$',",
            "            api_idz.api_corellium_reboot_instance),",
            "    re_path(r'^api/v1/ios/corellium_destroy_instance$',",
            "            api_idz.api_corellium_destroy_instance),",
            "    re_path(r'^api/v1/ios/corellium_list_apps$',",
            "            api_idz.api_corellium_instance_list_apps),",
            "    re_path(r'^api/v1/ios/setup_environment$',",
            "            api_idz.api_setup_environment),",
            "    re_path(r'^api/v1/ios/dynamic_analyzer$',",
            "            api_idz.api_ios_dynamic_analyzer),",
            "    re_path(r'^api/v1/ios/run_app$',",
            "            api_idz.api_run_app),",
            "    re_path(r'^api/v1/ios/stop_app$',",
            "            api_idz.api_stop_app),",
            "    re_path(r'^api/v1/ios/remove_app$',",
            "            api_idz.api_remove_app),",
            "    re_path(r'^api/v1/ios/take_screenshot$',",
            "            api_idz.api_take_screenshot),",
            "    re_path(r'^api/v1/ios/get_app_container_path$',",
            "            api_idz.api_get_app_container_path),",
            "    re_path(r'^api/v1/ios/network_capture$',",
            "            api_idz.api_network_capture),",
            "    re_path(r'^api/v1/ios/live_pcap_download$',",
            "            api_idz.api_live_pcap_download),",
            "    re_path(r'^api/v1/ios/ssh_execute$',",
            "            api_idz.api_ssh_execute),",
            "    re_path(r'^api/v1/ios/download_app_data$',",
            "            api_idz.api_download_app_data),",
            "    re_path(r'^api/v1/ios/instance_input$',",
            "            api_idz.api_instance_input),",
            "    re_path(r'^api/v1/ios/system_logs$',",
            "            api_idz.api_system_logs),",
            "    re_path(r'^api/v1/ios/file_upload$',",
            "            api_idz.api_device_file_upload),",
            "    re_path(r'^api/v1/ios/file_download$',",
            "            api_idz.api_device_file_download),",
            "    # Frida",
            "    re_path(r'^api/v1/frida/ios_instrument$', api_idz.api_ios_instrument),",
            "    re_path(r'^api/v1/dynamic/ios_report_json$', api_idz.api_ios_view_report),",
            "]",
            "if settings.API_ONLY == '0':",
            "    urlpatterns.extend([",
            "        # General",
            "        re_path(r'^$', home.index, name='home'),",
            "        re_path(r'^upload/$', home.Upload.as_view, name='upload'),",
            "        re_path(r'^download/', home.download, name='download'),",
            "        re_path(fr'^download_binary/{checksum_regex}/$',",
            "                home.download_binary,",
            "                name='download_binary'),",
            "        re_path(r'^download_scan/', home.download_apk, name='download_scan'),",
            "        re_path(r'^generate_downloads/$',",
            "                home.generate_download,",
            "                name='generate_downloads'),",
            "        re_path(r'^about$', home.about, name='about'),",
            "        re_path(r'^donate$', home.donate, name='donate'),",
            "        re_path(r'^api_docs$', home.api_docs, name='api_docs'),",
            "        re_path(r'^recent_scans/$', home.recent_scans, name='recent'),",
            "        re_path(fr'^recent_scans/{paginate}/$',",
            "                home.recent_scans,",
            "                name='scans_paginated'),",
            "        re_path(r'^delete_scan/$', home.delete_scan, name='delete_scan'),",
            "        re_path(r'^search$', home.search),",
            "        re_path(r'^status/$', home.scan_status, name='status'),",
            "        re_path(r'^error/$', home.error, name='error'),",
            "        re_path(r'^zip_format/$', home.zip_format),",
            "        re_path(r'^robots.txt$', home.robots_txt),",
            "        re_path(r'^dynamic_analysis/$', home.dynamic_analysis, name='dynamic'),",
            "        re_path(r'^tasks$',",
            "                async_task.list_tasks,",
            "                name='list_tasks'),",
            "        # Static Analysis",
            "        # Android",
            "        re_path(fr'^static_analyzer/{checksum_regex}/$',",
            "                android_sa.static_analyzer,",
            "                name='static_analyzer'),",
            "        # Remove this is version 4/5",
            "        re_path(r'^source_code/$', source_tree.run, name='tree_view'),",
            "        re_path(r'^view_file/$', view_source.run, name='view_source'),",
            "        re_path(r'^find/$', find.run, name='find_files'),",
            "        re_path(fr'^manifest_view/{checksum_regex}/$',",
            "                manifest_view.run,",
            "                name='manifest_view'),",
            "        # IOS",
            "        re_path(fr'^static_analyzer_ios/{checksum_regex}/$',",
            "                ios_sa.static_analyzer_ios,",
            "                name='static_analyzer_ios'),",
            "        re_path(r'^view_file_ios/$',",
            "                io_view_source.run,",
            "                name='view_file_ios'),",
            "        # Windows",
            "        re_path(fr'^static_analyzer_windows/{checksum_regex}/$',",
            "                windows.staticanalyzer_windows,",
            "                name='static_analyzer_windows'),",
            "        # Shared",
            "        re_path(fr'^pdf/{checksum_regex}/$', pdf.pdf, name='pdf'),",
            "        re_path(fr'^appsec_dashboard/{checksum_regex}/$',",
            "                appsec.appsec_dashboard,",
            "                name='appsec_dashboard'),",
            "        # Suppression",
            "        re_path(r'^suppress_by_rule/$',",
            "                suppression.suppress_by_rule_id,",
            "                name='suppress_by_rule'),",
            "        re_path(r'^suppress_by_files/$',",
            "                suppression.suppress_by_files,",
            "                name='suppress_by_files'),",
            "        re_path(r'^list_suppressions/$',",
            "                suppression.list_suppressions,",
            "                name='list_suppressions'),",
            "        re_path(r'^delete_suppression/$',",
            "                suppression.delete_suppression,",
            "                name='delete_suppression'),",
            "        # App Compare",
            "        re_path(r'^compare/(?P<hash1>[0-9a-f]{32})/(?P<hash2>[0-9a-f]{32})/$',",
            "                shared_func.compare_apps),",
            "        # Relative Shared & Dynamic Library scan",
            "        re_path(fr'^scan_library/{checksum_regex}$',",
            "                shared_func.scan_library,",
            "                name='scan_library'),",
            "        # Dynamic Analysis",
            "        re_path(r'^android/dynamic_analysis/$',",
            "                dz.android_dynamic_analysis,",
            "                name='dynamic_android'),",
            "        re_path(fr'^android_dynamic/{checksum_regex}$',",
            "                dz.dynamic_analyzer,",
            "                name='dynamic_analyzer'),",
            "        re_path(r'^httptools$',",
            "                dz.httptools_start,",
            "                name='httptools'),",
            "        re_path(r'^logcat/$', dz.logcat),",
            "        re_path(fr'^static_scan/{checksum_regex}$',",
            "                dz.trigger_static_analysis,",
            "                name='static_scan'),",
            "        # Android Operations",
            "        re_path(r'^run_apk/$', operations.run_apk),",
            "        re_path(r'^mobsfy/$', operations.mobsfy, name='mobsfy'),",
            "        re_path(r'^screenshot/$', operations.take_screenshot),",
            "        re_path(r'^execute_adb/$', operations.execute_adb),",
            "        re_path(r'^screen_cast/$',",
            "                operations.screen_cast,",
            "                name='screen_cast'),",
            "        re_path(r'^touch_events/$',",
            "                operations.touch,",
            "                name='android_touch'),",
            "        re_path(r'^get_component/$', operations.get_component),",
            "        re_path(r'^mobsf_ca/$', operations.mobsf_ca),",
            "        re_path(r'^global_proxy/$', operations.global_proxy),",
            "        # Dynamic Tests",
            "        re_path(r'^activity_tester/$', tests_common.activity_tester),",
            "        re_path(r'^start_activity/$',",
            "                tests_common.start_activity,",
            "                name='start_activity'),",
            "        re_path(r'^start_deeplink/$',",
            "                tests_common.start_deeplink,",
            "                name='start_deeplink'),",
            "        re_path(r'^download_data/$', tests_common.download_data),",
            "        re_path(r'^collect_logs/$', tests_common.collect_logs),",
            "        re_path(r'^tls_tests/$', tests_common.tls_tests),",
            "        # Frida",
            "        re_path(r'^frida_instrument/$',",
            "                tests_frida.instrument,",
            "                name='android_instrument'),",
            "        re_path(r'^live_api/$',",
            "                tests_frida.live_api,",
            "                name='live_api'),",
            "        re_path(r'^frida_logs/$',",
            "                frida.frida_logs,",
            "                name='frida_logs'),",
            "        re_path(r'^get_dependencies/$', tests_frida.get_runtime_dependencies),",
            "        # Report",
            "        re_path(fr'^dynamic_report/{checksum_regex}$',",
            "                report.view_report,",
            "                name='dynamic_report'),",
            "        # Shared",
            "        re_path(r'^list_frida_scripts/$',",
            "                frida.list_frida_scripts,",
            "                name='list_frida_scripts'),",
            "        re_path(r'^get_script/$',",
            "                frida.get_script,",
            "                name='get_script'),",
            "        re_path(r'^dynamic_view_file/$',",
            "                device.view_file,",
            "                name='dynamic_view_file'),",
            "        # iOS Dynamic Analysis",
            "        re_path(r'^ios/dynamic_analysis/$',",
            "                idz.dynamic_analysis,",
            "                name='dynamic_ios'),",
            "        re_path(r'^ios/create_vm_instance/$',",
            "                instance.create_vm_instance,",
            "                name='create_vm_instance'),",
            "        re_path(r'^ios/get_supported_models/$',",
            "                instance.get_supported_models,",
            "                name='get_supported_models'),",
            "        re_path(r'^ios/get_supported_os/$',",
            "                instance.get_supported_os,",
            "                name='get_supported_os'),",
            "        re_path(r'^ios/start_instance/$',",
            "                instance.start_instance,",
            "                name='start_instance'),",
            "        re_path(r'^ios/stop_instance/$',",
            "                instance.stop_instance,",
            "                name='stop_instance'),",
            "        re_path(r'^ios/unpause_instance/$',",
            "                instance.unpause_instance,",
            "                name='unpause_instance'),",
            "        re_path(r'^ios/reboot_instance/$',",
            "                instance.reboot_instance,",
            "                name='reboot_instance'),",
            "        re_path(r'^ios/destroy_instance/$',",
            "                instance.destroy_instance,",
            "                name='destroy_instance'),",
            "        re_path(r'^ios/list_apps/$',",
            "                instance.list_apps,",
            "                name='list_apps'),",
            "        re_path(fr'^ios/setup_environment/{checksum_regex}$',",
            "                instance.setup_environment,",
            "                name='setup_environment'),",
            "        re_path(r'^ios/dynamic_analyzer/$',",
            "                idz.dynamic_analyzer,",
            "                name='dynamic_analyzer_ios'),",
            "        re_path(r'^ios/run_app/$',",
            "                instance.run_app,",
            "                name='run_app'),",
            "        re_path(r'^ios/remove_app/$',",
            "                instance.remove_app,",
            "                name='remove_app'),",
            "        re_path(r'^ios/take_screenshot/$',",
            "                instance.take_screenshot,",
            "                name='take_screenshot'),",
            "        re_path(r'^ios/network_capture/$',",
            "                instance.network_capture,",
            "                name='network_capture'),",
            "        re_path(r'^ios/live_pcap_download/$',",
            "                instance.live_pcap_download,",
            "                name='ios_live_pcap_download'),",
            "        re_path(r'^ios/ssh_execute/$',",
            "                instance.ssh_execute,",
            "                name='ssh_execute'),",
            "        re_path(r'^ios/upload_file/$',",
            "                instance.upload_file,",
            "                name='upload_file'),",
            "        re_path(r'^ios/download_file/$',",
            "                instance.download_file,",
            "                name='download_file'),",
            "        re_path(r'^ios/touch/$',",
            "                instance.touch,",
            "                name='ios_touch'),",
            "        re_path(r'^ios/get_container_path/$',",
            "                instance.get_container_path,",
            "                name='get_container_path'),",
            "        re_path(r'^ios/system_logs/$',",
            "                instance.system_logs,",
            "                name='ios_system_logs'),",
            "        re_path(fr'^ios/download_data/{bundle_id_regex}',",
            "                instance.download_data,",
            "                name='ios_download_data'),",
            "        re_path(r'^ios/instrument/$',",
            "                ios_tests_frida.ios_instrument,",
            "                name='ios_instrument'),",
            "        re_path(fr'^ios/view_report/{bundle_id_regex}',",
            "                ios_view_report.ios_view_report,",
            "                name='ios_view_report'),",
            "",
            "        # Test",
            "        re_path(r'^tests/$', tests.start_test),",
            "    ])",
            "",
            "utils.print_version()",
            "init_exec_hooks()",
            "store_exec_hashes_at_first_run()"
        ],
        "afterPatchFile": [
            "from django.urls import re_path",
            "",
            "from mobsf.DynamicAnalyzer.views.common import (",
            "    device,",
            "    frida,",
            ")",
            "from mobsf.DynamicAnalyzer.views.android import dynamic_analyzer as dz",
            "from mobsf.DynamicAnalyzer.views.android import (",
            "    operations,",
            "    report,",
            "    tests_common,",
            "    tests_frida,",
            ")",
            "from mobsf.DynamicAnalyzer.views.ios import dynamic_analyzer as idz",
            "from mobsf.DynamicAnalyzer.views.ios import (",
            "    corellium_instance as instance,",
            "    report as ios_view_report,",
            "    tests_frida as ios_tests_frida,",
            ")",
            "from mobsf.MobSF import utils",
            "from mobsf.MobSF.security import (",
            "    init_exec_hooks,",
            "    store_exec_hashes_at_first_run,",
            ")",
            "from mobsf.MobSF.views import (",
            "    authentication,",
            "    authorization,",
            "    home,",
            "    saml2,",
            ")",
            "from mobsf.MobSF.views.api import api_static_analysis as api_sz",
            "from mobsf.MobSF.views.api import api_android_dynamic_analysis as api_dz",
            "from mobsf.MobSF.views.api import api_ios_dynamic_analysis as api_idz",
            "from mobsf.StaticAnalyzer import tests",
            "from mobsf.StaticAnalyzer.views.common import (",
            "    appsec,",
            "    async_task,",
            "    pdf,",
            "    shared_func,",
            "    suppression,",
            ")",
            "from mobsf.StaticAnalyzer.views.android.views import (",
            "    find,",
            "    manifest_view,",
            "    source_tree,",
            "    view_source,",
            ")",
            "from mobsf.StaticAnalyzer.views.windows import windows",
            "from mobsf.StaticAnalyzer.views.android import static_analyzer as android_sa",
            "from mobsf.StaticAnalyzer.views.ios import static_analyzer as ios_sa",
            "from mobsf.StaticAnalyzer.views.ios.views import view_source as io_view_source",
            "",
            "from . import settings",
            "",
            "bundle_id_regex = r'(?P<bundle_id>.+)$'",
            "checksum_regex = r'(?P<checksum>[0-9a-f]{32})'",
            "paginate = r'(?P<page_size>[0-9]{1,10})/(?P<page_number>[0-9]{1,10})'",
            "",
            "urlpatterns = [",
            "    re_path(r'^login/$',",
            "            authentication.login_view,",
            "            name='login'),",
            "    re_path(r'^logout$',",
            "            authentication.logout_view,",
            "            name='logout'),",
            "    re_path(r'^change_password/$',",
            "            authentication.change_password,",
            "            name='change_password'),",
            "    re_path(r'^users/$',",
            "            authorization.users,",
            "            name='users'),",
            "    re_path(r'^create_user/$',",
            "            authorization.create_user,",
            "            name='create_user'),",
            "    re_path(r'^delete_user/$',",
            "            authorization.delete_user,",
            "            name='delete_user'),",
            "    # SAML2",
            "    re_path(r'^sso/$',",
            "            saml2.saml_login,",
            "            name='saml_login'),",
            "    re_path(r'^sso/acs/$',",
            "            saml2.saml_acs,",
            "            name='saml_acs'),",
            "    # REST API",
            "    # Static Analysis",
            "    re_path(r'^api/v1/upload$', api_sz.api_upload),",
            "    re_path(r'^api/v1/scan$', api_sz.api_scan),",
            "    re_path(r'^api/v1/search$', api_sz.api_search),",
            "    re_path(r'^api/v1/scan_logs$', api_sz.api_scan_logs),",
            "    re_path(r'^api/v1/tasks$', api_sz.api_tasks),",
            "    re_path(r'^api/v1/delete_scan$', api_sz.api_delete_scan),",
            "    re_path(r'^api/v1/download_pdf$', api_sz.api_pdf_report),",
            "    re_path(r'^api/v1/report_json$', api_sz.api_json_report),",
            "    re_path(r'^api/v1/view_source$', api_sz.api_view_source,",
            "            name='api_view_source'),",
            "    re_path(r'^api/v1/scans$', api_sz.api_recent_scans),",
            "    re_path(r'^api/v1/compare$', api_sz.api_compare),",
            "    re_path(r'^api/v1/scorecard$', api_sz.api_scorecard),",
            "    # Static Suppression",
            "    re_path(r'^api/v1/suppress_by_rule$', api_sz.api_suppress_by_rule_id),",
            "    re_path(r'^api/v1/suppress_by_files$', api_sz.api_suppress_by_files),",
            "    re_path(r'^api/v1/list_suppressions$', api_sz.api_list_suppressions),",
            "    re_path(r'^api/v1/delete_suppression$', api_sz.api_delete_suppression),",
            "    # Dynamic Analysis",
            "    re_path(r'^api/v1/dynamic/get_apps$', api_dz.api_get_apps),",
            "    re_path(r'^api/v1/dynamic/start_analysis$', api_dz.api_start_analysis),",
            "    re_path(r'^api/v1/dynamic/stop_analysis$', api_dz.api_stop_analysis),",
            "    re_path(r'^api/v1/dynamic/report_json$', api_dz.api_dynamic_report),",
            "    # Android Specific",
            "    re_path(r'^api/v1/android/logcat$', api_dz.api_logcat),",
            "    re_path(r'^api/v1/android/mobsfy$', api_dz.api_mobsfy),",
            "    re_path(r'^api/v1/android/adb_command$', api_dz.api_adb_execute),",
            "    re_path(r'^api/v1/android/root_ca$', api_dz.api_root_ca),",
            "    re_path(r'^api/v1/android/global_proxy$', api_dz.api_global_proxy),",
            "    re_path(r'^api/v1/android/activity$', api_dz.api_act_tester),",
            "    re_path(r'^api/v1/android/start_activity$', api_dz.api_start_activity),",
            "    re_path(r'^api/v1/android/tls_tests$', api_dz.api_tls_tester),",
            "    # Frida",
            "    re_path(r'^api/v1/frida/instrument$', api_dz.api_instrument),",
            "    re_path(r'^api/v1/frida/api_monitor$', api_dz.api_api_monitor),",
            "    re_path(r'^api/v1/frida/get_dependencies$', api_dz.api_get_dependencies),",
            "    # Shared",
            "    re_path(r'^api/v1/frida/logs$', api_dz.api_frida_logs),",
            "    re_path(r'^api/v1/frida/list_scripts$', api_dz.api_list_frida_scripts),",
            "    re_path(r'^api/v1/frida/get_script$', api_dz.api_get_script),",
            "    re_path(r'^api/v1/dynamic/view_source$', api_dz.api_dynamic_view_file),",
            "    # iOS Specific",
            "    re_path(r'^api/v1/ios/corellium_supported_models$',",
            "            api_idz.api_corellium_get_supported_models),",
            "    re_path(r'^api/v1/ios/corellium_ios_versions$',",
            "            api_idz.api_corellium_get_supported_ios_versions),",
            "    re_path(r'^api/v1/ios/corellium_create_ios_instance$',",
            "            api_idz.api_corellium_create_ios_instance),",
            "    re_path(r'^api/v1/ios/dynamic_analysis$',",
            "            api_idz.api_ios_dynamic_analysis),",
            "    re_path(r'^api/v1/ios/corellium_start_instance$',",
            "            api_idz.api_corellium_start_instance),",
            "    re_path(r'^api/v1/ios/corellium_stop_instance$',",
            "            api_idz.api_corellium_stop_instance),",
            "    re_path(r'^api/v1/ios/corellium_unpause_instance$',",
            "            api_idz.api_corellium_unpause_instance),",
            "    re_path(r'^api/v1/ios/corellium_reboot_instance$',",
            "            api_idz.api_corellium_reboot_instance),",
            "    re_path(r'^api/v1/ios/corellium_destroy_instance$',",
            "            api_idz.api_corellium_destroy_instance),",
            "    re_path(r'^api/v1/ios/corellium_list_apps$',",
            "            api_idz.api_corellium_instance_list_apps),",
            "    re_path(r'^api/v1/ios/setup_environment$',",
            "            api_idz.api_setup_environment),",
            "    re_path(r'^api/v1/ios/dynamic_analyzer$',",
            "            api_idz.api_ios_dynamic_analyzer),",
            "    re_path(r'^api/v1/ios/run_app$',",
            "            api_idz.api_run_app),",
            "    re_path(r'^api/v1/ios/stop_app$',",
            "            api_idz.api_stop_app),",
            "    re_path(r'^api/v1/ios/remove_app$',",
            "            api_idz.api_remove_app),",
            "    re_path(r'^api/v1/ios/take_screenshot$',",
            "            api_idz.api_take_screenshot),",
            "    re_path(r'^api/v1/ios/get_app_container_path$',",
            "            api_idz.api_get_app_container_path),",
            "    re_path(r'^api/v1/ios/network_capture$',",
            "            api_idz.api_network_capture),",
            "    re_path(r'^api/v1/ios/live_pcap_download$',",
            "            api_idz.api_live_pcap_download),",
            "    re_path(r'^api/v1/ios/ssh_execute$',",
            "            api_idz.api_ssh_execute),",
            "    re_path(r'^api/v1/ios/download_app_data$',",
            "            api_idz.api_download_app_data),",
            "    re_path(r'^api/v1/ios/instance_input$',",
            "            api_idz.api_instance_input),",
            "    re_path(r'^api/v1/ios/system_logs$',",
            "            api_idz.api_system_logs),",
            "    re_path(r'^api/v1/ios/file_upload$',",
            "            api_idz.api_device_file_upload),",
            "    re_path(r'^api/v1/ios/file_download$',",
            "            api_idz.api_device_file_download),",
            "    # Frida",
            "    re_path(r'^api/v1/frida/ios_instrument$', api_idz.api_ios_instrument),",
            "    re_path(r'^api/v1/dynamic/ios_report_json$', api_idz.api_ios_view_report),",
            "]",
            "if settings.API_ONLY == '0':",
            "    urlpatterns.extend([",
            "        # General",
            "        re_path(r'^$', home.index, name='home'),",
            "        re_path(r'^upload/$', home.Upload.as_view, name='upload'),",
            "        re_path(r'^download/', home.download, name='download'),",
            "        re_path(fr'^download_binary/{checksum_regex}/$',",
            "                home.download_binary,",
            "                name='download_binary'),",
            "        re_path(r'^download_scan/', home.download_apk, name='download_scan'),",
            "        re_path(r'^generate_downloads/$',",
            "                home.generate_download,",
            "                name='generate_downloads'),",
            "        re_path(r'^about$', home.about, name='about'),",
            "        re_path(r'^donate$', home.donate, name='donate'),",
            "        re_path(r'^api_docs$', home.api_docs, name='api_docs'),",
            "        re_path(r'^recent_scans/$', home.recent_scans, name='recent'),",
            "        re_path(fr'^recent_scans/{paginate}/$',",
            "                home.recent_scans,",
            "                name='scans_paginated'),",
            "        re_path(r'^delete_scan/$', home.delete_scan, name='delete_scan'),",
            "        re_path(r'^search$', home.search),",
            "        re_path(r'^status/$', home.scan_status, name='status'),",
            "        re_path(r'^error/$', home.error, name='error'),",
            "        re_path(r'^zip_format/$', home.zip_format),",
            "        re_path(r'^robots.txt$', home.robots_txt),",
            "        re_path(r'^dynamic_analysis/$', home.dynamic_analysis, name='dynamic'),",
            "        re_path(r'^tasks$',",
            "                async_task.list_tasks,",
            "                name='list_tasks'),",
            "        # Static Analysis",
            "        # Android",
            "        re_path(fr'^static_analyzer/{checksum_regex}/$',",
            "                android_sa.static_analyzer,",
            "                name='static_analyzer'),",
            "        # Remove this is version 4/5",
            "        re_path(r'^source_code/$', source_tree.run, name='tree_view'),",
            "        re_path(r'^view_file/$', view_source.run, name='view_source'),",
            "        re_path(r'^find/$', find.run, name='find_files'),",
            "        re_path(fr'^manifest_view/{checksum_regex}/$',",
            "                manifest_view.run,",
            "                name='manifest_view'),",
            "        # IOS",
            "        re_path(fr'^static_analyzer_ios/{checksum_regex}/$',",
            "                ios_sa.static_analyzer_ios,",
            "                name='static_analyzer_ios'),",
            "        re_path(r'^view_file_ios/$',",
            "                io_view_source.run,",
            "                name='view_file_ios'),",
            "        # Windows",
            "        re_path(fr'^static_analyzer_windows/{checksum_regex}/$',",
            "                windows.staticanalyzer_windows,",
            "                name='static_analyzer_windows'),",
            "        # Shared",
            "        re_path(fr'^pdf/{checksum_regex}/$', pdf.pdf, name='pdf'),",
            "        re_path(fr'^appsec_dashboard/{checksum_regex}/$',",
            "                appsec.appsec_dashboard,",
            "                name='appsec_dashboard'),",
            "        # Suppression",
            "        re_path(r'^suppress_by_rule/$',",
            "                suppression.suppress_by_rule_id,",
            "                name='suppress_by_rule'),",
            "        re_path(r'^suppress_by_files/$',",
            "                suppression.suppress_by_files,",
            "                name='suppress_by_files'),",
            "        re_path(r'^list_suppressions/$',",
            "                suppression.list_suppressions,",
            "                name='list_suppressions'),",
            "        re_path(r'^delete_suppression/$',",
            "                suppression.delete_suppression,",
            "                name='delete_suppression'),",
            "        # App Compare",
            "        re_path(r'^compare/(?P<hash1>[0-9a-f]{32})/(?P<hash2>[0-9a-f]{32})/$',",
            "                shared_func.compare_apps),",
            "        # Relative Shared & Dynamic Library scan",
            "        re_path(fr'^scan_library/{checksum_regex}$',",
            "                shared_func.scan_library,",
            "                name='scan_library'),",
            "        # Dynamic Analysis",
            "        re_path(r'^android/dynamic_analysis/$',",
            "                dz.android_dynamic_analysis,",
            "                name='dynamic_android'),",
            "        re_path(fr'^android_dynamic/{checksum_regex}$',",
            "                dz.dynamic_analyzer,",
            "                name='dynamic_analyzer'),",
            "        re_path(r'^httptools$',",
            "                dz.httptools_start,",
            "                name='httptools'),",
            "        re_path(r'^logcat/$', dz.logcat),",
            "        re_path(fr'^static_scan/{checksum_regex}$',",
            "                dz.trigger_static_analysis,",
            "                name='static_scan'),",
            "        # Android Operations",
            "        re_path(r'^run_apk/$', operations.run_apk),",
            "        re_path(r'^mobsfy/$', operations.mobsfy, name='mobsfy'),",
            "        re_path(r'^screenshot/$', operations.take_screenshot),",
            "        re_path(r'^execute_adb/$', operations.execute_adb),",
            "        re_path(r'^screen_cast/$',",
            "                operations.screen_cast,",
            "                name='screen_cast'),",
            "        re_path(r'^touch_events/$',",
            "                operations.touch,",
            "                name='android_touch'),",
            "        re_path(r'^get_component/$', operations.get_component),",
            "        re_path(r'^mobsf_ca/$', operations.mobsf_ca),",
            "        re_path(r'^global_proxy/$', operations.global_proxy),",
            "        # Dynamic Tests",
            "        re_path(r'^activity_tester/$', tests_common.activity_tester),",
            "        re_path(r'^start_activity/$',",
            "                tests_common.start_activity,",
            "                name='start_activity'),",
            "        re_path(r'^start_deeplink/$',",
            "                tests_common.start_deeplink,",
            "                name='start_deeplink'),",
            "        re_path(r'^download_data/$', tests_common.download_data),",
            "        re_path(r'^collect_logs/$', tests_common.collect_logs),",
            "        re_path(r'^tls_tests/$', tests_common.tls_tests),",
            "        # Frida",
            "        re_path(r'^frida_instrument/$',",
            "                tests_frida.instrument,",
            "                name='android_instrument'),",
            "        re_path(r'^live_api/$',",
            "                tests_frida.live_api,",
            "                name='live_api'),",
            "        re_path(r'^frida_logs/$',",
            "                frida.frida_logs,",
            "                name='frida_logs'),",
            "        re_path(r'^get_dependencies/$', tests_frida.get_runtime_dependencies),",
            "        # Report",
            "        re_path(fr'^dynamic_report/{checksum_regex}$',",
            "                report.view_report,",
            "                name='dynamic_report'),",
            "        # Shared",
            "        re_path(r'^list_frida_scripts/$',",
            "                frida.list_frida_scripts,",
            "                name='list_frida_scripts'),",
            "        re_path(r'^get_script/$',",
            "                frida.get_script,",
            "                name='get_script'),",
            "        re_path(r'^dynamic_view_file/$',",
            "                device.view_file,",
            "                name='dynamic_view_file'),",
            "        # iOS Dynamic Analysis",
            "        re_path(r'^ios/dynamic_analysis/$',",
            "                idz.dynamic_analysis,",
            "                name='dynamic_ios'),",
            "        re_path(r'^ios/create_vm_instance/$',",
            "                instance.create_vm_instance,",
            "                name='create_vm_instance'),",
            "        re_path(r'^ios/get_supported_models/$',",
            "                instance.get_supported_models,",
            "                name='get_supported_models'),",
            "        re_path(r'^ios/get_supported_os/$',",
            "                instance.get_supported_os,",
            "                name='get_supported_os'),",
            "        re_path(r'^ios/start_instance/$',",
            "                instance.start_instance,",
            "                name='start_instance'),",
            "        re_path(r'^ios/stop_instance/$',",
            "                instance.stop_instance,",
            "                name='stop_instance'),",
            "        re_path(r'^ios/unpause_instance/$',",
            "                instance.unpause_instance,",
            "                name='unpause_instance'),",
            "        re_path(r'^ios/reboot_instance/$',",
            "                instance.reboot_instance,",
            "                name='reboot_instance'),",
            "        re_path(r'^ios/destroy_instance/$',",
            "                instance.destroy_instance,",
            "                name='destroy_instance'),",
            "        re_path(r'^ios/list_apps/$',",
            "                instance.list_apps,",
            "                name='list_apps'),",
            "        re_path(fr'^ios/setup_environment/{checksum_regex}$',",
            "                instance.setup_environment,",
            "                name='setup_environment'),",
            "        re_path(r'^ios/dynamic_analyzer/$',",
            "                idz.dynamic_analyzer,",
            "                name='dynamic_analyzer_ios'),",
            "        re_path(r'^ios/run_app/$',",
            "                instance.run_app,",
            "                name='run_app'),",
            "        re_path(r'^ios/remove_app/$',",
            "                instance.remove_app,",
            "                name='remove_app'),",
            "        re_path(r'^ios/take_screenshot/$',",
            "                instance.take_screenshot,",
            "                name='take_screenshot'),",
            "        re_path(r'^ios/network_capture/$',",
            "                instance.network_capture,",
            "                name='network_capture'),",
            "        re_path(r'^ios/live_pcap_download/$',",
            "                instance.live_pcap_download,",
            "                name='ios_live_pcap_download'),",
            "        re_path(r'^ios/ssh_execute/$',",
            "                instance.ssh_execute,",
            "                name='ssh_execute'),",
            "        re_path(r'^ios/upload_file/$',",
            "                instance.upload_file,",
            "                name='upload_file'),",
            "        re_path(r'^ios/download_file/$',",
            "                instance.download_file,",
            "                name='download_file'),",
            "        re_path(r'^ios/touch/$',",
            "                instance.touch,",
            "                name='ios_touch'),",
            "        re_path(r'^ios/get_container_path/$',",
            "                instance.get_container_path,",
            "                name='get_container_path'),",
            "        re_path(r'^ios/system_logs/$',",
            "                instance.system_logs,",
            "                name='ios_system_logs'),",
            "        re_path(fr'^ios/download_data/{bundle_id_regex}',",
            "                instance.download_data,",
            "                name='ios_download_data'),",
            "        re_path(r'^ios/instrument/$',",
            "                ios_tests_frida.ios_instrument,",
            "                name='ios_instrument'),",
            "        re_path(fr'^ios/view_report/{bundle_id_regex}',",
            "                ios_view_report.ios_view_report,",
            "                name='ios_view_report'),",
            "",
            "        # Test",
            "        re_path(r'^tests/$', tests.start_test),",
            "    ])",
            "",
            "utils.print_version()",
            "init_exec_hooks()",
            "store_exec_hashes_at_first_run()"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "55": [
                "bundle_id_regex"
            ]
        },
        "addLocation": []
    },
    "mobsf/StaticAnalyzer/views/android/views/source_tree.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": "     render,"
            },
            "1": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " )"
            },
            "2": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from mobsf.MobSF.init import api_key"
            },
            "4": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from mobsf.MobSF.utils import ("
            },
            "5": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 14,
                "PatchRowcode": "     is_md5,"
            },
            "6": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 15,
                "PatchRowcode": "     print_n_send_error_response,"
            },
            "7": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "             'hash': md5,"
            },
            "8": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "             'source_type': typ,"
            },
            "9": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "             'version': settings.MOBSF_VER,"
            },
            "10": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            'api_key': api_key(settings.MOBSF_HOME),"
            },
            "11": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "         }"
            },
            "12": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "         template = 'static_analysis/source_tree.html'"
            },
            "13": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "         return render(request, template, context)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"List all java files.\"\"\"",
            "",
            "import logging",
            "from pathlib import Path",
            "",
            "from django.conf import settings",
            "from django.shortcuts import (",
            "    loader,",
            "    render,",
            ")",
            "",
            "from mobsf.MobSF.init import api_key",
            "from mobsf.MobSF.utils import (",
            "    is_md5,",
            "    print_n_send_error_response,",
            ")",
            "from mobsf.StaticAnalyzer.views.common.shared_func import (",
            "    find_java_source_folder,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "# Generator that uses 2 template files in order to make the main template",
            "def tree_index_maker(root_dir: Path, original_root_dir_len: int):",
            "    def _index(root, root_len):",
            "        for mfile in root.iterdir():",
            "            if mfile.is_dir():",
            "                yield loader.render_to_string(",
            "                    'static_analysis/treeview_folder.html',",
            "                    {'file': mfile.name,",
            "                     'subfiles': _index(mfile, root_len)},",
            "                )",
            "                continue",
            "            yield loader.render_to_string(",
            "                'static_analysis/treeview_file.html',",
            "                {'file': mfile.name,",
            "                 'path': mfile.as_posix()[root_len + 1: -len(mfile.name)]},",
            "            )",
            "    return _index(root_dir, original_root_dir_len)",
            "",
            "",
            "@login_required",
            "def run(request):",
            "    \"\"\"Source Tree - Java/Smali view.\"\"\"",
            "    try:",
            "        logger.info('Listing Source files')",
            "        if not is_md5(request.GET['md5']):",
            "            return print_n_send_error_response(request, 'Scan hash not found')",
            "        md5 = request.GET['md5']",
            "        typ = request.GET['type']",
            "        base = Path(settings.UPLD_DIR) / md5",
            "        if typ == 'smali':",
            "            src = base / 'smali_source'",
            "        else:",
            "            try:",
            "                src = find_java_source_folder(base)[0]",
            "            except StopIteration:",
            "                return print_n_send_error_response(",
            "                    request,",
            "                    'Invalid Directory Structure')",
            "",
            "        tree_index = tree_index_maker(src, len(src.as_posix()))",
            "        context = {",
            "            'subfiles': tree_index,",
            "            'title': f'{typ.capitalize()} Source',",
            "            'hash': md5,",
            "            'source_type': typ,",
            "            'version': settings.MOBSF_VER,",
            "            'api_key': api_key(settings.MOBSF_HOME),",
            "        }",
            "        template = 'static_analysis/source_tree.html'",
            "        return render(request, template, context)",
            "    except Exception:",
            "        logger.exception('Getting Source Files')",
            "        return print_n_send_error_response(",
            "            request,",
            "            'Error Getting Source Files')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"List all java files.\"\"\"",
            "",
            "import logging",
            "from pathlib import Path",
            "",
            "from django.conf import settings",
            "from django.shortcuts import (",
            "    loader,",
            "    render,",
            ")",
            "",
            "from mobsf.MobSF.utils import (",
            "    is_md5,",
            "    print_n_send_error_response,",
            ")",
            "from mobsf.StaticAnalyzer.views.common.shared_func import (",
            "    find_java_source_folder,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "# Generator that uses 2 template files in order to make the main template",
            "def tree_index_maker(root_dir: Path, original_root_dir_len: int):",
            "    def _index(root, root_len):",
            "        for mfile in root.iterdir():",
            "            if mfile.is_dir():",
            "                yield loader.render_to_string(",
            "                    'static_analysis/treeview_folder.html',",
            "                    {'file': mfile.name,",
            "                     'subfiles': _index(mfile, root_len)},",
            "                )",
            "                continue",
            "            yield loader.render_to_string(",
            "                'static_analysis/treeview_file.html',",
            "                {'file': mfile.name,",
            "                 'path': mfile.as_posix()[root_len + 1: -len(mfile.name)]},",
            "            )",
            "    return _index(root_dir, original_root_dir_len)",
            "",
            "",
            "@login_required",
            "def run(request):",
            "    \"\"\"Source Tree - Java/Smali view.\"\"\"",
            "    try:",
            "        logger.info('Listing Source files')",
            "        if not is_md5(request.GET['md5']):",
            "            return print_n_send_error_response(request, 'Scan hash not found')",
            "        md5 = request.GET['md5']",
            "        typ = request.GET['type']",
            "        base = Path(settings.UPLD_DIR) / md5",
            "        if typ == 'smali':",
            "            src = base / 'smali_source'",
            "        else:",
            "            try:",
            "                src = find_java_source_folder(base)[0]",
            "            except StopIteration:",
            "                return print_n_send_error_response(",
            "                    request,",
            "                    'Invalid Directory Structure')",
            "",
            "        tree_index = tree_index_maker(src, len(src.as_posix()))",
            "        context = {",
            "            'subfiles': tree_index,",
            "            'title': f'{typ.capitalize()} Source',",
            "            'hash': md5,",
            "            'source_type': typ,",
            "            'version': settings.MOBSF_VER,",
            "        }",
            "        template = 'static_analysis/source_tree.html'",
            "        return render(request, template, context)",
            "    except Exception:",
            "        logger.exception('Getting Source Files')",
            "        return print_n_send_error_response(",
            "            request,",
            "            'Error Getting Source Files')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "13": [],
            "74": [
                "run"
            ]
        },
        "addLocation": []
    },
    "mobsf/StaticAnalyzer/views/android/views/view_source.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " # -*- coding: utf_8 -*-"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " \"\"\"View Source of a file.\"\"\""
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import logging"
            },
            "4": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import ntpath"
            },
            "5": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from pathlib import Path"
            },
            "6": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from django.conf import settings"
            },
            "8": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from django.shortcuts import render"
            },
            "9": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from django.utils.html import escape"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+from django.http import JsonResponse"
            },
            "11": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " "
            },
            "12": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from mobsf.MobSF.forms import FormUtil"
            },
            "13": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from mobsf.MobSF.utils import ("
            },
            "14": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 28,
                "PatchRowcode": " logger = logging.getLogger(__name__)"
            },
            "15": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " "
            },
            "16": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+def send_json(data):"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+    return JsonResponse(data, safe=False)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+def send_error(request, err, api_mode, json_resp, exp=None):"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 36,
                "PatchRowcode": "+    \"\"\"Send error message as dict or JSON.\"\"\""
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+    if exp:"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+        res = print_n_send_error_response(request, err, api_mode, exp)"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+    else:"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+        res = print_n_send_error_response(request, err, api_mode)"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    if json_resp:"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+        return send_json(res)"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+    return res"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+"
            },
            "32": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 46,
                "PatchRowcode": " @login_required"
            },
            "33": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 47,
                "PatchRowcode": " def run(request, api=False):"
            },
            "34": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "     \"\"\"View the source of a file.\"\"\""
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+    json_resp = request.GET.get('json', '0') == '1'"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+    api_mode = api or json_resp"
            },
            "37": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "     try:"
            },
            "38": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "         logger.info('View Java Source File')"
            },
            "39": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "         exp = 'Error Description'"
            },
            "40": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "             viewsource_form = ViewSourceAndroidForm(request.GET)"
            },
            "41": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "         if not viewsource_form.is_valid():"
            },
            "42": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "             err = FormUtil.errors_message(viewsource_form)"
            },
            "43": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return print_n_send_error_response(request, err, api, exp)"
            },
            "44": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+            return send_error(request, err, api_mode, json_resp, exp)"
            },
            "46": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "         base = Path(settings.UPLD_DIR) / md5"
            },
            "47": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "         if typ == 'smali':"
            },
            "48": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "             src = base / 'smali_source'"
            },
            "49": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "                 src, syntax, _ = find_java_source_folder(base)"
            },
            "50": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "             except StopIteration:"
            },
            "51": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "                 msg = 'Invalid directory or file extension'"
            },
            "52": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                return print_n_send_error_response(request, msg, api)"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 76,
                "PatchRowcode": "+                return send_error(request, msg, api_mode, json_resp)"
            },
            "54": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 77,
                "PatchRowcode": " "
            },
            "55": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "         sfile = src / fil"
            },
            "56": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "         if not is_safe_path(src, sfile.as_posix()):"
            },
            "57": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "             msg = 'Path Traversal Detected!'"
            },
            "58": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return print_n_send_error_response(request, msg, api)"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+            return send_error(request, msg, api_mode, json_resp)"
            },
            "60": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "         context = {"
            },
            "61": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "             'title': escape(ntpath.basename(fil)),"
            },
            "62": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "             'file': escape(ntpath.basename(fil)),"
            },
            "63": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "             'version': settings.MOBSF_VER,"
            },
            "64": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "         }"
            },
            "65": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 90,
                "PatchRowcode": "         template = 'general/view.html'"
            },
            "66": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if api:"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+        if json_resp:"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+            return send_json(context)"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        if api_mode:"
            },
            "70": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "             return context"
            },
            "71": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         return render(request, template, context)"
            },
            "72": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "     except Exception as exp:"
            },
            "73": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "         logger.exception('Error Viewing Source')"
            },
            "74": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "         msg = str(exp)"
            },
            "75": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "         exp = exp.__doc__"
            },
            "76": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return print_n_send_error_response(request, msg, api, exp)"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+        return send_error(request, msg, api_mode, json_resp, exp)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"View Source of a file.\"\"\"",
            "",
            "import logging",
            "import ntpath",
            "from pathlib import Path",
            "",
            "from django.conf import settings",
            "from django.shortcuts import render",
            "from django.utils.html import escape",
            "",
            "from mobsf.MobSF.forms import FormUtil",
            "from mobsf.MobSF.utils import (",
            "    is_safe_path,",
            "    print_n_send_error_response,",
            ")",
            "from mobsf.StaticAnalyzer.views.common.shared_func import (",
            "    find_java_source_folder,",
            ")",
            "from mobsf.StaticAnalyzer.forms import (",
            "    ViewSourceAndroidApiForm,",
            "    ViewSourceAndroidForm,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "@login_required",
            "def run(request, api=False):",
            "    \"\"\"View the source of a file.\"\"\"",
            "    try:",
            "        logger.info('View Java Source File')",
            "        exp = 'Error Description'",
            "        if api:",
            "            fil = request.POST['file']",
            "            md5 = request.POST['hash']",
            "            typ = request.POST['type']",
            "            viewsource_form = ViewSourceAndroidApiForm(request.POST)",
            "        else:",
            "            fil = request.GET['file']",
            "            md5 = request.GET['md5']",
            "            typ = request.GET['type']",
            "            viewsource_form = ViewSourceAndroidForm(request.GET)",
            "        if not viewsource_form.is_valid():",
            "            err = FormUtil.errors_message(viewsource_form)",
            "            return print_n_send_error_response(request, err, api, exp)",
            "",
            "        base = Path(settings.UPLD_DIR) / md5",
            "        if typ == 'smali':",
            "            src = base / 'smali_source'",
            "            syntax = 'smali'",
            "        else:",
            "            try:",
            "                src, syntax, _ = find_java_source_folder(base)",
            "            except StopIteration:",
            "                msg = 'Invalid directory or file extension'",
            "                return print_n_send_error_response(request, msg, api)",
            "",
            "        sfile = src / fil",
            "        if not is_safe_path(src, sfile.as_posix()):",
            "            msg = 'Path Traversal Detected!'",
            "            return print_n_send_error_response(request, msg, api)",
            "        context = {",
            "            'title': escape(ntpath.basename(fil)),",
            "            'file': escape(ntpath.basename(fil)),",
            "            'data': sfile.read_text('utf-8', 'ignore'),",
            "            'type': syntax,",
            "            'sqlite': {},",
            "            'version': settings.MOBSF_VER,",
            "        }",
            "        template = 'general/view.html'",
            "        if api:",
            "            return context",
            "        return render(request, template, context)",
            "    except Exception as exp:",
            "        logger.exception('Error Viewing Source')",
            "        msg = str(exp)",
            "        exp = exp.__doc__",
            "        return print_n_send_error_response(request, msg, api, exp)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf_8 -*-",
            "\"\"\"View Source of a file.\"\"\"",
            "import logging",
            "import ntpath",
            "from pathlib import Path",
            "",
            "from django.conf import settings",
            "from django.shortcuts import render",
            "from django.utils.html import escape",
            "from django.http import JsonResponse",
            "",
            "from mobsf.MobSF.forms import FormUtil",
            "from mobsf.MobSF.utils import (",
            "    is_safe_path,",
            "    print_n_send_error_response,",
            ")",
            "from mobsf.StaticAnalyzer.views.common.shared_func import (",
            "    find_java_source_folder,",
            ")",
            "from mobsf.StaticAnalyzer.forms import (",
            "    ViewSourceAndroidApiForm,",
            "    ViewSourceAndroidForm,",
            ")",
            "from mobsf.MobSF.views.authentication import (",
            "    login_required,",
            ")",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def send_json(data):",
            "    return JsonResponse(data, safe=False)",
            "",
            "",
            "def send_error(request, err, api_mode, json_resp, exp=None):",
            "    \"\"\"Send error message as dict or JSON.\"\"\"",
            "    if exp:",
            "        res = print_n_send_error_response(request, err, api_mode, exp)",
            "    else:",
            "        res = print_n_send_error_response(request, err, api_mode)",
            "    if json_resp:",
            "        return send_json(res)",
            "    return res",
            "",
            "",
            "@login_required",
            "def run(request, api=False):",
            "    \"\"\"View the source of a file.\"\"\"",
            "    json_resp = request.GET.get('json', '0') == '1'",
            "    api_mode = api or json_resp",
            "    try:",
            "        logger.info('View Java Source File')",
            "        exp = 'Error Description'",
            "        if api:",
            "            fil = request.POST['file']",
            "            md5 = request.POST['hash']",
            "            typ = request.POST['type']",
            "            viewsource_form = ViewSourceAndroidApiForm(request.POST)",
            "        else:",
            "            fil = request.GET['file']",
            "            md5 = request.GET['md5']",
            "            typ = request.GET['type']",
            "            viewsource_form = ViewSourceAndroidForm(request.GET)",
            "        if not viewsource_form.is_valid():",
            "            err = FormUtil.errors_message(viewsource_form)",
            "            return send_error(request, err, api_mode, json_resp, exp)",
            "        base = Path(settings.UPLD_DIR) / md5",
            "        if typ == 'smali':",
            "            src = base / 'smali_source'",
            "            syntax = 'smali'",
            "        else:",
            "            try:",
            "                src, syntax, _ = find_java_source_folder(base)",
            "            except StopIteration:",
            "                msg = 'Invalid directory or file extension'",
            "                return send_error(request, msg, api_mode, json_resp)",
            "",
            "        sfile = src / fil",
            "        if not is_safe_path(src, sfile.as_posix()):",
            "            msg = 'Path Traversal Detected!'",
            "            return send_error(request, msg, api_mode, json_resp)",
            "        context = {",
            "            'title': escape(ntpath.basename(fil)),",
            "            'file': escape(ntpath.basename(fil)),",
            "            'data': sfile.read_text('utf-8', 'ignore'),",
            "            'type': syntax,",
            "            'sqlite': {},",
            "            'version': settings.MOBSF_VER,",
            "        }",
            "        template = 'general/view.html'",
            "        if json_resp:",
            "            return send_json(context)",
            "        if api_mode:",
            "            return context",
            "        return render(request, template, context)",
            "    except Exception as exp:",
            "        logger.exception('Error Viewing Source')",
            "        msg = str(exp)",
            "        exp = exp.__doc__",
            "        return send_error(request, msg, api_mode, json_resp, exp)"
        ],
        "action": [
            "0",
            "0",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "3": [],
            "49": [
                "run"
            ],
            "50": [
                "run"
            ],
            "60": [
                "run"
            ],
            "65": [
                "run"
            ],
            "75": [
                "run"
            ],
            "82": [
                "run"
            ]
        },
        "addLocation": []
    }
}