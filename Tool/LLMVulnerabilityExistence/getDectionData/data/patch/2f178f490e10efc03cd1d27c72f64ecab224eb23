{
    "webapp/graphite/dashboard/views.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from graphite.render.views import renderView"
            },
            "1": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from graphite.util import json"
            },
            "2": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from graphite.user_util import isAuthenticated"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+from graphite.errors import handleInputParameterError, str_param"
            },
            "4": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " fieldRegex = re.compile(r'<([^>]+)>')"
            },
            "6": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " defaultScheme = {"
            },
            "7": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": 109,
                "PatchRowcode": " config = DashboardConfig()"
            },
            "8": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": 110,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": 111,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "11": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 113,
                "PatchRowcode": " def dashboard(request, name=None):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "13": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 115,
                "PatchRowcode": "   dashboard_conf_missing = False"
            },
            "14": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 116,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "   try:"
            },
            "16": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": 158,
                "PatchRowcode": "   return render(request, \"dashboard.html\", context)"
            },
            "17": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 159,
                "PatchRowcode": " "
            },
            "18": {
                "beforePatchRowNumber": 157,
                "afterPatchRowNumber": 160,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "20": {
                "beforePatchRowNumber": 158,
                "afterPatchRowNumber": 162,
                "PatchRowcode": " def template(request, name, val):"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "22": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": 164,
                "PatchRowcode": "   template_conf_missing = False"
            },
            "23": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 165,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "   try:"
            },
            "25": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": 226,
                "PatchRowcode": "   return permissions"
            },
            "26": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": 227,
                "PatchRowcode": " "
            },
            "27": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": 228,
                "PatchRowcode": " "
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 229,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "29": {
                "beforePatchRowNumber": 224,
                "afterPatchRowNumber": 230,
                "PatchRowcode": " def save(request, name):"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 231,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 232,
                "PatchRowcode": "+"
            },
            "32": {
                "beforePatchRowNumber": 225,
                "afterPatchRowNumber": 233,
                "PatchRowcode": "   if 'change' not in getPermissions(request.user):"
            },
            "33": {
                "beforePatchRowNumber": 226,
                "afterPatchRowNumber": 234,
                "PatchRowcode": "     return json_response( dict(error=\"Must be logged in with appropriate permissions to save\") )"
            },
            "34": {
                "beforePatchRowNumber": 227,
                "afterPatchRowNumber": 235,
                "PatchRowcode": "   # Deserialize and reserialize as a validation step"
            },
            "35": {
                "beforePatchRowNumber": 238,
                "afterPatchRowNumber": 246,
                "PatchRowcode": "   return json_response( dict(success=True) )"
            },
            "36": {
                "beforePatchRowNumber": 239,
                "afterPatchRowNumber": 247,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": 240,
                "afterPatchRowNumber": 248,
                "PatchRowcode": " "
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 249,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "39": {
                "beforePatchRowNumber": 241,
                "afterPatchRowNumber": 250,
                "PatchRowcode": " def save_template(request, name, key):"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+  key = str_param('key', key)"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+"
            },
            "43": {
                "beforePatchRowNumber": 242,
                "afterPatchRowNumber": 254,
                "PatchRowcode": "   if 'change' not in getPermissions(request.user):"
            },
            "44": {
                "beforePatchRowNumber": 243,
                "afterPatchRowNumber": 255,
                "PatchRowcode": "     return json_response( dict(error=\"Must be logged in with appropriate permissions to save the template\") )"
            },
            "45": {
                "beforePatchRowNumber": 244,
                "afterPatchRowNumber": 256,
                "PatchRowcode": "   # Deserialize and reserialize as a validation step"
            },
            "46": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": 269,
                "PatchRowcode": "   return json_response( dict(success=True) )"
            },
            "47": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": 270,
                "PatchRowcode": " "
            },
            "48": {
                "beforePatchRowNumber": 259,
                "afterPatchRowNumber": 271,
                "PatchRowcode": " "
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 272,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "50": {
                "beforePatchRowNumber": 260,
                "afterPatchRowNumber": 273,
                "PatchRowcode": " def load(request, name):"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 274,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "52": {
                "beforePatchRowNumber": 261,
                "afterPatchRowNumber": 275,
                "PatchRowcode": "   try:"
            },
            "53": {
                "beforePatchRowNumber": 262,
                "afterPatchRowNumber": 276,
                "PatchRowcode": "     dashboard = Dashboard.objects.get(name=name)"
            },
            "54": {
                "beforePatchRowNumber": 263,
                "afterPatchRowNumber": 277,
                "PatchRowcode": "   except Dashboard.DoesNotExist:"
            },
            "55": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": 280,
                "PatchRowcode": "   return json_response( dict(state=json.loads(dashboard.state)) )"
            },
            "56": {
                "beforePatchRowNumber": 267,
                "afterPatchRowNumber": 281,
                "PatchRowcode": " "
            },
            "57": {
                "beforePatchRowNumber": 268,
                "afterPatchRowNumber": 282,
                "PatchRowcode": " "
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 283,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "59": {
                "beforePatchRowNumber": 269,
                "afterPatchRowNumber": 284,
                "PatchRowcode": " def load_template(request, name, val):"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 285,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "61": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 286,
                "PatchRowcode": "   try:"
            },
            "62": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": 287,
                "PatchRowcode": "     template = Template.objects.get(name=name)"
            },
            "63": {
                "beforePatchRowNumber": 272,
                "afterPatchRowNumber": 288,
                "PatchRowcode": "   except Template.DoesNotExist:"
            },
            "64": {
                "beforePatchRowNumber": 277,
                "afterPatchRowNumber": 293,
                "PatchRowcode": "   return json_response( dict(state=state) )"
            },
            "65": {
                "beforePatchRowNumber": 278,
                "afterPatchRowNumber": 294,
                "PatchRowcode": " "
            },
            "66": {
                "beforePatchRowNumber": 279,
                "afterPatchRowNumber": 295,
                "PatchRowcode": " "
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 296,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "68": {
                "beforePatchRowNumber": 280,
                "afterPatchRowNumber": 297,
                "PatchRowcode": " def delete(request, name):"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 298,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "70": {
                "beforePatchRowNumber": 281,
                "afterPatchRowNumber": 299,
                "PatchRowcode": "   if 'delete' not in getPermissions(request.user):"
            },
            "71": {
                "beforePatchRowNumber": 282,
                "afterPatchRowNumber": 300,
                "PatchRowcode": "     return json_response( dict(error=\"Must be logged in with appropriate permissions to delete\") )"
            },
            "72": {
                "beforePatchRowNumber": 283,
                "afterPatchRowNumber": 301,
                "PatchRowcode": " "
            },
            "73": {
                "beforePatchRowNumber": 290,
                "afterPatchRowNumber": 308,
                "PatchRowcode": "     return json_response( dict(success=True) )"
            },
            "74": {
                "beforePatchRowNumber": 291,
                "afterPatchRowNumber": 309,
                "PatchRowcode": " "
            },
            "75": {
                "beforePatchRowNumber": 292,
                "afterPatchRowNumber": 310,
                "PatchRowcode": " "
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 311,
                "PatchRowcode": "+@handleInputParameterError"
            },
            "77": {
                "beforePatchRowNumber": 293,
                "afterPatchRowNumber": 312,
                "PatchRowcode": " def delete_template(request, name):"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 313,
                "PatchRowcode": "+  name = str_param('name', name)"
            },
            "79": {
                "beforePatchRowNumber": 294,
                "afterPatchRowNumber": 314,
                "PatchRowcode": "   if 'delete' not in getPermissions(request.user):"
            },
            "80": {
                "beforePatchRowNumber": 295,
                "afterPatchRowNumber": 315,
                "PatchRowcode": "     return json_response( dict(error=\"Must be logged in with appropriate permissions to delete the template\") )"
            },
            "81": {
                "beforePatchRowNumber": 296,
                "afterPatchRowNumber": 316,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "import re",
            "import errno",
            "",
            "from os.path import getmtime",
            "from six.moves.urllib.parse import urlencode",
            "from six.moves.configparser import ConfigParser",
            "from django.shortcuts import render",
            "from django.http import QueryDict",
            "from django.conf import settings",
            "from django.contrib.auth import login, authenticate, logout",
            "from django.contrib.staticfiles import finders",
            "from django.utils.safestring import mark_safe",
            "from graphite.compat import HttpResponse",
            "from graphite.dashboard.models import Dashboard, Template",
            "from graphite.dashboard.send_graph import send_graph_email",
            "from graphite.render.views import renderView",
            "from graphite.util import json",
            "from graphite.user_util import isAuthenticated",
            "",
            "fieldRegex = re.compile(r'<([^>]+)>')",
            "defaultScheme = {",
            "  'name' : 'Everything',",
            "  'pattern' : '<category>',",
            "  'fields' : [ dict(name='category', label='Category') ],",
            "}",
            "defaultUIConfig = {",
            "  'default_graph_width'  : 400,",
            "  'default_graph_height' : 250,",
            "  'refresh_interval'     :  60,",
            "  'autocomplete_delay'   : 375,",
            "  'merge_hover_delay'    : 700,",
            "  'theme'                : 'default',",
            "}",
            "defaultKeyboardShortcuts = {",
            "  'toggle_toolbar' : 'ctrl-z',",
            "  'toggle_metrics_panel' : 'ctrl-space',",
            "  'erase_all_graphs' : 'alt-x',",
            "  'save_dashboard' : 'alt-s',",
            "  'completer_add_metrics' : 'alt-enter',",
            "  'completer_del_metrics' : 'alt-backspace',",
            "  'give_completer_focus' : 'shift-space',",
            "}",
            "",
            "ALL_PERMISSIONS = ['change', 'delete']",
            "",
            "",
            "class DashboardConfig:",
            "  def __init__(self):",
            "    self.last_read = 0",
            "    self.schemes = [defaultScheme]",
            "    self.ui_config = defaultUIConfig.copy()",
            "",
            "  def check(self):",
            "    if getmtime(settings.DASHBOARD_CONF) > self.last_read:",
            "      self.load()",
            "",
            "  def load(self):",
            "    schemes = [defaultScheme]",
            "    parser = ConfigParser()",
            "    parser.read(settings.DASHBOARD_CONF)",
            "",
            "    for option, default_value in defaultUIConfig.items():",
            "      if parser.has_option('ui', option):",
            "        try:",
            "          self.ui_config[option] = parser.getint('ui', option)",
            "        except ValueError:",
            "          self.ui_config[option] = parser.get('ui', option)",
            "      else:",
            "        self.ui_config[option] = default_value",
            "",
            "    if parser.has_option('ui', 'automatic_variants'):",
            "      self.ui_config['automatic_variants']   = parser.getboolean('ui', 'automatic_variants')",
            "    else:",
            "      self.ui_config['automatic_variants'] = True",
            "",
            "    self.ui_config['keyboard_shortcuts'] = defaultKeyboardShortcuts.copy()",
            "    if parser.has_section('keyboard-shortcuts'):",
            "      self.ui_config['keyboard_shortcuts'].update( parser.items('keyboard-shortcuts') )",
            "",
            "    for section in parser.sections():",
            "      if section in ('ui', 'keyboard-shortcuts'):",
            "        continue",
            "",
            "      scheme = parser.get(section, 'scheme')",
            "      fields = []",
            "",
            "      for match in fieldRegex.finditer(scheme):",
            "        field = match.group(1)",
            "        if parser.has_option(section, '%s.label' % field):",
            "          label = parser.get(section, '%s.label' % field)",
            "        else:",
            "          label = field",
            "",
            "        fields.append({",
            "          'name' : field,",
            "          'label' : label",
            "        })",
            "",
            "      schemes.append({",
            "        'name' : section,",
            "        'pattern' : scheme,",
            "        'fields' : fields,",
            "      })",
            "",
            "    self.schemes = schemes",
            "",
            "",
            "config = DashboardConfig()",
            "",
            "",
            "def dashboard(request, name=None):",
            "  dashboard_conf_missing = False",
            "",
            "  try:",
            "    config.check()",
            "  except OSError as e:",
            "    if e.errno == errno.ENOENT:",
            "      dashboard_conf_missing = True",
            "    else:",
            "      raise",
            "",
            "  initialError = None",
            "  debug = request.GET.get('debug', False)",
            "  theme = request.GET.get('theme', config.ui_config['theme'])",
            "  css_file = finders.find('css/dashboard-%s.css' % theme)",
            "  if css_file is None:",
            "    initialError = \"Invalid theme '%s'\" % theme",
            "    theme = config.ui_config['theme']",
            "",
            "  context = {",
            "    'schemes_json': mark_safe(json.dumps(config.schemes)),",
            "    'ui_config_json': mark_safe(json.dumps(config.ui_config)),",
            "    'jsdebug': debug or settings.JAVASCRIPT_DEBUG,",
            "    'debug': debug,",
            "    'theme': theme,",
            "    'initialError': initialError,",
            "    'querystring': mark_safe(json.dumps(dict(request.GET.items()))),",
            "    'dashboard_conf_missing': dashboard_conf_missing,",
            "    'userName': '',",
            "    'permissions': mark_safe(json.dumps(getPermissions(request.user))),",
            "    'permissionsUnauthenticated': mark_safe(json.dumps(getPermissions(None)))",
            "  }",
            "  user = request.user",
            "  if user:",
            "      context['userName'] = user.username",
            "",
            "  if name is not None:",
            "    try:",
            "      dashboard = Dashboard.objects.get(name=name)",
            "    except Dashboard.DoesNotExist:",
            "      context['initialError'] = \"Dashboard '%s' does not exist.\" % name",
            "    else:",
            "      context['initialState'] = dashboard.state",
            "",
            "  return render(request, \"dashboard.html\", context)",
            "",
            "",
            "def template(request, name, val):",
            "  template_conf_missing = False",
            "",
            "  try:",
            "    config.check()",
            "  except OSError as e:",
            "    if e.errno == errno.ENOENT:",
            "      template_conf_missing = True",
            "    else:",
            "      raise",
            "",
            "  initialError = None",
            "  debug = request.GET.get('debug', False)",
            "  theme = request.GET.get('theme', config.ui_config['theme'])",
            "  css_file = finders.find('css/dashboard-%s.css' % theme)",
            "  if css_file is None:",
            "    initialError = \"Invalid theme '%s'\" % theme",
            "    theme = config.ui_config['theme']",
            "",
            "  context = {",
            "    'schemes_json' : json.dumps(config.schemes),",
            "    'ui_config_json' : json.dumps(config.ui_config),",
            "    'jsdebug' : debug or settings.JAVASCRIPT_DEBUG,",
            "    'debug' : debug,",
            "    'theme' : theme,",
            "    'initialError' : initialError,",
            "    'querystring' : json.dumps( dict( request.GET.items() ) ),",
            "    'template_conf_missing' : template_conf_missing,",
            "    'userName': '',",
            "    'permissions': json.dumps(getPermissions(request.user)),",
            "    'permissionsUnauthenticated': json.dumps(getPermissions(None))",
            "  }",
            "",
            "  user = request.user",
            "  if user:",
            "      context['userName'] = user.username",
            "",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    context['initialError'] = \"Template '%s' does not exist.\" % name",
            "  else:",
            "    state = json.loads(template.loadState(val))",
            "    state['name'] = '%s/%s' % (name, val)",
            "    context['initialState'] = json.dumps(state)",
            "  return render(request, \"dashboard.html\", context)",
            "",
            "",
            "def getPermissions(user):",
            "  \"\"\"Return [change, delete] based on authorisation model and user privileges/groups\"\"\"",
            "  if user and not isAuthenticated(user):",
            "    user = None",
            "  if not settings.DASHBOARD_REQUIRE_AUTHENTICATION:",
            "    return ALL_PERMISSIONS      # don't require login",
            "  if not user:",
            "      return []",
            "  # from here on, we have a user",
            "  permissions = ALL_PERMISSIONS",
            "  if settings.DASHBOARD_REQUIRE_PERMISSIONS:",
            "    permissions = [permission for permission in ALL_PERMISSIONS if user.has_perm('dashboard.%s_dashboard' % permission)]",
            "  editGroup = settings.DASHBOARD_REQUIRE_EDIT_GROUP",
            "  if editGroup and len(user.groups.filter(name = editGroup)) == 0:",
            "    permissions = []",
            "  return permissions",
            "",
            "",
            "def save(request, name):",
            "  if 'change' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to save\") )",
            "  # Deserialize and reserialize as a validation step",
            "  state = str( json.dumps( json.loads( request.POST['state'] ) ) )",
            "",
            "  try:",
            "    dashboard = Dashboard.objects.get(name=name)",
            "  except Dashboard.DoesNotExist:",
            "    dashboard = Dashboard.objects.create(name=name, state=state)",
            "  else:",
            "    dashboard.state = state",
            "    dashboard.save()",
            "",
            "  return json_response( dict(success=True) )",
            "",
            "",
            "def save_template(request, name, key):",
            "  if 'change' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to save the template\") )",
            "  # Deserialize and reserialize as a validation step",
            "  state = str( json.dumps( json.loads( request.POST['state'] ) ) )",
            "",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    template = Template.objects.create(name=name)",
            "    template.setState(state, key)",
            "    template.save()",
            "  else:",
            "    template.setState(state, key)",
            "    template.save()",
            "",
            "  return json_response( dict(success=True) )",
            "",
            "",
            "def load(request, name):",
            "  try:",
            "    dashboard = Dashboard.objects.get(name=name)",
            "  except Dashboard.DoesNotExist:",
            "    return json_response( dict(error=\"Dashboard '%s' does not exist. \" % name) )",
            "",
            "  return json_response( dict(state=json.loads(dashboard.state)) )",
            "",
            "",
            "def load_template(request, name, val):",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    return json_response( dict(error=\"Template '%s' does not exist. \" % name) )",
            "",
            "  state = json.loads(template.loadState(val))",
            "  state['name'] = '%s/%s' % (name, val)",
            "  return json_response( dict(state=state) )",
            "",
            "",
            "def delete(request, name):",
            "  if 'delete' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to delete\") )",
            "",
            "  try:",
            "    dashboard = Dashboard.objects.get(name=name)",
            "  except Dashboard.DoesNotExist:",
            "    return json_response( dict(error=\"Dashboard '%s' does not exist. \" % name) )",
            "  else:",
            "    dashboard.delete()",
            "    return json_response( dict(success=True) )",
            "",
            "",
            "def delete_template(request, name):",
            "  if 'delete' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to delete the template\") )",
            "",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    return json_response( dict(error=\"Template '%s' does not exist. \" % name) )",
            "  else:",
            "    template.delete()",
            "    return json_response( dict(success=True) )",
            "",
            "",
            "def find(request):",
            "  queryParams = request.GET.copy()",
            "  queryParams.update(request.POST)",
            "",
            "  query = queryParams.get('query', False)",
            "  query_terms = set( query.lower().split() )",
            "  results = []",
            "",
            "  # Find all dashboard names that contain each of our query terms as a substring",
            "  for dashboard_name in Dashboard.objects.order_by('name').values_list('name', flat=True):",
            "    name = dashboard_name.lower()",
            "",
            "    if name.startswith('temporary-'):",
            "      continue",
            "",
            "    found = True # blank queries return everything",
            "    for term in query_terms:",
            "      if term in name:",
            "        found = True",
            "      else:",
            "        found = False",
            "        break",
            "",
            "    if found:",
            "      results.append( dict(name=dashboard_name) )",
            "",
            "  return json_response( dict(dashboards=results) )",
            "",
            "",
            "def find_template(request):",
            "  queryParams = request.GET.copy()",
            "  queryParams.update(request.POST)",
            "",
            "  query = queryParams.get('query', False)",
            "  query_terms = set( query.lower().split() )",
            "  results = []",
            "",
            "  # Find all dashboard names that contain each of our query terms as a substring",
            "  for template in Template.objects.all():",
            "    name = template.name.lower()",
            "",
            "    found = True # blank queries return everything",
            "    for term in query_terms:",
            "      if term in name:",
            "        found = True",
            "      else:",
            "        found = False",
            "        break",
            "",
            "    if found:",
            "      results.append( dict(name=template.name) )",
            "",
            "  return json_response( dict(templates=results) )",
            "",
            "",
            "def help(request):",
            "  context = {}",
            "  return render(request, \"dashboardHelp.html\", context)",
            "",
            "",
            "def email(request):",
            "    sender = request.POST['sender']",
            "    recipients = request.POST['recipients'].split()",
            "    subject = request.POST['subject']",
            "    message = request.POST['message']",
            "",
            "    # these need to be passed to the render function in an HTTP request.",
            "    graph_params = json.loads(request.POST['graph_params'], parse_int=str)",
            "    target = QueryDict(urlencode({'target': graph_params.pop('target')}))",
            "    graph_params = QueryDict(urlencode(graph_params))",
            "",
            "    new_post = request.POST.copy()",
            "    new_post.update(graph_params)",
            "    new_post.update(target)",
            "    request.POST = new_post",
            "",
            "    resp = renderView(request)",
            "    img = resp.content",
            "",
            "    if img:",
            "        attachments = [('graph.png', img, 'image/png')]",
            "        send_graph_email(subject, sender, recipients, attachments, message)",
            "",
            "    return json_response(dict(success=True))",
            "",
            "",
            "def create_temporary(request):",
            "  state = str( json.dumps( json.loads( request.POST['state'] ) ) )",
            "  i = 0",
            "  while True:",
            "    name = \"temporary-%d\" % i",
            "    try:",
            "      Dashboard.objects.get(name=name)",
            "    except Dashboard.DoesNotExist:",
            "      dashboard = Dashboard.objects.create(name=name, state=state)",
            "      break",
            "    else:",
            "      i += 1",
            "",
            "  return json_response( dict(name=dashboard.name) )",
            "",
            "",
            "def json_response(obj):",
            "  return HttpResponse(content_type='application/json', content=json.dumps(obj))",
            "",
            "",
            "def user_login(request):",
            "  response = dict(errors={}, text={}, success=False, permissions=[])",
            "  user = authenticate(username=request.POST['username'],",
            "                      password=request.POST['password'])",
            "  if user is not None:",
            "    if user.is_active:",
            "      login(request, user)",
            "      response['success'] = True",
            "      response['permissions'].extend(getPermissions(user))",
            "    else:",
            "      response['errors']['reason'] = 'Account disabled.'",
            "  else:",
            "    response['errors']['reason'] = 'Username and/or password invalid.'",
            "  return json_response(response)",
            "",
            "",
            "def user_logout(request):",
            "  response = dict(errors={}, text={}, success=True)",
            "  logout(request)",
            "  return json_response(response)"
        ],
        "afterPatchFile": [
            "import re",
            "import errno",
            "",
            "from os.path import getmtime",
            "from six.moves.urllib.parse import urlencode",
            "from six.moves.configparser import ConfigParser",
            "from django.shortcuts import render",
            "from django.http import QueryDict",
            "from django.conf import settings",
            "from django.contrib.auth import login, authenticate, logout",
            "from django.contrib.staticfiles import finders",
            "from django.utils.safestring import mark_safe",
            "from graphite.compat import HttpResponse",
            "from graphite.dashboard.models import Dashboard, Template",
            "from graphite.dashboard.send_graph import send_graph_email",
            "from graphite.render.views import renderView",
            "from graphite.util import json",
            "from graphite.user_util import isAuthenticated",
            "from graphite.errors import handleInputParameterError, str_param",
            "",
            "fieldRegex = re.compile(r'<([^>]+)>')",
            "defaultScheme = {",
            "  'name' : 'Everything',",
            "  'pattern' : '<category>',",
            "  'fields' : [ dict(name='category', label='Category') ],",
            "}",
            "defaultUIConfig = {",
            "  'default_graph_width'  : 400,",
            "  'default_graph_height' : 250,",
            "  'refresh_interval'     :  60,",
            "  'autocomplete_delay'   : 375,",
            "  'merge_hover_delay'    : 700,",
            "  'theme'                : 'default',",
            "}",
            "defaultKeyboardShortcuts = {",
            "  'toggle_toolbar' : 'ctrl-z',",
            "  'toggle_metrics_panel' : 'ctrl-space',",
            "  'erase_all_graphs' : 'alt-x',",
            "  'save_dashboard' : 'alt-s',",
            "  'completer_add_metrics' : 'alt-enter',",
            "  'completer_del_metrics' : 'alt-backspace',",
            "  'give_completer_focus' : 'shift-space',",
            "}",
            "",
            "ALL_PERMISSIONS = ['change', 'delete']",
            "",
            "",
            "class DashboardConfig:",
            "  def __init__(self):",
            "    self.last_read = 0",
            "    self.schemes = [defaultScheme]",
            "    self.ui_config = defaultUIConfig.copy()",
            "",
            "  def check(self):",
            "    if getmtime(settings.DASHBOARD_CONF) > self.last_read:",
            "      self.load()",
            "",
            "  def load(self):",
            "    schemes = [defaultScheme]",
            "    parser = ConfigParser()",
            "    parser.read(settings.DASHBOARD_CONF)",
            "",
            "    for option, default_value in defaultUIConfig.items():",
            "      if parser.has_option('ui', option):",
            "        try:",
            "          self.ui_config[option] = parser.getint('ui', option)",
            "        except ValueError:",
            "          self.ui_config[option] = parser.get('ui', option)",
            "      else:",
            "        self.ui_config[option] = default_value",
            "",
            "    if parser.has_option('ui', 'automatic_variants'):",
            "      self.ui_config['automatic_variants']   = parser.getboolean('ui', 'automatic_variants')",
            "    else:",
            "      self.ui_config['automatic_variants'] = True",
            "",
            "    self.ui_config['keyboard_shortcuts'] = defaultKeyboardShortcuts.copy()",
            "    if parser.has_section('keyboard-shortcuts'):",
            "      self.ui_config['keyboard_shortcuts'].update( parser.items('keyboard-shortcuts') )",
            "",
            "    for section in parser.sections():",
            "      if section in ('ui', 'keyboard-shortcuts'):",
            "        continue",
            "",
            "      scheme = parser.get(section, 'scheme')",
            "      fields = []",
            "",
            "      for match in fieldRegex.finditer(scheme):",
            "        field = match.group(1)",
            "        if parser.has_option(section, '%s.label' % field):",
            "          label = parser.get(section, '%s.label' % field)",
            "        else:",
            "          label = field",
            "",
            "        fields.append({",
            "          'name' : field,",
            "          'label' : label",
            "        })",
            "",
            "      schemes.append({",
            "        'name' : section,",
            "        'pattern' : scheme,",
            "        'fields' : fields,",
            "      })",
            "",
            "    self.schemes = schemes",
            "",
            "",
            "config = DashboardConfig()",
            "",
            "",
            "@handleInputParameterError",
            "def dashboard(request, name=None):",
            "  name = str_param('name', name)",
            "  dashboard_conf_missing = False",
            "",
            "  try:",
            "    config.check()",
            "  except OSError as e:",
            "    if e.errno == errno.ENOENT:",
            "      dashboard_conf_missing = True",
            "    else:",
            "      raise",
            "",
            "  initialError = None",
            "  debug = request.GET.get('debug', False)",
            "  theme = request.GET.get('theme', config.ui_config['theme'])",
            "  css_file = finders.find('css/dashboard-%s.css' % theme)",
            "  if css_file is None:",
            "    initialError = \"Invalid theme '%s'\" % theme",
            "    theme = config.ui_config['theme']",
            "",
            "  context = {",
            "    'schemes_json': mark_safe(json.dumps(config.schemes)),",
            "    'ui_config_json': mark_safe(json.dumps(config.ui_config)),",
            "    'jsdebug': debug or settings.JAVASCRIPT_DEBUG,",
            "    'debug': debug,",
            "    'theme': theme,",
            "    'initialError': initialError,",
            "    'querystring': mark_safe(json.dumps(dict(request.GET.items()))),",
            "    'dashboard_conf_missing': dashboard_conf_missing,",
            "    'userName': '',",
            "    'permissions': mark_safe(json.dumps(getPermissions(request.user))),",
            "    'permissionsUnauthenticated': mark_safe(json.dumps(getPermissions(None)))",
            "  }",
            "  user = request.user",
            "  if user:",
            "      context['userName'] = user.username",
            "",
            "  if name is not None:",
            "    try:",
            "      dashboard = Dashboard.objects.get(name=name)",
            "    except Dashboard.DoesNotExist:",
            "      context['initialError'] = \"Dashboard '%s' does not exist.\" % name",
            "    else:",
            "      context['initialState'] = dashboard.state",
            "",
            "  return render(request, \"dashboard.html\", context)",
            "",
            "",
            "@handleInputParameterError",
            "def template(request, name, val):",
            "  name = str_param('name', name)",
            "  template_conf_missing = False",
            "",
            "  try:",
            "    config.check()",
            "  except OSError as e:",
            "    if e.errno == errno.ENOENT:",
            "      template_conf_missing = True",
            "    else:",
            "      raise",
            "",
            "  initialError = None",
            "  debug = request.GET.get('debug', False)",
            "  theme = request.GET.get('theme', config.ui_config['theme'])",
            "  css_file = finders.find('css/dashboard-%s.css' % theme)",
            "  if css_file is None:",
            "    initialError = \"Invalid theme '%s'\" % theme",
            "    theme = config.ui_config['theme']",
            "",
            "  context = {",
            "    'schemes_json' : json.dumps(config.schemes),",
            "    'ui_config_json' : json.dumps(config.ui_config),",
            "    'jsdebug' : debug or settings.JAVASCRIPT_DEBUG,",
            "    'debug' : debug,",
            "    'theme' : theme,",
            "    'initialError' : initialError,",
            "    'querystring' : json.dumps( dict( request.GET.items() ) ),",
            "    'template_conf_missing' : template_conf_missing,",
            "    'userName': '',",
            "    'permissions': json.dumps(getPermissions(request.user)),",
            "    'permissionsUnauthenticated': json.dumps(getPermissions(None))",
            "  }",
            "",
            "  user = request.user",
            "  if user:",
            "      context['userName'] = user.username",
            "",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    context['initialError'] = \"Template '%s' does not exist.\" % name",
            "  else:",
            "    state = json.loads(template.loadState(val))",
            "    state['name'] = '%s/%s' % (name, val)",
            "    context['initialState'] = json.dumps(state)",
            "  return render(request, \"dashboard.html\", context)",
            "",
            "",
            "def getPermissions(user):",
            "  \"\"\"Return [change, delete] based on authorisation model and user privileges/groups\"\"\"",
            "  if user and not isAuthenticated(user):",
            "    user = None",
            "  if not settings.DASHBOARD_REQUIRE_AUTHENTICATION:",
            "    return ALL_PERMISSIONS      # don't require login",
            "  if not user:",
            "      return []",
            "  # from here on, we have a user",
            "  permissions = ALL_PERMISSIONS",
            "  if settings.DASHBOARD_REQUIRE_PERMISSIONS:",
            "    permissions = [permission for permission in ALL_PERMISSIONS if user.has_perm('dashboard.%s_dashboard' % permission)]",
            "  editGroup = settings.DASHBOARD_REQUIRE_EDIT_GROUP",
            "  if editGroup and len(user.groups.filter(name = editGroup)) == 0:",
            "    permissions = []",
            "  return permissions",
            "",
            "",
            "@handleInputParameterError",
            "def save(request, name):",
            "  name = str_param('name', name)",
            "",
            "  if 'change' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to save\") )",
            "  # Deserialize and reserialize as a validation step",
            "  state = str( json.dumps( json.loads( request.POST['state'] ) ) )",
            "",
            "  try:",
            "    dashboard = Dashboard.objects.get(name=name)",
            "  except Dashboard.DoesNotExist:",
            "    dashboard = Dashboard.objects.create(name=name, state=state)",
            "  else:",
            "    dashboard.state = state",
            "    dashboard.save()",
            "",
            "  return json_response( dict(success=True) )",
            "",
            "",
            "@handleInputParameterError",
            "def save_template(request, name, key):",
            "  name = str_param('name', name)",
            "  key = str_param('key', key)",
            "",
            "  if 'change' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to save the template\") )",
            "  # Deserialize and reserialize as a validation step",
            "  state = str( json.dumps( json.loads( request.POST['state'] ) ) )",
            "",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    template = Template.objects.create(name=name)",
            "    template.setState(state, key)",
            "    template.save()",
            "  else:",
            "    template.setState(state, key)",
            "    template.save()",
            "",
            "  return json_response( dict(success=True) )",
            "",
            "",
            "@handleInputParameterError",
            "def load(request, name):",
            "  name = str_param('name', name)",
            "  try:",
            "    dashboard = Dashboard.objects.get(name=name)",
            "  except Dashboard.DoesNotExist:",
            "    return json_response( dict(error=\"Dashboard '%s' does not exist. \" % name) )",
            "",
            "  return json_response( dict(state=json.loads(dashboard.state)) )",
            "",
            "",
            "@handleInputParameterError",
            "def load_template(request, name, val):",
            "  name = str_param('name', name)",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    return json_response( dict(error=\"Template '%s' does not exist. \" % name) )",
            "",
            "  state = json.loads(template.loadState(val))",
            "  state['name'] = '%s/%s' % (name, val)",
            "  return json_response( dict(state=state) )",
            "",
            "",
            "@handleInputParameterError",
            "def delete(request, name):",
            "  name = str_param('name', name)",
            "  if 'delete' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to delete\") )",
            "",
            "  try:",
            "    dashboard = Dashboard.objects.get(name=name)",
            "  except Dashboard.DoesNotExist:",
            "    return json_response( dict(error=\"Dashboard '%s' does not exist. \" % name) )",
            "  else:",
            "    dashboard.delete()",
            "    return json_response( dict(success=True) )",
            "",
            "",
            "@handleInputParameterError",
            "def delete_template(request, name):",
            "  name = str_param('name', name)",
            "  if 'delete' not in getPermissions(request.user):",
            "    return json_response( dict(error=\"Must be logged in with appropriate permissions to delete the template\") )",
            "",
            "  try:",
            "    template = Template.objects.get(name=name)",
            "  except Template.DoesNotExist:",
            "    return json_response( dict(error=\"Template '%s' does not exist. \" % name) )",
            "  else:",
            "    template.delete()",
            "    return json_response( dict(success=True) )",
            "",
            "",
            "def find(request):",
            "  queryParams = request.GET.copy()",
            "  queryParams.update(request.POST)",
            "",
            "  query = queryParams.get('query', False)",
            "  query_terms = set( query.lower().split() )",
            "  results = []",
            "",
            "  # Find all dashboard names that contain each of our query terms as a substring",
            "  for dashboard_name in Dashboard.objects.order_by('name').values_list('name', flat=True):",
            "    name = dashboard_name.lower()",
            "",
            "    if name.startswith('temporary-'):",
            "      continue",
            "",
            "    found = True # blank queries return everything",
            "    for term in query_terms:",
            "      if term in name:",
            "        found = True",
            "      else:",
            "        found = False",
            "        break",
            "",
            "    if found:",
            "      results.append( dict(name=dashboard_name) )",
            "",
            "  return json_response( dict(dashboards=results) )",
            "",
            "",
            "def find_template(request):",
            "  queryParams = request.GET.copy()",
            "  queryParams.update(request.POST)",
            "",
            "  query = queryParams.get('query', False)",
            "  query_terms = set( query.lower().split() )",
            "  results = []",
            "",
            "  # Find all dashboard names that contain each of our query terms as a substring",
            "  for template in Template.objects.all():",
            "    name = template.name.lower()",
            "",
            "    found = True # blank queries return everything",
            "    for term in query_terms:",
            "      if term in name:",
            "        found = True",
            "      else:",
            "        found = False",
            "        break",
            "",
            "    if found:",
            "      results.append( dict(name=template.name) )",
            "",
            "  return json_response( dict(templates=results) )",
            "",
            "",
            "def help(request):",
            "  context = {}",
            "  return render(request, \"dashboardHelp.html\", context)",
            "",
            "",
            "def email(request):",
            "    sender = request.POST['sender']",
            "    recipients = request.POST['recipients'].split()",
            "    subject = request.POST['subject']",
            "    message = request.POST['message']",
            "",
            "    # these need to be passed to the render function in an HTTP request.",
            "    graph_params = json.loads(request.POST['graph_params'], parse_int=str)",
            "    target = QueryDict(urlencode({'target': graph_params.pop('target')}))",
            "    graph_params = QueryDict(urlencode(graph_params))",
            "",
            "    new_post = request.POST.copy()",
            "    new_post.update(graph_params)",
            "    new_post.update(target)",
            "    request.POST = new_post",
            "",
            "    resp = renderView(request)",
            "    img = resp.content",
            "",
            "    if img:",
            "        attachments = [('graph.png', img, 'image/png')]",
            "        send_graph_email(subject, sender, recipients, attachments, message)",
            "",
            "    return json_response(dict(success=True))",
            "",
            "",
            "def create_temporary(request):",
            "  state = str( json.dumps( json.loads( request.POST['state'] ) ) )",
            "  i = 0",
            "  while True:",
            "    name = \"temporary-%d\" % i",
            "    try:",
            "      Dashboard.objects.get(name=name)",
            "    except Dashboard.DoesNotExist:",
            "      dashboard = Dashboard.objects.create(name=name, state=state)",
            "      break",
            "    else:",
            "      i += 1",
            "",
            "  return json_response( dict(name=dashboard.name) )",
            "",
            "",
            "def json_response(obj):",
            "  return HttpResponse(content_type='application/json', content=json.dumps(obj))",
            "",
            "",
            "def user_login(request):",
            "  response = dict(errors={}, text={}, success=False, permissions=[])",
            "  user = authenticate(username=request.POST['username'],",
            "                      password=request.POST['password'])",
            "  if user is not None:",
            "    if user.is_active:",
            "      login(request, user)",
            "      response['success'] = True",
            "      response['permissions'].extend(getPermissions(user))",
            "    else:",
            "      response['errors']['reason'] = 'Account disabled.'",
            "  else:",
            "    response['errors']['reason'] = 'Username and/or password invalid.'",
            "  return json_response(response)",
            "",
            "",
            "def user_logout(request):",
            "  response = dict(errors={}, text={}, success=True)",
            "  logout(request)",
            "  return json_response(response)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "webapp.graphite.dashboard.views.template.context",
            "webapp.graphite.dashboard.views.dashboard.context",
            "flower.command"
        ]
    },
    "webapp/graphite/errors.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from django.http import HttpResponseBadRequest"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from graphite.logger import log"
            },
            "2": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 3,
                "PatchRowcode": "+from graphite.util import htmlEscape, is_unsafe_str"
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " "
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " class NormalizeEmptyResultError(Exception):"
            },
            "6": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         return msg"
            },
            "7": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 96,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 97,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-# Replace special characters \"&\", \"<\" and \">\" to HTML-safe sequences."
            },
            "10": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def escape(s):"
            },
            "11": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    s = s.replace(\"&\", \"&amp;\")  # Must be done first!"
            },
            "12": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    s = s.replace(\"<\", \"&lt;\")"
            },
            "13": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    s = s.replace(\">\", \"&gt;\")"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+def safe_param(name, s):"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+    if is_unsafe_str(s):"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+        raise InputParameterError(\"{} contain unsafe symbols\".format(name))"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+    return s"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+def is_unclean_str(s):"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+    for symbol in '&<>~!@#$%^*()`':"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+        if s.find(symbol) >= 0:"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+            return True"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+    return False"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 110,
                "PatchRowcode": " "
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+def str_param(name, s):"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+    if s is not None and is_unclean_str(s):"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+        raise InputParameterError(\"{} contain restricted symbols\".format(name))"
            },
            "30": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 114,
                "PatchRowcode": "     return s"
            },
            "31": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 115,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 116,
                "PatchRowcode": " "
            },
            "33": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 122,
                "PatchRowcode": "         except InputParameterError as e:"
            },
            "34": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "             msgStr = str(e)"
            },
            "35": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "             log.warning('%s', msgStr)"
            },
            "36": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return HttpResponseBadRequest(escape(msgStr))"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+            return HttpResponseBadRequest(htmlEscape(msgStr))"
            },
            "38": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 126,
                "PatchRowcode": " "
            },
            "39": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 127,
                "PatchRowcode": "     return new_f"
            }
        },
        "frontPatchFile": [
            "from django.http import HttpResponseBadRequest",
            "from graphite.logger import log",
            "",
            "",
            "class NormalizeEmptyResultError(Exception):",
            "    # throw error for normalize() when empty",
            "    pass",
            "",
            "",
            "class InputParameterError(ValueError):",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(InputParameterError, self).__init__(*args, **kwargs)",
            "        self.context = {}",
            "",
            "    def setSourceIdHeaders(self, newHeaders):",
            "        headers = self.context.get('sourceIdHeaders', {})",
            "        headers.update(newHeaders)",
            "        self.context['sourceIdHeaders'] = headers",
            "",
            "    @property",
            "    def sourceIdHeaders(self):",
            "        sourceIdHeaders = self.context.get('sourceIdHeaders', {})",
            "        headers = list(sourceIdHeaders.keys())",
            "        headers.sort()",
            "        source = ''",
            "",
            "        for name in headers:",
            "            if source:",
            "                source += ', '",
            "            source += '{name}: {value}'.format(",
            "                name=name,",
            "                value=sourceIdHeaders[name])",
            "",
            "        return source",
            "",
            "    def setTargets(self, targets):",
            "        self.context['targets'] = targets",
            "",
            "    @property",
            "    def targets(self):",
            "        return ', '.join(self.context.get('targets', []))",
            "",
            "    def setFunction(self, name, args, kwargs):",
            "        self.context['function'] = {",
            "            'name': name,",
            "            'args': args,",
            "            'kwargs': kwargs,",
            "        }",
            "",
            "    @property",
            "    def function(self):",
            "        func = self.context.get('function', None)",
            "        if not func:",
            "            return ''",
            "",
            "        funcName = func.get('name', '')",
            "        if not funcName:",
            "            return ''",
            "",
            "        kwargs = func.get('kwargs', {})",
            "        kwargKeys = list(kwargs.keys())",
            "",
            "        # keep kwargs sorted in message, for consistency and testability",
            "        kwargKeys.sort()",
            "",
            "        # generate string of args and kwargs",
            "        args = ', '.join(",
            "            argList",
            "            for argList in [",
            "                ', '.join(repr(arg) for arg in func.get('args', [])),",
            "                ', '.join('{k}={v}'.format(k=str(k), v=repr(kwargs[k])) for k in kwargKeys),",
            "            ] if argList",
            "        )",
            "",
            "        return '{func}({args})'.format(func=funcName, args=args)",
            "",
            "    def __str__(self):",
            "        msg = 'Invalid parameters ({msg})'.format(msg=str(super(InputParameterError, self).__str__()))",
            "        targets = self.targets",
            "        if targets:",
            "            msg += '; targets: \"{targets}\"'.format(targets=targets)",
            "",
            "        source = self.sourceIdHeaders",
            "        if source:",
            "            msg += '; source: \"{source}\"'.format(source=source)",
            "",
            "        # needs to be last because the string \"args\" may potentially be thousands",
            "        # of chars long after expanding the globbing patterns",
            "        func = self.function",
            "        if func:",
            "            msg += '; func: \"{func}\"'.format(func=func)",
            "",
            "        return msg",
            "",
            "",
            "# Replace special characters \"&\", \"<\" and \">\" to HTML-safe sequences.",
            "def escape(s):",
            "    s = s.replace(\"&\", \"&amp;\")  # Must be done first!",
            "    s = s.replace(\"<\", \"&lt;\")",
            "    s = s.replace(\">\", \"&gt;\")",
            "",
            "    return s",
            "",
            "",
            "# decorator which turns InputParameterExceptions into Django's HttpResponseBadRequest",
            "def handleInputParameterError(f):",
            "    def new_f(*args, **kwargs):",
            "        try:",
            "            return f(*args, **kwargs)",
            "        except InputParameterError as e:",
            "            msgStr = str(e)",
            "            log.warning('%s', msgStr)",
            "            return HttpResponseBadRequest(escape(msgStr))",
            "",
            "    return new_f"
        ],
        "afterPatchFile": [
            "from django.http import HttpResponseBadRequest",
            "from graphite.logger import log",
            "from graphite.util import htmlEscape, is_unsafe_str",
            "",
            "",
            "class NormalizeEmptyResultError(Exception):",
            "    # throw error for normalize() when empty",
            "    pass",
            "",
            "",
            "class InputParameterError(ValueError):",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(InputParameterError, self).__init__(*args, **kwargs)",
            "        self.context = {}",
            "",
            "    def setSourceIdHeaders(self, newHeaders):",
            "        headers = self.context.get('sourceIdHeaders', {})",
            "        headers.update(newHeaders)",
            "        self.context['sourceIdHeaders'] = headers",
            "",
            "    @property",
            "    def sourceIdHeaders(self):",
            "        sourceIdHeaders = self.context.get('sourceIdHeaders', {})",
            "        headers = list(sourceIdHeaders.keys())",
            "        headers.sort()",
            "        source = ''",
            "",
            "        for name in headers:",
            "            if source:",
            "                source += ', '",
            "            source += '{name}: {value}'.format(",
            "                name=name,",
            "                value=sourceIdHeaders[name])",
            "",
            "        return source",
            "",
            "    def setTargets(self, targets):",
            "        self.context['targets'] = targets",
            "",
            "    @property",
            "    def targets(self):",
            "        return ', '.join(self.context.get('targets', []))",
            "",
            "    def setFunction(self, name, args, kwargs):",
            "        self.context['function'] = {",
            "            'name': name,",
            "            'args': args,",
            "            'kwargs': kwargs,",
            "        }",
            "",
            "    @property",
            "    def function(self):",
            "        func = self.context.get('function', None)",
            "        if not func:",
            "            return ''",
            "",
            "        funcName = func.get('name', '')",
            "        if not funcName:",
            "            return ''",
            "",
            "        kwargs = func.get('kwargs', {})",
            "        kwargKeys = list(kwargs.keys())",
            "",
            "        # keep kwargs sorted in message, for consistency and testability",
            "        kwargKeys.sort()",
            "",
            "        # generate string of args and kwargs",
            "        args = ', '.join(",
            "            argList",
            "            for argList in [",
            "                ', '.join(repr(arg) for arg in func.get('args', [])),",
            "                ', '.join('{k}={v}'.format(k=str(k), v=repr(kwargs[k])) for k in kwargKeys),",
            "            ] if argList",
            "        )",
            "",
            "        return '{func}({args})'.format(func=funcName, args=args)",
            "",
            "    def __str__(self):",
            "        msg = 'Invalid parameters ({msg})'.format(msg=str(super(InputParameterError, self).__str__()))",
            "        targets = self.targets",
            "        if targets:",
            "            msg += '; targets: \"{targets}\"'.format(targets=targets)",
            "",
            "        source = self.sourceIdHeaders",
            "        if source:",
            "            msg += '; source: \"{source}\"'.format(source=source)",
            "",
            "        # needs to be last because the string \"args\" may potentially be thousands",
            "        # of chars long after expanding the globbing patterns",
            "        func = self.function",
            "        if func:",
            "            msg += '; func: \"{func}\"'.format(func=func)",
            "",
            "        return msg",
            "",
            "",
            "def safe_param(name, s):",
            "    if is_unsafe_str(s):",
            "        raise InputParameterError(\"{} contain unsafe symbols\".format(name))",
            "    return s",
            "",
            "",
            "def is_unclean_str(s):",
            "    for symbol in '&<>~!@#$%^*()`':",
            "        if s.find(symbol) >= 0:",
            "            return True",
            "    return False",
            "",
            "",
            "def str_param(name, s):",
            "    if s is not None and is_unclean_str(s):",
            "        raise InputParameterError(\"{} contain restricted symbols\".format(name))",
            "    return s",
            "",
            "",
            "# decorator which turns InputParameterExceptions into Django's HttpResponseBadRequest",
            "def handleInputParameterError(f):",
            "    def new_f(*args, **kwargs):",
            "        try:",
            "            return f(*args, **kwargs)",
            "        except InputParameterError as e:",
            "            msgStr = str(e)",
            "            log.warning('%s', msgStr)",
            "            return HttpResponseBadRequest(htmlEscape(msgStr))",
            "",
            "    return new_f"
        ],
        "action": [
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "97": [],
            "98": [
                "escape"
            ],
            "99": [
                "escape"
            ],
            "100": [
                "escape"
            ],
            "101": [
                "escape"
            ],
            "114": [
                "handleInputParameterError",
                "new_f"
            ]
        },
        "addLocation": []
    },
    "webapp/graphite/util.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 128,
                "PatchRowcode": "       yield index"
            },
            "1": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 129,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": 130,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+# Replace special characters \"&\", \"<\" and \">\" to HTML-safe sequences."
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+def htmlEscape(s):"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+    s = s.replace(\"&\", \"&amp;\")  # Must be done first!"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+    s = s.replace(\"<\", \"&lt;\")"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+    s = s.replace(\">\", \"&gt;\")"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+    return s"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+def is_unsafe_str(s):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+    for symbol in '<>':"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 141,
                "PatchRowcode": "+        if s.find(symbol) >= 0:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 142,
                "PatchRowcode": "+            return True"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+    return False"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": 146,
                "PatchRowcode": " def load_module(module_path, member=None):"
            },
            "19": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "   module_name = splitext(basename(module_path))[0]"
            },
            "20": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": 148,
                "PatchRowcode": "   try:  # 'U' is default from Python 3.0 and deprecated since 3.9"
            }
        },
        "frontPatchFile": [
            "\"\"\"Copyright 2008 Orbitz WorldWide",
            "",
            "Licensed under the Apache License, Version 2.0 (the \"License\");",
            "you may not use this file except in compliance with the License.",
            "You may obtain a copy of the License at",
            "",
            "   http://www.apache.org/licenses/LICENSE-2.0",
            "",
            "Unless required by applicable law or agreed to in writing, software",
            "distributed under the License is distributed on an \"AS IS\" BASIS,",
            "WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.",
            "See the License for the specific language governing permissions and",
            "limitations under the License.\"\"\"",
            "",
            "import imp",
            "import io",
            "import json as _json",
            "import socket",
            "import time",
            "import sys",
            "import calendar",
            "import pytz",
            "import six",
            "import traceback",
            "",
            "from datetime import datetime",
            "from functools import wraps",
            "from os.path import splitext, basename",
            "",
            "from django.conf import settings",
            "from django.utils.timezone import make_aware",
            "",
            "from graphite.compat import HttpResponse",
            "from graphite.logger import log",
            "",
            "# BytesIO is needed on py3 as StringIO does not operate on byte input anymore",
            "# We could use BytesIO on py2 as well but it is slower than StringIO",
            "if sys.version_info >= (3, 0):",
            "  PY3 = True",
            "  import pickle",
            "  from io import BytesIO",
            "else:",
            "  PY3 = False",
            "  import cPickle as pickle",
            "  from cStringIO import StringIO as BytesIO",
            "",
            "# use https://github.com/msgpack/msgpack-python if available",
            "try:",
            "  import msgpack  # NOQA",
            "# otherwise fall back to bundled https://github.com/vsergeev/u-msgpack-python",
            "except ImportError:",
            "  import graphite.umsgpack as msgpack  # NOQA",
            "",
            "",
            "def epoch(dt):",
            "  \"\"\"",
            "  Returns the epoch timestamp of a timezone-aware datetime object.",
            "  \"\"\"",
            "  if not dt.tzinfo:",
            "    tb = traceback.extract_stack(None, 2)",
            "    log.warning('epoch() called with non-timezone-aware datetime in %s at %s:%d' % (tb[0][2], tb[0][0], tb[0][1]))",
            "    return calendar.timegm(make_aware(dt, pytz.timezone(settings.TIME_ZONE)).astimezone(pytz.utc).timetuple())",
            "  return calendar.timegm(dt.astimezone(pytz.utc).timetuple())",
            "",
            "",
            "def epoch_to_dt(timestamp):",
            "    \"\"\"",
            "    Returns the timezone-aware datetime of an epoch timestamp.",
            "    \"\"\"",
            "    return make_aware(datetime.utcfromtimestamp(timestamp), pytz.utc)",
            "",
            "",
            "def timebounds(requestContext):",
            "  startTime = int(epoch(requestContext['startTime']))",
            "  endTime = int(epoch(requestContext['endTime']))",
            "  now = int(epoch(requestContext['now']))",
            "",
            "  return (startTime, endTime, now)",
            "",
            "",
            "def is_local_interface(host):",
            "  is_ipv6 = False",
            "  if ':' not in host:",
            "    pass",
            "  elif host.count(':') == 1:",
            "    host = host.split(':', 1)[0]",
            "  else:",
            "    is_ipv6 = True",
            "",
            "    if host.find('[', 0, 2) != -1:",
            "      last_bracket_position  = host.rfind(']')",
            "      last_colon_position = host.rfind(':')",
            "      if last_colon_position > last_bracket_position:",
            "        host = host.rsplit(':', 1)[0]",
            "      host = host.strip('[]')",
            "",
            "  try:",
            "    if is_ipv6:",
            "      sock = socket.socket(socket.AF_INET6, socket.SOCK_DGRAM)",
            "    else:",
            "      sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)",
            "    sock.bind( (host, 0) )",
            "  except socket.error:",
            "    return False",
            "  finally:",
            "    sock.close()",
            "",
            "  return True",
            "",
            "",
            "def is_pattern(s):",
            "   return '*' in s or '?' in s or '[' in s or '{' in s",
            "",
            "",
            "def is_escaped_pattern(s):",
            "  for symbol in '*?[{':",
            "    i = s.find(symbol)",
            "    if i > 0:",
            "      if s[i-1] == '\\\\':",
            "        return True",
            "  return False",
            "",
            "",
            "def find_escaped_pattern_fields(pattern_string):",
            "  pattern_parts = pattern_string.split('.')",
            "  for index,part in enumerate(pattern_parts):",
            "    if is_escaped_pattern(part):",
            "      yield index",
            "",
            "",
            "def load_module(module_path, member=None):",
            "  module_name = splitext(basename(module_path))[0]",
            "  try:  # 'U' is default from Python 3.0 and deprecated since 3.9",
            "    module_file = open(module_path, 'U')",
            "  except ValueError:",
            "    module_file = open(module_path, 'rt')",
            "  description = ('.py', 'U', imp.PY_SOURCE)",
            "  module = imp.load_module(module_name, module_file, module_path, description)",
            "  if member:",
            "    return getattr(module, member)",
            "  else:",
            "    return module",
            "",
            "",
            "def timestamp(dt):",
            "  \"Convert a datetime object into epoch time\"",
            "  return time.mktime(dt.timetuple())",
            "",
            "",
            "def deltaseconds(timedelta):",
            "  \"Convert a timedelta object into seconds (same as timedelta.total_seconds() in Python 2.7+)\"",
            "  return (timedelta.microseconds + (timedelta.seconds + timedelta.days * 24 * 3600) * 10**6) / 10**6",
            "",
            "",
            "# This whole song & dance is due to pickle being insecure",
            "# The SafeUnpickler classes were largely derived from",
            "# http://nadiana.com/python-pickle-insecure",
            "# This code also lives in carbon.util",
            "if not PY3:",
            "  class SafeUnpickler(object):",
            "    PICKLE_SAFE = {",
            "      'copy_reg': set(['_reconstructor']),",
            "      '__builtin__': set(['object', 'list', 'set']),",
            "      'collections': set(['deque']),",
            "      'graphite.render.datalib': set(['TimeSeries', 'Tags']),",
            "      'graphite.intervals': set(['Interval', 'IntervalSet']),",
            "    }",
            "",
            "    @classmethod",
            "    def find_class(cls, module, name):",
            "      if module not in cls.PICKLE_SAFE:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe module %s' % module)",
            "      __import__(module)",
            "      mod = sys.modules[module]",
            "      if name not in cls.PICKLE_SAFE[module]:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe class %s' % name)",
            "      return getattr(mod, name)",
            "",
            "    @classmethod",
            "    def loads(cls, pickle_string):",
            "      pickle_obj = pickle.Unpickler(BytesIO(pickle_string))",
            "      pickle_obj.find_global = cls.find_class",
            "      return pickle_obj.load()",
            "",
            "    @classmethod",
            "    def load(cls, file):",
            "      pickle_obj = pickle.Unpickler(file)",
            "      pickle_obj.find_global = cls.find_class",
            "      return pickle_obj.load()",
            "",
            "  unpickle = SafeUnpickler",
            "",
            "else:",
            "  class SafeUnpickler(pickle.Unpickler):",
            "    PICKLE_SAFE = {",
            "      'copy_reg': set(['_reconstructor']),",
            "      'builtins': set(['object', 'list', 'set']),",
            "      'collections': set(['deque']),",
            "      'graphite.render.datalib': set(['TimeSeries', 'Tags']),",
            "      'graphite.intervals': set(['Interval', 'IntervalSet']),",
            "    }",
            "",
            "    def __init__(self, file):",
            "        super().__init__(file, encoding='utf8')",
            "",
            "    def find_class(self, module, name):",
            "      if module not in self.PICKLE_SAFE:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe module %s' % module)",
            "      __import__(module)",
            "      mod = sys.modules[module]",
            "      if name not in self.PICKLE_SAFE[module]:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe class %s' % name)",
            "      return getattr(mod, name)",
            "",
            "  class unpickle(object):",
            "    @staticmethod",
            "    def loads(pickle_string):",
            "      return SafeUnpickler(BytesIO(pickle_string)).load()",
            "",
            "    @staticmethod",
            "    def load(file):",
            "      return SafeUnpickler(file).load()",
            "",
            "",
            "class json(object):",
            "  JSONEncoder = _json.JSONEncoder",
            "  JSONDecoder = _json.JSONDecoder",
            "",
            "  @staticmethod",
            "  def dump(*args, **kwargs):",
            "    return _json.dump(*args, **kwargs)",
            "",
            "  @staticmethod",
            "  def dumps(*args, **kwargs):",
            "    return _json.dumps(*args, **kwargs)",
            "",
            "  @staticmethod",
            "  def load(fp, *args, **kwargs):",
            "    return _json.load(fp, *args, **kwargs)",
            "",
            "  @staticmethod",
            "  def loads(s, *args, **kwargs):",
            "    if isinstance(s, six.binary_type):",
            "      return _json.loads(s.decode('utf-8'), *args, **kwargs)",
            "    return _json.loads(s, *args, **kwargs)",
            "",
            "",
            "class Timer(object):",
            "  __slots__ = ('msg', 'name', 'start_time')",
            "",
            "  def __init__(self, name):",
            "    self.name = name",
            "    self.msg = 'completed in'",
            "    self.start_time = time.time()",
            "",
            "  def set_msg(self, msg):",
            "    self.msg = msg",
            "",
            "  def set_name(self, name):",
            "    self.name = name",
            "",
            "  def stop(self):",
            "    log.info(",
            "      '{name} :: {msg} {sec:.6}s'.format(",
            "        name=self.name,",
            "        msg=self.msg,",
            "        sec=time.time() - self.start_time,",
            "      )",
            "    )",
            "",
            "",
            "def logtime(f):",
            "  @wraps(f)",
            "  def wrapped_f(*args, **kwargs):",
            "    timer = Timer(f.__module__ + '.' + f.__name__)",
            "    kwargs['timer'] = timer",
            "",
            "    try:",
            "      return f(*args, **kwargs)",
            "    except Exception:",
            "      timer.msg = 'failed in'",
            "      raise",
            "    finally:",
            "      timer.stop()",
            "",
            "  return wrapped_f",
            "",
            "",
            "class BufferedHTTPReader(io.FileIO):",
            "  def __init__(self, response, buffer_size=1048576):",
            "    self.response = response",
            "    self.buffer_size = buffer_size",
            "    self.buffer = b''",
            "    self.pos = 0",
            "",
            "  def read(self, amt=None):",
            "    if amt is None:",
            "      return self.response.read()",
            "    if len(self.buffer) - self.pos < amt:",
            "      self.buffer = self.buffer[self.pos:]",
            "      self.pos = 0",
            "      self.buffer += self.response.read(self.buffer_size)",
            "    data = self.buffer[self.pos:self.pos + amt]",
            "    self.pos += amt",
            "    if self.pos >= len(self.buffer):",
            "      self.pos = 0",
            "      self.buffer = b''",
            "    return data",
            "",
            "",
            "def jsonResponse(*args, **kwargs):",
            "  encoder = kwargs.get('encoder')",
            "  default = kwargs.get('default')",
            "",
            "  def decorator(f):",
            "    @wraps(f)",
            "    def wrapped_f(request, *args, **kwargs):",
            "      if request.method == 'GET':",
            "        queryParams = request.GET.copy()",
            "      elif request.method == 'POST':",
            "        queryParams = request.GET.copy()",
            "        queryParams.update(request.POST)",
            "      else:",
            "        queryParams = {}",
            "",
            "      try:",
            "        return _jsonResponse(",
            "          f(request, queryParams, *args, **kwargs), queryParams, encoder=encoder, default=default)",
            "      except ValueError as err:",
            "        return _jsonError(",
            "          str(err), queryParams, status=getattr(err, 'status', 400), encoder=encoder, default=default)",
            "      except Exception as err:",
            "        return _jsonError(",
            "          str(err), queryParams, status=getattr(err, 'status', 500), encoder=encoder, default=default)",
            "",
            "    return wrapped_f",
            "",
            "  # used like @jsonResponse",
            "  if args:",
            "    return decorator(args[0])",
            "",
            "  # used like @jsonResponse(encoder=DjangoJSONEncoder)",
            "  return decorator",
            "",
            "",
            "class HttpError(Exception):",
            "  def __init__(self, message, status=500):",
            "    super(HttpError, self).__init__(message)",
            "    self.status=status",
            "",
            "",
            "def _jsonResponse(data, queryParams, status=200, encoder=None, default=None):",
            "  if isinstance(data, HttpResponse):",
            "    return data",
            "",
            "  if not queryParams:",
            "    queryParams = {}",
            "",
            "  return HttpResponse(",
            "    json.dumps(",
            "      data,",
            "      indent=(2 if queryParams.get('pretty') else None),",
            "      sort_keys=bool(queryParams.get('pretty')),",
            "      cls=encoder,",
            "      default=default",
            "    ),",
            "    content_type='application/json',",
            "    status=status",
            "  )",
            "",
            "",
            "def _jsonError(message, queryParams, status=500, encoder=None, default=None):",
            "  return _jsonResponse(",
            "    {'error': message}, queryParams, status=status, encoder=encoder, default=default)",
            "",
            "",
            "def parseHost(host_string):",
            "    s = host_string.strip()",
            "    bidx = s.rfind(']:')    # find closing bracket and following colon.",
            "    cidx = s.find(':')",
            "    if s.startswith('[') and bidx is not None:",
            "        server = s[1:bidx]",
            "        port = s[bidx + 2:]",
            "    elif cidx is not None:",
            "        server = s[:cidx]",
            "        port = s[cidx + 1:]",
            "    else:",
            "        raise ValueError(\"Invalid host string \\\"%s\\\"\" % host_string)",
            "",
            "    if ':' in port:",
            "        port, _, instance = port.partition(':')",
            "    else:",
            "        instance = None",
            "",
            "    return server, int(port), instance",
            "",
            "",
            "def parseHosts(host_strings):",
            "    return [parseHost(host_string) for host_string in host_strings]"
        ],
        "afterPatchFile": [
            "\"\"\"Copyright 2008 Orbitz WorldWide",
            "",
            "Licensed under the Apache License, Version 2.0 (the \"License\");",
            "you may not use this file except in compliance with the License.",
            "You may obtain a copy of the License at",
            "",
            "   http://www.apache.org/licenses/LICENSE-2.0",
            "",
            "Unless required by applicable law or agreed to in writing, software",
            "distributed under the License is distributed on an \"AS IS\" BASIS,",
            "WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.",
            "See the License for the specific language governing permissions and",
            "limitations under the License.\"\"\"",
            "",
            "import imp",
            "import io",
            "import json as _json",
            "import socket",
            "import time",
            "import sys",
            "import calendar",
            "import pytz",
            "import six",
            "import traceback",
            "",
            "from datetime import datetime",
            "from functools import wraps",
            "from os.path import splitext, basename",
            "",
            "from django.conf import settings",
            "from django.utils.timezone import make_aware",
            "",
            "from graphite.compat import HttpResponse",
            "from graphite.logger import log",
            "",
            "# BytesIO is needed on py3 as StringIO does not operate on byte input anymore",
            "# We could use BytesIO on py2 as well but it is slower than StringIO",
            "if sys.version_info >= (3, 0):",
            "  PY3 = True",
            "  import pickle",
            "  from io import BytesIO",
            "else:",
            "  PY3 = False",
            "  import cPickle as pickle",
            "  from cStringIO import StringIO as BytesIO",
            "",
            "# use https://github.com/msgpack/msgpack-python if available",
            "try:",
            "  import msgpack  # NOQA",
            "# otherwise fall back to bundled https://github.com/vsergeev/u-msgpack-python",
            "except ImportError:",
            "  import graphite.umsgpack as msgpack  # NOQA",
            "",
            "",
            "def epoch(dt):",
            "  \"\"\"",
            "  Returns the epoch timestamp of a timezone-aware datetime object.",
            "  \"\"\"",
            "  if not dt.tzinfo:",
            "    tb = traceback.extract_stack(None, 2)",
            "    log.warning('epoch() called with non-timezone-aware datetime in %s at %s:%d' % (tb[0][2], tb[0][0], tb[0][1]))",
            "    return calendar.timegm(make_aware(dt, pytz.timezone(settings.TIME_ZONE)).astimezone(pytz.utc).timetuple())",
            "  return calendar.timegm(dt.astimezone(pytz.utc).timetuple())",
            "",
            "",
            "def epoch_to_dt(timestamp):",
            "    \"\"\"",
            "    Returns the timezone-aware datetime of an epoch timestamp.",
            "    \"\"\"",
            "    return make_aware(datetime.utcfromtimestamp(timestamp), pytz.utc)",
            "",
            "",
            "def timebounds(requestContext):",
            "  startTime = int(epoch(requestContext['startTime']))",
            "  endTime = int(epoch(requestContext['endTime']))",
            "  now = int(epoch(requestContext['now']))",
            "",
            "  return (startTime, endTime, now)",
            "",
            "",
            "def is_local_interface(host):",
            "  is_ipv6 = False",
            "  if ':' not in host:",
            "    pass",
            "  elif host.count(':') == 1:",
            "    host = host.split(':', 1)[0]",
            "  else:",
            "    is_ipv6 = True",
            "",
            "    if host.find('[', 0, 2) != -1:",
            "      last_bracket_position  = host.rfind(']')",
            "      last_colon_position = host.rfind(':')",
            "      if last_colon_position > last_bracket_position:",
            "        host = host.rsplit(':', 1)[0]",
            "      host = host.strip('[]')",
            "",
            "  try:",
            "    if is_ipv6:",
            "      sock = socket.socket(socket.AF_INET6, socket.SOCK_DGRAM)",
            "    else:",
            "      sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)",
            "    sock.bind( (host, 0) )",
            "  except socket.error:",
            "    return False",
            "  finally:",
            "    sock.close()",
            "",
            "  return True",
            "",
            "",
            "def is_pattern(s):",
            "   return '*' in s or '?' in s or '[' in s or '{' in s",
            "",
            "",
            "def is_escaped_pattern(s):",
            "  for symbol in '*?[{':",
            "    i = s.find(symbol)",
            "    if i > 0:",
            "      if s[i-1] == '\\\\':",
            "        return True",
            "  return False",
            "",
            "",
            "def find_escaped_pattern_fields(pattern_string):",
            "  pattern_parts = pattern_string.split('.')",
            "  for index,part in enumerate(pattern_parts):",
            "    if is_escaped_pattern(part):",
            "      yield index",
            "",
            "",
            "# Replace special characters \"&\", \"<\" and \">\" to HTML-safe sequences.",
            "def htmlEscape(s):",
            "    s = s.replace(\"&\", \"&amp;\")  # Must be done first!",
            "    s = s.replace(\"<\", \"&lt;\")",
            "    s = s.replace(\">\", \"&gt;\")",
            "    return s",
            "",
            "",
            "def is_unsafe_str(s):",
            "    for symbol in '<>':",
            "        if s.find(symbol) >= 0:",
            "            return True",
            "    return False",
            "",
            "",
            "def load_module(module_path, member=None):",
            "  module_name = splitext(basename(module_path))[0]",
            "  try:  # 'U' is default from Python 3.0 and deprecated since 3.9",
            "    module_file = open(module_path, 'U')",
            "  except ValueError:",
            "    module_file = open(module_path, 'rt')",
            "  description = ('.py', 'U', imp.PY_SOURCE)",
            "  module = imp.load_module(module_name, module_file, module_path, description)",
            "  if member:",
            "    return getattr(module, member)",
            "  else:",
            "    return module",
            "",
            "",
            "def timestamp(dt):",
            "  \"Convert a datetime object into epoch time\"",
            "  return time.mktime(dt.timetuple())",
            "",
            "",
            "def deltaseconds(timedelta):",
            "  \"Convert a timedelta object into seconds (same as timedelta.total_seconds() in Python 2.7+)\"",
            "  return (timedelta.microseconds + (timedelta.seconds + timedelta.days * 24 * 3600) * 10**6) / 10**6",
            "",
            "",
            "# This whole song & dance is due to pickle being insecure",
            "# The SafeUnpickler classes were largely derived from",
            "# http://nadiana.com/python-pickle-insecure",
            "# This code also lives in carbon.util",
            "if not PY3:",
            "  class SafeUnpickler(object):",
            "    PICKLE_SAFE = {",
            "      'copy_reg': set(['_reconstructor']),",
            "      '__builtin__': set(['object', 'list', 'set']),",
            "      'collections': set(['deque']),",
            "      'graphite.render.datalib': set(['TimeSeries', 'Tags']),",
            "      'graphite.intervals': set(['Interval', 'IntervalSet']),",
            "    }",
            "",
            "    @classmethod",
            "    def find_class(cls, module, name):",
            "      if module not in cls.PICKLE_SAFE:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe module %s' % module)",
            "      __import__(module)",
            "      mod = sys.modules[module]",
            "      if name not in cls.PICKLE_SAFE[module]:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe class %s' % name)",
            "      return getattr(mod, name)",
            "",
            "    @classmethod",
            "    def loads(cls, pickle_string):",
            "      pickle_obj = pickle.Unpickler(BytesIO(pickle_string))",
            "      pickle_obj.find_global = cls.find_class",
            "      return pickle_obj.load()",
            "",
            "    @classmethod",
            "    def load(cls, file):",
            "      pickle_obj = pickle.Unpickler(file)",
            "      pickle_obj.find_global = cls.find_class",
            "      return pickle_obj.load()",
            "",
            "  unpickle = SafeUnpickler",
            "",
            "else:",
            "  class SafeUnpickler(pickle.Unpickler):",
            "    PICKLE_SAFE = {",
            "      'copy_reg': set(['_reconstructor']),",
            "      'builtins': set(['object', 'list', 'set']),",
            "      'collections': set(['deque']),",
            "      'graphite.render.datalib': set(['TimeSeries', 'Tags']),",
            "      'graphite.intervals': set(['Interval', 'IntervalSet']),",
            "    }",
            "",
            "    def __init__(self, file):",
            "        super().__init__(file, encoding='utf8')",
            "",
            "    def find_class(self, module, name):",
            "      if module not in self.PICKLE_SAFE:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe module %s' % module)",
            "      __import__(module)",
            "      mod = sys.modules[module]",
            "      if name not in self.PICKLE_SAFE[module]:",
            "        raise pickle.UnpicklingError('Attempting to unpickle unsafe class %s' % name)",
            "      return getattr(mod, name)",
            "",
            "  class unpickle(object):",
            "    @staticmethod",
            "    def loads(pickle_string):",
            "      return SafeUnpickler(BytesIO(pickle_string)).load()",
            "",
            "    @staticmethod",
            "    def load(file):",
            "      return SafeUnpickler(file).load()",
            "",
            "",
            "class json(object):",
            "  JSONEncoder = _json.JSONEncoder",
            "  JSONDecoder = _json.JSONDecoder",
            "",
            "  @staticmethod",
            "  def dump(*args, **kwargs):",
            "    return _json.dump(*args, **kwargs)",
            "",
            "  @staticmethod",
            "  def dumps(*args, **kwargs):",
            "    return _json.dumps(*args, **kwargs)",
            "",
            "  @staticmethod",
            "  def load(fp, *args, **kwargs):",
            "    return _json.load(fp, *args, **kwargs)",
            "",
            "  @staticmethod",
            "  def loads(s, *args, **kwargs):",
            "    if isinstance(s, six.binary_type):",
            "      return _json.loads(s.decode('utf-8'), *args, **kwargs)",
            "    return _json.loads(s, *args, **kwargs)",
            "",
            "",
            "class Timer(object):",
            "  __slots__ = ('msg', 'name', 'start_time')",
            "",
            "  def __init__(self, name):",
            "    self.name = name",
            "    self.msg = 'completed in'",
            "    self.start_time = time.time()",
            "",
            "  def set_msg(self, msg):",
            "    self.msg = msg",
            "",
            "  def set_name(self, name):",
            "    self.name = name",
            "",
            "  def stop(self):",
            "    log.info(",
            "      '{name} :: {msg} {sec:.6}s'.format(",
            "        name=self.name,",
            "        msg=self.msg,",
            "        sec=time.time() - self.start_time,",
            "      )",
            "    )",
            "",
            "",
            "def logtime(f):",
            "  @wraps(f)",
            "  def wrapped_f(*args, **kwargs):",
            "    timer = Timer(f.__module__ + '.' + f.__name__)",
            "    kwargs['timer'] = timer",
            "",
            "    try:",
            "      return f(*args, **kwargs)",
            "    except Exception:",
            "      timer.msg = 'failed in'",
            "      raise",
            "    finally:",
            "      timer.stop()",
            "",
            "  return wrapped_f",
            "",
            "",
            "class BufferedHTTPReader(io.FileIO):",
            "  def __init__(self, response, buffer_size=1048576):",
            "    self.response = response",
            "    self.buffer_size = buffer_size",
            "    self.buffer = b''",
            "    self.pos = 0",
            "",
            "  def read(self, amt=None):",
            "    if amt is None:",
            "      return self.response.read()",
            "    if len(self.buffer) - self.pos < amt:",
            "      self.buffer = self.buffer[self.pos:]",
            "      self.pos = 0",
            "      self.buffer += self.response.read(self.buffer_size)",
            "    data = self.buffer[self.pos:self.pos + amt]",
            "    self.pos += amt",
            "    if self.pos >= len(self.buffer):",
            "      self.pos = 0",
            "      self.buffer = b''",
            "    return data",
            "",
            "",
            "def jsonResponse(*args, **kwargs):",
            "  encoder = kwargs.get('encoder')",
            "  default = kwargs.get('default')",
            "",
            "  def decorator(f):",
            "    @wraps(f)",
            "    def wrapped_f(request, *args, **kwargs):",
            "      if request.method == 'GET':",
            "        queryParams = request.GET.copy()",
            "      elif request.method == 'POST':",
            "        queryParams = request.GET.copy()",
            "        queryParams.update(request.POST)",
            "      else:",
            "        queryParams = {}",
            "",
            "      try:",
            "        return _jsonResponse(",
            "          f(request, queryParams, *args, **kwargs), queryParams, encoder=encoder, default=default)",
            "      except ValueError as err:",
            "        return _jsonError(",
            "          str(err), queryParams, status=getattr(err, 'status', 400), encoder=encoder, default=default)",
            "      except Exception as err:",
            "        return _jsonError(",
            "          str(err), queryParams, status=getattr(err, 'status', 500), encoder=encoder, default=default)",
            "",
            "    return wrapped_f",
            "",
            "  # used like @jsonResponse",
            "  if args:",
            "    return decorator(args[0])",
            "",
            "  # used like @jsonResponse(encoder=DjangoJSONEncoder)",
            "  return decorator",
            "",
            "",
            "class HttpError(Exception):",
            "  def __init__(self, message, status=500):",
            "    super(HttpError, self).__init__(message)",
            "    self.status=status",
            "",
            "",
            "def _jsonResponse(data, queryParams, status=200, encoder=None, default=None):",
            "  if isinstance(data, HttpResponse):",
            "    return data",
            "",
            "  if not queryParams:",
            "    queryParams = {}",
            "",
            "  return HttpResponse(",
            "    json.dumps(",
            "      data,",
            "      indent=(2 if queryParams.get('pretty') else None),",
            "      sort_keys=bool(queryParams.get('pretty')),",
            "      cls=encoder,",
            "      default=default",
            "    ),",
            "    content_type='application/json',",
            "    status=status",
            "  )",
            "",
            "",
            "def _jsonError(message, queryParams, status=500, encoder=None, default=None):",
            "  return _jsonResponse(",
            "    {'error': message}, queryParams, status=status, encoder=encoder, default=default)",
            "",
            "",
            "def parseHost(host_string):",
            "    s = host_string.strip()",
            "    bidx = s.rfind(']:')    # find closing bracket and following colon.",
            "    cidx = s.find(':')",
            "    if s.startswith('[') and bidx is not None:",
            "        server = s[1:bidx]",
            "        port = s[bidx + 2:]",
            "    elif cidx is not None:",
            "        server = s[:cidx]",
            "        port = s[cidx + 1:]",
            "    else:",
            "        raise ValueError(\"Invalid host string \\\"%s\\\"\" % host_string)",
            "",
            "    if ':' in port:",
            "        port, _, instance = port.partition(':')",
            "    else:",
            "        instance = None",
            "",
            "    return server, int(port), instance",
            "",
            "",
            "def parseHosts(host_strings):",
            "    return [parseHost(host_string) for host_string in host_strings]"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "flower.command"
        ]
    },
    "webapp/tests/base.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from graphite.worker_pool.pool import stop_pools"
            },
            "1": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+def is_unsafe_str(s):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+    for symbol in '<>':"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+        if s.find(symbol) > 0:"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+            return True"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+        return False"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+"
            },
            "10": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " class TestCase(OriginalTestCase):"
            },
            "11": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 13,
                "PatchRowcode": "     def tearDown(self):"
            },
            "12": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 14,
                "PatchRowcode": "         stop_pools()"
            },
            "13": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 22,
                "PatchRowcode": "                 \" (expected %d)\" % (response.status_code, status_code)"
            },
            "14": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 23,
                "PatchRowcode": "             )"
            },
            "15": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " "
            },
            "16": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        xss = response.content.find(b\"<\") != -1 or response.content.find(b\">\") != -1"
            },
            "17": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertFalse(xss, msg=msg_prefix+str(response.content))"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+        content = str(response.content)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+        xss = is_unsafe_str(content)"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+        self.assertFalse(xss, msg=msg_prefix+content)"
            }
        },
        "frontPatchFile": [
            "from django.test import TestCase as OriginalTestCase",
            "from graphite.worker_pool.pool import stop_pools",
            "",
            "",
            "class TestCase(OriginalTestCase):",
            "    def tearDown(self):",
            "        stop_pools()",
            "",
            "    # Assert that a response is unsanitized (for check XSS issues)",
            "    def assertXSS(self, response, status_code=200, msg_prefix=''):",
            "        if status_code is not None:",
            "            self.assertEqual(",
            "                response.status_code, status_code,",
            "                msg_prefix + \"Couldn't retrieve content: Response code was %d\"",
            "                \" (expected %d)\" % (response.status_code, status_code)",
            "            )",
            "",
            "        xss = response.content.find(b\"<\") != -1 or response.content.find(b\">\") != -1",
            "        self.assertFalse(xss, msg=msg_prefix+str(response.content))"
        ],
        "afterPatchFile": [
            "from django.test import TestCase as OriginalTestCase",
            "from graphite.worker_pool.pool import stop_pools",
            "",
            "",
            "def is_unsafe_str(s):",
            "    for symbol in '<>':",
            "        if s.find(symbol) > 0:",
            "            return True",
            "        return False",
            "",
            "",
            "class TestCase(OriginalTestCase):",
            "    def tearDown(self):",
            "        stop_pools()",
            "",
            "    # Assert that a response is unsanitized (for check XSS issues)",
            "    def assertXSS(self, response, status_code=200, msg_prefix=''):",
            "        if status_code is not None:",
            "            self.assertEqual(",
            "                response.status_code, status_code,",
            "                msg_prefix + \"Couldn't retrieve content: Response code was %d\"",
            "                \" (expected %d)\" % (response.status_code, status_code)",
            "            )",
            "",
            "        content = str(response.content)",
            "        xss = is_unsafe_str(content)",
            "        self.assertFalse(xss, msg=msg_prefix+content)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "18": [
                "TestCase",
                "assertXSS"
            ],
            "19": [
                "TestCase",
                "assertXSS"
            ]
        },
        "addLocation": [
            "webapp.tests.base.TestCase.assertXSS",
            "flower.command"
        ]
    },
    "webapp/tests/test_dashboard.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " except ImportError:"
            },
            "1": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": "     from django.contrib.auth.models import User"
            },
            "2": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+from graphite.util import htmlEscape"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+"
            },
            "5": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " class DashboardTest(TestCase):"
            },
            "7": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 27,
                "PatchRowcode": "     # Set config to the test config file"
            },
            "8": {
                "beforePatchRowNumber": 244,
                "afterPatchRowNumber": 246,
                "PatchRowcode": "         self.assertEqual(response.status_code, 200)"
            },
            "9": {
                "beforePatchRowNumber": 245,
                "afterPatchRowNumber": 247,
                "PatchRowcode": "         self.assertEqual(response.content, b'{\"templates\": []}')"
            },
            "10": {
                "beforePatchRowNumber": 246,
                "afterPatchRowNumber": 248,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 249,
                "PatchRowcode": "+    def test_dashboard_save_temporary_xss_name(self):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 250,
                "PatchRowcode": "+        xssStr = htmlEscape('<img src=1 onerror=alert(1)>')"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+        url = '/graphite/dashboard/save_template/' + xssStr + '/testkey'"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+        request = copy.deepcopy(self.testtemplate)"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 254,
                "PatchRowcode": "+        response = self.client.post(url, request)"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 255,
                "PatchRowcode": "+        self.assertContains(response, 'name contain restricted symbols', status_code=400)"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 256,
                "PatchRowcode": "+"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 257,
                "PatchRowcode": "+    def test_dashboard_save_temporary_xss_key(self):"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 258,
                "PatchRowcode": "+        xssStr = htmlEscape('<img src=1 onerror=alert(1)>')"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 259,
                "PatchRowcode": "+        url = '/graphite/dashboard/save_template/testtemplate/' + xssStr"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 260,
                "PatchRowcode": "+"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 261,
                "PatchRowcode": "+        request = copy.deepcopy(self.testtemplate)"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 262,
                "PatchRowcode": "+        response = self.client.post(url, request)"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 263,
                "PatchRowcode": "+        self.assertContains(response, 'key contain restricted symbols', status_code=400)"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 264,
                "PatchRowcode": "+"
            },
            "27": {
                "beforePatchRowNumber": 247,
                "afterPatchRowNumber": 265,
                "PatchRowcode": "     def test_dashboard_save_template(self):"
            },
            "28": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": 266,
                "PatchRowcode": "         url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])"
            },
            "29": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": 267,
                "PatchRowcode": "         request = copy.deepcopy(self.testtemplate)"
            },
            "30": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": 268,
                "PatchRowcode": "         response = self.client.post(url, request)"
            },
            "31": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": 269,
                "PatchRowcode": "         self.assertEqual(response.status_code, 200)"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 270,
                "PatchRowcode": "+        self.assertEqual(response.content, b'{\"success\": true}')"
            },
            "33": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": 271,
                "PatchRowcode": " "
            },
            "34": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Save again after it now exists"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 272,
                "PatchRowcode": "+    # Save again after it now exists"
            },
            "36": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": 273,
                "PatchRowcode": "     def test_dashboard_save_template_overwrite(self):"
            },
            "37": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": 274,
                "PatchRowcode": "         url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])"
            },
            "38": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": 275,
                "PatchRowcode": "         request = copy.deepcopy(self.testtemplate)"
            },
            "39": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": 276,
                "PatchRowcode": "         response = self.client.post(url, request)"
            },
            "40": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": 277,
                "PatchRowcode": "         self.assertEqual(response.status_code, 200)"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 278,
                "PatchRowcode": "+        self.assertEqual(response.content, b'{\"success\": true}')"
            },
            "42": {
                "beforePatchRowNumber": 259,
                "afterPatchRowNumber": 279,
                "PatchRowcode": " "
            },
            "43": {
                "beforePatchRowNumber": 260,
                "afterPatchRowNumber": 280,
                "PatchRowcode": "         url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])"
            },
            "44": {
                "beforePatchRowNumber": 261,
                "afterPatchRowNumber": 281,
                "PatchRowcode": "         request = copy.deepcopy(self.testtemplate)"
            },
            "45": {
                "beforePatchRowNumber": 262,
                "afterPatchRowNumber": 282,
                "PatchRowcode": "         response = self.client.post(url, request)"
            },
            "46": {
                "beforePatchRowNumber": 263,
                "afterPatchRowNumber": 283,
                "PatchRowcode": "         self.assertEqual(response.status_code, 200)"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 284,
                "PatchRowcode": "+        self.assertEqual(response.content, b'{\"success\": true}')"
            },
            "48": {
                "beforePatchRowNumber": 264,
                "afterPatchRowNumber": 285,
                "PatchRowcode": " "
            },
            "49": {
                "beforePatchRowNumber": 265,
                "afterPatchRowNumber": 286,
                "PatchRowcode": "     def test_dashboard_find_template(self):"
            },
            "50": {
                "beforePatchRowNumber": 266,
                "afterPatchRowNumber": 287,
                "PatchRowcode": "         url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])"
            }
        },
        "frontPatchFile": [
            "import copy",
            "import errno",
            "import mock",
            "import os",
            "",
            "from . import TEST_CONF_DIR",
            "",
            "from django.conf import settings",
            "try:",
            "    from django.urls import reverse",
            "except ImportError:  # Django < 1.10",
            "    from django.core.urlresolvers import reverse",
            "from django.http import HttpResponse",
            "from .base import TestCase",
            "from django.test.utils import override_settings",
            "from graphite.util import json",
            "try:",
            "    from django.contrib.auth import get_user_model",
            "    User = get_user_model()",
            "except ImportError:",
            "    from django.contrib.auth.models import User",
            "",
            "",
            "class DashboardTest(TestCase):",
            "    # Set config to the test config file",
            "    settings.DASHBOARD_CONF = os.path.join(TEST_CONF_DIR, 'dashboard.conf')",
            "",
            "    # Define a testtemplate",
            "    testtemplate = {\"state\": '{\"graphs\": [[ \"target=a.b.c.*.__VALUE__.d\", {  \"from\":\"-2days\", \"target\":[  \"a.b.c.*.__VALUE__.d\" ], \"until\":\"now\" }, \"/render?width=400&from=-2days&until=now&height=250&target=a.b.c.*.__VALUE__.d&_uniq=0.6526056618895382&title=a.b.c.*.__VALUE__.d\" ]]}'}",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing'))",
            "    def test_dashboard_missing_conf(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing'))",
            "    def test_dashboard_template_missing_template(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @mock.patch('graphite.dashboard.views.DashboardConfig.check')",
            "    def test_dashboard_conf_read_failure(self, check):",
            "        check.side_effect = OSError(errno.EPERM, 'Operation not permitted')",
            "        url = reverse('dashboard')",
            "        with self.assertRaises(Exception):",
            "            _ = self.client.get(url)",
            "",
            "    @mock.patch('graphite.dashboard.views.DashboardConfig.check')",
            "    def test_dashboard_template_conf_read_failure(self, check):",
            "        check.side_effect = OSError(errno.EPERM, 'Operation not permitted')",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        with self.assertRaises(Exception):",
            "            _ = self.client.get(url)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_ui'))",
            "    def test_dashboard_conf_missing_ui(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_ui'))",
            "    def test_dashboard_template_missing_ui(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_keyboard-shortcuts'))",
            "    def test_dashboard_conf_missing_keyboard_shortcuts(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_keyboard-shortcuts'))",
            "    def test_dashboard_template_missing_keyboard_shortcuts(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.invalid_theme'))",
            "    def test_dashboard_conf_invalid_theme(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.invalid_theme'))",
            "    def test_dashboard_template_invalid_theme(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_no_user(self):",
            "        url = reverse('dashboard')",
            "        request = {\"user\": '', \"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_pass_valid(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_pass_invalid_name(self):",
            "        url = reverse('dashboard', args=['bogusdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_find_empty(self):",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_save_empty(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_save_overwrite(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_find_existing(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"test\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": [{\"name\": \"testdashboard\"}]}')",
            "",
            "    def test_dashboard_find_not_existing(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"not here\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_load_not_existing(self):",
            "        url = reverse('dashboard_load', args=['bogusdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Dashboard \\'bogusdashboard\\' does not exist. \"}')",
            "",
            "    def test_dashboard_load_existing(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_load', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"state\": {}}')",
            "",
            "    def test_dashboard_delete_nonexisting(self):",
            "        url = reverse('dashboard_delete', args=['bogusdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Dashboard \\'bogusdashboard\\' does not exist. \"}')",
            "",
            "    def test_dashboard_delete_existing(self):",
            "        # Create a dashboard entry",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        # Delete it",
            "        url = reverse('dashboard_delete', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "        # Confirm it was deleted",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_create_temporary(self):",
            "        url = reverse('dashboard_create_temporary')",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"name\": \"temporary-0\"}')",
            "",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"name\": \"temporary-1\"}')",
            "",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_template_pass_invalid(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_template_pass_valid(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_template', args=['testtemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_find_template_empty(self):",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": []}')",
            "",
            "    def test_dashboard_save_template(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        # Save again after it now exists",
            "    def test_dashboard_save_template_overwrite(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_find_template(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"test\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": [{\"name\": \"testtemplate\"}]}')",
            "",
            "    def test_dashboard_find_template_nonexistent(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"not here\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": []}')",
            "",
            "    def test_dashboard_load_template_nonexistent(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_load_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Template \\'bogustemplate\\' does not exist. \"}')",
            "",
            "    def test_dashboard_load_template_existing(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_load_template', args=['testtemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        data = json.loads(response.content)",
            "        graph_data = json.loads(self.testtemplate[\"state\"].replace('__VALUE__', 'testkey'))",
            "        self.assertEqual(data, json.loads('{\"state\": {\"name\": \"testtemplate/testkey\", \"graphs\": ' + json.dumps(graph_data['graphs']) + '}}'))",
            "",
            "    def test_dashboard_delete_template_nonexisting(self):",
            "        # Delete nonexistent template",
            "        url = reverse('dashboard_delete_template', args=['bogustemplate'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Template \\'bogustemplate\\' does not exist. \"}')",
            "",
            "    def test_dashboard_delete_template_existing(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_delete_template', args=['testtemplate'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": []}')",
            "",
            "    def test_dashboard_help(self):",
            "        url = reverse('dashboard_help')",
            "        request = {}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_email(self):",
            "        url = reverse('dashboard_email')",
            "        request = {\"sender\": \"noreply@localhost\",",
            "                   \"recipients\": \"noreply@localhost\",",
            "                   \"subject\": \"Test email\",",
            "                   \"message\": \"Here is the test graph\",",
            "                   \"graph_params\": '{\"target\":[\"sumSeries(a.b.c.d)\"],\"title\":\"Test\",\"width\":\"500\",\"from\":\"-55minutes\",\"until\":\"now\",\"height\":\"400\"}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "    @mock.patch('graphite.dashboard.views.renderView')",
            "    def test_dashboard_email_mock_renderView(self, rv):",
            "        url = reverse('dashboard_email')",
            "        request = {\"sender\": \"noreply@localhost\",",
            "                   \"recipients\": \"noreply@localhost\",",
            "                   \"subject\": \"Test email\",",
            "                   \"message\": \"Here is the test graph\",",
            "                   \"graph_params\": '{\"target\":[\"sumSeries(a.b.c.d)\"],\"title\":\"Test\",\"width\":\"500\",\"from\":\"-55minutes\",\"until\":\"now\",\"height\":\"400\"}'}",
            "        responseObject = HttpResponse()",
            "        responseObject.content = ''",
            "        rv.return_value = responseObject",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "    def test_dashboard_login_invalid_authenticate(self):",
            "        url = reverse('dashboard_login')",
            "        request = {\"username\": \"testuser\",",
            "                   \"password\": \"testpassword\"}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"errors\": {\"reason\": \"Username and/or password invalid.\"}, \"success\": false, \"text\": {}, \"permissions\": []}'))",
            "",
            "    @mock.patch('graphite.dashboard.views.authenticate')",
            "    def test_dashboard_login_valid_authenticate(self, authenticate):",
            "        url = reverse('dashboard_login')",
            "        request = {\"username\": \"testuser\",",
            "                   \"password\": \"testpassword\"}",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        authenticate.return_value = user",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"permissions\": [\"change\", \"delete\"], \"success\": true, \"text\": {}, \"errors\": {}}'))",
            "",
            "    @mock.patch('graphite.dashboard.views.authenticate')",
            "    def test_dashboard_login_valid_authenticate_not_active(self, authenticate):",
            "        url = reverse('dashboard_login')",
            "        request = {\"username\": \"testuser\",",
            "                   \"password\": \"testpassword\"}",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        user.is_active = False",
            "        authenticate.return_value = user",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"permissions\": [], \"success\": false, \"errors\": {\"reason\": \"Account disabled.\"}, \"text\": {}}'))",
            "",
            "    def test_dashboard_logout(self):",
            "        url = reverse('dashboard_logout')",
            "        request = {\"username\": \"testuser\"}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"errors\": {}, \"success\": true, \"text\": {}}'))",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_save_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to save\"}')",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_delete_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_delete', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to delete\"}')",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_save_template_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to save the template\"}')",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_delete_template_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_delete_template', args=['testtemplate'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to delete the template\"}')",
            "",
            "    def test_getPermissions_no_user(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=False",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        self.assertEqual(getPermissions(False), ['change', 'delete'])",
            "",
            "    def test_getPermissions_no_user_require_auth(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        self.assertEqual(getPermissions(False), [])",
            "",
            "    def test_getPermissions_valid_user(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), ['change', 'delete'])",
            "",
            "    def test_getPermissions_valid_user_require_perm(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=True",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), [])",
            "",
            "    def test_getPermissions_valid_user_edit_group(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=True",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), [])",
            "",
            "    def test_getPermissions_valid_user_require_perms_edit_group(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=True",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=True",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), [])"
        ],
        "afterPatchFile": [
            "import copy",
            "import errno",
            "import mock",
            "import os",
            "",
            "from . import TEST_CONF_DIR",
            "",
            "from django.conf import settings",
            "try:",
            "    from django.urls import reverse",
            "except ImportError:  # Django < 1.10",
            "    from django.core.urlresolvers import reverse",
            "from django.http import HttpResponse",
            "from .base import TestCase",
            "from django.test.utils import override_settings",
            "from graphite.util import json",
            "try:",
            "    from django.contrib.auth import get_user_model",
            "    User = get_user_model()",
            "except ImportError:",
            "    from django.contrib.auth.models import User",
            "",
            "from graphite.util import htmlEscape",
            "",
            "",
            "class DashboardTest(TestCase):",
            "    # Set config to the test config file",
            "    settings.DASHBOARD_CONF = os.path.join(TEST_CONF_DIR, 'dashboard.conf')",
            "",
            "    # Define a testtemplate",
            "    testtemplate = {\"state\": '{\"graphs\": [[ \"target=a.b.c.*.__VALUE__.d\", {  \"from\":\"-2days\", \"target\":[  \"a.b.c.*.__VALUE__.d\" ], \"until\":\"now\" }, \"/render?width=400&from=-2days&until=now&height=250&target=a.b.c.*.__VALUE__.d&_uniq=0.6526056618895382&title=a.b.c.*.__VALUE__.d\" ]]}'}",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing'))",
            "    def test_dashboard_missing_conf(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing'))",
            "    def test_dashboard_template_missing_template(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @mock.patch('graphite.dashboard.views.DashboardConfig.check')",
            "    def test_dashboard_conf_read_failure(self, check):",
            "        check.side_effect = OSError(errno.EPERM, 'Operation not permitted')",
            "        url = reverse('dashboard')",
            "        with self.assertRaises(Exception):",
            "            _ = self.client.get(url)",
            "",
            "    @mock.patch('graphite.dashboard.views.DashboardConfig.check')",
            "    def test_dashboard_template_conf_read_failure(self, check):",
            "        check.side_effect = OSError(errno.EPERM, 'Operation not permitted')",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        with self.assertRaises(Exception):",
            "            _ = self.client.get(url)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_ui'))",
            "    def test_dashboard_conf_missing_ui(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_ui'))",
            "    def test_dashboard_template_missing_ui(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_keyboard-shortcuts'))",
            "    def test_dashboard_conf_missing_keyboard_shortcuts(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.missing_keyboard-shortcuts'))",
            "    def test_dashboard_template_missing_keyboard_shortcuts(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.invalid_theme'))",
            "    def test_dashboard_conf_invalid_theme(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    @override_settings(DASHBOARD_CONF=os.path.join(TEST_CONF_DIR, 'dashboard.conf.invalid_theme'))",
            "    def test_dashboard_template_invalid_theme(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard(self):",
            "        url = reverse('dashboard')",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_no_user(self):",
            "        url = reverse('dashboard')",
            "        request = {\"user\": '', \"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_pass_valid(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_pass_invalid_name(self):",
            "        url = reverse('dashboard', args=['bogusdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_find_empty(self):",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_save_empty(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_save_overwrite(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_find_existing(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"test\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": [{\"name\": \"testdashboard\"}]}')",
            "",
            "    def test_dashboard_find_not_existing(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"not here\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_load_not_existing(self):",
            "        url = reverse('dashboard_load', args=['bogusdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Dashboard \\'bogusdashboard\\' does not exist. \"}')",
            "",
            "    def test_dashboard_load_existing(self):",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_load', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"state\": {}}')",
            "",
            "    def test_dashboard_delete_nonexisting(self):",
            "        url = reverse('dashboard_delete', args=['bogusdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Dashboard \\'bogusdashboard\\' does not exist. \"}')",
            "",
            "    def test_dashboard_delete_existing(self):",
            "        # Create a dashboard entry",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        # Delete it",
            "        url = reverse('dashboard_delete', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "        # Confirm it was deleted",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_create_temporary(self):",
            "        url = reverse('dashboard_create_temporary')",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"name\": \"temporary-0\"}')",
            "",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"name\": \"temporary-1\"}')",
            "",
            "        url = reverse('dashboard_find')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"dashboards\": []}')",
            "",
            "    def test_dashboard_template_pass_invalid(self):",
            "        url = reverse('dashboard_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_template_pass_valid(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_template', args=['testtemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_find_template_empty(self):",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": []}')",
            "",
            "    def test_dashboard_save_temporary_xss_name(self):",
            "        xssStr = htmlEscape('<img src=1 onerror=alert(1)>')",
            "        url = '/graphite/dashboard/save_template/' + xssStr + '/testkey'",
            "",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertContains(response, 'name contain restricted symbols', status_code=400)",
            "",
            "    def test_dashboard_save_temporary_xss_key(self):",
            "        xssStr = htmlEscape('<img src=1 onerror=alert(1)>')",
            "        url = '/graphite/dashboard/save_template/testtemplate/' + xssStr",
            "",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertContains(response, 'key contain restricted symbols', status_code=400)",
            "",
            "    def test_dashboard_save_template(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "    # Save again after it now exists",
            "    def test_dashboard_save_template_overwrite(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "    def test_dashboard_find_template(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"test\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": [{\"name\": \"testtemplate\"}]}')",
            "",
            "    def test_dashboard_find_template_nonexistent(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"not here\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": []}')",
            "",
            "    def test_dashboard_load_template_nonexistent(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_load_template', args=['bogustemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Template \\'bogustemplate\\' does not exist. \"}')",
            "",
            "    def test_dashboard_load_template_existing(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_load_template', args=['testtemplate', 'testkey'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        data = json.loads(response.content)",
            "        graph_data = json.loads(self.testtemplate[\"state\"].replace('__VALUE__', 'testkey'))",
            "        self.assertEqual(data, json.loads('{\"state\": {\"name\": \"testtemplate/testkey\", \"graphs\": ' + json.dumps(graph_data['graphs']) + '}}'))",
            "",
            "    def test_dashboard_delete_template_nonexisting(self):",
            "        # Delete nonexistent template",
            "        url = reverse('dashboard_delete_template', args=['bogustemplate'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Template \\'bogustemplate\\' does not exist. \"}')",
            "",
            "    def test_dashboard_delete_template_existing(self):",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "        url = reverse('dashboard_delete_template', args=['testtemplate'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "        url = reverse('dashboard_find_template')",
            "        request = {\"query\": \"\"}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"templates\": []}')",
            "",
            "    def test_dashboard_help(self):",
            "        url = reverse('dashboard_help')",
            "        request = {}",
            "        response = self.client.get(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "",
            "    def test_dashboard_email(self):",
            "        url = reverse('dashboard_email')",
            "        request = {\"sender\": \"noreply@localhost\",",
            "                   \"recipients\": \"noreply@localhost\",",
            "                   \"subject\": \"Test email\",",
            "                   \"message\": \"Here is the test graph\",",
            "                   \"graph_params\": '{\"target\":[\"sumSeries(a.b.c.d)\"],\"title\":\"Test\",\"width\":\"500\",\"from\":\"-55minutes\",\"until\":\"now\",\"height\":\"400\"}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "    @mock.patch('graphite.dashboard.views.renderView')",
            "    def test_dashboard_email_mock_renderView(self, rv):",
            "        url = reverse('dashboard_email')",
            "        request = {\"sender\": \"noreply@localhost\",",
            "                   \"recipients\": \"noreply@localhost\",",
            "                   \"subject\": \"Test email\",",
            "                   \"message\": \"Here is the test graph\",",
            "                   \"graph_params\": '{\"target\":[\"sumSeries(a.b.c.d)\"],\"title\":\"Test\",\"width\":\"500\",\"from\":\"-55minutes\",\"until\":\"now\",\"height\":\"400\"}'}",
            "        responseObject = HttpResponse()",
            "        responseObject.content = ''",
            "        rv.return_value = responseObject",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.content, b'{\"success\": true}')",
            "",
            "    def test_dashboard_login_invalid_authenticate(self):",
            "        url = reverse('dashboard_login')",
            "        request = {\"username\": \"testuser\",",
            "                   \"password\": \"testpassword\"}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"errors\": {\"reason\": \"Username and/or password invalid.\"}, \"success\": false, \"text\": {}, \"permissions\": []}'))",
            "",
            "    @mock.patch('graphite.dashboard.views.authenticate')",
            "    def test_dashboard_login_valid_authenticate(self, authenticate):",
            "        url = reverse('dashboard_login')",
            "        request = {\"username\": \"testuser\",",
            "                   \"password\": \"testpassword\"}",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        authenticate.return_value = user",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"permissions\": [\"change\", \"delete\"], \"success\": true, \"text\": {}, \"errors\": {}}'))",
            "",
            "    @mock.patch('graphite.dashboard.views.authenticate')",
            "    def test_dashboard_login_valid_authenticate_not_active(self, authenticate):",
            "        url = reverse('dashboard_login')",
            "        request = {\"username\": \"testuser\",",
            "                   \"password\": \"testpassword\"}",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        user.is_active = False",
            "        authenticate.return_value = user",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"permissions\": [], \"success\": false, \"errors\": {\"reason\": \"Account disabled.\"}, \"text\": {}}'))",
            "",
            "    def test_dashboard_logout(self):",
            "        url = reverse('dashboard_logout')",
            "        request = {\"username\": \"testuser\"}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(json.loads(response.content), json.loads('{\"errors\": {}, \"success\": true, \"text\": {}}'))",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_save_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_save', args=['testdashboard'])",
            "        request = {\"state\": '{}'}",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to save\"}')",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_delete_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_delete', args=['testdashboard'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to delete\"}')",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_save_template_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_save_template', args=['testtemplate', 'testkey'])",
            "        request = copy.deepcopy(self.testtemplate)",
            "        response = self.client.post(url, request)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to save the template\"}')",
            "",
            "    @mock.patch('graphite.dashboard.views.getPermissions')",
            "    def test_dashboard_delete_template_no_permissions(self, gp):",
            "        gp.return_value = [None]",
            "        url = reverse('dashboard_delete_template', args=['testtemplate'])",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.content, b'{\"error\": \"Must be logged in with appropriate permissions to delete the template\"}')",
            "",
            "    def test_getPermissions_no_user(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=False",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        self.assertEqual(getPermissions(False), ['change', 'delete'])",
            "",
            "    def test_getPermissions_no_user_require_auth(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        self.assertEqual(getPermissions(False), [])",
            "",
            "    def test_getPermissions_valid_user(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), ['change', 'delete'])",
            "",
            "    def test_getPermissions_valid_user_require_perm(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=True",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=False",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), [])",
            "",
            "    def test_getPermissions_valid_user_edit_group(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=False",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=True",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), [])",
            "",
            "    def test_getPermissions_valid_user_require_perms_edit_group(self):",
            "        settings.DASHBOARD_REQUIRE_AUTHENTICATION=True",
            "        settings.DASHBOARD_REQUIRE_PERMISSIONS=True",
            "        settings.DASHBOARD_REQUIRE_EDIT_GROUP=True",
            "        from graphite.dashboard.views import getPermissions",
            "        user = User.objects.create(email='testuser@test.com')",
            "        user.backend = ''",
            "        self.assertEqual(getPermissions(user), [])"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "253": [
                "DashboardTest"
            ]
        },
        "addLocation": [
            "webapp.tests.test_dashboard.DashboardTest.testtemplate",
            "webapp.tests.test_dashboard.DashboardTest.self",
            "flower.command"
        ]
    }
}