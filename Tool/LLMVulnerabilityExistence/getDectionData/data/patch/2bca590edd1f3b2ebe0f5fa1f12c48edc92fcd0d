{
    "flask_appbuilder/cli.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from io import BytesIO"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " import os"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import shutil"
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from typing import Optional"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from typing import Optional, Union"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from urllib.request import urlopen"
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from zipfile import ZipFile"
            },
            "7": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 150,
                "PatchRowcode": " @fab.command(\"export-roles\")"
            },
            "9": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 151,
                "PatchRowcode": " @with_appcontext"
            },
            "10": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": 152,
                "PatchRowcode": " @click.option(\"--path\", \"-path\", help=\"Specify filepath to export roles to\")"
            },
            "11": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def export_roles(path: Optional[str] = None) -> None:"
            },
            "12": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    \"\"\" Exports roles with permissions and view menus to JSON file \"\"\""
            },
            "13": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    current_app.appbuilder.sm.export_roles(path)"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+@click.option(\"--indent\", help=\"Specify indent of generated JSON file\")"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+def export_roles("
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+    path: Optional[str] = None, indent: Optional[Union[int, str]] = None"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+) -> None:"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+    \"\"\"Exports roles with permissions and view menus to JSON file\"\"\""
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+    # Cast negative numbers to int (as they're passed as str from CLI)"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 159,
                "PatchRowcode": "+    try:"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 160,
                "PatchRowcode": "+        indent = int(indent)"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+    except TypeError:"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+        # Don't cast None"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+        pass"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+    except ValueError:"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+        # Don't cast non-int-like strings"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 166,
                "PatchRowcode": "+        pass"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 167,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 168,
                "PatchRowcode": "+    current_app.appbuilder.sm.export_roles(path=path, indent=indent)"
            },
            "30": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 169,
                "PatchRowcode": " "
            },
            "31": {
                "beforePatchRowNumber": 157,
                "afterPatchRowNumber": 170,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 158,
                "afterPatchRowNumber": 171,
                "PatchRowcode": " @fab.command(\"import-roles\")"
            }
        },
        "frontPatchFile": [
            "from io import BytesIO",
            "import os",
            "import shutil",
            "from typing import Optional",
            "from urllib.request import urlopen",
            "from zipfile import ZipFile",
            "",
            "import click",
            "from flask import current_app",
            "from flask.cli import with_appcontext",
            "",
            "from .const import AUTH_DB, AUTH_LDAP, AUTH_OAUTH, AUTH_OID, AUTH_REMOTE_USER",
            "",
            "",
            "SQLA_REPO_URL = (",
            "    \"https://github.com/dpgaspar/Flask-AppBuilder-Skeleton/archive/master.zip\"",
            ")",
            "MONGOENGIE_REPO_URL = (",
            "    \"https://github.com/dpgaspar/Flask-AppBuilder-Skeleton-me/archive/master.zip\"",
            ")",
            "ADDON_REPO_URL = (",
            "    \"https://github.com/dpgaspar/Flask-AppBuilder-Skeleton-AddOn/archive/master.zip\"",
            ")",
            "",
            "",
            "def echo_header(title):",
            "    click.echo(click.style(title, fg=\"green\"))",
            "    click.echo(click.style(\"-\" * len(title), fg=\"green\"))",
            "",
            "",
            "@click.group()",
            "def fab():",
            "    \"\"\" FAB flask group commands\"\"\"",
            "    pass",
            "",
            "",
            "@fab.command(\"create-admin\")",
            "@click.option(\"--username\", default=\"admin\", prompt=\"Username\")",
            "@click.option(\"--firstname\", default=\"admin\", prompt=\"User first name\")",
            "@click.option(\"--lastname\", default=\"user\", prompt=\"User last name\")",
            "@click.option(\"--email\", default=\"admin@fab.org\", prompt=\"Email\")",
            "@click.password_option()",
            "@with_appcontext",
            "def create_admin(username, firstname, lastname, email, password):",
            "    \"\"\"",
            "        Creates an admin user",
            "    \"\"\"",
            "    auth_type = {",
            "        AUTH_DB: \"Database Authentications\",",
            "        AUTH_OID: \"OpenID Authentication\",",
            "        AUTH_LDAP: \"LDAP Authentication\",",
            "        AUTH_REMOTE_USER: \"WebServer REMOTE_USER Authentication\",",
            "        AUTH_OAUTH: \"OAuth Authentication\",",
            "    }",
            "    click.echo(",
            "        click.style(",
            "            \"Recognized {0}.\".format(",
            "                auth_type.get(current_app.appbuilder.sm.auth_type, \"No Auth method\")",
            "            ),",
            "            fg=\"green\",",
            "        )",
            "    )",
            "    user = current_app.appbuilder.sm.find_user(username=username)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    user = current_app.appbuilder.sm.find_user(email=email)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    role_admin = current_app.appbuilder.sm.find_role(",
            "        current_app.appbuilder.sm.auth_role_admin",
            "    )",
            "    user = current_app.appbuilder.sm.add_user(",
            "        username, firstname, lastname, email, role_admin, password",
            "    )",
            "    if user:",
            "        click.echo(click.style(\"Admin User {0} created.\".format(username), fg=\"green\"))",
            "    else:",
            "        click.echo(click.style(\"No user created an error occured\", fg=\"red\"))",
            "",
            "",
            "@fab.command(\"create-user\")",
            "@click.option(\"--role\", default=\"Public\", prompt=\"Role\")",
            "@click.option(\"--username\", prompt=\"Username\")",
            "@click.option(\"--firstname\", prompt=\"User first name\")",
            "@click.option(\"--lastname\", prompt=\"User last name\")",
            "@click.option(\"--email\", prompt=\"Email\")",
            "@click.password_option()",
            "@with_appcontext",
            "def create_user(role, username, firstname, lastname, email, password):",
            "    \"\"\"",
            "        Create a user",
            "    \"\"\"",
            "    user = current_app.appbuilder.sm.find_user(username=username)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    user = current_app.appbuilder.sm.find_user(email=email)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    role_object = current_app.appbuilder.sm.find_role(role)",
            "    if not role_object:",
            "        click.echo(click.style(f\"Error! Role not found {role}\", fg=\"red\"))",
            "        return",
            "    user = current_app.appbuilder.sm.add_user(",
            "        username, firstname, lastname, email, role_object, password",
            "    )",
            "    if user:",
            "        click.echo(click.style(\"User {0} created.\".format(username), fg=\"green\"))",
            "    else:",
            "        click.echo(click.style(\"Error! No user created\", fg=\"red\"))",
            "",
            "",
            "@fab.command(\"reset-password\")",
            "@click.option(",
            "    \"--username\",",
            "    default=\"admin\",",
            "    prompt=\"The username\",",
            "    help=\"Resets the password for a particular user.\",",
            ")",
            "@click.password_option()",
            "@with_appcontext",
            "def reset_password(username, password):",
            "    \"\"\"",
            "        Resets a user's password",
            "    \"\"\"",
            "    user = current_app.appbuilder.sm.find_user(username=username)",
            "    if not user:",
            "        click.echo(\"User {0} not found.\".format(username))",
            "    else:",
            "        current_app.appbuilder.sm.reset_password(user.id, password)",
            "        click.echo(click.style(\"User {0} reseted.\".format(username), fg=\"green\"))",
            "",
            "",
            "@fab.command(\"create-db\")",
            "@with_appcontext",
            "def create_db():",
            "    \"\"\"",
            "        Create all your database objects (SQLAlchemy specific).",
            "    \"\"\"",
            "    from flask_appbuilder.models.sqla import Model",
            "",
            "    engine = current_app.appbuilder.get_session.get_bind(mapper=None, clause=None)",
            "    Model.metadata.create_all(engine)",
            "    click.echo(click.style(\"DB objects created\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"export-roles\")",
            "@with_appcontext",
            "@click.option(\"--path\", \"-path\", help=\"Specify filepath to export roles to\")",
            "def export_roles(path: Optional[str] = None) -> None:",
            "    \"\"\" Exports roles with permissions and view menus to JSON file \"\"\"",
            "    current_app.appbuilder.sm.export_roles(path)",
            "",
            "",
            "@fab.command(\"import-roles\")",
            "@with_appcontext",
            "@click.option(",
            "    \"--path\", \"-p\", help=\"Path to a JSON file containing roles\", required=True",
            ")",
            "def import_roles(path: str) -> None:",
            "    \"\"\" Imports roles with permissions and view menus from JSON file \"\"\"",
            "    current_app.appbuilder.sm.import_roles(path)",
            "",
            "",
            "@fab.command(\"version\")",
            "@with_appcontext",
            "def version():",
            "    \"\"\"",
            "        Flask-AppBuilder package version",
            "    \"\"\"",
            "    click.echo(",
            "        click.style(",
            "            \"F.A.B Version: {0}.\".format(current_app.appbuilder.version),",
            "            bg=\"blue\",",
            "            fg=\"white\",",
            "        )",
            "    )",
            "",
            "",
            "@fab.command(\"security-cleanup\")",
            "@with_appcontext",
            "def security_cleanup():",
            "    \"\"\"",
            "        Cleanup unused permissions from views and roles.",
            "    \"\"\"",
            "    current_app.appbuilder.security_cleanup()",
            "    click.echo(click.style(\"Finished security cleanup\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"security-converge\")",
            "@click.option(",
            "    \"--dry-run\", \"-d\", is_flag=True, help=\"Dry run & print state transitions.\"",
            ")",
            "@with_appcontext",
            "def security_converge(dry_run=False):",
            "    \"\"\"",
            "        Converges security deletes previous_class_permission_name",
            "    \"\"\"",
            "    state_transitions = current_app.appbuilder.security_converge(dry=dry_run)",
            "    if dry_run:",
            "        click.echo(click.style(\"Computed security converge:\", fg=\"green\"))",
            "        click.echo(click.style(\"Add to Roles:\", fg=\"green\"))",
            "        for _from, _to in state_transitions[\"add\"].items():",
            "            click.echo(f\"Where {_from} add {_to}\")",
            "        click.echo(click.style(\"Del from Roles:\", fg=\"green\"))",
            "        for pvm in state_transitions[\"del_role_pvm\"]:",
            "            click.echo(pvm)",
            "        click.echo(click.style(\"Remove views:\", fg=\"green\"))",
            "        for views in state_transitions[\"del_views\"]:",
            "            click.echo(views)",
            "        click.echo(click.style(\"Remove permissions:\", fg=\"green\"))",
            "        for perms in state_transitions[\"del_perms\"]:",
            "            click.echo(perms)",
            "    else:",
            "        click.echo(click.style(\"Finished security converge\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"create-permissions\")",
            "@with_appcontext",
            "def create_permissions():",
            "    \"\"\"",
            "        Creates all permissions and add them to the ADMIN Role.",
            "    \"\"\"",
            "    current_app.appbuilder.add_permissions(update_perms=True)",
            "    click.echo(click.style(\"Created all permissions\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"list-views\")",
            "@with_appcontext",
            "def list_views():",
            "    \"\"\"",
            "        List all registered views",
            "    \"\"\"",
            "    echo_header(\"List of registered views\")",
            "    for view in current_app.appbuilder.baseviews:",
            "        click.echo(",
            "            \"View:{0} | Route:{1} | Perms:{2}\".format(",
            "                view.__class__.__name__, view.route_base, view.base_permissions",
            "            )",
            "        )",
            "",
            "",
            "@fab.command(\"list-users\")",
            "@with_appcontext",
            "def list_users():",
            "    \"\"\"",
            "        List all users on the database",
            "    \"\"\"",
            "    echo_header(\"List of users\")",
            "    for user in current_app.appbuilder.sm.get_all_users():",
            "        click.echo(",
            "            \"username:{0} | email:{1} | role:{2}\".format(",
            "                user.username, user.email, user.roles",
            "            )",
            "        )",
            "",
            "",
            "@fab.command(\"create-app\")",
            "@click.option(",
            "    \"--name\",",
            "    prompt=\"Your new app name\",",
            "    help=\"Your application name, directory will have this name\",",
            ")",
            "@click.option(",
            "    \"--engine\",",
            "    prompt=\"Your engine type, SQLAlchemy or MongoEngine\",",
            "    type=click.Choice([\"SQLAlchemy\", \"MongoEngine\"]),",
            "    default=\"SQLAlchemy\",",
            "    help=\"Write your engine type\",",
            ")",
            "def create_app(name, engine):",
            "    \"\"\"",
            "        Create a Skeleton application (needs internet connection to github)",
            "    \"\"\"",
            "    try:",
            "        if engine.lower() == \"sqlalchemy\":",
            "            url = urlopen(SQLA_REPO_URL)",
            "            dirname = \"Flask-AppBuilder-Skeleton-master\"",
            "        elif engine.lower() == \"mongoengine\":",
            "            url = urlopen(MONGOENGIE_REPO_URL)",
            "            dirname = \"Flask-AppBuilder-Skeleton-me-master\"",
            "        zipfile = ZipFile(BytesIO(url.read()))",
            "        zipfile.extractall()",
            "        os.rename(dirname, name)",
            "        click.echo(click.style(\"Downloaded the skeleton app, good coding!\", fg=\"green\"))",
            "        return True",
            "    except Exception as e:",
            "        click.echo(click.style(\"Something went wrong {0}\".format(e), fg=\"red\"))",
            "        if engine.lower() == \"sqlalchemy\":",
            "            click.echo(",
            "                click.style(",
            "                    \"Try downloading from {0}\".format(SQLA_REPO_URL), fg=\"green\"",
            "                )",
            "            )",
            "        elif engine.lower() == \"mongoengine\":",
            "            click.echo(",
            "                click.style(",
            "                    \"Try downloading from {0}\".format(MONGOENGIE_REPO_URL), fg=\"green\"",
            "                )",
            "            )",
            "        return False",
            "",
            "",
            "@fab.command(\"create-addon\")",
            "@click.option(",
            "    \"--name\",",
            "    prompt=\"Your new addon name\",",
            "    help=\"Your addon name will be prefixed by fab_addon_, directory will have this name\",",
            ")",
            "def create_addon(name):",
            "    \"\"\"",
            "        Create a Skeleton AddOn (needs internet connection to github)",
            "    \"\"\"",
            "    try:",
            "        full_name = \"fab_addon_\" + name",
            "        dirname = \"Flask-AppBuilder-Skeleton-AddOn-master\"",
            "        url = urlopen(ADDON_REPO_URL)",
            "        zipfile = ZipFile(BytesIO(url.read()))",
            "        zipfile.extractall()",
            "        os.rename(dirname, full_name)",
            "        addon_path = os.path.join(full_name, full_name)",
            "        os.rename(os.path.join(full_name, \"fab_addon\"), addon_path)",
            "        f = open(os.path.join(full_name, \"config.py\"), \"w\")",
            "        f.write(\"ADDON_NAME='\" + name + \"'\\n\")",
            "        f.write(\"FULL_ADDON_NAME='fab_addon_' + ADDON_NAME\\n\")",
            "        f.close()",
            "        click.echo(",
            "            click.style(\"Downloaded the skeleton addon, good coding!\", fg=\"green\")",
            "        )",
            "        return True",
            "    except Exception as e:",
            "        click.echo(click.style(\"Something went wrong {0}\".format(e), fg=\"red\"))",
            "        return False",
            "",
            "",
            "@fab.command(\"collect-static\")",
            "@click.option(",
            "    \"--static_folder\", default=\"app/static\", help=\"Your projects static folder\"",
            ")",
            "def collect_static(static_folder):",
            "    \"\"\"",
            "        Copies flask-appbuilder static files to your projects static folder",
            "    \"\"\"",
            "    appbuilder_static_path = os.path.join(",
            "        os.path.dirname(os.path.abspath(__file__)), \"static/appbuilder\"",
            "    )",
            "    app_static_path = os.path.join(os.getcwd(), static_folder)",
            "    if not os.path.isdir(app_static_path):",
            "        click.echo(",
            "            click.style(",
            "                \"Static folder does not exist creating: %s\" % app_static_path,",
            "                fg=\"green\",",
            "            )",
            "        )",
            "        os.makedirs(app_static_path)",
            "    try:",
            "        shutil.copytree(",
            "            appbuilder_static_path, os.path.join(app_static_path, \"appbuilder\")",
            "        )",
            "    except Exception:",
            "        click.echo(",
            "            click.style(",
            "                \"Appbuilder static folder already exists on your project\", fg=\"red\"",
            "            )",
            "        )",
            "",
            "",
            "@fab.command(\"babel-extract\")",
            "@click.option(\"--config\", default=\"./babel/babel.cfg\")",
            "@click.option(\"--input\", default=\".\")",
            "@click.option(\"--output\", default=\"./babel/messages.pot\")",
            "@click.option(\"--target\", default=\"app/translations\")",
            "@click.option(",
            "    \"--keywords\", \"-k\", multiple=True, default=[\"lazy_gettext\", \"gettext\", \"_\", \"__\"]",
            ")",
            "def babel_extract(config, input, output, target, keywords):",
            "    \"\"\"",
            "        Babel, Extracts and updates all messages marked for translation",
            "    \"\"\"",
            "    click.echo(",
            "        click.style(",
            "            \"Starting Extractions config:{0} input:{1} output:{2} keywords:{3}\".format(",
            "                config, input, output, keywords",
            "            ),",
            "            fg=\"green\",",
            "        )",
            "    )",
            "    keywords = \" -k \".join(keywords)",
            "    os.popen(",
            "        \"pybabel extract -F {0} -k {1} -o {2} {3}\".format(",
            "            config, keywords, output, input",
            "        )",
            "    )",
            "    click.echo(click.style(\"Starting Update target:{0}\".format(target), fg=\"green\"))",
            "    os.popen(\"pybabel update -N -i {0} -d {1}\".format(output, target))",
            "    click.echo(click.style(\"Finish, you can start your translations\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"babel-compile\")",
            "@click.option(",
            "    \"--target\",",
            "    default=\"app/translations\",",
            "    help=\"The target directory where translations reside\",",
            ")",
            "def babel_compile(target):",
            "    \"\"\"",
            "        Babel, Compiles all translations",
            "    \"\"\"",
            "    click.echo(click.style(\"Starting Compile target:{0}\".format(target), fg=\"green\"))",
            "    os.popen(\"pybabel compile -f -d {0}\".format(target))"
        ],
        "afterPatchFile": [
            "from io import BytesIO",
            "import os",
            "import shutil",
            "from typing import Optional, Union",
            "from urllib.request import urlopen",
            "from zipfile import ZipFile",
            "",
            "import click",
            "from flask import current_app",
            "from flask.cli import with_appcontext",
            "",
            "from .const import AUTH_DB, AUTH_LDAP, AUTH_OAUTH, AUTH_OID, AUTH_REMOTE_USER",
            "",
            "",
            "SQLA_REPO_URL = (",
            "    \"https://github.com/dpgaspar/Flask-AppBuilder-Skeleton/archive/master.zip\"",
            ")",
            "MONGOENGIE_REPO_URL = (",
            "    \"https://github.com/dpgaspar/Flask-AppBuilder-Skeleton-me/archive/master.zip\"",
            ")",
            "ADDON_REPO_URL = (",
            "    \"https://github.com/dpgaspar/Flask-AppBuilder-Skeleton-AddOn/archive/master.zip\"",
            ")",
            "",
            "",
            "def echo_header(title):",
            "    click.echo(click.style(title, fg=\"green\"))",
            "    click.echo(click.style(\"-\" * len(title), fg=\"green\"))",
            "",
            "",
            "@click.group()",
            "def fab():",
            "    \"\"\" FAB flask group commands\"\"\"",
            "    pass",
            "",
            "",
            "@fab.command(\"create-admin\")",
            "@click.option(\"--username\", default=\"admin\", prompt=\"Username\")",
            "@click.option(\"--firstname\", default=\"admin\", prompt=\"User first name\")",
            "@click.option(\"--lastname\", default=\"user\", prompt=\"User last name\")",
            "@click.option(\"--email\", default=\"admin@fab.org\", prompt=\"Email\")",
            "@click.password_option()",
            "@with_appcontext",
            "def create_admin(username, firstname, lastname, email, password):",
            "    \"\"\"",
            "        Creates an admin user",
            "    \"\"\"",
            "    auth_type = {",
            "        AUTH_DB: \"Database Authentications\",",
            "        AUTH_OID: \"OpenID Authentication\",",
            "        AUTH_LDAP: \"LDAP Authentication\",",
            "        AUTH_REMOTE_USER: \"WebServer REMOTE_USER Authentication\",",
            "        AUTH_OAUTH: \"OAuth Authentication\",",
            "    }",
            "    click.echo(",
            "        click.style(",
            "            \"Recognized {0}.\".format(",
            "                auth_type.get(current_app.appbuilder.sm.auth_type, \"No Auth method\")",
            "            ),",
            "            fg=\"green\",",
            "        )",
            "    )",
            "    user = current_app.appbuilder.sm.find_user(username=username)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    user = current_app.appbuilder.sm.find_user(email=email)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    role_admin = current_app.appbuilder.sm.find_role(",
            "        current_app.appbuilder.sm.auth_role_admin",
            "    )",
            "    user = current_app.appbuilder.sm.add_user(",
            "        username, firstname, lastname, email, role_admin, password",
            "    )",
            "    if user:",
            "        click.echo(click.style(\"Admin User {0} created.\".format(username), fg=\"green\"))",
            "    else:",
            "        click.echo(click.style(\"No user created an error occured\", fg=\"red\"))",
            "",
            "",
            "@fab.command(\"create-user\")",
            "@click.option(\"--role\", default=\"Public\", prompt=\"Role\")",
            "@click.option(\"--username\", prompt=\"Username\")",
            "@click.option(\"--firstname\", prompt=\"User first name\")",
            "@click.option(\"--lastname\", prompt=\"User last name\")",
            "@click.option(\"--email\", prompt=\"Email\")",
            "@click.password_option()",
            "@with_appcontext",
            "def create_user(role, username, firstname, lastname, email, password):",
            "    \"\"\"",
            "        Create a user",
            "    \"\"\"",
            "    user = current_app.appbuilder.sm.find_user(username=username)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    user = current_app.appbuilder.sm.find_user(email=email)",
            "    if user:",
            "        click.echo(click.style(f\"Error! User already exists {username}\", fg=\"red\"))",
            "        return",
            "    role_object = current_app.appbuilder.sm.find_role(role)",
            "    if not role_object:",
            "        click.echo(click.style(f\"Error! Role not found {role}\", fg=\"red\"))",
            "        return",
            "    user = current_app.appbuilder.sm.add_user(",
            "        username, firstname, lastname, email, role_object, password",
            "    )",
            "    if user:",
            "        click.echo(click.style(\"User {0} created.\".format(username), fg=\"green\"))",
            "    else:",
            "        click.echo(click.style(\"Error! No user created\", fg=\"red\"))",
            "",
            "",
            "@fab.command(\"reset-password\")",
            "@click.option(",
            "    \"--username\",",
            "    default=\"admin\",",
            "    prompt=\"The username\",",
            "    help=\"Resets the password for a particular user.\",",
            ")",
            "@click.password_option()",
            "@with_appcontext",
            "def reset_password(username, password):",
            "    \"\"\"",
            "        Resets a user's password",
            "    \"\"\"",
            "    user = current_app.appbuilder.sm.find_user(username=username)",
            "    if not user:",
            "        click.echo(\"User {0} not found.\".format(username))",
            "    else:",
            "        current_app.appbuilder.sm.reset_password(user.id, password)",
            "        click.echo(click.style(\"User {0} reseted.\".format(username), fg=\"green\"))",
            "",
            "",
            "@fab.command(\"create-db\")",
            "@with_appcontext",
            "def create_db():",
            "    \"\"\"",
            "        Create all your database objects (SQLAlchemy specific).",
            "    \"\"\"",
            "    from flask_appbuilder.models.sqla import Model",
            "",
            "    engine = current_app.appbuilder.get_session.get_bind(mapper=None, clause=None)",
            "    Model.metadata.create_all(engine)",
            "    click.echo(click.style(\"DB objects created\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"export-roles\")",
            "@with_appcontext",
            "@click.option(\"--path\", \"-path\", help=\"Specify filepath to export roles to\")",
            "@click.option(\"--indent\", help=\"Specify indent of generated JSON file\")",
            "def export_roles(",
            "    path: Optional[str] = None, indent: Optional[Union[int, str]] = None",
            ") -> None:",
            "    \"\"\"Exports roles with permissions and view menus to JSON file\"\"\"",
            "    # Cast negative numbers to int (as they're passed as str from CLI)",
            "    try:",
            "        indent = int(indent)",
            "    except TypeError:",
            "        # Don't cast None",
            "        pass",
            "    except ValueError:",
            "        # Don't cast non-int-like strings",
            "        pass",
            "",
            "    current_app.appbuilder.sm.export_roles(path=path, indent=indent)",
            "",
            "",
            "@fab.command(\"import-roles\")",
            "@with_appcontext",
            "@click.option(",
            "    \"--path\", \"-p\", help=\"Path to a JSON file containing roles\", required=True",
            ")",
            "def import_roles(path: str) -> None:",
            "    \"\"\" Imports roles with permissions and view menus from JSON file \"\"\"",
            "    current_app.appbuilder.sm.import_roles(path)",
            "",
            "",
            "@fab.command(\"version\")",
            "@with_appcontext",
            "def version():",
            "    \"\"\"",
            "        Flask-AppBuilder package version",
            "    \"\"\"",
            "    click.echo(",
            "        click.style(",
            "            \"F.A.B Version: {0}.\".format(current_app.appbuilder.version),",
            "            bg=\"blue\",",
            "            fg=\"white\",",
            "        )",
            "    )",
            "",
            "",
            "@fab.command(\"security-cleanup\")",
            "@with_appcontext",
            "def security_cleanup():",
            "    \"\"\"",
            "        Cleanup unused permissions from views and roles.",
            "    \"\"\"",
            "    current_app.appbuilder.security_cleanup()",
            "    click.echo(click.style(\"Finished security cleanup\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"security-converge\")",
            "@click.option(",
            "    \"--dry-run\", \"-d\", is_flag=True, help=\"Dry run & print state transitions.\"",
            ")",
            "@with_appcontext",
            "def security_converge(dry_run=False):",
            "    \"\"\"",
            "        Converges security deletes previous_class_permission_name",
            "    \"\"\"",
            "    state_transitions = current_app.appbuilder.security_converge(dry=dry_run)",
            "    if dry_run:",
            "        click.echo(click.style(\"Computed security converge:\", fg=\"green\"))",
            "        click.echo(click.style(\"Add to Roles:\", fg=\"green\"))",
            "        for _from, _to in state_transitions[\"add\"].items():",
            "            click.echo(f\"Where {_from} add {_to}\")",
            "        click.echo(click.style(\"Del from Roles:\", fg=\"green\"))",
            "        for pvm in state_transitions[\"del_role_pvm\"]:",
            "            click.echo(pvm)",
            "        click.echo(click.style(\"Remove views:\", fg=\"green\"))",
            "        for views in state_transitions[\"del_views\"]:",
            "            click.echo(views)",
            "        click.echo(click.style(\"Remove permissions:\", fg=\"green\"))",
            "        for perms in state_transitions[\"del_perms\"]:",
            "            click.echo(perms)",
            "    else:",
            "        click.echo(click.style(\"Finished security converge\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"create-permissions\")",
            "@with_appcontext",
            "def create_permissions():",
            "    \"\"\"",
            "        Creates all permissions and add them to the ADMIN Role.",
            "    \"\"\"",
            "    current_app.appbuilder.add_permissions(update_perms=True)",
            "    click.echo(click.style(\"Created all permissions\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"list-views\")",
            "@with_appcontext",
            "def list_views():",
            "    \"\"\"",
            "        List all registered views",
            "    \"\"\"",
            "    echo_header(\"List of registered views\")",
            "    for view in current_app.appbuilder.baseviews:",
            "        click.echo(",
            "            \"View:{0} | Route:{1} | Perms:{2}\".format(",
            "                view.__class__.__name__, view.route_base, view.base_permissions",
            "            )",
            "        )",
            "",
            "",
            "@fab.command(\"list-users\")",
            "@with_appcontext",
            "def list_users():",
            "    \"\"\"",
            "        List all users on the database",
            "    \"\"\"",
            "    echo_header(\"List of users\")",
            "    for user in current_app.appbuilder.sm.get_all_users():",
            "        click.echo(",
            "            \"username:{0} | email:{1} | role:{2}\".format(",
            "                user.username, user.email, user.roles",
            "            )",
            "        )",
            "",
            "",
            "@fab.command(\"create-app\")",
            "@click.option(",
            "    \"--name\",",
            "    prompt=\"Your new app name\",",
            "    help=\"Your application name, directory will have this name\",",
            ")",
            "@click.option(",
            "    \"--engine\",",
            "    prompt=\"Your engine type, SQLAlchemy or MongoEngine\",",
            "    type=click.Choice([\"SQLAlchemy\", \"MongoEngine\"]),",
            "    default=\"SQLAlchemy\",",
            "    help=\"Write your engine type\",",
            ")",
            "def create_app(name, engine):",
            "    \"\"\"",
            "        Create a Skeleton application (needs internet connection to github)",
            "    \"\"\"",
            "    try:",
            "        if engine.lower() == \"sqlalchemy\":",
            "            url = urlopen(SQLA_REPO_URL)",
            "            dirname = \"Flask-AppBuilder-Skeleton-master\"",
            "        elif engine.lower() == \"mongoengine\":",
            "            url = urlopen(MONGOENGIE_REPO_URL)",
            "            dirname = \"Flask-AppBuilder-Skeleton-me-master\"",
            "        zipfile = ZipFile(BytesIO(url.read()))",
            "        zipfile.extractall()",
            "        os.rename(dirname, name)",
            "        click.echo(click.style(\"Downloaded the skeleton app, good coding!\", fg=\"green\"))",
            "        return True",
            "    except Exception as e:",
            "        click.echo(click.style(\"Something went wrong {0}\".format(e), fg=\"red\"))",
            "        if engine.lower() == \"sqlalchemy\":",
            "            click.echo(",
            "                click.style(",
            "                    \"Try downloading from {0}\".format(SQLA_REPO_URL), fg=\"green\"",
            "                )",
            "            )",
            "        elif engine.lower() == \"mongoengine\":",
            "            click.echo(",
            "                click.style(",
            "                    \"Try downloading from {0}\".format(MONGOENGIE_REPO_URL), fg=\"green\"",
            "                )",
            "            )",
            "        return False",
            "",
            "",
            "@fab.command(\"create-addon\")",
            "@click.option(",
            "    \"--name\",",
            "    prompt=\"Your new addon name\",",
            "    help=\"Your addon name will be prefixed by fab_addon_, directory will have this name\",",
            ")",
            "def create_addon(name):",
            "    \"\"\"",
            "        Create a Skeleton AddOn (needs internet connection to github)",
            "    \"\"\"",
            "    try:",
            "        full_name = \"fab_addon_\" + name",
            "        dirname = \"Flask-AppBuilder-Skeleton-AddOn-master\"",
            "        url = urlopen(ADDON_REPO_URL)",
            "        zipfile = ZipFile(BytesIO(url.read()))",
            "        zipfile.extractall()",
            "        os.rename(dirname, full_name)",
            "        addon_path = os.path.join(full_name, full_name)",
            "        os.rename(os.path.join(full_name, \"fab_addon\"), addon_path)",
            "        f = open(os.path.join(full_name, \"config.py\"), \"w\")",
            "        f.write(\"ADDON_NAME='\" + name + \"'\\n\")",
            "        f.write(\"FULL_ADDON_NAME='fab_addon_' + ADDON_NAME\\n\")",
            "        f.close()",
            "        click.echo(",
            "            click.style(\"Downloaded the skeleton addon, good coding!\", fg=\"green\")",
            "        )",
            "        return True",
            "    except Exception as e:",
            "        click.echo(click.style(\"Something went wrong {0}\".format(e), fg=\"red\"))",
            "        return False",
            "",
            "",
            "@fab.command(\"collect-static\")",
            "@click.option(",
            "    \"--static_folder\", default=\"app/static\", help=\"Your projects static folder\"",
            ")",
            "def collect_static(static_folder):",
            "    \"\"\"",
            "        Copies flask-appbuilder static files to your projects static folder",
            "    \"\"\"",
            "    appbuilder_static_path = os.path.join(",
            "        os.path.dirname(os.path.abspath(__file__)), \"static/appbuilder\"",
            "    )",
            "    app_static_path = os.path.join(os.getcwd(), static_folder)",
            "    if not os.path.isdir(app_static_path):",
            "        click.echo(",
            "            click.style(",
            "                \"Static folder does not exist creating: %s\" % app_static_path,",
            "                fg=\"green\",",
            "            )",
            "        )",
            "        os.makedirs(app_static_path)",
            "    try:",
            "        shutil.copytree(",
            "            appbuilder_static_path, os.path.join(app_static_path, \"appbuilder\")",
            "        )",
            "    except Exception:",
            "        click.echo(",
            "            click.style(",
            "                \"Appbuilder static folder already exists on your project\", fg=\"red\"",
            "            )",
            "        )",
            "",
            "",
            "@fab.command(\"babel-extract\")",
            "@click.option(\"--config\", default=\"./babel/babel.cfg\")",
            "@click.option(\"--input\", default=\".\")",
            "@click.option(\"--output\", default=\"./babel/messages.pot\")",
            "@click.option(\"--target\", default=\"app/translations\")",
            "@click.option(",
            "    \"--keywords\", \"-k\", multiple=True, default=[\"lazy_gettext\", \"gettext\", \"_\", \"__\"]",
            ")",
            "def babel_extract(config, input, output, target, keywords):",
            "    \"\"\"",
            "        Babel, Extracts and updates all messages marked for translation",
            "    \"\"\"",
            "    click.echo(",
            "        click.style(",
            "            \"Starting Extractions config:{0} input:{1} output:{2} keywords:{3}\".format(",
            "                config, input, output, keywords",
            "            ),",
            "            fg=\"green\",",
            "        )",
            "    )",
            "    keywords = \" -k \".join(keywords)",
            "    os.popen(",
            "        \"pybabel extract -F {0} -k {1} -o {2} {3}\".format(",
            "            config, keywords, output, input",
            "        )",
            "    )",
            "    click.echo(click.style(\"Starting Update target:{0}\".format(target), fg=\"green\"))",
            "    os.popen(\"pybabel update -N -i {0} -d {1}\".format(output, target))",
            "    click.echo(click.style(\"Finish, you can start your translations\", fg=\"green\"))",
            "",
            "",
            "@fab.command(\"babel-compile\")",
            "@click.option(",
            "    \"--target\",",
            "    default=\"app/translations\",",
            "    help=\"The target directory where translations reside\",",
            ")",
            "def babel_compile(target):",
            "    \"\"\"",
            "        Babel, Compiles all translations",
            "    \"\"\"",
            "    click.echo(click.style(\"Starting Compile target:{0}\".format(target), fg=\"green\"))",
            "    os.popen(\"pybabel compile -f -d {0}\".format(target))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "4": [],
            "153": [
                "export_roles"
            ],
            "154": [
                "export_roles"
            ],
            "155": [
                "export_roles"
            ]
        },
        "addLocation": []
    },
    "flask_appbuilder/security/manager.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import json"
            },
            "1": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import logging"
            },
            "2": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import re"
            },
            "3": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from typing import Any, Dict, List, Optional, Set, Tuple"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from typing import Any, Dict, List, Optional, Set, Tuple, Union"
            },
            "5": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from flask import g, session, url_for"
            },
            "7": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from flask_babel import lazy_gettext as _"
            },
            "8": {
                "beforePatchRowNumber": 2023,
                "afterPatchRowNumber": 2023,
                "PatchRowcode": "         \"\"\""
            },
            "9": {
                "beforePatchRowNumber": 2024,
                "afterPatchRowNumber": 2024,
                "PatchRowcode": "         raise NotImplementedError"
            },
            "10": {
                "beforePatchRowNumber": 2025,
                "afterPatchRowNumber": 2025,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": 2026,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def export_roles(self, path: Optional[str] = None) -> None:"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 2026,
                "PatchRowcode": "+    def export_roles("
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 2027,
                "PatchRowcode": "+        self, path: Optional[str] = None, indent: Optional[Union[int, str]] = None"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 2028,
                "PatchRowcode": "+    ) -> None:"
            },
            "15": {
                "beforePatchRowNumber": 2027,
                "afterPatchRowNumber": 2029,
                "PatchRowcode": "         \"\"\" Exports roles to JSON file. \"\"\""
            },
            "16": {
                "beforePatchRowNumber": 2028,
                "afterPatchRowNumber": 2030,
                "PatchRowcode": "         raise NotImplementedError"
            },
            "17": {
                "beforePatchRowNumber": 2029,
                "afterPatchRowNumber": 2031,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "import base64",
            "import datetime",
            "import json",
            "import logging",
            "import re",
            "from typing import Any, Dict, List, Optional, Set, Tuple",
            "",
            "from flask import g, session, url_for",
            "from flask_babel import lazy_gettext as _",
            "from flask_jwt_extended import current_user as current_user_jwt",
            "from flask_jwt_extended import JWTManager",
            "from flask_login import current_user, LoginManager",
            "from werkzeug.security import check_password_hash, generate_password_hash",
            "",
            "from .api import SecurityApi",
            "from .registerviews import (",
            "    RegisterUserDBView,",
            "    RegisterUserOAuthView,",
            "    RegisterUserOIDView,",
            ")",
            "from .views import (",
            "    AuthDBView,",
            "    AuthLDAPView,",
            "    AuthOAuthView,",
            "    AuthOIDView,",
            "    AuthRemoteUserView,",
            "    PermissionModelView,",
            "    PermissionViewModelView,",
            "    RegisterUserModelView,",
            "    ResetMyPasswordView,",
            "    ResetPasswordView,",
            "    RoleModelView,",
            "    UserDBModelView,",
            "    UserInfoEditView,",
            "    UserLDAPModelView,",
            "    UserOAuthModelView,",
            "    UserOIDModelView,",
            "    UserRemoteUserModelView,",
            "    UserStatsChartView,",
            "    ViewMenuModelView,",
            ")",
            "from ..basemanager import BaseManager",
            "from ..const import (",
            "    AUTH_DB,",
            "    AUTH_LDAP,",
            "    AUTH_OAUTH,",
            "    AUTH_OID,",
            "    AUTH_REMOTE_USER,",
            "    LOGMSG_ERR_SEC_ADD_REGISTER_USER,",
            "    LOGMSG_ERR_SEC_AUTH_LDAP,",
            "    LOGMSG_ERR_SEC_AUTH_LDAP_TLS,",
            "    LOGMSG_WAR_SEC_LOGIN_FAILED,",
            "    LOGMSG_WAR_SEC_NO_USER,",
            "    LOGMSG_WAR_SEC_NOLDAP_OBJ,",
            "    PERMISSION_PREFIX,",
            ")",
            "",
            "log = logging.getLogger(__name__)",
            "",
            "",
            "class AbstractSecurityManager(BaseManager):",
            "    \"\"\"",
            "        Abstract SecurityManager class, declares all methods used by the",
            "        framework. There is no assumptions about security models or auth types.",
            "    \"\"\"",
            "",
            "    def add_permissions_view(self, base_permissions, view_menu):",
            "        \"\"\"",
            "            Adds a permission on a view menu to the backend",
            "",
            "            :param base_permissions:",
            "                list of permissions from view (all exposed methods):",
            "                 'can_add','can_edit' etc...",
            "            :param view_menu:",
            "                name of the view or menu to add",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_permissions_menu(self, view_menu_name):",
            "        \"\"\"",
            "            Adds menu_access to menu on permission_view_menu",
            "",
            "            :param view_menu_name:",
            "                The menu name",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def register_views(self):",
            "        \"\"\"",
            "            Generic function to create the security views",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def is_item_public(self, permission_name, view_name):",
            "        \"\"\"",
            "            Check if view has public permissions",
            "",
            "            :param permission_name:",
            "                the permission: can_show, can_edit...",
            "            :param view_name:",
            "                the name of the class view (child of BaseView)",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def has_access(self, permission_name, view_name):",
            "        \"\"\"",
            "            Check if current user or public has access to view or menu",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def security_cleanup(self, baseviews, menus):",
            "        raise NotImplementedError",
            "",
            "    def get_first_user(self):",
            "        raise NotImplementedError",
            "",
            "    def noop_user_update(self, user) -> None:",
            "        raise NotImplementedError",
            "",
            "",
            "def _oauth_tokengetter(token=None):",
            "    \"\"\"",
            "        Default function to return the current user oauth token",
            "        from session cookie.",
            "    \"\"\"",
            "    token = session.get(\"oauth\")",
            "    log.debug(\"Token Get: {0}\".format(token))",
            "    return token",
            "",
            "",
            "class BaseSecurityManager(AbstractSecurityManager):",
            "    auth_view = None",
            "    \"\"\" The obj instance for authentication view \"\"\"",
            "    user_view = None",
            "    \"\"\" The obj instance for user view \"\"\"",
            "    registeruser_view = None",
            "    \"\"\" The obj instance for registering user view \"\"\"",
            "    lm = None",
            "    \"\"\" Flask-Login LoginManager \"\"\"",
            "    jwt_manager = None",
            "    \"\"\" Flask-JWT-Extended \"\"\"",
            "    oid = None",
            "    \"\"\" Flask-OpenID OpenID \"\"\"",
            "    oauth = None",
            "    \"\"\" Flask-OAuth \"\"\"",
            "    oauth_remotes = None",
            "    \"\"\" OAuth email whitelists \"\"\"",
            "    oauth_whitelists = {}",
            "    \"\"\" Initialized (remote_app) providers dict {'provider_name', OBJ } \"\"\"",
            "    oauth_tokengetter = _oauth_tokengetter",
            "    \"\"\" OAuth tokengetter function override to implement your own tokengetter method \"\"\"",
            "    oauth_user_info = None",
            "",
            "    user_model = None",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    role_model = None",
            "    \"\"\" Override to set your own Role Model \"\"\"",
            "    permission_model = None",
            "    \"\"\" Override to set your own Permission Model \"\"\"",
            "    viewmenu_model = None",
            "    \"\"\" Override to set your own ViewMenu Model \"\"\"",
            "    permissionview_model = None",
            "    \"\"\" Override to set your own PermissionView Model \"\"\"",
            "    registeruser_model = None",
            "    \"\"\" Override to set your own RegisterUser Model \"\"\"",
            "",
            "    userdbmodelview = UserDBModelView",
            "    \"\"\" Override if you want your own user db view \"\"\"",
            "    userldapmodelview = UserLDAPModelView",
            "    \"\"\" Override if you want your own user ldap view \"\"\"",
            "    useroidmodelview = UserOIDModelView",
            "    \"\"\" Override if you want your own user OID view \"\"\"",
            "    useroauthmodelview = UserOAuthModelView",
            "    \"\"\" Override if you want your own user OAuth view \"\"\"",
            "    userremoteusermodelview = UserRemoteUserModelView",
            "    \"\"\" Override if you want your own user REMOTE_USER view \"\"\"",
            "    registerusermodelview = RegisterUserModelView",
            "",
            "    authdbview = AuthDBView",
            "    \"\"\" Override if you want your own Authentication DB view \"\"\"",
            "    authldapview = AuthLDAPView",
            "    \"\"\" Override if you want your own Authentication LDAP view \"\"\"",
            "    authoidview = AuthOIDView",
            "    \"\"\" Override if you want your own Authentication OID view \"\"\"",
            "    authoauthview = AuthOAuthView",
            "    \"\"\" Override if you want your own Authentication OAuth view \"\"\"",
            "    authremoteuserview = AuthRemoteUserView",
            "    \"\"\" Override if you want your own Authentication REMOTE_USER view \"\"\"",
            "",
            "    registeruserdbview = RegisterUserDBView",
            "    \"\"\" Override if you want your own register user db view \"\"\"",
            "    registeruseroidview = RegisterUserOIDView",
            "    \"\"\" Override if you want your own register user OpenID view \"\"\"",
            "    registeruseroauthview = RegisterUserOAuthView",
            "    \"\"\" Override if you want your own register user OAuth view \"\"\"",
            "",
            "    resetmypasswordview = ResetMyPasswordView",
            "    \"\"\" Override if you want your own reset my password view \"\"\"",
            "    resetpasswordview = ResetPasswordView",
            "    \"\"\" Override if you want your own reset password view \"\"\"",
            "    userinfoeditview = UserInfoEditView",
            "    \"\"\" Override if you want your own User information edit view \"\"\"",
            "",
            "    # API",
            "    security_api = SecurityApi",
            "    \"\"\" Override if you want your own Security API login endpoint \"\"\"",
            "",
            "    rolemodelview = RoleModelView",
            "    permissionmodelview = PermissionModelView",
            "    userstatschartview = UserStatsChartView",
            "    viewmenumodelview = ViewMenuModelView",
            "    permissionviewmodelview = PermissionViewModelView",
            "",
            "    def __init__(self, appbuilder):",
            "        super(BaseSecurityManager, self).__init__(appbuilder)",
            "        app = self.appbuilder.get_app",
            "        # Base Security Config",
            "        app.config.setdefault(\"AUTH_ROLE_ADMIN\", \"Admin\")",
            "        app.config.setdefault(\"AUTH_ROLE_PUBLIC\", \"Public\")",
            "        app.config.setdefault(\"AUTH_TYPE\", AUTH_DB)",
            "        # Self Registration",
            "        app.config.setdefault(\"AUTH_USER_REGISTRATION\", False)",
            "        app.config.setdefault(\"AUTH_USER_REGISTRATION_ROLE\", self.auth_role_public)",
            "        app.config.setdefault(\"AUTH_USER_REGISTRATION_ROLE_JMESPATH\", None)",
            "        # Role Mapping",
            "        app.config.setdefault(\"AUTH_ROLES_MAPPING\", {})",
            "        app.config.setdefault(\"AUTH_ROLES_SYNC_AT_LOGIN\", False)",
            "        app.config.setdefault(\"AUTH_API_LOGIN_ALLOW_MULTIPLE_PROVIDERS\", False)",
            "",
            "        # LDAP Config",
            "        if self.auth_type == AUTH_LDAP:",
            "            if \"AUTH_LDAP_SERVER\" not in app.config:",
            "                raise Exception(",
            "                    \"No AUTH_LDAP_SERVER defined on config\"",
            "                    \" with AUTH_LDAP authentication type.\"",
            "                )",
            "            app.config.setdefault(\"AUTH_LDAP_SEARCH\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_SEARCH_FILTER\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_APPEND_DOMAIN\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_USERNAME_FORMAT\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_BIND_USER\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_BIND_PASSWORD\", \"\")",
            "            # TLS options",
            "            app.config.setdefault(\"AUTH_LDAP_USE_TLS\", False)",
            "            app.config.setdefault(\"AUTH_LDAP_ALLOW_SELF_SIGNED\", False)",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_DEMAND\", False)",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_CACERTDIR\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_CACERTFILE\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_CERTFILE\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_KEYFILE\", \"\")",
            "            # Mapping options",
            "            app.config.setdefault(\"AUTH_LDAP_UID_FIELD\", \"uid\")",
            "            app.config.setdefault(\"AUTH_LDAP_GROUP_FIELD\", \"memberOf\")",
            "            app.config.setdefault(\"AUTH_LDAP_FIRSTNAME_FIELD\", \"givenName\")",
            "            app.config.setdefault(\"AUTH_LDAP_LASTNAME_FIELD\", \"sn\")",
            "            app.config.setdefault(\"AUTH_LDAP_EMAIL_FIELD\", \"mail\")",
            "",
            "        if self.auth_type == AUTH_OID:",
            "            from flask_openid import OpenID",
            "",
            "            self.oid = OpenID(app)",
            "        if self.auth_type == AUTH_OAUTH:",
            "            from authlib.integrations.flask_client import OAuth",
            "",
            "            self.oauth = OAuth(app)",
            "            self.oauth_remotes = dict()",
            "            for _provider in self.oauth_providers:",
            "                provider_name = _provider[\"name\"]",
            "                log.debug(\"OAuth providers init {0}\".format(provider_name))",
            "                obj_provider = self.oauth.register(",
            "                    provider_name, **_provider[\"remote_app\"]",
            "                )",
            "                obj_provider._tokengetter = self.oauth_tokengetter",
            "                if not self.oauth_user_info:",
            "                    self.oauth_user_info = self.get_oauth_user_info",
            "                # Whitelist only users with matching emails",
            "                if \"whitelist\" in _provider:",
            "                    self.oauth_whitelists[provider_name] = _provider[\"whitelist\"]",
            "                self.oauth_remotes[provider_name] = obj_provider",
            "",
            "        self._builtin_roles = self.create_builtin_roles()",
            "        # Setup Flask-Login",
            "        self.lm = self.create_login_manager(app)",
            "",
            "        # Setup Flask-Jwt-Extended",
            "        self.jwt_manager = self.create_jwt_manager(app)",
            "",
            "    def create_login_manager(self, app) -> LoginManager:",
            "        \"\"\"",
            "            Override to implement your custom login manager instance",
            "",
            "            :param app: Flask app",
            "        \"\"\"",
            "        lm = LoginManager(app)",
            "        lm.login_view = \"login\"",
            "        lm.user_loader(self.load_user)",
            "        return lm",
            "",
            "    def create_jwt_manager(self, app) -> JWTManager:",
            "        \"\"\"",
            "            Override to implement your custom JWT manager instance",
            "",
            "            :param app: Flask app",
            "        \"\"\"",
            "        jwt_manager = JWTManager()",
            "        jwt_manager.init_app(app)",
            "        jwt_manager.user_loader_callback_loader(self.load_user_jwt)",
            "        return jwt_manager",
            "",
            "    def create_builtin_roles(self):",
            "        return self.appbuilder.get_app.config.get(\"FAB_ROLES\", {})",
            "",
            "    def get_roles_from_keys(self, role_keys: List[str]) -> Set[role_model]:",
            "        \"\"\"",
            "        Construct a list of FAB role objects, from a list of keys.",
            "",
            "        NOTE:",
            "        - keys are things like: \"LDAP group DNs\" or \"OAUTH group names\"",
            "        - we use AUTH_ROLES_MAPPING to map from keys, to FAB role names",
            "",
            "        :param role_keys: the list of FAB role keys",
            "        :return: a list of RoleModelView",
            "        \"\"\"",
            "        _roles = set()",
            "        _role_keys = set(role_keys)",
            "        for role_key, fab_role_names in self.auth_roles_mapping.items():",
            "            if role_key in _role_keys:",
            "                for fab_role_name in fab_role_names:",
            "                    fab_role = self.find_role(fab_role_name)",
            "                    if fab_role:",
            "                        _roles.add(fab_role)",
            "                    else:",
            "                        log.warning(",
            "                            \"Can't find role specified in AUTH_ROLES_MAPPING: {0}\".format(",
            "                                fab_role_name",
            "                            )",
            "                        )",
            "        return _roles",
            "",
            "    @property",
            "    def auth_type_provider_name(self) -> Optional[str]:",
            "        provider_to_auth_type = {AUTH_DB: \"db\", AUTH_LDAP: \"ldap\"}",
            "        return provider_to_auth_type.get(self.auth_type)",
            "",
            "    @property",
            "    def get_url_for_registeruser(self):",
            "        return url_for(",
            "            \"%s.%s\"",
            "            % (self.registeruser_view.endpoint, self.registeruser_view.default_view)",
            "        )",
            "",
            "    @property",
            "    def get_user_datamodel(self):",
            "        return self.user_view.datamodel",
            "",
            "    @property",
            "    def get_register_user_datamodel(self):",
            "        return self.registerusermodelview.datamodel",
            "",
            "    @property",
            "    def builtin_roles(self) -> Dict[str, Any]:",
            "        return self._builtin_roles",
            "",
            "    @property",
            "    def api_login_allow_multiple_providers(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_API_LOGIN_ALLOW_MULTIPLE_PROVIDERS\"]",
            "",
            "    @property",
            "    def auth_type(self) -> int:",
            "        return self.appbuilder.get_app.config[\"AUTH_TYPE\"]",
            "",
            "    @property",
            "    def auth_username_ci(self) -> str:",
            "        return self.appbuilder.get_app.config.get(\"AUTH_USERNAME_CI\", True)",
            "",
            "    @property",
            "    def auth_role_admin(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLE_ADMIN\"]",
            "",
            "    @property",
            "    def auth_role_public(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLE_PUBLIC\"]",
            "",
            "    @property",
            "    def auth_ldap_server(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_SERVER\"]",
            "",
            "    @property",
            "    def auth_ldap_use_tls(self) -> bool:",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_USE_TLS\"]",
            "",
            "    @property",
            "    def auth_user_registration(self) -> bool:",
            "        return self.appbuilder.get_app.config[\"AUTH_USER_REGISTRATION\"]",
            "",
            "    @property",
            "    def auth_user_registration_role(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_USER_REGISTRATION_ROLE\"]",
            "",
            "    @property",
            "    def auth_user_registration_role_jmespath(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_USER_REGISTRATION_ROLE_JMESPATH\"]",
            "",
            "    @property",
            "    def auth_roles_mapping(self) -> Dict[str, List[str]]:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLES_MAPPING\"]",
            "",
            "    @property",
            "    def auth_roles_sync_at_login(self) -> bool:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLES_SYNC_AT_LOGIN\"]",
            "",
            "    @property",
            "    def auth_ldap_search(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_SEARCH\"]",
            "",
            "    @property",
            "    def auth_ldap_search_filter(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_SEARCH_FILTER\"]",
            "",
            "    @property",
            "    def auth_ldap_bind_user(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_BIND_USER\"]",
            "",
            "    @property",
            "    def auth_ldap_bind_password(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_BIND_PASSWORD\"]",
            "",
            "    @property",
            "    def auth_ldap_append_domain(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_APPEND_DOMAIN\"]",
            "",
            "    @property",
            "    def auth_ldap_username_format(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_USERNAME_FORMAT\"]",
            "",
            "    @property",
            "    def auth_ldap_uid_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_UID_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_group_field(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_GROUP_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_firstname_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_FIRSTNAME_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_lastname_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_LASTNAME_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_email_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_EMAIL_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_bind_first(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_BIND_FIRST\"]",
            "",
            "    @property",
            "    def auth_ldap_allow_self_signed(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_ALLOW_SELF_SIGNED\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_demand(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_DEMAND\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_cacertdir(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_CACERTDIR\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_cacertfile(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_CACERTFILE\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_certfile(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_CERTFILE\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_keyfile(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_KEYFILE\"]",
            "",
            "    @property",
            "    def openid_providers(self):",
            "        return self.appbuilder.get_app.config[\"OPENID_PROVIDERS\"]",
            "",
            "    @property",
            "    def oauth_providers(self):",
            "        return self.appbuilder.get_app.config[\"OAUTH_PROVIDERS\"]",
            "",
            "    @property",
            "    def current_user(self):",
            "        if current_user.is_authenticated:",
            "            return g.user",
            "        elif current_user_jwt:",
            "            return current_user_jwt",
            "",
            "    def oauth_user_info_getter(self, f):",
            "        \"\"\"",
            "            Decorator function to be the OAuth user info getter",
            "            for all the providers, receives provider and response",
            "            return a dict with the information returned from the provider.",
            "            The returned user info dict should have it's keys with the same",
            "            name as the User Model.",
            "",
            "            Use it like this an example for GitHub ::",
            "",
            "                @appbuilder.sm.oauth_user_info_getter",
            "                def my_oauth_user_info(sm, provider, response=None):",
            "                    if provider == 'github':",
            "                        me = sm.oauth_remotes[provider].get('user')",
            "                        return {'username': me.data.get('login')}",
            "                    else:",
            "                        return {}",
            "        \"\"\"",
            "",
            "        def wraps(provider, response=None):",
            "            ret = f(self, provider, response=response)",
            "            # Checks if decorator is well behaved and returns a dict as supposed.",
            "            if not type(ret) == dict:",
            "                log.error(",
            "                    \"OAuth user info decorated function \"",
            "                    \"did not returned a dict, but: {0}\".format(type(ret))",
            "                )",
            "                return {}",
            "            return ret",
            "",
            "        self.oauth_user_info = wraps",
            "        return wraps",
            "",
            "    def get_oauth_token_key_name(self, provider):",
            "        \"\"\"",
            "            Returns the token_key name for the oauth provider",
            "            if none is configured defaults to oauth_token",
            "            this is configured using OAUTH_PROVIDERS and token_key key.",
            "        \"\"\"",
            "        for _provider in self.oauth_providers:",
            "            if _provider[\"name\"] == provider:",
            "                return _provider.get(\"token_key\", \"oauth_token\")",
            "",
            "    def get_oauth_token_secret_name(self, provider):",
            "        \"\"\"",
            "            Returns the token_secret name for the oauth provider",
            "            if none is configured defaults to oauth_secret",
            "            this is configured using OAUTH_PROVIDERS and token_secret",
            "        \"\"\"",
            "        for _provider in self.oauth_providers:",
            "            if _provider[\"name\"] == provider:",
            "                return _provider.get(\"token_secret\", \"oauth_token_secret\")",
            "",
            "    def set_oauth_session(self, provider, oauth_response):",
            "        \"\"\"",
            "            Set the current session with OAuth user secrets",
            "        \"\"\"",
            "        # Get this provider key names for token_key and token_secret",
            "        token_key = self.appbuilder.sm.get_oauth_token_key_name(provider)",
            "        token_secret = self.appbuilder.sm.get_oauth_token_secret_name(provider)",
            "        # Save users token on encrypted session cookie",
            "        session[\"oauth\"] = (",
            "            oauth_response[token_key],",
            "            oauth_response.get(token_secret, \"\"),",
            "        )",
            "        session[\"oauth_provider\"] = provider",
            "",
            "    def get_oauth_user_info(self, provider, resp):",
            "        \"\"\"",
            "            Since there are different OAuth API's with different ways to",
            "            retrieve user info",
            "        \"\"\"",
            "        # for GITHUB",
            "        if provider == \"github\" or provider == \"githublocal\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"user\")",
            "            data = me.json()",
            "            log.debug(\"User info from Github: {0}\".format(data))",
            "            return {\"username\": \"github_\" + data.get(\"login\")}",
            "        # for twitter",
            "        if provider == \"twitter\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"account/settings.json\")",
            "            data = me.json()",
            "            log.debug(\"User info from Twitter: {0}\".format(data))",
            "            return {\"username\": \"twitter_\" + data.get(\"screen_name\", \"\")}",
            "        # for linkedin",
            "        if provider == \"linkedin\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(",
            "                \"people/~:(id,email-address,first-name,last-name)?format=json\"",
            "            )",
            "            data = me.json()",
            "            log.debug(\"User info from Linkedin: {0}\".format(data))",
            "            return {",
            "                \"username\": \"linkedin_\" + data.get(\"id\", \"\"),",
            "                \"email\": data.get(\"email-address\", \"\"),",
            "                \"first_name\": data.get(\"firstName\", \"\"),",
            "                \"last_name\": data.get(\"lastName\", \"\"),",
            "            }",
            "        # for Google",
            "        if provider == \"google\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"userinfo\")",
            "            data = me.json()",
            "            log.debug(\"User info from Google: {0}\".format(data))",
            "            return {",
            "                \"username\": \"google_\" + data.get(\"id\", \"\"),",
            "                \"first_name\": data.get(\"given_name\", \"\"),",
            "                \"last_name\": data.get(\"family_name\", \"\"),",
            "                \"email\": data.get(\"email\", \"\"),",
            "            }",
            "        # for Azure AD Tenant. Azure OAuth response contains",
            "        # JWT token which has user info.",
            "        # JWT token needs to be base64 decoded.",
            "        # https://docs.microsoft.com/en-us/azure/active-directory/develop/",
            "        # active-directory-protocols-oauth-code",
            "        if provider == \"azure\":",
            "            log.debug(\"Azure response received : {0}\".format(resp))",
            "            id_token = resp[\"id_token\"]",
            "            log.debug(str(id_token))",
            "            me = self._azure_jwt_token_parse(id_token)",
            "            log.debug(\"Parse JWT token : {0}\".format(me))",
            "            return {",
            "                \"name\": me.get(\"name\", \"\"),",
            "                \"email\": me[\"upn\"],",
            "                \"first_name\": me.get(\"given_name\", \"\"),",
            "                \"last_name\": me.get(\"family_name\", \"\"),",
            "                \"id\": me[\"oid\"],",
            "                \"username\": me[\"oid\"],",
            "                \"role_keys\": me.get(\"roles\", []),",
            "            }",
            "        # for OpenShift",
            "        if provider == \"openshift\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(",
            "                \"apis/user.openshift.io/v1/users/~\"",
            "            )",
            "            data = me.json()",
            "            log.debug(\"User info from OpenShift: {0}\".format(data))",
            "            return {\"username\": \"openshift_\" + data.get(\"metadata\").get(\"name\")}",
            "        # for Okta",
            "        if provider == \"okta\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"userinfo\")",
            "            data = me.json()",
            "            log.debug(\"User info from Okta: %s\", data)",
            "            return {",
            "                \"username\": \"okta_\" + data.get(\"sub\", \"\"),",
            "                \"first_name\": data.get(\"given_name\", \"\"),",
            "                \"last_name\": data.get(\"family_name\", \"\"),",
            "                \"email\": data.get(\"email\", \"\"),",
            "                \"role_keys\": data.get(\"groups\", []),",
            "            }",
            "        else:",
            "            return {}",
            "",
            "    def _azure_parse_jwt(self, id_token):",
            "        jwt_token_parts = r\"^([^\\.\\s]*)\\.([^\\.\\s]+)\\.([^\\.\\s]*)$\"",
            "        matches = re.search(jwt_token_parts, id_token)",
            "        if not matches or len(matches.groups()) < 3:",
            "            log.error(\"Unable to parse token.\")",
            "            return {}",
            "        return {",
            "            \"header\": matches.group(1),",
            "            \"Payload\": matches.group(2),",
            "            \"Sig\": matches.group(3),",
            "        }",
            "",
            "    def _azure_jwt_token_parse(self, id_token):",
            "        jwt_split_token = self._azure_parse_jwt(id_token)",
            "        if not jwt_split_token:",
            "            return",
            "",
            "        jwt_payload = jwt_split_token[\"Payload\"]",
            "        # Prepare for base64 decoding",
            "        payload_b64_string = jwt_payload",
            "        payload_b64_string += \"=\" * (4 - ((len(jwt_payload) % 4)))",
            "        decoded_payload = base64.urlsafe_b64decode(payload_b64_string.encode(\"ascii\"))",
            "",
            "        if not decoded_payload:",
            "            log.error(\"Payload of id_token could not be base64 url decoded.\")",
            "            return",
            "",
            "        jwt_decoded_payload = json.loads(decoded_payload.decode(\"utf-8\"))",
            "",
            "        return jwt_decoded_payload",
            "",
            "    def register_views(self):",
            "        if not self.appbuilder.app.config.get(\"FAB_ADD_SECURITY_VIEWS\", True):",
            "            return",
            "        # Security APIs",
            "        self.appbuilder.add_api(self.security_api)",
            "",
            "        if self.auth_user_registration:",
            "            if self.auth_type == AUTH_DB:",
            "                self.registeruser_view = self.registeruserdbview()",
            "            elif self.auth_type == AUTH_OID:",
            "                self.registeruser_view = self.registeruseroidview()",
            "            elif self.auth_type == AUTH_OAUTH:",
            "                self.registeruser_view = self.registeruseroauthview()",
            "            if self.registeruser_view:",
            "                self.appbuilder.add_view_no_menu(self.registeruser_view)",
            "",
            "        self.appbuilder.add_view_no_menu(self.resetpasswordview())",
            "        self.appbuilder.add_view_no_menu(self.resetmypasswordview())",
            "        self.appbuilder.add_view_no_menu(self.userinfoeditview())",
            "",
            "        if self.auth_type == AUTH_DB:",
            "            self.user_view = self.userdbmodelview",
            "            self.auth_view = self.authdbview()",
            "",
            "        elif self.auth_type == AUTH_LDAP:",
            "            self.user_view = self.userldapmodelview",
            "            self.auth_view = self.authldapview()",
            "        elif self.auth_type == AUTH_OAUTH:",
            "            self.user_view = self.useroauthmodelview",
            "            self.auth_view = self.authoauthview()",
            "        elif self.auth_type == AUTH_REMOTE_USER:",
            "            self.user_view = self.userremoteusermodelview",
            "            self.auth_view = self.authremoteuserview()",
            "        else:",
            "            self.user_view = self.useroidmodelview",
            "            self.auth_view = self.authoidview()",
            "            if self.auth_user_registration:",
            "                pass",
            "                # self.registeruser_view = self.registeruseroidview()",
            "                # self.appbuilder.add_view_no_menu(self.registeruser_view)",
            "",
            "        self.appbuilder.add_view_no_menu(self.auth_view)",
            "",
            "        self.user_view = self.appbuilder.add_view(",
            "            self.user_view,",
            "            \"List Users\",",
            "            icon=\"fa-user\",",
            "            label=_(\"List Users\"),",
            "            category=\"Security\",",
            "            category_icon=\"fa-cogs\",",
            "            category_label=_(\"Security\"),",
            "        )",
            "",
            "        role_view = self.appbuilder.add_view(",
            "            self.rolemodelview,",
            "            \"List Roles\",",
            "            icon=\"fa-group\",",
            "            label=_(\"List Roles\"),",
            "            category=\"Security\",",
            "            category_icon=\"fa-cogs\",",
            "        )",
            "        role_view.related_views = [self.user_view.__class__]",
            "",
            "        if self.userstatschartview:",
            "            self.appbuilder.add_view(",
            "                self.userstatschartview,",
            "                \"User's Statistics\",",
            "                icon=\"fa-bar-chart-o\",",
            "                label=_(\"User's Statistics\"),",
            "                category=\"Security\",",
            "            )",
            "        if self.auth_user_registration:",
            "            self.appbuilder.add_view(",
            "                self.registerusermodelview,",
            "                \"User's Statistics\",",
            "                icon=\"fa-user-plus\",",
            "                label=_(\"User Registrations\"),",
            "                category=\"Security\",",
            "            )",
            "        self.appbuilder.menu.add_separator(\"Security\")",
            "        if self.appbuilder.app.config.get(\"FAB_ADD_SECURITY_PERMISSION_VIEW\", True):",
            "            self.appbuilder.add_view(",
            "                self.permissionmodelview,",
            "                \"Base Permissions\",",
            "                icon=\"fa-lock\",",
            "                label=_(\"Base Permissions\"),",
            "                category=\"Security\",",
            "            )",
            "        if self.appbuilder.app.config.get(\"FAB_ADD_SECURITY_VIEW_MENU_VIEW\", True):",
            "            self.appbuilder.add_view(",
            "                self.viewmenumodelview,",
            "                \"Views/Menus\",",
            "                icon=\"fa-list-alt\",",
            "                label=_(\"Views/Menus\"),",
            "                category=\"Security\",",
            "            )",
            "        if self.appbuilder.app.config.get(",
            "            \"FAB_ADD_SECURITY_PERMISSION_VIEWS_VIEW\", True",
            "        ):",
            "            self.appbuilder.add_view(",
            "                self.permissionviewmodelview,",
            "                \"Permission on Views/Menus\",",
            "                icon=\"fa-link\",",
            "                label=_(\"Permission on Views/Menus\"),",
            "                category=\"Security\",",
            "            )",
            "",
            "    def create_db(self):",
            "        \"\"\"",
            "            Setups the DB, creates admin and public roles if they don't exist.",
            "        \"\"\"",
            "        roles_mapping = self.appbuilder.get_app.config.get(\"FAB_ROLES_MAPPING\", {})",
            "        for pk, name in roles_mapping.items():",
            "            self.update_role(pk, name)",
            "        for role_name, permission_view_menus in self.builtin_roles.items():",
            "            permission_view_menus = [",
            "                self.add_permission_view_menu(permission_name, view_menu_name)",
            "                for view_menu_name, permission_name in permission_view_menus",
            "            ]",
            "            self.add_role(name=role_name, permissions=permission_view_menus)",
            "        if self.auth_role_admin not in self.builtin_roles:",
            "            self.add_role(self.auth_role_admin)",
            "        self.add_role(self.auth_role_public)",
            "        if self.count_users() == 0:",
            "            log.warning(LOGMSG_WAR_SEC_NO_USER)",
            "",
            "    def reset_password(self, userid, password):",
            "        \"\"\"",
            "            Change/Reset a user's password for authdb.",
            "            Password will be hashed and saved.",
            "",
            "            :param userid:",
            "                the user.id to reset the password",
            "            :param password:",
            "                The clear text password to reset and save hashed on the db",
            "        \"\"\"",
            "        user = self.get_user_by_id(userid)",
            "        user.password = generate_password_hash(password)",
            "        self.update_user(user)",
            "",
            "    def update_user_auth_stat(self, user, success=True):",
            "        \"\"\"",
            "        Update user authentication stats upon successful/unsuccessful",
            "        authentication attempts.",
            "",
            "        :param user:",
            "            The identified (but possibly not successfully authenticated) user",
            "            model",
            "        :param success:",
            "        :type success: bool or None",
            "            Defaults to true, if true increments login_count, updates",
            "            last_login, and resets fail_login_count to 0, if false increments",
            "            fail_login_count on user model.",
            "        \"\"\"",
            "        if not user.login_count:",
            "            user.login_count = 0",
            "        if not user.fail_login_count:",
            "            user.fail_login_count = 0",
            "        if success:",
            "            user.login_count += 1",
            "            user.last_login = datetime.datetime.now()",
            "            user.fail_login_count = 0",
            "        else:",
            "            user.fail_login_count += 1",
            "        self.update_user(user)",
            "",
            "    def auth_user_db(self, username, password):",
            "        \"\"\"",
            "        Method for authenticating user, auth db style",
            "",
            "        :param username:",
            "            The username or registered email address",
            "        :param password:",
            "            The password, will be tested against hashed password on db",
            "        \"\"\"",
            "        if username is None or username == \"\":",
            "            return None",
            "        first_user = self.get_first_user()",
            "        user = self.find_user(username=username)",
            "        if user is None:",
            "            user = self.find_user(email=username)",
            "        else:",
            "            # Balance failure and success",
            "            _ = self.find_user(email=username)",
            "        if user is None or (not user.is_active):",
            "            # Balance failure and success",
            "            check_password_hash(",
            "                \"pbkdf2:sha256:150000$Z3t6fmj2$22da622d94a1f8118\"",
            "                \"c0976a03d2f18f680bfff877c9a965db9eedc51bc0be87c\",",
            "                \"password\",",
            "            )",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "            # Balance failure and success",
            "            self.noop_user_update(first_user)",
            "            return None",
            "        elif check_password_hash(user.password, password):",
            "            self.update_user_auth_stat(user, True)",
            "            return user",
            "        else:",
            "            self.update_user_auth_stat(user, False)",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "            return None",
            "",
            "    def _search_ldap(self, ldap, con, username):",
            "        \"\"\"",
            "            Searches LDAP for user.",
            "",
            "            :param ldap: The ldap module reference",
            "            :param con: The ldap connection",
            "            :param username: username to match with AUTH_LDAP_UID_FIELD",
            "            :return: ldap object array",
            "        \"\"\"",
            "        # always check AUTH_LDAP_SEARCH is set before calling this method",
            "        assert self.auth_ldap_search, \"AUTH_LDAP_SEARCH must be set\"",
            "",
            "        # build the filter string for the LDAP search",
            "        if self.auth_ldap_search_filter:",
            "            filter_str = \"(&{0}({1}={2}))\".format(",
            "                self.auth_ldap_search_filter, self.auth_ldap_uid_field, username",
            "            )",
            "        else:",
            "            filter_str = \"({0}={1})\".format(self.auth_ldap_uid_field, username)",
            "",
            "        # build what fields to request in the LDAP search",
            "        request_fields = [",
            "            self.auth_ldap_firstname_field,",
            "            self.auth_ldap_lastname_field,",
            "            self.auth_ldap_email_field,",
            "        ]",
            "        if len(self.auth_roles_mapping) > 0:",
            "            request_fields.append(self.auth_ldap_group_field)",
            "",
            "        # preform the LDAP search",
            "        log.debug(",
            "            \"LDAP search for '{0}' with fields {1} in scope '{2}'\".format(",
            "                filter_str, request_fields, self.auth_ldap_search",
            "            )",
            "        )",
            "        raw_search_result = con.search_s(",
            "            self.auth_ldap_search, ldap.SCOPE_SUBTREE, filter_str, request_fields",
            "        )",
            "        log.debug(\"LDAP search returned: {0}\".format(raw_search_result))",
            "",
            "        # Remove any search referrals from results",
            "        search_result = [",
            "            (dn, attrs)",
            "            for dn, attrs in raw_search_result",
            "            if dn is not None and isinstance(attrs, dict)",
            "        ]",
            "",
            "        # only continue if 0 or 1 results were returned",
            "        if len(search_result) > 1:",
            "            log.error(",
            "                \"LDAP search for '{0}' in scope '{1}' returned multiple results\".format(",
            "                    filter_str, self.auth_ldap_search",
            "                )",
            "            )",
            "            return None, None",
            "",
            "        try:",
            "            # extract the DN",
            "            user_dn = search_result[0][0]",
            "            # extract the other attributes",
            "            user_info = search_result[0][1]",
            "            # return",
            "            return user_dn, user_info",
            "        except (IndexError, NameError):",
            "            return None, None",
            "",
            "    def _ldap_calculate_user_roles(",
            "        self, user_attributes: Dict[str, bytes]",
            "    ) -> List[str]:",
            "        user_role_objects = set()",
            "",
            "        # apply AUTH_ROLES_MAPPING",
            "        if len(self.auth_roles_mapping) > 0:",
            "            user_role_keys = self.ldap_extract_list(",
            "                user_attributes, self.auth_ldap_group_field",
            "            )",
            "            user_role_objects.update(self.get_roles_from_keys(user_role_keys))",
            "",
            "        # apply AUTH_USER_REGISTRATION",
            "        if self.auth_user_registration:",
            "            registration_role_name = self.auth_user_registration_role",
            "",
            "            # lookup registration role in flask db",
            "            fab_role = self.find_role(registration_role_name)",
            "            if fab_role:",
            "                user_role_objects.add(fab_role)",
            "            else:",
            "                log.warning(",
            "                    \"Can't find AUTH_USER_REGISTRATION role: {0}\".format(",
            "                        registration_role_name",
            "                    )",
            "                )",
            "",
            "        return list(user_role_objects)",
            "",
            "    def _ldap_bind_indirect(self, ldap, con) -> None:",
            "        \"\"\"",
            "            Attempt to bind to LDAP using the AUTH_LDAP_BIND_USER.",
            "",
            "            :param ldap: The ldap module reference",
            "            :param con: The ldap connection",
            "        \"\"\"",
            "        # always check AUTH_LDAP_BIND_USER is set before calling this method",
            "        assert self.auth_ldap_bind_user, \"AUTH_LDAP_BIND_USER must be set\"",
            "",
            "        try:",
            "            log.debug(",
            "                \"LDAP bind indirect TRY with username: '{0}'\".format(",
            "                    self.auth_ldap_bind_user",
            "                )",
            "            )",
            "            con.simple_bind_s(self.auth_ldap_bind_user, self.auth_ldap_bind_password)",
            "            log.debug(",
            "                \"LDAP bind indirect SUCCESS with username: '{0}'\".format(",
            "                    self.auth_ldap_bind_user",
            "                )",
            "            )",
            "        except ldap.INVALID_CREDENTIALS as ex:",
            "            log.error(",
            "                \"AUTH_LDAP_BIND_USER and AUTH_LDAP_BIND_PASSWORD are\"",
            "                \" not valid LDAP bind credentials\"",
            "            )",
            "            raise ex",
            "",
            "    @staticmethod",
            "    def _ldap_bind(ldap, con, dn: str, password: str) -> bool:",
            "        \"\"\"",
            "            Validates/binds the provided dn/password with the LDAP sever.",
            "        \"\"\"",
            "        try:",
            "            log.debug(\"LDAP bind TRY with username: '{0}'\".format(dn))",
            "            con.simple_bind_s(dn, password)",
            "            log.debug(\"LDAP bind SUCCESS with username: '{0}'\".format(dn))",
            "            return True",
            "        except ldap.INVALID_CREDENTIALS:",
            "            return False",
            "",
            "    @staticmethod",
            "    def ldap_extract(",
            "        ldap_dict: Dict[str, bytes], field_name: str, fallback: str",
            "    ) -> str:",
            "        raw_value = ldap_dict.get(field_name, [bytes()])",
            "        # decode - if empty string, default to fallback, otherwise take first element",
            "        return raw_value[0].decode(\"utf-8\") or fallback",
            "",
            "    @staticmethod",
            "    def ldap_extract_list(ldap_dict: Dict[str, bytes], field_name: str) -> List[str]:",
            "        raw_list = ldap_dict.get(field_name, [])",
            "        # decode - removing empty strings",
            "        return [x.decode(\"utf-8\") for x in raw_list if x.decode(\"utf-8\")]",
            "",
            "    def auth_user_ldap(self, username, password):",
            "        \"\"\"",
            "            Method for authenticating user with LDAP.",
            "",
            "            NOTE: this depends on python-ldap module",
            "",
            "            :param username: the username",
            "            :param password: the password",
            "        \"\"\"",
            "        # If no username is provided, go away",
            "        if (username is None) or username == \"\":",
            "            return None",
            "",
            "        # Search the DB for this user",
            "        user = self.find_user(username=username)",
            "",
            "        # If user is not active, go away",
            "        if user and (not user.is_active):",
            "            return None",
            "",
            "        # If user is not registered, and not self-registration, go away",
            "        if (not user) and (not self.auth_user_registration):",
            "            return None",
            "",
            "        # Ensure python-ldap is installed",
            "        try:",
            "            import ldap",
            "        except ImportError:",
            "            log.error(\"python-ldap library is not installed\")",
            "            return None",
            "",
            "        try:",
            "            # LDAP certificate settings",
            "            if self.auth_ldap_allow_self_signed:",
            "                ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_ALLOW)",
            "                ldap.set_option(ldap.OPT_X_TLS_NEWCTX, 0)",
            "            elif self.auth_ldap_tls_demand:",
            "                ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_DEMAND)",
            "                ldap.set_option(ldap.OPT_X_TLS_NEWCTX, 0)",
            "            if self.auth_ldap_tls_cacertdir:",
            "                ldap.set_option(ldap.OPT_X_TLS_CACERTDIR, self.auth_ldap_tls_cacertdir)",
            "            if self.auth_ldap_tls_cacertfile:",
            "                ldap.set_option(",
            "                    ldap.OPT_X_TLS_CACERTFILE, self.auth_ldap_tls_cacertfile",
            "                )",
            "            if self.auth_ldap_tls_certfile:",
            "                ldap.set_option(ldap.OPT_X_TLS_CERTFILE, self.auth_ldap_tls_certfile)",
            "            if self.auth_ldap_tls_keyfile:",
            "                ldap.set_option(ldap.OPT_X_TLS_KEYFILE, self.auth_ldap_tls_keyfile)",
            "",
            "            # Initialise LDAP connection",
            "            con = ldap.initialize(self.auth_ldap_server)",
            "            con.set_option(ldap.OPT_REFERRALS, 0)",
            "            if self.auth_ldap_use_tls:",
            "                try:",
            "                    con.start_tls_s()",
            "                except Exception:",
            "                    log.error(",
            "                        LOGMSG_ERR_SEC_AUTH_LDAP_TLS.format(self.auth_ldap_server)",
            "                    )",
            "                    return None",
            "",
            "            # Define variables, so we can check if they are set in later steps",
            "            user_dn = None",
            "            user_attributes = {}",
            "",
            "            # Flow 1 - (Indirect Search Bind):",
            "            #  - in this flow, special bind credentials are used to preform the",
            "            #    LDAP search",
            "            #  - in this flow, AUTH_LDAP_SEARCH must be set",
            "            if self.auth_ldap_bind_user:",
            "                # Bind with AUTH_LDAP_BIND_USER/AUTH_LDAP_BIND_PASSWORD",
            "                # (authorizes for LDAP search)",
            "                self._ldap_bind_indirect(ldap, con)",
            "",
            "                # Search for `username`",
            "                #  - returns the `user_dn` needed for binding to validate credentials",
            "                #  - returns the `user_attributes` needed for",
            "                #    AUTH_USER_REGISTRATION/AUTH_ROLES_SYNC_AT_LOGIN",
            "                if self.auth_ldap_search:",
            "                    user_dn, user_attributes = self._search_ldap(ldap, con, username)",
            "                else:",
            "                    log.error(",
            "                        \"AUTH_LDAP_SEARCH must be set when using AUTH_LDAP_BIND_USER\"",
            "                    )",
            "                    return None",
            "",
            "                # If search failed, go away",
            "                if user_dn is None:",
            "                    log.info(LOGMSG_WAR_SEC_NOLDAP_OBJ.format(username))",
            "                    return None",
            "",
            "                # Bind with user_dn/password (validates credentials)",
            "                if not self._ldap_bind(ldap, con, user_dn, password):",
            "                    if user:",
            "                        self.update_user_auth_stat(user, False)",
            "",
            "                    # Invalid credentials, go away",
            "                    log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "                    return None",
            "",
            "            # Flow 2 - (Direct Search Bind):",
            "            #  - in this flow, the credentials provided by the end-user are used",
            "            #    to preform the LDAP search",
            "            #  - in this flow, we only search LDAP if AUTH_LDAP_SEARCH is set",
            "            #     - features like AUTH_USER_REGISTRATION & AUTH_ROLES_SYNC_AT_LOGIN",
            "            #       will only work if AUTH_LDAP_SEARCH is set",
            "            else:",
            "                # Copy the provided username (so we can apply formatters)",
            "                bind_username = username",
            "",
            "                # update `bind_username` by applying AUTH_LDAP_APPEND_DOMAIN",
            "                #  - for Microsoft AD, which allows binding with userPrincipalName",
            "                if self.auth_ldap_append_domain:",
            "                    bind_username = bind_username + \"@\" + self.auth_ldap_append_domain",
            "",
            "                # Update `bind_username` by applying AUTH_LDAP_USERNAME_FORMAT",
            "                #  - for transforming the username into a DN,",
            "                #    for example: \"uid=%s,ou=example,o=test\"",
            "                if self.auth_ldap_username_format:",
            "                    bind_username = self.auth_ldap_username_format % bind_username",
            "",
            "                # Bind with bind_username/password",
            "                # (validates credentials & authorizes for LDAP search)",
            "                if not self._ldap_bind(ldap, con, bind_username, password):",
            "                    if user:",
            "                        self.update_user_auth_stat(user, False)",
            "",
            "                    # Invalid credentials, go away",
            "                    log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(bind_username))",
            "                    return None",
            "",
            "                # Search for `username` (if AUTH_LDAP_SEARCH is set)",
            "                #  - returns the `user_attributes`",
            "                #    needed for AUTH_USER_REGISTRATION/AUTH_ROLES_SYNC_AT_LOGIN",
            "                #  - we search on `username` not `bind_username`,",
            "                #    because AUTH_LDAP_APPEND_DOMAIN and AUTH_LDAP_USERNAME_FORMAT",
            "                #    would result in an invalid search filter",
            "                if self.auth_ldap_search:",
            "                    user_dn, user_attributes = self._search_ldap(ldap, con, username)",
            "",
            "                    # If search failed, go away",
            "                    if user_dn is None:",
            "                        log.info(LOGMSG_WAR_SEC_NOLDAP_OBJ.format(username))",
            "                        return None",
            "",
            "            # Sync the user's roles",
            "            if user and user_attributes and self.auth_roles_sync_at_login:",
            "                user.roles = self._ldap_calculate_user_roles(user_attributes)",
            "                log.debug(",
            "                    \"Calculated new roles for user='{0}' as: {1}\".format(",
            "                        user_dn, user.roles",
            "                    )",
            "                )",
            "",
            "            # If the user is new, register them",
            "            if (not user) and user_attributes and self.auth_user_registration:",
            "                user = self.add_user(",
            "                    username=username,",
            "                    first_name=self.ldap_extract(",
            "                        user_attributes, self.auth_ldap_firstname_field, \"\"",
            "                    ),",
            "                    last_name=self.ldap_extract(",
            "                        user_attributes, self.auth_ldap_lastname_field, \"\"",
            "                    ),",
            "                    email=self.ldap_extract(",
            "                        user_attributes,",
            "                        self.auth_ldap_email_field,",
            "                        f\"{username}@email.notfound\",",
            "                    ),",
            "                    role=self._ldap_calculate_user_roles(user_attributes),",
            "                )",
            "                log.debug(\"New user registered: {0}\".format(user))",
            "",
            "                # If user registration failed, go away",
            "                if not user:",
            "                    log.info(LOGMSG_ERR_SEC_ADD_REGISTER_USER.format(username))",
            "                    return None",
            "",
            "            # LOGIN SUCCESS (only if user is now registered)",
            "            if user:",
            "                self.update_user_auth_stat(user)",
            "                return user",
            "            else:",
            "                return None",
            "",
            "        except ldap.LDAPError as e:",
            "            msg = None",
            "            if isinstance(e, dict):",
            "                msg = getattr(e, \"message\", None)",
            "            if (msg is not None) and (\"desc\" in msg):",
            "                log.error(LOGMSG_ERR_SEC_AUTH_LDAP.format(e.message[\"desc\"]))",
            "                return None",
            "            else:",
            "                log.error(e)",
            "                return None",
            "",
            "    def auth_user_oid(self, email):",
            "        \"\"\"",
            "            OpenID user Authentication",
            "",
            "            :param email: user's email to authenticate",
            "            :type self: User model",
            "        \"\"\"",
            "        user = self.find_user(email=email)",
            "        if user is None or (not user.is_active):",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(email))",
            "            return None",
            "        else:",
            "            self.update_user_auth_stat(user)",
            "            return user",
            "",
            "    def auth_user_remote_user(self, username):",
            "        \"\"\"",
            "            REMOTE_USER user Authentication",
            "",
            "            :param username: user's username for remote auth",
            "            :type self: User model",
            "        \"\"\"",
            "        user = self.find_user(username=username)",
            "",
            "        # User does not exist, create one if auto user registration.",
            "        if user is None and self.auth_user_registration:",
            "            user = self.add_user(",
            "                # All we have is REMOTE_USER, so we set",
            "                # the other fields to blank.",
            "                username=username,",
            "                first_name=username,",
            "                last_name=\"-\",",
            "                email=username + \"@email.notfound\",",
            "                role=self.find_role(self.auth_user_registration_role),",
            "            )",
            "",
            "        # If user does not exist on the DB and not auto user registration,",
            "        # or user is inactive, go away.",
            "        elif user is None or (not user.is_active):",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "            return None",
            "",
            "        self.update_user_auth_stat(user)",
            "        return user",
            "",
            "    def _oauth_calculate_user_roles(self, userinfo) -> List[str]:",
            "        user_role_objects = set()",
            "",
            "        # apply AUTH_ROLES_MAPPING",
            "        if len(self.auth_roles_mapping) > 0:",
            "            user_role_keys = userinfo.get(\"role_keys\", [])",
            "            user_role_objects.update(self.get_roles_from_keys(user_role_keys))",
            "",
            "        # apply AUTH_USER_REGISTRATION_ROLE",
            "        if self.auth_user_registration:",
            "            registration_role_name = self.auth_user_registration_role",
            "",
            "            # if AUTH_USER_REGISTRATION_ROLE_JMESPATH is set,",
            "            # use it for the registration role",
            "            if self.auth_user_registration_role_jmespath:",
            "                import jmespath",
            "",
            "                registration_role_name = jmespath.search(",
            "                    self.auth_user_registration_role_jmespath, userinfo",
            "                )",
            "",
            "            # lookup registration role in flask db",
            "            fab_role = self.find_role(registration_role_name)",
            "            if fab_role:",
            "                user_role_objects.add(fab_role)",
            "            else:",
            "                log.warning(",
            "                    \"Can't find AUTH_USER_REGISTRATION role: {0}\".format(",
            "                        registration_role_name",
            "                    )",
            "                )",
            "",
            "        return list(user_role_objects)",
            "",
            "    def auth_user_oauth(self, userinfo):",
            "        \"\"\"",
            "            Method for authenticating user with OAuth.",
            "",
            "            :userinfo: dict with user information",
            "                       (keys are the same as User model columns)",
            "        \"\"\"",
            "        # extract the username from `userinfo`",
            "        if \"username\" in userinfo:",
            "            username = userinfo[\"username\"]",
            "        elif \"email\" in userinfo:",
            "            username = userinfo[\"email\"]",
            "        else:",
            "            log.error(",
            "                \"OAUTH userinfo does not have username or email {0}\".format(userinfo)",
            "            )",
            "            return None",
            "",
            "        # If username is empty, go away",
            "        if (username is None) or username == \"\":",
            "            return None",
            "",
            "        # Search the DB for this user",
            "        user = self.find_user(username=username)",
            "",
            "        # If user is not active, go away",
            "        if user and (not user.is_active):",
            "            return None",
            "",
            "        # If user is not registered, and not self-registration, go away",
            "        if (not user) and (not self.auth_user_registration):",
            "            return None",
            "",
            "        # Sync the user's roles",
            "        if user and self.auth_roles_sync_at_login:",
            "            user.roles = self._oauth_calculate_user_roles(userinfo)",
            "            log.debug(",
            "                \"Calculated new roles for user='{0}' as: {1}\".format(",
            "                    username, user.roles",
            "                )",
            "            )",
            "",
            "        # If the user is new, register them",
            "        if (not user) and self.auth_user_registration:",
            "            user = self.add_user(",
            "                username=username,",
            "                first_name=userinfo.get(\"first_name\", \"\"),",
            "                last_name=userinfo.get(\"last_name\", \"\"),",
            "                email=userinfo.get(\"email\", \"\") or f\"{username}@email.notfound\",",
            "                role=self._oauth_calculate_user_roles(userinfo),",
            "            )",
            "            log.debug(\"New user registered: {0}\".format(user))",
            "",
            "            # If user registration failed, go away",
            "            if not user:",
            "                log.error(\"Error creating a new OAuth user {0}\".format(username))",
            "                return None",
            "",
            "        # LOGIN SUCCESS (only if user is now registered)",
            "        if user:",
            "            self.update_user_auth_stat(user)",
            "            return user",
            "        else:",
            "            return None",
            "",
            "    \"\"\"",
            "        ----------------------------------------",
            "            PERMISSION ACCESS CHECK",
            "        ----------------------------------------",
            "    \"\"\"",
            "",
            "    def is_item_public(self, permission_name, view_name):",
            "        \"\"\"",
            "            Check if view has public permissions",
            "",
            "            :param permission_name:",
            "                the permission: can_show, can_edit...",
            "            :param view_name:",
            "                the name of the class view (child of BaseView)",
            "        \"\"\"",
            "        permissions = self.get_public_permissions()",
            "        if permissions:",
            "            for i in permissions:",
            "                if (view_name == i.view_menu.name) and (",
            "                    permission_name == i.permission.name",
            "                ):",
            "                    return True",
            "            return False",
            "        else:",
            "            return False",
            "",
            "    def _has_access_builtin_roles(",
            "        self, role, permission_name: str, view_name: str",
            "    ) -> bool:",
            "        \"\"\"",
            "            Checks permission on builtin role",
            "        \"\"\"",
            "        builtin_pvms = self.builtin_roles.get(role.name, [])",
            "        for pvm in builtin_pvms:",
            "            _view_name = pvm[0]",
            "            _permission_name = pvm[1]",
            "            if re.match(_view_name, view_name) and re.match(",
            "                _permission_name, permission_name",
            "            ):",
            "                return True",
            "        return False",
            "",
            "    def _has_view_access(",
            "        self, user: object, permission_name: str, view_name: str",
            "    ) -> bool:",
            "        roles = user.roles",
            "        db_role_ids = list()",
            "        # First check against builtin (statically configured) roles",
            "        # because no database query is needed",
            "        for role in roles:",
            "            if role.name in self.builtin_roles:",
            "                if self._has_access_builtin_roles(role, permission_name, view_name):",
            "                    return True",
            "            else:",
            "                db_role_ids.append(role.id)",
            "",
            "        # If it's not a builtin role check against database store roles",
            "        return self.exist_permission_on_roles(view_name, permission_name, db_role_ids)",
            "",
            "    def get_user_roles(self, user) -> List[object]:",
            "        \"\"\"",
            "        Get current user roles, if user is not authenticated returns the public role",
            "        \"\"\"",
            "        if not user.is_authenticated:",
            "            return [self.get_public_role()]",
            "        return user.roles",
            "",
            "    def get_role_permissions(self, role) -> Set[Tuple[str, str]]:",
            "        \"\"\"",
            "        Get all permissions for a certain role",
            "        \"\"\"",
            "        result = set()",
            "        if role.name in self.builtin_roles:",
            "            for permission in self.builtin_roles[role.name]:",
            "                result.add((permission[1], permission[0]))",
            "        else:",
            "            for permission in self.get_db_role_permissions(role.id):",
            "                result.add((permission.permission.name, permission.view_menu.name))",
            "        return result",
            "",
            "    def get_user_permissions(self, user) -> Set[Tuple[str, str]]:",
            "        \"\"\"",
            "        Get all permissions from the current user",
            "        \"\"\"",
            "        roles = self.get_user_roles(user)",
            "        result = set()",
            "        for role in roles:",
            "            result.update(self.get_role_permissions(role))",
            "        return result",
            "",
            "    def _get_user_permission_view_menus(",
            "        self, user: object, permission_name: str, view_menus_name: List[str]",
            "    ) -> Set[str]:",
            "        \"\"\"",
            "        Return a set of view menu names with a certain permission name",
            "        that a user has access to. Mainly used to fetch all menu permissions",
            "        on a single db call, will also check public permissions and builtin roles",
            "        \"\"\"",
            "        db_role_ids = list()",
            "        if user is None:",
            "            # include public role",
            "            roles = [self.get_public_role()]",
            "        else:",
            "            roles = user.roles",
            "        # First check against builtin (statically configured) roles",
            "        # because no database query is needed",
            "        result = set()",
            "        for role in roles:",
            "            if role.name in self.builtin_roles:",
            "                for view_menu_name in view_menus_name:",
            "                    if self._has_access_builtin_roles(",
            "                        role, permission_name, view_menu_name",
            "                    ):",
            "                        result.add(view_menu_name)",
            "            else:",
            "                db_role_ids.append(role.id)",
            "        # Then check against database-stored roles",
            "        pvms_names = [",
            "            pvm.view_menu.name",
            "            for pvm in self.find_roles_permission_view_menus(",
            "                permission_name, db_role_ids",
            "            )",
            "        ]",
            "        result.update(pvms_names)",
            "        return result",
            "",
            "    def has_access(self, permission_name, view_name):",
            "        \"\"\"",
            "        Check if current user or public has access to view or menu",
            "        \"\"\"",
            "        if current_user.is_authenticated:",
            "            return self._has_view_access(g.user, permission_name, view_name)",
            "        elif current_user_jwt:",
            "            return self._has_view_access(current_user_jwt, permission_name, view_name)",
            "        else:",
            "            return self.is_item_public(permission_name, view_name)",
            "",
            "    def get_user_menu_access(self, menu_names: List[str] = None) -> Set[str]:",
            "        if current_user.is_authenticated:",
            "            return self._get_user_permission_view_menus(",
            "                g.user, \"menu_access\", view_menus_name=menu_names",
            "            )",
            "        elif current_user_jwt:",
            "            return self._get_user_permission_view_menus(",
            "                current_user_jwt, \"menu_access\", view_menus_name=menu_names",
            "            )",
            "        else:",
            "            return self._get_user_permission_view_menus(",
            "                None, \"menu_access\", view_menus_name=menu_names",
            "            )",
            "",
            "    def add_permissions_view(self, base_permissions, view_menu):",
            "        \"\"\"",
            "        Adds a permission on a view menu to the backend",
            "",
            "        :param base_permissions:",
            "            list of permissions from view (all exposed methods):",
            "             'can_add','can_edit' etc...",
            "        :param view_menu:",
            "            name of the view or menu to add",
            "        \"\"\"",
            "        view_menu_db = self.add_view_menu(view_menu)",
            "        perm_views = self.find_permissions_view_menu(view_menu_db)",
            "",
            "        if not perm_views:",
            "            # No permissions yet on this view",
            "            for permission in base_permissions:",
            "                pv = self.add_permission_view_menu(permission, view_menu)",
            "                if self.auth_role_admin not in self.builtin_roles:",
            "                    role_admin = self.find_role(self.auth_role_admin)",
            "                    self.add_permission_role(role_admin, pv)",
            "        else:",
            "            # Permissions on this view exist but....",
            "            role_admin = self.find_role(self.auth_role_admin)",
            "            for permission in base_permissions:",
            "                # Check if base view permissions exist",
            "                if not self.exist_permission_on_views(perm_views, permission):",
            "                    pv = self.add_permission_view_menu(permission, view_menu)",
            "                    if self.auth_role_admin not in self.builtin_roles:",
            "                        self.add_permission_role(role_admin, pv)",
            "            for perm_view in perm_views:",
            "                if perm_view.permission is None:",
            "                    # Skip this perm_view, it has a null permission",
            "                    continue",
            "                if perm_view.permission.name not in base_permissions:",
            "                    # perm to delete",
            "                    roles = self.get_all_roles()",
            "                    perm = self.find_permission(perm_view.permission.name)",
            "                    # del permission from all roles",
            "                    for role in roles:",
            "                        self.del_permission_role(role, perm)",
            "                    self.del_permission_view_menu(perm_view.permission.name, view_menu)",
            "                elif (",
            "                    self.auth_role_admin not in self.builtin_roles",
            "                    and perm_view not in role_admin.permissions",
            "                ):",
            "                    # Role Admin must have all permissions",
            "                    self.add_permission_role(role_admin, perm_view)",
            "",
            "    def add_permissions_menu(self, view_menu_name):",
            "        \"\"\"",
            "        Adds menu_access to menu on permission_view_menu",
            "",
            "        :param view_menu_name:",
            "            The menu name",
            "        \"\"\"",
            "        self.add_view_menu(view_menu_name)",
            "        pv = self.find_permission_view_menu(\"menu_access\", view_menu_name)",
            "        if not pv:",
            "            pv = self.add_permission_view_menu(\"menu_access\", view_menu_name)",
            "        if self.auth_role_admin not in self.builtin_roles:",
            "            role_admin = self.find_role(self.auth_role_admin)",
            "            self.add_permission_role(role_admin, pv)",
            "",
            "    def security_cleanup(self, baseviews, menus):",
            "        \"\"\"",
            "        Will cleanup all unused permissions from the database",
            "",
            "        :param baseviews: A list of BaseViews class",
            "        :param menus: Menu class",
            "        \"\"\"",
            "        viewsmenus = self.get_all_view_menu()",
            "        roles = self.get_all_roles()",
            "        for viewmenu in viewsmenus:",
            "            found = False",
            "            for baseview in baseviews:",
            "                if viewmenu.name == baseview.class_permission_name:",
            "                    found = True",
            "                    break",
            "            if menus.find(viewmenu.name):",
            "                found = True",
            "            if not found:",
            "                permissions = self.find_permissions_view_menu(viewmenu)",
            "                for permission in permissions:",
            "                    for role in roles:",
            "                        self.del_permission_role(role, permission)",
            "                    self.del_permission_view_menu(",
            "                        permission.permission.name, viewmenu.name",
            "                    )",
            "                self.del_view_menu(viewmenu.name)",
            "        self.security_converge(baseviews, menus)",
            "",
            "    @staticmethod",
            "    def _get_new_old_permissions(baseview) -> Dict:",
            "        ret = dict()",
            "        for method_name, permission_name in baseview.method_permission_name.items():",
            "            old_permission_name = baseview.previous_method_permission_name.get(",
            "                method_name",
            "            )",
            "            # Actions do not get prefix when normally defined",
            "            if hasattr(baseview, \"actions\") and baseview.actions.get(",
            "                old_permission_name",
            "            ):",
            "                permission_prefix = \"\"",
            "            else:",
            "                permission_prefix = PERMISSION_PREFIX",
            "            if old_permission_name:",
            "                if PERMISSION_PREFIX + permission_name not in ret:",
            "                    ret[PERMISSION_PREFIX + permission_name] = {",
            "                        permission_prefix + old_permission_name",
            "                    }",
            "                else:",
            "                    ret[PERMISSION_PREFIX + permission_name].add(",
            "                        permission_prefix + old_permission_name",
            "                    )",
            "        return ret",
            "",
            "    @staticmethod",
            "    def _add_state_transition(",
            "        state_transition: Dict,",
            "        old_view_name: str,",
            "        old_perm_name: str,",
            "        view_name: str,",
            "        perm_name: str,",
            "    ) -> None:",
            "        old_pvm = state_transition[\"add\"].get((old_view_name, old_perm_name))",
            "        if old_pvm:",
            "            state_transition[\"add\"][(old_view_name, old_perm_name)].add(",
            "                (view_name, perm_name)",
            "            )",
            "        else:",
            "            state_transition[\"add\"][(old_view_name, old_perm_name)] = {",
            "                (view_name, perm_name)",
            "            }",
            "        state_transition[\"del_role_pvm\"].add((old_view_name, old_perm_name))",
            "        state_transition[\"del_views\"].add(old_view_name)",
            "        state_transition[\"del_perms\"].add(old_perm_name)",
            "",
            "    @staticmethod",
            "    def _update_del_transitions(state_transitions: Dict, baseviews: List) -> None:",
            "        \"\"\"",
            "        Mutates state_transitions, loop baseviews and prunes all",
            "        views and permissions that are not to delete because references",
            "        exist.",
            "",
            "        :param baseview:",
            "        :param state_transitions:",
            "        :return:",
            "        \"\"\"",
            "        for baseview in baseviews:",
            "            state_transitions[\"del_views\"].discard(baseview.class_permission_name)",
            "            for permission in baseview.base_permissions:",
            "                state_transitions[\"del_role_pvm\"].discard(",
            "                    (baseview.class_permission_name, permission)",
            "                )",
            "                state_transitions[\"del_perms\"].discard(permission)",
            "",
            "    def create_state_transitions(self, baseviews: List, menus: List) -> Dict:",
            "        \"\"\"",
            "        Creates a Dict with all the necessary vm/permission transitions",
            "",
            "        Dict: {",
            "                \"add\": {(<VM>, <PERM>): ((<VM>, PERM), ... )}",
            "                \"del_role_pvm\": ((<VM>, <PERM>), ...)",
            "                \"del_views\": (<VM>, ... )",
            "                \"del_perms\": (<PERM>, ... )",
            "              }",
            "",
            "        :param baseviews: List with all the registered BaseView, BaseApi",
            "        :param menus: List with all the menu entries",
            "        :return: Dict with state transitions",
            "        \"\"\"",
            "        state_transitions = {",
            "            \"add\": {},",
            "            \"del_role_pvm\": set(),",
            "            \"del_views\": set(),",
            "            \"del_perms\": set(),",
            "        }",
            "        for baseview in baseviews:",
            "            add_all_flag = False",
            "            new_view_name = baseview.class_permission_name",
            "            permission_mapping = self._get_new_old_permissions(baseview)",
            "            if baseview.previous_class_permission_name:",
            "                old_view_name = baseview.previous_class_permission_name",
            "                add_all_flag = True",
            "            else:",
            "                new_view_name = baseview.class_permission_name",
            "                old_view_name = new_view_name",
            "            for new_perm_name in baseview.base_permissions:",
            "                if add_all_flag:",
            "                    old_perm_names = permission_mapping.get(new_perm_name)",
            "                    old_perm_names = old_perm_names or (new_perm_name,)",
            "                    for old_perm_name in old_perm_names:",
            "                        self._add_state_transition(",
            "                            state_transitions,",
            "                            old_view_name,",
            "                            old_perm_name,",
            "                            new_view_name,",
            "                            new_perm_name,",
            "                        )",
            "                else:",
            "                    old_perm_names = permission_mapping.get(new_perm_name) or set()",
            "                    for old_perm_name in old_perm_names:",
            "                        self._add_state_transition(",
            "                            state_transitions,",
            "                            old_view_name,",
            "                            old_perm_name,",
            "                            new_view_name,",
            "                            new_perm_name,",
            "                        )",
            "        self._update_del_transitions(state_transitions, baseviews)",
            "        return state_transitions",
            "",
            "    def security_converge(self, baseviews: List, menus: List, dry=False) -> Dict:",
            "        \"\"\"",
            "        Converges overridden permissions on all registered views/api",
            "        will compute all necessary operations from `class_permissions_name`,",
            "        `previous_class_permission_name`, method_permission_name`,",
            "        `previous_method_permission_name` class attributes.",
            "",
            "        :param baseviews: List of registered views/apis",
            "        :param menus: List of menu items",
            "        :param dry: If True will not change DB",
            "        :return: Dict with the necessary operations (state_transitions)",
            "        \"\"\"",
            "        state_transitions = self.create_state_transitions(baseviews, menus)",
            "        if dry:",
            "            return state_transitions",
            "        if not state_transitions:",
            "            log.info(\"No state transitions found\")",
            "            return dict()",
            "        log.debug(f\"State transitions: {state_transitions}\")",
            "        roles = self.get_all_roles()",
            "        for role in roles:",
            "            permissions = list(role.permissions)",
            "            for pvm in permissions:",
            "                new_pvm_states = state_transitions[\"add\"].get(",
            "                    (pvm.view_menu.name, pvm.permission.name)",
            "                )",
            "                if not new_pvm_states:",
            "                    continue",
            "                for new_pvm_state in new_pvm_states:",
            "                    new_pvm = self.add_permission_view_menu(",
            "                        new_pvm_state[1], new_pvm_state[0]",
            "                    )",
            "                    self.add_permission_role(role, new_pvm)",
            "                if (pvm.view_menu.name, pvm.permission.name) in state_transitions[",
            "                    \"del_role_pvm\"",
            "                ]:",
            "                    self.del_permission_role(role, pvm)",
            "        for pvm in state_transitions[\"del_role_pvm\"]:",
            "            self.del_permission_view_menu(pvm[1], pvm[0], cascade=False)",
            "        for view_name in state_transitions[\"del_views\"]:",
            "            self.del_view_menu(view_name)",
            "        for permission_name in state_transitions[\"del_perms\"]:",
            "            self.del_permission(permission_name)",
            "        return state_transitions",
            "",
            "    \"\"\"",
            "     ---------------------------",
            "     INTERFACE ABSTRACT METHODS",
            "     ---------------------------",
            "",
            "     ---------------------",
            "     PRIMITIVES FOR USERS",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_register_user(self, registration_hash):",
            "        \"\"\"",
            "            Generic function to return user registration",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_register_user(",
            "        self, username, first_name, last_name, email, password=\"\", hashed_password=\"\"",
            "    ):",
            "        \"\"\"",
            "            Generic function to add user registration",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_register_user(self, register_user):",
            "        \"\"\"",
            "            Generic function to delete user registration",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_user_by_id(self, pk):",
            "        \"\"\"",
            "            Generic function to return user by it's id (pk)",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_user(self, username=None, email=None):",
            "        \"\"\"",
            "            Generic function find a user by it's username or email",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_all_users(self):",
            "        \"\"\"",
            "            Generic function that returns all existing users",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_db_role_permissions(self, role_id: int) -> List[object]:",
            "        \"\"\"",
            "        Get all DB permissions from a role id",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_user(self, username, first_name, last_name, email, role, password=\"\"):",
            "        \"\"\"",
            "            Generic function to create user",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def update_user(self, user):",
            "        \"\"\"",
            "            Generic function to update user",
            "",
            "            :param user: User model to update to database",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def count_users(self):",
            "        \"\"\"",
            "            Generic function to count the existing users",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES FOR ROLES",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_role(self, name):",
            "        raise NotImplementedError",
            "",
            "    def add_role(self, name, permissions=None):",
            "        raise NotImplementedError",
            "",
            "    def update_role(self, pk, name):",
            "        raise NotImplementedError",
            "",
            "    def get_all_roles(self):",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------------",
            "     PRIMITIVES FOR PERMISSIONS",
            "    ----------------------------",
            "    \"\"\"",
            "",
            "    def get_public_role(self):",
            "        \"\"\"",
            "            returns all permissions from public role",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_public_permissions(self):",
            "        \"\"\"",
            "            returns all permissions from public role",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_permission(self, name):",
            "        \"\"\"",
            "            Finds and returns a Permission by name",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_roles_permission_view_menus(",
            "        self, permission_name: str, role_ids: List[int]",
            "    ):",
            "        raise NotImplementedError",
            "",
            "    def exist_permission_on_roles(",
            "        self, view_name: str, permission_name: str, role_ids: List[int]",
            "    ) -> bool:",
            "        \"\"\"",
            "            Finds and returns permission views for a group of roles",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_permission(self, name):",
            "        \"\"\"",
            "            Adds a permission to the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_permission(self, name):",
            "        \"\"\"",
            "            Deletes a permission from the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_view_menu(self, name):",
            "        \"\"\"",
            "            Finds and returns a ViewMenu by name",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_all_view_menu(self):",
            "        raise NotImplementedError",
            "",
            "    def add_view_menu(self, name):",
            "        \"\"\"",
            "            Adds a view or menu to the backend, model view_menu",
            "            param name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_view_menu(self, name):",
            "        \"\"\"",
            "            Deletes a ViewMenu from the backend",
            "",
            "            :param name:",
            "                name of the ViewMenu",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PERMISSION VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Finds and returns a PermissionView by names",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_permissions_view_menu(self, view_menu):",
            "        \"\"\"",
            "            Finds all permissions from ViewMenu, returns list of PermissionView",
            "",
            "            :param view_menu: ViewMenu object",
            "            :return: list of PermissionView objects",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Adds a permission on a view or menu to the backend",
            "",
            "            :param permission_name:",
            "                name of the permission to add: 'can_add','can_edit' etc...",
            "            :param view_menu_name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_permission_view_menu(self, permission_name, view_menu_name, cascade=True):",
            "        raise NotImplementedError",
            "",
            "    def exist_permission_on_views(self, lst, item):",
            "        raise NotImplementedError",
            "",
            "    def exist_permission_on_view(self, lst, permission, view_menu):",
            "        raise NotImplementedError",
            "",
            "    def add_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Add permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Remove permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def export_roles(self, path: Optional[str] = None) -> None:",
            "        \"\"\" Exports roles to JSON file. \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def import_roles(self, path: str) -> None:",
            "        \"\"\" Imports roles from JSON file. \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def load_user(self, pk):",
            "        return self.get_user_by_id(int(pk))",
            "",
            "    def load_user_jwt(self, pk):",
            "        user = self.load_user(pk)",
            "        # Set flask g.user to JWT user, we can't do it on before request",
            "        g.user = user",
            "        return user",
            "",
            "    @staticmethod",
            "    def before_request():",
            "        g.user = current_user"
        ],
        "afterPatchFile": [
            "import base64",
            "import datetime",
            "import json",
            "import logging",
            "import re",
            "from typing import Any, Dict, List, Optional, Set, Tuple, Union",
            "",
            "from flask import g, session, url_for",
            "from flask_babel import lazy_gettext as _",
            "from flask_jwt_extended import current_user as current_user_jwt",
            "from flask_jwt_extended import JWTManager",
            "from flask_login import current_user, LoginManager",
            "from werkzeug.security import check_password_hash, generate_password_hash",
            "",
            "from .api import SecurityApi",
            "from .registerviews import (",
            "    RegisterUserDBView,",
            "    RegisterUserOAuthView,",
            "    RegisterUserOIDView,",
            ")",
            "from .views import (",
            "    AuthDBView,",
            "    AuthLDAPView,",
            "    AuthOAuthView,",
            "    AuthOIDView,",
            "    AuthRemoteUserView,",
            "    PermissionModelView,",
            "    PermissionViewModelView,",
            "    RegisterUserModelView,",
            "    ResetMyPasswordView,",
            "    ResetPasswordView,",
            "    RoleModelView,",
            "    UserDBModelView,",
            "    UserInfoEditView,",
            "    UserLDAPModelView,",
            "    UserOAuthModelView,",
            "    UserOIDModelView,",
            "    UserRemoteUserModelView,",
            "    UserStatsChartView,",
            "    ViewMenuModelView,",
            ")",
            "from ..basemanager import BaseManager",
            "from ..const import (",
            "    AUTH_DB,",
            "    AUTH_LDAP,",
            "    AUTH_OAUTH,",
            "    AUTH_OID,",
            "    AUTH_REMOTE_USER,",
            "    LOGMSG_ERR_SEC_ADD_REGISTER_USER,",
            "    LOGMSG_ERR_SEC_AUTH_LDAP,",
            "    LOGMSG_ERR_SEC_AUTH_LDAP_TLS,",
            "    LOGMSG_WAR_SEC_LOGIN_FAILED,",
            "    LOGMSG_WAR_SEC_NO_USER,",
            "    LOGMSG_WAR_SEC_NOLDAP_OBJ,",
            "    PERMISSION_PREFIX,",
            ")",
            "",
            "log = logging.getLogger(__name__)",
            "",
            "",
            "class AbstractSecurityManager(BaseManager):",
            "    \"\"\"",
            "        Abstract SecurityManager class, declares all methods used by the",
            "        framework. There is no assumptions about security models or auth types.",
            "    \"\"\"",
            "",
            "    def add_permissions_view(self, base_permissions, view_menu):",
            "        \"\"\"",
            "            Adds a permission on a view menu to the backend",
            "",
            "            :param base_permissions:",
            "                list of permissions from view (all exposed methods):",
            "                 'can_add','can_edit' etc...",
            "            :param view_menu:",
            "                name of the view or menu to add",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_permissions_menu(self, view_menu_name):",
            "        \"\"\"",
            "            Adds menu_access to menu on permission_view_menu",
            "",
            "            :param view_menu_name:",
            "                The menu name",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def register_views(self):",
            "        \"\"\"",
            "            Generic function to create the security views",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def is_item_public(self, permission_name, view_name):",
            "        \"\"\"",
            "            Check if view has public permissions",
            "",
            "            :param permission_name:",
            "                the permission: can_show, can_edit...",
            "            :param view_name:",
            "                the name of the class view (child of BaseView)",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def has_access(self, permission_name, view_name):",
            "        \"\"\"",
            "            Check if current user or public has access to view or menu",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def security_cleanup(self, baseviews, menus):",
            "        raise NotImplementedError",
            "",
            "    def get_first_user(self):",
            "        raise NotImplementedError",
            "",
            "    def noop_user_update(self, user) -> None:",
            "        raise NotImplementedError",
            "",
            "",
            "def _oauth_tokengetter(token=None):",
            "    \"\"\"",
            "        Default function to return the current user oauth token",
            "        from session cookie.",
            "    \"\"\"",
            "    token = session.get(\"oauth\")",
            "    log.debug(\"Token Get: {0}\".format(token))",
            "    return token",
            "",
            "",
            "class BaseSecurityManager(AbstractSecurityManager):",
            "    auth_view = None",
            "    \"\"\" The obj instance for authentication view \"\"\"",
            "    user_view = None",
            "    \"\"\" The obj instance for user view \"\"\"",
            "    registeruser_view = None",
            "    \"\"\" The obj instance for registering user view \"\"\"",
            "    lm = None",
            "    \"\"\" Flask-Login LoginManager \"\"\"",
            "    jwt_manager = None",
            "    \"\"\" Flask-JWT-Extended \"\"\"",
            "    oid = None",
            "    \"\"\" Flask-OpenID OpenID \"\"\"",
            "    oauth = None",
            "    \"\"\" Flask-OAuth \"\"\"",
            "    oauth_remotes = None",
            "    \"\"\" OAuth email whitelists \"\"\"",
            "    oauth_whitelists = {}",
            "    \"\"\" Initialized (remote_app) providers dict {'provider_name', OBJ } \"\"\"",
            "    oauth_tokengetter = _oauth_tokengetter",
            "    \"\"\" OAuth tokengetter function override to implement your own tokengetter method \"\"\"",
            "    oauth_user_info = None",
            "",
            "    user_model = None",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    role_model = None",
            "    \"\"\" Override to set your own Role Model \"\"\"",
            "    permission_model = None",
            "    \"\"\" Override to set your own Permission Model \"\"\"",
            "    viewmenu_model = None",
            "    \"\"\" Override to set your own ViewMenu Model \"\"\"",
            "    permissionview_model = None",
            "    \"\"\" Override to set your own PermissionView Model \"\"\"",
            "    registeruser_model = None",
            "    \"\"\" Override to set your own RegisterUser Model \"\"\"",
            "",
            "    userdbmodelview = UserDBModelView",
            "    \"\"\" Override if you want your own user db view \"\"\"",
            "    userldapmodelview = UserLDAPModelView",
            "    \"\"\" Override if you want your own user ldap view \"\"\"",
            "    useroidmodelview = UserOIDModelView",
            "    \"\"\" Override if you want your own user OID view \"\"\"",
            "    useroauthmodelview = UserOAuthModelView",
            "    \"\"\" Override if you want your own user OAuth view \"\"\"",
            "    userremoteusermodelview = UserRemoteUserModelView",
            "    \"\"\" Override if you want your own user REMOTE_USER view \"\"\"",
            "    registerusermodelview = RegisterUserModelView",
            "",
            "    authdbview = AuthDBView",
            "    \"\"\" Override if you want your own Authentication DB view \"\"\"",
            "    authldapview = AuthLDAPView",
            "    \"\"\" Override if you want your own Authentication LDAP view \"\"\"",
            "    authoidview = AuthOIDView",
            "    \"\"\" Override if you want your own Authentication OID view \"\"\"",
            "    authoauthview = AuthOAuthView",
            "    \"\"\" Override if you want your own Authentication OAuth view \"\"\"",
            "    authremoteuserview = AuthRemoteUserView",
            "    \"\"\" Override if you want your own Authentication REMOTE_USER view \"\"\"",
            "",
            "    registeruserdbview = RegisterUserDBView",
            "    \"\"\" Override if you want your own register user db view \"\"\"",
            "    registeruseroidview = RegisterUserOIDView",
            "    \"\"\" Override if you want your own register user OpenID view \"\"\"",
            "    registeruseroauthview = RegisterUserOAuthView",
            "    \"\"\" Override if you want your own register user OAuth view \"\"\"",
            "",
            "    resetmypasswordview = ResetMyPasswordView",
            "    \"\"\" Override if you want your own reset my password view \"\"\"",
            "    resetpasswordview = ResetPasswordView",
            "    \"\"\" Override if you want your own reset password view \"\"\"",
            "    userinfoeditview = UserInfoEditView",
            "    \"\"\" Override if you want your own User information edit view \"\"\"",
            "",
            "    # API",
            "    security_api = SecurityApi",
            "    \"\"\" Override if you want your own Security API login endpoint \"\"\"",
            "",
            "    rolemodelview = RoleModelView",
            "    permissionmodelview = PermissionModelView",
            "    userstatschartview = UserStatsChartView",
            "    viewmenumodelview = ViewMenuModelView",
            "    permissionviewmodelview = PermissionViewModelView",
            "",
            "    def __init__(self, appbuilder):",
            "        super(BaseSecurityManager, self).__init__(appbuilder)",
            "        app = self.appbuilder.get_app",
            "        # Base Security Config",
            "        app.config.setdefault(\"AUTH_ROLE_ADMIN\", \"Admin\")",
            "        app.config.setdefault(\"AUTH_ROLE_PUBLIC\", \"Public\")",
            "        app.config.setdefault(\"AUTH_TYPE\", AUTH_DB)",
            "        # Self Registration",
            "        app.config.setdefault(\"AUTH_USER_REGISTRATION\", False)",
            "        app.config.setdefault(\"AUTH_USER_REGISTRATION_ROLE\", self.auth_role_public)",
            "        app.config.setdefault(\"AUTH_USER_REGISTRATION_ROLE_JMESPATH\", None)",
            "        # Role Mapping",
            "        app.config.setdefault(\"AUTH_ROLES_MAPPING\", {})",
            "        app.config.setdefault(\"AUTH_ROLES_SYNC_AT_LOGIN\", False)",
            "        app.config.setdefault(\"AUTH_API_LOGIN_ALLOW_MULTIPLE_PROVIDERS\", False)",
            "",
            "        # LDAP Config",
            "        if self.auth_type == AUTH_LDAP:",
            "            if \"AUTH_LDAP_SERVER\" not in app.config:",
            "                raise Exception(",
            "                    \"No AUTH_LDAP_SERVER defined on config\"",
            "                    \" with AUTH_LDAP authentication type.\"",
            "                )",
            "            app.config.setdefault(\"AUTH_LDAP_SEARCH\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_SEARCH_FILTER\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_APPEND_DOMAIN\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_USERNAME_FORMAT\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_BIND_USER\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_BIND_PASSWORD\", \"\")",
            "            # TLS options",
            "            app.config.setdefault(\"AUTH_LDAP_USE_TLS\", False)",
            "            app.config.setdefault(\"AUTH_LDAP_ALLOW_SELF_SIGNED\", False)",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_DEMAND\", False)",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_CACERTDIR\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_CACERTFILE\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_CERTFILE\", \"\")",
            "            app.config.setdefault(\"AUTH_LDAP_TLS_KEYFILE\", \"\")",
            "            # Mapping options",
            "            app.config.setdefault(\"AUTH_LDAP_UID_FIELD\", \"uid\")",
            "            app.config.setdefault(\"AUTH_LDAP_GROUP_FIELD\", \"memberOf\")",
            "            app.config.setdefault(\"AUTH_LDAP_FIRSTNAME_FIELD\", \"givenName\")",
            "            app.config.setdefault(\"AUTH_LDAP_LASTNAME_FIELD\", \"sn\")",
            "            app.config.setdefault(\"AUTH_LDAP_EMAIL_FIELD\", \"mail\")",
            "",
            "        if self.auth_type == AUTH_OID:",
            "            from flask_openid import OpenID",
            "",
            "            self.oid = OpenID(app)",
            "        if self.auth_type == AUTH_OAUTH:",
            "            from authlib.integrations.flask_client import OAuth",
            "",
            "            self.oauth = OAuth(app)",
            "            self.oauth_remotes = dict()",
            "            for _provider in self.oauth_providers:",
            "                provider_name = _provider[\"name\"]",
            "                log.debug(\"OAuth providers init {0}\".format(provider_name))",
            "                obj_provider = self.oauth.register(",
            "                    provider_name, **_provider[\"remote_app\"]",
            "                )",
            "                obj_provider._tokengetter = self.oauth_tokengetter",
            "                if not self.oauth_user_info:",
            "                    self.oauth_user_info = self.get_oauth_user_info",
            "                # Whitelist only users with matching emails",
            "                if \"whitelist\" in _provider:",
            "                    self.oauth_whitelists[provider_name] = _provider[\"whitelist\"]",
            "                self.oauth_remotes[provider_name] = obj_provider",
            "",
            "        self._builtin_roles = self.create_builtin_roles()",
            "        # Setup Flask-Login",
            "        self.lm = self.create_login_manager(app)",
            "",
            "        # Setup Flask-Jwt-Extended",
            "        self.jwt_manager = self.create_jwt_manager(app)",
            "",
            "    def create_login_manager(self, app) -> LoginManager:",
            "        \"\"\"",
            "            Override to implement your custom login manager instance",
            "",
            "            :param app: Flask app",
            "        \"\"\"",
            "        lm = LoginManager(app)",
            "        lm.login_view = \"login\"",
            "        lm.user_loader(self.load_user)",
            "        return lm",
            "",
            "    def create_jwt_manager(self, app) -> JWTManager:",
            "        \"\"\"",
            "            Override to implement your custom JWT manager instance",
            "",
            "            :param app: Flask app",
            "        \"\"\"",
            "        jwt_manager = JWTManager()",
            "        jwt_manager.init_app(app)",
            "        jwt_manager.user_loader_callback_loader(self.load_user_jwt)",
            "        return jwt_manager",
            "",
            "    def create_builtin_roles(self):",
            "        return self.appbuilder.get_app.config.get(\"FAB_ROLES\", {})",
            "",
            "    def get_roles_from_keys(self, role_keys: List[str]) -> Set[role_model]:",
            "        \"\"\"",
            "        Construct a list of FAB role objects, from a list of keys.",
            "",
            "        NOTE:",
            "        - keys are things like: \"LDAP group DNs\" or \"OAUTH group names\"",
            "        - we use AUTH_ROLES_MAPPING to map from keys, to FAB role names",
            "",
            "        :param role_keys: the list of FAB role keys",
            "        :return: a list of RoleModelView",
            "        \"\"\"",
            "        _roles = set()",
            "        _role_keys = set(role_keys)",
            "        for role_key, fab_role_names in self.auth_roles_mapping.items():",
            "            if role_key in _role_keys:",
            "                for fab_role_name in fab_role_names:",
            "                    fab_role = self.find_role(fab_role_name)",
            "                    if fab_role:",
            "                        _roles.add(fab_role)",
            "                    else:",
            "                        log.warning(",
            "                            \"Can't find role specified in AUTH_ROLES_MAPPING: {0}\".format(",
            "                                fab_role_name",
            "                            )",
            "                        )",
            "        return _roles",
            "",
            "    @property",
            "    def auth_type_provider_name(self) -> Optional[str]:",
            "        provider_to_auth_type = {AUTH_DB: \"db\", AUTH_LDAP: \"ldap\"}",
            "        return provider_to_auth_type.get(self.auth_type)",
            "",
            "    @property",
            "    def get_url_for_registeruser(self):",
            "        return url_for(",
            "            \"%s.%s\"",
            "            % (self.registeruser_view.endpoint, self.registeruser_view.default_view)",
            "        )",
            "",
            "    @property",
            "    def get_user_datamodel(self):",
            "        return self.user_view.datamodel",
            "",
            "    @property",
            "    def get_register_user_datamodel(self):",
            "        return self.registerusermodelview.datamodel",
            "",
            "    @property",
            "    def builtin_roles(self) -> Dict[str, Any]:",
            "        return self._builtin_roles",
            "",
            "    @property",
            "    def api_login_allow_multiple_providers(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_API_LOGIN_ALLOW_MULTIPLE_PROVIDERS\"]",
            "",
            "    @property",
            "    def auth_type(self) -> int:",
            "        return self.appbuilder.get_app.config[\"AUTH_TYPE\"]",
            "",
            "    @property",
            "    def auth_username_ci(self) -> str:",
            "        return self.appbuilder.get_app.config.get(\"AUTH_USERNAME_CI\", True)",
            "",
            "    @property",
            "    def auth_role_admin(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLE_ADMIN\"]",
            "",
            "    @property",
            "    def auth_role_public(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLE_PUBLIC\"]",
            "",
            "    @property",
            "    def auth_ldap_server(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_SERVER\"]",
            "",
            "    @property",
            "    def auth_ldap_use_tls(self) -> bool:",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_USE_TLS\"]",
            "",
            "    @property",
            "    def auth_user_registration(self) -> bool:",
            "        return self.appbuilder.get_app.config[\"AUTH_USER_REGISTRATION\"]",
            "",
            "    @property",
            "    def auth_user_registration_role(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_USER_REGISTRATION_ROLE\"]",
            "",
            "    @property",
            "    def auth_user_registration_role_jmespath(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_USER_REGISTRATION_ROLE_JMESPATH\"]",
            "",
            "    @property",
            "    def auth_roles_mapping(self) -> Dict[str, List[str]]:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLES_MAPPING\"]",
            "",
            "    @property",
            "    def auth_roles_sync_at_login(self) -> bool:",
            "        return self.appbuilder.get_app.config[\"AUTH_ROLES_SYNC_AT_LOGIN\"]",
            "",
            "    @property",
            "    def auth_ldap_search(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_SEARCH\"]",
            "",
            "    @property",
            "    def auth_ldap_search_filter(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_SEARCH_FILTER\"]",
            "",
            "    @property",
            "    def auth_ldap_bind_user(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_BIND_USER\"]",
            "",
            "    @property",
            "    def auth_ldap_bind_password(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_BIND_PASSWORD\"]",
            "",
            "    @property",
            "    def auth_ldap_append_domain(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_APPEND_DOMAIN\"]",
            "",
            "    @property",
            "    def auth_ldap_username_format(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_USERNAME_FORMAT\"]",
            "",
            "    @property",
            "    def auth_ldap_uid_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_UID_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_group_field(self) -> str:",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_GROUP_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_firstname_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_FIRSTNAME_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_lastname_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_LASTNAME_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_email_field(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_EMAIL_FIELD\"]",
            "",
            "    @property",
            "    def auth_ldap_bind_first(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_BIND_FIRST\"]",
            "",
            "    @property",
            "    def auth_ldap_allow_self_signed(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_ALLOW_SELF_SIGNED\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_demand(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_DEMAND\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_cacertdir(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_CACERTDIR\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_cacertfile(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_CACERTFILE\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_certfile(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_CERTFILE\"]",
            "",
            "    @property",
            "    def auth_ldap_tls_keyfile(self):",
            "        return self.appbuilder.get_app.config[\"AUTH_LDAP_TLS_KEYFILE\"]",
            "",
            "    @property",
            "    def openid_providers(self):",
            "        return self.appbuilder.get_app.config[\"OPENID_PROVIDERS\"]",
            "",
            "    @property",
            "    def oauth_providers(self):",
            "        return self.appbuilder.get_app.config[\"OAUTH_PROVIDERS\"]",
            "",
            "    @property",
            "    def current_user(self):",
            "        if current_user.is_authenticated:",
            "            return g.user",
            "        elif current_user_jwt:",
            "            return current_user_jwt",
            "",
            "    def oauth_user_info_getter(self, f):",
            "        \"\"\"",
            "            Decorator function to be the OAuth user info getter",
            "            for all the providers, receives provider and response",
            "            return a dict with the information returned from the provider.",
            "            The returned user info dict should have it's keys with the same",
            "            name as the User Model.",
            "",
            "            Use it like this an example for GitHub ::",
            "",
            "                @appbuilder.sm.oauth_user_info_getter",
            "                def my_oauth_user_info(sm, provider, response=None):",
            "                    if provider == 'github':",
            "                        me = sm.oauth_remotes[provider].get('user')",
            "                        return {'username': me.data.get('login')}",
            "                    else:",
            "                        return {}",
            "        \"\"\"",
            "",
            "        def wraps(provider, response=None):",
            "            ret = f(self, provider, response=response)",
            "            # Checks if decorator is well behaved and returns a dict as supposed.",
            "            if not type(ret) == dict:",
            "                log.error(",
            "                    \"OAuth user info decorated function \"",
            "                    \"did not returned a dict, but: {0}\".format(type(ret))",
            "                )",
            "                return {}",
            "            return ret",
            "",
            "        self.oauth_user_info = wraps",
            "        return wraps",
            "",
            "    def get_oauth_token_key_name(self, provider):",
            "        \"\"\"",
            "            Returns the token_key name for the oauth provider",
            "            if none is configured defaults to oauth_token",
            "            this is configured using OAUTH_PROVIDERS and token_key key.",
            "        \"\"\"",
            "        for _provider in self.oauth_providers:",
            "            if _provider[\"name\"] == provider:",
            "                return _provider.get(\"token_key\", \"oauth_token\")",
            "",
            "    def get_oauth_token_secret_name(self, provider):",
            "        \"\"\"",
            "            Returns the token_secret name for the oauth provider",
            "            if none is configured defaults to oauth_secret",
            "            this is configured using OAUTH_PROVIDERS and token_secret",
            "        \"\"\"",
            "        for _provider in self.oauth_providers:",
            "            if _provider[\"name\"] == provider:",
            "                return _provider.get(\"token_secret\", \"oauth_token_secret\")",
            "",
            "    def set_oauth_session(self, provider, oauth_response):",
            "        \"\"\"",
            "            Set the current session with OAuth user secrets",
            "        \"\"\"",
            "        # Get this provider key names for token_key and token_secret",
            "        token_key = self.appbuilder.sm.get_oauth_token_key_name(provider)",
            "        token_secret = self.appbuilder.sm.get_oauth_token_secret_name(provider)",
            "        # Save users token on encrypted session cookie",
            "        session[\"oauth\"] = (",
            "            oauth_response[token_key],",
            "            oauth_response.get(token_secret, \"\"),",
            "        )",
            "        session[\"oauth_provider\"] = provider",
            "",
            "    def get_oauth_user_info(self, provider, resp):",
            "        \"\"\"",
            "            Since there are different OAuth API's with different ways to",
            "            retrieve user info",
            "        \"\"\"",
            "        # for GITHUB",
            "        if provider == \"github\" or provider == \"githublocal\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"user\")",
            "            data = me.json()",
            "            log.debug(\"User info from Github: {0}\".format(data))",
            "            return {\"username\": \"github_\" + data.get(\"login\")}",
            "        # for twitter",
            "        if provider == \"twitter\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"account/settings.json\")",
            "            data = me.json()",
            "            log.debug(\"User info from Twitter: {0}\".format(data))",
            "            return {\"username\": \"twitter_\" + data.get(\"screen_name\", \"\")}",
            "        # for linkedin",
            "        if provider == \"linkedin\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(",
            "                \"people/~:(id,email-address,first-name,last-name)?format=json\"",
            "            )",
            "            data = me.json()",
            "            log.debug(\"User info from Linkedin: {0}\".format(data))",
            "            return {",
            "                \"username\": \"linkedin_\" + data.get(\"id\", \"\"),",
            "                \"email\": data.get(\"email-address\", \"\"),",
            "                \"first_name\": data.get(\"firstName\", \"\"),",
            "                \"last_name\": data.get(\"lastName\", \"\"),",
            "            }",
            "        # for Google",
            "        if provider == \"google\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"userinfo\")",
            "            data = me.json()",
            "            log.debug(\"User info from Google: {0}\".format(data))",
            "            return {",
            "                \"username\": \"google_\" + data.get(\"id\", \"\"),",
            "                \"first_name\": data.get(\"given_name\", \"\"),",
            "                \"last_name\": data.get(\"family_name\", \"\"),",
            "                \"email\": data.get(\"email\", \"\"),",
            "            }",
            "        # for Azure AD Tenant. Azure OAuth response contains",
            "        # JWT token which has user info.",
            "        # JWT token needs to be base64 decoded.",
            "        # https://docs.microsoft.com/en-us/azure/active-directory/develop/",
            "        # active-directory-protocols-oauth-code",
            "        if provider == \"azure\":",
            "            log.debug(\"Azure response received : {0}\".format(resp))",
            "            id_token = resp[\"id_token\"]",
            "            log.debug(str(id_token))",
            "            me = self._azure_jwt_token_parse(id_token)",
            "            log.debug(\"Parse JWT token : {0}\".format(me))",
            "            return {",
            "                \"name\": me.get(\"name\", \"\"),",
            "                \"email\": me[\"upn\"],",
            "                \"first_name\": me.get(\"given_name\", \"\"),",
            "                \"last_name\": me.get(\"family_name\", \"\"),",
            "                \"id\": me[\"oid\"],",
            "                \"username\": me[\"oid\"],",
            "                \"role_keys\": me.get(\"roles\", []),",
            "            }",
            "        # for OpenShift",
            "        if provider == \"openshift\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(",
            "                \"apis/user.openshift.io/v1/users/~\"",
            "            )",
            "            data = me.json()",
            "            log.debug(\"User info from OpenShift: {0}\".format(data))",
            "            return {\"username\": \"openshift_\" + data.get(\"metadata\").get(\"name\")}",
            "        # for Okta",
            "        if provider == \"okta\":",
            "            me = self.appbuilder.sm.oauth_remotes[provider].get(\"userinfo\")",
            "            data = me.json()",
            "            log.debug(\"User info from Okta: %s\", data)",
            "            return {",
            "                \"username\": \"okta_\" + data.get(\"sub\", \"\"),",
            "                \"first_name\": data.get(\"given_name\", \"\"),",
            "                \"last_name\": data.get(\"family_name\", \"\"),",
            "                \"email\": data.get(\"email\", \"\"),",
            "                \"role_keys\": data.get(\"groups\", []),",
            "            }",
            "        else:",
            "            return {}",
            "",
            "    def _azure_parse_jwt(self, id_token):",
            "        jwt_token_parts = r\"^([^\\.\\s]*)\\.([^\\.\\s]+)\\.([^\\.\\s]*)$\"",
            "        matches = re.search(jwt_token_parts, id_token)",
            "        if not matches or len(matches.groups()) < 3:",
            "            log.error(\"Unable to parse token.\")",
            "            return {}",
            "        return {",
            "            \"header\": matches.group(1),",
            "            \"Payload\": matches.group(2),",
            "            \"Sig\": matches.group(3),",
            "        }",
            "",
            "    def _azure_jwt_token_parse(self, id_token):",
            "        jwt_split_token = self._azure_parse_jwt(id_token)",
            "        if not jwt_split_token:",
            "            return",
            "",
            "        jwt_payload = jwt_split_token[\"Payload\"]",
            "        # Prepare for base64 decoding",
            "        payload_b64_string = jwt_payload",
            "        payload_b64_string += \"=\" * (4 - ((len(jwt_payload) % 4)))",
            "        decoded_payload = base64.urlsafe_b64decode(payload_b64_string.encode(\"ascii\"))",
            "",
            "        if not decoded_payload:",
            "            log.error(\"Payload of id_token could not be base64 url decoded.\")",
            "            return",
            "",
            "        jwt_decoded_payload = json.loads(decoded_payload.decode(\"utf-8\"))",
            "",
            "        return jwt_decoded_payload",
            "",
            "    def register_views(self):",
            "        if not self.appbuilder.app.config.get(\"FAB_ADD_SECURITY_VIEWS\", True):",
            "            return",
            "        # Security APIs",
            "        self.appbuilder.add_api(self.security_api)",
            "",
            "        if self.auth_user_registration:",
            "            if self.auth_type == AUTH_DB:",
            "                self.registeruser_view = self.registeruserdbview()",
            "            elif self.auth_type == AUTH_OID:",
            "                self.registeruser_view = self.registeruseroidview()",
            "            elif self.auth_type == AUTH_OAUTH:",
            "                self.registeruser_view = self.registeruseroauthview()",
            "            if self.registeruser_view:",
            "                self.appbuilder.add_view_no_menu(self.registeruser_view)",
            "",
            "        self.appbuilder.add_view_no_menu(self.resetpasswordview())",
            "        self.appbuilder.add_view_no_menu(self.resetmypasswordview())",
            "        self.appbuilder.add_view_no_menu(self.userinfoeditview())",
            "",
            "        if self.auth_type == AUTH_DB:",
            "            self.user_view = self.userdbmodelview",
            "            self.auth_view = self.authdbview()",
            "",
            "        elif self.auth_type == AUTH_LDAP:",
            "            self.user_view = self.userldapmodelview",
            "            self.auth_view = self.authldapview()",
            "        elif self.auth_type == AUTH_OAUTH:",
            "            self.user_view = self.useroauthmodelview",
            "            self.auth_view = self.authoauthview()",
            "        elif self.auth_type == AUTH_REMOTE_USER:",
            "            self.user_view = self.userremoteusermodelview",
            "            self.auth_view = self.authremoteuserview()",
            "        else:",
            "            self.user_view = self.useroidmodelview",
            "            self.auth_view = self.authoidview()",
            "            if self.auth_user_registration:",
            "                pass",
            "                # self.registeruser_view = self.registeruseroidview()",
            "                # self.appbuilder.add_view_no_menu(self.registeruser_view)",
            "",
            "        self.appbuilder.add_view_no_menu(self.auth_view)",
            "",
            "        self.user_view = self.appbuilder.add_view(",
            "            self.user_view,",
            "            \"List Users\",",
            "            icon=\"fa-user\",",
            "            label=_(\"List Users\"),",
            "            category=\"Security\",",
            "            category_icon=\"fa-cogs\",",
            "            category_label=_(\"Security\"),",
            "        )",
            "",
            "        role_view = self.appbuilder.add_view(",
            "            self.rolemodelview,",
            "            \"List Roles\",",
            "            icon=\"fa-group\",",
            "            label=_(\"List Roles\"),",
            "            category=\"Security\",",
            "            category_icon=\"fa-cogs\",",
            "        )",
            "        role_view.related_views = [self.user_view.__class__]",
            "",
            "        if self.userstatschartview:",
            "            self.appbuilder.add_view(",
            "                self.userstatschartview,",
            "                \"User's Statistics\",",
            "                icon=\"fa-bar-chart-o\",",
            "                label=_(\"User's Statistics\"),",
            "                category=\"Security\",",
            "            )",
            "        if self.auth_user_registration:",
            "            self.appbuilder.add_view(",
            "                self.registerusermodelview,",
            "                \"User's Statistics\",",
            "                icon=\"fa-user-plus\",",
            "                label=_(\"User Registrations\"),",
            "                category=\"Security\",",
            "            )",
            "        self.appbuilder.menu.add_separator(\"Security\")",
            "        if self.appbuilder.app.config.get(\"FAB_ADD_SECURITY_PERMISSION_VIEW\", True):",
            "            self.appbuilder.add_view(",
            "                self.permissionmodelview,",
            "                \"Base Permissions\",",
            "                icon=\"fa-lock\",",
            "                label=_(\"Base Permissions\"),",
            "                category=\"Security\",",
            "            )",
            "        if self.appbuilder.app.config.get(\"FAB_ADD_SECURITY_VIEW_MENU_VIEW\", True):",
            "            self.appbuilder.add_view(",
            "                self.viewmenumodelview,",
            "                \"Views/Menus\",",
            "                icon=\"fa-list-alt\",",
            "                label=_(\"Views/Menus\"),",
            "                category=\"Security\",",
            "            )",
            "        if self.appbuilder.app.config.get(",
            "            \"FAB_ADD_SECURITY_PERMISSION_VIEWS_VIEW\", True",
            "        ):",
            "            self.appbuilder.add_view(",
            "                self.permissionviewmodelview,",
            "                \"Permission on Views/Menus\",",
            "                icon=\"fa-link\",",
            "                label=_(\"Permission on Views/Menus\"),",
            "                category=\"Security\",",
            "            )",
            "",
            "    def create_db(self):",
            "        \"\"\"",
            "            Setups the DB, creates admin and public roles if they don't exist.",
            "        \"\"\"",
            "        roles_mapping = self.appbuilder.get_app.config.get(\"FAB_ROLES_MAPPING\", {})",
            "        for pk, name in roles_mapping.items():",
            "            self.update_role(pk, name)",
            "        for role_name, permission_view_menus in self.builtin_roles.items():",
            "            permission_view_menus = [",
            "                self.add_permission_view_menu(permission_name, view_menu_name)",
            "                for view_menu_name, permission_name in permission_view_menus",
            "            ]",
            "            self.add_role(name=role_name, permissions=permission_view_menus)",
            "        if self.auth_role_admin not in self.builtin_roles:",
            "            self.add_role(self.auth_role_admin)",
            "        self.add_role(self.auth_role_public)",
            "        if self.count_users() == 0:",
            "            log.warning(LOGMSG_WAR_SEC_NO_USER)",
            "",
            "    def reset_password(self, userid, password):",
            "        \"\"\"",
            "            Change/Reset a user's password for authdb.",
            "            Password will be hashed and saved.",
            "",
            "            :param userid:",
            "                the user.id to reset the password",
            "            :param password:",
            "                The clear text password to reset and save hashed on the db",
            "        \"\"\"",
            "        user = self.get_user_by_id(userid)",
            "        user.password = generate_password_hash(password)",
            "        self.update_user(user)",
            "",
            "    def update_user_auth_stat(self, user, success=True):",
            "        \"\"\"",
            "        Update user authentication stats upon successful/unsuccessful",
            "        authentication attempts.",
            "",
            "        :param user:",
            "            The identified (but possibly not successfully authenticated) user",
            "            model",
            "        :param success:",
            "        :type success: bool or None",
            "            Defaults to true, if true increments login_count, updates",
            "            last_login, and resets fail_login_count to 0, if false increments",
            "            fail_login_count on user model.",
            "        \"\"\"",
            "        if not user.login_count:",
            "            user.login_count = 0",
            "        if not user.fail_login_count:",
            "            user.fail_login_count = 0",
            "        if success:",
            "            user.login_count += 1",
            "            user.last_login = datetime.datetime.now()",
            "            user.fail_login_count = 0",
            "        else:",
            "            user.fail_login_count += 1",
            "        self.update_user(user)",
            "",
            "    def auth_user_db(self, username, password):",
            "        \"\"\"",
            "        Method for authenticating user, auth db style",
            "",
            "        :param username:",
            "            The username or registered email address",
            "        :param password:",
            "            The password, will be tested against hashed password on db",
            "        \"\"\"",
            "        if username is None or username == \"\":",
            "            return None",
            "        first_user = self.get_first_user()",
            "        user = self.find_user(username=username)",
            "        if user is None:",
            "            user = self.find_user(email=username)",
            "        else:",
            "            # Balance failure and success",
            "            _ = self.find_user(email=username)",
            "        if user is None or (not user.is_active):",
            "            # Balance failure and success",
            "            check_password_hash(",
            "                \"pbkdf2:sha256:150000$Z3t6fmj2$22da622d94a1f8118\"",
            "                \"c0976a03d2f18f680bfff877c9a965db9eedc51bc0be87c\",",
            "                \"password\",",
            "            )",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "            # Balance failure and success",
            "            self.noop_user_update(first_user)",
            "            return None",
            "        elif check_password_hash(user.password, password):",
            "            self.update_user_auth_stat(user, True)",
            "            return user",
            "        else:",
            "            self.update_user_auth_stat(user, False)",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "            return None",
            "",
            "    def _search_ldap(self, ldap, con, username):",
            "        \"\"\"",
            "            Searches LDAP for user.",
            "",
            "            :param ldap: The ldap module reference",
            "            :param con: The ldap connection",
            "            :param username: username to match with AUTH_LDAP_UID_FIELD",
            "            :return: ldap object array",
            "        \"\"\"",
            "        # always check AUTH_LDAP_SEARCH is set before calling this method",
            "        assert self.auth_ldap_search, \"AUTH_LDAP_SEARCH must be set\"",
            "",
            "        # build the filter string for the LDAP search",
            "        if self.auth_ldap_search_filter:",
            "            filter_str = \"(&{0}({1}={2}))\".format(",
            "                self.auth_ldap_search_filter, self.auth_ldap_uid_field, username",
            "            )",
            "        else:",
            "            filter_str = \"({0}={1})\".format(self.auth_ldap_uid_field, username)",
            "",
            "        # build what fields to request in the LDAP search",
            "        request_fields = [",
            "            self.auth_ldap_firstname_field,",
            "            self.auth_ldap_lastname_field,",
            "            self.auth_ldap_email_field,",
            "        ]",
            "        if len(self.auth_roles_mapping) > 0:",
            "            request_fields.append(self.auth_ldap_group_field)",
            "",
            "        # preform the LDAP search",
            "        log.debug(",
            "            \"LDAP search for '{0}' with fields {1} in scope '{2}'\".format(",
            "                filter_str, request_fields, self.auth_ldap_search",
            "            )",
            "        )",
            "        raw_search_result = con.search_s(",
            "            self.auth_ldap_search, ldap.SCOPE_SUBTREE, filter_str, request_fields",
            "        )",
            "        log.debug(\"LDAP search returned: {0}\".format(raw_search_result))",
            "",
            "        # Remove any search referrals from results",
            "        search_result = [",
            "            (dn, attrs)",
            "            for dn, attrs in raw_search_result",
            "            if dn is not None and isinstance(attrs, dict)",
            "        ]",
            "",
            "        # only continue if 0 or 1 results were returned",
            "        if len(search_result) > 1:",
            "            log.error(",
            "                \"LDAP search for '{0}' in scope '{1}' returned multiple results\".format(",
            "                    filter_str, self.auth_ldap_search",
            "                )",
            "            )",
            "            return None, None",
            "",
            "        try:",
            "            # extract the DN",
            "            user_dn = search_result[0][0]",
            "            # extract the other attributes",
            "            user_info = search_result[0][1]",
            "            # return",
            "            return user_dn, user_info",
            "        except (IndexError, NameError):",
            "            return None, None",
            "",
            "    def _ldap_calculate_user_roles(",
            "        self, user_attributes: Dict[str, bytes]",
            "    ) -> List[str]:",
            "        user_role_objects = set()",
            "",
            "        # apply AUTH_ROLES_MAPPING",
            "        if len(self.auth_roles_mapping) > 0:",
            "            user_role_keys = self.ldap_extract_list(",
            "                user_attributes, self.auth_ldap_group_field",
            "            )",
            "            user_role_objects.update(self.get_roles_from_keys(user_role_keys))",
            "",
            "        # apply AUTH_USER_REGISTRATION",
            "        if self.auth_user_registration:",
            "            registration_role_name = self.auth_user_registration_role",
            "",
            "            # lookup registration role in flask db",
            "            fab_role = self.find_role(registration_role_name)",
            "            if fab_role:",
            "                user_role_objects.add(fab_role)",
            "            else:",
            "                log.warning(",
            "                    \"Can't find AUTH_USER_REGISTRATION role: {0}\".format(",
            "                        registration_role_name",
            "                    )",
            "                )",
            "",
            "        return list(user_role_objects)",
            "",
            "    def _ldap_bind_indirect(self, ldap, con) -> None:",
            "        \"\"\"",
            "            Attempt to bind to LDAP using the AUTH_LDAP_BIND_USER.",
            "",
            "            :param ldap: The ldap module reference",
            "            :param con: The ldap connection",
            "        \"\"\"",
            "        # always check AUTH_LDAP_BIND_USER is set before calling this method",
            "        assert self.auth_ldap_bind_user, \"AUTH_LDAP_BIND_USER must be set\"",
            "",
            "        try:",
            "            log.debug(",
            "                \"LDAP bind indirect TRY with username: '{0}'\".format(",
            "                    self.auth_ldap_bind_user",
            "                )",
            "            )",
            "            con.simple_bind_s(self.auth_ldap_bind_user, self.auth_ldap_bind_password)",
            "            log.debug(",
            "                \"LDAP bind indirect SUCCESS with username: '{0}'\".format(",
            "                    self.auth_ldap_bind_user",
            "                )",
            "            )",
            "        except ldap.INVALID_CREDENTIALS as ex:",
            "            log.error(",
            "                \"AUTH_LDAP_BIND_USER and AUTH_LDAP_BIND_PASSWORD are\"",
            "                \" not valid LDAP bind credentials\"",
            "            )",
            "            raise ex",
            "",
            "    @staticmethod",
            "    def _ldap_bind(ldap, con, dn: str, password: str) -> bool:",
            "        \"\"\"",
            "            Validates/binds the provided dn/password with the LDAP sever.",
            "        \"\"\"",
            "        try:",
            "            log.debug(\"LDAP bind TRY with username: '{0}'\".format(dn))",
            "            con.simple_bind_s(dn, password)",
            "            log.debug(\"LDAP bind SUCCESS with username: '{0}'\".format(dn))",
            "            return True",
            "        except ldap.INVALID_CREDENTIALS:",
            "            return False",
            "",
            "    @staticmethod",
            "    def ldap_extract(",
            "        ldap_dict: Dict[str, bytes], field_name: str, fallback: str",
            "    ) -> str:",
            "        raw_value = ldap_dict.get(field_name, [bytes()])",
            "        # decode - if empty string, default to fallback, otherwise take first element",
            "        return raw_value[0].decode(\"utf-8\") or fallback",
            "",
            "    @staticmethod",
            "    def ldap_extract_list(ldap_dict: Dict[str, bytes], field_name: str) -> List[str]:",
            "        raw_list = ldap_dict.get(field_name, [])",
            "        # decode - removing empty strings",
            "        return [x.decode(\"utf-8\") for x in raw_list if x.decode(\"utf-8\")]",
            "",
            "    def auth_user_ldap(self, username, password):",
            "        \"\"\"",
            "            Method for authenticating user with LDAP.",
            "",
            "            NOTE: this depends on python-ldap module",
            "",
            "            :param username: the username",
            "            :param password: the password",
            "        \"\"\"",
            "        # If no username is provided, go away",
            "        if (username is None) or username == \"\":",
            "            return None",
            "",
            "        # Search the DB for this user",
            "        user = self.find_user(username=username)",
            "",
            "        # If user is not active, go away",
            "        if user and (not user.is_active):",
            "            return None",
            "",
            "        # If user is not registered, and not self-registration, go away",
            "        if (not user) and (not self.auth_user_registration):",
            "            return None",
            "",
            "        # Ensure python-ldap is installed",
            "        try:",
            "            import ldap",
            "        except ImportError:",
            "            log.error(\"python-ldap library is not installed\")",
            "            return None",
            "",
            "        try:",
            "            # LDAP certificate settings",
            "            if self.auth_ldap_allow_self_signed:",
            "                ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_ALLOW)",
            "                ldap.set_option(ldap.OPT_X_TLS_NEWCTX, 0)",
            "            elif self.auth_ldap_tls_demand:",
            "                ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_DEMAND)",
            "                ldap.set_option(ldap.OPT_X_TLS_NEWCTX, 0)",
            "            if self.auth_ldap_tls_cacertdir:",
            "                ldap.set_option(ldap.OPT_X_TLS_CACERTDIR, self.auth_ldap_tls_cacertdir)",
            "            if self.auth_ldap_tls_cacertfile:",
            "                ldap.set_option(",
            "                    ldap.OPT_X_TLS_CACERTFILE, self.auth_ldap_tls_cacertfile",
            "                )",
            "            if self.auth_ldap_tls_certfile:",
            "                ldap.set_option(ldap.OPT_X_TLS_CERTFILE, self.auth_ldap_tls_certfile)",
            "            if self.auth_ldap_tls_keyfile:",
            "                ldap.set_option(ldap.OPT_X_TLS_KEYFILE, self.auth_ldap_tls_keyfile)",
            "",
            "            # Initialise LDAP connection",
            "            con = ldap.initialize(self.auth_ldap_server)",
            "            con.set_option(ldap.OPT_REFERRALS, 0)",
            "            if self.auth_ldap_use_tls:",
            "                try:",
            "                    con.start_tls_s()",
            "                except Exception:",
            "                    log.error(",
            "                        LOGMSG_ERR_SEC_AUTH_LDAP_TLS.format(self.auth_ldap_server)",
            "                    )",
            "                    return None",
            "",
            "            # Define variables, so we can check if they are set in later steps",
            "            user_dn = None",
            "            user_attributes = {}",
            "",
            "            # Flow 1 - (Indirect Search Bind):",
            "            #  - in this flow, special bind credentials are used to preform the",
            "            #    LDAP search",
            "            #  - in this flow, AUTH_LDAP_SEARCH must be set",
            "            if self.auth_ldap_bind_user:",
            "                # Bind with AUTH_LDAP_BIND_USER/AUTH_LDAP_BIND_PASSWORD",
            "                # (authorizes for LDAP search)",
            "                self._ldap_bind_indirect(ldap, con)",
            "",
            "                # Search for `username`",
            "                #  - returns the `user_dn` needed for binding to validate credentials",
            "                #  - returns the `user_attributes` needed for",
            "                #    AUTH_USER_REGISTRATION/AUTH_ROLES_SYNC_AT_LOGIN",
            "                if self.auth_ldap_search:",
            "                    user_dn, user_attributes = self._search_ldap(ldap, con, username)",
            "                else:",
            "                    log.error(",
            "                        \"AUTH_LDAP_SEARCH must be set when using AUTH_LDAP_BIND_USER\"",
            "                    )",
            "                    return None",
            "",
            "                # If search failed, go away",
            "                if user_dn is None:",
            "                    log.info(LOGMSG_WAR_SEC_NOLDAP_OBJ.format(username))",
            "                    return None",
            "",
            "                # Bind with user_dn/password (validates credentials)",
            "                if not self._ldap_bind(ldap, con, user_dn, password):",
            "                    if user:",
            "                        self.update_user_auth_stat(user, False)",
            "",
            "                    # Invalid credentials, go away",
            "                    log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "                    return None",
            "",
            "            # Flow 2 - (Direct Search Bind):",
            "            #  - in this flow, the credentials provided by the end-user are used",
            "            #    to preform the LDAP search",
            "            #  - in this flow, we only search LDAP if AUTH_LDAP_SEARCH is set",
            "            #     - features like AUTH_USER_REGISTRATION & AUTH_ROLES_SYNC_AT_LOGIN",
            "            #       will only work if AUTH_LDAP_SEARCH is set",
            "            else:",
            "                # Copy the provided username (so we can apply formatters)",
            "                bind_username = username",
            "",
            "                # update `bind_username` by applying AUTH_LDAP_APPEND_DOMAIN",
            "                #  - for Microsoft AD, which allows binding with userPrincipalName",
            "                if self.auth_ldap_append_domain:",
            "                    bind_username = bind_username + \"@\" + self.auth_ldap_append_domain",
            "",
            "                # Update `bind_username` by applying AUTH_LDAP_USERNAME_FORMAT",
            "                #  - for transforming the username into a DN,",
            "                #    for example: \"uid=%s,ou=example,o=test\"",
            "                if self.auth_ldap_username_format:",
            "                    bind_username = self.auth_ldap_username_format % bind_username",
            "",
            "                # Bind with bind_username/password",
            "                # (validates credentials & authorizes for LDAP search)",
            "                if not self._ldap_bind(ldap, con, bind_username, password):",
            "                    if user:",
            "                        self.update_user_auth_stat(user, False)",
            "",
            "                    # Invalid credentials, go away",
            "                    log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(bind_username))",
            "                    return None",
            "",
            "                # Search for `username` (if AUTH_LDAP_SEARCH is set)",
            "                #  - returns the `user_attributes`",
            "                #    needed for AUTH_USER_REGISTRATION/AUTH_ROLES_SYNC_AT_LOGIN",
            "                #  - we search on `username` not `bind_username`,",
            "                #    because AUTH_LDAP_APPEND_DOMAIN and AUTH_LDAP_USERNAME_FORMAT",
            "                #    would result in an invalid search filter",
            "                if self.auth_ldap_search:",
            "                    user_dn, user_attributes = self._search_ldap(ldap, con, username)",
            "",
            "                    # If search failed, go away",
            "                    if user_dn is None:",
            "                        log.info(LOGMSG_WAR_SEC_NOLDAP_OBJ.format(username))",
            "                        return None",
            "",
            "            # Sync the user's roles",
            "            if user and user_attributes and self.auth_roles_sync_at_login:",
            "                user.roles = self._ldap_calculate_user_roles(user_attributes)",
            "                log.debug(",
            "                    \"Calculated new roles for user='{0}' as: {1}\".format(",
            "                        user_dn, user.roles",
            "                    )",
            "                )",
            "",
            "            # If the user is new, register them",
            "            if (not user) and user_attributes and self.auth_user_registration:",
            "                user = self.add_user(",
            "                    username=username,",
            "                    first_name=self.ldap_extract(",
            "                        user_attributes, self.auth_ldap_firstname_field, \"\"",
            "                    ),",
            "                    last_name=self.ldap_extract(",
            "                        user_attributes, self.auth_ldap_lastname_field, \"\"",
            "                    ),",
            "                    email=self.ldap_extract(",
            "                        user_attributes,",
            "                        self.auth_ldap_email_field,",
            "                        f\"{username}@email.notfound\",",
            "                    ),",
            "                    role=self._ldap_calculate_user_roles(user_attributes),",
            "                )",
            "                log.debug(\"New user registered: {0}\".format(user))",
            "",
            "                # If user registration failed, go away",
            "                if not user:",
            "                    log.info(LOGMSG_ERR_SEC_ADD_REGISTER_USER.format(username))",
            "                    return None",
            "",
            "            # LOGIN SUCCESS (only if user is now registered)",
            "            if user:",
            "                self.update_user_auth_stat(user)",
            "                return user",
            "            else:",
            "                return None",
            "",
            "        except ldap.LDAPError as e:",
            "            msg = None",
            "            if isinstance(e, dict):",
            "                msg = getattr(e, \"message\", None)",
            "            if (msg is not None) and (\"desc\" in msg):",
            "                log.error(LOGMSG_ERR_SEC_AUTH_LDAP.format(e.message[\"desc\"]))",
            "                return None",
            "            else:",
            "                log.error(e)",
            "                return None",
            "",
            "    def auth_user_oid(self, email):",
            "        \"\"\"",
            "            OpenID user Authentication",
            "",
            "            :param email: user's email to authenticate",
            "            :type self: User model",
            "        \"\"\"",
            "        user = self.find_user(email=email)",
            "        if user is None or (not user.is_active):",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(email))",
            "            return None",
            "        else:",
            "            self.update_user_auth_stat(user)",
            "            return user",
            "",
            "    def auth_user_remote_user(self, username):",
            "        \"\"\"",
            "            REMOTE_USER user Authentication",
            "",
            "            :param username: user's username for remote auth",
            "            :type self: User model",
            "        \"\"\"",
            "        user = self.find_user(username=username)",
            "",
            "        # User does not exist, create one if auto user registration.",
            "        if user is None and self.auth_user_registration:",
            "            user = self.add_user(",
            "                # All we have is REMOTE_USER, so we set",
            "                # the other fields to blank.",
            "                username=username,",
            "                first_name=username,",
            "                last_name=\"-\",",
            "                email=username + \"@email.notfound\",",
            "                role=self.find_role(self.auth_user_registration_role),",
            "            )",
            "",
            "        # If user does not exist on the DB and not auto user registration,",
            "        # or user is inactive, go away.",
            "        elif user is None or (not user.is_active):",
            "            log.info(LOGMSG_WAR_SEC_LOGIN_FAILED.format(username))",
            "            return None",
            "",
            "        self.update_user_auth_stat(user)",
            "        return user",
            "",
            "    def _oauth_calculate_user_roles(self, userinfo) -> List[str]:",
            "        user_role_objects = set()",
            "",
            "        # apply AUTH_ROLES_MAPPING",
            "        if len(self.auth_roles_mapping) > 0:",
            "            user_role_keys = userinfo.get(\"role_keys\", [])",
            "            user_role_objects.update(self.get_roles_from_keys(user_role_keys))",
            "",
            "        # apply AUTH_USER_REGISTRATION_ROLE",
            "        if self.auth_user_registration:",
            "            registration_role_name = self.auth_user_registration_role",
            "",
            "            # if AUTH_USER_REGISTRATION_ROLE_JMESPATH is set,",
            "            # use it for the registration role",
            "            if self.auth_user_registration_role_jmespath:",
            "                import jmespath",
            "",
            "                registration_role_name = jmespath.search(",
            "                    self.auth_user_registration_role_jmespath, userinfo",
            "                )",
            "",
            "            # lookup registration role in flask db",
            "            fab_role = self.find_role(registration_role_name)",
            "            if fab_role:",
            "                user_role_objects.add(fab_role)",
            "            else:",
            "                log.warning(",
            "                    \"Can't find AUTH_USER_REGISTRATION role: {0}\".format(",
            "                        registration_role_name",
            "                    )",
            "                )",
            "",
            "        return list(user_role_objects)",
            "",
            "    def auth_user_oauth(self, userinfo):",
            "        \"\"\"",
            "            Method for authenticating user with OAuth.",
            "",
            "            :userinfo: dict with user information",
            "                       (keys are the same as User model columns)",
            "        \"\"\"",
            "        # extract the username from `userinfo`",
            "        if \"username\" in userinfo:",
            "            username = userinfo[\"username\"]",
            "        elif \"email\" in userinfo:",
            "            username = userinfo[\"email\"]",
            "        else:",
            "            log.error(",
            "                \"OAUTH userinfo does not have username or email {0}\".format(userinfo)",
            "            )",
            "            return None",
            "",
            "        # If username is empty, go away",
            "        if (username is None) or username == \"\":",
            "            return None",
            "",
            "        # Search the DB for this user",
            "        user = self.find_user(username=username)",
            "",
            "        # If user is not active, go away",
            "        if user and (not user.is_active):",
            "            return None",
            "",
            "        # If user is not registered, and not self-registration, go away",
            "        if (not user) and (not self.auth_user_registration):",
            "            return None",
            "",
            "        # Sync the user's roles",
            "        if user and self.auth_roles_sync_at_login:",
            "            user.roles = self._oauth_calculate_user_roles(userinfo)",
            "            log.debug(",
            "                \"Calculated new roles for user='{0}' as: {1}\".format(",
            "                    username, user.roles",
            "                )",
            "            )",
            "",
            "        # If the user is new, register them",
            "        if (not user) and self.auth_user_registration:",
            "            user = self.add_user(",
            "                username=username,",
            "                first_name=userinfo.get(\"first_name\", \"\"),",
            "                last_name=userinfo.get(\"last_name\", \"\"),",
            "                email=userinfo.get(\"email\", \"\") or f\"{username}@email.notfound\",",
            "                role=self._oauth_calculate_user_roles(userinfo),",
            "            )",
            "            log.debug(\"New user registered: {0}\".format(user))",
            "",
            "            # If user registration failed, go away",
            "            if not user:",
            "                log.error(\"Error creating a new OAuth user {0}\".format(username))",
            "                return None",
            "",
            "        # LOGIN SUCCESS (only if user is now registered)",
            "        if user:",
            "            self.update_user_auth_stat(user)",
            "            return user",
            "        else:",
            "            return None",
            "",
            "    \"\"\"",
            "        ----------------------------------------",
            "            PERMISSION ACCESS CHECK",
            "        ----------------------------------------",
            "    \"\"\"",
            "",
            "    def is_item_public(self, permission_name, view_name):",
            "        \"\"\"",
            "            Check if view has public permissions",
            "",
            "            :param permission_name:",
            "                the permission: can_show, can_edit...",
            "            :param view_name:",
            "                the name of the class view (child of BaseView)",
            "        \"\"\"",
            "        permissions = self.get_public_permissions()",
            "        if permissions:",
            "            for i in permissions:",
            "                if (view_name == i.view_menu.name) and (",
            "                    permission_name == i.permission.name",
            "                ):",
            "                    return True",
            "            return False",
            "        else:",
            "            return False",
            "",
            "    def _has_access_builtin_roles(",
            "        self, role, permission_name: str, view_name: str",
            "    ) -> bool:",
            "        \"\"\"",
            "            Checks permission on builtin role",
            "        \"\"\"",
            "        builtin_pvms = self.builtin_roles.get(role.name, [])",
            "        for pvm in builtin_pvms:",
            "            _view_name = pvm[0]",
            "            _permission_name = pvm[1]",
            "            if re.match(_view_name, view_name) and re.match(",
            "                _permission_name, permission_name",
            "            ):",
            "                return True",
            "        return False",
            "",
            "    def _has_view_access(",
            "        self, user: object, permission_name: str, view_name: str",
            "    ) -> bool:",
            "        roles = user.roles",
            "        db_role_ids = list()",
            "        # First check against builtin (statically configured) roles",
            "        # because no database query is needed",
            "        for role in roles:",
            "            if role.name in self.builtin_roles:",
            "                if self._has_access_builtin_roles(role, permission_name, view_name):",
            "                    return True",
            "            else:",
            "                db_role_ids.append(role.id)",
            "",
            "        # If it's not a builtin role check against database store roles",
            "        return self.exist_permission_on_roles(view_name, permission_name, db_role_ids)",
            "",
            "    def get_user_roles(self, user) -> List[object]:",
            "        \"\"\"",
            "        Get current user roles, if user is not authenticated returns the public role",
            "        \"\"\"",
            "        if not user.is_authenticated:",
            "            return [self.get_public_role()]",
            "        return user.roles",
            "",
            "    def get_role_permissions(self, role) -> Set[Tuple[str, str]]:",
            "        \"\"\"",
            "        Get all permissions for a certain role",
            "        \"\"\"",
            "        result = set()",
            "        if role.name in self.builtin_roles:",
            "            for permission in self.builtin_roles[role.name]:",
            "                result.add((permission[1], permission[0]))",
            "        else:",
            "            for permission in self.get_db_role_permissions(role.id):",
            "                result.add((permission.permission.name, permission.view_menu.name))",
            "        return result",
            "",
            "    def get_user_permissions(self, user) -> Set[Tuple[str, str]]:",
            "        \"\"\"",
            "        Get all permissions from the current user",
            "        \"\"\"",
            "        roles = self.get_user_roles(user)",
            "        result = set()",
            "        for role in roles:",
            "            result.update(self.get_role_permissions(role))",
            "        return result",
            "",
            "    def _get_user_permission_view_menus(",
            "        self, user: object, permission_name: str, view_menus_name: List[str]",
            "    ) -> Set[str]:",
            "        \"\"\"",
            "        Return a set of view menu names with a certain permission name",
            "        that a user has access to. Mainly used to fetch all menu permissions",
            "        on a single db call, will also check public permissions and builtin roles",
            "        \"\"\"",
            "        db_role_ids = list()",
            "        if user is None:",
            "            # include public role",
            "            roles = [self.get_public_role()]",
            "        else:",
            "            roles = user.roles",
            "        # First check against builtin (statically configured) roles",
            "        # because no database query is needed",
            "        result = set()",
            "        for role in roles:",
            "            if role.name in self.builtin_roles:",
            "                for view_menu_name in view_menus_name:",
            "                    if self._has_access_builtin_roles(",
            "                        role, permission_name, view_menu_name",
            "                    ):",
            "                        result.add(view_menu_name)",
            "            else:",
            "                db_role_ids.append(role.id)",
            "        # Then check against database-stored roles",
            "        pvms_names = [",
            "            pvm.view_menu.name",
            "            for pvm in self.find_roles_permission_view_menus(",
            "                permission_name, db_role_ids",
            "            )",
            "        ]",
            "        result.update(pvms_names)",
            "        return result",
            "",
            "    def has_access(self, permission_name, view_name):",
            "        \"\"\"",
            "        Check if current user or public has access to view or menu",
            "        \"\"\"",
            "        if current_user.is_authenticated:",
            "            return self._has_view_access(g.user, permission_name, view_name)",
            "        elif current_user_jwt:",
            "            return self._has_view_access(current_user_jwt, permission_name, view_name)",
            "        else:",
            "            return self.is_item_public(permission_name, view_name)",
            "",
            "    def get_user_menu_access(self, menu_names: List[str] = None) -> Set[str]:",
            "        if current_user.is_authenticated:",
            "            return self._get_user_permission_view_menus(",
            "                g.user, \"menu_access\", view_menus_name=menu_names",
            "            )",
            "        elif current_user_jwt:",
            "            return self._get_user_permission_view_menus(",
            "                current_user_jwt, \"menu_access\", view_menus_name=menu_names",
            "            )",
            "        else:",
            "            return self._get_user_permission_view_menus(",
            "                None, \"menu_access\", view_menus_name=menu_names",
            "            )",
            "",
            "    def add_permissions_view(self, base_permissions, view_menu):",
            "        \"\"\"",
            "        Adds a permission on a view menu to the backend",
            "",
            "        :param base_permissions:",
            "            list of permissions from view (all exposed methods):",
            "             'can_add','can_edit' etc...",
            "        :param view_menu:",
            "            name of the view or menu to add",
            "        \"\"\"",
            "        view_menu_db = self.add_view_menu(view_menu)",
            "        perm_views = self.find_permissions_view_menu(view_menu_db)",
            "",
            "        if not perm_views:",
            "            # No permissions yet on this view",
            "            for permission in base_permissions:",
            "                pv = self.add_permission_view_menu(permission, view_menu)",
            "                if self.auth_role_admin not in self.builtin_roles:",
            "                    role_admin = self.find_role(self.auth_role_admin)",
            "                    self.add_permission_role(role_admin, pv)",
            "        else:",
            "            # Permissions on this view exist but....",
            "            role_admin = self.find_role(self.auth_role_admin)",
            "            for permission in base_permissions:",
            "                # Check if base view permissions exist",
            "                if not self.exist_permission_on_views(perm_views, permission):",
            "                    pv = self.add_permission_view_menu(permission, view_menu)",
            "                    if self.auth_role_admin not in self.builtin_roles:",
            "                        self.add_permission_role(role_admin, pv)",
            "            for perm_view in perm_views:",
            "                if perm_view.permission is None:",
            "                    # Skip this perm_view, it has a null permission",
            "                    continue",
            "                if perm_view.permission.name not in base_permissions:",
            "                    # perm to delete",
            "                    roles = self.get_all_roles()",
            "                    perm = self.find_permission(perm_view.permission.name)",
            "                    # del permission from all roles",
            "                    for role in roles:",
            "                        self.del_permission_role(role, perm)",
            "                    self.del_permission_view_menu(perm_view.permission.name, view_menu)",
            "                elif (",
            "                    self.auth_role_admin not in self.builtin_roles",
            "                    and perm_view not in role_admin.permissions",
            "                ):",
            "                    # Role Admin must have all permissions",
            "                    self.add_permission_role(role_admin, perm_view)",
            "",
            "    def add_permissions_menu(self, view_menu_name):",
            "        \"\"\"",
            "        Adds menu_access to menu on permission_view_menu",
            "",
            "        :param view_menu_name:",
            "            The menu name",
            "        \"\"\"",
            "        self.add_view_menu(view_menu_name)",
            "        pv = self.find_permission_view_menu(\"menu_access\", view_menu_name)",
            "        if not pv:",
            "            pv = self.add_permission_view_menu(\"menu_access\", view_menu_name)",
            "        if self.auth_role_admin not in self.builtin_roles:",
            "            role_admin = self.find_role(self.auth_role_admin)",
            "            self.add_permission_role(role_admin, pv)",
            "",
            "    def security_cleanup(self, baseviews, menus):",
            "        \"\"\"",
            "        Will cleanup all unused permissions from the database",
            "",
            "        :param baseviews: A list of BaseViews class",
            "        :param menus: Menu class",
            "        \"\"\"",
            "        viewsmenus = self.get_all_view_menu()",
            "        roles = self.get_all_roles()",
            "        for viewmenu in viewsmenus:",
            "            found = False",
            "            for baseview in baseviews:",
            "                if viewmenu.name == baseview.class_permission_name:",
            "                    found = True",
            "                    break",
            "            if menus.find(viewmenu.name):",
            "                found = True",
            "            if not found:",
            "                permissions = self.find_permissions_view_menu(viewmenu)",
            "                for permission in permissions:",
            "                    for role in roles:",
            "                        self.del_permission_role(role, permission)",
            "                    self.del_permission_view_menu(",
            "                        permission.permission.name, viewmenu.name",
            "                    )",
            "                self.del_view_menu(viewmenu.name)",
            "        self.security_converge(baseviews, menus)",
            "",
            "    @staticmethod",
            "    def _get_new_old_permissions(baseview) -> Dict:",
            "        ret = dict()",
            "        for method_name, permission_name in baseview.method_permission_name.items():",
            "            old_permission_name = baseview.previous_method_permission_name.get(",
            "                method_name",
            "            )",
            "            # Actions do not get prefix when normally defined",
            "            if hasattr(baseview, \"actions\") and baseview.actions.get(",
            "                old_permission_name",
            "            ):",
            "                permission_prefix = \"\"",
            "            else:",
            "                permission_prefix = PERMISSION_PREFIX",
            "            if old_permission_name:",
            "                if PERMISSION_PREFIX + permission_name not in ret:",
            "                    ret[PERMISSION_PREFIX + permission_name] = {",
            "                        permission_prefix + old_permission_name",
            "                    }",
            "                else:",
            "                    ret[PERMISSION_PREFIX + permission_name].add(",
            "                        permission_prefix + old_permission_name",
            "                    )",
            "        return ret",
            "",
            "    @staticmethod",
            "    def _add_state_transition(",
            "        state_transition: Dict,",
            "        old_view_name: str,",
            "        old_perm_name: str,",
            "        view_name: str,",
            "        perm_name: str,",
            "    ) -> None:",
            "        old_pvm = state_transition[\"add\"].get((old_view_name, old_perm_name))",
            "        if old_pvm:",
            "            state_transition[\"add\"][(old_view_name, old_perm_name)].add(",
            "                (view_name, perm_name)",
            "            )",
            "        else:",
            "            state_transition[\"add\"][(old_view_name, old_perm_name)] = {",
            "                (view_name, perm_name)",
            "            }",
            "        state_transition[\"del_role_pvm\"].add((old_view_name, old_perm_name))",
            "        state_transition[\"del_views\"].add(old_view_name)",
            "        state_transition[\"del_perms\"].add(old_perm_name)",
            "",
            "    @staticmethod",
            "    def _update_del_transitions(state_transitions: Dict, baseviews: List) -> None:",
            "        \"\"\"",
            "        Mutates state_transitions, loop baseviews and prunes all",
            "        views and permissions that are not to delete because references",
            "        exist.",
            "",
            "        :param baseview:",
            "        :param state_transitions:",
            "        :return:",
            "        \"\"\"",
            "        for baseview in baseviews:",
            "            state_transitions[\"del_views\"].discard(baseview.class_permission_name)",
            "            for permission in baseview.base_permissions:",
            "                state_transitions[\"del_role_pvm\"].discard(",
            "                    (baseview.class_permission_name, permission)",
            "                )",
            "                state_transitions[\"del_perms\"].discard(permission)",
            "",
            "    def create_state_transitions(self, baseviews: List, menus: List) -> Dict:",
            "        \"\"\"",
            "        Creates a Dict with all the necessary vm/permission transitions",
            "",
            "        Dict: {",
            "                \"add\": {(<VM>, <PERM>): ((<VM>, PERM), ... )}",
            "                \"del_role_pvm\": ((<VM>, <PERM>), ...)",
            "                \"del_views\": (<VM>, ... )",
            "                \"del_perms\": (<PERM>, ... )",
            "              }",
            "",
            "        :param baseviews: List with all the registered BaseView, BaseApi",
            "        :param menus: List with all the menu entries",
            "        :return: Dict with state transitions",
            "        \"\"\"",
            "        state_transitions = {",
            "            \"add\": {},",
            "            \"del_role_pvm\": set(),",
            "            \"del_views\": set(),",
            "            \"del_perms\": set(),",
            "        }",
            "        for baseview in baseviews:",
            "            add_all_flag = False",
            "            new_view_name = baseview.class_permission_name",
            "            permission_mapping = self._get_new_old_permissions(baseview)",
            "            if baseview.previous_class_permission_name:",
            "                old_view_name = baseview.previous_class_permission_name",
            "                add_all_flag = True",
            "            else:",
            "                new_view_name = baseview.class_permission_name",
            "                old_view_name = new_view_name",
            "            for new_perm_name in baseview.base_permissions:",
            "                if add_all_flag:",
            "                    old_perm_names = permission_mapping.get(new_perm_name)",
            "                    old_perm_names = old_perm_names or (new_perm_name,)",
            "                    for old_perm_name in old_perm_names:",
            "                        self._add_state_transition(",
            "                            state_transitions,",
            "                            old_view_name,",
            "                            old_perm_name,",
            "                            new_view_name,",
            "                            new_perm_name,",
            "                        )",
            "                else:",
            "                    old_perm_names = permission_mapping.get(new_perm_name) or set()",
            "                    for old_perm_name in old_perm_names:",
            "                        self._add_state_transition(",
            "                            state_transitions,",
            "                            old_view_name,",
            "                            old_perm_name,",
            "                            new_view_name,",
            "                            new_perm_name,",
            "                        )",
            "        self._update_del_transitions(state_transitions, baseviews)",
            "        return state_transitions",
            "",
            "    def security_converge(self, baseviews: List, menus: List, dry=False) -> Dict:",
            "        \"\"\"",
            "        Converges overridden permissions on all registered views/api",
            "        will compute all necessary operations from `class_permissions_name`,",
            "        `previous_class_permission_name`, method_permission_name`,",
            "        `previous_method_permission_name` class attributes.",
            "",
            "        :param baseviews: List of registered views/apis",
            "        :param menus: List of menu items",
            "        :param dry: If True will not change DB",
            "        :return: Dict with the necessary operations (state_transitions)",
            "        \"\"\"",
            "        state_transitions = self.create_state_transitions(baseviews, menus)",
            "        if dry:",
            "            return state_transitions",
            "        if not state_transitions:",
            "            log.info(\"No state transitions found\")",
            "            return dict()",
            "        log.debug(f\"State transitions: {state_transitions}\")",
            "        roles = self.get_all_roles()",
            "        for role in roles:",
            "            permissions = list(role.permissions)",
            "            for pvm in permissions:",
            "                new_pvm_states = state_transitions[\"add\"].get(",
            "                    (pvm.view_menu.name, pvm.permission.name)",
            "                )",
            "                if not new_pvm_states:",
            "                    continue",
            "                for new_pvm_state in new_pvm_states:",
            "                    new_pvm = self.add_permission_view_menu(",
            "                        new_pvm_state[1], new_pvm_state[0]",
            "                    )",
            "                    self.add_permission_role(role, new_pvm)",
            "                if (pvm.view_menu.name, pvm.permission.name) in state_transitions[",
            "                    \"del_role_pvm\"",
            "                ]:",
            "                    self.del_permission_role(role, pvm)",
            "        for pvm in state_transitions[\"del_role_pvm\"]:",
            "            self.del_permission_view_menu(pvm[1], pvm[0], cascade=False)",
            "        for view_name in state_transitions[\"del_views\"]:",
            "            self.del_view_menu(view_name)",
            "        for permission_name in state_transitions[\"del_perms\"]:",
            "            self.del_permission(permission_name)",
            "        return state_transitions",
            "",
            "    \"\"\"",
            "     ---------------------------",
            "     INTERFACE ABSTRACT METHODS",
            "     ---------------------------",
            "",
            "     ---------------------",
            "     PRIMITIVES FOR USERS",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_register_user(self, registration_hash):",
            "        \"\"\"",
            "            Generic function to return user registration",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_register_user(",
            "        self, username, first_name, last_name, email, password=\"\", hashed_password=\"\"",
            "    ):",
            "        \"\"\"",
            "            Generic function to add user registration",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_register_user(self, register_user):",
            "        \"\"\"",
            "            Generic function to delete user registration",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_user_by_id(self, pk):",
            "        \"\"\"",
            "            Generic function to return user by it's id (pk)",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_user(self, username=None, email=None):",
            "        \"\"\"",
            "            Generic function find a user by it's username or email",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_all_users(self):",
            "        \"\"\"",
            "            Generic function that returns all existing users",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_db_role_permissions(self, role_id: int) -> List[object]:",
            "        \"\"\"",
            "        Get all DB permissions from a role id",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_user(self, username, first_name, last_name, email, role, password=\"\"):",
            "        \"\"\"",
            "            Generic function to create user",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def update_user(self, user):",
            "        \"\"\"",
            "            Generic function to update user",
            "",
            "            :param user: User model to update to database",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def count_users(self):",
            "        \"\"\"",
            "            Generic function to count the existing users",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES FOR ROLES",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_role(self, name):",
            "        raise NotImplementedError",
            "",
            "    def add_role(self, name, permissions=None):",
            "        raise NotImplementedError",
            "",
            "    def update_role(self, pk, name):",
            "        raise NotImplementedError",
            "",
            "    def get_all_roles(self):",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------------",
            "     PRIMITIVES FOR PERMISSIONS",
            "    ----------------------------",
            "    \"\"\"",
            "",
            "    def get_public_role(self):",
            "        \"\"\"",
            "            returns all permissions from public role",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_public_permissions(self):",
            "        \"\"\"",
            "            returns all permissions from public role",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_permission(self, name):",
            "        \"\"\"",
            "            Finds and returns a Permission by name",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_roles_permission_view_menus(",
            "        self, permission_name: str, role_ids: List[int]",
            "    ):",
            "        raise NotImplementedError",
            "",
            "    def exist_permission_on_roles(",
            "        self, view_name: str, permission_name: str, role_ids: List[int]",
            "    ) -> bool:",
            "        \"\"\"",
            "            Finds and returns permission views for a group of roles",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_permission(self, name):",
            "        \"\"\"",
            "            Adds a permission to the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_permission(self, name):",
            "        \"\"\"",
            "            Deletes a permission from the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_view_menu(self, name):",
            "        \"\"\"",
            "            Finds and returns a ViewMenu by name",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def get_all_view_menu(self):",
            "        raise NotImplementedError",
            "",
            "    def add_view_menu(self, name):",
            "        \"\"\"",
            "            Adds a view or menu to the backend, model view_menu",
            "            param name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_view_menu(self, name):",
            "        \"\"\"",
            "            Deletes a ViewMenu from the backend",
            "",
            "            :param name:",
            "                name of the ViewMenu",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PERMISSION VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Finds and returns a PermissionView by names",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def find_permissions_view_menu(self, view_menu):",
            "        \"\"\"",
            "            Finds all permissions from ViewMenu, returns list of PermissionView",
            "",
            "            :param view_menu: ViewMenu object",
            "            :return: list of PermissionView objects",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def add_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Adds a permission on a view or menu to the backend",
            "",
            "            :param permission_name:",
            "                name of the permission to add: 'can_add','can_edit' etc...",
            "            :param view_menu_name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_permission_view_menu(self, permission_name, view_menu_name, cascade=True):",
            "        raise NotImplementedError",
            "",
            "    def exist_permission_on_views(self, lst, item):",
            "        raise NotImplementedError",
            "",
            "    def exist_permission_on_view(self, lst, permission, view_menu):",
            "        raise NotImplementedError",
            "",
            "    def add_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Add permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def del_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Remove permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def export_roles(",
            "        self, path: Optional[str] = None, indent: Optional[Union[int, str]] = None",
            "    ) -> None:",
            "        \"\"\" Exports roles to JSON file. \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def import_roles(self, path: str) -> None:",
            "        \"\"\" Imports roles from JSON file. \"\"\"",
            "        raise NotImplementedError",
            "",
            "    def load_user(self, pk):",
            "        return self.get_user_by_id(int(pk))",
            "",
            "    def load_user_jwt(self, pk):",
            "        user = self.load_user(pk)",
            "        # Set flask g.user to JWT user, we can't do it on before request",
            "        g.user = user",
            "        return user",
            "",
            "    @staticmethod",
            "    def before_request():",
            "        g.user = current_user"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "6": [],
            "2026": [
                "BaseSecurityManager",
                "export_roles"
            ]
        },
        "addLocation": []
    },
    "flask_appbuilder/security/mongoengine/manager.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from datetime import datetime"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " import json"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import logging"
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from typing import List, Optional"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from typing import List, Optional, Union"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import uuid"
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from werkzeug.security import generate_password_hash"
            },
            "8": {
                "beforePatchRowNumber": 408,
                "afterPatchRowNumber": 408,
                "PatchRowcode": "             except Exception as e:"
            },
            "9": {
                "beforePatchRowNumber": 409,
                "afterPatchRowNumber": 409,
                "PatchRowcode": "                 log.error(c.LOGMSG_ERR_SEC_DEL_PERMROLE.format(str(e)))"
            },
            "10": {
                "beforePatchRowNumber": 410,
                "afterPatchRowNumber": 410,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": 411,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def export_roles(self, path: Optional[str] = None) -> None:"
            },
            "12": {
                "beforePatchRowNumber": 412,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\" Exports roles to JSON file. \"\"\""
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 411,
                "PatchRowcode": "+    def export_roles("
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 412,
                "PatchRowcode": "+        self, path: Optional[str] = None, indent: Optional[Union[int, str]] = None"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 413,
                "PatchRowcode": "+    ) -> None:"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 414,
                "PatchRowcode": "+        \"\"\"Exports roles to JSON file.\"\"\""
            },
            "17": {
                "beforePatchRowNumber": 413,
                "afterPatchRowNumber": 415,
                "PatchRowcode": "         timestamp = datetime.now().strftime(\"%Y%m%dT%H%M%S\")"
            },
            "18": {
                "beforePatchRowNumber": 414,
                "afterPatchRowNumber": 416,
                "PatchRowcode": "         filename = path or f\"roles_export_{timestamp}.json\""
            },
            "19": {
                "beforePatchRowNumber": 415,
                "afterPatchRowNumber": 417,
                "PatchRowcode": " "
            },
            "20": {
                "beforePatchRowNumber": 430,
                "afterPatchRowNumber": 432,
                "PatchRowcode": "             serialized_roles.append(serialized_role)"
            },
            "21": {
                "beforePatchRowNumber": 431,
                "afterPatchRowNumber": 433,
                "PatchRowcode": " "
            },
            "22": {
                "beforePatchRowNumber": 432,
                "afterPatchRowNumber": 434,
                "PatchRowcode": "         with open(filename, \"w\") as fd:"
            },
            "23": {
                "beforePatchRowNumber": 433,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            fd.write(json.dumps(serialized_roles))"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 435,
                "PatchRowcode": "+            fd.write(json.dumps(serialized_roles, indent=indent))"
            },
            "25": {
                "beforePatchRowNumber": 434,
                "afterPatchRowNumber": 436,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 435,
                "afterPatchRowNumber": 437,
                "PatchRowcode": "     def import_roles(self, path: str) -> None:"
            },
            "27": {
                "beforePatchRowNumber": 436,
                "afterPatchRowNumber": 438,
                "PatchRowcode": "         \"\"\" Imports roles from JSON file. \"\"\""
            }
        },
        "frontPatchFile": [
            "from datetime import datetime",
            "import json",
            "import logging",
            "from typing import List, Optional",
            "import uuid",
            "",
            "from werkzeug.security import generate_password_hash",
            "",
            "from .models import Permission, PermissionView, RegisterUser, Role, User, ViewMenu",
            "from ..manager import BaseSecurityManager",
            "from ... import const as c",
            "from ...models.mongoengine.interface import MongoEngineInterface",
            "",
            "log = logging.getLogger(__name__)",
            "",
            "",
            "class SecurityManager(BaseSecurityManager):",
            "    \"\"\"",
            "        Responsible for authentication, registering security views,",
            "        role and permission auto management",
            "",
            "        If you want to change anything just inherit and override, then",
            "        pass your own security manager to AppBuilder.",
            "    \"\"\"",
            "",
            "    user_model = User",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    role_model = Role",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    permission_model = Permission",
            "    viewmenu_model = ViewMenu",
            "    permissionview_model = PermissionView",
            "    registeruser_model = RegisterUser",
            "",
            "    def __init__(self, appbuilder):",
            "        \"\"\"",
            "            SecurityManager contructor",
            "            param appbuilder:",
            "                F.A.B AppBuilder main object",
            "        \"\"\"",
            "        super(SecurityManager, self).__init__(appbuilder)",
            "        user_datamodel = MongoEngineInterface(self.user_model)",
            "        if self.auth_type == c.AUTH_DB:",
            "            self.userdbmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_LDAP:",
            "            self.userldapmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OID:",
            "            self.useroidmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OAUTH:",
            "            self.useroauthmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_REMOTE_USER:",
            "            self.userremoteusermodelview.datamodel = user_datamodel",
            "",
            "        self.userstatschartview.datamodel = MongoEngineInterface(self.user_model)",
            "        if self.auth_user_registration:",
            "            self.registerusermodelview.datamodel = MongoEngineInterface(",
            "                self.registeruser_model",
            "            )",
            "",
            "        self.rolemodelview.datamodel = MongoEngineInterface(self.role_model)",
            "        self.permissionmodelview.datamodel = MongoEngineInterface(self.permission_model)",
            "        self.viewmenumodelview.datamodel = MongoEngineInterface(self.viewmenu_model)",
            "        self.permissionviewmodelview.datamodel = MongoEngineInterface(",
            "            self.permissionview_model",
            "        )",
            "        self.create_db()",
            "",
            "    def find_register_user(self, registration_hash):",
            "        return self.registeruser_model.objects(",
            "            registration_hash=registration_hash",
            "        ).first()",
            "",
            "    def add_register_user(",
            "        self, username, first_name, last_name, email, password=\"\", hashed_password=\"\"",
            "    ):",
            "        try:",
            "            register_user = self.registeruser_model()",
            "            register_user.first_name = first_name",
            "            register_user.last_name = last_name",
            "            register_user.username = username",
            "            register_user.email = email",
            "            if hashed_password:",
            "                register_user.password = hashed_password",
            "            else:",
            "                register_user.password = generate_password_hash(password)",
            "            register_user.registration_hash = str(uuid.uuid1())",
            "            register_user.save()",
            "            return register_user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_REGISTER_USER.format(str(e)))",
            "            return False",
            "",
            "    def del_register_user(self, register_user):",
            "        try:",
            "            register_user.delete()",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_REGISTER_USER.format(str(e)))",
            "",
            "    def find_user(self, username=None, email=None):",
            "        if username:",
            "            return self.user_model.objects(username=username).first()",
            "        elif email:",
            "            return self.user_model.objects(email=email).first()",
            "",
            "    def get_all_users(self):",
            "        return User.objects",
            "",
            "    def add_user(",
            "        self,",
            "        username,",
            "        first_name,",
            "        last_name,",
            "        email,",
            "        role,",
            "        password=\"\",",
            "        hashed_password=\"\",",
            "    ):",
            "        \"\"\"",
            "            Generic function to create user",
            "        \"\"\"",
            "        try:",
            "            user = self.user_model()",
            "            user.first_name = first_name",
            "            user.last_name = last_name",
            "            user.username = username",
            "            user.email = email",
            "            user.active = True",
            "            user.roles = role if isinstance(role, list) else [role]",
            "            if hashed_password:",
            "                user.password = hashed_password",
            "            else:",
            "                user.password = generate_password_hash(password)",
            "            user.save()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_USER.format(username))",
            "            return user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_USER.format(str(e)))",
            "            return False",
            "",
            "    def count_users(self):",
            "        return len(self.user_model.objects)",
            "",
            "    def update_user(self, user):",
            "        try:",
            "            user.save()",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_USER.format(str(e)))",
            "            return False",
            "",
            "    def get_user_by_id(self, pk):",
            "        return self.user_model.objects(pk=pk).first()",
            "",
            "    def load_user(self, pk):",
            "        return self.get_user_by_id(pk)",
            "",
            "    \"\"\"",
            "    -----------------------",
            "     PERMISSION MANAGEMENT",
            "    -----------------------",
            "    \"\"\"",
            "",
            "    def add_role(",
            "        self, name: str, permissions: Optional[List[PermissionView]] = None",
            "    ) -> Optional[Role]:",
            "        if not permissions:",
            "            permissions = []",
            "",
            "        role = self.find_role(name)",
            "        if role is None:",
            "            try:",
            "                role = self.role_model(name=name, permissions=permissions)",
            "                role.save()",
            "                log.info(c.LOGMSG_INF_SEC_ADD_ROLE.format(name))",
            "                return role",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_ROLE.format(str(e)))",
            "        return role",
            "",
            "    def update_role(self, pk, name: str) -> Optional[Role]:",
            "        try:",
            "            role = self.role_model.objects(id=pk).update(name=name)",
            "            log.info(c.LOGMSG_INF_SEC_UPD_ROLE.format(role))",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_ROLE.format(str(e)))",
            "            return",
            "",
            "    def find_role(self, name):",
            "        return self.role_model.objects(name=name).first()",
            "",
            "    def get_all_roles(self):",
            "        return self.role_model.objects",
            "",
            "    def get_public_permissions(self):",
            "        role = self.find_role(self.auth_role_public)",
            "        return role.permissions",
            "",
            "    def find_permission(self, name):",
            "        \"\"\"",
            "            Finds and returns a Permission by name",
            "        \"\"\"",
            "        return self.permission_model.objects(name=name).first()",
            "",
            "    def exist_permission_on_roles(",
            "        self, view_name: str, permission_name: str, role_ids: List[int]",
            "    ) -> bool:",
            "        for role_id in role_ids:",
            "            role = self.role_model.objects(id=role_id).first()",
            "            permissions = role.permissions",
            "            if permissions:",
            "                for permission in permissions:",
            "                    if (view_name == permission.view_menu.name) and (",
            "                        permission_name == permission.permission.name",
            "                    ):",
            "                        return True",
            "        return False",
            "",
            "    def add_permission(self, name):",
            "        \"\"\"",
            "            Adds a permission to the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if perm is None:",
            "            try:",
            "                perm = self.permission_model(name=name)",
            "                perm.save()",
            "                return perm",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMISSION.format(str(e)))",
            "        return perm",
            "",
            "    def del_permission(self, name):",
            "        \"\"\"",
            "            Deletes a permission from the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if perm:",
            "            try:",
            "                perm.delete()",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_view_menu(self, name):",
            "        \"\"\"",
            "            Finds and returns a ViewMenu by name",
            "        \"\"\"",
            "        return self.viewmenu_model.objects(name=name).first()",
            "",
            "    def get_all_view_menu(self):",
            "        return self.viewmenu_model.objects",
            "",
            "    def add_view_menu(self, name):",
            "        \"\"\"",
            "            Adds a view or menu to the backend, model view_menu",
            "            param name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        view_menu = self.find_view_menu(name)",
            "        if view_menu is None:",
            "            try:",
            "                view_menu = self.viewmenu_model(name=name)",
            "                view_menu.save()",
            "                return view_menu",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_VIEWMENU.format(str(e)))",
            "        return view_menu",
            "",
            "    def del_view_menu(self, name):",
            "        \"\"\"",
            "            Deletes a ViewMenu from the backend",
            "",
            "            :param name:",
            "                name of the ViewMenu",
            "        \"\"\"",
            "        obj = self.find_view_menu(name)",
            "        if obj:",
            "            try:",
            "                obj.delete()",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PERMISSION VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Finds and returns a PermissionView by names",
            "        \"\"\"",
            "        permission = self.find_permission(permission_name)",
            "        view_menu = self.find_view_menu(view_menu_name)",
            "        if permission and view_menu:",
            "            return self.permissionview_model.objects(",
            "                permission=permission, view_menu=view_menu",
            "            ).first()",
            "",
            "    def find_permissions_view_menu(self, view_menu):",
            "        \"\"\"",
            "            Finds all permissions from ViewMenu, returns list of PermissionView",
            "",
            "            :param view_menu: ViewMenu object",
            "            :return: list of PermissionView objects",
            "        \"\"\"",
            "        return self.permissionview_model.objects(view_menu=view_menu)",
            "",
            "    def add_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Adds a permission on a view or menu to the backend",
            "",
            "            :param permission_name:",
            "                name of the permission to add: 'can_add','can_edit' etc...",
            "            :param view_menu_name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        if not (permission_name and view_menu_name):",
            "            return None",
            "        pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "        if pv:",
            "            return pv",
            "        vm = self.add_view_menu(view_menu_name)",
            "        perm = self.add_permission(permission_name)",
            "        pv = self.permissionview_model()",
            "        pv.view_menu, pv.permission = vm, perm",
            "        try:",
            "            pv.save()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_PERMVIEW.format(str(pv)))",
            "            return pv",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_PERMVIEW.format(str(e)))",
            "",
            "    def del_permission_view_menu(self, permission_name, view_menu_name, cascade=True):",
            "        try:",
            "            pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "            # delete permission on view",
            "            pv.delete()",
            "            if not cascade:",
            "                return",
            "            # if no more permission on permission view, delete permission",
            "            pv = self.permissionview_model.objects(permission=pv.permission)",
            "            if not pv:",
            "                self.del_permission(pv.permission.name)",
            "            log.info(",
            "                c.LOGMSG_INF_SEC_DEL_PERMVIEW.format(permission_name, view_menu_name)",
            "            )",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMVIEW.format(str(e)))",
            "",
            "    def exist_permission_on_views(self, lst, item):",
            "        for i in lst:",
            "            if i.permission.name == item:",
            "                return True",
            "        return False",
            "",
            "    def exist_permission_on_view(self, lst, permission, view_menu):",
            "        for i in lst:",
            "            if i.permission.name == permission and i.view_menu.name == view_menu:",
            "                return True",
            "        return False",
            "",
            "    def add_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Add permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view and perm_view not in role.permissions:",
            "            try:",
            "                role.permissions.append(perm_view)",
            "                role.save()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_ADD_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMROLE.format(str(e)))",
            "",
            "    def del_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Remove permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view in role.permissions:",
            "            try:",
            "                role.permissions.remove(perm_view)",
            "                role.save()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_DEL_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMROLE.format(str(e)))",
            "",
            "    def export_roles(self, path: Optional[str] = None) -> None:",
            "        \"\"\" Exports roles to JSON file. \"\"\"",
            "        timestamp = datetime.now().strftime(\"%Y%m%dT%H%M%S\")",
            "        filename = path or f\"roles_export_{timestamp}.json\"",
            "",
            "        roles = self.get_all_roles()",
            "",
            "        serialized_roles = []",
            "",
            "        for role in roles:",
            "            serialized_role = {\"name\": role.name, \"permissions\": []}",
            "            for pvm in role.permissions:",
            "                permission = pvm.permission",
            "                view_menu = pvm.view_menu",
            "                permission_view_menu = {",
            "                    \"permission\": {\"name\": permission.name},",
            "                    \"view_menu\": {\"name\": view_menu.name},",
            "                }",
            "                serialized_role[\"permissions\"].append(permission_view_menu)",
            "            serialized_roles.append(serialized_role)",
            "",
            "        with open(filename, \"w\") as fd:",
            "            fd.write(json.dumps(serialized_roles))",
            "",
            "    def import_roles(self, path: str) -> None:",
            "        \"\"\" Imports roles from JSON file. \"\"\"",
            "        with open(path, \"r\") as fd:",
            "            serialized_roles = json.loads(fd.read())",
            "",
            "        for role_kwargs in serialized_roles:",
            "            role = self.add_role(role_kwargs[\"name\"])",
            "",
            "            permission_view_menus = [",
            "                self.add_permission_view_menu(",
            "                    permission_name=pvm_kwargs[\"permission\"][\"name\"],",
            "                    view_menu_name=pvm_kwargs[\"view_menu\"][\"name\"],",
            "                )",
            "                for pvm_kwargs in role_kwargs[\"permissions\"]",
            "            ]",
            "            role.permissions = permission_view_menus",
            "",
            "            role.save()",
            "",
            "    def get_first_user(self) -> \"User\":",
            "        return self.user_model.objects.first()",
            "",
            "    def noop_user_update(self, user: \"User\") -> None:",
            "        pass"
        ],
        "afterPatchFile": [
            "from datetime import datetime",
            "import json",
            "import logging",
            "from typing import List, Optional, Union",
            "import uuid",
            "",
            "from werkzeug.security import generate_password_hash",
            "",
            "from .models import Permission, PermissionView, RegisterUser, Role, User, ViewMenu",
            "from ..manager import BaseSecurityManager",
            "from ... import const as c",
            "from ...models.mongoengine.interface import MongoEngineInterface",
            "",
            "log = logging.getLogger(__name__)",
            "",
            "",
            "class SecurityManager(BaseSecurityManager):",
            "    \"\"\"",
            "        Responsible for authentication, registering security views,",
            "        role and permission auto management",
            "",
            "        If you want to change anything just inherit and override, then",
            "        pass your own security manager to AppBuilder.",
            "    \"\"\"",
            "",
            "    user_model = User",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    role_model = Role",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    permission_model = Permission",
            "    viewmenu_model = ViewMenu",
            "    permissionview_model = PermissionView",
            "    registeruser_model = RegisterUser",
            "",
            "    def __init__(self, appbuilder):",
            "        \"\"\"",
            "            SecurityManager contructor",
            "            param appbuilder:",
            "                F.A.B AppBuilder main object",
            "        \"\"\"",
            "        super(SecurityManager, self).__init__(appbuilder)",
            "        user_datamodel = MongoEngineInterface(self.user_model)",
            "        if self.auth_type == c.AUTH_DB:",
            "            self.userdbmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_LDAP:",
            "            self.userldapmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OID:",
            "            self.useroidmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OAUTH:",
            "            self.useroauthmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_REMOTE_USER:",
            "            self.userremoteusermodelview.datamodel = user_datamodel",
            "",
            "        self.userstatschartview.datamodel = MongoEngineInterface(self.user_model)",
            "        if self.auth_user_registration:",
            "            self.registerusermodelview.datamodel = MongoEngineInterface(",
            "                self.registeruser_model",
            "            )",
            "",
            "        self.rolemodelview.datamodel = MongoEngineInterface(self.role_model)",
            "        self.permissionmodelview.datamodel = MongoEngineInterface(self.permission_model)",
            "        self.viewmenumodelview.datamodel = MongoEngineInterface(self.viewmenu_model)",
            "        self.permissionviewmodelview.datamodel = MongoEngineInterface(",
            "            self.permissionview_model",
            "        )",
            "        self.create_db()",
            "",
            "    def find_register_user(self, registration_hash):",
            "        return self.registeruser_model.objects(",
            "            registration_hash=registration_hash",
            "        ).first()",
            "",
            "    def add_register_user(",
            "        self, username, first_name, last_name, email, password=\"\", hashed_password=\"\"",
            "    ):",
            "        try:",
            "            register_user = self.registeruser_model()",
            "            register_user.first_name = first_name",
            "            register_user.last_name = last_name",
            "            register_user.username = username",
            "            register_user.email = email",
            "            if hashed_password:",
            "                register_user.password = hashed_password",
            "            else:",
            "                register_user.password = generate_password_hash(password)",
            "            register_user.registration_hash = str(uuid.uuid1())",
            "            register_user.save()",
            "            return register_user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_REGISTER_USER.format(str(e)))",
            "            return False",
            "",
            "    def del_register_user(self, register_user):",
            "        try:",
            "            register_user.delete()",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_REGISTER_USER.format(str(e)))",
            "",
            "    def find_user(self, username=None, email=None):",
            "        if username:",
            "            return self.user_model.objects(username=username).first()",
            "        elif email:",
            "            return self.user_model.objects(email=email).first()",
            "",
            "    def get_all_users(self):",
            "        return User.objects",
            "",
            "    def add_user(",
            "        self,",
            "        username,",
            "        first_name,",
            "        last_name,",
            "        email,",
            "        role,",
            "        password=\"\",",
            "        hashed_password=\"\",",
            "    ):",
            "        \"\"\"",
            "            Generic function to create user",
            "        \"\"\"",
            "        try:",
            "            user = self.user_model()",
            "            user.first_name = first_name",
            "            user.last_name = last_name",
            "            user.username = username",
            "            user.email = email",
            "            user.active = True",
            "            user.roles = role if isinstance(role, list) else [role]",
            "            if hashed_password:",
            "                user.password = hashed_password",
            "            else:",
            "                user.password = generate_password_hash(password)",
            "            user.save()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_USER.format(username))",
            "            return user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_USER.format(str(e)))",
            "            return False",
            "",
            "    def count_users(self):",
            "        return len(self.user_model.objects)",
            "",
            "    def update_user(self, user):",
            "        try:",
            "            user.save()",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_USER.format(str(e)))",
            "            return False",
            "",
            "    def get_user_by_id(self, pk):",
            "        return self.user_model.objects(pk=pk).first()",
            "",
            "    def load_user(self, pk):",
            "        return self.get_user_by_id(pk)",
            "",
            "    \"\"\"",
            "    -----------------------",
            "     PERMISSION MANAGEMENT",
            "    -----------------------",
            "    \"\"\"",
            "",
            "    def add_role(",
            "        self, name: str, permissions: Optional[List[PermissionView]] = None",
            "    ) -> Optional[Role]:",
            "        if not permissions:",
            "            permissions = []",
            "",
            "        role = self.find_role(name)",
            "        if role is None:",
            "            try:",
            "                role = self.role_model(name=name, permissions=permissions)",
            "                role.save()",
            "                log.info(c.LOGMSG_INF_SEC_ADD_ROLE.format(name))",
            "                return role",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_ROLE.format(str(e)))",
            "        return role",
            "",
            "    def update_role(self, pk, name: str) -> Optional[Role]:",
            "        try:",
            "            role = self.role_model.objects(id=pk).update(name=name)",
            "            log.info(c.LOGMSG_INF_SEC_UPD_ROLE.format(role))",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_ROLE.format(str(e)))",
            "            return",
            "",
            "    def find_role(self, name):",
            "        return self.role_model.objects(name=name).first()",
            "",
            "    def get_all_roles(self):",
            "        return self.role_model.objects",
            "",
            "    def get_public_permissions(self):",
            "        role = self.find_role(self.auth_role_public)",
            "        return role.permissions",
            "",
            "    def find_permission(self, name):",
            "        \"\"\"",
            "            Finds and returns a Permission by name",
            "        \"\"\"",
            "        return self.permission_model.objects(name=name).first()",
            "",
            "    def exist_permission_on_roles(",
            "        self, view_name: str, permission_name: str, role_ids: List[int]",
            "    ) -> bool:",
            "        for role_id in role_ids:",
            "            role = self.role_model.objects(id=role_id).first()",
            "            permissions = role.permissions",
            "            if permissions:",
            "                for permission in permissions:",
            "                    if (view_name == permission.view_menu.name) and (",
            "                        permission_name == permission.permission.name",
            "                    ):",
            "                        return True",
            "        return False",
            "",
            "    def add_permission(self, name):",
            "        \"\"\"",
            "            Adds a permission to the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if perm is None:",
            "            try:",
            "                perm = self.permission_model(name=name)",
            "                perm.save()",
            "                return perm",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMISSION.format(str(e)))",
            "        return perm",
            "",
            "    def del_permission(self, name):",
            "        \"\"\"",
            "            Deletes a permission from the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if perm:",
            "            try:",
            "                perm.delete()",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_view_menu(self, name):",
            "        \"\"\"",
            "            Finds and returns a ViewMenu by name",
            "        \"\"\"",
            "        return self.viewmenu_model.objects(name=name).first()",
            "",
            "    def get_all_view_menu(self):",
            "        return self.viewmenu_model.objects",
            "",
            "    def add_view_menu(self, name):",
            "        \"\"\"",
            "            Adds a view or menu to the backend, model view_menu",
            "            param name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        view_menu = self.find_view_menu(name)",
            "        if view_menu is None:",
            "            try:",
            "                view_menu = self.viewmenu_model(name=name)",
            "                view_menu.save()",
            "                return view_menu",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_VIEWMENU.format(str(e)))",
            "        return view_menu",
            "",
            "    def del_view_menu(self, name):",
            "        \"\"\"",
            "            Deletes a ViewMenu from the backend",
            "",
            "            :param name:",
            "                name of the ViewMenu",
            "        \"\"\"",
            "        obj = self.find_view_menu(name)",
            "        if obj:",
            "            try:",
            "                obj.delete()",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PERMISSION VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Finds and returns a PermissionView by names",
            "        \"\"\"",
            "        permission = self.find_permission(permission_name)",
            "        view_menu = self.find_view_menu(view_menu_name)",
            "        if permission and view_menu:",
            "            return self.permissionview_model.objects(",
            "                permission=permission, view_menu=view_menu",
            "            ).first()",
            "",
            "    def find_permissions_view_menu(self, view_menu):",
            "        \"\"\"",
            "            Finds all permissions from ViewMenu, returns list of PermissionView",
            "",
            "            :param view_menu: ViewMenu object",
            "            :return: list of PermissionView objects",
            "        \"\"\"",
            "        return self.permissionview_model.objects(view_menu=view_menu)",
            "",
            "    def add_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Adds a permission on a view or menu to the backend",
            "",
            "            :param permission_name:",
            "                name of the permission to add: 'can_add','can_edit' etc...",
            "            :param view_menu_name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        if not (permission_name and view_menu_name):",
            "            return None",
            "        pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "        if pv:",
            "            return pv",
            "        vm = self.add_view_menu(view_menu_name)",
            "        perm = self.add_permission(permission_name)",
            "        pv = self.permissionview_model()",
            "        pv.view_menu, pv.permission = vm, perm",
            "        try:",
            "            pv.save()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_PERMVIEW.format(str(pv)))",
            "            return pv",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_PERMVIEW.format(str(e)))",
            "",
            "    def del_permission_view_menu(self, permission_name, view_menu_name, cascade=True):",
            "        try:",
            "            pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "            # delete permission on view",
            "            pv.delete()",
            "            if not cascade:",
            "                return",
            "            # if no more permission on permission view, delete permission",
            "            pv = self.permissionview_model.objects(permission=pv.permission)",
            "            if not pv:",
            "                self.del_permission(pv.permission.name)",
            "            log.info(",
            "                c.LOGMSG_INF_SEC_DEL_PERMVIEW.format(permission_name, view_menu_name)",
            "            )",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMVIEW.format(str(e)))",
            "",
            "    def exist_permission_on_views(self, lst, item):",
            "        for i in lst:",
            "            if i.permission.name == item:",
            "                return True",
            "        return False",
            "",
            "    def exist_permission_on_view(self, lst, permission, view_menu):",
            "        for i in lst:",
            "            if i.permission.name == permission and i.view_menu.name == view_menu:",
            "                return True",
            "        return False",
            "",
            "    def add_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Add permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view and perm_view not in role.permissions:",
            "            try:",
            "                role.permissions.append(perm_view)",
            "                role.save()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_ADD_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMROLE.format(str(e)))",
            "",
            "    def del_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Remove permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view in role.permissions:",
            "            try:",
            "                role.permissions.remove(perm_view)",
            "                role.save()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_DEL_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMROLE.format(str(e)))",
            "",
            "    def export_roles(",
            "        self, path: Optional[str] = None, indent: Optional[Union[int, str]] = None",
            "    ) -> None:",
            "        \"\"\"Exports roles to JSON file.\"\"\"",
            "        timestamp = datetime.now().strftime(\"%Y%m%dT%H%M%S\")",
            "        filename = path or f\"roles_export_{timestamp}.json\"",
            "",
            "        roles = self.get_all_roles()",
            "",
            "        serialized_roles = []",
            "",
            "        for role in roles:",
            "            serialized_role = {\"name\": role.name, \"permissions\": []}",
            "            for pvm in role.permissions:",
            "                permission = pvm.permission",
            "                view_menu = pvm.view_menu",
            "                permission_view_menu = {",
            "                    \"permission\": {\"name\": permission.name},",
            "                    \"view_menu\": {\"name\": view_menu.name},",
            "                }",
            "                serialized_role[\"permissions\"].append(permission_view_menu)",
            "            serialized_roles.append(serialized_role)",
            "",
            "        with open(filename, \"w\") as fd:",
            "            fd.write(json.dumps(serialized_roles, indent=indent))",
            "",
            "    def import_roles(self, path: str) -> None:",
            "        \"\"\" Imports roles from JSON file. \"\"\"",
            "        with open(path, \"r\") as fd:",
            "            serialized_roles = json.loads(fd.read())",
            "",
            "        for role_kwargs in serialized_roles:",
            "            role = self.add_role(role_kwargs[\"name\"])",
            "",
            "            permission_view_menus = [",
            "                self.add_permission_view_menu(",
            "                    permission_name=pvm_kwargs[\"permission\"][\"name\"],",
            "                    view_menu_name=pvm_kwargs[\"view_menu\"][\"name\"],",
            "                )",
            "                for pvm_kwargs in role_kwargs[\"permissions\"]",
            "            ]",
            "            role.permissions = permission_view_menus",
            "",
            "            role.save()",
            "",
            "    def get_first_user(self) -> \"User\":",
            "        return self.user_model.objects.first()",
            "",
            "    def noop_user_update(self, user: \"User\") -> None:",
            "        pass"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "4": [],
            "411": [
                "SecurityManager",
                "export_roles"
            ],
            "412": [
                "SecurityManager",
                "export_roles"
            ],
            "433": [
                "SecurityManager",
                "export_roles"
            ]
        },
        "addLocation": []
    },
    "flask_appbuilder/security/sqla/manager.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " from datetime import datetime"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " import json"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import logging"
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from typing import List, Optional"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from typing import List, Optional, Union"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import uuid"
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from sqlalchemy import and_, func, literal, update"
            },
            "8": {
                "beforePatchRowNumber": 660,
                "afterPatchRowNumber": 660,
                "PatchRowcode": "                 log.error(c.LOGMSG_ERR_SEC_DEL_PERMROLE.format(str(e)))"
            },
            "9": {
                "beforePatchRowNumber": 661,
                "afterPatchRowNumber": 661,
                "PatchRowcode": "                 self.get_session.rollback()"
            },
            "10": {
                "beforePatchRowNumber": 662,
                "afterPatchRowNumber": 662,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": 663,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def export_roles(self, path: Optional[str] = None) -> None:"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 663,
                "PatchRowcode": "+    def export_roles("
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 664,
                "PatchRowcode": "+        self, path: Optional[str] = None, indent: Optional[Union[int, str]] = None"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 665,
                "PatchRowcode": "+    ) -> None:"
            },
            "15": {
                "beforePatchRowNumber": 664,
                "afterPatchRowNumber": 666,
                "PatchRowcode": "         \"\"\" Exports roles to JSON file. \"\"\""
            },
            "16": {
                "beforePatchRowNumber": 665,
                "afterPatchRowNumber": 667,
                "PatchRowcode": "         timestamp = datetime.now().strftime(\"%Y%m%dT%H%M%S\")"
            },
            "17": {
                "beforePatchRowNumber": 666,
                "afterPatchRowNumber": 668,
                "PatchRowcode": "         filename = path or f\"roles_export_{timestamp}.json\""
            },
            "18": {
                "beforePatchRowNumber": 680,
                "afterPatchRowNumber": 682,
                "PatchRowcode": "             serialized_roles.append(serialized_role)"
            },
            "19": {
                "beforePatchRowNumber": 681,
                "afterPatchRowNumber": 683,
                "PatchRowcode": " "
            },
            "20": {
                "beforePatchRowNumber": 682,
                "afterPatchRowNumber": 684,
                "PatchRowcode": "         with open(filename, \"w\") as fd:"
            },
            "21": {
                "beforePatchRowNumber": 683,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            fd.write(json.dumps(serialized_roles))"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 685,
                "PatchRowcode": "+            fd.write(json.dumps(serialized_roles, indent=indent))"
            },
            "23": {
                "beforePatchRowNumber": 684,
                "afterPatchRowNumber": 686,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": 685,
                "afterPatchRowNumber": 687,
                "PatchRowcode": "     def import_roles(self, path: str) -> None:"
            },
            "25": {
                "beforePatchRowNumber": 686,
                "afterPatchRowNumber": 688,
                "PatchRowcode": "         \"\"\" Imports roles from JSON file. \"\"\""
            }
        },
        "frontPatchFile": [
            "from datetime import datetime",
            "import json",
            "import logging",
            "from typing import List, Optional",
            "import uuid",
            "",
            "from sqlalchemy import and_, func, literal, update",
            "from sqlalchemy.engine.reflection import Inspector",
            "from sqlalchemy.orm import contains_eager",
            "from sqlalchemy.orm.exc import MultipleResultsFound",
            "from werkzeug.security import generate_password_hash",
            "",
            "from .models import (",
            "    assoc_permissionview_role,",
            "    Permission,",
            "    PermissionView,",
            "    RegisterUser,",
            "    Role,",
            "    User,",
            "    ViewMenu,",
            ")",
            "from ..manager import BaseSecurityManager",
            "from ... import const as c",
            "from ...models.sqla import Base",
            "from ...models.sqla.interface import SQLAInterface",
            "",
            "log = logging.getLogger(__name__)",
            "",
            "",
            "class SecurityManager(BaseSecurityManager):",
            "    \"\"\"",
            "        Responsible for authentication, registering security views,",
            "        role and permission auto management",
            "",
            "        If you want to change anything just inherit and override, then",
            "        pass your own security manager to AppBuilder.",
            "    \"\"\"",
            "",
            "    user_model = User",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    role_model = Role",
            "    \"\"\" Override to set your own Role Model \"\"\"",
            "    permission_model = Permission",
            "    viewmenu_model = ViewMenu",
            "    permissionview_model = PermissionView",
            "    registeruser_model = RegisterUser",
            "",
            "    def __init__(self, appbuilder):",
            "        \"\"\"",
            "            SecurityManager contructor",
            "            param appbuilder:",
            "                F.A.B AppBuilder main object",
            "        \"\"\"",
            "        super(SecurityManager, self).__init__(appbuilder)",
            "        user_datamodel = SQLAInterface(self.user_model)",
            "        if self.auth_type == c.AUTH_DB:",
            "            self.userdbmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_LDAP:",
            "            self.userldapmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OID:",
            "            self.useroidmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OAUTH:",
            "            self.useroauthmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_REMOTE_USER:",
            "            self.userremoteusermodelview.datamodel = user_datamodel",
            "",
            "        if self.userstatschartview:",
            "            self.userstatschartview.datamodel = user_datamodel",
            "        if self.auth_user_registration:",
            "            self.registerusermodelview.datamodel = SQLAInterface(",
            "                self.registeruser_model",
            "            )",
            "",
            "        self.rolemodelview.datamodel = SQLAInterface(self.role_model)",
            "        self.permissionmodelview.datamodel = SQLAInterface(self.permission_model)",
            "        self.viewmenumodelview.datamodel = SQLAInterface(self.viewmenu_model)",
            "        self.permissionviewmodelview.datamodel = SQLAInterface(",
            "            self.permissionview_model",
            "        )",
            "        self.create_db()",
            "",
            "    @property",
            "    def get_session(self):",
            "        return self.appbuilder.get_session",
            "",
            "    def register_views(self):",
            "        super(SecurityManager, self).register_views()",
            "",
            "    def create_db(self):",
            "        try:",
            "            engine = self.get_session.get_bind(mapper=None, clause=None)",
            "            inspector = Inspector.from_engine(engine)",
            "            if \"ab_user\" not in inspector.get_table_names():",
            "                log.info(c.LOGMSG_INF_SEC_NO_DB)",
            "                Base.metadata.create_all(engine)",
            "                log.info(c.LOGMSG_INF_SEC_ADD_DB)",
            "            super(SecurityManager, self).create_db()",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_CREATE_DB.format(str(e)))",
            "            exit(1)",
            "",
            "    def find_register_user(self, registration_hash):",
            "        return (",
            "            self.get_session.query(self.registeruser_model)",
            "            .filter(self.registeruser_model.registration_hash == registration_hash)",
            "            .scalar()",
            "        )",
            "",
            "    def add_register_user(",
            "        self, username, first_name, last_name, email, password=\"\", hashed_password=\"\"",
            "    ):",
            "        \"\"\"",
            "            Add a registration request for the user.",
            "",
            "            :rtype : RegisterUser",
            "        \"\"\"",
            "        register_user = self.registeruser_model()",
            "        register_user.username = username",
            "        register_user.email = email",
            "        register_user.first_name = first_name",
            "        register_user.last_name = last_name",
            "        if hashed_password:",
            "            register_user.password = hashed_password",
            "        else:",
            "            register_user.password = generate_password_hash(password)",
            "        register_user.registration_hash = str(uuid.uuid1())",
            "        try:",
            "            self.get_session.add(register_user)",
            "            self.get_session.commit()",
            "            return register_user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_REGISTER_USER.format(str(e)))",
            "            self.appbuilder.get_session.rollback()",
            "            return None",
            "",
            "    def del_register_user(self, register_user):",
            "        \"\"\"",
            "            Deletes registration object from database",
            "",
            "            :param register_user: RegisterUser object to delete",
            "        \"\"\"",
            "        try:",
            "            self.get_session.delete(register_user)",
            "            self.get_session.commit()",
            "            return True",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_REGISTER_USER.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    def find_user(self, username=None, email=None):",
            "        \"\"\"",
            "            Finds user by username or email",
            "        \"\"\"",
            "        if username:",
            "            try:",
            "                if self.auth_username_ci:",
            "                    return (",
            "                        self.get_session.query(self.user_model)",
            "                        .filter(",
            "                            func.lower(self.user_model.username) == func.lower(username)",
            "                        )",
            "                        .one_or_none()",
            "                    )",
            "                else:",
            "                    return (",
            "                        self.get_session.query(self.user_model)",
            "                        .filter(self.user_model.username == username)",
            "                        .one_or_none()",
            "                    )",
            "            except MultipleResultsFound:",
            "                log.error(f\"Multiple results found for user {username}\")",
            "                return None",
            "        elif email:",
            "            try:",
            "                return (",
            "                    self.get_session.query(self.user_model)",
            "                    .filter_by(email=email)",
            "                    .one_or_none()",
            "                )",
            "            except MultipleResultsFound:",
            "                log.error(f\"Multiple results found for user with email {email}\")",
            "                return None",
            "",
            "    def get_all_users(self):",
            "        return self.get_session.query(self.user_model).all()",
            "",
            "    def add_user(",
            "        self,",
            "        username,",
            "        first_name,",
            "        last_name,",
            "        email,",
            "        role,",
            "        password=\"\",",
            "        hashed_password=\"\",",
            "    ):",
            "        \"\"\"",
            "            Generic function to create user",
            "        \"\"\"",
            "        try:",
            "            user = self.user_model()",
            "            user.first_name = first_name",
            "            user.last_name = last_name",
            "            user.username = username",
            "            user.email = email",
            "            user.active = True",
            "            user.roles = role if isinstance(role, list) else [role]",
            "            if hashed_password:",
            "                user.password = hashed_password",
            "            else:",
            "                user.password = generate_password_hash(password)",
            "            self.get_session.add(user)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_USER.format(username))",
            "            return user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_USER.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    def count_users(self):",
            "        return self.get_session.query(func.count(self.user_model.id)).scalar()",
            "",
            "    def update_user(self, user):",
            "        try:",
            "            self.get_session.merge(user)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_UPD_USER.format(user))",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_USER.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    def get_user_by_id(self, pk):",
            "        return self.get_session.query(self.user_model).get(pk)",
            "",
            "    def get_first_user(self) -> \"User\":",
            "        return self.get_session.query(self.user_model).first()",
            "",
            "    def noop_user_update(self, user: \"User\") -> None:",
            "        stmt = (",
            "            update(User)",
            "            .where(self.user_model.id == user.id)",
            "            .values(login_count=user.login_count)",
            "        )",
            "        self.get_session.execute(stmt)",
            "        self.get_session.commit()",
            "",
            "    \"\"\"",
            "    -----------------------",
            "     PERMISSION MANAGEMENT",
            "    -----------------------",
            "    \"\"\"",
            "",
            "    def add_role(",
            "        self, name: str, permissions: Optional[List[PermissionView]] = None",
            "    ) -> Optional[Role]:",
            "        if not permissions:",
            "            permissions = []",
            "",
            "        role = self.find_role(name)",
            "        if role is None:",
            "            try:",
            "                role = self.role_model()",
            "                role.name = name",
            "                role.permissions = permissions",
            "                self.get_session.add(role)",
            "                self.get_session.commit()",
            "                log.info(c.LOGMSG_INF_SEC_ADD_ROLE.format(name))",
            "                return role",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_ROLE.format(str(e)))",
            "                self.get_session.rollback()",
            "        return role",
            "",
            "    def update_role(self, pk, name: str) -> Optional[Role]:",
            "        role = self.get_session.query(self.role_model).get(pk)",
            "        if not role:",
            "            return",
            "        try:",
            "            role.name = name",
            "            self.get_session.merge(role)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_UPD_ROLE.format(role))",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_ROLE.format(str(e)))",
            "            self.get_session.rollback()",
            "            return",
            "",
            "    def find_role(self, name):",
            "        return (",
            "            self.get_session.query(self.role_model).filter_by(name=name).one_or_none()",
            "        )",
            "",
            "    def get_all_roles(self):",
            "        return self.get_session.query(self.role_model).all()",
            "",
            "    def get_public_role(self):",
            "        return (",
            "            self.get_session.query(self.role_model)",
            "            .filter_by(name=self.auth_role_public)",
            "            .one_or_none()",
            "        )",
            "",
            "    def get_public_permissions(self):",
            "        role = self.get_public_role()",
            "        if role:",
            "            return role.permissions",
            "        return []",
            "",
            "    def find_permission(self, name):",
            "        \"\"\"",
            "            Finds and returns a Permission by name",
            "        \"\"\"",
            "        return (",
            "            self.get_session.query(self.permission_model)",
            "            .filter_by(name=name)",
            "            .one_or_none()",
            "        )",
            "",
            "    def exist_permission_on_roles(",
            "        self, view_name: str, permission_name: str, role_ids: List[int]",
            "    ) -> bool:",
            "        \"\"\"",
            "            Method to efficiently check if a certain permission exists",
            "            on a list of role id's. This is used by `has_access`",
            "",
            "        :param view_name: The view's name to check if exists on one of the roles",
            "        :param permission_name: The permission name to check if exists",
            "        :param role_ids: a list of Role ids",
            "        :return: Boolean",
            "        \"\"\"",
            "        q = (",
            "            self.appbuilder.get_session.query(self.permissionview_model)",
            "            .join(",
            "                assoc_permissionview_role,",
            "                and_(",
            "                    (",
            "                        self.permissionview_model.id",
            "                        == assoc_permissionview_role.c.permission_view_id",
            "                    )",
            "                ),",
            "            )",
            "            .join(self.role_model)",
            "            .join(self.permission_model)",
            "            .join(self.viewmenu_model)",
            "            .filter(",
            "                self.viewmenu_model.name == view_name,",
            "                self.permission_model.name == permission_name,",
            "                self.role_model.id.in_(role_ids),",
            "            )",
            "            .exists()",
            "        )",
            "        # Special case for MSSQL/Oracle (works on PG and MySQL > 8)",
            "        if self.appbuilder.get_session.bind.dialect.name in (\"mssql\", \"oracle\"):",
            "            return self.appbuilder.get_session.query(literal(True)).filter(q).scalar()",
            "        return self.appbuilder.get_session.query(q).scalar()",
            "",
            "    def find_roles_permission_view_menus(",
            "        self, permission_name: str, role_ids: List[int]",
            "    ):",
            "        return (",
            "            self.appbuilder.get_session.query(self.permissionview_model)",
            "            .join(",
            "                assoc_permissionview_role,",
            "                and_(",
            "                    (",
            "                        self.permissionview_model.id",
            "                        == assoc_permissionview_role.c.permission_view_id",
            "                    )",
            "                ),",
            "            )",
            "            .join(self.role_model)",
            "            .join(self.permission_model)",
            "            .join(self.viewmenu_model)",
            "            .filter(",
            "                self.permission_model.name == permission_name,",
            "                self.role_model.id.in_(role_ids),",
            "            )",
            "        ).all()",
            "",
            "    def get_db_role_permissions(self, role_id: int) -> List[PermissionView]:",
            "        \"\"\"",
            "        Get all DB permissions from a role (one single query)",
            "        \"\"\"",
            "        return (",
            "            self.appbuilder.get_session.query(PermissionView)",
            "            .join(Permission)",
            "            .join(ViewMenu)",
            "            .join(PermissionView.role)",
            "            .filter(Role.id == role_id)",
            "            .options(contains_eager(PermissionView.permission))",
            "            .options(contains_eager(PermissionView.view_menu))",
            "            .all()",
            "        )",
            "",
            "    def add_permission(self, name):",
            "        \"\"\"",
            "            Adds a permission to the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if perm is None:",
            "            try:",
            "                perm = self.permission_model()",
            "                perm.name = name",
            "                self.get_session.add(perm)",
            "                self.get_session.commit()",
            "                return perm",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMISSION.format(str(e)))",
            "                self.get_session.rollback()",
            "        return perm",
            "",
            "    def del_permission(self, name: str) -> bool:",
            "        \"\"\"",
            "            Deletes a permission from the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if not perm:",
            "            log.warning(c.LOGMSG_WAR_SEC_DEL_PERMISSION.format(name))",
            "            return False",
            "        try:",
            "            pvms = (",
            "                self.get_session.query(self.permissionview_model)",
            "                .filter(self.permissionview_model.permission == perm)",
            "                .all()",
            "            )",
            "            if pvms:",
            "                log.warning(c.LOGMSG_WAR_SEC_DEL_PERM_PVM.format(perm, pvms))",
            "                return False",
            "            self.get_session.delete(perm)",
            "            self.get_session.commit()",
            "            return True",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_view_menu(self, name):",
            "        \"\"\"",
            "            Finds and returns a ViewMenu by name",
            "        \"\"\"",
            "        return (",
            "            self.get_session.query(self.viewmenu_model)",
            "            .filter_by(name=name)",
            "            .one_or_none()",
            "        )",
            "",
            "    def get_all_view_menu(self):",
            "        return self.get_session.query(self.viewmenu_model).all()",
            "",
            "    def add_view_menu(self, name):",
            "        \"\"\"",
            "            Adds a view or menu to the backend, model view_menu",
            "            param name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        view_menu = self.find_view_menu(name)",
            "        if view_menu is None:",
            "            try:",
            "                view_menu = self.viewmenu_model()",
            "                view_menu.name = name",
            "                self.get_session.add(view_menu)",
            "                self.get_session.commit()",
            "                return view_menu",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_VIEWMENU.format(str(e)))",
            "                self.get_session.rollback()",
            "        return view_menu",
            "",
            "    def del_view_menu(self, name: str) -> bool:",
            "        \"\"\"",
            "            Deletes a ViewMenu from the backend",
            "",
            "            :param name:",
            "                name of the ViewMenu",
            "        \"\"\"",
            "        view_menu = self.find_view_menu(name)",
            "        if not view_menu:",
            "            log.warning(c.LOGMSG_WAR_SEC_DEL_VIEWMENU.format(name))",
            "            return False",
            "        try:",
            "            pvms = (",
            "                self.get_session.query(self.permissionview_model)",
            "                .filter(self.permissionview_model.view_menu == view_menu)",
            "                .all()",
            "            )",
            "            if pvms:",
            "                log.warning(c.LOGMSG_WAR_SEC_DEL_VIEWMENU_PVM.format(view_menu, pvms))",
            "                return False",
            "            self.get_session.delete(view_menu)",
            "            self.get_session.commit()",
            "            return True",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PERMISSION VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Finds and returns a PermissionView by names",
            "        \"\"\"",
            "        permission = self.find_permission(permission_name)",
            "        view_menu = self.find_view_menu(view_menu_name)",
            "        if permission and view_menu:",
            "            return (",
            "                self.get_session.query(self.permissionview_model)",
            "                .filter_by(permission=permission, view_menu=view_menu)",
            "                .one_or_none()",
            "            )",
            "",
            "    def find_permissions_view_menu(self, view_menu):",
            "        \"\"\"",
            "            Finds all permissions from ViewMenu, returns list of PermissionView",
            "",
            "            :param view_menu: ViewMenu object",
            "            :return: list of PermissionView objects",
            "        \"\"\"",
            "        return (",
            "            self.get_session.query(self.permissionview_model)",
            "            .filter_by(view_menu_id=view_menu.id)",
            "            .all()",
            "        )",
            "",
            "    def add_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Adds a permission on a view or menu to the backend",
            "",
            "            :param permission_name:",
            "                name of the permission to add: 'can_add','can_edit' etc...",
            "            :param view_menu_name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        if not (permission_name and view_menu_name):",
            "            return None",
            "        pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "        if pv:",
            "            return pv",
            "        vm = self.add_view_menu(view_menu_name)",
            "        perm = self.add_permission(permission_name)",
            "        pv = self.permissionview_model()",
            "        pv.view_menu_id, pv.permission_id = vm.id, perm.id",
            "        try:",
            "            self.get_session.add(pv)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_PERMVIEW.format(str(pv)))",
            "            return pv",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_PERMVIEW.format(str(e)))",
            "            self.get_session.rollback()",
            "",
            "    def del_permission_view_menu(self, permission_name, view_menu_name, cascade=True):",
            "        if not (permission_name and view_menu_name):",
            "            return",
            "        pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "        if not pv:",
            "            return",
            "        roles_pvs = (",
            "            self.get_session.query(self.role_model)",
            "            .filter(self.role_model.permissions.contains(pv))",
            "            .first()",
            "        )",
            "        if roles_pvs:",
            "            log.warning(",
            "                c.LOGMSG_WAR_SEC_DEL_PERMVIEW.format(",
            "                    view_menu_name, permission_name, roles_pvs",
            "                )",
            "            )",
            "            return",
            "        try:",
            "            # delete permission on view",
            "            self.get_session.delete(pv)",
            "            self.get_session.commit()",
            "            # if no more permission on permission view, delete permission",
            "            if not cascade:",
            "                return",
            "            if (",
            "                not self.get_session.query(self.permissionview_model)",
            "                .filter_by(permission=pv.permission)",
            "                .all()",
            "            ):",
            "                self.del_permission(pv.permission.name)",
            "            log.info(",
            "                c.LOGMSG_INF_SEC_DEL_PERMVIEW.format(permission_name, view_menu_name)",
            "            )",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMVIEW.format(str(e)))",
            "            self.get_session.rollback()",
            "",
            "    def exist_permission_on_views(self, lst, item):",
            "        for i in lst:",
            "            if i.permission and i.permission.name == item:",
            "                return True",
            "        return False",
            "",
            "    def exist_permission_on_view(self, lst, permission, view_menu):",
            "        for i in lst:",
            "            if i.permission.name == permission and i.view_menu.name == view_menu:",
            "                return True",
            "        return False",
            "",
            "    def add_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Add permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view and perm_view not in role.permissions:",
            "            try:",
            "                role.permissions.append(perm_view)",
            "                self.get_session.merge(role)",
            "                self.get_session.commit()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_ADD_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMROLE.format(str(e)))",
            "                self.get_session.rollback()",
            "",
            "    def del_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Remove permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view in role.permissions:",
            "            try:",
            "                role.permissions.remove(perm_view)",
            "                self.get_session.merge(role)",
            "                self.get_session.commit()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_DEL_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMROLE.format(str(e)))",
            "                self.get_session.rollback()",
            "",
            "    def export_roles(self, path: Optional[str] = None) -> None:",
            "        \"\"\" Exports roles to JSON file. \"\"\"",
            "        timestamp = datetime.now().strftime(\"%Y%m%dT%H%M%S\")",
            "        filename = path or f\"roles_export_{timestamp}.json\"",
            "",
            "        serialized_roles = []",
            "",
            "        for role in self.get_all_roles():",
            "            serialized_role = {\"name\": role.name, \"permissions\": []}",
            "            for pvm in role.permissions:",
            "                permission = pvm.permission",
            "                view_menu = pvm.view_menu",
            "                permission_view_menu = {",
            "                    \"permission\": {\"name\": permission.name},",
            "                    \"view_menu\": {\"name\": view_menu.name},",
            "                }",
            "                serialized_role[\"permissions\"].append(permission_view_menu)",
            "            serialized_roles.append(serialized_role)",
            "",
            "        with open(filename, \"w\") as fd:",
            "            fd.write(json.dumps(serialized_roles))",
            "",
            "    def import_roles(self, path: str) -> None:",
            "        \"\"\" Imports roles from JSON file. \"\"\"",
            "",
            "        session = self.get_session()",
            "",
            "        with open(path, \"r\") as fd:",
            "            roles_json = json.loads(fd.read())",
            "",
            "        roles = []",
            "",
            "        for role_kwargs in roles_json:",
            "            role = self.add_role(role_kwargs[\"name\"])",
            "            permission_view_menus = [",
            "                self.add_permission_view_menu(",
            "                    permission_name=pvm_kwargs[\"permission\"][\"name\"],",
            "                    view_menu_name=pvm_kwargs[\"view_menu\"][\"name\"],",
            "                )",
            "                for pvm_kwargs in role_kwargs[\"permissions\"]",
            "            ]",
            "",
            "            for permission_view_menu in permission_view_menus:",
            "                if permission_view_menu not in role.permissions:",
            "                    role.permissions.append(permission_view_menu)",
            "            roles.append(role)",
            "",
            "        session.add_all(roles)",
            "        session.commit()"
        ],
        "afterPatchFile": [
            "from datetime import datetime",
            "import json",
            "import logging",
            "from typing import List, Optional, Union",
            "import uuid",
            "",
            "from sqlalchemy import and_, func, literal, update",
            "from sqlalchemy.engine.reflection import Inspector",
            "from sqlalchemy.orm import contains_eager",
            "from sqlalchemy.orm.exc import MultipleResultsFound",
            "from werkzeug.security import generate_password_hash",
            "",
            "from .models import (",
            "    assoc_permissionview_role,",
            "    Permission,",
            "    PermissionView,",
            "    RegisterUser,",
            "    Role,",
            "    User,",
            "    ViewMenu,",
            ")",
            "from ..manager import BaseSecurityManager",
            "from ... import const as c",
            "from ...models.sqla import Base",
            "from ...models.sqla.interface import SQLAInterface",
            "",
            "log = logging.getLogger(__name__)",
            "",
            "",
            "class SecurityManager(BaseSecurityManager):",
            "    \"\"\"",
            "        Responsible for authentication, registering security views,",
            "        role and permission auto management",
            "",
            "        If you want to change anything just inherit and override, then",
            "        pass your own security manager to AppBuilder.",
            "    \"\"\"",
            "",
            "    user_model = User",
            "    \"\"\" Override to set your own User Model \"\"\"",
            "    role_model = Role",
            "    \"\"\" Override to set your own Role Model \"\"\"",
            "    permission_model = Permission",
            "    viewmenu_model = ViewMenu",
            "    permissionview_model = PermissionView",
            "    registeruser_model = RegisterUser",
            "",
            "    def __init__(self, appbuilder):",
            "        \"\"\"",
            "            SecurityManager contructor",
            "            param appbuilder:",
            "                F.A.B AppBuilder main object",
            "        \"\"\"",
            "        super(SecurityManager, self).__init__(appbuilder)",
            "        user_datamodel = SQLAInterface(self.user_model)",
            "        if self.auth_type == c.AUTH_DB:",
            "            self.userdbmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_LDAP:",
            "            self.userldapmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OID:",
            "            self.useroidmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_OAUTH:",
            "            self.useroauthmodelview.datamodel = user_datamodel",
            "        elif self.auth_type == c.AUTH_REMOTE_USER:",
            "            self.userremoteusermodelview.datamodel = user_datamodel",
            "",
            "        if self.userstatschartview:",
            "            self.userstatschartview.datamodel = user_datamodel",
            "        if self.auth_user_registration:",
            "            self.registerusermodelview.datamodel = SQLAInterface(",
            "                self.registeruser_model",
            "            )",
            "",
            "        self.rolemodelview.datamodel = SQLAInterface(self.role_model)",
            "        self.permissionmodelview.datamodel = SQLAInterface(self.permission_model)",
            "        self.viewmenumodelview.datamodel = SQLAInterface(self.viewmenu_model)",
            "        self.permissionviewmodelview.datamodel = SQLAInterface(",
            "            self.permissionview_model",
            "        )",
            "        self.create_db()",
            "",
            "    @property",
            "    def get_session(self):",
            "        return self.appbuilder.get_session",
            "",
            "    def register_views(self):",
            "        super(SecurityManager, self).register_views()",
            "",
            "    def create_db(self):",
            "        try:",
            "            engine = self.get_session.get_bind(mapper=None, clause=None)",
            "            inspector = Inspector.from_engine(engine)",
            "            if \"ab_user\" not in inspector.get_table_names():",
            "                log.info(c.LOGMSG_INF_SEC_NO_DB)",
            "                Base.metadata.create_all(engine)",
            "                log.info(c.LOGMSG_INF_SEC_ADD_DB)",
            "            super(SecurityManager, self).create_db()",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_CREATE_DB.format(str(e)))",
            "            exit(1)",
            "",
            "    def find_register_user(self, registration_hash):",
            "        return (",
            "            self.get_session.query(self.registeruser_model)",
            "            .filter(self.registeruser_model.registration_hash == registration_hash)",
            "            .scalar()",
            "        )",
            "",
            "    def add_register_user(",
            "        self, username, first_name, last_name, email, password=\"\", hashed_password=\"\"",
            "    ):",
            "        \"\"\"",
            "            Add a registration request for the user.",
            "",
            "            :rtype : RegisterUser",
            "        \"\"\"",
            "        register_user = self.registeruser_model()",
            "        register_user.username = username",
            "        register_user.email = email",
            "        register_user.first_name = first_name",
            "        register_user.last_name = last_name",
            "        if hashed_password:",
            "            register_user.password = hashed_password",
            "        else:",
            "            register_user.password = generate_password_hash(password)",
            "        register_user.registration_hash = str(uuid.uuid1())",
            "        try:",
            "            self.get_session.add(register_user)",
            "            self.get_session.commit()",
            "            return register_user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_REGISTER_USER.format(str(e)))",
            "            self.appbuilder.get_session.rollback()",
            "            return None",
            "",
            "    def del_register_user(self, register_user):",
            "        \"\"\"",
            "            Deletes registration object from database",
            "",
            "            :param register_user: RegisterUser object to delete",
            "        \"\"\"",
            "        try:",
            "            self.get_session.delete(register_user)",
            "            self.get_session.commit()",
            "            return True",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_REGISTER_USER.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    def find_user(self, username=None, email=None):",
            "        \"\"\"",
            "            Finds user by username or email",
            "        \"\"\"",
            "        if username:",
            "            try:",
            "                if self.auth_username_ci:",
            "                    return (",
            "                        self.get_session.query(self.user_model)",
            "                        .filter(",
            "                            func.lower(self.user_model.username) == func.lower(username)",
            "                        )",
            "                        .one_or_none()",
            "                    )",
            "                else:",
            "                    return (",
            "                        self.get_session.query(self.user_model)",
            "                        .filter(self.user_model.username == username)",
            "                        .one_or_none()",
            "                    )",
            "            except MultipleResultsFound:",
            "                log.error(f\"Multiple results found for user {username}\")",
            "                return None",
            "        elif email:",
            "            try:",
            "                return (",
            "                    self.get_session.query(self.user_model)",
            "                    .filter_by(email=email)",
            "                    .one_or_none()",
            "                )",
            "            except MultipleResultsFound:",
            "                log.error(f\"Multiple results found for user with email {email}\")",
            "                return None",
            "",
            "    def get_all_users(self):",
            "        return self.get_session.query(self.user_model).all()",
            "",
            "    def add_user(",
            "        self,",
            "        username,",
            "        first_name,",
            "        last_name,",
            "        email,",
            "        role,",
            "        password=\"\",",
            "        hashed_password=\"\",",
            "    ):",
            "        \"\"\"",
            "            Generic function to create user",
            "        \"\"\"",
            "        try:",
            "            user = self.user_model()",
            "            user.first_name = first_name",
            "            user.last_name = last_name",
            "            user.username = username",
            "            user.email = email",
            "            user.active = True",
            "            user.roles = role if isinstance(role, list) else [role]",
            "            if hashed_password:",
            "                user.password = hashed_password",
            "            else:",
            "                user.password = generate_password_hash(password)",
            "            self.get_session.add(user)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_USER.format(username))",
            "            return user",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_USER.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    def count_users(self):",
            "        return self.get_session.query(func.count(self.user_model.id)).scalar()",
            "",
            "    def update_user(self, user):",
            "        try:",
            "            self.get_session.merge(user)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_UPD_USER.format(user))",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_USER.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    def get_user_by_id(self, pk):",
            "        return self.get_session.query(self.user_model).get(pk)",
            "",
            "    def get_first_user(self) -> \"User\":",
            "        return self.get_session.query(self.user_model).first()",
            "",
            "    def noop_user_update(self, user: \"User\") -> None:",
            "        stmt = (",
            "            update(User)",
            "            .where(self.user_model.id == user.id)",
            "            .values(login_count=user.login_count)",
            "        )",
            "        self.get_session.execute(stmt)",
            "        self.get_session.commit()",
            "",
            "    \"\"\"",
            "    -----------------------",
            "     PERMISSION MANAGEMENT",
            "    -----------------------",
            "    \"\"\"",
            "",
            "    def add_role(",
            "        self, name: str, permissions: Optional[List[PermissionView]] = None",
            "    ) -> Optional[Role]:",
            "        if not permissions:",
            "            permissions = []",
            "",
            "        role = self.find_role(name)",
            "        if role is None:",
            "            try:",
            "                role = self.role_model()",
            "                role.name = name",
            "                role.permissions = permissions",
            "                self.get_session.add(role)",
            "                self.get_session.commit()",
            "                log.info(c.LOGMSG_INF_SEC_ADD_ROLE.format(name))",
            "                return role",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_ROLE.format(str(e)))",
            "                self.get_session.rollback()",
            "        return role",
            "",
            "    def update_role(self, pk, name: str) -> Optional[Role]:",
            "        role = self.get_session.query(self.role_model).get(pk)",
            "        if not role:",
            "            return",
            "        try:",
            "            role.name = name",
            "            self.get_session.merge(role)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_UPD_ROLE.format(role))",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_UPD_ROLE.format(str(e)))",
            "            self.get_session.rollback()",
            "            return",
            "",
            "    def find_role(self, name):",
            "        return (",
            "            self.get_session.query(self.role_model).filter_by(name=name).one_or_none()",
            "        )",
            "",
            "    def get_all_roles(self):",
            "        return self.get_session.query(self.role_model).all()",
            "",
            "    def get_public_role(self):",
            "        return (",
            "            self.get_session.query(self.role_model)",
            "            .filter_by(name=self.auth_role_public)",
            "            .one_or_none()",
            "        )",
            "",
            "    def get_public_permissions(self):",
            "        role = self.get_public_role()",
            "        if role:",
            "            return role.permissions",
            "        return []",
            "",
            "    def find_permission(self, name):",
            "        \"\"\"",
            "            Finds and returns a Permission by name",
            "        \"\"\"",
            "        return (",
            "            self.get_session.query(self.permission_model)",
            "            .filter_by(name=name)",
            "            .one_or_none()",
            "        )",
            "",
            "    def exist_permission_on_roles(",
            "        self, view_name: str, permission_name: str, role_ids: List[int]",
            "    ) -> bool:",
            "        \"\"\"",
            "            Method to efficiently check if a certain permission exists",
            "            on a list of role id's. This is used by `has_access`",
            "",
            "        :param view_name: The view's name to check if exists on one of the roles",
            "        :param permission_name: The permission name to check if exists",
            "        :param role_ids: a list of Role ids",
            "        :return: Boolean",
            "        \"\"\"",
            "        q = (",
            "            self.appbuilder.get_session.query(self.permissionview_model)",
            "            .join(",
            "                assoc_permissionview_role,",
            "                and_(",
            "                    (",
            "                        self.permissionview_model.id",
            "                        == assoc_permissionview_role.c.permission_view_id",
            "                    )",
            "                ),",
            "            )",
            "            .join(self.role_model)",
            "            .join(self.permission_model)",
            "            .join(self.viewmenu_model)",
            "            .filter(",
            "                self.viewmenu_model.name == view_name,",
            "                self.permission_model.name == permission_name,",
            "                self.role_model.id.in_(role_ids),",
            "            )",
            "            .exists()",
            "        )",
            "        # Special case for MSSQL/Oracle (works on PG and MySQL > 8)",
            "        if self.appbuilder.get_session.bind.dialect.name in (\"mssql\", \"oracle\"):",
            "            return self.appbuilder.get_session.query(literal(True)).filter(q).scalar()",
            "        return self.appbuilder.get_session.query(q).scalar()",
            "",
            "    def find_roles_permission_view_menus(",
            "        self, permission_name: str, role_ids: List[int]",
            "    ):",
            "        return (",
            "            self.appbuilder.get_session.query(self.permissionview_model)",
            "            .join(",
            "                assoc_permissionview_role,",
            "                and_(",
            "                    (",
            "                        self.permissionview_model.id",
            "                        == assoc_permissionview_role.c.permission_view_id",
            "                    )",
            "                ),",
            "            )",
            "            .join(self.role_model)",
            "            .join(self.permission_model)",
            "            .join(self.viewmenu_model)",
            "            .filter(",
            "                self.permission_model.name == permission_name,",
            "                self.role_model.id.in_(role_ids),",
            "            )",
            "        ).all()",
            "",
            "    def get_db_role_permissions(self, role_id: int) -> List[PermissionView]:",
            "        \"\"\"",
            "        Get all DB permissions from a role (one single query)",
            "        \"\"\"",
            "        return (",
            "            self.appbuilder.get_session.query(PermissionView)",
            "            .join(Permission)",
            "            .join(ViewMenu)",
            "            .join(PermissionView.role)",
            "            .filter(Role.id == role_id)",
            "            .options(contains_eager(PermissionView.permission))",
            "            .options(contains_eager(PermissionView.view_menu))",
            "            .all()",
            "        )",
            "",
            "    def add_permission(self, name):",
            "        \"\"\"",
            "            Adds a permission to the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if perm is None:",
            "            try:",
            "                perm = self.permission_model()",
            "                perm.name = name",
            "                self.get_session.add(perm)",
            "                self.get_session.commit()",
            "                return perm",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMISSION.format(str(e)))",
            "                self.get_session.rollback()",
            "        return perm",
            "",
            "    def del_permission(self, name: str) -> bool:",
            "        \"\"\"",
            "            Deletes a permission from the backend, model permission",
            "",
            "            :param name:",
            "                name of the permission: 'can_add','can_edit' etc...",
            "        \"\"\"",
            "        perm = self.find_permission(name)",
            "        if not perm:",
            "            log.warning(c.LOGMSG_WAR_SEC_DEL_PERMISSION.format(name))",
            "            return False",
            "        try:",
            "            pvms = (",
            "                self.get_session.query(self.permissionview_model)",
            "                .filter(self.permissionview_model.permission == perm)",
            "                .all()",
            "            )",
            "            if pvms:",
            "                log.warning(c.LOGMSG_WAR_SEC_DEL_PERM_PVM.format(perm, pvms))",
            "                return False",
            "            self.get_session.delete(perm)",
            "            self.get_session.commit()",
            "            return True",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PRIMITIVES VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_view_menu(self, name):",
            "        \"\"\"",
            "            Finds and returns a ViewMenu by name",
            "        \"\"\"",
            "        return (",
            "            self.get_session.query(self.viewmenu_model)",
            "            .filter_by(name=name)",
            "            .one_or_none()",
            "        )",
            "",
            "    def get_all_view_menu(self):",
            "        return self.get_session.query(self.viewmenu_model).all()",
            "",
            "    def add_view_menu(self, name):",
            "        \"\"\"",
            "            Adds a view or menu to the backend, model view_menu",
            "            param name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        view_menu = self.find_view_menu(name)",
            "        if view_menu is None:",
            "            try:",
            "                view_menu = self.viewmenu_model()",
            "                view_menu.name = name",
            "                self.get_session.add(view_menu)",
            "                self.get_session.commit()",
            "                return view_menu",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_VIEWMENU.format(str(e)))",
            "                self.get_session.rollback()",
            "        return view_menu",
            "",
            "    def del_view_menu(self, name: str) -> bool:",
            "        \"\"\"",
            "            Deletes a ViewMenu from the backend",
            "",
            "            :param name:",
            "                name of the ViewMenu",
            "        \"\"\"",
            "        view_menu = self.find_view_menu(name)",
            "        if not view_menu:",
            "            log.warning(c.LOGMSG_WAR_SEC_DEL_VIEWMENU.format(name))",
            "            return False",
            "        try:",
            "            pvms = (",
            "                self.get_session.query(self.permissionview_model)",
            "                .filter(self.permissionview_model.view_menu == view_menu)",
            "                .all()",
            "            )",
            "            if pvms:",
            "                log.warning(c.LOGMSG_WAR_SEC_DEL_VIEWMENU_PVM.format(view_menu, pvms))",
            "                return False",
            "            self.get_session.delete(view_menu)",
            "            self.get_session.commit()",
            "            return True",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMISSION.format(str(e)))",
            "            self.get_session.rollback()",
            "            return False",
            "",
            "    \"\"\"",
            "    ----------------------",
            "     PERMISSION VIEW MENU",
            "    ----------------------",
            "    \"\"\"",
            "",
            "    def find_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Finds and returns a PermissionView by names",
            "        \"\"\"",
            "        permission = self.find_permission(permission_name)",
            "        view_menu = self.find_view_menu(view_menu_name)",
            "        if permission and view_menu:",
            "            return (",
            "                self.get_session.query(self.permissionview_model)",
            "                .filter_by(permission=permission, view_menu=view_menu)",
            "                .one_or_none()",
            "            )",
            "",
            "    def find_permissions_view_menu(self, view_menu):",
            "        \"\"\"",
            "            Finds all permissions from ViewMenu, returns list of PermissionView",
            "",
            "            :param view_menu: ViewMenu object",
            "            :return: list of PermissionView objects",
            "        \"\"\"",
            "        return (",
            "            self.get_session.query(self.permissionview_model)",
            "            .filter_by(view_menu_id=view_menu.id)",
            "            .all()",
            "        )",
            "",
            "    def add_permission_view_menu(self, permission_name, view_menu_name):",
            "        \"\"\"",
            "            Adds a permission on a view or menu to the backend",
            "",
            "            :param permission_name:",
            "                name of the permission to add: 'can_add','can_edit' etc...",
            "            :param view_menu_name:",
            "                name of the view menu to add",
            "        \"\"\"",
            "        if not (permission_name and view_menu_name):",
            "            return None",
            "        pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "        if pv:",
            "            return pv",
            "        vm = self.add_view_menu(view_menu_name)",
            "        perm = self.add_permission(permission_name)",
            "        pv = self.permissionview_model()",
            "        pv.view_menu_id, pv.permission_id = vm.id, perm.id",
            "        try:",
            "            self.get_session.add(pv)",
            "            self.get_session.commit()",
            "            log.info(c.LOGMSG_INF_SEC_ADD_PERMVIEW.format(str(pv)))",
            "            return pv",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_ADD_PERMVIEW.format(str(e)))",
            "            self.get_session.rollback()",
            "",
            "    def del_permission_view_menu(self, permission_name, view_menu_name, cascade=True):",
            "        if not (permission_name and view_menu_name):",
            "            return",
            "        pv = self.find_permission_view_menu(permission_name, view_menu_name)",
            "        if not pv:",
            "            return",
            "        roles_pvs = (",
            "            self.get_session.query(self.role_model)",
            "            .filter(self.role_model.permissions.contains(pv))",
            "            .first()",
            "        )",
            "        if roles_pvs:",
            "            log.warning(",
            "                c.LOGMSG_WAR_SEC_DEL_PERMVIEW.format(",
            "                    view_menu_name, permission_name, roles_pvs",
            "                )",
            "            )",
            "            return",
            "        try:",
            "            # delete permission on view",
            "            self.get_session.delete(pv)",
            "            self.get_session.commit()",
            "            # if no more permission on permission view, delete permission",
            "            if not cascade:",
            "                return",
            "            if (",
            "                not self.get_session.query(self.permissionview_model)",
            "                .filter_by(permission=pv.permission)",
            "                .all()",
            "            ):",
            "                self.del_permission(pv.permission.name)",
            "            log.info(",
            "                c.LOGMSG_INF_SEC_DEL_PERMVIEW.format(permission_name, view_menu_name)",
            "            )",
            "        except Exception as e:",
            "            log.error(c.LOGMSG_ERR_SEC_DEL_PERMVIEW.format(str(e)))",
            "            self.get_session.rollback()",
            "",
            "    def exist_permission_on_views(self, lst, item):",
            "        for i in lst:",
            "            if i.permission and i.permission.name == item:",
            "                return True",
            "        return False",
            "",
            "    def exist_permission_on_view(self, lst, permission, view_menu):",
            "        for i in lst:",
            "            if i.permission.name == permission and i.view_menu.name == view_menu:",
            "                return True",
            "        return False",
            "",
            "    def add_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Add permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view and perm_view not in role.permissions:",
            "            try:",
            "                role.permissions.append(perm_view)",
            "                self.get_session.merge(role)",
            "                self.get_session.commit()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_ADD_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_ADD_PERMROLE.format(str(e)))",
            "                self.get_session.rollback()",
            "",
            "    def del_permission_role(self, role, perm_view):",
            "        \"\"\"",
            "            Remove permission-ViewMenu object to Role",
            "",
            "            :param role:",
            "                The role object",
            "            :param perm_view:",
            "                The PermissionViewMenu object",
            "        \"\"\"",
            "        if perm_view in role.permissions:",
            "            try:",
            "                role.permissions.remove(perm_view)",
            "                self.get_session.merge(role)",
            "                self.get_session.commit()",
            "                log.info(",
            "                    c.LOGMSG_INF_SEC_DEL_PERMROLE.format(str(perm_view), role.name)",
            "                )",
            "            except Exception as e:",
            "                log.error(c.LOGMSG_ERR_SEC_DEL_PERMROLE.format(str(e)))",
            "                self.get_session.rollback()",
            "",
            "    def export_roles(",
            "        self, path: Optional[str] = None, indent: Optional[Union[int, str]] = None",
            "    ) -> None:",
            "        \"\"\" Exports roles to JSON file. \"\"\"",
            "        timestamp = datetime.now().strftime(\"%Y%m%dT%H%M%S\")",
            "        filename = path or f\"roles_export_{timestamp}.json\"",
            "",
            "        serialized_roles = []",
            "",
            "        for role in self.get_all_roles():",
            "            serialized_role = {\"name\": role.name, \"permissions\": []}",
            "            for pvm in role.permissions:",
            "                permission = pvm.permission",
            "                view_menu = pvm.view_menu",
            "                permission_view_menu = {",
            "                    \"permission\": {\"name\": permission.name},",
            "                    \"view_menu\": {\"name\": view_menu.name},",
            "                }",
            "                serialized_role[\"permissions\"].append(permission_view_menu)",
            "            serialized_roles.append(serialized_role)",
            "",
            "        with open(filename, \"w\") as fd:",
            "            fd.write(json.dumps(serialized_roles, indent=indent))",
            "",
            "    def import_roles(self, path: str) -> None:",
            "        \"\"\" Imports roles from JSON file. \"\"\"",
            "",
            "        session = self.get_session()",
            "",
            "        with open(path, \"r\") as fd:",
            "            roles_json = json.loads(fd.read())",
            "",
            "        roles = []",
            "",
            "        for role_kwargs in roles_json:",
            "            role = self.add_role(role_kwargs[\"name\"])",
            "            permission_view_menus = [",
            "                self.add_permission_view_menu(",
            "                    permission_name=pvm_kwargs[\"permission\"][\"name\"],",
            "                    view_menu_name=pvm_kwargs[\"view_menu\"][\"name\"],",
            "                )",
            "                for pvm_kwargs in role_kwargs[\"permissions\"]",
            "            ]",
            "",
            "            for permission_view_menu in permission_view_menus:",
            "                if permission_view_menu not in role.permissions:",
            "                    role.permissions.append(permission_view_menu)",
            "            roles.append(role)",
            "",
            "        session.add_all(roles)",
            "        session.commit()"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "4": [],
            "663": [
                "SecurityManager",
                "export_roles"
            ],
            "683": [
                "SecurityManager",
                "export_roles"
            ]
        },
        "addLocation": []
    },
    "flask_appbuilder/tests/test_fab_cli.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import logging"
            },
            "1": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import os"
            },
            "2": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import tempfile"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from unittest.mock import ANY, patch"
            },
            "4": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from click.testing import CliRunner"
            },
            "6": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from flask import Flask"
            },
            "7": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "                 len(glob.glob(os.path.join(tmp_dir, \"roles_export_*\"))), 0"
            },
            "8": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 148,
                "PatchRowcode": "             )"
            },
            "9": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": 149,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+    @patch(\"json.dumps\")"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 151,
                "PatchRowcode": "+    def test_export_roles_indent(self, mock_json_dumps):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+        \"\"\"Test that json.dumps is called with the correct argument passed from CLI.\"\"\""
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+        with tempfile.TemporaryDirectory() as tmp_dir:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+            app = Flask(\"src_app\")"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+            app.config.from_object(\"flask_appbuilder.tests.config_security\")"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+            app.config["
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+                \"SQLALCHEMY_DATABASE_URI\""
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+            ] = f\"sqlite:///{os.path.join(tmp_dir, 'src.db')}\""
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 159,
                "PatchRowcode": "+            db = SQLA(app)"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 160,
                "PatchRowcode": "+            app_builder = AppBuilder(app, db.session)  # noqa: F841"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+            cli_runner = app.test_cli_runner()"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+            cli_runner.invoke(export_roles)"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+            mock_json_dumps.assert_called_with(ANY, indent=None)"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+            mock_json_dumps.reset_mock()"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 166,
                "PatchRowcode": "+"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 167,
                "PatchRowcode": "+            example_cli_args = [\"\", \"foo\", -1, 0, 1]"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 168,
                "PatchRowcode": "+            for arg in example_cli_args:"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 169,
                "PatchRowcode": "+                cli_runner.invoke(export_roles, [f\"--indent={arg}\"])"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 170,
                "PatchRowcode": "+                mock_json_dumps.assert_called_with(ANY, indent=arg)"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 171,
                "PatchRowcode": "+                mock_json_dumps.reset_mock()"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 172,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": 173,
                "PatchRowcode": "     def test_import_roles(self):"
            },
            "34": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 174,
                "PatchRowcode": "         with tempfile.TemporaryDirectory() as tmp_dir:"
            },
            "35": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 175,
                "PatchRowcode": "             app = Flask(\"dst_app\")"
            }
        },
        "frontPatchFile": [
            "import glob",
            "import json",
            "import logging",
            "import os",
            "import tempfile",
            "",
            "from click.testing import CliRunner",
            "from flask import Flask",
            "from flask_appbuilder import AppBuilder, SQLA",
            "from flask_appbuilder.cli import (",
            "    create_app,",
            "    create_permissions,",
            "    create_user,",
            "    export_roles,",
            "    import_roles,",
            "    list_users,",
            "    list_views,",
            "    reset_password,",
            ")",
            "",
            "from .base import FABTestCase",
            "",
            "logging.basicConfig(format=\"%(asctime)s:%(levelname)s:%(name)s:%(message)s\")",
            "logging.getLogger().setLevel(logging.DEBUG)",
            "log = logging.getLogger(__name__)",
            "",
            "APP_DIR = \"myapp\"",
            "",
            "",
            "class FlaskTestCase(FABTestCase):",
            "    def setUp(self):",
            "        pass",
            "",
            "    def tearDown(self):",
            "        log.debug(\"TEAR DOWN\")",
            "",
            "    def test_create_app(self):",
            "        \"\"\"",
            "            Test create app, create-user",
            "        \"\"\"",
            "        os.environ[\"FLASK_APP\"] = \"app:app\"",
            "        runner = CliRunner()",
            "        with runner.isolated_filesystem():",
            "            result = runner.invoke(",
            "                create_app, [f\"--name={APP_DIR}\", \"--engine=SQLAlchemy\"]",
            "            )",
            "            self.assertIn(\"Downloaded the skeleton app, good coding!\", result.output)",
            "            os.chdir(APP_DIR)",
            "            result = runner.invoke(",
            "                create_user,",
            "                [",
            "                    \"--username=bob\",",
            "                    \"--role=Public\",",
            "                    \"--firstname=Bob\",",
            "                    \"--lastname=Smith\",",
            "                    \"--email=bob@fab.com\",",
            "                    \"--password=foo\",",
            "                ],",
            "            )",
            "            log.info(result.output)",
            "            self.assertIn(\"User bob created.\", result.output)",
            "",
            "            result = runner.invoke(list_users, [])",
            "            self.assertIn(\"bob\", result.output)",
            "",
            "            runner.invoke(create_permissions, [])",
            "",
            "            runner.invoke(reset_password, [\"--username=bob\", \"--password=bar\"])",
            "",
            "    def test_list_views(self):",
            "        \"\"\"",
            "            CLI: Test list views",
            "        \"\"\"",
            "        os.environ[\"FLASK_APP\"] = \"app:app\"",
            "        runner = CliRunner()",
            "        with runner.isolated_filesystem():",
            "            result = runner.invoke(list_views, [])",
            "            self.assertIn(\"List of registered views\", result.output)",
            "            self.assertIn(\" Route:/api/v1/security\", result.output)",
            "",
            "",
            "class SQLAlchemyImportExportTestCase(FABTestCase):",
            "    def setUp(self):",
            "        with open(\"flask_appbuilder/tests/data/roles.json\", \"r\") as fd:",
            "            self.expected_roles = json.loads(fd.read())",
            "",
            "    def test_export_roles(self):",
            "        with tempfile.TemporaryDirectory() as tmp_dir:",
            "            app = Flask(\"src_app\")",
            "            app.config.from_object(\"flask_appbuilder.tests.config_security\")",
            "            app.config[",
            "                \"SQLALCHEMY_DATABASE_URI\"",
            "            ] = f\"sqlite:///{os.path.join(tmp_dir, 'src.db')}\"",
            "            db = SQLA(app)",
            "            app_builder = AppBuilder(app, db.session)  # noqa: F841",
            "            cli_runner = app.test_cli_runner()",
            "",
            "            path = os.path.join(tmp_dir, \"roles.json\")",
            "",
            "            export_result = cli_runner.invoke(export_roles, [f\"--path={path}\"])",
            "",
            "            self.assertEqual(export_result.exit_code, 0)",
            "            self.assertTrue(os.path.exists(path))",
            "",
            "            with open(path, \"r\") as fd:",
            "                resulting_roles = json.loads(fd.read())",
            "",
            "            for expected_role in self.expected_roles:",
            "                match = [",
            "                    r for r in resulting_roles if r[\"name\"] == expected_role[\"name\"]",
            "                ]",
            "                self.assertTrue(match)",
            "                resulting_role = match[0]",
            "                resulting_role_permission_view_menus = {",
            "                    (pvm[\"permission\"][\"name\"], pvm[\"view_menu\"][\"name\"])",
            "                    for pvm in resulting_role[\"permissions\"]",
            "                }",
            "                expected_role_permission_view_menus = {",
            "                    (pvm[\"permission\"][\"name\"], pvm[\"view_menu\"][\"name\"])",
            "                    for pvm in expected_role[\"permissions\"]",
            "                }",
            "                self.assertEqual(",
            "                    resulting_role_permission_view_menus,",
            "                    expected_role_permission_view_menus,",
            "                )",
            "",
            "    def test_export_roles_filename(self):",
            "        with tempfile.TemporaryDirectory() as tmp_dir:",
            "            app = Flask(\"src_app\")",
            "            app.config.from_object(\"flask_appbuilder.tests.config_security\")",
            "",
            "            app.config[",
            "                \"SQLALCHEMY_DATABASE_URI\"",
            "            ] = f\"sqlite:///{os.path.join(tmp_dir, 'src.db')}\"",
            "            db = SQLA(app)",
            "            app_builder = AppBuilder(app, db.session)  # noqa: F841",
            "",
            "            owd = os.getcwd()",
            "            os.chdir(tmp_dir)",
            "            cli_runner = app.test_cli_runner()",
            "            export_result = cli_runner.invoke(export_roles)",
            "            os.chdir(owd)",
            "",
            "            self.assertEqual(export_result.exit_code, 0)",
            "            self.assertGreater(",
            "                len(glob.glob(os.path.join(tmp_dir, \"roles_export_*\"))), 0",
            "            )",
            "",
            "    def test_import_roles(self):",
            "        with tempfile.TemporaryDirectory() as tmp_dir:",
            "            app = Flask(\"dst_app\")",
            "            app.config[",
            "                \"SQLALCHEMY_DATABASE_URI\"",
            "            ] = f\"sqlite:///{os.path.join(tmp_dir, 'dst.db')}\"",
            "            db = SQLA(app)",
            "            app_builder = AppBuilder(app, db.session)",
            "            cli_runner = app.test_cli_runner()",
            "",
            "            path = os.path.join(tmp_dir, \"roles.json\")",
            "",
            "            with open(path, \"w\") as fd:",
            "                fd.write(json.dumps(self.expected_roles))",
            "",
            "            # before import roles on dst app include only Admin and Public",
            "            self.assertEqual(len(app_builder.sm.get_all_roles()), 2)",
            "",
            "            import_result = cli_runner.invoke(import_roles, [f\"--path={path}\"])",
            "            self.assertEqual(import_result.exit_code, 0)",
            "",
            "            resulting_roles = app_builder.sm.get_all_roles()",
            "",
            "            for expected_role in self.expected_roles:",
            "                match = [r for r in resulting_roles if r.name == expected_role[\"name\"]]",
            "                self.assertTrue(match)",
            "                resulting_role = match[0]",
            "",
            "                expected_role_permission_view_menus = {",
            "                    (pvm[\"permission\"][\"name\"], pvm[\"view_menu\"][\"name\"])",
            "                    for pvm in expected_role[\"permissions\"]",
            "                }",
            "                resulting_role_permission_view_menus = {",
            "                    (pvm.permission.name, pvm.view_menu.name)",
            "                    for pvm in resulting_role.permissions",
            "                }",
            "                self.assertEqual(",
            "                    resulting_role_permission_view_menus,",
            "                    expected_role_permission_view_menus,",
            "                )"
        ],
        "afterPatchFile": [
            "import glob",
            "import json",
            "import logging",
            "import os",
            "import tempfile",
            "from unittest.mock import ANY, patch",
            "",
            "from click.testing import CliRunner",
            "from flask import Flask",
            "from flask_appbuilder import AppBuilder, SQLA",
            "from flask_appbuilder.cli import (",
            "    create_app,",
            "    create_permissions,",
            "    create_user,",
            "    export_roles,",
            "    import_roles,",
            "    list_users,",
            "    list_views,",
            "    reset_password,",
            ")",
            "",
            "from .base import FABTestCase",
            "",
            "logging.basicConfig(format=\"%(asctime)s:%(levelname)s:%(name)s:%(message)s\")",
            "logging.getLogger().setLevel(logging.DEBUG)",
            "log = logging.getLogger(__name__)",
            "",
            "APP_DIR = \"myapp\"",
            "",
            "",
            "class FlaskTestCase(FABTestCase):",
            "    def setUp(self):",
            "        pass",
            "",
            "    def tearDown(self):",
            "        log.debug(\"TEAR DOWN\")",
            "",
            "    def test_create_app(self):",
            "        \"\"\"",
            "            Test create app, create-user",
            "        \"\"\"",
            "        os.environ[\"FLASK_APP\"] = \"app:app\"",
            "        runner = CliRunner()",
            "        with runner.isolated_filesystem():",
            "            result = runner.invoke(",
            "                create_app, [f\"--name={APP_DIR}\", \"--engine=SQLAlchemy\"]",
            "            )",
            "            self.assertIn(\"Downloaded the skeleton app, good coding!\", result.output)",
            "            os.chdir(APP_DIR)",
            "            result = runner.invoke(",
            "                create_user,",
            "                [",
            "                    \"--username=bob\",",
            "                    \"--role=Public\",",
            "                    \"--firstname=Bob\",",
            "                    \"--lastname=Smith\",",
            "                    \"--email=bob@fab.com\",",
            "                    \"--password=foo\",",
            "                ],",
            "            )",
            "            log.info(result.output)",
            "            self.assertIn(\"User bob created.\", result.output)",
            "",
            "            result = runner.invoke(list_users, [])",
            "            self.assertIn(\"bob\", result.output)",
            "",
            "            runner.invoke(create_permissions, [])",
            "",
            "            runner.invoke(reset_password, [\"--username=bob\", \"--password=bar\"])",
            "",
            "    def test_list_views(self):",
            "        \"\"\"",
            "            CLI: Test list views",
            "        \"\"\"",
            "        os.environ[\"FLASK_APP\"] = \"app:app\"",
            "        runner = CliRunner()",
            "        with runner.isolated_filesystem():",
            "            result = runner.invoke(list_views, [])",
            "            self.assertIn(\"List of registered views\", result.output)",
            "            self.assertIn(\" Route:/api/v1/security\", result.output)",
            "",
            "",
            "class SQLAlchemyImportExportTestCase(FABTestCase):",
            "    def setUp(self):",
            "        with open(\"flask_appbuilder/tests/data/roles.json\", \"r\") as fd:",
            "            self.expected_roles = json.loads(fd.read())",
            "",
            "    def test_export_roles(self):",
            "        with tempfile.TemporaryDirectory() as tmp_dir:",
            "            app = Flask(\"src_app\")",
            "            app.config.from_object(\"flask_appbuilder.tests.config_security\")",
            "            app.config[",
            "                \"SQLALCHEMY_DATABASE_URI\"",
            "            ] = f\"sqlite:///{os.path.join(tmp_dir, 'src.db')}\"",
            "            db = SQLA(app)",
            "            app_builder = AppBuilder(app, db.session)  # noqa: F841",
            "            cli_runner = app.test_cli_runner()",
            "",
            "            path = os.path.join(tmp_dir, \"roles.json\")",
            "",
            "            export_result = cli_runner.invoke(export_roles, [f\"--path={path}\"])",
            "",
            "            self.assertEqual(export_result.exit_code, 0)",
            "            self.assertTrue(os.path.exists(path))",
            "",
            "            with open(path, \"r\") as fd:",
            "                resulting_roles = json.loads(fd.read())",
            "",
            "            for expected_role in self.expected_roles:",
            "                match = [",
            "                    r for r in resulting_roles if r[\"name\"] == expected_role[\"name\"]",
            "                ]",
            "                self.assertTrue(match)",
            "                resulting_role = match[0]",
            "                resulting_role_permission_view_menus = {",
            "                    (pvm[\"permission\"][\"name\"], pvm[\"view_menu\"][\"name\"])",
            "                    for pvm in resulting_role[\"permissions\"]",
            "                }",
            "                expected_role_permission_view_menus = {",
            "                    (pvm[\"permission\"][\"name\"], pvm[\"view_menu\"][\"name\"])",
            "                    for pvm in expected_role[\"permissions\"]",
            "                }",
            "                self.assertEqual(",
            "                    resulting_role_permission_view_menus,",
            "                    expected_role_permission_view_menus,",
            "                )",
            "",
            "    def test_export_roles_filename(self):",
            "        with tempfile.TemporaryDirectory() as tmp_dir:",
            "            app = Flask(\"src_app\")",
            "            app.config.from_object(\"flask_appbuilder.tests.config_security\")",
            "",
            "            app.config[",
            "                \"SQLALCHEMY_DATABASE_URI\"",
            "            ] = f\"sqlite:///{os.path.join(tmp_dir, 'src.db')}\"",
            "            db = SQLA(app)",
            "            app_builder = AppBuilder(app, db.session)  # noqa: F841",
            "",
            "            owd = os.getcwd()",
            "            os.chdir(tmp_dir)",
            "            cli_runner = app.test_cli_runner()",
            "            export_result = cli_runner.invoke(export_roles)",
            "            os.chdir(owd)",
            "",
            "            self.assertEqual(export_result.exit_code, 0)",
            "            self.assertGreater(",
            "                len(glob.glob(os.path.join(tmp_dir, \"roles_export_*\"))), 0",
            "            )",
            "",
            "    @patch(\"json.dumps\")",
            "    def test_export_roles_indent(self, mock_json_dumps):",
            "        \"\"\"Test that json.dumps is called with the correct argument passed from CLI.\"\"\"",
            "        with tempfile.TemporaryDirectory() as tmp_dir:",
            "            app = Flask(\"src_app\")",
            "            app.config.from_object(\"flask_appbuilder.tests.config_security\")",
            "            app.config[",
            "                \"SQLALCHEMY_DATABASE_URI\"",
            "            ] = f\"sqlite:///{os.path.join(tmp_dir, 'src.db')}\"",
            "            db = SQLA(app)",
            "            app_builder = AppBuilder(app, db.session)  # noqa: F841",
            "            cli_runner = app.test_cli_runner()",
            "",
            "            cli_runner.invoke(export_roles)",
            "            mock_json_dumps.assert_called_with(ANY, indent=None)",
            "            mock_json_dumps.reset_mock()",
            "",
            "            example_cli_args = [\"\", \"foo\", -1, 0, 1]",
            "            for arg in example_cli_args:",
            "                cli_runner.invoke(export_roles, [f\"--indent={arg}\"])",
            "                mock_json_dumps.assert_called_with(ANY, indent=arg)",
            "                mock_json_dumps.reset_mock()",
            "",
            "    def test_import_roles(self):",
            "        with tempfile.TemporaryDirectory() as tmp_dir:",
            "            app = Flask(\"dst_app\")",
            "            app.config[",
            "                \"SQLALCHEMY_DATABASE_URI\"",
            "            ] = f\"sqlite:///{os.path.join(tmp_dir, 'dst.db')}\"",
            "            db = SQLA(app)",
            "            app_builder = AppBuilder(app, db.session)",
            "            cli_runner = app.test_cli_runner()",
            "",
            "            path = os.path.join(tmp_dir, \"roles.json\")",
            "",
            "            with open(path, \"w\") as fd:",
            "                fd.write(json.dumps(self.expected_roles))",
            "",
            "            # before import roles on dst app include only Admin and Public",
            "            self.assertEqual(len(app_builder.sm.get_all_roles()), 2)",
            "",
            "            import_result = cli_runner.invoke(import_roles, [f\"--path={path}\"])",
            "            self.assertEqual(import_result.exit_code, 0)",
            "",
            "            resulting_roles = app_builder.sm.get_all_roles()",
            "",
            "            for expected_role in self.expected_roles:",
            "                match = [r for r in resulting_roles if r.name == expected_role[\"name\"]]",
            "                self.assertTrue(match)",
            "                resulting_role = match[0]",
            "",
            "                expected_role_permission_view_menus = {",
            "                    (pvm[\"permission\"][\"name\"], pvm[\"view_menu\"][\"name\"])",
            "                    for pvm in expected_role[\"permissions\"]",
            "                }",
            "                resulting_role_permission_view_menus = {",
            "                    (pvm.permission.name, pvm.view_menu.name)",
            "                    for pvm in resulting_role.permissions",
            "                }",
            "                self.assertEqual(",
            "                    resulting_role_permission_view_menus,",
            "                    expected_role_permission_view_menus,",
            "                )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "python.paddle.nn.functional.extension",
            "flask_appbuilder.tests.test_fab_cli.SQLAlchemyImportExportTestCase.self"
        ]
    }
}