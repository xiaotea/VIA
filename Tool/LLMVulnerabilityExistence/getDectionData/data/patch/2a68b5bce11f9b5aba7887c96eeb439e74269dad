{
    "cli/onionshare_cli/web/chat_mode.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "         self.define_routes()"
            },
            "1": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 49,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "     def validate_username(self, username):"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+        username = username.strip()"
            },
            "4": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "         return ("
            },
            "5": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "             username"
            },
            "6": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "             and username not in self.connected_users"
            },
            "7": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 86,
                "PatchRowcode": "         def update_session_username():"
            },
            "8": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "             history_id = self.cur_history_id"
            },
            "9": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "             data = request.get_json()"
            },
            "10": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if self.validate_username(data.get(\"username\", \"\")):"
            },
            "11": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                session[\"name\"] = data.get(\"username\", session.get(\"name\"))"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+            username = data.get(\"username\", session.get(\"name\")).strip()"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+            if self.validate_username(username):"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+                session[\"name\"] = username"
            },
            "15": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "                 self.web.add_request("
            },
            "16": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "                     request.path,"
            },
            "17": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "                     {\"id\": history_id, \"status_code\": 200},"
            },
            "18": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 149,
                "PatchRowcode": "             \"\"\"Sent by a client when the user updates their username."
            },
            "19": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": 150,
                "PatchRowcode": "             The message is sent to all people in the server.\"\"\""
            },
            "20": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": 151,
                "PatchRowcode": "             current_name = session.get(\"name\")"
            },
            "21": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if self.validate_username(message.get(\"username\", \"\")):"
            },
            "22": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                session[\"name\"] = message[\"username\"]"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+            new_name = message.get(\"username\", \"\").strip()"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+            if self.validate_username(new_name):"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+                session[\"name\"] = new_name"
            },
            "26": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": 155,
                "PatchRowcode": "                 self.connected_users["
            },
            "27": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": 156,
                "PatchRowcode": "                     self.connected_users.index(current_name)"
            },
            "28": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": 157,
                "PatchRowcode": "                 ] = session.get(\"name\")"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "\"\"\"",
            "OnionShare | https://onionshare.org/",
            "",
            "Copyright (C) 2014-2021 Micah Lee, et al. <micah@micahflee.com>",
            "",
            "This program is free software: you can redistribute it and/or modify",
            "it under the terms of the GNU General Public License as published by",
            "the Free Software Foundation, either version 3 of the License, or",
            "(at your option) any later version.",
            "",
            "This program is distributed in the hope that it will be useful,",
            "but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "GNU General Public License for more details.",
            "",
            "You should have received a copy of the GNU General Public License",
            "along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "",
            "from flask import request, render_template, make_response, jsonify, session",
            "from flask_socketio import emit, ConnectionRefusedError",
            "",
            "",
            "class ChatModeWeb:",
            "    \"\"\"",
            "    All of the web logic for chat mode",
            "    \"\"\"",
            "",
            "    def __init__(self, common, web):",
            "        self.common = common",
            "        self.common.log(\"ChatModeWeb\", \"__init__\")",
            "",
            "        self.web = web",
            "",
            "        # This tracks users in the server",
            "        self.connected_users = []",
            "",
            "        # This tracks the history id",
            "        self.cur_history_id = 0",
            "",
            "        # Whether or not we can send REQUEST_INDIVIDUAL_FILE_STARTED",
            "        # and maybe other events when requests come in to this mode",
            "        # Chat mode has no concept of individual file requests that",
            "        # turn into history widgets in the GUI, so set it to False",
            "        self.supports_file_requests = False",
            "",
            "        self.define_routes()",
            "",
            "    def validate_username(self, username):",
            "        return (",
            "            username",
            "            and username not in self.connected_users",
            "            and len(username) < 128",
            "        )",
            "",
            "    def define_routes(self):",
            "        \"\"\"",
            "        The web app routes for chatting",
            "        \"\"\"",
            "",
            "        @self.web.app.route(\"/\", methods=[\"GET\"], provide_automatic_options=False)",
            "        def index():",
            "            history_id = self.cur_history_id",
            "            self.cur_history_id += 1",
            "            session[\"name\"] = (",
            "                session.get(\"name\")",
            "                if session.get(\"name\")",
            "                else self.common.build_username()",
            "            )",
            "            self.web.add_request(",
            "                request.path,",
            "                {\"id\": history_id, \"status_code\": 200},",
            "            )",
            "",
            "            self.web.add_request(self.web.REQUEST_LOAD, request.path)",
            "            return render_template(",
            "                    \"chat.html\",",
            "                    static_url_path=self.web.static_url_path,",
            "                    username=session.get(\"name\"),",
            "                    title=self.web.settings.get(\"general\", \"title\"),",
            "            )",
            "",
            "        @self.web.app.route(\"/update-session-username\", methods=[\"POST\"], provide_automatic_options=False)",
            "        def update_session_username():",
            "            history_id = self.cur_history_id",
            "            data = request.get_json()",
            "            if self.validate_username(data.get(\"username\", \"\")):",
            "                session[\"name\"] = data.get(\"username\", session.get(\"name\"))",
            "                self.web.add_request(",
            "                    request.path,",
            "                    {\"id\": history_id, \"status_code\": 200},",
            "                )",
            "",
            "                self.web.add_request(self.web.REQUEST_LOAD, request.path)",
            "                r = make_response(",
            "                    jsonify(",
            "                        username=session.get(\"name\"),",
            "                        success=True,",
            "                    )",
            "                )",
            "            else:",
            "                self.web.add_request(",
            "                    request.path,",
            "                    {\"id\": history_id, \"status_code\": 403},",
            "                )",
            "",
            "                r = make_response(",
            "                    jsonify(",
            "                        username=session.get(\"name\"),",
            "                        success=False,",
            "                    )",
            "                )",
            "            return r",
            "",
            "        @self.web.socketio.on(\"connect\", namespace=\"/chat\")",
            "        def server_connect():",
            "            \"\"\"Sent by clients when they enter a room.",
            "            A status message is broadcast to all people in the room.\"\"\"",
            "            if self.validate_username(session.get(\"name\")):",
            "                self.connected_users.append(session.get(\"name\"))",
            "                emit(",
            "                    \"status\",",
            "                    {",
            "                        \"username\": session.get(\"name\"),",
            "                        \"msg\": \"{} has joined.\".format(session.get(\"name\")),",
            "                        \"connected_users\": self.connected_users,",
            "                        \"user\": session.get(\"name\"),",
            "                    },",
            "                    broadcast=True,",
            "                )",
            "            else:",
            "                raise ConnectionRefusedError('You are active from another session!')",
            "",
            "        @self.web.socketio.on(\"text\", namespace=\"/chat\")",
            "        def text(message):",
            "            \"\"\"Sent by a client when the user entered a new message.",
            "            The message is sent to all people in the server.\"\"\"",
            "            emit(",
            "                \"chat_message\",",
            "                {\"username\": session.get(\"name\"), \"msg\": message[\"msg\"]},",
            "                broadcast=True,",
            "            )",
            "",
            "        @self.web.socketio.on(\"update_username\", namespace=\"/chat\")",
            "        def update_username(message):",
            "            \"\"\"Sent by a client when the user updates their username.",
            "            The message is sent to all people in the server.\"\"\"",
            "            current_name = session.get(\"name\")",
            "            if self.validate_username(message.get(\"username\", \"\")):",
            "                session[\"name\"] = message[\"username\"]",
            "                self.connected_users[",
            "                    self.connected_users.index(current_name)",
            "                ] = session.get(\"name\")",
            "                emit(",
            "                    \"status\",",
            "                    {",
            "                        \"msg\": \"{} has updated their username to: {}\".format(",
            "                            current_name, session.get(\"name\")",
            "                        ),",
            "                        \"connected_users\": self.connected_users,",
            "                        \"old_name\": current_name,",
            "                        \"new_name\": session.get(\"name\"),",
            "                    },",
            "                    broadcast=True,",
            "                )",
            "            else:",
            "                emit(",
            "                    \"status\",",
            "                    {\"msg\": \"Failed to update username.\"},",
            "                )",
            "",
            "        @self.web.socketio.on(\"disconnect\", namespace=\"/chat\")",
            "        def disconnect():",
            "            \"\"\"Sent by clients when they disconnect.",
            "            A status message is broadcast to all people in the server.\"\"\"",
            "            if session.get(\"name\") in self.connected_users:",
            "                self.connected_users.remove(session.get(\"name\"))",
            "            emit(",
            "                \"status\",",
            "                {",
            "                    \"msg\": \"{} has left the room.\".format(session.get(\"name\")),",
            "                    \"connected_users\": self.connected_users,",
            "                },",
            "                broadcast=True,",
            "            )"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "\"\"\"",
            "OnionShare | https://onionshare.org/",
            "",
            "Copyright (C) 2014-2021 Micah Lee, et al. <micah@micahflee.com>",
            "",
            "This program is free software: you can redistribute it and/or modify",
            "it under the terms of the GNU General Public License as published by",
            "the Free Software Foundation, either version 3 of the License, or",
            "(at your option) any later version.",
            "",
            "This program is distributed in the hope that it will be useful,",
            "but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "GNU General Public License for more details.",
            "",
            "You should have received a copy of the GNU General Public License",
            "along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "",
            "from flask import request, render_template, make_response, jsonify, session",
            "from flask_socketio import emit, ConnectionRefusedError",
            "",
            "",
            "class ChatModeWeb:",
            "    \"\"\"",
            "    All of the web logic for chat mode",
            "    \"\"\"",
            "",
            "    def __init__(self, common, web):",
            "        self.common = common",
            "        self.common.log(\"ChatModeWeb\", \"__init__\")",
            "",
            "        self.web = web",
            "",
            "        # This tracks users in the server",
            "        self.connected_users = []",
            "",
            "        # This tracks the history id",
            "        self.cur_history_id = 0",
            "",
            "        # Whether or not we can send REQUEST_INDIVIDUAL_FILE_STARTED",
            "        # and maybe other events when requests come in to this mode",
            "        # Chat mode has no concept of individual file requests that",
            "        # turn into history widgets in the GUI, so set it to False",
            "        self.supports_file_requests = False",
            "",
            "        self.define_routes()",
            "",
            "    def validate_username(self, username):",
            "        username = username.strip()",
            "        return (",
            "            username",
            "            and username not in self.connected_users",
            "            and len(username) < 128",
            "        )",
            "",
            "    def define_routes(self):",
            "        \"\"\"",
            "        The web app routes for chatting",
            "        \"\"\"",
            "",
            "        @self.web.app.route(\"/\", methods=[\"GET\"], provide_automatic_options=False)",
            "        def index():",
            "            history_id = self.cur_history_id",
            "            self.cur_history_id += 1",
            "            session[\"name\"] = (",
            "                session.get(\"name\")",
            "                if session.get(\"name\")",
            "                else self.common.build_username()",
            "            )",
            "            self.web.add_request(",
            "                request.path,",
            "                {\"id\": history_id, \"status_code\": 200},",
            "            )",
            "",
            "            self.web.add_request(self.web.REQUEST_LOAD, request.path)",
            "            return render_template(",
            "                    \"chat.html\",",
            "                    static_url_path=self.web.static_url_path,",
            "                    username=session.get(\"name\"),",
            "                    title=self.web.settings.get(\"general\", \"title\"),",
            "            )",
            "",
            "        @self.web.app.route(\"/update-session-username\", methods=[\"POST\"], provide_automatic_options=False)",
            "        def update_session_username():",
            "            history_id = self.cur_history_id",
            "            data = request.get_json()",
            "            username = data.get(\"username\", session.get(\"name\")).strip()",
            "            if self.validate_username(username):",
            "                session[\"name\"] = username",
            "                self.web.add_request(",
            "                    request.path,",
            "                    {\"id\": history_id, \"status_code\": 200},",
            "                )",
            "",
            "                self.web.add_request(self.web.REQUEST_LOAD, request.path)",
            "                r = make_response(",
            "                    jsonify(",
            "                        username=session.get(\"name\"),",
            "                        success=True,",
            "                    )",
            "                )",
            "            else:",
            "                self.web.add_request(",
            "                    request.path,",
            "                    {\"id\": history_id, \"status_code\": 403},",
            "                )",
            "",
            "                r = make_response(",
            "                    jsonify(",
            "                        username=session.get(\"name\"),",
            "                        success=False,",
            "                    )",
            "                )",
            "            return r",
            "",
            "        @self.web.socketio.on(\"connect\", namespace=\"/chat\")",
            "        def server_connect():",
            "            \"\"\"Sent by clients when they enter a room.",
            "            A status message is broadcast to all people in the room.\"\"\"",
            "            if self.validate_username(session.get(\"name\")):",
            "                self.connected_users.append(session.get(\"name\"))",
            "                emit(",
            "                    \"status\",",
            "                    {",
            "                        \"username\": session.get(\"name\"),",
            "                        \"msg\": \"{} has joined.\".format(session.get(\"name\")),",
            "                        \"connected_users\": self.connected_users,",
            "                        \"user\": session.get(\"name\"),",
            "                    },",
            "                    broadcast=True,",
            "                )",
            "            else:",
            "                raise ConnectionRefusedError('You are active from another session!')",
            "",
            "        @self.web.socketio.on(\"text\", namespace=\"/chat\")",
            "        def text(message):",
            "            \"\"\"Sent by a client when the user entered a new message.",
            "            The message is sent to all people in the server.\"\"\"",
            "            emit(",
            "                \"chat_message\",",
            "                {\"username\": session.get(\"name\"), \"msg\": message[\"msg\"]},",
            "                broadcast=True,",
            "            )",
            "",
            "        @self.web.socketio.on(\"update_username\", namespace=\"/chat\")",
            "        def update_username(message):",
            "            \"\"\"Sent by a client when the user updates their username.",
            "            The message is sent to all people in the server.\"\"\"",
            "            current_name = session.get(\"name\")",
            "            new_name = message.get(\"username\", \"\").strip()",
            "            if self.validate_username(new_name):",
            "                session[\"name\"] = new_name",
            "                self.connected_users[",
            "                    self.connected_users.index(current_name)",
            "                ] = session.get(\"name\")",
            "                emit(",
            "                    \"status\",",
            "                    {",
            "                        \"msg\": \"{} has updated their username to: {}\".format(",
            "                            current_name, session.get(\"name\")",
            "                        ),",
            "                        \"connected_users\": self.connected_users,",
            "                        \"old_name\": current_name,",
            "                        \"new_name\": session.get(\"name\"),",
            "                    },",
            "                    broadcast=True,",
            "                )",
            "            else:",
            "                emit(",
            "                    \"status\",",
            "                    {\"msg\": \"Failed to update username.\"},",
            "                )",
            "",
            "        @self.web.socketio.on(\"disconnect\", namespace=\"/chat\")",
            "        def disconnect():",
            "            \"\"\"Sent by clients when they disconnect.",
            "            A status message is broadcast to all people in the server.\"\"\"",
            "            if session.get(\"name\") in self.connected_users:",
            "                self.connected_users.remove(session.get(\"name\"))",
            "            emit(",
            "                \"status\",",
            "                {",
            "                    \"msg\": \"{} has left the room.\".format(session.get(\"name\")),",
            "                    \"connected_users\": self.connected_users,",
            "                },",
            "                broadcast=True,",
            "            )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "88": [
                "ChatModeWeb",
                "define_routes",
                "update_session_username"
            ],
            "89": [
                "ChatModeWeb",
                "define_routes",
                "update_session_username"
            ],
            "150": [
                "ChatModeWeb",
                "define_routes",
                "update_username"
            ],
            "151": [
                "ChatModeWeb",
                "define_routes",
                "update_username"
            ]
        },
        "addLocation": [
            "tensorflow.python.kernel_tests.data_structures.list_ops_test.ListOpsTest.testResourceVariableScatterGatherInt64"
        ]
    }
}