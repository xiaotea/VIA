{
    "Products/CMFPlone/URLTool.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " # -*- coding: utf-8 -*-"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from AccessControl import ClassSecurityInfo"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from App.class_init import InitializeClass"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+from HTMLParser import HTMLParser"
            },
            "4": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from plone.registry.interfaces import IRegistry"
            },
            "5": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from posixpath import normpath"
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from Products.CMFCore.URLTool import URLTool as BaseTool"
            },
            "7": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " import re"
            },
            "8": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+hp = HTMLParser()"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 16,
                "PatchRowcode": "+# These schemas are allowed in full urls to consider them in the portal:"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 17,
                "PatchRowcode": "+# A mailto schema is an obvious sign of a url that is not in the portal."
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 18,
                "PatchRowcode": "+# This is a whitelist."
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+ALLOWED_SCHEMAS = ["
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 20,
                "PatchRowcode": "+    'https',"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+    'http',"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+]"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+# These bad parts are not allowed in urls that are in the portal:"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+# This is a blacklist."
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+BAD_URL_PARTS = ["
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+    '\\\\\\\\',"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+    '<script',"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+    '%3cscript',"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+    'javascript:',"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+    'javascript%3a',"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+]"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " class URLTool(PloneBaseTool, BaseTool):"
            },
            "30": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " "
            },
            "31": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "     meta_type = 'Plone URL Tool'"
            },
            "32": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "         # sanitize url"
            },
            "33": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "         url = re.sub('^[\\x00-\\x20]+', '', url).strip()"
            },
            "34": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "         cmp_url = url.lower()"
            },
            "35": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if ('\\\\\\\\' in cmp_url or"
            },
            "36": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                '<script' in cmp_url or"
            },
            "37": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                '%3cscript' in cmp_url or"
            },
            "38": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                'javascript:' in cmp_url or"
            },
            "39": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                'javascript%3a' in cmp_url):"
            },
            "40": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return False"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+        for bad in BAD_URL_PARTS:"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+            if bad in cmp_url:"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+                return False"
            },
            "44": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 60,
                "PatchRowcode": " "
            },
            "45": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "         p_url = self()"
            },
            "46": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 62,
                "PatchRowcode": " "
            },
            "47": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        _, u_host, u_path, _, _, _ = urlparse(url)"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+        schema, u_host, u_path, _, _, _ = urlparse(url)"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        if schema and schema not in ALLOWED_SCHEMAS:"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+            # Redirecting to 'data:' may be harmful,"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+            # and redirecting to 'mailto:' or 'ftp:' is silly."
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+            return False"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+        # Someone may be doing tricks with escaped html code."
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+        unescaped_url = hp.unescape(url)"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+        if unescaped_url != url:"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+            if not self.isURLInPortal(unescaped_url):"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+                return False"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+"
            },
            "60": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "         if not u_host and not u_path.startswith('/'):"
            },
            "61": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "             if context is None:"
            },
            "62": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "                 return True  # old behavior"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from AccessControl import ClassSecurityInfo",
            "from App.class_init import InitializeClass",
            "from plone.registry.interfaces import IRegistry",
            "from posixpath import normpath",
            "from Products.CMFCore.URLTool import URLTool as BaseTool",
            "from Products.CMFPlone.interfaces import ILoginSchema",
            "from Products.CMFPlone.PloneBaseTool import PloneBaseTool",
            "from urlparse import urlparse, urljoin",
            "from zope.component import getUtility",
            "import re",
            "",
            "",
            "class URLTool(PloneBaseTool, BaseTool):",
            "",
            "    meta_type = 'Plone URL Tool'",
            "    security = ClassSecurityInfo()",
            "    toolicon = 'skins/plone_images/link_icon.png'",
            "",
            "    security.declarePublic('isURLInPortal')",
            "",
            "    def isURLInPortal(self, url, context=None):",
            "        # Check if a given url is on the same host and contains the portal",
            "        # path.  Used to ensure that login forms can determine relevant",
            "        # referrers (i.e. in portal).  Also return true for some relative",
            "        # urls if context is passed in to allow for url parsing. When context",
            "        # is not provided, assume that relative urls are in the portal. It is",
            "        # assumed that http://portal is the same portal as https://portal.",
            "",
            "        # External sites listed in 'allow_external_login_sites' of",
            "        # site_properties are also considered within the portal to allow for",
            "        # single sign on.",
            "",
            "        # sanitize url",
            "        url = re.sub('^[\\x00-\\x20]+', '', url).strip()",
            "        cmp_url = url.lower()",
            "        if ('\\\\\\\\' in cmp_url or",
            "                '<script' in cmp_url or",
            "                '%3cscript' in cmp_url or",
            "                'javascript:' in cmp_url or",
            "                'javascript%3a' in cmp_url):",
            "            return False",
            "",
            "        p_url = self()",
            "",
            "        _, u_host, u_path, _, _, _ = urlparse(url)",
            "        if not u_host and not u_path.startswith('/'):",
            "            if context is None:",
            "                return True  # old behavior",
            "            if not context.isPrincipiaFolderish:",
            "                useurl = context.aq_parent.absolute_url()",
            "            else:",
            "                useurl = context.absolute_url()",
            "        else:",
            "            useurl = p_url  # when u_path.startswith('/')",
            "        if not useurl.endswith('/'):",
            "            useurl += '/'",
            "",
            "        # urljoin to current url to get an absolute path",
            "        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))",
            "",
            "        # normalise to end with a '/' so /foobar is not considered within /foo",
            "        if not u_path:",
            "            u_path = '/'",
            "        else:",
            "            u_path = normpath(u_path)",
            "            if not u_path.endswith('/'):",
            "                u_path += '/'",
            "        _, host, path, _, _, _ = urlparse(p_url)",
            "        if not path.endswith('/'):",
            "            path += '/'",
            "        if host == u_host and u_path.startswith(path):",
            "            return True",
            "",
            "        registry = getUtility(IRegistry)",
            "        settings = registry.forInterface(ILoginSchema, prefix='plone')",
            "        for external_site in settings.allow_external_login_sites:",
            "            _, host, path, _, _, _ = urlparse(external_site)",
            "            if not path.endswith('/'):",
            "                path += '/'",
            "            if host == u_host and u_path.startswith(path):",
            "                return True",
            "        return False",
            "",
            "",
            "URLTool.__doc__ = BaseTool.__doc__",
            "",
            "InitializeClass(URLTool)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from AccessControl import ClassSecurityInfo",
            "from App.class_init import InitializeClass",
            "from HTMLParser import HTMLParser",
            "from plone.registry.interfaces import IRegistry",
            "from posixpath import normpath",
            "from Products.CMFCore.URLTool import URLTool as BaseTool",
            "from Products.CMFPlone.interfaces import ILoginSchema",
            "from Products.CMFPlone.PloneBaseTool import PloneBaseTool",
            "from urlparse import urlparse, urljoin",
            "from zope.component import getUtility",
            "import re",
            "",
            "",
            "hp = HTMLParser()",
            "# These schemas are allowed in full urls to consider them in the portal:",
            "# A mailto schema is an obvious sign of a url that is not in the portal.",
            "# This is a whitelist.",
            "ALLOWED_SCHEMAS = [",
            "    'https',",
            "    'http',",
            "]",
            "# These bad parts are not allowed in urls that are in the portal:",
            "# This is a blacklist.",
            "BAD_URL_PARTS = [",
            "    '\\\\\\\\',",
            "    '<script',",
            "    '%3cscript',",
            "    'javascript:',",
            "    'javascript%3a',",
            "]",
            "",
            "",
            "class URLTool(PloneBaseTool, BaseTool):",
            "",
            "    meta_type = 'Plone URL Tool'",
            "    security = ClassSecurityInfo()",
            "    toolicon = 'skins/plone_images/link_icon.png'",
            "",
            "    security.declarePublic('isURLInPortal')",
            "",
            "    def isURLInPortal(self, url, context=None):",
            "        # Check if a given url is on the same host and contains the portal",
            "        # path.  Used to ensure that login forms can determine relevant",
            "        # referrers (i.e. in portal).  Also return true for some relative",
            "        # urls if context is passed in to allow for url parsing. When context",
            "        # is not provided, assume that relative urls are in the portal. It is",
            "        # assumed that http://portal is the same portal as https://portal.",
            "",
            "        # External sites listed in 'allow_external_login_sites' of",
            "        # site_properties are also considered within the portal to allow for",
            "        # single sign on.",
            "",
            "        # sanitize url",
            "        url = re.sub('^[\\x00-\\x20]+', '', url).strip()",
            "        cmp_url = url.lower()",
            "        for bad in BAD_URL_PARTS:",
            "            if bad in cmp_url:",
            "                return False",
            "",
            "        p_url = self()",
            "",
            "        schema, u_host, u_path, _, _, _ = urlparse(url)",
            "        if schema and schema not in ALLOWED_SCHEMAS:",
            "            # Redirecting to 'data:' may be harmful,",
            "            # and redirecting to 'mailto:' or 'ftp:' is silly.",
            "            return False",
            "",
            "        # Someone may be doing tricks with escaped html code.",
            "        unescaped_url = hp.unescape(url)",
            "        if unescaped_url != url:",
            "            if not self.isURLInPortal(unescaped_url):",
            "                return False",
            "",
            "        if not u_host and not u_path.startswith('/'):",
            "            if context is None:",
            "                return True  # old behavior",
            "            if not context.isPrincipiaFolderish:",
            "                useurl = context.aq_parent.absolute_url()",
            "            else:",
            "                useurl = context.absolute_url()",
            "        else:",
            "            useurl = p_url  # when u_path.startswith('/')",
            "        if not useurl.endswith('/'):",
            "            useurl += '/'",
            "",
            "        # urljoin to current url to get an absolute path",
            "        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))",
            "",
            "        # normalise to end with a '/' so /foobar is not considered within /foo",
            "        if not u_path:",
            "            u_path = '/'",
            "        else:",
            "            u_path = normpath(u_path)",
            "            if not u_path.endswith('/'):",
            "                u_path += '/'",
            "        _, host, path, _, _, _ = urlparse(p_url)",
            "        if not path.endswith('/'):",
            "            path += '/'",
            "        if host == u_host and u_path.startswith(path):",
            "            return True",
            "",
            "        registry = getUtility(IRegistry)",
            "        settings = registry.forInterface(ILoginSchema, prefix='plone')",
            "        for external_site in settings.allow_external_login_sites:",
            "            _, host, path, _, _, _ = urlparse(external_site)",
            "            if not path.endswith('/'):",
            "                path += '/'",
            "            if host == u_host and u_path.startswith(path):",
            "                return True",
            "        return False",
            "",
            "",
            "URLTool.__doc__ = BaseTool.__doc__",
            "",
            "InitializeClass(URLTool)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "37": [
                "URLTool",
                "isURLInPortal"
            ],
            "38": [
                "URLTool",
                "isURLInPortal"
            ],
            "39": [
                "URLTool",
                "isURLInPortal"
            ],
            "40": [
                "URLTool",
                "isURLInPortal"
            ],
            "41": [
                "URLTool",
                "isURLInPortal"
            ],
            "42": [
                "URLTool",
                "isURLInPortal"
            ],
            "46": [
                "URLTool",
                "isURLInPortal"
            ]
        },
        "addLocation": []
    },
    "Products/CMFPlone/tests/testURLTool.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 136,
                "PatchRowcode": "         url_tool = self._makeOne()"
            },
            "1": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "         iURLiP = url_tool.isURLInPortal"
            },
            "2": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": 138,
                "PatchRowcode": "         self.assertFalse(iURLiP('\\\\\\\\www.example.com'))"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+    def test_regression_absolute_url_in_portal(self):"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 141,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 142,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+        self.assertTrue(iURLiP(url_tool()))"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+        self.assertTrue(iURLiP(url_tool() + '/shrubbery?knights=ni#ekki-ekki'))"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+    def test_mailto_simple_not_in_portal(self):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 147,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 148,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 149,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+            'mailto:someone@example.org')"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 151,
                "PatchRowcode": "+        )"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+    def test_mailto_complex_not_in_portal(self):"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+            'mailto&#58;192&#46;168&#46;163&#46;154&#58;8080&#47;Plone&apos;'"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+            '&quot;&gt;&lt;html&gt;&lt;svg&#32;onload&#61;alert&#40;document'"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 159,
                "PatchRowcode": "+            '&#46;domain&#41;&gt;&lt;&#47;html&gt;')"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 160,
                "PatchRowcode": "+        )"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+    def test_data_not_in_portal(self):"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 166,
                "PatchRowcode": "+            'data:text/html%3bbase64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K')"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 167,
                "PatchRowcode": "+        )"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 168,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 169,
                "PatchRowcode": "+    def test_double_slash(self):"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 170,
                "PatchRowcode": "+        # I wondered if this might be a problem after reading"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 171,
                "PatchRowcode": "+        # https://bugs.python.org/issue23505"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 172,
                "PatchRowcode": "+        # Apparently not, but let's test it."
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 173,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 174,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 175,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 176,
                "PatchRowcode": "+            '//www.google.com'))"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 177,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 178,
                "PatchRowcode": "+            '////www.google.com'))"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import unittest",
            "",
            "from Products.CMFCore.tests.base.dummy import DummySite",
            "from Products.CMFCore.tests.base.dummy import DummyFolder",
            "from Products.CMFCore.tests.base.dummy import DummyContent",
            "",
            "from Acquisition import aq_parent",
            "from plone.registry.interfaces import IRegistry",
            "from Products.CMFPlone.interfaces import ILoginSchema",
            "from zope.component import getSiteManager",
            "",
            "",
            "class DummyFolder(DummyFolder):",
            "",
            "    def absolute_url(self):",
            "        return '/'.join([aq_parent(self).absolute_url(), self.getId()])",
            "",
            "",
            "class DummyLoginSettings():",
            "    allow_external_login_sites = [",
            "        'http://external1',",
            "        'http://external2/',",
            "        'http://external3/site',",
            "        'http://external4/site/'",
            "    ]",
            "",
            "",
            "class DummyRegistry(DummyContent):",
            "",
            "    def __getitem__(self, name, default=None):",
            "        if name == 'plone.allow_external_login_sites':",
            "            return DummyLoginSettings().allow_external_login_sites",
            "        return default",
            "",
            "    def forInterface(self, iface, prefix=''):",
            "        if iface == ILoginSchema:",
            "            return DummyLoginSettings()",
            "",
            "",
            "class TestURLTool(unittest.TestCase):",
            "",
            "    def setUp(self):",
            "        self.site = DummySite(id='foo')",
            "        self.site._setObject('foo', DummyFolder(id='foo'))",
            "        self.site.foo._setObject('doc1', DummyContent(id='doc1'))",
            "        mock_registry = DummyRegistry(id='portal_registry')",
            "        self.site.portal_registry = mock_registry",
            "        sm = getSiteManager()",
            "        sm.registerUtility(component=mock_registry, provided=IRegistry)",
            "",
            "    def _makeOne(self, *args, **kw):",
            "        from Products.CMFPlone.URLTool import URLTool",
            "        url_tool = URLTool(*args, **kw)",
            "        return url_tool.__of__(self.site)",
            "",
            "    def test_isURLInPortal(self):",
            "        # First test what the absolute url of the site is, otherwise these",
            "        # tests look really weird.  Apparently our domain is www.foobar.com.",
            "        self.assertEqual(self.site.absolute_url(),",
            "                         'http://www.foobar.com/bar/foo')",
            "",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))",
            "        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar'))",
            "        self.assertFalse(iURLiP('/images'))",
            "        self.assertTrue(iURLiP('/bar/foo/foo'))",
            "",
            "    def test_isURLInPortalRelative(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "",
            "        # non-root relative urls will need a current context to be passed in",
            "        self.assertTrue(iURLiP('images/img1.jpg'))",
            "        self.assertTrue(iURLiP('./images/img1.jpg'))",
            "",
            "        # /bar/foo/something",
            "        self.assertTrue(iURLiP('../something', self.site.foo.doc1))",
            "        # /bar/afolder",
            "        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))",
            "        # /afolder",
            "        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))",
            "",
            "        # /../afolder? How do we have more ../'s than there are parts in",
            "        # the URL?",
            "        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))",
            "",
            "        # /bar/foo/afolder",
            "        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))",
            "",
            "    def test_isURLInPortalExternal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://external1'))",
            "        self.assertTrue(iURLiP('http://external1/'))",
            "        self.assertTrue(iURLiP('http://external1/something'))",
            "        self.assertTrue(iURLiP('http://external2'))",
            "        self.assertTrue(iURLiP('http://external2/'))",
            "        self.assertTrue(iURLiP('http://external2/something'))",
            "        self.assertTrue(iURLiP('http://external3/site'))",
            "        self.assertTrue(iURLiP('http://external3/site/'))",
            "        self.assertTrue(iURLiP('http://external3/site/something'))",
            "        self.assertTrue(iURLiP('http://external4/site'))",
            "        self.assertTrue(iURLiP('http://external4/site/'))",
            "        self.assertTrue(iURLiP('http://external4/site/something'))",
            "",
            "        self.assertFalse(iURLiP('http://external3/other'))",
            "        self.assertFalse(iURLiP('http://external4/other'))",
            "        self.assertFalse(iURLiP('http://external5'))",
            "        self.assertFalse(iURLiP('http://external11'))",
            "",
            "    def test_script_tag_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('<script>alert(\"hi\");</script>'))",
            "        self.assertFalse(iURLiP('<sCript>alert(\"hi\");</script>'))",
            "        self.assertFalse(",
            "            iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "        self.assertFalse(",
            "            iURLiP('%3CsCript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "",
            "    def test_inline_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('javascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('javascript:alert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript:alert(3)'))",
            "",
            "    def test_double_back_slash(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('\\\\\\\\www.example.com'))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import unittest",
            "",
            "from Products.CMFCore.tests.base.dummy import DummySite",
            "from Products.CMFCore.tests.base.dummy import DummyFolder",
            "from Products.CMFCore.tests.base.dummy import DummyContent",
            "",
            "from Acquisition import aq_parent",
            "from plone.registry.interfaces import IRegistry",
            "from Products.CMFPlone.interfaces import ILoginSchema",
            "from zope.component import getSiteManager",
            "",
            "",
            "class DummyFolder(DummyFolder):",
            "",
            "    def absolute_url(self):",
            "        return '/'.join([aq_parent(self).absolute_url(), self.getId()])",
            "",
            "",
            "class DummyLoginSettings():",
            "    allow_external_login_sites = [",
            "        'http://external1',",
            "        'http://external2/',",
            "        'http://external3/site',",
            "        'http://external4/site/'",
            "    ]",
            "",
            "",
            "class DummyRegistry(DummyContent):",
            "",
            "    def __getitem__(self, name, default=None):",
            "        if name == 'plone.allow_external_login_sites':",
            "            return DummyLoginSettings().allow_external_login_sites",
            "        return default",
            "",
            "    def forInterface(self, iface, prefix=''):",
            "        if iface == ILoginSchema:",
            "            return DummyLoginSettings()",
            "",
            "",
            "class TestURLTool(unittest.TestCase):",
            "",
            "    def setUp(self):",
            "        self.site = DummySite(id='foo')",
            "        self.site._setObject('foo', DummyFolder(id='foo'))",
            "        self.site.foo._setObject('doc1', DummyContent(id='doc1'))",
            "        mock_registry = DummyRegistry(id='portal_registry')",
            "        self.site.portal_registry = mock_registry",
            "        sm = getSiteManager()",
            "        sm.registerUtility(component=mock_registry, provided=IRegistry)",
            "",
            "    def _makeOne(self, *args, **kw):",
            "        from Products.CMFPlone.URLTool import URLTool",
            "        url_tool = URLTool(*args, **kw)",
            "        return url_tool.__of__(self.site)",
            "",
            "    def test_isURLInPortal(self):",
            "        # First test what the absolute url of the site is, otherwise these",
            "        # tests look really weird.  Apparently our domain is www.foobar.com.",
            "        self.assertEqual(self.site.absolute_url(),",
            "                         'http://www.foobar.com/bar/foo')",
            "",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))",
            "        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar'))",
            "        self.assertFalse(iURLiP('/images'))",
            "        self.assertTrue(iURLiP('/bar/foo/foo'))",
            "",
            "    def test_isURLInPortalRelative(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "",
            "        # non-root relative urls will need a current context to be passed in",
            "        self.assertTrue(iURLiP('images/img1.jpg'))",
            "        self.assertTrue(iURLiP('./images/img1.jpg'))",
            "",
            "        # /bar/foo/something",
            "        self.assertTrue(iURLiP('../something', self.site.foo.doc1))",
            "        # /bar/afolder",
            "        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))",
            "        # /afolder",
            "        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))",
            "",
            "        # /../afolder? How do we have more ../'s than there are parts in",
            "        # the URL?",
            "        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))",
            "",
            "        # /bar/foo/afolder",
            "        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))",
            "",
            "    def test_isURLInPortalExternal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://external1'))",
            "        self.assertTrue(iURLiP('http://external1/'))",
            "        self.assertTrue(iURLiP('http://external1/something'))",
            "        self.assertTrue(iURLiP('http://external2'))",
            "        self.assertTrue(iURLiP('http://external2/'))",
            "        self.assertTrue(iURLiP('http://external2/something'))",
            "        self.assertTrue(iURLiP('http://external3/site'))",
            "        self.assertTrue(iURLiP('http://external3/site/'))",
            "        self.assertTrue(iURLiP('http://external3/site/something'))",
            "        self.assertTrue(iURLiP('http://external4/site'))",
            "        self.assertTrue(iURLiP('http://external4/site/'))",
            "        self.assertTrue(iURLiP('http://external4/site/something'))",
            "",
            "        self.assertFalse(iURLiP('http://external3/other'))",
            "        self.assertFalse(iURLiP('http://external4/other'))",
            "        self.assertFalse(iURLiP('http://external5'))",
            "        self.assertFalse(iURLiP('http://external11'))",
            "",
            "    def test_script_tag_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('<script>alert(\"hi\");</script>'))",
            "        self.assertFalse(iURLiP('<sCript>alert(\"hi\");</script>'))",
            "        self.assertFalse(",
            "            iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "        self.assertFalse(",
            "            iURLiP('%3CsCript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "",
            "    def test_inline_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('javascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('javascript:alert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript:alert(3)'))",
            "",
            "    def test_double_back_slash(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('\\\\\\\\www.example.com'))",
            "",
            "    def test_regression_absolute_url_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP(url_tool()))",
            "        self.assertTrue(iURLiP(url_tool() + '/shrubbery?knights=ni#ekki-ekki'))",
            "",
            "    def test_mailto_simple_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            'mailto:someone@example.org')",
            "        )",
            "",
            "    def test_mailto_complex_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            'mailto&#58;192&#46;168&#46;163&#46;154&#58;8080&#47;Plone&apos;'",
            "            '&quot;&gt;&lt;html&gt;&lt;svg&#32;onload&#61;alert&#40;document'",
            "            '&#46;domain&#41;&gt;&lt;&#47;html&gt;')",
            "        )",
            "",
            "    def test_data_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            'data:text/html%3bbase64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K')",
            "        )",
            "",
            "    def test_double_slash(self):",
            "        # I wondered if this might be a problem after reading",
            "        # https://bugs.python.org/issue23505",
            "        # Apparently not, but let's test it.",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            '//www.google.com'))",
            "        self.assertFalse(iURLiP(",
            "            '////www.google.com'))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "Products.CMFPlone.tests.testURLTool.TestURLTool.self",
            "bikeshed.cli.handleRefs"
        ]
    }
}