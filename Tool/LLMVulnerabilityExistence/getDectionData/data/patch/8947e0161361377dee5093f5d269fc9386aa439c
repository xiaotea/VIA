{
    "vantage6-server/vantage6/server/permission.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from vantage6.server.model.role import Role"
            },
            "1": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from vantage6.server.model.rule import Rule, Operation, Scope"
            },
            "2": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from vantage6.server.model.base import DatabaseSessionManager"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+from vantage6.server.model.organization import Organization"
            },
            "4": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from vantage6.common import logger_name"
            },
            "5": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " module_name = logger_name(__name__)"
            },
            "7": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " RuleNeed = namedtuple(\"RuleNeed\", [\"name\", \"scope\", \"operation\"])"
            },
            "8": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class RuleCollection:"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+# TODO document this function in the API reference"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+def get_scopes_with_level(minimal_scope: Scope) -> list[Scope]:"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+    \"\"\""
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+    Get scopes that are at least equal to a certain scope"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+    Parameters"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+    ----------"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+    minimal_scope: Scope"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+        Minimal scope"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+    Returns"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+    -------"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+    list[Scope]"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+        List of scopes that are at least equal to the minimal scope"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 36,
                "PatchRowcode": "+    Raises"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+    ------"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+    ValueError"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+        If the minimal scope is not known"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+    \"\"\""
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    if minimal_scope == Scope.ORGANIZATION:"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+        return [Scope.ORGANIZATION, Scope.COLLABORATION, Scope.GLOBAL]"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+    elif minimal_scope == Scope.COLLABORATION:"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+        return [Scope.COLLABORATION, Scope.GLOBAL]"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+    elif minimal_scope == Scope.GLOBAL:"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+        return [Scope.GLOBAL]"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+    elif minimal_scope == Scope.OWN:"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 48,
                "PatchRowcode": "+        return [Scope.OWN, Scope.ORGANIZATION, Scope.COLLABORATION,"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+                Scope.GLOBAL]"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+    else:"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+        raise ValueError(f\"Unknown scope '{minimal_scope}'\")"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+class RuleCollection(dict):"
            },
            "45": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "     \"\"\""
            },
            "46": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "     Class that tracks a set of all rules for a certain resource name"
            },
            "47": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 57,
                "PatchRowcode": " "
            },
            "48": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "         permission = Permission(RuleNeed(self.name, scope, operation))"
            },
            "49": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 79,
                "PatchRowcode": "         self.__setattr__(f'{operation.value}_{scope.value}', permission)"
            },
            "50": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 80,
                "PatchRowcode": " "
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+    def can_by_org(self, operation: Operation, subject_org_id: int,"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+                   own_org: Organization) -> bool:"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+        \"\"\""
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        Check if an operation is on a certain organization"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+        Parameters"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+        ----------"
            },
            "58": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+        operation: Operation"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+            Operation to check if allowed"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+        subject_org_id: int"
            },
            "61": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+            Organization id on which the operation should be allowed"
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+        own_org: Organization"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+            Organization of the user/node/algorithm that is performing the"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+            operation"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+        Returns"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+        -------"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+        bool"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+            True if the operation is allowed on the organization, False"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+            otherwise"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+        \"\"\""
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+        # check if the entity has global permission"
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+        global_perm = getattr(self, f'{operation.value}_{Scope.GLOBAL.value}')"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+        if global_perm and global_perm.can():"
            },
            "75": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+            return True"
            },
            "76": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+        # check if the entity has organization permission and organization is"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+        # the same as the subject organization"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+        org_perm = getattr(self,"
            },
            "80": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+                           f'{operation.value}_{Scope.ORGANIZATION.value}')"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+        if own_org.id == subject_org_id and org_perm and org_perm.can():"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+            return True"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+        # check if the entity has collaboration permission and the subject"
            },
            "85": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+        # organization is in the collaboration of the own organization"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+        col_perm = getattr(self,"
            },
            "87": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+                           f'{operation.value}_{Scope.COLLABORATION.value}')"
            },
            "88": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+        if col_perm and col_perm.can():"
            },
            "89": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+            for col in own_org.collaborations:"
            },
            "90": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 120,
                "PatchRowcode": "+                if subject_org_id in [org.id for org in col.organizations]:"
            },
            "91": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+                    return True"
            },
            "92": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+        # no permission found"
            },
            "93": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 123,
                "PatchRowcode": "+        return False"
            },
            "94": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 124,
                "PatchRowcode": "+"
            },
            "95": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 125,
                "PatchRowcode": "+    def _get_relevant_perms(self, operation: Operation,"
            },
            "96": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 126,
                "PatchRowcode": "+                            minimal_scope: Scope) -> list[Permission]:"
            },
            "97": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+        \"\"\""
            },
            "98": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+        Get permissions that are relevant for a certain operation with at least"
            },
            "99": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+        the given scope"
            },
            "100": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+"
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+        Parameters"
            },
            "102": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+        ----------"
            },
            "103": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+        operation: Operation"
            },
            "104": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+            Operation to check if allowed"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+        minimal_scope: Scope"
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+            Scope to check if allowed"
            },
            "107": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+"
            },
            "108": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+        Returns"
            },
            "109": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+        -------"
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+        list[Permission]"
            },
            "111": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 141,
                "PatchRowcode": "+            List of permissions that are relevant for the operation and scope"
            },
            "112": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 142,
                "PatchRowcode": "+        \"\"\""
            },
            "113": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+        perms = []"
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+        scopes = get_scopes_with_level(minimal_scope)"
            },
            "115": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+        for scope in scopes:"
            },
            "116": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+            perm = getattr(self, f'{operation.value}_{scope.value}')"
            },
            "117": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 147,
                "PatchRowcode": "+            if perm is not None:"
            },
            "118": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 148,
                "PatchRowcode": "+                perms.append(perm)"
            },
            "119": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 149,
                "PatchRowcode": "+        return perms"
            },
            "120": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+"
            },
            "121": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 151,
                "PatchRowcode": "+    def has_minimal_scope(self, operation: Operation,"
            },
            "122": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+                          minimal_scope: Scope) -> bool:"
            },
            "123": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+        \"\"\""
            },
            "124": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+        Check if a node/user/algorithm has at least the given scope for a"
            },
            "125": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+        certain operation"
            },
            "126": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+"
            },
            "127": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+        Parameters"
            },
            "128": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+        ----------"
            },
            "129": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 159,
                "PatchRowcode": "+        operation: Operation"
            },
            "130": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 160,
                "PatchRowcode": "+            Operation to check if allowed"
            },
            "131": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+        minimal_scope: Scope"
            },
            "132": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+            Minimal scope that user/node/algorithm should have"
            },
            "133": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+"
            },
            "134": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+        Returns"
            },
            "135": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+        -------"
            },
            "136": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 166,
                "PatchRowcode": "+        bool"
            },
            "137": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 167,
                "PatchRowcode": "+            True if the entity is allowed to perform the operation on at least"
            },
            "138": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 168,
                "PatchRowcode": "+            the scope provided, False otherwise"
            },
            "139": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 169,
                "PatchRowcode": "+        \"\"\""
            },
            "140": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 170,
                "PatchRowcode": "+        perms = self._get_relevant_perms(operation, minimal_scope)"
            },
            "141": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 171,
                "PatchRowcode": "+        return any([perm.can() for perm in perms])"
            },
            "142": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 172,
                "PatchRowcode": "+"
            },
            "143": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 173,
                "PatchRowcode": " "
            },
            "144": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 174,
                "PatchRowcode": " class PermissionManager:"
            },
            "145": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 175,
                "PatchRowcode": "     \"\"\""
            }
        },
        "frontPatchFile": [
            "import logging",
            "import importlib",
            "",
            "from collections import namedtuple",
            "from flask_principal import Permission, PermissionDenied",
            "",
            "from vantage6.server.globals import RESOURCES",
            "from vantage6.server.default_roles import DefaultRole",
            "from vantage6.server.model.role import Role",
            "from vantage6.server.model.rule import Rule, Operation, Scope",
            "from vantage6.server.model.base import DatabaseSessionManager",
            "from vantage6.common import logger_name",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "RuleNeed = namedtuple(\"RuleNeed\", [\"name\", \"scope\", \"operation\"])",
            "",
            "",
            "class RuleCollection:",
            "    \"\"\"",
            "    Class that tracks a set of all rules for a certain resource name",
            "",
            "    Parameters",
            "    ----------",
            "    name: str",
            "        Name of the resource endpoint (e.g. node, organization, user)",
            "    \"\"\"",
            "",
            "    def __init__(self, name: str) -> None:",
            "        self.name = name",
            "",
            "    def add(self, scope: Scope, operation: Operation) -> None:",
            "        \"\"\"",
            "        Add a rule to the rule collection",
            "",
            "        Parameters",
            "        ----------",
            "        scope: Scope",
            "            Scope within which to apply the rule",
            "        operation: Operation",
            "            What operation the rule applies to",
            "        \"\"\"",
            "        permission = Permission(RuleNeed(self.name, scope, operation))",
            "        self.__setattr__(f'{operation.value}_{scope.value}', permission)",
            "",
            "",
            "class PermissionManager:",
            "    \"\"\"",
            "    Loads the permissions and syncs rules in database with rules defined in",
            "    the code",
            "    \"\"\"",
            "",
            "    def __init__(self) -> None:",
            "        self.collections = {}",
            "        log.info(\"Loading permission system...\")",
            "        self.load_rules_from_resources()",
            "",
            "    def load_rules_from_resources(self) -> None:",
            "        \"\"\"",
            "        Collect all permission rules from all registered API resources",
            "        \"\"\"",
            "        for res in RESOURCES:",
            "            module = importlib.import_module('vantage6.server.resource.' + res)",
            "            try:",
            "                module.permissions(self)",
            "            except Exception:",
            "                module_name = module.__name__.split(\".\")[-1]",
            "                log.debug(f\"Resource '{module_name}' contains no or invalid \"",
            "                          \"permissions\")",
            "",
            "    def assign_rule_to_root(self, name: str, scope: Scope,",
            "                            operation: Operation) -> None:",
            "        \"\"\"",
            "        Assign a rule to the root role.",
            "",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        self.assign_rule_to_fixed_role(DefaultRole.ROOT, name, scope,",
            "                                       operation)",
            "",
            "    def assign_rule_to_node(self, resource: str, scope: Scope,",
            "                            operation: Operation) -> None:",
            "        \"\"\"",
            "        Assign a rule to the Node role.",
            "",
            "        Parameters",
            "        ----------",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        self.assign_rule_to_fixed_role(DefaultRole.NODE, resource, scope,",
            "                                       operation)",
            "",
            "    def assign_rule_to_container(self, resource: str, scope: Scope,",
            "                                 operation: Operation) -> None:",
            "        \"\"\"",
            "        Assign a rule to the container role.",
            "",
            "        Parameters",
            "        ----------",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        self.assign_rule_to_fixed_role(DefaultRole.CONTAINER, resource, scope,",
            "                                       operation)",
            "",
            "    @staticmethod",
            "    def assign_rule_to_fixed_role(fixedrole: str, resource: str, scope: Scope,",
            "                                  operation: Operation) -> None:",
            "        \"\"\"",
            "        Attach a rule to a fixed role (not adjustable by users).",
            "",
            "        Parameters",
            "        ----------",
            "        fixedrole: str",
            "            Name of the fixed role that the rule should be added to",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        role = Role.get_by_name(fixedrole)",
            "        if not role:",
            "            log.warning(f\"{fixedrole} role not found, creating it now!\")",
            "            role = Role(name=fixedrole, description=f\"{fixedrole} role\")",
            "",
            "        rule = Rule.get_by_(resource, scope, operation)",
            "        if not rule:",
            "            log.error(f\"Rule ({resource},{scope},{operation}) not found!\")",
            "",
            "        if rule not in role.rules:",
            "            role.rules.append(rule)",
            "            log.info(f\"Rule ({resource},{scope},{operation}) added to \"",
            "                     f\"{fixedrole} role!\")",
            "",
            "    def register_rule(self, resource: str, scope: Scope,",
            "                      operation: Operation, description=None,",
            "                      assign_to_node=False, assign_to_container=False) -> None:",
            "        \"\"\"",
            "        Register a permission rule in the database.",
            "",
            "        If a rule already exists, nothing is done. This rule can be used in API",
            "        endpoints to determine if a user, node or container can do a certain",
            "        operation in a certain scope.",
            "",
            "        Parameters",
            "        ----------",
            "        resource : str",
            "            API resource that the rule applies to",
            "        scope : Scope",
            "            Scope of the rule",
            "        operation : Operation",
            "            Operation of the rule",
            "        description : String, optional",
            "            Human readable description where the rule is used for, by default",
            "            None",
            "        assign_to_node: bool, optional",
            "            Whether rule should be assigned to the node role or not. Default",
            "            False",
            "        assign_to_container: bool, optional",
            "            Whether rule should be assigned to the container role or not.",
            "            Default False",
            "        \"\"\"",
            "        # verify that the rule is in the DB, so that these can be assigned to",
            "        # roles and users",
            "        rule = Rule.get_by_(resource, scope, operation)",
            "        if not rule:",
            "            rule = Rule(name=resource, operation=operation, scope=scope,",
            "                        description=description)",
            "            rule.save()",
            "            log.debug(f\"New auth rule '{resource}' with scope={scope}\"",
            "                      f\" and operation={operation} is stored in the DB\")",
            "",
            "        if assign_to_container:",
            "            self.assign_rule_to_container(resource, scope, operation)",
            "",
            "        if assign_to_node:",
            "            self.assign_rule_to_node(resource, scope, operation)",
            "",
            "        # assign all new rules to root user",
            "        self.assign_rule_to_root(resource, scope, operation)",
            "",
            "        self.collection(resource).add(rule.scope, rule.operation)",
            "",
            "    def appender(self, name: str) -> callable:",
            "        \"\"\"",
            "        Add a module's rules to the rule collection",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            The name of the module whose rules are to be registered",
            "",
            "        Returns",
            "        -------",
            "        Callable",
            "            A callable ``register_rule`` function",
            "        \"\"\"",
            "        # make sure collection exists",
            "        self.collection(name)",
            "        return lambda *args, **kwargs: self.register_rule(name, *args,",
            "                                                          **kwargs)",
            "",
            "    def collection(self, name: str) -> RuleCollection:",
            "        \"\"\"",
            "        Get a RuleCollection object. If it doesn't exist yet, it will be",
            "        created.",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            Name of the module whose RuleCollection is to be obtained or",
            "            created",
            "",
            "        Returns",
            "        -------",
            "        RuleCollection",
            "            The collection of rules belonging to the module name",
            "        \"\"\"",
            "        if self._collection_exists(name):",
            "            return self.collections[name]",
            "        else:",
            "            self.collections[name] = RuleCollection(name)",
            "            return self.collections[name]",
            "",
            "    def _collection_exists(self, name: str) -> bool:",
            "        \"\"\"",
            "        Check if a module's rule collection is defined",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            Name of the module to be checked",
            "",
            "        Returns",
            "        -------",
            "        bool:",
            "            True if RuleCollection is defined for module, else False",
            "        \"\"\"",
            "        return name in self.collections",
            "",
            "    def __getattr__(self, name: str) -> RuleCollection:",
            "        # TODO BvB 2023-01-18 I think this function might not be used. It would",
            "        # be triggered when we do something like",
            "        # `permissionManager.resource_name` but we don't ever do that (?!)",
            "        try:",
            "            collection = self.collections[name]",
            "            return collection",
            "        except Exception as e:",
            "            log.critical(f\"Missing permission collection! {name}\")",
            "            raise e",
            "",
            "    @staticmethod",
            "    def rule_exists_in_db(name: str, scope: Scope,",
            "                          operation: Operation) -> bool:",
            "        \"\"\"Check if the rule exists in the DB.",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            Name of the rule",
            "        scope: Scope",
            "            Scope of the rule",
            "        operation: Operation",
            "            Operation of the rule",
            "",
            "        Returns",
            "        -------",
            "        bool",
            "            Whenever this rule exists in the database or not",
            "        \"\"\"",
            "        session = DatabaseSessionManager.get_session()",
            "        result = session.query(Rule).filter_by(",
            "            name=name,",
            "            operation=operation,",
            "            scope=scope",
            "        ).scalar()",
            "        session.commit()",
            "        return result",
            "",
            "    @staticmethod",
            "    def check_user_rules(rules: list[Rule]) -> dict | bool:",
            "        \"\"\"",
            "        Check if a user, node or container has all the `rules` in a list",
            "",
            "        Parameters",
            "        ----------",
            "        rules: List[Rule]",
            "            List of rules that user is checked to have",
            "",
            "        Returns",
            "        -------",
            "        dict | bool",
            "            Dict with a message which rule is missing, else None",
            "        \"\"\"",
            "        for rule in rules:",
            "            requires = RuleNeed(rule.name, rule.scope, rule.operation)",
            "            try:",
            "                Permission(requires).test()",
            "            except PermissionDenied:",
            "                return {\"msg\": f\"You don't have the rule ({rule.name}, \"",
            "                        f\"{rule.scope}, {rule.operation})\"}",
            "        return None"
        ],
        "afterPatchFile": [
            "import logging",
            "import importlib",
            "",
            "from collections import namedtuple",
            "from flask_principal import Permission, PermissionDenied",
            "",
            "from vantage6.server.globals import RESOURCES",
            "from vantage6.server.default_roles import DefaultRole",
            "from vantage6.server.model.role import Role",
            "from vantage6.server.model.rule import Rule, Operation, Scope",
            "from vantage6.server.model.base import DatabaseSessionManager",
            "from vantage6.server.model.organization import Organization",
            "from vantage6.common import logger_name",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "RuleNeed = namedtuple(\"RuleNeed\", [\"name\", \"scope\", \"operation\"])",
            "",
            "",
            "# TODO document this function in the API reference",
            "def get_scopes_with_level(minimal_scope: Scope) -> list[Scope]:",
            "    \"\"\"",
            "    Get scopes that are at least equal to a certain scope",
            "",
            "    Parameters",
            "    ----------",
            "    minimal_scope: Scope",
            "        Minimal scope",
            "",
            "    Returns",
            "    -------",
            "    list[Scope]",
            "        List of scopes that are at least equal to the minimal scope",
            "",
            "    Raises",
            "    ------",
            "    ValueError",
            "        If the minimal scope is not known",
            "    \"\"\"",
            "    if minimal_scope == Scope.ORGANIZATION:",
            "        return [Scope.ORGANIZATION, Scope.COLLABORATION, Scope.GLOBAL]",
            "    elif minimal_scope == Scope.COLLABORATION:",
            "        return [Scope.COLLABORATION, Scope.GLOBAL]",
            "    elif minimal_scope == Scope.GLOBAL:",
            "        return [Scope.GLOBAL]",
            "    elif minimal_scope == Scope.OWN:",
            "        return [Scope.OWN, Scope.ORGANIZATION, Scope.COLLABORATION,",
            "                Scope.GLOBAL]",
            "    else:",
            "        raise ValueError(f\"Unknown scope '{minimal_scope}'\")",
            "",
            "",
            "class RuleCollection(dict):",
            "    \"\"\"",
            "    Class that tracks a set of all rules for a certain resource name",
            "",
            "    Parameters",
            "    ----------",
            "    name: str",
            "        Name of the resource endpoint (e.g. node, organization, user)",
            "    \"\"\"",
            "",
            "    def __init__(self, name: str) -> None:",
            "        self.name = name",
            "",
            "    def add(self, scope: Scope, operation: Operation) -> None:",
            "        \"\"\"",
            "        Add a rule to the rule collection",
            "",
            "        Parameters",
            "        ----------",
            "        scope: Scope",
            "            Scope within which to apply the rule",
            "        operation: Operation",
            "            What operation the rule applies to",
            "        \"\"\"",
            "        permission = Permission(RuleNeed(self.name, scope, operation))",
            "        self.__setattr__(f'{operation.value}_{scope.value}', permission)",
            "",
            "    def can_by_org(self, operation: Operation, subject_org_id: int,",
            "                   own_org: Organization) -> bool:",
            "        \"\"\"",
            "        Check if an operation is on a certain organization",
            "",
            "        Parameters",
            "        ----------",
            "        operation: Operation",
            "            Operation to check if allowed",
            "        subject_org_id: int",
            "            Organization id on which the operation should be allowed",
            "        own_org: Organization",
            "            Organization of the user/node/algorithm that is performing the",
            "            operation",
            "",
            "        Returns",
            "        -------",
            "        bool",
            "            True if the operation is allowed on the organization, False",
            "            otherwise",
            "        \"\"\"",
            "        # check if the entity has global permission",
            "        global_perm = getattr(self, f'{operation.value}_{Scope.GLOBAL.value}')",
            "        if global_perm and global_perm.can():",
            "            return True",
            "",
            "        # check if the entity has organization permission and organization is",
            "        # the same as the subject organization",
            "        org_perm = getattr(self,",
            "                           f'{operation.value}_{Scope.ORGANIZATION.value}')",
            "        if own_org.id == subject_org_id and org_perm and org_perm.can():",
            "            return True",
            "",
            "        # check if the entity has collaboration permission and the subject",
            "        # organization is in the collaboration of the own organization",
            "        col_perm = getattr(self,",
            "                           f'{operation.value}_{Scope.COLLABORATION.value}')",
            "        if col_perm and col_perm.can():",
            "            for col in own_org.collaborations:",
            "                if subject_org_id in [org.id for org in col.organizations]:",
            "                    return True",
            "        # no permission found",
            "        return False",
            "",
            "    def _get_relevant_perms(self, operation: Operation,",
            "                            minimal_scope: Scope) -> list[Permission]:",
            "        \"\"\"",
            "        Get permissions that are relevant for a certain operation with at least",
            "        the given scope",
            "",
            "        Parameters",
            "        ----------",
            "        operation: Operation",
            "            Operation to check if allowed",
            "        minimal_scope: Scope",
            "            Scope to check if allowed",
            "",
            "        Returns",
            "        -------",
            "        list[Permission]",
            "            List of permissions that are relevant for the operation and scope",
            "        \"\"\"",
            "        perms = []",
            "        scopes = get_scopes_with_level(minimal_scope)",
            "        for scope in scopes:",
            "            perm = getattr(self, f'{operation.value}_{scope.value}')",
            "            if perm is not None:",
            "                perms.append(perm)",
            "        return perms",
            "",
            "    def has_minimal_scope(self, operation: Operation,",
            "                          minimal_scope: Scope) -> bool:",
            "        \"\"\"",
            "        Check if a node/user/algorithm has at least the given scope for a",
            "        certain operation",
            "",
            "        Parameters",
            "        ----------",
            "        operation: Operation",
            "            Operation to check if allowed",
            "        minimal_scope: Scope",
            "            Minimal scope that user/node/algorithm should have",
            "",
            "        Returns",
            "        -------",
            "        bool",
            "            True if the entity is allowed to perform the operation on at least",
            "            the scope provided, False otherwise",
            "        \"\"\"",
            "        perms = self._get_relevant_perms(operation, minimal_scope)",
            "        return any([perm.can() for perm in perms])",
            "",
            "",
            "class PermissionManager:",
            "    \"\"\"",
            "    Loads the permissions and syncs rules in database with rules defined in",
            "    the code",
            "    \"\"\"",
            "",
            "    def __init__(self) -> None:",
            "        self.collections = {}",
            "        log.info(\"Loading permission system...\")",
            "        self.load_rules_from_resources()",
            "",
            "    def load_rules_from_resources(self) -> None:",
            "        \"\"\"",
            "        Collect all permission rules from all registered API resources",
            "        \"\"\"",
            "        for res in RESOURCES:",
            "            module = importlib.import_module('vantage6.server.resource.' + res)",
            "            try:",
            "                module.permissions(self)",
            "            except Exception:",
            "                module_name = module.__name__.split(\".\")[-1]",
            "                log.debug(f\"Resource '{module_name}' contains no or invalid \"",
            "                          \"permissions\")",
            "",
            "    def assign_rule_to_root(self, name: str, scope: Scope,",
            "                            operation: Operation) -> None:",
            "        \"\"\"",
            "        Assign a rule to the root role.",
            "",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        self.assign_rule_to_fixed_role(DefaultRole.ROOT, name, scope,",
            "                                       operation)",
            "",
            "    def assign_rule_to_node(self, resource: str, scope: Scope,",
            "                            operation: Operation) -> None:",
            "        \"\"\"",
            "        Assign a rule to the Node role.",
            "",
            "        Parameters",
            "        ----------",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        self.assign_rule_to_fixed_role(DefaultRole.NODE, resource, scope,",
            "                                       operation)",
            "",
            "    def assign_rule_to_container(self, resource: str, scope: Scope,",
            "                                 operation: Operation) -> None:",
            "        \"\"\"",
            "        Assign a rule to the container role.",
            "",
            "        Parameters",
            "        ----------",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        self.assign_rule_to_fixed_role(DefaultRole.CONTAINER, resource, scope,",
            "                                       operation)",
            "",
            "    @staticmethod",
            "    def assign_rule_to_fixed_role(fixedrole: str, resource: str, scope: Scope,",
            "                                  operation: Operation) -> None:",
            "        \"\"\"",
            "        Attach a rule to a fixed role (not adjustable by users).",
            "",
            "        Parameters",
            "        ----------",
            "        fixedrole: str",
            "            Name of the fixed role that the rule should be added to",
            "        resource: str",
            "            Resource that the rule applies to",
            "        scope: Scope",
            "            Scope that the rule applies to",
            "        operation: Operation",
            "            Operation that the rule applies to",
            "        \"\"\"",
            "        role = Role.get_by_name(fixedrole)",
            "        if not role:",
            "            log.warning(f\"{fixedrole} role not found, creating it now!\")",
            "            role = Role(name=fixedrole, description=f\"{fixedrole} role\")",
            "",
            "        rule = Rule.get_by_(resource, scope, operation)",
            "        if not rule:",
            "            log.error(f\"Rule ({resource},{scope},{operation}) not found!\")",
            "",
            "        if rule not in role.rules:",
            "            role.rules.append(rule)",
            "            log.info(f\"Rule ({resource},{scope},{operation}) added to \"",
            "                     f\"{fixedrole} role!\")",
            "",
            "    def register_rule(self, resource: str, scope: Scope,",
            "                      operation: Operation, description=None,",
            "                      assign_to_node=False, assign_to_container=False) -> None:",
            "        \"\"\"",
            "        Register a permission rule in the database.",
            "",
            "        If a rule already exists, nothing is done. This rule can be used in API",
            "        endpoints to determine if a user, node or container can do a certain",
            "        operation in a certain scope.",
            "",
            "        Parameters",
            "        ----------",
            "        resource : str",
            "            API resource that the rule applies to",
            "        scope : Scope",
            "            Scope of the rule",
            "        operation : Operation",
            "            Operation of the rule",
            "        description : String, optional",
            "            Human readable description where the rule is used for, by default",
            "            None",
            "        assign_to_node: bool, optional",
            "            Whether rule should be assigned to the node role or not. Default",
            "            False",
            "        assign_to_container: bool, optional",
            "            Whether rule should be assigned to the container role or not.",
            "            Default False",
            "        \"\"\"",
            "        # verify that the rule is in the DB, so that these can be assigned to",
            "        # roles and users",
            "        rule = Rule.get_by_(resource, scope, operation)",
            "        if not rule:",
            "            rule = Rule(name=resource, operation=operation, scope=scope,",
            "                        description=description)",
            "            rule.save()",
            "            log.debug(f\"New auth rule '{resource}' with scope={scope}\"",
            "                      f\" and operation={operation} is stored in the DB\")",
            "",
            "        if assign_to_container:",
            "            self.assign_rule_to_container(resource, scope, operation)",
            "",
            "        if assign_to_node:",
            "            self.assign_rule_to_node(resource, scope, operation)",
            "",
            "        # assign all new rules to root user",
            "        self.assign_rule_to_root(resource, scope, operation)",
            "",
            "        self.collection(resource).add(rule.scope, rule.operation)",
            "",
            "    def appender(self, name: str) -> callable:",
            "        \"\"\"",
            "        Add a module's rules to the rule collection",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            The name of the module whose rules are to be registered",
            "",
            "        Returns",
            "        -------",
            "        Callable",
            "            A callable ``register_rule`` function",
            "        \"\"\"",
            "        # make sure collection exists",
            "        self.collection(name)",
            "        return lambda *args, **kwargs: self.register_rule(name, *args,",
            "                                                          **kwargs)",
            "",
            "    def collection(self, name: str) -> RuleCollection:",
            "        \"\"\"",
            "        Get a RuleCollection object. If it doesn't exist yet, it will be",
            "        created.",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            Name of the module whose RuleCollection is to be obtained or",
            "            created",
            "",
            "        Returns",
            "        -------",
            "        RuleCollection",
            "            The collection of rules belonging to the module name",
            "        \"\"\"",
            "        if self._collection_exists(name):",
            "            return self.collections[name]",
            "        else:",
            "            self.collections[name] = RuleCollection(name)",
            "            return self.collections[name]",
            "",
            "    def _collection_exists(self, name: str) -> bool:",
            "        \"\"\"",
            "        Check if a module's rule collection is defined",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            Name of the module to be checked",
            "",
            "        Returns",
            "        -------",
            "        bool:",
            "            True if RuleCollection is defined for module, else False",
            "        \"\"\"",
            "        return name in self.collections",
            "",
            "    def __getattr__(self, name: str) -> RuleCollection:",
            "        # TODO BvB 2023-01-18 I think this function might not be used. It would",
            "        # be triggered when we do something like",
            "        # `permissionManager.resource_name` but we don't ever do that (?!)",
            "        try:",
            "            collection = self.collections[name]",
            "            return collection",
            "        except Exception as e:",
            "            log.critical(f\"Missing permission collection! {name}\")",
            "            raise e",
            "",
            "    @staticmethod",
            "    def rule_exists_in_db(name: str, scope: Scope,",
            "                          operation: Operation) -> bool:",
            "        \"\"\"Check if the rule exists in the DB.",
            "",
            "        Parameters",
            "        ----------",
            "        name: str",
            "            Name of the rule",
            "        scope: Scope",
            "            Scope of the rule",
            "        operation: Operation",
            "            Operation of the rule",
            "",
            "        Returns",
            "        -------",
            "        bool",
            "            Whenever this rule exists in the database or not",
            "        \"\"\"",
            "        session = DatabaseSessionManager.get_session()",
            "        result = session.query(Rule).filter_by(",
            "            name=name,",
            "            operation=operation,",
            "            scope=scope",
            "        ).scalar()",
            "        session.commit()",
            "        return result",
            "",
            "    @staticmethod",
            "    def check_user_rules(rules: list[Rule]) -> dict | bool:",
            "        \"\"\"",
            "        Check if a user, node or container has all the `rules` in a list",
            "",
            "        Parameters",
            "        ----------",
            "        rules: List[Rule]",
            "            List of rules that user is checked to have",
            "",
            "        Returns",
            "        -------",
            "        dict | bool",
            "            Dict with a message which rule is missing, else None",
            "        \"\"\"",
            "        for rule in rules:",
            "            requires = RuleNeed(rule.name, rule.scope, rule.operation)",
            "            try:",
            "                Permission(requires).test()",
            "            except PermissionDenied:",
            "                return {\"msg\": f\"You don't have the rule ({rule.name}, \"",
            "                        f\"{rule.scope}, {rule.operation})\"}",
            "        return None"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "20": [
                "RuleCollection"
            ]
        },
        "addLocation": []
    },
    "vantage6-server/vantage6/server/resource/organization.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from vantage6.server.permission import ("
            },
            "1": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": "     Scope as S,"
            },
            "2": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 13,
                "PatchRowcode": "     Operation as P,"
            },
            "3": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    PermissionManager"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+    PermissionManager,"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+    RuleCollection"
            },
            "6": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " )"
            },
            "7": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from vantage6.server.resource import ("
            },
            "8": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 18,
                "PatchRowcode": "     with_user_or_node, only_for, with_user, ServicesResources"
            },
            "9": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         description=\"edit any organization\")"
            },
            "10": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "     add(scope=S.ORGANIZATION, operation=P.EDIT,"
            },
            "11": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "         description=\"edit your own organization info\", assign_to_node=True)"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+    add(scope=S.COLLABORATION, operation=P.EDIT,"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+        description='edit collaborating organizations')"
            },
            "14": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "     add(scope=S.GLOBAL, operation=P.CREATE,"
            },
            "15": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "         description=\"create a new organization\")"
            },
            "16": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 107,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 116,
                "PatchRowcode": " "
            },
            "18": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "     def __init__(self, socketio, mail, api, permissions, config):"
            },
            "19": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 118,
                "PatchRowcode": "         super().__init__(socketio, mail, api, permissions, config)"
            },
            "20": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.r = getattr(self.permissions, module_name)"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+        self.r: RuleCollection = getattr(self.permissions, module_name)"
            },
            "22": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 120,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 121,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 122,
                "PatchRowcode": " class Organizations(OrganizationBase):"
            },
            "25": {
                "beforePatchRowNumber": 203,
                "afterPatchRowNumber": 206,
                "PatchRowcode": "         if 'country' in args:"
            },
            "26": {
                "beforePatchRowNumber": 204,
                "afterPatchRowNumber": 207,
                "PatchRowcode": "             q = q.filter(db.Organization.country == args['country'])"
            },
            "27": {
                "beforePatchRowNumber": 205,
                "afterPatchRowNumber": 208,
                "PatchRowcode": "         if 'collaboration_id' in args:"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 209,
                "PatchRowcode": "+            if not self.r.has_minimal_scope(P.VIEW, S.COLLABORATION):"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 210,
                "PatchRowcode": "+                return {"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 211,
                "PatchRowcode": "+                    'msg': 'You lack the permission to get all organizations '"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 212,
                "PatchRowcode": "+                    'in your collaboration!'"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 213,
                "PatchRowcode": "+                }, HTTPStatus.UNAUTHORIZED"
            },
            "33": {
                "beforePatchRowNumber": 206,
                "afterPatchRowNumber": 214,
                "PatchRowcode": "             q = q.join(db.Member).join(db.Collaboration)\\"
            },
            "34": {
                "beforePatchRowNumber": 207,
                "afterPatchRowNumber": 215,
                "PatchRowcode": "                  .filter(db.Collaboration.id == args['collaboration_id'])"
            },
            "35": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": 216,
                "PatchRowcode": " "
            },
            "36": {
                "beforePatchRowNumber": 216,
                "afterPatchRowNumber": 224,
                "PatchRowcode": "             ).all()"
            },
            "37": {
                "beforePatchRowNumber": 217,
                "afterPatchRowNumber": 225,
                "PatchRowcode": "             g.session.commit()"
            },
            "38": {
                "beforePatchRowNumber": 218,
                "afterPatchRowNumber": 226,
                "PatchRowcode": " "
            },
            "39": {
                "beforePatchRowNumber": 219,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # list comprehension fetish, and add own organization in case"
            },
            "40": {
                "beforePatchRowNumber": 220,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # this organization does not participate in any collaborations yet"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 227,
                "PatchRowcode": "+            # filter orgs in own collaborations, and add own organization in"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 228,
                "PatchRowcode": "+            # case this organization does not participate in any collaborations"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 229,
                "PatchRowcode": "+            # yet"
            },
            "44": {
                "beforePatchRowNumber": 221,
                "afterPatchRowNumber": 230,
                "PatchRowcode": "             org_ids = [o.id for col in collabs for o in col.organizations]"
            },
            "45": {
                "beforePatchRowNumber": 222,
                "afterPatchRowNumber": 231,
                "PatchRowcode": "             org_ids = list(set(org_ids + [auth_org.id]))"
            },
            "46": {
                "beforePatchRowNumber": 223,
                "afterPatchRowNumber": 232,
                "PatchRowcode": " "
            },
            "47": {
                "beforePatchRowNumber": 352,
                "afterPatchRowNumber": 361,
                "PatchRowcode": "             return {'msg': f'Organization id={id} not found!'}, \\"
            },
            "48": {
                "beforePatchRowNumber": 353,
                "afterPatchRowNumber": 362,
                "PatchRowcode": "                 HTTPStatus.NOT_FOUND"
            },
            "49": {
                "beforePatchRowNumber": 354,
                "afterPatchRowNumber": 363,
                "PatchRowcode": " "
            },
            "50": {
                "beforePatchRowNumber": 355,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        accepted = False"
            },
            "51": {
                "beforePatchRowNumber": 356,
                "afterPatchRowNumber": 364,
                "PatchRowcode": "         # Check if auth has enough permissions"
            },
            "52": {
                "beforePatchRowNumber": 357,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if self.r.v_glo.can():"
            },
            "53": {
                "beforePatchRowNumber": 358,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            accepted = True"
            },
            "54": {
                "beforePatchRowNumber": 359,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        elif self.r.v_col.can():"
            },
            "55": {
                "beforePatchRowNumber": 360,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # check if the organization is whithin a collaboration"
            },
            "56": {
                "beforePatchRowNumber": 361,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            for col in auth_org.collaborations:"
            },
            "57": {
                "beforePatchRowNumber": 362,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                if req_org in col.organizations:"
            },
            "58": {
                "beforePatchRowNumber": 363,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    accepted = True"
            },
            "59": {
                "beforePatchRowNumber": 364,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # or that the organization is auths org"
            },
            "60": {
                "beforePatchRowNumber": 365,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if req_org == auth_org:"
            },
            "61": {
                "beforePatchRowNumber": 366,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                accepted = True"
            },
            "62": {
                "beforePatchRowNumber": 367,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        elif self.r.v_org.can():"
            },
            "63": {
                "beforePatchRowNumber": 368,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            accepted = auth_org == req_org"
            },
            "64": {
                "beforePatchRowNumber": 369,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "65": {
                "beforePatchRowNumber": 370,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if accepted:"
            },
            "66": {
                "beforePatchRowNumber": 371,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return org_schema.dump(req_org, many=False).data, \\"
            },
            "67": {
                "beforePatchRowNumber": 372,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                HTTPStatus.OK"
            },
            "68": {
                "beforePatchRowNumber": 373,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        else:"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 365,
                "PatchRowcode": "+        if not self.r.can_by_org(P.VIEW, id, auth_org):"
            },
            "70": {
                "beforePatchRowNumber": 374,
                "afterPatchRowNumber": 366,
                "PatchRowcode": "             return {'msg': 'You do not have permission to do that!'}, \\"
            },
            "71": {
                "beforePatchRowNumber": 375,
                "afterPatchRowNumber": 367,
                "PatchRowcode": "                 HTTPStatus.UNAUTHORIZED"
            },
            "72": {
                "beforePatchRowNumber": 376,
                "afterPatchRowNumber": 368,
                "PatchRowcode": " "
            },
            "73": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 369,
                "PatchRowcode": "+        return org_schema.dump(req_org, many=False).data, HTTPStatus.OK"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 370,
                "PatchRowcode": "+"
            },
            "75": {
                "beforePatchRowNumber": 377,
                "afterPatchRowNumber": 371,
                "PatchRowcode": "     @only_for((\"user\", \"node\"))"
            },
            "76": {
                "beforePatchRowNumber": 378,
                "afterPatchRowNumber": 372,
                "PatchRowcode": "     def patch(self, id):"
            },
            "77": {
                "beforePatchRowNumber": 379,
                "afterPatchRowNumber": 373,
                "PatchRowcode": "         \"\"\"Update organization"
            },
            "78": {
                "beforePatchRowNumber": 387,
                "afterPatchRowNumber": 381,
                "PatchRowcode": "           |--|--|--|--|--|--|\\n"
            },
            "79": {
                "beforePatchRowNumber": 388,
                "afterPatchRowNumber": 382,
                "PatchRowcode": "           |Organization|Global|Edit|\u274c|\u274c|Update an organization with"
            },
            "80": {
                "beforePatchRowNumber": 389,
                "afterPatchRowNumber": 383,
                "PatchRowcode": "           specified id|\\n"
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 384,
                "PatchRowcode": "+          |Organization|Collaboration|Edit|\u274c|\u274c|Update an organization within"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 385,
                "PatchRowcode": "+          the collaboration the user is part of|\\n"
            },
            "83": {
                "beforePatchRowNumber": 390,
                "afterPatchRowNumber": 386,
                "PatchRowcode": "           |Organization|Organization|Edit|\u274c|\u274c|Update the organization that"
            },
            "84": {
                "beforePatchRowNumber": 391,
                "afterPatchRowNumber": 387,
                "PatchRowcode": "           the user is part of|\\n"
            },
            "85": {
                "beforePatchRowNumber": 392,
                "afterPatchRowNumber": 388,
                "PatchRowcode": " "
            },
            "86": {
                "beforePatchRowNumber": 427,
                "afterPatchRowNumber": 423,
                "PatchRowcode": "             return {\"msg\": f\"Organization with id={id} not found\"}, \\"
            },
            "87": {
                "beforePatchRowNumber": 428,
                "afterPatchRowNumber": 424,
                "PatchRowcode": "                 HTTPStatus.NOT_FOUND"
            },
            "88": {
                "beforePatchRowNumber": 429,
                "afterPatchRowNumber": 425,
                "PatchRowcode": " "
            },
            "89": {
                "beforePatchRowNumber": 430,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if not ("
            },
            "90": {
                "beforePatchRowNumber": 431,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.r.e_glo.can() or"
            },
            "91": {
                "beforePatchRowNumber": 432,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            (self.r.e_org.can() and g.user and id == g.user.organization.id) or"
            },
            "92": {
                "beforePatchRowNumber": 433,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            (self.r.e_org.can() and g.node and id == g.node.organization.id)"
            },
            "93": {
                "beforePatchRowNumber": 434,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ):"
            },
            "94": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 426,
                "PatchRowcode": "+        own_org = g.user.organization if g.user else g.node.organization"
            },
            "95": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 427,
                "PatchRowcode": "+        if not self.r.can_by_org(P.EDIT, id, own_org):"
            },
            "96": {
                "beforePatchRowNumber": 435,
                "afterPatchRowNumber": 428,
                "PatchRowcode": "             return {'msg': 'You lack the permission to do that!'}, \\"
            },
            "97": {
                "beforePatchRowNumber": 436,
                "afterPatchRowNumber": 429,
                "PatchRowcode": "                 HTTPStatus.UNAUTHORIZED"
            },
            "98": {
                "beforePatchRowNumber": 437,
                "afterPatchRowNumber": 430,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from flask import request, g",
            "from flask_restful import Api",
            "from http import HTTPStatus",
            "",
            "from vantage6.common import logger_name",
            "from vantage6.server import db",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    Operation as P,",
            "    PermissionManager",
            ")",
            "from vantage6.server.resource import (",
            "    with_user_or_node, only_for, with_user, ServicesResources",
            ")",
            "from vantage6.server.resource.common._schema import (",
            "    OrganizationSchema,",
            "    CollaborationSchema,",
            "    NodeSchema",
            ")",
            "",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the organization resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Organizations,",
            "        path,",
            "        endpoint='organization_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "     )",
            "    api.add_resource(",
            "        Organization,",
            "        path + '/<int:id>',",
            "        endpoint='organization_with_id',",
            "        methods=('GET', 'PATCH'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        OrganizationCollaboration,",
            "        path + '/<int:id>/collaboration',",
            "        endpoint='organization_collaboration',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        OrganizationNode,",
            "        path + '/<int:id>/node',",
            "        endpoint='organization_node',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "",
            "    add(scope=S.GLOBAL, operation=P.VIEW,",
            "        description=\"view any organization\")",
            "    add(scope=S.ORGANIZATION, operation=P.VIEW,",
            "        description=\"view your own organization info\",",
            "        assign_to_container=True, assign_to_node=True)",
            "    add(scope=S.COLLABORATION, operation=P.VIEW,",
            "        description='view collaborating organizations',",
            "        assign_to_container=True, assign_to_node=True)",
            "    add(scope=S.GLOBAL, operation=P.EDIT,",
            "        description=\"edit any organization\")",
            "    add(scope=S.ORGANIZATION, operation=P.EDIT,",
            "        description=\"edit your own organization info\", assign_to_node=True)",
            "    add(scope=S.GLOBAL, operation=P.CREATE,",
            "        description=\"create a new organization\")",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "org_schema = OrganizationSchema()",
            "",
            "",
            "class OrganizationBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Organizations(OrganizationBase):",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self):",
            "        \"\"\" Returns a list organizations",
            "        ---",
            "        description: >-",
            "            Get a list of organizations based on filters and user permissions\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Organization|Global|View|\u274c|\u274c|View all organizations|\\n",
            "            |Organization|Collaboration|View|\u2705|\u2705|View a list of organizations",
            "            within the scope of the collaboration|\\n",
            "            |Organization|Organization|View|\u2705|\u2705|View a 'list' of just the",
            "            organization you are part of|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: name",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: country",
            "            schema:",
            "              type: string",
            "            description: Country",
            "          - in: query",
            "            name: collaboration_id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        # Obtain the organization of the requester",
            "        auth_org = self.obtain_auth_organization()",
            "        args = request.args",
            "",
            "        # query",
            "        q = g.session.query(db.Organization)",
            "        g.session.commit()",
            "",
            "        # filter by a field of this endpoint",
            "        if 'name' in args:",
            "            q = q.filter(db.Organization.name.like(args['name']))",
            "        if 'country' in args:",
            "            q = q.filter(db.Organization.country == args['country'])",
            "        if 'collaboration_id' in args:",
            "            q = q.join(db.Member).join(db.Collaboration)\\",
            "                 .filter(db.Collaboration.id == args['collaboration_id'])",
            "",
            "        # filter the list of organizations based on the scope",
            "        if self.r.v_glo.can():",
            "            pass  # don't apply filters",
            "        elif self.r.v_col.can():",
            "            # obtain collaborations your organization participates in",
            "            collabs = g.session.query(db.Collaboration).filter(",
            "                db.Collaboration.organizations.any(id=auth_org.id)",
            "            ).all()",
            "            g.session.commit()",
            "",
            "            # list comprehension fetish, and add own organization in case",
            "            # this organization does not participate in any collaborations yet",
            "            org_ids = [o.id for col in collabs for o in col.organizations]",
            "            org_ids = list(set(org_ids + [auth_org.id]))",
            "",
            "            # select only the organizations in the collaborations",
            "            q = q.filter(db.Organization.id.in_(org_ids))",
            "",
            "        elif self.r.v_org.can():",
            "            q = q.filter(db.Organization.id == auth_org.id)",
            "        else:",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate the results",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # serialization of DB model",
            "        return self.response(page, org_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\"Create new organization",
            "        ---",
            "        description: >-",
            "          Creates a new organization from the specified values\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|Create|\u274c|\u274c|Create a new organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                $ref: '#/components/schemas/Organization'",
            "",
            "        responses:",
            "          201:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Organization with that name already exists",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        if not self.r.c_glo.can():",
            "            return {'msg': 'You lack the permissions to do that!'},\\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        name = data.get('name', '')",
            "        if db.Organization.exists(\"name\", name):",
            "            return {",
            "                \"msg\": f\"Organization with name '{name}' already exists!\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "",
            "        organization = db.Organization(",
            "            name=name,",
            "            address1=data.get('address1', ''),",
            "            address2=data.get('address2' ''),",
            "            zipcode=data.get('zipcode', ''),",
            "            country=data.get('country', ''),",
            "            public_key=data.get('public_key', ''),",
            "            domain=data.get('domain', '')",
            "        )",
            "        organization.save()",
            "",
            "        return org_schema.dump(organization, many=False).data, \\",
            "            HTTPStatus.CREATED",
            "",
            "",
            "class Organization(OrganizationBase):",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self, id):",
            "        \"\"\"Get organization",
            "        ---",
            "        description: >-",
            "          Returns the organization specified by the id\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|View|\u274c|\u274c|View all organizations|\\n",
            "          |Organization|Collaboration|View|\u2705|\u2705|View a list of organizations",
            "          within the scope of the collaboration|\\n",
            "          |Organization|Organization|View|\u2705|\u2705|View a list of organizations",
            "          that the user is part of|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        # obtain organization of authenticated",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        # retrieve requested organization",
            "        req_org = db.Organization.get(id)",
            "        if not req_org:",
            "            return {'msg': f'Organization id={id} not found!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        accepted = False",
            "        # Check if auth has enough permissions",
            "        if self.r.v_glo.can():",
            "            accepted = True",
            "        elif self.r.v_col.can():",
            "            # check if the organization is whithin a collaboration",
            "            for col in auth_org.collaborations:",
            "                if req_org in col.organizations:",
            "                    accepted = True",
            "            # or that the organization is auths org",
            "            if req_org == auth_org:",
            "                accepted = True",
            "        elif self.r.v_org.can():",
            "            accepted = auth_org == req_org",
            "",
            "        if accepted:",
            "            return org_schema.dump(req_org, many=False).data, \\",
            "                HTTPStatus.OK",
            "        else:",
            "            return {'msg': 'You do not have permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "    @only_for((\"user\", \"node\"))",
            "    def patch(self, id):",
            "        \"\"\"Update organization",
            "        ---",
            "        description: >-",
            "          Updates the organization with the specified id.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|Edit|\u274c|\u274c|Update an organization with",
            "          specified id|\\n",
            "          |Organization|Organization|Edit|\u274c|\u274c|Update the organization that",
            "          the user is part of|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                $ref: '#/components/schemas/Organization'",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Organization with that name already exists",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        organization = db.Organization.get(id)",
            "        if not organization:",
            "            return {\"msg\": f\"Organization with id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not (",
            "            self.r.e_glo.can() or",
            "            (self.r.e_org.can() and g.user and id == g.user.organization.id) or",
            "            (self.r.e_org.can() and g.node and id == g.node.organization.id)",
            "        ):",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        name = data.get('name', None)",
            "        if name:",
            "            if organization.name != name and \\",
            "                    db.Organization.exists(\"name\", name):",
            "                return {",
            "                    \"msg\": f\"Organization with name '{name}' already exists!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            organization.name = name",
            "",
            "        fields = [\"address1\", \"address2\", \"zipcode\", \"country\",",
            "                  \"public_key\", \"domain\"]",
            "        for field in fields:",
            "            if field in data and data[field] is not None:",
            "                setattr(organization, field, data[field])",
            "",
            "        organization.save()",
            "        return org_schema.dump(organization, many=False).data, \\",
            "            HTTPStatus.OK",
            "",
            "",
            "class OrganizationCollaboration(ServicesResources):",
            "    \"\"\"Collaborations for a specific organization.\"\"\"",
            "",
            "    col_schema = CollaborationSchema()",
            "",
            "    @only_for((\"user\", \"node\"))",
            "    def get(self, id):",
            "        \"\"\"Get collaborations from organization",
            "        ---",
            "        description: >-",
            "          Returns a list of collaborations in which the organization is a",
            "          participant of.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|View all collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|View a list of collaborations",
            "          that the organization is a part of|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "        organization = db.Organization.get(id)",
            "        if not organization:",
            "            return {\"msg\": f\"organization id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if g.node:",
            "            auth_org_id = g.node.organization.id",
            "        else:  # g.user:",
            "            auth_org_id = g.user.organization.id",
            "",
            "        if not self.permissions.collaboration.v_glo.can():",
            "            if not (self.permissions.collaboration.v_org.can() and",
            "                    auth_org_id == id):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return self.col_schema.dump(",
            "            organization.collaborations,",
            "            many=True",
            "        ).data, HTTPStatus.OK",
            "",
            "",
            "class OrganizationNode(ServicesResources):",
            "    \"\"\"Resource for /api/organization/<int:id>/node.\"\"\"",
            "",
            "    nod_schema = NodeSchema()",
            "",
            "    @with_user_or_node",
            "    def get(self, id):",
            "        \"\"\"Return a list of nodes.",
            "        ---",
            "        description: >-",
            "          Returns a list of nodes which are from the organization.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|View|\u274c|\u274c|View any node|\\n",
            "          |Organization|Organization|View|\u2705|\u2705|View a list of nodes that",
            "          belong to your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "        organization = db.Organization.get(id)",
            "        if not organization:",
            "            return {\"msg\": f\"organization id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if g.user:",
            "            auth_org_id = g.user.organization.id",
            "        else:  # g.node",
            "            auth_org_id = g.node.organization.id",
            "",
            "        if not self.permissions.node.v_glo.can():",
            "            if not (self.permissions.node.v_org.can() and id == auth_org_id):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return self.nod_schema.dump(organization.nodes, many=True).data, \\",
            "            HTTPStatus.OK"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from flask import request, g",
            "from flask_restful import Api",
            "from http import HTTPStatus",
            "",
            "from vantage6.common import logger_name",
            "from vantage6.server import db",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    Operation as P,",
            "    PermissionManager,",
            "    RuleCollection",
            ")",
            "from vantage6.server.resource import (",
            "    with_user_or_node, only_for, with_user, ServicesResources",
            ")",
            "from vantage6.server.resource.common._schema import (",
            "    OrganizationSchema,",
            "    CollaborationSchema,",
            "    NodeSchema",
            ")",
            "",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the organization resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Organizations,",
            "        path,",
            "        endpoint='organization_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "     )",
            "    api.add_resource(",
            "        Organization,",
            "        path + '/<int:id>',",
            "        endpoint='organization_with_id',",
            "        methods=('GET', 'PATCH'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        OrganizationCollaboration,",
            "        path + '/<int:id>/collaboration',",
            "        endpoint='organization_collaboration',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        OrganizationNode,",
            "        path + '/<int:id>/node',",
            "        endpoint='organization_node',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "",
            "    add(scope=S.GLOBAL, operation=P.VIEW,",
            "        description=\"view any organization\")",
            "    add(scope=S.ORGANIZATION, operation=P.VIEW,",
            "        description=\"view your own organization info\",",
            "        assign_to_container=True, assign_to_node=True)",
            "    add(scope=S.COLLABORATION, operation=P.VIEW,",
            "        description='view collaborating organizations',",
            "        assign_to_container=True, assign_to_node=True)",
            "    add(scope=S.GLOBAL, operation=P.EDIT,",
            "        description=\"edit any organization\")",
            "    add(scope=S.ORGANIZATION, operation=P.EDIT,",
            "        description=\"edit your own organization info\", assign_to_node=True)",
            "    add(scope=S.COLLABORATION, operation=P.EDIT,",
            "        description='edit collaborating organizations')",
            "    add(scope=S.GLOBAL, operation=P.CREATE,",
            "        description=\"create a new organization\")",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "org_schema = OrganizationSchema()",
            "",
            "",
            "class OrganizationBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r: RuleCollection = getattr(self.permissions, module_name)",
            "",
            "",
            "class Organizations(OrganizationBase):",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self):",
            "        \"\"\" Returns a list organizations",
            "        ---",
            "        description: >-",
            "            Get a list of organizations based on filters and user permissions\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Organization|Global|View|\u274c|\u274c|View all organizations|\\n",
            "            |Organization|Collaboration|View|\u2705|\u2705|View a list of organizations",
            "            within the scope of the collaboration|\\n",
            "            |Organization|Organization|View|\u2705|\u2705|View a 'list' of just the",
            "            organization you are part of|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: name",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: country",
            "            schema:",
            "              type: string",
            "            description: Country",
            "          - in: query",
            "            name: collaboration_id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        # Obtain the organization of the requester",
            "        auth_org = self.obtain_auth_organization()",
            "        args = request.args",
            "",
            "        # query",
            "        q = g.session.query(db.Organization)",
            "        g.session.commit()",
            "",
            "        # filter by a field of this endpoint",
            "        if 'name' in args:",
            "            q = q.filter(db.Organization.name.like(args['name']))",
            "        if 'country' in args:",
            "            q = q.filter(db.Organization.country == args['country'])",
            "        if 'collaboration_id' in args:",
            "            if not self.r.has_minimal_scope(P.VIEW, S.COLLABORATION):",
            "                return {",
            "                    'msg': 'You lack the permission to get all organizations '",
            "                    'in your collaboration!'",
            "                }, HTTPStatus.UNAUTHORIZED",
            "            q = q.join(db.Member).join(db.Collaboration)\\",
            "                 .filter(db.Collaboration.id == args['collaboration_id'])",
            "",
            "        # filter the list of organizations based on the scope",
            "        if self.r.v_glo.can():",
            "            pass  # don't apply filters",
            "        elif self.r.v_col.can():",
            "            # obtain collaborations your organization participates in",
            "            collabs = g.session.query(db.Collaboration).filter(",
            "                db.Collaboration.organizations.any(id=auth_org.id)",
            "            ).all()",
            "            g.session.commit()",
            "",
            "            # filter orgs in own collaborations, and add own organization in",
            "            # case this organization does not participate in any collaborations",
            "            # yet",
            "            org_ids = [o.id for col in collabs for o in col.organizations]",
            "            org_ids = list(set(org_ids + [auth_org.id]))",
            "",
            "            # select only the organizations in the collaborations",
            "            q = q.filter(db.Organization.id.in_(org_ids))",
            "",
            "        elif self.r.v_org.can():",
            "            q = q.filter(db.Organization.id == auth_org.id)",
            "        else:",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate the results",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # serialization of DB model",
            "        return self.response(page, org_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\"Create new organization",
            "        ---",
            "        description: >-",
            "          Creates a new organization from the specified values\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|Create|\u274c|\u274c|Create a new organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                $ref: '#/components/schemas/Organization'",
            "",
            "        responses:",
            "          201:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Organization with that name already exists",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        if not self.r.c_glo.can():",
            "            return {'msg': 'You lack the permissions to do that!'},\\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        name = data.get('name', '')",
            "        if db.Organization.exists(\"name\", name):",
            "            return {",
            "                \"msg\": f\"Organization with name '{name}' already exists!\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "",
            "        organization = db.Organization(",
            "            name=name,",
            "            address1=data.get('address1', ''),",
            "            address2=data.get('address2' ''),",
            "            zipcode=data.get('zipcode', ''),",
            "            country=data.get('country', ''),",
            "            public_key=data.get('public_key', ''),",
            "            domain=data.get('domain', '')",
            "        )",
            "        organization.save()",
            "",
            "        return org_schema.dump(organization, many=False).data, \\",
            "            HTTPStatus.CREATED",
            "",
            "",
            "class Organization(OrganizationBase):",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self, id):",
            "        \"\"\"Get organization",
            "        ---",
            "        description: >-",
            "          Returns the organization specified by the id\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|View|\u274c|\u274c|View all organizations|\\n",
            "          |Organization|Collaboration|View|\u2705|\u2705|View a list of organizations",
            "          within the scope of the collaboration|\\n",
            "          |Organization|Organization|View|\u2705|\u2705|View a list of organizations",
            "          that the user is part of|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        # obtain organization of authenticated",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        # retrieve requested organization",
            "        req_org = db.Organization.get(id)",
            "        if not req_org:",
            "            return {'msg': f'Organization id={id} not found!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # Check if auth has enough permissions",
            "        if not self.r.can_by_org(P.VIEW, id, auth_org):",
            "            return {'msg': 'You do not have permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        return org_schema.dump(req_org, many=False).data, HTTPStatus.OK",
            "",
            "    @only_for((\"user\", \"node\"))",
            "    def patch(self, id):",
            "        \"\"\"Update organization",
            "        ---",
            "        description: >-",
            "          Updates the organization with the specified id.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|Edit|\u274c|\u274c|Update an organization with",
            "          specified id|\\n",
            "          |Organization|Collaboration|Edit|\u274c|\u274c|Update an organization within",
            "          the collaboration the user is part of|\\n",
            "          |Organization|Organization|Edit|\u274c|\u274c|Update the organization that",
            "          the user is part of|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                $ref: '#/components/schemas/Organization'",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Organization with that name already exists",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "",
            "        organization = db.Organization.get(id)",
            "        if not organization:",
            "            return {\"msg\": f\"Organization with id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        own_org = g.user.organization if g.user else g.node.organization",
            "        if not self.r.can_by_org(P.EDIT, id, own_org):",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        name = data.get('name', None)",
            "        if name:",
            "            if organization.name != name and \\",
            "                    db.Organization.exists(\"name\", name):",
            "                return {",
            "                    \"msg\": f\"Organization with name '{name}' already exists!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            organization.name = name",
            "",
            "        fields = [\"address1\", \"address2\", \"zipcode\", \"country\",",
            "                  \"public_key\", \"domain\"]",
            "        for field in fields:",
            "            if field in data and data[field] is not None:",
            "                setattr(organization, field, data[field])",
            "",
            "        organization.save()",
            "        return org_schema.dump(organization, many=False).data, \\",
            "            HTTPStatus.OK",
            "",
            "",
            "class OrganizationCollaboration(ServicesResources):",
            "    \"\"\"Collaborations for a specific organization.\"\"\"",
            "",
            "    col_schema = CollaborationSchema()",
            "",
            "    @only_for((\"user\", \"node\"))",
            "    def get(self, id):",
            "        \"\"\"Get collaborations from organization",
            "        ---",
            "        description: >-",
            "          Returns a list of collaborations in which the organization is a",
            "          participant of.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|View all collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|View a list of collaborations",
            "          that the organization is a part of|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "        organization = db.Organization.get(id)",
            "        if not organization:",
            "            return {\"msg\": f\"organization id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if g.node:",
            "            auth_org_id = g.node.organization.id",
            "        else:  # g.user:",
            "            auth_org_id = g.user.organization.id",
            "",
            "        if not self.permissions.collaboration.v_glo.can():",
            "            if not (self.permissions.collaboration.v_org.can() and",
            "                    auth_org_id == id):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return self.col_schema.dump(",
            "            organization.collaborations,",
            "            many=True",
            "        ).data, HTTPStatus.OK",
            "",
            "",
            "class OrganizationNode(ServicesResources):",
            "    \"\"\"Resource for /api/organization/<int:id>/node.\"\"\"",
            "",
            "    nod_schema = NodeSchema()",
            "",
            "    @with_user_or_node",
            "    def get(self, id):",
            "        \"\"\"Return a list of nodes.",
            "        ---",
            "        description: >-",
            "          Returns a list of nodes which are from the organization.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Organization|Global|View|\u274c|\u274c|View any node|\\n",
            "          |Organization|Organization|View|\u2705|\u2705|View a list of nodes that",
            "          belong to your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Organization not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Organization\"]",
            "        \"\"\"",
            "        organization = db.Organization.get(id)",
            "        if not organization:",
            "            return {\"msg\": f\"organization id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if g.user:",
            "            auth_org_id = g.user.organization.id",
            "        else:  # g.node",
            "            auth_org_id = g.node.organization.id",
            "",
            "        if not self.permissions.node.v_glo.can():",
            "            if not (self.permissions.node.v_org.can() and id == auth_org_id):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return self.nod_schema.dump(organization.nodes, many=True).data, \\",
            "            HTTPStatus.OK"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "14": [],
            "116": [
                "OrganizationBase",
                "__init__"
            ],
            "219": [
                "Organizations",
                "get"
            ],
            "220": [
                "Organizations",
                "get"
            ],
            "355": [
                "Organization",
                "get"
            ],
            "357": [
                "Organization",
                "get"
            ],
            "358": [
                "Organization",
                "get"
            ],
            "359": [
                "Organization",
                "get"
            ],
            "360": [
                "Organization",
                "get"
            ],
            "361": [
                "Organization",
                "get"
            ],
            "362": [
                "Organization",
                "get"
            ],
            "363": [
                "Organization",
                "get"
            ],
            "364": [
                "Organization",
                "get"
            ],
            "365": [
                "Organization",
                "get"
            ],
            "366": [
                "Organization",
                "get"
            ],
            "367": [
                "Organization",
                "get"
            ],
            "368": [
                "Organization",
                "get"
            ],
            "369": [
                "Organization",
                "get"
            ],
            "370": [
                "Organization",
                "get"
            ],
            "371": [
                "Organization",
                "get"
            ],
            "372": [
                "Organization",
                "get"
            ],
            "373": [
                "Organization",
                "get"
            ],
            "430": [
                "Organization",
                "patch"
            ],
            "431": [
                "Organization",
                "patch"
            ],
            "432": [
                "Organization",
                "patch"
            ],
            "433": [
                "Organization",
                "patch"
            ],
            "434": [
                "Organization",
                "patch"
            ]
        },
        "addLocation": []
    },
    "vantage6-server/vantage6/server/resource/rule.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 160,
                "PatchRowcode": "                     db.UserPermission.c.user_id == args['user_id']"
            },
            "1": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 161,
                "PatchRowcode": "                  ))"
            },
            "2": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": 162,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # check if pagination is disabled"
            },
            "4": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        paginate = True"
            },
            "5": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if 'no_pagination' in args and args['no_pagination'] == '1':"
            },
            "6": {
                "beforePatchRowNumber": 166,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            paginate = False"
            },
            "7": {
                "beforePatchRowNumber": 167,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "8": {
                "beforePatchRowNumber": 168,
                "afterPatchRowNumber": 163,
                "PatchRowcode": "         # paginate results"
            },
            "9": {
                "beforePatchRowNumber": 169,
                "afterPatchRowNumber": 164,
                "PatchRowcode": "         try:"
            },
            "10": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            page = Pagination.from_query(q, request, paginate=paginate)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+            page = Pagination.from_query(q, request)"
            },
            "12": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "         except ValueError as e:"
            },
            "13": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "             return {'msg': str(e)}, HTTPStatus.BAD_REQUEST"
            },
            "14": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": 168,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from http import HTTPStatus",
            "from flask.globals import request",
            "from flask import g",
            "from flask_restful import Api",
            "from sqlalchemy import or_",
            "",
            "from vantage6.server.resource import (",
            "    with_user,",
            "    ServicesResources",
            ")",
            "from vantage6.common import logger_name",
            "from vantage6.server import db",
            "from vantage6.server.resource.common._schema import RuleSchema",
            "from vantage6.server.resource.common.pagination import Pagination",
            "",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "rule_schema = RuleSchema()",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the rule resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Rules,",
            "        path,",
            "        endpoint='rule_without_id',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Rule,",
            "        path + '/<int:id>',",
            "        endpoint='rule_with_id',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "class Rules(ServicesResources):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"List Rules",
            "        ---",
            "        description: >-",
            "            List of all available rules at the server. The user must be",
            "            authenticated, but does not require any additional permissions to",
            "            view the rules.\\n",
            "",
            "            Accesible to users.",
            "",
            "        parameters:",
            "            - in: query",
            "              name: name",
            "              schema:",
            "                type: string",
            "              description: Filter by name of the rule",
            "            - in: query",
            "              name: operation",
            "              schema:",
            "                type: string",
            "              description: Get rules for a specific type of operation",
            "            - in: query",
            "              name: scope",
            "              schema:",
            "                type: string",
            "              description: Get rules for a specific scope",
            "            - in: query",
            "              name: role_id",
            "              schema:",
            "                type: integer",
            "              description: Get rules for a specific role",
            "            - in: query",
            "              name: user_id",
            "              schema:",
            "                type: integer",
            "              description: Get rules for a specific user. This includes the",
            "                rules that are part of the user's roles.",
            "            - in: query",
            "              name: page",
            "              schema:",
            "                type: integer",
            "              description: Page number for pagination (default=1)",
            "            - in: query",
            "              name: per_page",
            "              schema:",
            "                type: integer",
            "              description: Number of items per page (default=10)",
            "            - in: query",
            "              name: sort",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Sort by one or more fields, separated by a comma. Use a minus",
            "                sign (-) in front of the field to sort in descending order.",
            "            - in: query",
            "              name: no_pagination",
            "              schema:",
            "                type: int",
            "              description: >-",
            "                If set to 1, pagination is disabled and all items are returned.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Rule\"]",
            "        \"\"\"",
            "        q = g.session.query(db.Rule)",
            "",
            "        args = request.args",
            "",
            "        # filter by any field of this endpoint",
            "        for param in ['name', 'operation', 'scope']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.Rule, param) == args[param])",
            "",
            "        # find roles containing a specific rule",
            "        if 'role_id' in args:",
            "            q = q.join(db.role_rule_association).join(db.Role)\\",
            "                 .filter(db.Role.id == args['role_id'])",
            "",
            "        # find all rules of a specific user. This is done by first joining all",
            "        # tables to find all rules originating from a user's roles. Then, we",
            "        # do an outer join to find all rules that are directly assigned to the",
            "        # user.",
            "        if 'user_id' in args:",
            "            q = q.join(db.role_rule_association).join(db.Role)\\",
            "                 .join(db.Permission).join(db.User)\\",
            "                 .outerjoin(db.UserPermission,",
            "                            db.Rule.id == db.UserPermission.c.rule_id)\\",
            "                 .filter(or_(",
            "                    db.User.id == args['user_id'],",
            "                    db.UserPermission.c.user_id == args['user_id']",
            "                 ))",
            "",
            "        # check if pagination is disabled",
            "        paginate = True",
            "        if 'no_pagination' in args and args['no_pagination'] == '1':",
            "            paginate = False",
            "",
            "        # paginate results",
            "        try:",
            "            page = Pagination.from_query(q, request, paginate=paginate)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # model serialization",
            "        return self.response(page, rule_schema)",
            "",
            "",
            "class Rule(ServicesResources):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Returns a specific rule",
            "        ---",
            "        description: >-",
            "            Get a rule by it's id. The user must be authenticated, but does",
            "            not require any additional permissions to view rules.\\n",
            "",
            "            Accesible to users.",
            "",
            "        parameters:",
            "        - in: path",
            "          name: id",
            "          schema:",
            "              type: integer",
            "          minimum: 1",
            "          description: rule_id",
            "          required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Rule not found",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Rule\"]",
            "        \"\"\"",
            "        rule = db.Rule.get(id)",
            "        if not rule:",
            "            return {'msg': f'Rule id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "",
            "        return rule_schema.dump(rule, many=False).data, HTTPStatus.OK"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from http import HTTPStatus",
            "from flask.globals import request",
            "from flask import g",
            "from flask_restful import Api",
            "from sqlalchemy import or_",
            "",
            "from vantage6.server.resource import (",
            "    with_user,",
            "    ServicesResources",
            ")",
            "from vantage6.common import logger_name",
            "from vantage6.server import db",
            "from vantage6.server.resource.common._schema import RuleSchema",
            "from vantage6.server.resource.common.pagination import Pagination",
            "",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "rule_schema = RuleSchema()",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the rule resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Rules,",
            "        path,",
            "        endpoint='rule_without_id',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Rule,",
            "        path + '/<int:id>',",
            "        endpoint='rule_with_id',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "class Rules(ServicesResources):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"List Rules",
            "        ---",
            "        description: >-",
            "            List of all available rules at the server. The user must be",
            "            authenticated, but does not require any additional permissions to",
            "            view the rules.\\n",
            "",
            "            Accesible to users.",
            "",
            "        parameters:",
            "            - in: query",
            "              name: name",
            "              schema:",
            "                type: string",
            "              description: Filter by name of the rule",
            "            - in: query",
            "              name: operation",
            "              schema:",
            "                type: string",
            "              description: Get rules for a specific type of operation",
            "            - in: query",
            "              name: scope",
            "              schema:",
            "                type: string",
            "              description: Get rules for a specific scope",
            "            - in: query",
            "              name: role_id",
            "              schema:",
            "                type: integer",
            "              description: Get rules for a specific role",
            "            - in: query",
            "              name: user_id",
            "              schema:",
            "                type: integer",
            "              description: Get rules for a specific user. This includes the",
            "                rules that are part of the user's roles.",
            "            - in: query",
            "              name: page",
            "              schema:",
            "                type: integer",
            "              description: Page number for pagination (default=1)",
            "            - in: query",
            "              name: per_page",
            "              schema:",
            "                type: integer",
            "              description: Number of items per page (default=10)",
            "            - in: query",
            "              name: sort",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Sort by one or more fields, separated by a comma. Use a minus",
            "                sign (-) in front of the field to sort in descending order.",
            "            - in: query",
            "              name: no_pagination",
            "              schema:",
            "                type: int",
            "              description: >-",
            "                If set to 1, pagination is disabled and all items are returned.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Rule\"]",
            "        \"\"\"",
            "        q = g.session.query(db.Rule)",
            "",
            "        args = request.args",
            "",
            "        # filter by any field of this endpoint",
            "        for param in ['name', 'operation', 'scope']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.Rule, param) == args[param])",
            "",
            "        # find roles containing a specific rule",
            "        if 'role_id' in args:",
            "            q = q.join(db.role_rule_association).join(db.Role)\\",
            "                 .filter(db.Role.id == args['role_id'])",
            "",
            "        # find all rules of a specific user. This is done by first joining all",
            "        # tables to find all rules originating from a user's roles. Then, we",
            "        # do an outer join to find all rules that are directly assigned to the",
            "        # user.",
            "        if 'user_id' in args:",
            "            q = q.join(db.role_rule_association).join(db.Role)\\",
            "                 .join(db.Permission).join(db.User)\\",
            "                 .outerjoin(db.UserPermission,",
            "                            db.Rule.id == db.UserPermission.c.rule_id)\\",
            "                 .filter(or_(",
            "                    db.User.id == args['user_id'],",
            "                    db.UserPermission.c.user_id == args['user_id']",
            "                 ))",
            "",
            "        # paginate results",
            "        try:",
            "            page = Pagination.from_query(q, request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # model serialization",
            "        return self.response(page, rule_schema)",
            "",
            "",
            "class Rule(ServicesResources):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Returns a specific rule",
            "        ---",
            "        description: >-",
            "            Get a rule by it's id. The user must be authenticated, but does",
            "            not require any additional permissions to view rules.\\n",
            "",
            "            Accesible to users.",
            "",
            "        parameters:",
            "        - in: path",
            "          name: id",
            "          schema:",
            "              type: integer",
            "          minimum: 1",
            "          description: rule_id",
            "          required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Rule not found",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Rule\"]",
            "        \"\"\"",
            "        rule = db.Rule.get(id)",
            "        if not rule:",
            "            return {'msg': f'Rule id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "",
            "        return rule_schema.dump(rule, many=False).data, HTTPStatus.OK"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "163": [
                "Rules",
                "get"
            ],
            "164": [
                "Rules",
                "get"
            ],
            "165": [
                "Rules",
                "get"
            ],
            "166": [
                "Rules",
                "get"
            ],
            "167": [
                "Rules",
                "get"
            ],
            "170": [
                "Rules",
                "get"
            ]
        },
        "addLocation": []
    }
}