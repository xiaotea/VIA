{
    "Products/CMFPlone/URLTool.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "         \"\"\""
            },
            "1": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 31,
                "PatchRowcode": "         # sanitize url"
            },
            "2": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 32,
                "PatchRowcode": "         url = re.sub('^[\\x00-\\x20]+', '', url).strip()"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+        if ('<script' in url or '%3Cscript' in url or 'javascript:' in url or"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+                'javascript%3A' in url):"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+            return False"
            },
            "6": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "         p_url = self()"
            },
            "8": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "from Products.CMFCore.URLTool import URLTool as BaseTool",
            "from Products.CMFCore.utils import getToolByName",
            "from AccessControl import ClassSecurityInfo",
            "from App.class_init import InitializeClass",
            "from Products.CMFPlone.PloneBaseTool import PloneBaseTool",
            "",
            "from posixpath import normpath",
            "from urlparse import urlparse, urljoin",
            "import re",
            "",
            "",
            "class URLTool(PloneBaseTool, BaseTool):",
            "",
            "    meta_type = 'Plone URL Tool'",
            "    security = ClassSecurityInfo()",
            "    toolicon = 'skins/plone_images/link_icon.png'",
            "",
            "    security.declarePublic('isURLInPortal')",
            "    def isURLInPortal(self, url, context=None):",
            "        \"\"\" Check if a given url is on the same host and contains the portal",
            "            path.  Used to ensure that login forms can determine relevant",
            "            referrers (i.e. in portal).  Also return true for some relative",
            "            urls if context is passed in to allow for url parsing. When context",
            "            is not provided, assume that relative urls are in the portal. It is",
            "            assumed that http://portal is the same portal as https://portal.",
            "",
            "            External sites listed in 'allow_external_login_sites' of",
            "            site_properties are also considered within the portal to allow for",
            "            single sign on.",
            "        \"\"\"",
            "        # sanitize url",
            "        url = re.sub('^[\\x00-\\x20]+', '', url).strip()",
            "",
            "        p_url = self()",
            "",
            "        _, u_host, u_path, _, _, _ = urlparse(url)",
            "        if not u_host and not u_path.startswith('/'):",
            "            if context is None:",
            "                return True  # old behavior",
            "            if not context.isPrincipiaFolderish:",
            "                useurl = context.aq_parent.absolute_url()",
            "            else:",
            "                useurl = context.absolute_url()",
            "        else:",
            "            useurl = p_url  # when u_path.startswith('/')",
            "        if not useurl.endswith('/'):",
            "            useurl += '/'",
            "",
            "        # urljoin to current url to get an absolute path",
            "        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))",
            "",
            "        # normalise to end with a '/' so /foobar is not considered within /foo",
            "        if not u_path:",
            "            u_path = '/'",
            "        else:",
            "            u_path = normpath(u_path)",
            "            if not u_path.endswith('/'):",
            "                u_path += '/'",
            "        _, host, path, _, _, _ = urlparse(p_url)",
            "        if not path.endswith('/'):",
            "            path += '/'",
            "        if host == u_host and u_path.startswith(path):",
            "            return True",
            "",
            "        props = getToolByName(self, 'portal_properties').site_properties",
            "        for external_site in props.getProperty('allow_external_login_sites', []):",
            "            _, host, path, _, _, _ = urlparse(external_site)",
            "            if not path.endswith('/'):",
            "                path += '/'",
            "            if host == u_host and u_path.startswith(path):",
            "                return True",
            "        return False",
            "",
            "",
            "URLTool.__doc__ = BaseTool.__doc__",
            "",
            "InitializeClass(URLTool)"
        ],
        "afterPatchFile": [
            "from Products.CMFCore.URLTool import URLTool as BaseTool",
            "from Products.CMFCore.utils import getToolByName",
            "from AccessControl import ClassSecurityInfo",
            "from App.class_init import InitializeClass",
            "from Products.CMFPlone.PloneBaseTool import PloneBaseTool",
            "",
            "from posixpath import normpath",
            "from urlparse import urlparse, urljoin",
            "import re",
            "",
            "",
            "class URLTool(PloneBaseTool, BaseTool):",
            "",
            "    meta_type = 'Plone URL Tool'",
            "    security = ClassSecurityInfo()",
            "    toolicon = 'skins/plone_images/link_icon.png'",
            "",
            "    security.declarePublic('isURLInPortal')",
            "    def isURLInPortal(self, url, context=None):",
            "        \"\"\" Check if a given url is on the same host and contains the portal",
            "            path.  Used to ensure that login forms can determine relevant",
            "            referrers (i.e. in portal).  Also return true for some relative",
            "            urls if context is passed in to allow for url parsing. When context",
            "            is not provided, assume that relative urls are in the portal. It is",
            "            assumed that http://portal is the same portal as https://portal.",
            "",
            "            External sites listed in 'allow_external_login_sites' of",
            "            site_properties are also considered within the portal to allow for",
            "            single sign on.",
            "        \"\"\"",
            "        # sanitize url",
            "        url = re.sub('^[\\x00-\\x20]+', '', url).strip()",
            "        if ('<script' in url or '%3Cscript' in url or 'javascript:' in url or",
            "                'javascript%3A' in url):",
            "            return False",
            "",
            "        p_url = self()",
            "",
            "        _, u_host, u_path, _, _, _ = urlparse(url)",
            "        if not u_host and not u_path.startswith('/'):",
            "            if context is None:",
            "                return True  # old behavior",
            "            if not context.isPrincipiaFolderish:",
            "                useurl = context.aq_parent.absolute_url()",
            "            else:",
            "                useurl = context.absolute_url()",
            "        else:",
            "            useurl = p_url  # when u_path.startswith('/')",
            "        if not useurl.endswith('/'):",
            "            useurl += '/'",
            "",
            "        # urljoin to current url to get an absolute path",
            "        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))",
            "",
            "        # normalise to end with a '/' so /foobar is not considered within /foo",
            "        if not u_path:",
            "            u_path = '/'",
            "        else:",
            "            u_path = normpath(u_path)",
            "            if not u_path.endswith('/'):",
            "                u_path += '/'",
            "        _, host, path, _, _, _ = urlparse(p_url)",
            "        if not path.endswith('/'):",
            "            path += '/'",
            "        if host == u_host and u_path.startswith(path):",
            "            return True",
            "",
            "        props = getToolByName(self, 'portal_properties').site_properties",
            "        for external_site in props.getProperty('allow_external_login_sites', []):",
            "            _, host, path, _, _, _ = urlparse(external_site)",
            "            if not path.endswith('/'):",
            "                path += '/'",
            "            if host == u_host and u_path.startswith(path):",
            "                return True",
            "        return False",
            "",
            "",
            "URLTool.__doc__ = BaseTool.__doc__",
            "",
            "InitializeClass(URLTool)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "html5lib.serializer.htmlserializer.HTMLSerializer.serialize"
        ]
    },
    "Products/CMFPlone/tests/testURLTool.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "         self.assertFalse(iURLiP('http://external4/other'))"
            },
            "1": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "         self.assertFalse(iURLiP('http://external5'))"
            },
            "2": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "         self.assertFalse(iURLiP('http://external11'))"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+    def test_script_tag_url_not_in_portal(self):"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+        self.assertFalse(iURLiP('<script>alert(\"hi\");</script>'))"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+        self.assertFalse("
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+            iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+    def test_inline_url_not_in_portal(self):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+        self.assertFalse(iURLiP('javascript%3Aalert(3)'))"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+        self.assertFalse(iURLiP('javascript:alert(3)'))"
            }
        },
        "frontPatchFile": [
            "import unittest",
            "",
            "from Products.CMFCore.tests.base.dummy import DummySite",
            "from Products.CMFCore.tests.base.dummy import DummyFolder",
            "from Products.CMFCore.tests.base.dummy import DummyContent",
            "",
            "from Acquisition import aq_parent",
            "",
            "",
            "class DummyFolder(DummyFolder):",
            "    def absolute_url(self):",
            "        return '/'.join([aq_parent(self).absolute_url(), self.getId()])",
            "",
            "",
            "class DummyProperties(DummyContent):",
            "",
            "    _allow_external_login_sites = [",
            "        'http://external1',",
            "        'http://external2/',",
            "        'http://external3/site',",
            "        'http://external4/site/'",
            "        ]",
            "",
            "    def getProperty(self, name, default=None):",
            "        if name == 'allow_external_login_sites':",
            "            return self._allow_external_login_sites",
            "        return default",
            "",
            "",
            "class TestURLTool(unittest.TestCase):",
            "",
            "    def setUp(self):",
            "        self.site = DummySite(id='foo')",
            "        self.site._setObject('foo', DummyFolder(id='foo'))",
            "        self.site.foo._setObject('doc1', DummyContent(id='doc1'))",
            "        self.site.portal_properties = DummyProperties(id='portal_properties')",
            "        self.site.portal_properties.site_properties = \\",
            "            DummyProperties(id='site_properties')",
            "",
            "    def _makeOne(self, *args, **kw):",
            "        from Products.CMFPlone.URLTool import URLTool",
            "        url_tool = URLTool(*args, **kw)",
            "        return url_tool.__of__(self.site)",
            "",
            "    def test_isURLInPortal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))",
            "        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar'))",
            "        self.assertFalse(iURLiP('/images'))",
            "        self.assertTrue(iURLiP('/bar/foo/foo'))",
            "",
            "    def test_isURLInPortalRelative(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "",
            "        #non-root relative urls will need a current context to be passed in",
            "        self.assertTrue(iURLiP('images/img1.jpg'))",
            "        self.assertTrue(iURLiP('./images/img1.jpg'))",
            "",
            "        # /bar/foo/something",
            "        self.assertTrue(iURLiP('../something', self.site.foo.doc1))",
            "        # /bar/afolder",
            "        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))",
            "        # /afolder",
            "        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))",
            "",
            "        # /../afolder? How do we have more ../'s than there are parts in",
            "        # the URL?",
            "        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))",
            "",
            "        # /bar/foo/afolder",
            "        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))",
            "",
            "    def test_isURLInPortalExternal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://external1'))",
            "        self.assertTrue(iURLiP('http://external1/'))",
            "        self.assertTrue(iURLiP('http://external1/something'))",
            "        self.assertTrue(iURLiP('http://external2'))",
            "        self.assertTrue(iURLiP('http://external2/'))",
            "        self.assertTrue(iURLiP('http://external2/something'))",
            "        self.assertTrue(iURLiP('http://external3/site'))",
            "        self.assertTrue(iURLiP('http://external3/site/'))",
            "        self.assertTrue(iURLiP('http://external3/site/something'))",
            "        self.assertTrue(iURLiP('http://external4/site'))",
            "        self.assertTrue(iURLiP('http://external4/site/'))",
            "        self.assertTrue(iURLiP('http://external4/site/something'))",
            "",
            "        self.assertFalse(iURLiP('http://external3/other'))",
            "        self.assertFalse(iURLiP('http://external4/other'))",
            "        self.assertFalse(iURLiP('http://external5'))",
            "        self.assertFalse(iURLiP('http://external11'))"
        ],
        "afterPatchFile": [
            "import unittest",
            "",
            "from Products.CMFCore.tests.base.dummy import DummySite",
            "from Products.CMFCore.tests.base.dummy import DummyFolder",
            "from Products.CMFCore.tests.base.dummy import DummyContent",
            "",
            "from Acquisition import aq_parent",
            "",
            "",
            "class DummyFolder(DummyFolder):",
            "    def absolute_url(self):",
            "        return '/'.join([aq_parent(self).absolute_url(), self.getId()])",
            "",
            "",
            "class DummyProperties(DummyContent):",
            "",
            "    _allow_external_login_sites = [",
            "        'http://external1',",
            "        'http://external2/',",
            "        'http://external3/site',",
            "        'http://external4/site/'",
            "        ]",
            "",
            "    def getProperty(self, name, default=None):",
            "        if name == 'allow_external_login_sites':",
            "            return self._allow_external_login_sites",
            "        return default",
            "",
            "",
            "class TestURLTool(unittest.TestCase):",
            "",
            "    def setUp(self):",
            "        self.site = DummySite(id='foo')",
            "        self.site._setObject('foo', DummyFolder(id='foo'))",
            "        self.site.foo._setObject('doc1', DummyContent(id='doc1'))",
            "        self.site.portal_properties = DummyProperties(id='portal_properties')",
            "        self.site.portal_properties.site_properties = \\",
            "            DummyProperties(id='site_properties')",
            "",
            "    def _makeOne(self, *args, **kw):",
            "        from Products.CMFPlone.URLTool import URLTool",
            "        url_tool = URLTool(*args, **kw)",
            "        return url_tool.__of__(self.site)",
            "",
            "    def test_isURLInPortal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))",
            "        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar'))",
            "        self.assertFalse(iURLiP('/images'))",
            "        self.assertTrue(iURLiP('/bar/foo/foo'))",
            "",
            "    def test_isURLInPortalRelative(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "",
            "        #non-root relative urls will need a current context to be passed in",
            "        self.assertTrue(iURLiP('images/img1.jpg'))",
            "        self.assertTrue(iURLiP('./images/img1.jpg'))",
            "",
            "        # /bar/foo/something",
            "        self.assertTrue(iURLiP('../something', self.site.foo.doc1))",
            "        # /bar/afolder",
            "        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))",
            "        # /afolder",
            "        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))",
            "",
            "        # /../afolder? How do we have more ../'s than there are parts in",
            "        # the URL?",
            "        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))",
            "",
            "        # /bar/foo/afolder",
            "        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))",
            "",
            "    def test_isURLInPortalExternal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://external1'))",
            "        self.assertTrue(iURLiP('http://external1/'))",
            "        self.assertTrue(iURLiP('http://external1/something'))",
            "        self.assertTrue(iURLiP('http://external2'))",
            "        self.assertTrue(iURLiP('http://external2/'))",
            "        self.assertTrue(iURLiP('http://external2/something'))",
            "        self.assertTrue(iURLiP('http://external3/site'))",
            "        self.assertTrue(iURLiP('http://external3/site/'))",
            "        self.assertTrue(iURLiP('http://external3/site/something'))",
            "        self.assertTrue(iURLiP('http://external4/site'))",
            "        self.assertTrue(iURLiP('http://external4/site/'))",
            "        self.assertTrue(iURLiP('http://external4/site/something'))",
            "",
            "        self.assertFalse(iURLiP('http://external3/other'))",
            "        self.assertFalse(iURLiP('http://external4/other'))",
            "        self.assertFalse(iURLiP('http://external5'))",
            "        self.assertFalse(iURLiP('http://external11'))",
            "",
            "    def test_script_tag_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('<script>alert(\"hi\");</script>'))",
            "        self.assertFalse(",
            "            iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "",
            "    def test_inline_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('javascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('javascript:alert(3)'))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "Products.CMFPlone.tests.testURLTool.TestURLTool.self",
            "html5lib.serializer.htmlserializer.HTMLSerializer.serialize"
        ]
    }
}