{
    "rdiffweb/controller/page_login.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "             else:"
            },
            "1": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "                 if userobj:"
            },
            "2": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "                     cherrypy.session[SESSION_KEY] = userobj.username"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+                    cherrypy.session.regenerate()"
            },
            "4": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "                     raise cherrypy.HTTPRedirect(form.redirect.data)"
            },
            "5": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "                 flash(_(\"Invalid username or password.\"))"
            },
            "6": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 75,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 90,
                "PatchRowcode": "     @cherrypy.config(**{'tools.auth_form.on': False})"
            },
            "8": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "     def default(self):"
            },
            "9": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "         cherrypy.session[SESSION_KEY] = None"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        cherrypy.session.regenerate()"
            },
            "11": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "         raise cherrypy.HTTPRedirect('/')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import PasswordField, StringField",
            "from wtforms.fields.simple import HiddenField",
            "from wtforms.validators import InputRequired",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.core.config import Option",
            "from rdiffweb.tools.auth_form import SESSION_KEY",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginForm(CherryForm):",
            "    login = StringField(",
            "        _('Username'),",
            "        validators=[InputRequired()],",
            "        render_kw={",
            "            \"placeholder\": _('Username'),",
            "            \"autocorrect\": \"off\",",
            "            \"autocapitalize\": \"none\",",
            "            \"autocomplete\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    password = PasswordField(_('Password'), validators=[InputRequired()], render_kw={\"placeholder\": _('Password')})",
            "    # Sanitize the redirect URL to avoid Open Redirect",
            "    redirect = HiddenField(default='/', filters=[lambda v: v if v.startswith('/') else '/'])",
            "",
            "",
            "class LoginPage(Controller):",
            "    \"\"\"",
            "    This page is used by the authentication to enter a user/pass.",
            "    \"\"\"",
            "",
            "    _welcome_msg = Option(\"welcome_msg\")",
            "",
            "    @cherrypy.expose()",
            "    @cherrypy.config(**{'tools.auth_form.on': False, 'tools.ratelimit.on': True})",
            "    def index(self, **kwargs):",
            "        form = LoginForm()",
            "        # Validate user's credentials",
            "        if form.validate_on_submit():",
            "            try:",
            "                userobj = self.app.store.login(form.login.data, form.password.data)",
            "            except Exception:",
            "                logger.exception('fail to validate credential')",
            "                flash(_(\"Fail to validate user credential.\"))",
            "            else:",
            "                if userobj:",
            "                    cherrypy.session[SESSION_KEY] = userobj.username",
            "                    raise cherrypy.HTTPRedirect(form.redirect.data)",
            "                flash(_(\"Invalid username or password.\"))",
            "",
            "        params = {'form': form}",
            "",
            "        # Add welcome message to params. Try to load translated message.",
            "        if self._welcome_msg:",
            "            params[\"welcome_msg\"] = self._welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = self._welcome_msg.get(locale, params[\"welcome_msg\"])",
            "",
            "        return self._compile_template(\"login.html\", **params).encode(\"utf-8\")",
            "",
            "",
            "class LogoutPage(Controller):",
            "    @cherrypy.expose",
            "    @cherrypy.config(**{'tools.auth_form.on': False})",
            "    def default(self):",
            "        cherrypy.session[SESSION_KEY] = None",
            "        raise cherrypy.HTTPRedirect('/')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import PasswordField, StringField",
            "from wtforms.fields.simple import HiddenField",
            "from wtforms.validators import InputRequired",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.core.config import Option",
            "from rdiffweb.tools.auth_form import SESSION_KEY",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginForm(CherryForm):",
            "    login = StringField(",
            "        _('Username'),",
            "        validators=[InputRequired()],",
            "        render_kw={",
            "            \"placeholder\": _('Username'),",
            "            \"autocorrect\": \"off\",",
            "            \"autocapitalize\": \"none\",",
            "            \"autocomplete\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    password = PasswordField(_('Password'), validators=[InputRequired()], render_kw={\"placeholder\": _('Password')})",
            "    # Sanitize the redirect URL to avoid Open Redirect",
            "    redirect = HiddenField(default='/', filters=[lambda v: v if v.startswith('/') else '/'])",
            "",
            "",
            "class LoginPage(Controller):",
            "    \"\"\"",
            "    This page is used by the authentication to enter a user/pass.",
            "    \"\"\"",
            "",
            "    _welcome_msg = Option(\"welcome_msg\")",
            "",
            "    @cherrypy.expose()",
            "    @cherrypy.config(**{'tools.auth_form.on': False, 'tools.ratelimit.on': True})",
            "    def index(self, **kwargs):",
            "        form = LoginForm()",
            "        # Validate user's credentials",
            "        if form.validate_on_submit():",
            "            try:",
            "                userobj = self.app.store.login(form.login.data, form.password.data)",
            "            except Exception:",
            "                logger.exception('fail to validate credential')",
            "                flash(_(\"Fail to validate user credential.\"))",
            "            else:",
            "                if userobj:",
            "                    cherrypy.session[SESSION_KEY] = userobj.username",
            "                    cherrypy.session.regenerate()",
            "                    raise cherrypy.HTTPRedirect(form.redirect.data)",
            "                flash(_(\"Invalid username or password.\"))",
            "",
            "        params = {'form': form}",
            "",
            "        # Add welcome message to params. Try to load translated message.",
            "        if self._welcome_msg:",
            "            params[\"welcome_msg\"] = self._welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = self._welcome_msg.get(locale, params[\"welcome_msg\"])",
            "",
            "        return self._compile_template(\"login.html\", **params).encode(\"utf-8\")",
            "",
            "",
            "class LogoutPage(Controller):",
            "    @cherrypy.expose",
            "    @cherrypy.config(**{'tools.auth_form.on': False})",
            "    def default(self):",
            "        cherrypy.session[SESSION_KEY] = None",
            "        cherrypy.session.regenerate()",
            "        raise cherrypy.HTTPRedirect('/')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.page_login.LoginPage.index.params",
            "flask_cors.extension"
        ]
    }
}