{
    "papermerge/core/validators.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " def safe_character_validator(value):"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+    \"\"\""
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+    Unsafe characters are"
            },
            "5": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    unsafe_chars = re.compile(r'.*[<>\\/\\\\;:&].*')"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+    <  (smaller then)"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+    >  (greater then)"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+    \\\\  (backslash)"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+    /  (slash)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+    & and ; may be added by escape:"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 16,
                "PatchRowcode": "+"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 17,
                "PatchRowcode": "+    <script>alert('hi!')</script> after escaping becomes:"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 18,
                "PatchRowcode": "+"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+    &lt;script&gt;alert(&#x27;hi!&#x27;)&lt;/script&gt;"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 20,
                "PatchRowcode": "+    \"\"\""
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+    unsafe_chars = re.compile(r'.*[<>\\/\\\\:].*')"
            },
            "19": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 22,
                "PatchRowcode": "     message = 'Enter only safe characters.'"
            },
            "20": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " "
            },
            "21": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 24,
                "PatchRowcode": "     if unsafe_chars.match(value):"
            }
        },
        "frontPatchFile": [
            "import re",
            "",
            "from django.core.exceptions import ValidationError",
            "",
            "",
            "def safe_character_validator(value):",
            "",
            "    unsafe_chars = re.compile(r'.*[<>\\/\\\\;:&].*')",
            "    message = 'Enter only safe characters.'",
            "",
            "    if unsafe_chars.match(value):",
            "        raise ValidationError(message)"
        ],
        "afterPatchFile": [
            "import re",
            "",
            "from django.core.exceptions import ValidationError",
            "",
            "",
            "def safe_character_validator(value):",
            "    \"\"\"",
            "    Unsafe characters are",
            "",
            "    <  (smaller then)",
            "    >  (greater then)",
            "    \\\\  (backslash)",
            "    /  (slash)",
            "",
            "    & and ; may be added by escape:",
            "",
            "    <script>alert('hi!')</script> after escaping becomes:",
            "",
            "    &lt;script&gt;alert(&#x27;hi!&#x27;)&lt;/script&gt;",
            "    \"\"\"",
            "    unsafe_chars = re.compile(r'.*[<>\\/\\\\:].*')",
            "    message = 'Enter only safe characters.'",
            "",
            "    if unsafe_chars.match(value):",
            "        raise ValidationError(message)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "8": [
                "safe_character_validator"
            ]
        },
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    },
    "papermerge/core/views/documents.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 247,
                "afterPatchRowNumber": 247,
                "PatchRowcode": " def rename_node(request, id):"
            },
            "1": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": 248,
                "PatchRowcode": "     \"\"\""
            },
            "2": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": 249,
                "PatchRowcode": "     Renames a node (changes its title field)."
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 250,
                "PatchRowcode": "+"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+    Mandatory attributes:"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+        * non empty title"
            },
            "7": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": 254,
                "PatchRowcode": "     \"\"\""
            },
            "8": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": 255,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": 256,
                "PatchRowcode": "     data = json.loads(request.body)"
            },
            "10": {
                "beforePatchRowNumber": 253,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    title = data.get('title', None)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 257,
                "PatchRowcode": "+    title = data.get('title', False)"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 258,
                "PatchRowcode": "+    title = escape(title)"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 259,
                "PatchRowcode": "+"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 260,
                "PatchRowcode": "+    if not title:"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 261,
                "PatchRowcode": "+        return HttpResponseBadRequest("
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 262,
                "PatchRowcode": "+            json.dumps({"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 263,
                "PatchRowcode": "+                'msg': _('Title attribute is required')"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 264,
                "PatchRowcode": "+            }),"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 265,
                "PatchRowcode": "+            content_type=\"application/json\""
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 266,
                "PatchRowcode": "+        )"
            },
            "21": {
                "beforePatchRowNumber": 254,
                "afterPatchRowNumber": 267,
                "PatchRowcode": "     node = get_object_or_404(BaseTreeNode, id=id)"
            },
            "22": {
                "beforePatchRowNumber": 255,
                "afterPatchRowNumber": 268,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 256,
                "afterPatchRowNumber": 269,
                "PatchRowcode": "     if not request.user.has_perm(Access.PERM_WRITE, node):"
            },
            "24": {
                "beforePatchRowNumber": 281,
                "afterPatchRowNumber": 294,
                "PatchRowcode": "     Creates a new folder."
            },
            "25": {
                "beforePatchRowNumber": 282,
                "afterPatchRowNumber": 295,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 283,
                "afterPatchRowNumber": 296,
                "PatchRowcode": "     Mandatory parameters parent_id and title:"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 297,
                "PatchRowcode": "+"
            },
            "28": {
                "beforePatchRowNumber": 284,
                "afterPatchRowNumber": 298,
                "PatchRowcode": "     * If either parent_id or title are missing - does nothing."
            },
            "29": {
                "beforePatchRowNumber": 285,
                "afterPatchRowNumber": 299,
                "PatchRowcode": "     * If parent_id < 0 => creates a folder with parent root."
            },
            "30": {
                "beforePatchRowNumber": 286,
                "afterPatchRowNumber": 300,
                "PatchRowcode": "     * If parent_id >= 0 => creates a folder with given parent id."
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 301,
                "PatchRowcode": "+"
            },
            "32": {
                "beforePatchRowNumber": 287,
                "afterPatchRowNumber": 302,
                "PatchRowcode": "     \"\"\""
            },
            "33": {
                "beforePatchRowNumber": 288,
                "afterPatchRowNumber": 303,
                "PatchRowcode": "     data = json.loads(request.body)"
            },
            "34": {
                "beforePatchRowNumber": 289,
                "afterPatchRowNumber": 304,
                "PatchRowcode": "     parent_id = data.get('parent_id', -1)"
            },
            "35": {
                "beforePatchRowNumber": 290,
                "afterPatchRowNumber": 305,
                "PatchRowcode": "     title = data.get('title', False)"
            },
            "36": {
                "beforePatchRowNumber": 291,
                "afterPatchRowNumber": 306,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 307,
                "PatchRowcode": "+    if not title:"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 308,
                "PatchRowcode": "+        return HttpResponseBadRequest("
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 309,
                "PatchRowcode": "+            json.dumps({"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 310,
                "PatchRowcode": "+                'msg': _('Title attribute is required')"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 311,
                "PatchRowcode": "+            }),"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 312,
                "PatchRowcode": "+            content_type=\"application/json\""
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 313,
                "PatchRowcode": "+        )"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 314,
                "PatchRowcode": "+"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 315,
                "PatchRowcode": "+    title = escape(title)"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 316,
                "PatchRowcode": "+"
            },
            "47": {
                "beforePatchRowNumber": 292,
                "afterPatchRowNumber": 317,
                "PatchRowcode": "     if title == Folder.INBOX_NAME:"
            },
            "48": {
                "beforePatchRowNumber": 293,
                "afterPatchRowNumber": 318,
                "PatchRowcode": "         return HttpResponseBadRequest("
            },
            "49": {
                "beforePatchRowNumber": 294,
                "afterPatchRowNumber": 319,
                "PatchRowcode": "             json.dumps({"
            },
            "50": {
                "beforePatchRowNumber": 387,
                "afterPatchRowNumber": 412,
                "PatchRowcode": "     parent_id = request.POST.get('parent', \"-1\")"
            },
            "51": {
                "beforePatchRowNumber": 388,
                "afterPatchRowNumber": 413,
                "PatchRowcode": "     parent_id = filter_node_id(parent_id)"
            },
            "52": {
                "beforePatchRowNumber": 389,
                "afterPatchRowNumber": 414,
                "PatchRowcode": " "
            },
            "53": {
                "beforePatchRowNumber": 390,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    lang = request.POST.get('language')"
            },
            "54": {
                "beforePatchRowNumber": 391,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    notes = request.POST.get('notes')"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 415,
                "PatchRowcode": "+    lang = escape(request.POST.get('language'))"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 416,
                "PatchRowcode": "+    notes = escape(request.POST.get('notes'))"
            },
            "57": {
                "beforePatchRowNumber": 392,
                "afterPatchRowNumber": 417,
                "PatchRowcode": "     try:"
            },
            "58": {
                "beforePatchRowNumber": 393,
                "afterPatchRowNumber": 418,
                "PatchRowcode": "         page_count = get_pagecount(f.temporary_file_path())"
            },
            "59": {
                "beforePatchRowNumber": 394,
                "afterPatchRowNumber": 419,
                "PatchRowcode": "     except exceptions.FileTypeNotSupported:"
            },
            "60": {
                "beforePatchRowNumber": 399,
                "afterPatchRowNumber": 424,
                "PatchRowcode": "         )"
            },
            "61": {
                "beforePatchRowNumber": 400,
                "afterPatchRowNumber": 425,
                "PatchRowcode": "         return msg, status"
            },
            "62": {
                "beforePatchRowNumber": 401,
                "afterPatchRowNumber": 426,
                "PatchRowcode": " "
            },
            "63": {
                "beforePatchRowNumber": 402,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    logger.debug(\"creating document {}\".format(f.name))"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 427,
                "PatchRowcode": "+    fname = escape(f.name)"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 428,
                "PatchRowcode": "+    logger.debug(\"creating document {}\".format(fname))"
            },
            "66": {
                "beforePatchRowNumber": 403,
                "afterPatchRowNumber": 429,
                "PatchRowcode": " "
            },
            "67": {
                "beforePatchRowNumber": 404,
                "afterPatchRowNumber": 430,
                "PatchRowcode": "     doc = Document.create_document("
            },
            "68": {
                "beforePatchRowNumber": 405,
                "afterPatchRowNumber": 431,
                "PatchRowcode": "         user=user,"
            },
            "69": {
                "beforePatchRowNumber": 406,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        title=f.name,"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 432,
                "PatchRowcode": "+        title=fname,"
            },
            "71": {
                "beforePatchRowNumber": 407,
                "afterPatchRowNumber": 433,
                "PatchRowcode": "         size=size,"
            },
            "72": {
                "beforePatchRowNumber": 408,
                "afterPatchRowNumber": 434,
                "PatchRowcode": "         lang=lang,"
            },
            "73": {
                "beforePatchRowNumber": 409,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        file_name=f.name,"
            },
            "74": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 435,
                "PatchRowcode": "+        file_name=fname,"
            },
            "75": {
                "beforePatchRowNumber": 410,
                "afterPatchRowNumber": 436,
                "PatchRowcode": "         parent_id=parent_id,"
            },
            "76": {
                "beforePatchRowNumber": 411,
                "afterPatchRowNumber": 437,
                "PatchRowcode": "         notes=notes,"
            },
            "77": {
                "beforePatchRowNumber": 412,
                "afterPatchRowNumber": 438,
                "PatchRowcode": "         page_count=page_count"
            },
            "78": {
                "beforePatchRowNumber": 423,
                "afterPatchRowNumber": 449,
                "PatchRowcode": "         ocr_page.apply_async(kwargs={"
            },
            "79": {
                "beforePatchRowNumber": 424,
                "afterPatchRowNumber": 450,
                "PatchRowcode": "             'user_id': user.id,"
            },
            "80": {
                "beforePatchRowNumber": 425,
                "afterPatchRowNumber": 451,
                "PatchRowcode": "             'document_id': doc.id,"
            },
            "81": {
                "beforePatchRowNumber": 426,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            'file_name': f.name,"
            },
            "82": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 452,
                "PatchRowcode": "+            'file_name': fname,"
            },
            "83": {
                "beforePatchRowNumber": 427,
                "afterPatchRowNumber": 453,
                "PatchRowcode": "             'page_num': page_num,"
            },
            "84": {
                "beforePatchRowNumber": 428,
                "afterPatchRowNumber": 454,
                "PatchRowcode": "             'lang': lang}"
            },
            "85": {
                "beforePatchRowNumber": 429,
                "afterPatchRowNumber": 455,
                "PatchRowcode": "         )"
            }
        },
        "frontPatchFile": [
            "import os",
            "import json",
            "import logging",
            "",
            "from django.utils.translation import gettext as _",
            "from django.utils.html import escape",
            "from django.shortcuts import redirect, render, get_object_or_404",
            "from django.urls import reverse",
            "from django.views.decorators.http import require_POST",
            "from django.conf import settings",
            "from django.http import (",
            "    HttpResponse,",
            "    HttpResponseRedirect,",
            "    HttpResponseBadRequest,",
            "    HttpResponseForbidden,",
            "    Http404",
            ")",
            "from django.core.exceptions import ValidationError",
            "from django.contrib.staticfiles import finders",
            "from django.core.files.temp import NamedTemporaryFile",
            "from django.contrib.auth.decorators import login_required",
            "",
            "from mglib.pdfinfo import get_pagecount",
            "from mglib.step import Step",
            "from mglib.shortcuts import extract_img",
            "from mglib import exceptions",
            "",
            "from papermerge.core.storage import default_storage",
            "from papermerge.core.lib.hocr import Hocr",
            "from .decorators import json_response",
            "",
            "from papermerge.core.models import (",
            "    Folder, Document, BaseTreeNode, Access",
            ")",
            "from papermerge.core.tasks import ocr_page",
            "from papermerge.core.utils import filter_node_id",
            "from papermerge.core.backup_restore import build_tar_archive",
            "from papermerge.core import signal_definitions as signals",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "@login_required",
            "def document(request, doc_id):",
            "    try:",
            "        doc = Document.objects.get(id=doc_id)",
            "    except Document.DoesNotExist:",
            "        return render(request, \"admin/document_404.html\")",
            "",
            "    nodes_perms = request.user.get_perms_dict(",
            "        [doc], Access.ALL_PERMS",
            "    )",
            "",
            "    if not request.is_ajax():",
            "        if request.user.has_perm(Access.PERM_READ, doc):",
            "            return render(",
            "                request,",
            "                'admin/document.html',",
            "                {",
            "                    'pages': doc.pages.all(),",
            "                    'tags': doc.tags.all(),",
            "                    'document': doc,",
            "                    'has_perm_write': nodes_perms[doc.id].get(",
            "                        Access.PERM_WRITE, False",
            "                    ),",
            "                }",
            "            )",
            "        else:",
            "            return HttpResponseForbidden()",
            "",
            "    # ajax + PATCH",
            "    if request.method == 'PATCH':",
            "        # test_document_view",
            "        # TestDocumentAjaxOperationsView.test_update_notes",
            "        # test_update_notes",
            "        if request.user.has_perm(Access.PERM_WRITE, doc):",
            "            data = json.loads(request.body)",
            "            if 'notes' in data:",
            "                # dangerous user input. Escape it.",
            "                doc.notes = escape(data['notes'])",
            "                doc.save()",
            "                return HttpResponse(",
            "                    json.dumps(",
            "                        {",
            "                            'msg': _(\"Notes saved!\")",
            "                        }",
            "                    ),",
            "                    content_type=\"application/json\",",
            "                )",
            "        else:",
            "            return HttpResponseForbidden(",
            "                json.dumps({'msg': _(\"Access denied\")}),",
            "                content_type=\"application/json\",",
            "            )",
            "",
            "    if request.method == 'DELETE':",
            "        # test_document_view",
            "        # TestDocumentAjaxOperationsView.test_delete_document",
            "        if request.user.has_perm(Access.PERM_DELETE, doc):",
            "            doc.delete()",
            "            return HttpResponse(",
            "                json.dumps(",
            "                    {",
            "                        'msg': \"OK\",",
            "                        'url': reverse('admin:browse')",
            "                    }",
            "                ),",
            "                content_type=\"application/json\",",
            "            )",
            "        else:",
            "            return HttpResponseForbidden(",
            "                json.dumps(_(\"Access denied\")),",
            "                content_type=\"application/json\",",
            "            )",
            "",
            "    # so, ajax only here",
            "    if request.method == 'POST':",
            "        # ajax + post",
            "        pass",
            "",
            "    # ajax + GET here",
            "    result_dict = doc.to_dict()",
            "    result_dict['user_perms'] = nodes_perms[doc.id]",
            "",
            "    return HttpResponse(",
            "        json.dumps({'document': result_dict}),",
            "        content_type=\"application/json\",",
            "    )",
            "",
            "",
            "@json_response",
            "@login_required",
            "@require_POST",
            "def cut_node(request):",
            "    data = json.loads(request.body)",
            "    node_ids = [item['id'] for item in data]",
            "    nodes = BaseTreeNode.objects.filter(",
            "        id__in=node_ids",
            "    )",
            "    nodes_perms = request.user.get_perms_dict(",
            "        nodes, Access.ALL_PERMS",
            "    )",
            "    for node in nodes:",
            "        if not nodes_perms[node.id].get(",
            "            Access.PERM_DELETE, False",
            "        ):",
            "            msg = _(",
            "                \"%s does not have permission to cut %s\"",
            "            ) % (request.user.username, node.title)",
            "",
            "            return msg, HttpResponseForbidden.status_code",
            "",
            "    # request.clipboard.nodes = request.nodes",
            "    request.nodes.add(node_ids)",
            "",
            "    return 'OK'",
            "",
            "",
            "@login_required",
            "def clipboard(request):",
            "    if request.method == 'GET':",
            "",
            "        return HttpResponse(",
            "            # request.nodes = request.clipboard.nodes",
            "            json.dumps({'clipboard': request.nodes.all()}),",
            "            content_type=\"application/json\",",
            "        )",
            "",
            "    return HttpResponse(",
            "        json.dumps({'clipboard': []}),",
            "        content_type=\"application/json\",",
            "    )",
            "",
            "",
            "@login_required",
            "@require_POST",
            "def paste_pages(request):",
            "    \"\"\"",
            "    Paste pages in a changelist view.",
            "    This means a new document instance",
            "    is created.",
            "    \"\"\"",
            "    data = json.loads(request.body)",
            "    parent_id = data.get('parent_id', None)",
            "",
            "    if parent_id:",
            "        parent_id = int(parent_id)",
            "",
            "    Document.paste_pages(",
            "        user=request.user,",
            "        parent_id=parent_id,",
            "        doc_pages=request.pages.all()",
            "    )",
            "",
            "    request.pages.clear()",
            "",
            "    return HttpResponse(",
            "        json.dumps({'msg': 'OK'}),",
            "        content_type=\"application/json\",",
            "    )",
            "",
            "",
            "@login_required",
            "@require_POST",
            "def paste_node(request):",
            "    data = json.loads(request.body)",
            "",
            "    if not data:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': 'Payload empty'",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "",
            "    parent_id = data.get('parent_id', False)",
            "",
            "    if parent_id:",
            "        parent = BaseTreeNode.objects.filter(id=parent_id).first()",
            "    else:",
            "        parent = None",
            "",
            "    # request.clipboard.nodes = request.nodes",
            "    node_ids = request.nodes.all()",
            "",
            "    # iterate through all node ids and change their",
            "    # parent to new one (parent_id)",
            "    for node in BaseTreeNode.objects.filter(id__in=node_ids):",
            "        node.refresh_from_db()",
            "        if parent:",
            "            parent.refresh_from_db()",
            "        Document.objects.move_node(node, parent)",
            "",
            "    # request.clipboard.nodes = request.nodes",
            "    request.nodes.clear()",
            "",
            "    return HttpResponse(",
            "        json.dumps({",
            "            'msg': 'OK'",
            "        }),",
            "        content_type=\"application/json\"",
            "    )",
            "",
            "",
            "@json_response",
            "@login_required",
            "def rename_node(request, id):",
            "    \"\"\"",
            "    Renames a node (changes its title field).",
            "    \"\"\"",
            "",
            "    data = json.loads(request.body)",
            "    title = data.get('title', None)",
            "    node = get_object_or_404(BaseTreeNode, id=id)",
            "",
            "    if not request.user.has_perm(Access.PERM_WRITE, node):",
            "        msg = _(",
            "            \"You don't have permissions to rename this document\"",
            "        )",
            "        return msg, HttpResponseForbidden.status_code",
            "",
            "    if not title:",
            "        return _('Missing title')",
            "",
            "    node.title = title",
            "    # never trust data coming from user",
            "    try:",
            "        node.full_clean()",
            "    except ValidationError as e:",
            "        return e.message_dict, HttpResponseBadRequest.status_code",
            "",
            "    node.save()",
            "",
            "    return 'OK'",
            "",
            "",
            "@login_required",
            "@require_POST",
            "def create_folder(request):",
            "    \"\"\"",
            "    Creates a new folder.",
            "",
            "    Mandatory parameters parent_id and title:",
            "    * If either parent_id or title are missing - does nothing.",
            "    * If parent_id < 0 => creates a folder with parent root.",
            "    * If parent_id >= 0 => creates a folder with given parent id.",
            "    \"\"\"",
            "    data = json.loads(request.body)",
            "    parent_id = data.get('parent_id', -1)",
            "    title = data.get('title', False)",
            "",
            "    if title == Folder.INBOX_NAME:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': 'This title is not allowed'",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "",
            "    if not (parent_id or title):",
            "        logger.info(",
            "            \"Invalid params for create_folder: parent=%s title=%s\",",
            "            parent_id,",
            "            title",
            "        )",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': 'Both parent_id and title empty'",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "    try:",
            "        parent_id = int(parent_id or -1)",
            "    except ValueError:",
            "        parent_id = -1",
            "",
            "    if int(parent_id) < 0:",
            "        parent_folder = None",
            "    else:",
            "        parent_folder = Folder.objects.filter(id=parent_id).first()",
            "        # if not existing parent_id was given, redirect to root",
            "        if not parent_folder:",
            "            return HttpResponseBadRequest(",
            "                json.dumps({",
            "                    'msg': f\"Parent with id={parent_id} does not exist\"",
            "                }),",
            "                content_type=\"application/json\"",
            "            )",
            "    folder = Folder(",
            "        title=title,",
            "        parent=parent_folder,",
            "        user=request.user",
            "    )",
            "    try:",
            "        folder.full_clean()",
            "    except ValidationError as e:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': e.message_dict",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "    # save folder only after OK validation",
            "    folder.save()",
            "    signals.folder_created.send(",
            "        sender='core.views.documents.create_folder',",
            "        user_id=request.user.id,",
            "        level=logging.INFO,",
            "        message=_(\"Folder created\"),",
            "        folder_id=folder.id",
            "    )",
            "",
            "    return HttpResponse(",
            "        json.dumps(",
            "            folder.to_dict()",
            "        )",
            "    )",
            "",
            "",
            "@json_response",
            "@login_required",
            "@require_POST",
            "def upload(request):",
            "    \"\"\"",
            "    To understand returned value, have a look at",
            "    papermerge.core.views.decorators.json_reponse decorator",
            "    \"\"\"",
            "    files = request.FILES.getlist('file')",
            "    if not files:",
            "        logger.warning(",
            "            \"POST request.FILES is empty. Forgot adding file?\"",
            "        )",
            "        return \"Missing input file\", 400",
            "",
            "    if len(files) > 1:",
            "        msg = \"More then one files per ajax? how come?\"",
            "        logger.warning(msg)",
            "",
            "        return msg, 400",
            "",
            "    f = files[0]",
            "",
            "    logger.debug(\"upload for f=%s user=%s\", f, request.user)",
            "",
            "    user = request.user",
            "    size = os.path.getsize(f.temporary_file_path())",
            "    parent_id = request.POST.get('parent', \"-1\")",
            "    parent_id = filter_node_id(parent_id)",
            "",
            "    lang = request.POST.get('language')",
            "    notes = request.POST.get('notes')",
            "    try:",
            "        page_count = get_pagecount(f.temporary_file_path())",
            "    except exceptions.FileTypeNotSupported:",
            "        status = 400",
            "        msg = _(",
            "            \"File type not supported.\"",
            "            \" Only pdf, tiff, png, jpeg files are supported\"",
            "        )",
            "        return msg, status",
            "",
            "    logger.debug(\"creating document {}\".format(f.name))",
            "",
            "    doc = Document.create_document(",
            "        user=user,",
            "        title=f.name,",
            "        size=size,",
            "        lang=lang,",
            "        file_name=f.name,",
            "        parent_id=parent_id,",
            "        notes=notes,",
            "        page_count=page_count",
            "    )",
            "    logger.debug(",
            "        \"uploading to {}\".format(doc.path.url())",
            "    )",
            "",
            "    default_storage.copy_doc(",
            "        src=f.temporary_file_path(),",
            "        dst=doc.path.url()",
            "    )",
            "    for page_num in range(1, page_count + 1):",
            "        ocr_page.apply_async(kwargs={",
            "            'user_id': user.id,",
            "            'document_id': doc.id,",
            "            'file_name': f.name,",
            "            'page_num': page_num,",
            "            'lang': lang}",
            "        )",
            "",
            "    # upload only one file at time.",
            "    # after each upload return a json object with",
            "    # following fields:",
            "    #",
            "    # - title",
            "    # - preview_url",
            "    # - doc_id",
            "    # - action_url  -> needed for renaming/deleting selected item",
            "    #",
            "    # with that info a new thumbnail will be created.",
            "    preview_url = reverse(",
            "        'core:preview', args=(doc.id, 200, 1)",
            "    )",
            "",
            "    result = {",
            "        'title': doc.title,",
            "        'doc_id': doc.id,",
            "        'action_url': \"\",",
            "        'preview_url': preview_url",
            "    }",
            "",
            "    return result",
            "",
            "",
            "@login_required",
            "def usersettings(request, option, value):",
            "",
            "    if option == 'documents_view':",
            "        user_settings = request.user.preferences",
            "        if value in ('list', 'grid'):",
            "            user_settings['views__documents_view'] = value",
            "            user_settings['views__documents_view']",
            "",
            "    return HttpResponseRedirect(",
            "        request.META.get('HTTP_REFERER')",
            "    )",
            "",
            "",
            "@login_required",
            "def hocr(request, id, step=None, page=\"1\"):",
            "",
            "    logger.debug(f\"hocr for doc_id={id}, step={step}, page={page}\")",
            "",
            "    try:",
            "        doc = Document.objects.get(id=id)",
            "    except Document.DoesNotExist:",
            "        raise Http404(\"Document does not exists\")",
            "",
            "    doc_path = doc.path",
            "",
            "    if request.user.has_perm(Access.PERM_READ, doc):",
            "        # document absolute path",
            "        doc_abs_path = default_storage.abspath(doc_path.url())",
            "        if not os.path.exists(",
            "            doc_abs_path",
            "        ):",
            "            raise Http404(\"HOCR data not yet ready.\")",
            "",
            "        page_count = get_pagecount(doc_abs_path)",
            "        if page > page_count or page < 0:",
            "            raise Http404(\"Page does not exists\")",
            "",
            "        page_path = doc.page_paths[page]",
            "        hocr_abs_path = default_storage.abspath(page_path.hocr_url())",
            "",
            "        logger.debug(f\"Extract words from {hocr_abs_path}\")",
            "",
            "        if not os.path.exists(hocr_abs_path):",
            "            raise Http404(\"HOCR data not yet ready.\")",
            "",
            "        # At this point local HOCR data should be available.",
            "        hocr = Hocr(",
            "            hocr_file_path=hocr_abs_path",
            "        )",
            "",
            "        return HttpResponse(",
            "            json.dumps({",
            "                'hocr': hocr.good_json_words(),",
            "                'hocr_meta': hocr.get_meta()",
            "            }),",
            "            content_type=\"application/json\",",
            "        )",
            "",
            "    return HttpResponseForbidden()",
            "",
            "",
            "@login_required",
            "def preview(request, id, step=None, page=\"1\"):",
            "",
            "    try:",
            "        doc = Document.objects.get(id=id)",
            "    except Document.DoesNotExist:",
            "        raise Http404(\"Document does not exists\")",
            "",
            "    if request.user.has_perm(Access.PERM_READ, doc):",
            "        page_path = doc.get_page_path(",
            "            page_num=page,",
            "            step=Step(step),",
            "        )",
            "        img_abs_path = default_storage.abspath(",
            "            page_path.img_url()",
            "        )",
            "",
            "        if not os.path.exists(img_abs_path):",
            "            logger.debug(",
            "                f\"Preview image {img_abs_path} does not exists. Generating...\"",
            "            )",
            "            extract_img(",
            "                page_path, media_root=settings.MEDIA_ROOT",
            "            )",
            "",
            "        try:",
            "            with open(img_abs_path, \"rb\") as f:",
            "                return HttpResponse(f.read(), content_type=\"image/jpeg\")",
            "        except IOError:",
            "            generic_file = \"admin/img/document.png\"",
            "            if Step(step).is_thumbnail:",
            "                generic_file = \"admin/img/document_thumbnail.png\"",
            "",
            "            file_path = finders.find(generic_file)",
            "",
            "            with open(file_path, \"rb\") as f:",
            "                return HttpResponse(f.read(), content_type=\"image/png\")",
            "",
            "    return redirect('core:index')",
            "",
            "",
            "@login_required",
            "def document_download(request, id):",
            "    \"\"\"",
            "    Any user with read permission on the document must be",
            "    able to download the document.",
            "    \"\"\"",
            "    try:",
            "        doc = Document.objects.get(id=id)",
            "    except Document.DoesNotExist:",
            "        raise Http404(\"Document does not exists\")",
            "",
            "    if request.user.has_perm(Access.PERM_READ, doc):",
            "        try:",
            "            file_handle = open(default_storage.abspath(",
            "                doc.path.url()",
            "            ), \"rb\")",
            "        except OSError:",
            "            logger.error(",
            "                \"Cannot open local version of %s\" % doc.path.url()",
            "            )",
            "            return redirect('admin:browse')",
            "",
            "        resp = HttpResponse(",
            "            file_handle.read(),",
            "            content_type=\"application/pdf\"",
            "        )",
            "        disposition = \"attachment; filename=%s\" % doc.title",
            "        resp['Content-Disposition'] = disposition",
            "        file_handle.close()",
            "        return resp",
            "",
            "    return HttpResponseForbidden()",
            "",
            "",
            "@login_required",
            "def documents_download(request):",
            "    \"\"\"",
            "    Download multiple nodes (documents and folders) packed",
            "    as tar.gz archive.",
            "    \"\"\"",
            "",
            "    node_ids = request.GET.getlist('node_ids[]')",
            "    nodes = BaseTreeNode.objects.filter(",
            "        id__in=node_ids",
            "    )",
            "    nodes_perms = request.user.get_perms_dict(",
            "        nodes, Access.ALL_PERMS",
            "    )",
            "    for node in nodes:",
            "        if not nodes_perms[node.id].get(",
            "            Access.PERM_READ, False",
            "        ):",
            "            msg = _(",
            "                \"%s does not have permission to read %s\"",
            "            ) % (request.user.username, node.title)",
            "",
            "            return msg, HttpResponseForbidden.status_code",
            "",
            "    with NamedTemporaryFile(prefix=\"download_\") as fileobj:",
            "        build_tar_archive(",
            "            fileobj=fileobj,",
            "            node_ids=node_ids",
            "        )",
            "        # reset fileobj to initial position",
            "        fileobj.seek(0)",
            "        data = fileobj.read()",
            "        resp = HttpResponse(",
            "            data,",
            "            content_type=\"application/x-tar\"",
            "        )",
            "        disposition = \"attachment; filename=download.tar\"",
            "        resp['Content-Disposition'] = disposition",
            "",
            "        return resp"
        ],
        "afterPatchFile": [
            "import os",
            "import json",
            "import logging",
            "",
            "from django.utils.translation import gettext as _",
            "from django.utils.html import escape",
            "from django.shortcuts import redirect, render, get_object_or_404",
            "from django.urls import reverse",
            "from django.views.decorators.http import require_POST",
            "from django.conf import settings",
            "from django.http import (",
            "    HttpResponse,",
            "    HttpResponseRedirect,",
            "    HttpResponseBadRequest,",
            "    HttpResponseForbidden,",
            "    Http404",
            ")",
            "from django.core.exceptions import ValidationError",
            "from django.contrib.staticfiles import finders",
            "from django.core.files.temp import NamedTemporaryFile",
            "from django.contrib.auth.decorators import login_required",
            "",
            "from mglib.pdfinfo import get_pagecount",
            "from mglib.step import Step",
            "from mglib.shortcuts import extract_img",
            "from mglib import exceptions",
            "",
            "from papermerge.core.storage import default_storage",
            "from papermerge.core.lib.hocr import Hocr",
            "from .decorators import json_response",
            "",
            "from papermerge.core.models import (",
            "    Folder, Document, BaseTreeNode, Access",
            ")",
            "from papermerge.core.tasks import ocr_page",
            "from papermerge.core.utils import filter_node_id",
            "from papermerge.core.backup_restore import build_tar_archive",
            "from papermerge.core import signal_definitions as signals",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "@login_required",
            "def document(request, doc_id):",
            "    try:",
            "        doc = Document.objects.get(id=doc_id)",
            "    except Document.DoesNotExist:",
            "        return render(request, \"admin/document_404.html\")",
            "",
            "    nodes_perms = request.user.get_perms_dict(",
            "        [doc], Access.ALL_PERMS",
            "    )",
            "",
            "    if not request.is_ajax():",
            "        if request.user.has_perm(Access.PERM_READ, doc):",
            "            return render(",
            "                request,",
            "                'admin/document.html',",
            "                {",
            "                    'pages': doc.pages.all(),",
            "                    'tags': doc.tags.all(),",
            "                    'document': doc,",
            "                    'has_perm_write': nodes_perms[doc.id].get(",
            "                        Access.PERM_WRITE, False",
            "                    ),",
            "                }",
            "            )",
            "        else:",
            "            return HttpResponseForbidden()",
            "",
            "    # ajax + PATCH",
            "    if request.method == 'PATCH':",
            "        # test_document_view",
            "        # TestDocumentAjaxOperationsView.test_update_notes",
            "        # test_update_notes",
            "        if request.user.has_perm(Access.PERM_WRITE, doc):",
            "            data = json.loads(request.body)",
            "            if 'notes' in data:",
            "                # dangerous user input. Escape it.",
            "                doc.notes = escape(data['notes'])",
            "                doc.save()",
            "                return HttpResponse(",
            "                    json.dumps(",
            "                        {",
            "                            'msg': _(\"Notes saved!\")",
            "                        }",
            "                    ),",
            "                    content_type=\"application/json\",",
            "                )",
            "        else:",
            "            return HttpResponseForbidden(",
            "                json.dumps({'msg': _(\"Access denied\")}),",
            "                content_type=\"application/json\",",
            "            )",
            "",
            "    if request.method == 'DELETE':",
            "        # test_document_view",
            "        # TestDocumentAjaxOperationsView.test_delete_document",
            "        if request.user.has_perm(Access.PERM_DELETE, doc):",
            "            doc.delete()",
            "            return HttpResponse(",
            "                json.dumps(",
            "                    {",
            "                        'msg': \"OK\",",
            "                        'url': reverse('admin:browse')",
            "                    }",
            "                ),",
            "                content_type=\"application/json\",",
            "            )",
            "        else:",
            "            return HttpResponseForbidden(",
            "                json.dumps(_(\"Access denied\")),",
            "                content_type=\"application/json\",",
            "            )",
            "",
            "    # so, ajax only here",
            "    if request.method == 'POST':",
            "        # ajax + post",
            "        pass",
            "",
            "    # ajax + GET here",
            "    result_dict = doc.to_dict()",
            "    result_dict['user_perms'] = nodes_perms[doc.id]",
            "",
            "    return HttpResponse(",
            "        json.dumps({'document': result_dict}),",
            "        content_type=\"application/json\",",
            "    )",
            "",
            "",
            "@json_response",
            "@login_required",
            "@require_POST",
            "def cut_node(request):",
            "    data = json.loads(request.body)",
            "    node_ids = [item['id'] for item in data]",
            "    nodes = BaseTreeNode.objects.filter(",
            "        id__in=node_ids",
            "    )",
            "    nodes_perms = request.user.get_perms_dict(",
            "        nodes, Access.ALL_PERMS",
            "    )",
            "    for node in nodes:",
            "        if not nodes_perms[node.id].get(",
            "            Access.PERM_DELETE, False",
            "        ):",
            "            msg = _(",
            "                \"%s does not have permission to cut %s\"",
            "            ) % (request.user.username, node.title)",
            "",
            "            return msg, HttpResponseForbidden.status_code",
            "",
            "    # request.clipboard.nodes = request.nodes",
            "    request.nodes.add(node_ids)",
            "",
            "    return 'OK'",
            "",
            "",
            "@login_required",
            "def clipboard(request):",
            "    if request.method == 'GET':",
            "",
            "        return HttpResponse(",
            "            # request.nodes = request.clipboard.nodes",
            "            json.dumps({'clipboard': request.nodes.all()}),",
            "            content_type=\"application/json\",",
            "        )",
            "",
            "    return HttpResponse(",
            "        json.dumps({'clipboard': []}),",
            "        content_type=\"application/json\",",
            "    )",
            "",
            "",
            "@login_required",
            "@require_POST",
            "def paste_pages(request):",
            "    \"\"\"",
            "    Paste pages in a changelist view.",
            "    This means a new document instance",
            "    is created.",
            "    \"\"\"",
            "    data = json.loads(request.body)",
            "    parent_id = data.get('parent_id', None)",
            "",
            "    if parent_id:",
            "        parent_id = int(parent_id)",
            "",
            "    Document.paste_pages(",
            "        user=request.user,",
            "        parent_id=parent_id,",
            "        doc_pages=request.pages.all()",
            "    )",
            "",
            "    request.pages.clear()",
            "",
            "    return HttpResponse(",
            "        json.dumps({'msg': 'OK'}),",
            "        content_type=\"application/json\",",
            "    )",
            "",
            "",
            "@login_required",
            "@require_POST",
            "def paste_node(request):",
            "    data = json.loads(request.body)",
            "",
            "    if not data:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': 'Payload empty'",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "",
            "    parent_id = data.get('parent_id', False)",
            "",
            "    if parent_id:",
            "        parent = BaseTreeNode.objects.filter(id=parent_id).first()",
            "    else:",
            "        parent = None",
            "",
            "    # request.clipboard.nodes = request.nodes",
            "    node_ids = request.nodes.all()",
            "",
            "    # iterate through all node ids and change their",
            "    # parent to new one (parent_id)",
            "    for node in BaseTreeNode.objects.filter(id__in=node_ids):",
            "        node.refresh_from_db()",
            "        if parent:",
            "            parent.refresh_from_db()",
            "        Document.objects.move_node(node, parent)",
            "",
            "    # request.clipboard.nodes = request.nodes",
            "    request.nodes.clear()",
            "",
            "    return HttpResponse(",
            "        json.dumps({",
            "            'msg': 'OK'",
            "        }),",
            "        content_type=\"application/json\"",
            "    )",
            "",
            "",
            "@json_response",
            "@login_required",
            "def rename_node(request, id):",
            "    \"\"\"",
            "    Renames a node (changes its title field).",
            "",
            "    Mandatory attributes:",
            "",
            "        * non empty title",
            "    \"\"\"",
            "",
            "    data = json.loads(request.body)",
            "    title = data.get('title', False)",
            "    title = escape(title)",
            "",
            "    if not title:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': _('Title attribute is required')",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "    node = get_object_or_404(BaseTreeNode, id=id)",
            "",
            "    if not request.user.has_perm(Access.PERM_WRITE, node):",
            "        msg = _(",
            "            \"You don't have permissions to rename this document\"",
            "        )",
            "        return msg, HttpResponseForbidden.status_code",
            "",
            "    if not title:",
            "        return _('Missing title')",
            "",
            "    node.title = title",
            "    # never trust data coming from user",
            "    try:",
            "        node.full_clean()",
            "    except ValidationError as e:",
            "        return e.message_dict, HttpResponseBadRequest.status_code",
            "",
            "    node.save()",
            "",
            "    return 'OK'",
            "",
            "",
            "@login_required",
            "@require_POST",
            "def create_folder(request):",
            "    \"\"\"",
            "    Creates a new folder.",
            "",
            "    Mandatory parameters parent_id and title:",
            "",
            "    * If either parent_id or title are missing - does nothing.",
            "    * If parent_id < 0 => creates a folder with parent root.",
            "    * If parent_id >= 0 => creates a folder with given parent id.",
            "",
            "    \"\"\"",
            "    data = json.loads(request.body)",
            "    parent_id = data.get('parent_id', -1)",
            "    title = data.get('title', False)",
            "",
            "    if not title:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': _('Title attribute is required')",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "",
            "    title = escape(title)",
            "",
            "    if title == Folder.INBOX_NAME:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': 'This title is not allowed'",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "",
            "    if not (parent_id or title):",
            "        logger.info(",
            "            \"Invalid params for create_folder: parent=%s title=%s\",",
            "            parent_id,",
            "            title",
            "        )",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': 'Both parent_id and title empty'",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "    try:",
            "        parent_id = int(parent_id or -1)",
            "    except ValueError:",
            "        parent_id = -1",
            "",
            "    if int(parent_id) < 0:",
            "        parent_folder = None",
            "    else:",
            "        parent_folder = Folder.objects.filter(id=parent_id).first()",
            "        # if not existing parent_id was given, redirect to root",
            "        if not parent_folder:",
            "            return HttpResponseBadRequest(",
            "                json.dumps({",
            "                    'msg': f\"Parent with id={parent_id} does not exist\"",
            "                }),",
            "                content_type=\"application/json\"",
            "            )",
            "    folder = Folder(",
            "        title=title,",
            "        parent=parent_folder,",
            "        user=request.user",
            "    )",
            "    try:",
            "        folder.full_clean()",
            "    except ValidationError as e:",
            "        return HttpResponseBadRequest(",
            "            json.dumps({",
            "                'msg': e.message_dict",
            "            }),",
            "            content_type=\"application/json\"",
            "        )",
            "    # save folder only after OK validation",
            "    folder.save()",
            "    signals.folder_created.send(",
            "        sender='core.views.documents.create_folder',",
            "        user_id=request.user.id,",
            "        level=logging.INFO,",
            "        message=_(\"Folder created\"),",
            "        folder_id=folder.id",
            "    )",
            "",
            "    return HttpResponse(",
            "        json.dumps(",
            "            folder.to_dict()",
            "        )",
            "    )",
            "",
            "",
            "@json_response",
            "@login_required",
            "@require_POST",
            "def upload(request):",
            "    \"\"\"",
            "    To understand returned value, have a look at",
            "    papermerge.core.views.decorators.json_reponse decorator",
            "    \"\"\"",
            "    files = request.FILES.getlist('file')",
            "    if not files:",
            "        logger.warning(",
            "            \"POST request.FILES is empty. Forgot adding file?\"",
            "        )",
            "        return \"Missing input file\", 400",
            "",
            "    if len(files) > 1:",
            "        msg = \"More then one files per ajax? how come?\"",
            "        logger.warning(msg)",
            "",
            "        return msg, 400",
            "",
            "    f = files[0]",
            "",
            "    logger.debug(\"upload for f=%s user=%s\", f, request.user)",
            "",
            "    user = request.user",
            "    size = os.path.getsize(f.temporary_file_path())",
            "    parent_id = request.POST.get('parent', \"-1\")",
            "    parent_id = filter_node_id(parent_id)",
            "",
            "    lang = escape(request.POST.get('language'))",
            "    notes = escape(request.POST.get('notes'))",
            "    try:",
            "        page_count = get_pagecount(f.temporary_file_path())",
            "    except exceptions.FileTypeNotSupported:",
            "        status = 400",
            "        msg = _(",
            "            \"File type not supported.\"",
            "            \" Only pdf, tiff, png, jpeg files are supported\"",
            "        )",
            "        return msg, status",
            "",
            "    fname = escape(f.name)",
            "    logger.debug(\"creating document {}\".format(fname))",
            "",
            "    doc = Document.create_document(",
            "        user=user,",
            "        title=fname,",
            "        size=size,",
            "        lang=lang,",
            "        file_name=fname,",
            "        parent_id=parent_id,",
            "        notes=notes,",
            "        page_count=page_count",
            "    )",
            "    logger.debug(",
            "        \"uploading to {}\".format(doc.path.url())",
            "    )",
            "",
            "    default_storage.copy_doc(",
            "        src=f.temporary_file_path(),",
            "        dst=doc.path.url()",
            "    )",
            "    for page_num in range(1, page_count + 1):",
            "        ocr_page.apply_async(kwargs={",
            "            'user_id': user.id,",
            "            'document_id': doc.id,",
            "            'file_name': fname,",
            "            'page_num': page_num,",
            "            'lang': lang}",
            "        )",
            "",
            "    # upload only one file at time.",
            "    # after each upload return a json object with",
            "    # following fields:",
            "    #",
            "    # - title",
            "    # - preview_url",
            "    # - doc_id",
            "    # - action_url  -> needed for renaming/deleting selected item",
            "    #",
            "    # with that info a new thumbnail will be created.",
            "    preview_url = reverse(",
            "        'core:preview', args=(doc.id, 200, 1)",
            "    )",
            "",
            "    result = {",
            "        'title': doc.title,",
            "        'doc_id': doc.id,",
            "        'action_url': \"\",",
            "        'preview_url': preview_url",
            "    }",
            "",
            "    return result",
            "",
            "",
            "@login_required",
            "def usersettings(request, option, value):",
            "",
            "    if option == 'documents_view':",
            "        user_settings = request.user.preferences",
            "        if value in ('list', 'grid'):",
            "            user_settings['views__documents_view'] = value",
            "            user_settings['views__documents_view']",
            "",
            "    return HttpResponseRedirect(",
            "        request.META.get('HTTP_REFERER')",
            "    )",
            "",
            "",
            "@login_required",
            "def hocr(request, id, step=None, page=\"1\"):",
            "",
            "    logger.debug(f\"hocr for doc_id={id}, step={step}, page={page}\")",
            "",
            "    try:",
            "        doc = Document.objects.get(id=id)",
            "    except Document.DoesNotExist:",
            "        raise Http404(\"Document does not exists\")",
            "",
            "    doc_path = doc.path",
            "",
            "    if request.user.has_perm(Access.PERM_READ, doc):",
            "        # document absolute path",
            "        doc_abs_path = default_storage.abspath(doc_path.url())",
            "        if not os.path.exists(",
            "            doc_abs_path",
            "        ):",
            "            raise Http404(\"HOCR data not yet ready.\")",
            "",
            "        page_count = get_pagecount(doc_abs_path)",
            "        if page > page_count or page < 0:",
            "            raise Http404(\"Page does not exists\")",
            "",
            "        page_path = doc.page_paths[page]",
            "        hocr_abs_path = default_storage.abspath(page_path.hocr_url())",
            "",
            "        logger.debug(f\"Extract words from {hocr_abs_path}\")",
            "",
            "        if not os.path.exists(hocr_abs_path):",
            "            raise Http404(\"HOCR data not yet ready.\")",
            "",
            "        # At this point local HOCR data should be available.",
            "        hocr = Hocr(",
            "            hocr_file_path=hocr_abs_path",
            "        )",
            "",
            "        return HttpResponse(",
            "            json.dumps({",
            "                'hocr': hocr.good_json_words(),",
            "                'hocr_meta': hocr.get_meta()",
            "            }),",
            "            content_type=\"application/json\",",
            "        )",
            "",
            "    return HttpResponseForbidden()",
            "",
            "",
            "@login_required",
            "def preview(request, id, step=None, page=\"1\"):",
            "",
            "    try:",
            "        doc = Document.objects.get(id=id)",
            "    except Document.DoesNotExist:",
            "        raise Http404(\"Document does not exists\")",
            "",
            "    if request.user.has_perm(Access.PERM_READ, doc):",
            "        page_path = doc.get_page_path(",
            "            page_num=page,",
            "            step=Step(step),",
            "        )",
            "        img_abs_path = default_storage.abspath(",
            "            page_path.img_url()",
            "        )",
            "",
            "        if not os.path.exists(img_abs_path):",
            "            logger.debug(",
            "                f\"Preview image {img_abs_path} does not exists. Generating...\"",
            "            )",
            "            extract_img(",
            "                page_path, media_root=settings.MEDIA_ROOT",
            "            )",
            "",
            "        try:",
            "            with open(img_abs_path, \"rb\") as f:",
            "                return HttpResponse(f.read(), content_type=\"image/jpeg\")",
            "        except IOError:",
            "            generic_file = \"admin/img/document.png\"",
            "            if Step(step).is_thumbnail:",
            "                generic_file = \"admin/img/document_thumbnail.png\"",
            "",
            "            file_path = finders.find(generic_file)",
            "",
            "            with open(file_path, \"rb\") as f:",
            "                return HttpResponse(f.read(), content_type=\"image/png\")",
            "",
            "    return redirect('core:index')",
            "",
            "",
            "@login_required",
            "def document_download(request, id):",
            "    \"\"\"",
            "    Any user with read permission on the document must be",
            "    able to download the document.",
            "    \"\"\"",
            "    try:",
            "        doc = Document.objects.get(id=id)",
            "    except Document.DoesNotExist:",
            "        raise Http404(\"Document does not exists\")",
            "",
            "    if request.user.has_perm(Access.PERM_READ, doc):",
            "        try:",
            "            file_handle = open(default_storage.abspath(",
            "                doc.path.url()",
            "            ), \"rb\")",
            "        except OSError:",
            "            logger.error(",
            "                \"Cannot open local version of %s\" % doc.path.url()",
            "            )",
            "            return redirect('admin:browse')",
            "",
            "        resp = HttpResponse(",
            "            file_handle.read(),",
            "            content_type=\"application/pdf\"",
            "        )",
            "        disposition = \"attachment; filename=%s\" % doc.title",
            "        resp['Content-Disposition'] = disposition",
            "        file_handle.close()",
            "        return resp",
            "",
            "    return HttpResponseForbidden()",
            "",
            "",
            "@login_required",
            "def documents_download(request):",
            "    \"\"\"",
            "    Download multiple nodes (documents and folders) packed",
            "    as tar.gz archive.",
            "    \"\"\"",
            "",
            "    node_ids = request.GET.getlist('node_ids[]')",
            "    nodes = BaseTreeNode.objects.filter(",
            "        id__in=node_ids",
            "    )",
            "    nodes_perms = request.user.get_perms_dict(",
            "        nodes, Access.ALL_PERMS",
            "    )",
            "    for node in nodes:",
            "        if not nodes_perms[node.id].get(",
            "            Access.PERM_READ, False",
            "        ):",
            "            msg = _(",
            "                \"%s does not have permission to read %s\"",
            "            ) % (request.user.username, node.title)",
            "",
            "            return msg, HttpResponseForbidden.status_code",
            "",
            "    with NamedTemporaryFile(prefix=\"download_\") as fileobj:",
            "        build_tar_archive(",
            "            fileobj=fileobj,",
            "            node_ids=node_ids",
            "        )",
            "        # reset fileobj to initial position",
            "        fileobj.seek(0)",
            "        data = fileobj.read()",
            "        resp = HttpResponse(",
            "            data,",
            "            content_type=\"application/x-tar\"",
            "        )",
            "        disposition = \"attachment; filename=download.tar\"",
            "        resp['Content-Disposition'] = disposition",
            "",
            "        return resp"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "253": [
                "rename_node"
            ],
            "390": [
                "upload"
            ],
            "391": [
                "upload"
            ],
            "402": [
                "upload"
            ],
            "406": [
                "upload"
            ],
            "409": [
                "upload"
            ],
            "426": [
                "upload"
            ]
        },
        "addLocation": [
            "web.pgadmin.tools.import_export.create_import_export_job"
        ]
    }
}