{
    "src/ansibleguy-webui/aw/api_endpoints/alert.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from aw.model.job import Job"
            },
            "2": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, api_docs_put, api_docs_delete, \\"
            },
            "3": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    api_docs_post"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+    api_docs_post, validate_no_xss"
            },
            "5": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from aw.utils.permission import has_manager_privileges"
            },
            "6": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from aw.model.alert import BaseAlert, AlertPlugin, AlertGlobal, AlertGroup, AlertUser"
            },
            "7": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 197,
                "afterPatchRowNumber": 197,
                "PatchRowcode": "         model = AlertUser"
            },
            "9": {
                "beforePatchRowNumber": 198,
                "afterPatchRowNumber": 198,
                "PatchRowcode": "         fields = AlertUser.api_fields_write"
            },
            "10": {
                "beforePatchRowNumber": 199,
                "afterPatchRowNumber": 199,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 200,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 201,
                "PatchRowcode": "+        for field in AlertUser.api_fields_write:"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 202,
                "PatchRowcode": "+            if field in attrs:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 203,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 204,
                "PatchRowcode": "+"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 205,
                "PatchRowcode": "+        return attrs"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 206,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": 200,
                "afterPatchRowNumber": 207,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": 201,
                "afterPatchRowNumber": 208,
                "PatchRowcode": " class APIAlertUser(GenericAPIView):"
            },
            "20": {
                "beforePatchRowNumber": 202,
                "afterPatchRowNumber": 209,
                "PatchRowcode": "     http_method_names = ['get', 'post']"
            },
            "21": {
                "beforePatchRowNumber": 352,
                "afterPatchRowNumber": 359,
                "PatchRowcode": "         model = AlertGlobal"
            },
            "22": {
                "beforePatchRowNumber": 353,
                "afterPatchRowNumber": 360,
                "PatchRowcode": "         fields = AlertGlobal.api_fields_write"
            },
            "23": {
                "beforePatchRowNumber": 354,
                "afterPatchRowNumber": 361,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 362,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 363,
                "PatchRowcode": "+        for field in AlertGlobal.api_fields_write:"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 364,
                "PatchRowcode": "+            if field in attrs:"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 365,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 366,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 367,
                "PatchRowcode": "+        return attrs"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 368,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": 355,
                "afterPatchRowNumber": 369,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 356,
                "afterPatchRowNumber": 370,
                "PatchRowcode": " class APIAlertGlobal(GenericAPIView):"
            },
            "33": {
                "beforePatchRowNumber": 357,
                "afterPatchRowNumber": 371,
                "PatchRowcode": "     http_method_names = ['get', 'post']"
            },
            "34": {
                "beforePatchRowNumber": 513,
                "afterPatchRowNumber": 527,
                "PatchRowcode": "         model = AlertGroup"
            },
            "35": {
                "beforePatchRowNumber": 514,
                "afterPatchRowNumber": 528,
                "PatchRowcode": "         fields = AlertGroup.api_fields_write"
            },
            "36": {
                "beforePatchRowNumber": 515,
                "afterPatchRowNumber": 529,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 530,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 531,
                "PatchRowcode": "+        for field in AlertGroup.api_fields_write:"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 532,
                "PatchRowcode": "+            if field in attrs:"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 533,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 534,
                "PatchRowcode": "+"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 535,
                "PatchRowcode": "+        return attrs"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 536,
                "PatchRowcode": "+"
            },
            "44": {
                "beforePatchRowNumber": 516,
                "afterPatchRowNumber": 537,
                "PatchRowcode": " "
            },
            "45": {
                "beforePatchRowNumber": 517,
                "afterPatchRowNumber": 538,
                "PatchRowcode": " class APIAlertGroup(GenericAPIView):"
            },
            "46": {
                "beforePatchRowNumber": 518,
                "afterPatchRowNumber": 539,
                "PatchRowcode": "     http_method_names = ['get', 'post']"
            }
        },
        "frontPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.generics import GenericAPIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse",
            "",
            "from aw.model.job import Job",
            "from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, api_docs_put, api_docs_delete, \\",
            "    api_docs_post",
            "from aw.utils.permission import has_manager_privileges",
            "from aw.model.alert import BaseAlert, AlertPlugin, AlertGlobal, AlertGroup, AlertUser",
            "",
            "",
            "def update_jobs(alert: BaseAlert, job_ids: list):",
            "    jobs = []",
            "    for job_id in job_ids:",
            "        try:",
            "            jobs.append(Job.objects.get(id=job_id))",
            "",
            "        except ObjectDoesNotExist:",
            "            continue",
            "",
            "    alert.jobs.set(jobs)",
            "",
            "",
            "class AlertPluginReadWrite(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertPlugin",
            "        fields = AlertPlugin.api_fields",
            "",
            "",
            "class APIAlertPlugin(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertPluginReadWrite",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertPluginReadWrite},",
            "        summary='Return list of Alert-Plugins',",
            "        operation_id='alert_plugin_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response([AlertPluginReadWrite(instance=plugin).data for plugin in AlertPlugin.objects.all()])",
            "",
            "    @extend_schema(",
            "        request=AlertPluginReadWrite,",
            "        responses=api_docs_post('Alert-Plugin'),",
            "        summary='Create a new Alert-Plugin.',",
            "        operation_id='alert_plugin_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert-Plugin'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertPluginReadWrite(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert-Plugin data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert-Plugin data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert-Plugin '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertPluginItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertPluginReadWrite,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert-Plugin does not exist'),",
            "        },",
            "        summary='Return information of an Alert-Plugin.',",
            "        operation_id='alert_plugin_get'",
            "    )",
            "    def get(request, plugin_id: int):",
            "        del request",
            "        try:",
            "            plugin = AlertPlugin.objects.get(id=plugin_id)",
            "            if plugin is not None:",
            "                return Response(AlertPluginReadWrite(instance=plugin).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert-Plugin with ID {plugin_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=AlertPluginReadWrite,",
            "        responses=api_docs_put('Alert-Plugin'),",
            "        summary='Modify an Alert-Plugin.',",
            "        operation_id='alert_plugin_edit',",
            "    )",
            "    def put(self, request, plugin_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert-Plugins'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertPluginReadWrite(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert-Plugin data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            plugin = AlertPlugin.objects.get(id=plugin_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            plugin = None",
            "",
            "        if plugin is None:",
            "            return Response(",
            "                data={'msg': f\"Alert-Plugin with ID {plugin_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            AlertPlugin.objects.filter(id=plugin.id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Alert-Plugin '{plugin.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert-Plugin data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert-Plugin'),",
            "        summary='Delete an Alert-Plugin.',",
            "        operation_id='alert_plugin_delete'",
            "    )",
            "    def delete(self, request, plugin_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert-Plugins'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            plugin = AlertPlugin.objects.get(id=plugin_id)",
            "            if plugin is not None:",
            "                plugin.delete()",
            "                return Response(data={'msg': f\"Alert-Plugin '{plugin.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert-Plugin with ID {plugin_id} does not exist\"}, status=404)",
            "",
            "",
            "class BaseAlertWriteRequest(serializers.ModelSerializer):",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        self.fields['jobs'] = serializers.MultipleChoiceField(choices=[job.id for job in Job.objects.all()])",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "    jobs = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "",
            "",
            "class AlertUserReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertUser",
            "        fields = AlertUser.api_fields_read",
            "",
            "    alert_type_name = serializers.CharField()",
            "    condition_name = serializers.CharField()",
            "",
            "",
            "class AlertUserWriteRequest(BaseAlertWriteRequest):",
            "    class Meta:",
            "        model = AlertUser",
            "        fields = AlertUser.api_fields_write",
            "",
            "",
            "class APIAlertUser(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertUserReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertUserReadResponse},",
            "        summary='Return list of Alerts',",
            "        operation_id='alert_user_list',",
            "    )",
            "    def get(request):",
            "        user = get_api_user(request)",
            "        return Response(",
            "            [AlertUserReadResponse(instance=alert).data for alert in AlertUser.objects.filter(user=user)]",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertUserWriteRequest,",
            "        responses=api_docs_post('Alert'),",
            "        summary='Create a new Alert.',",
            "        operation_id='alert_user_create',",
            "    )",
            "    def post(self, request):",
            "        user = get_api_user(request)",
            "        serializer = AlertUserWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.validated_data['user_id'] = user.id",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertUserItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertUserReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert does not exist'),",
            "        },",
            "        summary='Return information of an Alert.',",
            "        operation_id='alert_user_get'",
            "    )",
            "    def get(request, alert_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            alert = AlertUser.objects.get(id=alert_id, user=user)",
            "            if alert is not None:",
            "                return Response(AlertUserReadResponse(instance=alert).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist or is belongs to another user\"},",
            "            status=404,",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertUserWriteRequest,",
            "        responses=api_docs_put('Alert'),",
            "        summary='Modify an Alert.',",
            "        operation_id='alert_user_edit',",
            "    )",
            "    def put(self, request, alert_id: int):",
            "        user = get_api_user(request)",
            "        serializer = AlertUserWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            alert = AlertUser.objects.get(id=alert_id, user=user)",
            "",
            "        except ObjectDoesNotExist:",
            "            alert = None",
            "",
            "        if alert is None:",
            "            return Response(",
            "                data={'msg': f\"Alert with ID {alert_id} does not exist or is belongs to another user\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            update_jobs(alert=alert, job_ids=serializer.validated_data.pop('jobs'))",
            "            AlertUser.objects.filter(id=alert.id).update(",
            "                **{**serializer.validated_data, 'user': user.id}",
            "            )",
            "            return Response(data={'msg': f\"Alert '{alert.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert'),",
            "        summary='Delete an Alert.',",
            "        operation_id='alert_user_delete'",
            "    )",
            "    def delete(self, request, alert_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            alert = AlertUser.objects.get(id=alert_id, user=user)",
            "            if alert is not None:",
            "                alert.delete()",
            "                return Response(data={'msg': f\"Alert '{alert.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist or is belongs to another user\"},",
            "            status=404,",
            "        )",
            "",
            "",
            "class AlertGlobalReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertGlobal",
            "        fields = AlertGlobal.api_fields_read",
            "",
            "    alert_type_name = serializers.CharField()",
            "    condition_name = serializers.CharField()",
            "",
            "",
            "class AlertGlobalWriteRequest(BaseAlertWriteRequest):",
            "    class Meta:",
            "        model = AlertGlobal",
            "        fields = AlertGlobal.api_fields_write",
            "",
            "",
            "class APIAlertGlobal(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertGlobalReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertGlobalReadResponse},",
            "        summary='Return list of Alerts',",
            "        operation_id='alert_global_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response([AlertGlobalReadResponse(instance=alert).data for alert in AlertGlobal.objects.all()])",
            "",
            "    @extend_schema(",
            "        request=AlertGlobalWriteRequest,",
            "        responses=api_docs_post('Alert'),",
            "        summary='Create a new Alert.',",
            "        operation_id='alert_global_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGlobalWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertGlobalItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertGlobalReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert does not exist'),",
            "        },",
            "        summary='Return information of an Alert.',",
            "        operation_id='alert_global_get'",
            "    )",
            "    def get(request, alert_id: int):",
            "        del request",
            "        try:",
            "            alert = AlertGlobal.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                return Response(AlertGlobalReadResponse(instance=alert).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert with ID {alert_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=AlertGlobalWriteRequest,",
            "        responses=api_docs_put('Alert'),",
            "        summary='Modify an Alert.',",
            "        operation_id='alert_global_edit',",
            "    )",
            "    def put(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGlobalWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGlobal.objects.get(id=alert_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            alert = None",
            "",
            "        if alert is None:",
            "            return Response(",
            "                data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            update_jobs(alert=alert, job_ids=serializer.validated_data.pop('jobs'))",
            "            AlertGlobal.objects.filter(id=alert.id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Alert '{alert.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert'),",
            "        summary='Delete an Alert.',",
            "        operation_id='alert_global_delete'",
            "    )",
            "    def delete(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGlobal.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                alert.delete()",
            "                return Response(data={'msg': f\"Alert '{alert.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert with ID {alert_id} does not exist\"}, status=404)",
            "",
            "",
            "class AlertGroupReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertGroup",
            "        fields = AlertGroup.api_fields_read",
            "",
            "    alert_type_name = serializers.CharField()",
            "    condition_name = serializers.CharField()",
            "    group_name = serializers.CharField()",
            "",
            "",
            "class AlertGroupWriteRequest(BaseAlertWriteRequest):",
            "    class Meta:",
            "        model = AlertGroup",
            "        fields = AlertGroup.api_fields_write",
            "",
            "",
            "class APIAlertGroup(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertGroupReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertGroupReadResponse},",
            "        summary='Return list of Alerts',",
            "        operation_id='alert_group_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response(",
            "            [AlertGroupReadResponse(instance=alert).data for alert in AlertGroup.objects.filter()]",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertGroupWriteRequest,",
            "        responses=api_docs_post('Alert'),",
            "        summary='Create a new Alert.',",
            "        operation_id='alert_group_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGroupWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertGroupItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertGroupReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert does not exist'),",
            "        },",
            "        summary='Return information of an Alert.',",
            "        operation_id='alert_group_get'",
            "    )",
            "    def get(request, alert_id: int):",
            "        del request",
            "",
            "        try:",
            "            alert = AlertGroup.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                return Response(AlertGroupReadResponse(instance=alert).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "            status=404,",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertGroupWriteRequest,",
            "        responses=api_docs_put('Alert'),",
            "        summary='Modify an Alert.',",
            "        operation_id='alert_group_edit',",
            "    )",
            "    def put(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGroupWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGroup.objects.get(id=alert_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            alert = None",
            "",
            "        if alert is None:",
            "            return Response(",
            "                data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            update_jobs(alert=alert, job_ids=serializer.validated_data.pop('jobs'))",
            "            AlertGroup.objects.filter(id=alert.id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Alert '{alert.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert'),",
            "        summary='Delete an Alert.',",
            "        operation_id='alert_group_delete'",
            "    )",
            "    def delete(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGroup.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                alert.delete()",
            "                return Response(data={'msg': f\"Alert '{alert.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "            status=404,",
            "        )"
        ],
        "afterPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.generics import GenericAPIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse",
            "",
            "from aw.model.job import Job",
            "from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, api_docs_put, api_docs_delete, \\",
            "    api_docs_post, validate_no_xss",
            "from aw.utils.permission import has_manager_privileges",
            "from aw.model.alert import BaseAlert, AlertPlugin, AlertGlobal, AlertGroup, AlertUser",
            "",
            "",
            "def update_jobs(alert: BaseAlert, job_ids: list):",
            "    jobs = []",
            "    for job_id in job_ids:",
            "        try:",
            "            jobs.append(Job.objects.get(id=job_id))",
            "",
            "        except ObjectDoesNotExist:",
            "            continue",
            "",
            "    alert.jobs.set(jobs)",
            "",
            "",
            "class AlertPluginReadWrite(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertPlugin",
            "        fields = AlertPlugin.api_fields",
            "",
            "",
            "class APIAlertPlugin(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertPluginReadWrite",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertPluginReadWrite},",
            "        summary='Return list of Alert-Plugins',",
            "        operation_id='alert_plugin_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response([AlertPluginReadWrite(instance=plugin).data for plugin in AlertPlugin.objects.all()])",
            "",
            "    @extend_schema(",
            "        request=AlertPluginReadWrite,",
            "        responses=api_docs_post('Alert-Plugin'),",
            "        summary='Create a new Alert-Plugin.',",
            "        operation_id='alert_plugin_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert-Plugin'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertPluginReadWrite(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert-Plugin data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert-Plugin data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert-Plugin '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertPluginItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertPluginReadWrite,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert-Plugin does not exist'),",
            "        },",
            "        summary='Return information of an Alert-Plugin.',",
            "        operation_id='alert_plugin_get'",
            "    )",
            "    def get(request, plugin_id: int):",
            "        del request",
            "        try:",
            "            plugin = AlertPlugin.objects.get(id=plugin_id)",
            "            if plugin is not None:",
            "                return Response(AlertPluginReadWrite(instance=plugin).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert-Plugin with ID {plugin_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=AlertPluginReadWrite,",
            "        responses=api_docs_put('Alert-Plugin'),",
            "        summary='Modify an Alert-Plugin.',",
            "        operation_id='alert_plugin_edit',",
            "    )",
            "    def put(self, request, plugin_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert-Plugins'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertPluginReadWrite(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert-Plugin data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            plugin = AlertPlugin.objects.get(id=plugin_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            plugin = None",
            "",
            "        if plugin is None:",
            "            return Response(",
            "                data={'msg': f\"Alert-Plugin with ID {plugin_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            AlertPlugin.objects.filter(id=plugin.id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Alert-Plugin '{plugin.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert-Plugin data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert-Plugin'),",
            "        summary='Delete an Alert-Plugin.',",
            "        operation_id='alert_plugin_delete'",
            "    )",
            "    def delete(self, request, plugin_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert-Plugins'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            plugin = AlertPlugin.objects.get(id=plugin_id)",
            "            if plugin is not None:",
            "                plugin.delete()",
            "                return Response(data={'msg': f\"Alert-Plugin '{plugin.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert-Plugin with ID {plugin_id} does not exist\"}, status=404)",
            "",
            "",
            "class BaseAlertWriteRequest(serializers.ModelSerializer):",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        self.fields['jobs'] = serializers.MultipleChoiceField(choices=[job.id for job in Job.objects.all()])",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "    jobs = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "",
            "",
            "class AlertUserReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertUser",
            "        fields = AlertUser.api_fields_read",
            "",
            "    alert_type_name = serializers.CharField()",
            "    condition_name = serializers.CharField()",
            "",
            "",
            "class AlertUserWriteRequest(BaseAlertWriteRequest):",
            "    class Meta:",
            "        model = AlertUser",
            "        fields = AlertUser.api_fields_write",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in AlertUser.api_fields_write:",
            "            if field in attrs:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "",
            "class APIAlertUser(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertUserReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertUserReadResponse},",
            "        summary='Return list of Alerts',",
            "        operation_id='alert_user_list',",
            "    )",
            "    def get(request):",
            "        user = get_api_user(request)",
            "        return Response(",
            "            [AlertUserReadResponse(instance=alert).data for alert in AlertUser.objects.filter(user=user)]",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertUserWriteRequest,",
            "        responses=api_docs_post('Alert'),",
            "        summary='Create a new Alert.',",
            "        operation_id='alert_user_create',",
            "    )",
            "    def post(self, request):",
            "        user = get_api_user(request)",
            "        serializer = AlertUserWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.validated_data['user_id'] = user.id",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertUserItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertUserReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert does not exist'),",
            "        },",
            "        summary='Return information of an Alert.',",
            "        operation_id='alert_user_get'",
            "    )",
            "    def get(request, alert_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            alert = AlertUser.objects.get(id=alert_id, user=user)",
            "            if alert is not None:",
            "                return Response(AlertUserReadResponse(instance=alert).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist or is belongs to another user\"},",
            "            status=404,",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertUserWriteRequest,",
            "        responses=api_docs_put('Alert'),",
            "        summary='Modify an Alert.',",
            "        operation_id='alert_user_edit',",
            "    )",
            "    def put(self, request, alert_id: int):",
            "        user = get_api_user(request)",
            "        serializer = AlertUserWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            alert = AlertUser.objects.get(id=alert_id, user=user)",
            "",
            "        except ObjectDoesNotExist:",
            "            alert = None",
            "",
            "        if alert is None:",
            "            return Response(",
            "                data={'msg': f\"Alert with ID {alert_id} does not exist or is belongs to another user\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            update_jobs(alert=alert, job_ids=serializer.validated_data.pop('jobs'))",
            "            AlertUser.objects.filter(id=alert.id).update(",
            "                **{**serializer.validated_data, 'user': user.id}",
            "            )",
            "            return Response(data={'msg': f\"Alert '{alert.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert'),",
            "        summary='Delete an Alert.',",
            "        operation_id='alert_user_delete'",
            "    )",
            "    def delete(self, request, alert_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            alert = AlertUser.objects.get(id=alert_id, user=user)",
            "            if alert is not None:",
            "                alert.delete()",
            "                return Response(data={'msg': f\"Alert '{alert.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist or is belongs to another user\"},",
            "            status=404,",
            "        )",
            "",
            "",
            "class AlertGlobalReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertGlobal",
            "        fields = AlertGlobal.api_fields_read",
            "",
            "    alert_type_name = serializers.CharField()",
            "    condition_name = serializers.CharField()",
            "",
            "",
            "class AlertGlobalWriteRequest(BaseAlertWriteRequest):",
            "    class Meta:",
            "        model = AlertGlobal",
            "        fields = AlertGlobal.api_fields_write",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in AlertGlobal.api_fields_write:",
            "            if field in attrs:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "",
            "class APIAlertGlobal(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertGlobalReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertGlobalReadResponse},",
            "        summary='Return list of Alerts',",
            "        operation_id='alert_global_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response([AlertGlobalReadResponse(instance=alert).data for alert in AlertGlobal.objects.all()])",
            "",
            "    @extend_schema(",
            "        request=AlertGlobalWriteRequest,",
            "        responses=api_docs_post('Alert'),",
            "        summary='Create a new Alert.',",
            "        operation_id='alert_global_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alert'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGlobalWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertGlobalItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertGlobalReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert does not exist'),",
            "        },",
            "        summary='Return information of an Alert.',",
            "        operation_id='alert_global_get'",
            "    )",
            "    def get(request, alert_id: int):",
            "        del request",
            "        try:",
            "            alert = AlertGlobal.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                return Response(AlertGlobalReadResponse(instance=alert).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert with ID {alert_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=AlertGlobalWriteRequest,",
            "        responses=api_docs_put('Alert'),",
            "        summary='Modify an Alert.',",
            "        operation_id='alert_global_edit',",
            "    )",
            "    def put(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGlobalWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGlobal.objects.get(id=alert_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            alert = None",
            "",
            "        if alert is None:",
            "            return Response(",
            "                data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            update_jobs(alert=alert, job_ids=serializer.validated_data.pop('jobs'))",
            "            AlertGlobal.objects.filter(id=alert.id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Alert '{alert.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert'),",
            "        summary='Delete an Alert.',",
            "        operation_id='alert_global_delete'",
            "    )",
            "    def delete(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGlobal.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                alert.delete()",
            "                return Response(data={'msg': f\"Alert '{alert.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Alert with ID {alert_id} does not exist\"}, status=404)",
            "",
            "",
            "class AlertGroupReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = AlertGroup",
            "        fields = AlertGroup.api_fields_read",
            "",
            "    alert_type_name = serializers.CharField()",
            "    condition_name = serializers.CharField()",
            "    group_name = serializers.CharField()",
            "",
            "",
            "class AlertGroupWriteRequest(BaseAlertWriteRequest):",
            "    class Meta:",
            "        model = AlertGroup",
            "        fields = AlertGroup.api_fields_write",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in AlertGroup.api_fields_write:",
            "            if field in attrs:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "",
            "class APIAlertGroup(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = AlertGroupReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: AlertGroupReadResponse},",
            "        summary='Return list of Alerts',",
            "        operation_id='alert_group_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response(",
            "            [AlertGroupReadResponse(instance=alert).data for alert in AlertGroup.objects.filter()]",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertGroupWriteRequest,",
            "        responses=api_docs_post('Alert'),",
            "        summary='Create a new Alert.',",
            "        operation_id='alert_group_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGroupWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Alert '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIAlertGroupItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: AlertGroupReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Alert does not exist'),",
            "        },",
            "        summary='Return information of an Alert.',",
            "        operation_id='alert_group_get'",
            "    )",
            "    def get(request, alert_id: int):",
            "        del request",
            "",
            "        try:",
            "            alert = AlertGroup.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                return Response(AlertGroupReadResponse(instance=alert).data)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "            status=404,",
            "        )",
            "",
            "    @extend_schema(",
            "        request=AlertGroupWriteRequest,",
            "        responses=api_docs_put('Alert'),",
            "        summary='Modify an Alert.',",
            "        operation_id='alert_group_edit',",
            "    )",
            "    def put(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = AlertGroupWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided Alert data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGroup.objects.get(id=alert_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            alert = None",
            "",
            "        if alert is None:",
            "            return Response(",
            "                data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            update_jobs(alert=alert, job_ids=serializer.validated_data.pop('jobs'))",
            "            AlertGroup.objects.filter(id=alert.id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Alert '{alert.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided Alert data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Alert'),",
            "        summary='Delete an Alert.',",
            "        operation_id='alert_group_delete'",
            "    )",
            "    def delete(self, request, alert_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='alert')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage Alerts'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            alert = AlertGroup.objects.get(id=alert_id)",
            "            if alert is not None:",
            "                alert.delete()",
            "                return Response(data={'msg': f\"Alert '{alert.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Alert with ID {alert_id} does not exist\"},",
            "            status=404,",
            "        )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "10": []
        },
        "addLocation": []
    },
    "src/ansibleguy-webui/aw/api_endpoints/base.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from django.contrib.auth.models import AnonymousUser"
            },
            "1": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from django.core.exceptions import ObjectDoesNotExist"
            },
            "2": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " from django.http import JsonResponse"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+from django.utils.html import escape as escape_html"
            },
            "4": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from rest_framework import serializers"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+from rest_framework.exceptions import ValidationError"
            },
            "6": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from rest_framework.permissions import IsAuthenticated"
            },
            "7": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from rest_framework_api_key.permissions import BaseHasAPIKey"
            },
            "8": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from drf_spectacular.utils import OpenApiResponse"
            },
            "9": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from aw.model.api import AwAPIKey"
            },
            "11": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from aw.base import USERS, GROUPS"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+from aw.utils.util import is_set"
            },
            "13": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " class HasAwAPIKey(BaseHasAPIKey):"
            },
            "16": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 91,
                "PatchRowcode": " def not_implemented(*args, **kwargs):"
            },
            "17": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "     del args, kwargs"
            },
            "18": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "     return JsonResponse({'error': 'Not yet implemented'}, status=404)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+def validate_no_xss(value: str, field: str):"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+    if is_set(value) and isinstance(value, str) and value != escape_html(value):"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+        raise ValidationError(f\"Found illegal characters in field '{field}'\")"
            }
        },
        "frontPatchFile": [
            "from django.conf import settings",
            "from django.contrib.auth.models import AnonymousUser",
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.http import JsonResponse",
            "from rest_framework import serializers",
            "from rest_framework.permissions import IsAuthenticated",
            "from rest_framework_api_key.permissions import BaseHasAPIKey",
            "from drf_spectacular.utils import OpenApiResponse",
            "",
            "from aw.model.api import AwAPIKey",
            "from aw.base import USERS, GROUPS",
            "",
            "",
            "class HasAwAPIKey(BaseHasAPIKey):",
            "    model = AwAPIKey",
            "",
            "",
            "API_PERMISSION = [IsAuthenticated | HasAwAPIKey]",
            "",
            "",
            "# see: rest_framework_api_key.permissions.BaseHasAPIKey:get_from_header",
            "def get_api_user(request) -> USERS:",
            "    if isinstance(request.user, AnonymousUser):",
            "        try:",
            "            return AwAPIKey.objects.get_from_key(",
            "                request.META.get(getattr(settings, 'API_KEY_CUSTOM_HEADER'))",
            "            ).user",
            "",
            "        except ObjectDoesNotExist:",
            "            # invalid api key",
            "            pass",
            "",
            "    return request.user",
            "",
            "",
            "class BaseResponse(serializers.Serializer):",
            "    def create(self, validated_data):",
            "        pass",
            "",
            "    def update(self, instance, validated_data):",
            "        pass",
            "",
            "",
            "class GenericResponse(BaseResponse):",
            "    msg = serializers.CharField()",
            "",
            "",
            "class GroupSerializer(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = GROUPS",
            "",
            "",
            "class UserSerializer(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = USERS",
            "",
            "",
            "class LogDownloadResponse(BaseResponse):",
            "    binary = serializers.CharField()",
            "",
            "",
            "def api_docs_put(item: str) -> dict:",
            "    return {",
            "        200: OpenApiResponse(response=GenericResponse, description=f'{item} updated'),",
            "        400: OpenApiResponse(response=GenericResponse, description=f'Invalid {item} data provided'),",
            "        403: OpenApiResponse(response=GenericResponse, description=f'Not privileged to edit the {item}'),",
            "        404: OpenApiResponse(response=GenericResponse, description=f'{item} does not exist'),",
            "    }",
            "",
            "",
            "def api_docs_delete(item: str) -> dict:",
            "    return {",
            "        200: OpenApiResponse(response=GenericResponse, description=f'{item} deleted'),",
            "        400: OpenApiResponse(response=GenericResponse, description=f'Invalid {item} data provided'),",
            "        403: OpenApiResponse(response=GenericResponse, description=f'Not privileged to delete the {item}'),",
            "        404: OpenApiResponse(response=GenericResponse, description=f'{item} does not exist'),",
            "    }",
            "",
            "",
            "def api_docs_post(item: str) -> dict:",
            "    return {",
            "        200: OpenApiResponse(response=GenericResponse, description=f'{item} created'),",
            "        400: OpenApiResponse(response=GenericResponse, description=f'Invalid {item} data provided'),",
            "        403: OpenApiResponse(response=GenericResponse, description=f'Not privileged to create {item}'),",
            "    }",
            "",
            "",
            "def not_implemented(*args, **kwargs):",
            "    del args, kwargs",
            "    return JsonResponse({'error': 'Not yet implemented'}, status=404)"
        ],
        "afterPatchFile": [
            "from django.conf import settings",
            "from django.contrib.auth.models import AnonymousUser",
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.http import JsonResponse",
            "from django.utils.html import escape as escape_html",
            "from rest_framework import serializers",
            "from rest_framework.exceptions import ValidationError",
            "from rest_framework.permissions import IsAuthenticated",
            "from rest_framework_api_key.permissions import BaseHasAPIKey",
            "from drf_spectacular.utils import OpenApiResponse",
            "",
            "from aw.model.api import AwAPIKey",
            "from aw.base import USERS, GROUPS",
            "from aw.utils.util import is_set",
            "",
            "",
            "class HasAwAPIKey(BaseHasAPIKey):",
            "    model = AwAPIKey",
            "",
            "",
            "API_PERMISSION = [IsAuthenticated | HasAwAPIKey]",
            "",
            "",
            "# see: rest_framework_api_key.permissions.BaseHasAPIKey:get_from_header",
            "def get_api_user(request) -> USERS:",
            "    if isinstance(request.user, AnonymousUser):",
            "        try:",
            "            return AwAPIKey.objects.get_from_key(",
            "                request.META.get(getattr(settings, 'API_KEY_CUSTOM_HEADER'))",
            "            ).user",
            "",
            "        except ObjectDoesNotExist:",
            "            # invalid api key",
            "            pass",
            "",
            "    return request.user",
            "",
            "",
            "class BaseResponse(serializers.Serializer):",
            "    def create(self, validated_data):",
            "        pass",
            "",
            "    def update(self, instance, validated_data):",
            "        pass",
            "",
            "",
            "class GenericResponse(BaseResponse):",
            "    msg = serializers.CharField()",
            "",
            "",
            "class GroupSerializer(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = GROUPS",
            "",
            "",
            "class UserSerializer(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = USERS",
            "",
            "",
            "class LogDownloadResponse(BaseResponse):",
            "    binary = serializers.CharField()",
            "",
            "",
            "def api_docs_put(item: str) -> dict:",
            "    return {",
            "        200: OpenApiResponse(response=GenericResponse, description=f'{item} updated'),",
            "        400: OpenApiResponse(response=GenericResponse, description=f'Invalid {item} data provided'),",
            "        403: OpenApiResponse(response=GenericResponse, description=f'Not privileged to edit the {item}'),",
            "        404: OpenApiResponse(response=GenericResponse, description=f'{item} does not exist'),",
            "    }",
            "",
            "",
            "def api_docs_delete(item: str) -> dict:",
            "    return {",
            "        200: OpenApiResponse(response=GenericResponse, description=f'{item} deleted'),",
            "        400: OpenApiResponse(response=GenericResponse, description=f'Invalid {item} data provided'),",
            "        403: OpenApiResponse(response=GenericResponse, description=f'Not privileged to delete the {item}'),",
            "        404: OpenApiResponse(response=GenericResponse, description=f'{item} does not exist'),",
            "    }",
            "",
            "",
            "def api_docs_post(item: str) -> dict:",
            "    return {",
            "        200: OpenApiResponse(response=GenericResponse, description=f'{item} created'),",
            "        400: OpenApiResponse(response=GenericResponse, description=f'Invalid {item} data provided'),",
            "        403: OpenApiResponse(response=GenericResponse, description=f'Not privileged to create {item}'),",
            "    }",
            "",
            "",
            "def not_implemented(*args, **kwargs):",
            "    del args, kwargs",
            "    return JsonResponse({'error': 'Not yet implemented'}, status=404)",
            "",
            "",
            "def validate_no_xss(value: str, field: str):",
            "    if is_set(value) and isinstance(value, str) and value != escape_html(value):",
            "        raise ValidationError(f\"Found illegal characters in field '{field}'\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "src.twisted.web.client.URI.fromBytes"
        ]
    },
    "src/ansibleguy-webui/aw/api_endpoints/credentials.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from aw.model.job_credential import BaseJobCredentials, JobUserCredentials, JobGlobalCredentials"
            },
            "1": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from aw.model.permission import CHOICE_PERMISSION_READ, CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE"
            },
            "2": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from aw.api_endpoints.base import API_PERMISSION, get_api_user, GenericResponse, BaseResponse, api_docs_delete, \\"
            },
            "3": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    api_docs_put, api_docs_post"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+    api_docs_put, api_docs_post, validate_no_xss"
            },
            "5": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from aw.utils.permission import has_credentials_permission, has_manager_privileges"
            },
            "6": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from aw.config.hardcoded import SECRET_HIDDEN"
            },
            "7": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from aw.utils.util import is_null"
            },
            "8": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "     connect_pass = serializers.CharField(max_length=100, required=False, default=None, allow_blank=True)"
            },
            "9": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "     ssh_key = serializers.CharField(max_length=5000, required=False, default=None, allow_blank=True)"
            },
            "10": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 52,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+        for field in JobGlobalCredentials.api_fields_write:"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+            if field in attrs and field not in BaseJobCredentials.SECRET_ATTRS:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+        return attrs"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 60,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 61,
                "PatchRowcode": " class JobUserCredentialsWriteRequest(JobGlobalCredentialsWriteRequest):"
            },
            "20": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "     class Meta:"
            },
            "21": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "         model = JobUserCredentials"
            },
            "22": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "         fields = JobUserCredentials.api_fields_write"
            },
            "23": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": 65,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+        for field in JobUserCredentials.api_fields_write:"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+            if field in attrs and field not in BaseJobCredentials.SECRET_ATTRS:"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+        return attrs"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 73,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 74,
                "PatchRowcode": " def are_global_credentials(request) -> bool:"
            },
            "33": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "     if 'global' in request.GET and request.GET['global'] != 'true':"
            }
        },
        "frontPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.views import APIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiParameter",
            "",
            "from aw.model.job import Job, JobExecution",
            "from aw.model.job_credential import BaseJobCredentials, JobUserCredentials, JobGlobalCredentials",
            "from aw.model.permission import CHOICE_PERMISSION_READ, CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE",
            "from aw.api_endpoints.base import API_PERMISSION, get_api_user, GenericResponse, BaseResponse, api_docs_delete, \\",
            "    api_docs_put, api_docs_post",
            "from aw.utils.permission import has_credentials_permission, has_manager_privileges",
            "from aw.config.hardcoded import SECRET_HIDDEN",
            "from aw.utils.util import is_null",
            "from aw.base import USERS",
            "",
            "",
            "class JobGlobalCredentialsReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobGlobalCredentials",
            "        fields = JobGlobalCredentials.api_fields_read",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        for secret_attr in BaseJobCredentials.SECRET_ATTRS:",
            "            setattr(self, f'{secret_attr}_is_set', serializers.BooleanField(required=False))",
            "",
            "",
            "class JobUserCredentialsReadResponse(JobGlobalCredentialsReadResponse):",
            "    class Meta:",
            "        model = JobUserCredentials",
            "        fields = JobUserCredentials.api_fields_read",
            "",
            "",
            "class JobCredentialsList(BaseResponse):",
            "    # NOTE: 'global' attribute not usable..",
            "    shared = serializers.ListSerializer(child=JobGlobalCredentialsReadResponse())",
            "    user = serializers.ListSerializer(child=JobUserCredentialsReadResponse())",
            "",
            "",
            "class JobGlobalCredentialsWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobGlobalCredentials",
            "        fields = JobGlobalCredentials.api_fields_write",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "    vault_pass = serializers.CharField(max_length=100, required=False, default=None, allow_blank=True)",
            "    become_pass = serializers.CharField(max_length=100, required=False, default=None, allow_blank=True)",
            "    connect_pass = serializers.CharField(max_length=100, required=False, default=None, allow_blank=True)",
            "    ssh_key = serializers.CharField(max_length=5000, required=False, default=None, allow_blank=True)",
            "",
            "",
            "class JobUserCredentialsWriteRequest(JobGlobalCredentialsWriteRequest):",
            "    class Meta:",
            "        model = JobUserCredentials",
            "        fields = JobUserCredentials.api_fields_write",
            "",
            "",
            "def are_global_credentials(request) -> bool:",
            "    if 'global' in request.GET and request.GET['global'] != 'true':",
            "        return False",
            "",
            "    return True",
            "",
            "",
            "def _find_credentials(",
            "        credentials_id: int, are_global: bool, user: USERS",
            ") -> (BaseJobCredentials, None):",
            "    try:",
            "        if are_global:",
            "            return JobGlobalCredentials.objects.get(id=credentials_id)",
            "",
            "        return JobUserCredentials.objects.get(id=credentials_id, user=user)",
            "",
            "    except ObjectDoesNotExist:",
            "        return None",
            "",
            "",
            "def _log_global_user(are_global: bool, lower: bool = False) -> str:",
            "    if are_global:",
            "        msg = 'Global credentials'",
            "",
            "    else:",
            "        msg = 'User credentials'",
            "",
            "    if lower:",
            "        return msg.lower()",
            "",
            "    return msg",
            "",
            "",
            "def credentials_in_use(credentials: BaseJobCredentials) -> bool:",
            "    if isinstance(credentials, JobGlobalCredentials):",
            "        in_use_jobs = Job.objects.filter(credentials_default=credentials).exists()",
            "        in_use_execs = JobExecution.objects.filter(credential_global=credentials).exists()",
            "        in_use = in_use_jobs or in_use_execs",
            "",
            "    else:",
            "        in_use = JobExecution.objects.filter(credential_user=credentials).exists()",
            "",
            "    return in_use",
            "",
            "",
            "SSH_KEY_PREFIX = '-----BEGIN OPENSSH PRIVATE KEY-----'",
            "SSH_KEY_APPENDIX = '-----END OPENSSH PRIVATE KEY-----'",
            "",
            "",
            "def _validate_and_fix_ssh_key(key: str) -> (str, None):",
            "    if key.find(SSH_KEY_PREFIX) == -1:",
            "        # only support unencrypted keys for now",
            "        return None",
            "",
            "    key = key.replace(SSH_KEY_PREFIX, '').replace(SSH_KEY_APPENDIX, '').strip().replace(' ', '\\n')",
            "    return f'{SSH_KEY_PREFIX}\\n{key}\\n{SSH_KEY_APPENDIX}\\n'",
            "",
            "",
            "class APIJobCredentials(APIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "    parameters = [",
            "        OpenApiParameter(",
            "            name='global', type=bool, default=True,",
            "            description='If the credentials are global or user-specific',",
            "            required=False,",
            "        ),",
            "    ]",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobCredentialsList, description='Return list of credentials'),",
            "        },",
            "        summary='Return list of all credentials the current user is privileged to view.',",
            "        operation_id='credentials_list',",
            "    )",
            "    def get(self, request):",
            "        user = get_api_user(request)",
            "        credentials_global = []",
            "        credentials_global_raw = JobGlobalCredentials.objects.all()",
            "        for credentials in credentials_global_raw:",
            "            if has_credentials_permission(",
            "                user=user,",
            "                credentials=credentials,",
            "                permission_needed=CHOICE_PERMISSION_READ,",
            "            ):",
            "                credentials_global.append(JobGlobalCredentialsReadResponse(instance=credentials).data)",
            "",
            "        credentials_user_raw = JobUserCredentials.objects.filter(user=user)",
            "        credentials_user = []",
            "        for credentials in credentials_user_raw:",
            "            credentials_user.append(JobUserCredentialsReadResponse(instance=credentials).data)",
            "",
            "        return Response(data={'shared': credentials_global, 'user': credentials_user}, status=200)",
            "",
            "    @extend_schema(",
            "        request=JobGlobalCredentialsWriteRequest,",
            "        responses=api_docs_post('Credentials'),",
            "        summary='Create credentials.',",
            "        operation_id='credentials_create',",
            "        parameters=parameters,",
            "    )",
            "    def post(self, request):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global and not has_manager_privileges(user=user, kind='credentials'):",
            "            return Response(data={'msg': 'Not privileged to create global credentials'}, status=403)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsWriteRequest",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsWriteRequest",
            "",
            "        serializer = self.serializer_class(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global)} data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        for field in BaseJobCredentials.SECRET_ATTRS:",
            "            value = serializer.validated_data[field]",
            "            if field in BaseJobCredentials.SECRET_ATTRS:",
            "                if is_null(value) or value == SECRET_HIDDEN:",
            "                    serializer.validated_data[field] = None",
            "",
            "                elif field == 'ssh_key':",
            "                    value = _validate_and_fix_ssh_key(value)",
            "                    if value is None:",
            "                        return Response(",
            "                            data={'msg': f\"Provided {_log_global_user(are_global)} ssh-key is not valid'\"},",
            "                            status=400,",
            "                        )",
            "",
            "                    serializer.validated_data[field] = value",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global)} data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response(data={'msg': f'{_log_global_user(are_global, lower=False)} created'}, status=200)",
            "",
            "",
            "class APIJobCredentialsItem(APIView):",
            "    http_method_names = ['get', 'delete', 'put']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "    parameters = [",
            "        OpenApiParameter(",
            "            name='global', type=bool, default=True,",
            "            description='If the credentials are global or user-specific',",
            "            required=False,",
            "        ),",
            "    ]",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobUserCredentialsReadResponse, description='Return information about credentials'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the credentials'),",
            "            404: OpenApiResponse(GenericResponse, description='Credentials not exist'),",
            "        },",
            "        summary='Return information about a set of credentials.',",
            "        operation_id='credentials_view',",
            "        parameters=parameters,",
            "    )",
            "    def get(self, request, credentials_id: int):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsReadResponse",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsReadResponse",
            "",
            "        credentials = _find_credentials(",
            "            credentials_id=credentials_id,",
            "            are_global=are_global,",
            "            user=user,",
            "        )",
            "        if credentials is None:",
            "            base_msg = f\"{_log_global_user(are_global)} with ID {credentials_id} do not exist\"",
            "            if not are_global:",
            "                return Response(data={'msg': f\"{base_msg} or belong to another user\"}, status=404)",
            "",
            "            return Response(data={'msg': base_msg}, status=404)",
            "",
            "        if are_global and not has_credentials_permission(",
            "            user=user,",
            "            credentials=credentials,",
            "            permission_needed=CHOICE_PERMISSION_READ,",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' are not viewable\"},",
            "                status=403,",
            "            )",
            "",
            "        return Response(data=self.serializer_class(instance=credentials).data, status=200)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Credentials'),",
            "        summary='Delete credentials.',",
            "        operation_id='credentials_delete',",
            "        parameters=parameters,",
            "    )",
            "    def delete(self, request, credentials_id: int):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsReadResponse",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsReadResponse",
            "",
            "        credentials = _find_credentials(",
            "            credentials_id=credentials_id,",
            "            are_global=are_global,",
            "            user=user,",
            "        )",
            "        if credentials is None:",
            "            base_msg = f\"{_log_global_user(are_global)} with ID {credentials_id} do not exist\"",
            "            if not are_global:",
            "                return Response(data={'msg': f\"{base_msg} or belong to another user\"}, status=404)",
            "",
            "            return Response(data={'msg': base_msg}, status=404)",
            "",
            "        if are_global and not has_credentials_permission(",
            "            user=user,",
            "            credentials=credentials,",
            "            permission_needed=CHOICE_PERMISSION_DELETE,",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"Not privileged to delete the {_log_global_user(are_global, lower=True)} \"",
            "                             f\"'{credentials.name}'\"},",
            "                status=403)",
            "",
            "        if credentials_in_use(credentials):",
            "            return Response(",
            "                data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' cannot be deleted \"",
            "                             \"as they are still in use\"},",
            "                status=400,",
            "            )",
            "",
            "        credentials.delete()",
            "        return Response(data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' deleted\"}, status=200)",
            "",
            "    @extend_schema(",
            "        request=JobGlobalCredentialsWriteRequest,",
            "        responses=api_docs_put('Credentials'),",
            "        summary='Modify credentials.',",
            "        operation_id='credentials_edit',",
            "        parameters=parameters,",
            "    )",
            "    def put(self, request, credentials_id: int):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsWriteRequest",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsWriteRequest",
            "",
            "        credentials = _find_credentials(",
            "            credentials_id=credentials_id,",
            "            are_global=are_global,",
            "            user=user,",
            "        )",
            "        if credentials is None:",
            "            base_msg = f\"{_log_global_user(are_global)} with ID {credentials_id} do not exist\"",
            "            if not are_global:",
            "                return Response(data={'msg': f\"{base_msg} or belong to another user\"}, status=404)",
            "",
            "            return Response(data={'msg': base_msg}, status=404)",
            "",
            "        if are_global and not has_credentials_permission(",
            "            user=user,",
            "            credentials=credentials,",
            "            permission_needed=CHOICE_PERMISSION_WRITE,",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"Not privileged to modify the {_log_global_user(are_global, lower=True)} \"",
            "                             f\"'{credentials.name}'\"},",
            "                status=403,",
            "            )",
            "",
            "        serializer = self.serializer_class(data=request.data)",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global, lower=True)} data is not valid: \"",
            "                             f\"'{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            # not working with password properties: 'Job.objects.filter(id=job_id).update(**serializer.data)'",
            "            for field, value in serializer.validated_data.items():",
            "                if field in BaseJobCredentials.SECRET_ATTRS:",
            "                    if (field not in BaseJobCredentials.EMPTY_ATTRS and is_null(value)) or value == SECRET_HIDDEN:",
            "                        value = getattr(credentials, field)",
            "",
            "                    elif field == 'ssh_key':",
            "                        value = _validate_and_fix_ssh_key(value)",
            "                        if value is None:",
            "                            return Response(",
            "                                data={'msg': f\"Provided {_log_global_user(are_global)} ssh-key is not valid'\"},",
            "                                status=400,",
            "                            )",
            "",
            "                elif field == 'user':",
            "                    continue",
            "",
            "                setattr(credentials, field, value)",
            "",
            "            if not are_global:",
            "                credentials.user = user",
            "",
            "            credentials.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global, lower=True)} data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response(data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' updated\"}, status=200)"
        ],
        "afterPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.views import APIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiParameter",
            "",
            "from aw.model.job import Job, JobExecution",
            "from aw.model.job_credential import BaseJobCredentials, JobUserCredentials, JobGlobalCredentials",
            "from aw.model.permission import CHOICE_PERMISSION_READ, CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE",
            "from aw.api_endpoints.base import API_PERMISSION, get_api_user, GenericResponse, BaseResponse, api_docs_delete, \\",
            "    api_docs_put, api_docs_post, validate_no_xss",
            "from aw.utils.permission import has_credentials_permission, has_manager_privileges",
            "from aw.config.hardcoded import SECRET_HIDDEN",
            "from aw.utils.util import is_null",
            "from aw.base import USERS",
            "",
            "",
            "class JobGlobalCredentialsReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobGlobalCredentials",
            "        fields = JobGlobalCredentials.api_fields_read",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        for secret_attr in BaseJobCredentials.SECRET_ATTRS:",
            "            setattr(self, f'{secret_attr}_is_set', serializers.BooleanField(required=False))",
            "",
            "",
            "class JobUserCredentialsReadResponse(JobGlobalCredentialsReadResponse):",
            "    class Meta:",
            "        model = JobUserCredentials",
            "        fields = JobUserCredentials.api_fields_read",
            "",
            "",
            "class JobCredentialsList(BaseResponse):",
            "    # NOTE: 'global' attribute not usable..",
            "    shared = serializers.ListSerializer(child=JobGlobalCredentialsReadResponse())",
            "    user = serializers.ListSerializer(child=JobUserCredentialsReadResponse())",
            "",
            "",
            "class JobGlobalCredentialsWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobGlobalCredentials",
            "        fields = JobGlobalCredentials.api_fields_write",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "    vault_pass = serializers.CharField(max_length=100, required=False, default=None, allow_blank=True)",
            "    become_pass = serializers.CharField(max_length=100, required=False, default=None, allow_blank=True)",
            "    connect_pass = serializers.CharField(max_length=100, required=False, default=None, allow_blank=True)",
            "    ssh_key = serializers.CharField(max_length=5000, required=False, default=None, allow_blank=True)",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in JobGlobalCredentials.api_fields_write:",
            "            if field in attrs and field not in BaseJobCredentials.SECRET_ATTRS:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "",
            "class JobUserCredentialsWriteRequest(JobGlobalCredentialsWriteRequest):",
            "    class Meta:",
            "        model = JobUserCredentials",
            "        fields = JobUserCredentials.api_fields_write",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in JobUserCredentials.api_fields_write:",
            "            if field in attrs and field not in BaseJobCredentials.SECRET_ATTRS:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "",
            "def are_global_credentials(request) -> bool:",
            "    if 'global' in request.GET and request.GET['global'] != 'true':",
            "        return False",
            "",
            "    return True",
            "",
            "",
            "def _find_credentials(",
            "        credentials_id: int, are_global: bool, user: USERS",
            ") -> (BaseJobCredentials, None):",
            "    try:",
            "        if are_global:",
            "            return JobGlobalCredentials.objects.get(id=credentials_id)",
            "",
            "        return JobUserCredentials.objects.get(id=credentials_id, user=user)",
            "",
            "    except ObjectDoesNotExist:",
            "        return None",
            "",
            "",
            "def _log_global_user(are_global: bool, lower: bool = False) -> str:",
            "    if are_global:",
            "        msg = 'Global credentials'",
            "",
            "    else:",
            "        msg = 'User credentials'",
            "",
            "    if lower:",
            "        return msg.lower()",
            "",
            "    return msg",
            "",
            "",
            "def credentials_in_use(credentials: BaseJobCredentials) -> bool:",
            "    if isinstance(credentials, JobGlobalCredentials):",
            "        in_use_jobs = Job.objects.filter(credentials_default=credentials).exists()",
            "        in_use_execs = JobExecution.objects.filter(credential_global=credentials).exists()",
            "        in_use = in_use_jobs or in_use_execs",
            "",
            "    else:",
            "        in_use = JobExecution.objects.filter(credential_user=credentials).exists()",
            "",
            "    return in_use",
            "",
            "",
            "SSH_KEY_PREFIX = '-----BEGIN OPENSSH PRIVATE KEY-----'",
            "SSH_KEY_APPENDIX = '-----END OPENSSH PRIVATE KEY-----'",
            "",
            "",
            "def _validate_and_fix_ssh_key(key: str) -> (str, None):",
            "    if key.find(SSH_KEY_PREFIX) == -1:",
            "        # only support unencrypted keys for now",
            "        return None",
            "",
            "    key = key.replace(SSH_KEY_PREFIX, '').replace(SSH_KEY_APPENDIX, '').strip().replace(' ', '\\n')",
            "    return f'{SSH_KEY_PREFIX}\\n{key}\\n{SSH_KEY_APPENDIX}\\n'",
            "",
            "",
            "class APIJobCredentials(APIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "    parameters = [",
            "        OpenApiParameter(",
            "            name='global', type=bool, default=True,",
            "            description='If the credentials are global or user-specific',",
            "            required=False,",
            "        ),",
            "    ]",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobCredentialsList, description='Return list of credentials'),",
            "        },",
            "        summary='Return list of all credentials the current user is privileged to view.',",
            "        operation_id='credentials_list',",
            "    )",
            "    def get(self, request):",
            "        user = get_api_user(request)",
            "        credentials_global = []",
            "        credentials_global_raw = JobGlobalCredentials.objects.all()",
            "        for credentials in credentials_global_raw:",
            "            if has_credentials_permission(",
            "                user=user,",
            "                credentials=credentials,",
            "                permission_needed=CHOICE_PERMISSION_READ,",
            "            ):",
            "                credentials_global.append(JobGlobalCredentialsReadResponse(instance=credentials).data)",
            "",
            "        credentials_user_raw = JobUserCredentials.objects.filter(user=user)",
            "        credentials_user = []",
            "        for credentials in credentials_user_raw:",
            "            credentials_user.append(JobUserCredentialsReadResponse(instance=credentials).data)",
            "",
            "        return Response(data={'shared': credentials_global, 'user': credentials_user}, status=200)",
            "",
            "    @extend_schema(",
            "        request=JobGlobalCredentialsWriteRequest,",
            "        responses=api_docs_post('Credentials'),",
            "        summary='Create credentials.',",
            "        operation_id='credentials_create',",
            "        parameters=parameters,",
            "    )",
            "    def post(self, request):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global and not has_manager_privileges(user=user, kind='credentials'):",
            "            return Response(data={'msg': 'Not privileged to create global credentials'}, status=403)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsWriteRequest",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsWriteRequest",
            "",
            "        serializer = self.serializer_class(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global)} data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        for field in BaseJobCredentials.SECRET_ATTRS:",
            "            value = serializer.validated_data[field]",
            "            if field in BaseJobCredentials.SECRET_ATTRS:",
            "                if is_null(value) or value == SECRET_HIDDEN:",
            "                    serializer.validated_data[field] = None",
            "",
            "                elif field == 'ssh_key':",
            "                    value = _validate_and_fix_ssh_key(value)",
            "                    if value is None:",
            "                        return Response(",
            "                            data={'msg': f\"Provided {_log_global_user(are_global)} ssh-key is not valid'\"},",
            "                            status=400,",
            "                        )",
            "",
            "                    serializer.validated_data[field] = value",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global)} data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response(data={'msg': f'{_log_global_user(are_global, lower=False)} created'}, status=200)",
            "",
            "",
            "class APIJobCredentialsItem(APIView):",
            "    http_method_names = ['get', 'delete', 'put']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "    parameters = [",
            "        OpenApiParameter(",
            "            name='global', type=bool, default=True,",
            "            description='If the credentials are global or user-specific',",
            "            required=False,",
            "        ),",
            "    ]",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobUserCredentialsReadResponse, description='Return information about credentials'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the credentials'),",
            "            404: OpenApiResponse(GenericResponse, description='Credentials not exist'),",
            "        },",
            "        summary='Return information about a set of credentials.',",
            "        operation_id='credentials_view',",
            "        parameters=parameters,",
            "    )",
            "    def get(self, request, credentials_id: int):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsReadResponse",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsReadResponse",
            "",
            "        credentials = _find_credentials(",
            "            credentials_id=credentials_id,",
            "            are_global=are_global,",
            "            user=user,",
            "        )",
            "        if credentials is None:",
            "            base_msg = f\"{_log_global_user(are_global)} with ID {credentials_id} do not exist\"",
            "            if not are_global:",
            "                return Response(data={'msg': f\"{base_msg} or belong to another user\"}, status=404)",
            "",
            "            return Response(data={'msg': base_msg}, status=404)",
            "",
            "        if are_global and not has_credentials_permission(",
            "            user=user,",
            "            credentials=credentials,",
            "            permission_needed=CHOICE_PERMISSION_READ,",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' are not viewable\"},",
            "                status=403,",
            "            )",
            "",
            "        return Response(data=self.serializer_class(instance=credentials).data, status=200)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Credentials'),",
            "        summary='Delete credentials.',",
            "        operation_id='credentials_delete',",
            "        parameters=parameters,",
            "    )",
            "    def delete(self, request, credentials_id: int):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsReadResponse",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsReadResponse",
            "",
            "        credentials = _find_credentials(",
            "            credentials_id=credentials_id,",
            "            are_global=are_global,",
            "            user=user,",
            "        )",
            "        if credentials is None:",
            "            base_msg = f\"{_log_global_user(are_global)} with ID {credentials_id} do not exist\"",
            "            if not are_global:",
            "                return Response(data={'msg': f\"{base_msg} or belong to another user\"}, status=404)",
            "",
            "            return Response(data={'msg': base_msg}, status=404)",
            "",
            "        if are_global and not has_credentials_permission(",
            "            user=user,",
            "            credentials=credentials,",
            "            permission_needed=CHOICE_PERMISSION_DELETE,",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"Not privileged to delete the {_log_global_user(are_global, lower=True)} \"",
            "                             f\"'{credentials.name}'\"},",
            "                status=403)",
            "",
            "        if credentials_in_use(credentials):",
            "            return Response(",
            "                data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' cannot be deleted \"",
            "                             \"as they are still in use\"},",
            "                status=400,",
            "            )",
            "",
            "        credentials.delete()",
            "        return Response(data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' deleted\"}, status=200)",
            "",
            "    @extend_schema(",
            "        request=JobGlobalCredentialsWriteRequest,",
            "        responses=api_docs_put('Credentials'),",
            "        summary='Modify credentials.',",
            "        operation_id='credentials_edit',",
            "        parameters=parameters,",
            "    )",
            "    def put(self, request, credentials_id: int):",
            "        user = get_api_user(request)",
            "        are_global = are_global_credentials(request)",
            "",
            "        if are_global:",
            "            self.serializer_class = JobGlobalCredentialsWriteRequest",
            "",
            "        else:",
            "            self.serializer_class = JobUserCredentialsWriteRequest",
            "",
            "        credentials = _find_credentials(",
            "            credentials_id=credentials_id,",
            "            are_global=are_global,",
            "            user=user,",
            "        )",
            "        if credentials is None:",
            "            base_msg = f\"{_log_global_user(are_global)} with ID {credentials_id} do not exist\"",
            "            if not are_global:",
            "                return Response(data={'msg': f\"{base_msg} or belong to another user\"}, status=404)",
            "",
            "            return Response(data={'msg': base_msg}, status=404)",
            "",
            "        if are_global and not has_credentials_permission(",
            "            user=user,",
            "            credentials=credentials,",
            "            permission_needed=CHOICE_PERMISSION_WRITE,",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"Not privileged to modify the {_log_global_user(are_global, lower=True)} \"",
            "                             f\"'{credentials.name}'\"},",
            "                status=403,",
            "            )",
            "",
            "        serializer = self.serializer_class(data=request.data)",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global, lower=True)} data is not valid: \"",
            "                             f\"'{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            # not working with password properties: 'Job.objects.filter(id=job_id).update(**serializer.data)'",
            "            for field, value in serializer.validated_data.items():",
            "                if field in BaseJobCredentials.SECRET_ATTRS:",
            "                    if (field not in BaseJobCredentials.EMPTY_ATTRS and is_null(value)) or value == SECRET_HIDDEN:",
            "                        value = getattr(credentials, field)",
            "",
            "                    elif field == 'ssh_key':",
            "                        value = _validate_and_fix_ssh_key(value)",
            "                        if value is None:",
            "                            return Response(",
            "                                data={'msg': f\"Provided {_log_global_user(are_global)} ssh-key is not valid'\"},",
            "                                status=400,",
            "                            )",
            "",
            "                elif field == 'user':",
            "                    continue",
            "",
            "                setattr(credentials, field, value)",
            "",
            "            if not are_global:",
            "                credentials.user = user",
            "",
            "            credentials.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided {_log_global_user(are_global, lower=True)} data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response(data={'msg': f\"{_log_global_user(are_global)} '{credentials.name}' updated\"}, status=200)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "12": []
        },
        "addLocation": []
    },
    "src/ansibleguy-webui/aw/api_endpoints/job.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": "     CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE"
            },
            "1": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from aw.model.job_credential import JobGlobalCredentials"
            },
            "2": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " from aw.api_endpoints.base import API_PERMISSION, get_api_user, BaseResponse, GenericResponse, \\"
            },
            "3": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    LogDownloadResponse, api_docs_put, api_docs_delete, api_docs_post"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+    LogDownloadResponse, api_docs_put, api_docs_delete, api_docs_post, validate_no_xss"
            },
            "5": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from aw.api_endpoints.job_util import get_viewable_jobs_serialized, JobReadResponse, get_job_executions_serialized, \\"
            },
            "6": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": "     JobExecutionReadResponse, get_viewable_jobs, get_job_execution_serialized, get_log_file_content"
            },
            "7": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from aw.utils.permission import has_job_permission, has_credentials_permission, has_manager_privileges"
            },
            "8": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 28,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": "     name = serializers.CharField(validators=[])  # uc on update"
            },
            "10": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 30,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+        for field in Job.api_fields_write:"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+            if field in attrs:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 36,
                "PatchRowcode": "+        return attrs"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " def _find_job(job_id: int) -> (Job, None):"
            },
            "20": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "     try:"
            }
        },
        "frontPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.views import APIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiParameter",
            "",
            "from aw.config.hardcoded import JOB_EXECUTION_LIMIT",
            "from aw.model.job import Job, JobExecution",
            "from aw.model.permission import CHOICE_PERMISSION_READ, CHOICE_PERMISSION_EXECUTE, \\",
            "    CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE",
            "from aw.model.job_credential import JobGlobalCredentials",
            "from aw.api_endpoints.base import API_PERMISSION, get_api_user, BaseResponse, GenericResponse, \\",
            "    LogDownloadResponse, api_docs_put, api_docs_delete, api_docs_post",
            "from aw.api_endpoints.job_util import get_viewable_jobs_serialized, JobReadResponse, get_job_executions_serialized, \\",
            "    JobExecutionReadResponse, get_viewable_jobs, get_job_execution_serialized, get_log_file_content",
            "from aw.utils.permission import has_job_permission, has_credentials_permission, has_manager_privileges",
            "from aw.execute.queue import queue_add",
            "from aw.execute.util import update_status, is_execution_status",
            "from aw.utils.util import is_set, ansible_log_html, ansible_log_text",
            "from aw.base import USERS",
            "",
            "",
            "class JobWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = Job",
            "        fields = Job.api_fields_write",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "",
            "",
            "def _find_job(job_id: int) -> (Job, None):",
            "    try:",
            "        return Job.objects.get(id=job_id)",
            "",
            "    except ObjectDoesNotExist:",
            "        return None",
            "",
            "",
            "def _find_job_and_execution(job_id: int, exec_id: int) -> tuple[Job, (JobExecution, None)]:",
            "    job = _find_job(job_id)",
            "    try:",
            "        return job, JobExecution.objects.get(id=exec_id, job=job)",
            "",
            "    except ObjectDoesNotExist:",
            "        return job, None",
            "",
            "",
            "def _job_execution_count(request) -> (int, None):",
            "    max_count = None",
            "    if 'execution_count' in request.GET:",
            "        max_count = int(request.GET['execution_count'])",
            "        max_count = min(max_count, 1000)",
            "",
            "    return max_count",
            "",
            "",
            "def _want_job_executions(request) -> tuple:",
            "    max_count = None",
            "    if 'executions' in request.GET and request.GET['executions'] == 'true':",
            "        try:",
            "            return True, _job_execution_count(request)",
            "",
            "        except TypeError:",
            "            pass",
            "",
            "    return False, max_count",
            "",
            "",
            "def _has_credentials_permission(user: USERS, data: dict) -> bool:",
            "    if 'credentials_default' in data and is_set(data['credentials_default']):",
            "        try:",
            "            credentials = data['credentials_default']",
            "            if not isinstance(credentials, JobGlobalCredentials):",
            "                credentials = JobGlobalCredentials.objects.get(id=credentials)",
            "",
            "            return has_credentials_permission(",
            "                user=user,",
            "                credentials=credentials,",
            "                permission_needed=CHOICE_PERMISSION_READ,",
            "            )",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "    return True",
            "",
            "",
            "class APIJob(APIView):",
            "    http_method_names = ['post', 'get']",
            "    serializer_class = JobReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Return list of jobs'),",
            "        },",
            "        summary='Return list of all jobs the current user is privileged to view.',",
            "        operation_id='job_list',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='executions', type=bool, default=False, description='Return list of job-executions',",
            "                required=False,",
            "            ),",
            "            OpenApiParameter(",
            "                name='execution_count', type=int, default=JOB_EXECUTION_LIMIT,",
            "                description='Maximum count of job-executions to return',",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(request):",
            "        want_exec, exec_count = _want_job_executions(request)",
            "        if want_exec:",
            "            data = get_viewable_jobs_serialized(",
            "                user=get_api_user(request),",
            "                executions=True,",
            "                execution_count=exec_count,",
            "            )",
            "",
            "        else:",
            "            data = get_viewable_jobs_serialized(get_api_user(request))",
            "",
            "        return Response(data=data, status=200)",
            "",
            "    @extend_schema(",
            "        request=JobWriteRequest,",
            "        responses=api_docs_post('Job'),",
            "        summary='Create a new job.',",
            "        operation_id='job_create'",
            "    )",
            "    def post(self, request):",
            "        user = get_api_user(request)",
            "        if not has_manager_privileges(user=user, kind='job'):",
            "            return Response(data={'msg': 'Not privileged to create jobs'}, status=403)",
            "",
            "        serializer = JobWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided job data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        if not _has_credentials_permission(user=user, data=serializer.validated_data):",
            "            return Response(",
            "                data={'msg': \"Not privileged to use provided credentials\"},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided job data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response(data={'msg': 'Job created'}, status=200)",
            "",
            "",
            "class APIJobItem(APIView):",
            "    http_method_names = ['get', 'delete', 'put', 'post']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Return job information'),",
            "            400: OpenApiResponse(GenericResponse, description='Bad parameters provided'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the job'),",
            "            404: OpenApiResponse(JobReadResponse, description='Job does not exist'),",
            "        },",
            "        summary='Return information about a job.',",
            "        operation_id='job_view',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='executions', type=bool, default=False, description='Return list of job-executions',",
            "                required=False,",
            "            ),",
            "            OpenApiParameter(",
            "                name='execution_count', type=int, default=JOB_EXECUTION_LIMIT,",
            "                description='Maximum count of job-executions to return',",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request, job_id: int):",
            "        self.serializer_class = JobReadResponse",
            "        user = get_api_user(request)",
            "        job = _find_job(job_id)",
            "        if job is None:",
            "            return Response(data={'msg': f\"Job with ID {job_id} does not exist\"}, status=404)",
            "",
            "        if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_READ):",
            "            return Response(data={'msg': f\"Job '{job.name}' is not viewable\"}, status=403)",
            "",
            "        data = JobReadResponse(instance=job).data",
            "",
            "        want_exec, exec_count = _want_job_executions(request)",
            "        if want_exec:",
            "            data['executions'] = get_job_executions_serialized(job=job, execution_count=exec_count)",
            "",
            "        return Response(data=data, status=200)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Job'),",
            "        summary='Delete a job.',",
            "        operation_id='job_delete'",
            "    )",
            "    def delete(self, request, job_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job = _find_job(job_id)",
            "",
            "            if job is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_DELETE):",
            "                    return Response(data={'msg': f\"Not privileged to delete the job '{job.name}'\"}, status=403)",
            "",
            "                job.delete()",
            "                return Response(data={'msg': f\"Job '{job.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID {job_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=JobWriteRequest,",
            "        responses=api_docs_put('Job'),",
            "        summary='Modify a job.',",
            "        operation_id='job_edit'",
            "    )",
            "    def put(self, request, job_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job = _find_job(job_id)",
            "",
            "            if job is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_WRITE):",
            "                    return Response(data={'msg': f\"Not privileged to modify the job '{job.name}'\"}, status=403)",
            "",
            "                serializer = JobWriteRequest(data=request.data)",
            "                if not serializer.is_valid():",
            "                    return Response(",
            "                        data={'msg': f\"Provided job data is not valid: '{serializer.errors}'\"},",
            "                        status=400,",
            "                    )",
            "",
            "                if not _has_credentials_permission(user=user, data=serializer.validated_data):",
            "                    return Response(",
            "                        data={'msg': \"Not privileged to use provided credentials\"},",
            "                        status=403,",
            "                    )",
            "",
            "                try:",
            "                    Job.objects.filter(id=job.id).update(**serializer.validated_data)",
            "",
            "                except IntegrityError as err:",
            "                    return Response(",
            "                        data={'msg': f\"Provided job data is not valid: '{err}'\"},",
            "                        status=400,",
            "                    )",
            "",
            "                return Response(data={'msg': f\"Job '{job.name}' updated\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID {job_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Job execution queued'),",
            "            403: OpenApiResponse(JobReadResponse, description='Not privileged to execute the job'),",
            "            404: OpenApiResponse(JobReadResponse, description='Job does not exist'),",
            "        },",
            "        summary='Execute a job.',",
            "        operation_id='job_execute'",
            "    )",
            "    def post(self, request, job_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job = _find_job(job_id)",
            "",
            "            if job is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_EXECUTE):",
            "                    return Response(data={'msg': f\"Not privileged to execute the job '{job.name}'\"}, status=403)",
            "",
            "                queue_add(job=job, user=user)",
            "                return Response(data={'msg': f\"Job '{job.name}' execution queued\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID '{job_id}' does not exist\"}, status=404)",
            "",
            "",
            "class APIJobExecutionItem(APIView):",
            "    http_method_names = ['delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Job execution stopping'),",
            "            400: OpenApiResponse(JobReadResponse, description='Job execution is not running'),",
            "            403: OpenApiResponse(JobReadResponse, description='Not privileged to stop the job'),",
            "            404: OpenApiResponse(JobReadResponse, description='Job or execution does not exist'),",
            "        },",
            "        summary='Stop a running job execution.',",
            "        operation_id='job_exec_stop'",
            "    )",
            "    def delete(self, request, job_id: int, exec_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job, execution = _find_job_and_execution(job_id, exec_id)",
            "",
            "            if job is not None and execution is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_EXECUTE):",
            "                    return Response(data={'msg': f\"Not privileged to stop the job '{job.name}'\"}, status=403)",
            "",
            "                if not is_execution_status(execution, 'Running'):",
            "                    return Response(data={'msg': f\"Job execution '{job.name}' is not running\"}, status=400)",
            "",
            "                update_status(execution, 'Stopping')",
            "                return Response(data={'msg': f\"Job execution '{job.name}' stopping\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID '{job_id}' or execution does not exist\"}, status=404)",
            "",
            "",
            "class JobExecutionLogReadResponse(BaseResponse):",
            "    lines = serializers.ListSerializer(child=serializers.CharField())",
            "",
            "",
            "class APIJobExecutionLogs(APIView):",
            "    http_method_names = ['get']",
            "    serializer_class = JobExecutionLogReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobExecutionLogReadResponse, description='Return job logs'),",
            "            403: OpenApiResponse(JobExecutionLogReadResponse, description='Not privileged to view the job logs'),",
            "            404: OpenApiResponse(JobExecutionLogReadResponse, description='Job, execution or log-file do not exist'),",
            "        },",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='format', type=str, default='html',",
            "                description=\"Format to return - one of 'plain', 'text' or 'html'\",",
            "                required=False,",
            "            ),",
            "        ],",
            "        summary='Get logs of a job execution.',",
            "        operation_id='job_exec_logs'",
            "    )",
            "    def get(self, request, job_id: int, exec_id: int, line_start: int = 0):",
            "        user = get_api_user(request)",
            "",
            "        if 'format' not in request.GET:",
            "            log_fmt = 'html'",
            "",
            "        else:",
            "            log_fmt = str(request.GET['format'])",
            "",
            "        try:",
            "            job, execution = _find_job_and_execution(job_id, exec_id)",
            "",
            "            if job is not None and execution is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_READ):",
            "                    return Response(data={'msg': f\"Not privileged to view logs of the job '{job.name}'\"}, status=403)",
            "",
            "                if execution.log_stdout is None:",
            "                    return Response(data={'msg': f\"No logs found for job '{job.name}'\"}, status=404)",
            "",
            "                with open(execution.log_stdout, 'r', encoding='utf-8') as logfile:",
            "                    lines = logfile.readlines()",
            "                    if log_fmt == 'html':",
            "                        lines = [ansible_log_html(line) for line in lines]",
            "",
            "                    elif log_fmt == 'text':",
            "                        lines = [ansible_log_text(line) for line in lines]",
            "",
            "                    return Response(data={'lines': lines[line_start:]}, status=200)",
            "",
            "        except (ObjectDoesNotExist, FileNotFoundError):",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Job with ID '{job_id}', execution with ID '{exec_id}' or log-file does not exist\"},",
            "            status=404,",
            "        )",
            "",
            "",
            "class APIJobExecutionLogFile(APIView):",
            "    http_method_names = ['get']",
            "    serializer_class = LogDownloadResponse",
            "    permission_classes = API_PERMISSION",
            "    valid_logfile_type = ['stdout', 'stderr', 'stdout_repo', 'stderr_repo']",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(GenericResponse, description='Download job log-file'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the job logs'),",
            "            404: OpenApiResponse(GenericResponse, description='Job, execution or log-file do not exist'),",
            "        },",
            "        summary='Download log-file of a job execution.',",
            "        operation_id='job_exec_logfile',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='type', type=str, default='stdout',",
            "                description=f\"Type of log-file to download. One of {valid_logfile_type}\",",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request, job_id: int, exec_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job, execution = _find_job_and_execution(job_id, exec_id)",
            "",
            "            if job is not None and execution is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_READ):",
            "                    return Response(data={'msg': f\"Not privileged to view logs of the job '{job.name}'\"}, status=403)",
            "",
            "                logfile = execution.log_stdout",
            "                if 'type' in request.GET:",
            "                    logfile_type = request.GET['type'] if request.GET['type'] in self.valid_logfile_type else 'stdout'",
            "                    logfile = getattr(execution, f'log_{logfile_type}')",
            "",
            "                if logfile is None:",
            "                    return Response(data={'msg': f\"No logs found for job '{job.name}'\"}, status=404)",
            "",
            "                return get_log_file_content(logfile)",
            "",
            "        except (ObjectDoesNotExist, FileNotFoundError):",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Job with ID '{job_id}', execution with ID '{exec_id}' or log-file does not exist\"},",
            "            status=404,",
            "        )",
            "",
            "",
            "class APIJobExecution(APIView):",
            "    http_method_names = ['get']",
            "    serializer_class = JobExecutionReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobExecutionReadResponse, description='Return job-execution information'),",
            "        },",
            "        summary='Return list of job-executions the current user is privileged to view.',",
            "        operation_id='job_exec_list',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='execution_count', type=int, default=JOB_EXECUTION_LIMIT,",
            "                description='Maximum count of job-executions to return',",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request):",
            "        jobs = get_viewable_jobs(get_api_user(request))",
            "        exec_count = _job_execution_count(request)",
            "        if exec_count is None:",
            "            exec_count = JOB_EXECUTION_LIMIT",
            "",
            "        serialized = []",
            "        for execution in JobExecution.objects.filter(job__in=jobs).order_by('-updated')[:exec_count]:",
            "            serialized.append(get_job_execution_serialized(execution))",
            "",
            "        return Response(data=serialized, status=200)"
        ],
        "afterPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.views import APIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiParameter",
            "",
            "from aw.config.hardcoded import JOB_EXECUTION_LIMIT",
            "from aw.model.job import Job, JobExecution",
            "from aw.model.permission import CHOICE_PERMISSION_READ, CHOICE_PERMISSION_EXECUTE, \\",
            "    CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE",
            "from aw.model.job_credential import JobGlobalCredentials",
            "from aw.api_endpoints.base import API_PERMISSION, get_api_user, BaseResponse, GenericResponse, \\",
            "    LogDownloadResponse, api_docs_put, api_docs_delete, api_docs_post, validate_no_xss",
            "from aw.api_endpoints.job_util import get_viewable_jobs_serialized, JobReadResponse, get_job_executions_serialized, \\",
            "    JobExecutionReadResponse, get_viewable_jobs, get_job_execution_serialized, get_log_file_content",
            "from aw.utils.permission import has_job_permission, has_credentials_permission, has_manager_privileges",
            "from aw.execute.queue import queue_add",
            "from aw.execute.util import update_status, is_execution_status",
            "from aw.utils.util import is_set, ansible_log_html, ansible_log_text",
            "from aw.base import USERS",
            "",
            "",
            "class JobWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = Job",
            "        fields = Job.api_fields_write",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in Job.api_fields_write:",
            "            if field in attrs:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "",
            "def _find_job(job_id: int) -> (Job, None):",
            "    try:",
            "        return Job.objects.get(id=job_id)",
            "",
            "    except ObjectDoesNotExist:",
            "        return None",
            "",
            "",
            "def _find_job_and_execution(job_id: int, exec_id: int) -> tuple[Job, (JobExecution, None)]:",
            "    job = _find_job(job_id)",
            "    try:",
            "        return job, JobExecution.objects.get(id=exec_id, job=job)",
            "",
            "    except ObjectDoesNotExist:",
            "        return job, None",
            "",
            "",
            "def _job_execution_count(request) -> (int, None):",
            "    max_count = None",
            "    if 'execution_count' in request.GET:",
            "        max_count = int(request.GET['execution_count'])",
            "        max_count = min(max_count, 1000)",
            "",
            "    return max_count",
            "",
            "",
            "def _want_job_executions(request) -> tuple:",
            "    max_count = None",
            "    if 'executions' in request.GET and request.GET['executions'] == 'true':",
            "        try:",
            "            return True, _job_execution_count(request)",
            "",
            "        except TypeError:",
            "            pass",
            "",
            "    return False, max_count",
            "",
            "",
            "def _has_credentials_permission(user: USERS, data: dict) -> bool:",
            "    if 'credentials_default' in data and is_set(data['credentials_default']):",
            "        try:",
            "            credentials = data['credentials_default']",
            "            if not isinstance(credentials, JobGlobalCredentials):",
            "                credentials = JobGlobalCredentials.objects.get(id=credentials)",
            "",
            "            return has_credentials_permission(",
            "                user=user,",
            "                credentials=credentials,",
            "                permission_needed=CHOICE_PERMISSION_READ,",
            "            )",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "    return True",
            "",
            "",
            "class APIJob(APIView):",
            "    http_method_names = ['post', 'get']",
            "    serializer_class = JobReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Return list of jobs'),",
            "        },",
            "        summary='Return list of all jobs the current user is privileged to view.',",
            "        operation_id='job_list',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='executions', type=bool, default=False, description='Return list of job-executions',",
            "                required=False,",
            "            ),",
            "            OpenApiParameter(",
            "                name='execution_count', type=int, default=JOB_EXECUTION_LIMIT,",
            "                description='Maximum count of job-executions to return',",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(request):",
            "        want_exec, exec_count = _want_job_executions(request)",
            "        if want_exec:",
            "            data = get_viewable_jobs_serialized(",
            "                user=get_api_user(request),",
            "                executions=True,",
            "                execution_count=exec_count,",
            "            )",
            "",
            "        else:",
            "            data = get_viewable_jobs_serialized(get_api_user(request))",
            "",
            "        return Response(data=data, status=200)",
            "",
            "    @extend_schema(",
            "        request=JobWriteRequest,",
            "        responses=api_docs_post('Job'),",
            "        summary='Create a new job.',",
            "        operation_id='job_create'",
            "    )",
            "    def post(self, request):",
            "        user = get_api_user(request)",
            "        if not has_manager_privileges(user=user, kind='job'):",
            "            return Response(data={'msg': 'Not privileged to create jobs'}, status=403)",
            "",
            "        serializer = JobWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided job data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        if not _has_credentials_permission(user=user, data=serializer.validated_data):",
            "            return Response(",
            "                data={'msg': \"Not privileged to use provided credentials\"},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided job data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response(data={'msg': 'Job created'}, status=200)",
            "",
            "",
            "class APIJobItem(APIView):",
            "    http_method_names = ['get', 'delete', 'put', 'post']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Return job information'),",
            "            400: OpenApiResponse(GenericResponse, description='Bad parameters provided'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the job'),",
            "            404: OpenApiResponse(JobReadResponse, description='Job does not exist'),",
            "        },",
            "        summary='Return information about a job.',",
            "        operation_id='job_view',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='executions', type=bool, default=False, description='Return list of job-executions',",
            "                required=False,",
            "            ),",
            "            OpenApiParameter(",
            "                name='execution_count', type=int, default=JOB_EXECUTION_LIMIT,",
            "                description='Maximum count of job-executions to return',",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request, job_id: int):",
            "        self.serializer_class = JobReadResponse",
            "        user = get_api_user(request)",
            "        job = _find_job(job_id)",
            "        if job is None:",
            "            return Response(data={'msg': f\"Job with ID {job_id} does not exist\"}, status=404)",
            "",
            "        if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_READ):",
            "            return Response(data={'msg': f\"Job '{job.name}' is not viewable\"}, status=403)",
            "",
            "        data = JobReadResponse(instance=job).data",
            "",
            "        want_exec, exec_count = _want_job_executions(request)",
            "        if want_exec:",
            "            data['executions'] = get_job_executions_serialized(job=job, execution_count=exec_count)",
            "",
            "        return Response(data=data, status=200)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Job'),",
            "        summary='Delete a job.',",
            "        operation_id='job_delete'",
            "    )",
            "    def delete(self, request, job_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job = _find_job(job_id)",
            "",
            "            if job is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_DELETE):",
            "                    return Response(data={'msg': f\"Not privileged to delete the job '{job.name}'\"}, status=403)",
            "",
            "                job.delete()",
            "                return Response(data={'msg': f\"Job '{job.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID {job_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=JobWriteRequest,",
            "        responses=api_docs_put('Job'),",
            "        summary='Modify a job.',",
            "        operation_id='job_edit'",
            "    )",
            "    def put(self, request, job_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job = _find_job(job_id)",
            "",
            "            if job is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_WRITE):",
            "                    return Response(data={'msg': f\"Not privileged to modify the job '{job.name}'\"}, status=403)",
            "",
            "                serializer = JobWriteRequest(data=request.data)",
            "                if not serializer.is_valid():",
            "                    return Response(",
            "                        data={'msg': f\"Provided job data is not valid: '{serializer.errors}'\"},",
            "                        status=400,",
            "                    )",
            "",
            "                if not _has_credentials_permission(user=user, data=serializer.validated_data):",
            "                    return Response(",
            "                        data={'msg': \"Not privileged to use provided credentials\"},",
            "                        status=403,",
            "                    )",
            "",
            "                try:",
            "                    Job.objects.filter(id=job.id).update(**serializer.validated_data)",
            "",
            "                except IntegrityError as err:",
            "                    return Response(",
            "                        data={'msg': f\"Provided job data is not valid: '{err}'\"},",
            "                        status=400,",
            "                    )",
            "",
            "                return Response(data={'msg': f\"Job '{job.name}' updated\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID {job_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Job execution queued'),",
            "            403: OpenApiResponse(JobReadResponse, description='Not privileged to execute the job'),",
            "            404: OpenApiResponse(JobReadResponse, description='Job does not exist'),",
            "        },",
            "        summary='Execute a job.',",
            "        operation_id='job_execute'",
            "    )",
            "    def post(self, request, job_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job = _find_job(job_id)",
            "",
            "            if job is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_EXECUTE):",
            "                    return Response(data={'msg': f\"Not privileged to execute the job '{job.name}'\"}, status=403)",
            "",
            "                queue_add(job=job, user=user)",
            "                return Response(data={'msg': f\"Job '{job.name}' execution queued\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID '{job_id}' does not exist\"}, status=404)",
            "",
            "",
            "class APIJobExecutionItem(APIView):",
            "    http_method_names = ['delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobReadResponse, description='Job execution stopping'),",
            "            400: OpenApiResponse(JobReadResponse, description='Job execution is not running'),",
            "            403: OpenApiResponse(JobReadResponse, description='Not privileged to stop the job'),",
            "            404: OpenApiResponse(JobReadResponse, description='Job or execution does not exist'),",
            "        },",
            "        summary='Stop a running job execution.',",
            "        operation_id='job_exec_stop'",
            "    )",
            "    def delete(self, request, job_id: int, exec_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job, execution = _find_job_and_execution(job_id, exec_id)",
            "",
            "            if job is not None and execution is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_EXECUTE):",
            "                    return Response(data={'msg': f\"Not privileged to stop the job '{job.name}'\"}, status=403)",
            "",
            "                if not is_execution_status(execution, 'Running'):",
            "                    return Response(data={'msg': f\"Job execution '{job.name}' is not running\"}, status=400)",
            "",
            "                update_status(execution, 'Stopping')",
            "                return Response(data={'msg': f\"Job execution '{job.name}' stopping\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Job with ID '{job_id}' or execution does not exist\"}, status=404)",
            "",
            "",
            "class JobExecutionLogReadResponse(BaseResponse):",
            "    lines = serializers.ListSerializer(child=serializers.CharField())",
            "",
            "",
            "class APIJobExecutionLogs(APIView):",
            "    http_method_names = ['get']",
            "    serializer_class = JobExecutionLogReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobExecutionLogReadResponse, description='Return job logs'),",
            "            403: OpenApiResponse(JobExecutionLogReadResponse, description='Not privileged to view the job logs'),",
            "            404: OpenApiResponse(JobExecutionLogReadResponse, description='Job, execution or log-file do not exist'),",
            "        },",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='format', type=str, default='html',",
            "                description=\"Format to return - one of 'plain', 'text' or 'html'\",",
            "                required=False,",
            "            ),",
            "        ],",
            "        summary='Get logs of a job execution.',",
            "        operation_id='job_exec_logs'",
            "    )",
            "    def get(self, request, job_id: int, exec_id: int, line_start: int = 0):",
            "        user = get_api_user(request)",
            "",
            "        if 'format' not in request.GET:",
            "            log_fmt = 'html'",
            "",
            "        else:",
            "            log_fmt = str(request.GET['format'])",
            "",
            "        try:",
            "            job, execution = _find_job_and_execution(job_id, exec_id)",
            "",
            "            if job is not None and execution is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_READ):",
            "                    return Response(data={'msg': f\"Not privileged to view logs of the job '{job.name}'\"}, status=403)",
            "",
            "                if execution.log_stdout is None:",
            "                    return Response(data={'msg': f\"No logs found for job '{job.name}'\"}, status=404)",
            "",
            "                with open(execution.log_stdout, 'r', encoding='utf-8') as logfile:",
            "                    lines = logfile.readlines()",
            "                    if log_fmt == 'html':",
            "                        lines = [ansible_log_html(line) for line in lines]",
            "",
            "                    elif log_fmt == 'text':",
            "                        lines = [ansible_log_text(line) for line in lines]",
            "",
            "                    return Response(data={'lines': lines[line_start:]}, status=200)",
            "",
            "        except (ObjectDoesNotExist, FileNotFoundError):",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Job with ID '{job_id}', execution with ID '{exec_id}' or log-file does not exist\"},",
            "            status=404,",
            "        )",
            "",
            "",
            "class APIJobExecutionLogFile(APIView):",
            "    http_method_names = ['get']",
            "    serializer_class = LogDownloadResponse",
            "    permission_classes = API_PERMISSION",
            "    valid_logfile_type = ['stdout', 'stderr', 'stdout_repo', 'stderr_repo']",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(GenericResponse, description='Download job log-file'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the job logs'),",
            "            404: OpenApiResponse(GenericResponse, description='Job, execution or log-file do not exist'),",
            "        },",
            "        summary='Download log-file of a job execution.',",
            "        operation_id='job_exec_logfile',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='type', type=str, default='stdout',",
            "                description=f\"Type of log-file to download. One of {valid_logfile_type}\",",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request, job_id: int, exec_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            job, execution = _find_job_and_execution(job_id, exec_id)",
            "",
            "            if job is not None and execution is not None:",
            "                if not has_job_permission(user=user, job=job, permission_needed=CHOICE_PERMISSION_READ):",
            "                    return Response(data={'msg': f\"Not privileged to view logs of the job '{job.name}'\"}, status=403)",
            "",
            "                logfile = execution.log_stdout",
            "                if 'type' in request.GET:",
            "                    logfile_type = request.GET['type'] if request.GET['type'] in self.valid_logfile_type else 'stdout'",
            "                    logfile = getattr(execution, f'log_{logfile_type}')",
            "",
            "                if logfile is None:",
            "                    return Response(data={'msg': f\"No logs found for job '{job.name}'\"}, status=404)",
            "",
            "                return get_log_file_content(logfile)",
            "",
            "        except (ObjectDoesNotExist, FileNotFoundError):",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Job with ID '{job_id}', execution with ID '{exec_id}' or log-file does not exist\"},",
            "            status=404,",
            "        )",
            "",
            "",
            "class APIJobExecution(APIView):",
            "    http_method_names = ['get']",
            "    serializer_class = JobExecutionReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(JobExecutionReadResponse, description='Return job-execution information'),",
            "        },",
            "        summary='Return list of job-executions the current user is privileged to view.',",
            "        operation_id='job_exec_list',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='execution_count', type=int, default=JOB_EXECUTION_LIMIT,",
            "                description='Maximum count of job-executions to return',",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request):",
            "        jobs = get_viewable_jobs(get_api_user(request))",
            "        exec_count = _job_execution_count(request)",
            "        if exec_count is None:",
            "            exec_count = JOB_EXECUTION_LIMIT",
            "",
            "        serialized = []",
            "        for execution in JobExecution.objects.filter(job__in=jobs).order_by('-updated')[:exec_count]:",
            "            serialized.append(get_job_execution_serialized(execution))",
            "",
            "        return Response(data=serialized, status=200)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "14": []
        },
        "addLocation": []
    },
    "src/ansibleguy-webui/aw/api_endpoints/permission.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from aw.model.permission import JobPermission, JobPermissionMapping, JobPermissionMemberUser, \\"
            },
            "1": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": "     JobPermissionMemberGroup, JobCredentialsPermissionMapping, JobRepositoryPermissionMapping"
            },
            "2": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, api_docs_put, api_docs_delete, \\"
            },
            "3": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    api_docs_post"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+    api_docs_post, validate_no_xss"
            },
            "5": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from aw.utils.permission import has_manager_privileges"
            },
            "6": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from aw.utils.util import is_set"
            },
            "7": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from aw.base import USERS, GROUPS"
            },
            "8": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 60,
                "PatchRowcode": "         self.fields['users'] = serializers.MultipleChoiceField(choices=[user.id for user in USERS.objects.all()])"
            },
            "9": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "         self.fields['groups'] = serializers.MultipleChoiceField(choices=[group.id for group in GROUPS.objects.all()])"
            },
            "10": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 62,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        for field in JobPermission.api_fields_write:"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+            if field in attrs:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+        return attrs"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "     @staticmethod"
            },
            "19": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "     def create_or_update(validated_data: dict, perm: JobPermission = None):"
            },
            "20": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "         # pylint: disable=R0912,R0915"
            }
        },
        "frontPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.generics import GenericAPIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema",
            "",
            "from aw.model.job import Job",
            "from aw.model.job_credential import JobGlobalCredentials",
            "from aw.model.permission import JobPermission, JobPermissionMapping, JobPermissionMemberUser, \\",
            "    JobPermissionMemberGroup, JobCredentialsPermissionMapping, JobRepositoryPermissionMapping",
            "from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, api_docs_put, api_docs_delete, \\",
            "    api_docs_post",
            "from aw.utils.permission import has_manager_privileges",
            "from aw.utils.util import is_set",
            "from aw.base import USERS, GROUPS",
            "from aw.model.repository import Repository",
            "",
            "",
            "class PermissionReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobPermission",
            "        fields = JobPermission.api_fields_read",
            "",
            "    permission_name = serializers.CharField(required=False)",
            "    jobs = serializers.ListSerializer(child=serializers.IntegerField(), required=False)",
            "    credentials = serializers.ListSerializer(child=serializers.IntegerField(), required=False)",
            "    users_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "    groups_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "    jobs_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "    credentials_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "",
            "",
            "class JobSerializer(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = Job",
            "",
            "",
            "class PermissionWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobPermission",
            "        fields = JobPermission.api_fields_write",
            "",
            "    jobs = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    credentials = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    repositories = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    users = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    groups = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        self.fields['jobs'] = serializers.MultipleChoiceField(choices=[job.id for job in Job.objects.all()])",
            "        self.fields['credentials'] = serializers.MultipleChoiceField(",
            "            choices=[creds.id for creds in JobGlobalCredentials.objects.all()]",
            "        )",
            "        self.fields['repositories'] = serializers.MultipleChoiceField(",
            "            choices=[repo.id for repo in Repository.objects.all()]",
            "        )",
            "        self.fields['users'] = serializers.MultipleChoiceField(choices=[user.id for user in USERS.objects.all()])",
            "        self.fields['groups'] = serializers.MultipleChoiceField(choices=[group.id for group in GROUPS.objects.all()])",
            "",
            "    @staticmethod",
            "    def create_or_update(validated_data: dict, perm: JobPermission = None):",
            "        # pylint: disable=R0912,R0915",
            "        if 'permission' in validated_data:",
            "            permission = validated_data['permission']",
            "        else:",
            "            permission = JobPermission.permission_default",
            "",
            "        if perm is None:",
            "            perm = JobPermission(",
            "                name=validated_data['name'],",
            "                permission=permission,",
            "            )",
            "",
            "        else:",
            "            perm.name = validated_data['name']",
            "            perm.permission = permission",
            "",
            "        if 'jobs_all' in validated_data:",
            "            perm.jobs_all = validated_data['jobs_all']",
            "",
            "        if 'credentials_all' in validated_data:",
            "            perm.credentials_all = validated_data['credentials_all']",
            "",
            "        if 'repositories_all' in validated_data:",
            "            perm.repositories_all = validated_data['repositories_all']",
            "",
            "        perm.save()",
            "",
            "        if 'jobs' in validated_data and is_set(validated_data['jobs']):",
            "            jobs = []",
            "            for job_id in validated_data['jobs']:",
            "                try:",
            "                    jobs.append(Job.objects.get(id=job_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.jobs.set(jobs)",
            "",
            "        if 'credentials' in validated_data and is_set(validated_data['credentials']):",
            "            credentials = []",
            "            for creds_id in validated_data['credentials']:",
            "                try:",
            "                    credentials.append(JobGlobalCredentials.objects.get(id=creds_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.credentials.set(credentials)",
            "",
            "        if 'repositories' in validated_data and is_set(validated_data['repositories']):",
            "            repositories = []",
            "            for repo_id in validated_data['repositories']:",
            "                try:",
            "                    repositories.append(Repository.objects.get(id=repo_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.repositories.set(repositories)",
            "",
            "        if 'users' in validated_data and is_set(validated_data['users']):",
            "            users = []",
            "            for user_id in validated_data['users']:",
            "                try:",
            "                    users.append(USERS.objects.get(id=user_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.users.set(users)",
            "",
            "        if 'groups' in validated_data and is_set(validated_data['groups']):",
            "            groups = []",
            "            for group_id in validated_data['groups']:",
            "                try:",
            "                    groups.append(GROUPS.objects.get(id=group_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.groups.set(groups)",
            "",
            "        perm.save()",
            "",
            "",
            "def build_permissions(perm_id_filter: int = None) -> (list, dict):",
            "    permissions_raw = JobPermission.objects.all()",
            "    permission_jobs_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_jobs_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_credentials_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_credentials_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_repositories_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_repositories_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_users_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_users_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_groups_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_groups_name = {permission.id: [] for permission in permissions_raw}",
            "",
            "    for mapping in JobPermissionMapping.objects.all():",
            "        permission_jobs_id[mapping.permission.id].append(mapping.job.id)",
            "        permission_jobs_name[mapping.permission.id].append(mapping.job.name)",
            "",
            "    for mapping in JobCredentialsPermissionMapping.objects.all():",
            "        permission_credentials_id[mapping.permission.id].append(mapping.credentials.id)",
            "        permission_credentials_name[mapping.permission.id].append(mapping.credentials.name)",
            "",
            "    for mapping in JobRepositoryPermissionMapping.objects.all():",
            "        permission_repositories_id[mapping.permission.id].append(mapping.repository.id)",
            "        permission_repositories_name[mapping.permission.id].append(mapping.repository.name)",
            "",
            "    for mapping in JobPermissionMemberUser.objects.all():",
            "        permission_users_id[mapping.permission.id].append(mapping.user.id)",
            "        permission_users_name[mapping.permission.id].append(mapping.user.username)",
            "",
            "    for mapping in JobPermissionMemberGroup.objects.all():",
            "        permission_groups_id[mapping.permission.id].append(mapping.group.id)",
            "        permission_groups_name[mapping.permission.id].append(mapping.group.name)",
            "",
            "    permissions = []",
            "",
            "    for permission in permissions_raw:",
            "        if perm_id_filter is not None:",
            "            if perm_id_filter != permission.id:",
            "                continue",
            "",
            "        permissions.append({",
            "            'id': permission.id,",
            "            'name': permission.name,",
            "            'permission': permission.permission,",
            "            'permission_name': permission.permission_name,",
            "            'jobs': permission_jobs_id[permission.id],",
            "            'jobs_all': permission.jobs_all,",
            "            'credentials': permission_credentials_id[permission.id],",
            "            'credentials_all': permission.credentials_all,",
            "            'repositories': permission_repositories_id[permission.id],",
            "            'repositories_all': permission.repositories_all,",
            "            'users': permission_users_id[permission.id],",
            "            'groups': permission_groups_id[permission.id],",
            "            'jobs_name': permission_jobs_name[permission.id],",
            "            'credentials_name': permission_credentials_name[permission.id],",
            "            'repositories_name': permission_repositories_name[permission.id],",
            "            'users_name': permission_users_name[permission.id],",
            "            'groups_name': permission_groups_name[permission.id],",
            "        })",
            "",
            "    try:",
            "        if perm_id_filter is not None:",
            "            return permissions[0]",
            "",
            "    except IndexError:",
            "        return {}",
            "",
            "    return permissions",
            "",
            "",
            "def permission_in_use(permission: JobPermission) -> bool:",
            "    in_use_jobs = JobPermissionMapping.objects.filter(permission=permission).exists()",
            "    in_use_creds = JobCredentialsPermissionMapping.objects.filter(permission=permission).exists()",
            "    return in_use_jobs or in_use_creds",
            "",
            "",
            "class APIPermission(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = PermissionReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: PermissionReadResponse},",
            "        summary='Return list of permissions',",
            "        operation_id='permission_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response(build_permissions())",
            "",
            "    @extend_schema(",
            "        request=PermissionWriteRequest,",
            "        responses=api_docs_post('Permission'),",
            "        summary='Create a new Permission.',",
            "        operation_id='permission_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='permission')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage permissions'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = PermissionWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided permission data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.create_or_update(validated_data=serializer.validated_data, perm=None)",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided permission data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Permission '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIPermissionItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: PermissionReadResponse},",
            "        summary='Return information of a permission.',",
            "        operation_id='permission_get'",
            "    )",
            "    def get(request, perm_id: int):",
            "        del request",
            "        return Response(build_permissions(perm_id_filter=perm_id))",
            "",
            "    @extend_schema(",
            "        request=PermissionWriteRequest,",
            "        responses=api_docs_put('Permission'),",
            "        summary='Modify a permission.',",
            "        operation_id='permission_edit',",
            "    )",
            "    def put(self, request, perm_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='permission')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage permissions'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = PermissionWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided permission data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            permission = JobPermission.objects.get(id=perm_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            permission = None",
            "",
            "        if permission is None:",
            "            return Response(",
            "                data={'msg': f\"Permission with ID {perm_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            serializer.create_or_update(validated_data=serializer.validated_data, perm=permission)",
            "            return Response(data={'msg': f\"Permission '{permission.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided permission data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Permission'),",
            "        summary='Delete a permission.',",
            "        operation_id='permission_delete'",
            "    )",
            "    def delete(self, request, perm_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='permission')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage permissions'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            permission = JobPermission.objects.get(id=perm_id)",
            "            if permission is not None:",
            "                if permission_in_use(permission):",
            "                    return Response(",
            "                        data={'msg': f\"Permission '{permission.name}' cannot be deleted as it is still in use\"},",
            "                        status=400,",
            "                    )",
            "",
            "                permission.delete()",
            "                return Response(data={'msg': f\"Permission '{permission.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Permission with ID {perm_id} does not exist\"}, status=404)"
        ],
        "afterPatchFile": [
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.generics import GenericAPIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema",
            "",
            "from aw.model.job import Job",
            "from aw.model.job_credential import JobGlobalCredentials",
            "from aw.model.permission import JobPermission, JobPermissionMapping, JobPermissionMemberUser, \\",
            "    JobPermissionMemberGroup, JobCredentialsPermissionMapping, JobRepositoryPermissionMapping",
            "from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, api_docs_put, api_docs_delete, \\",
            "    api_docs_post, validate_no_xss",
            "from aw.utils.permission import has_manager_privileges",
            "from aw.utils.util import is_set",
            "from aw.base import USERS, GROUPS",
            "from aw.model.repository import Repository",
            "",
            "",
            "class PermissionReadResponse(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobPermission",
            "        fields = JobPermission.api_fields_read",
            "",
            "    permission_name = serializers.CharField(required=False)",
            "    jobs = serializers.ListSerializer(child=serializers.IntegerField(), required=False)",
            "    credentials = serializers.ListSerializer(child=serializers.IntegerField(), required=False)",
            "    users_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "    groups_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "    jobs_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "    credentials_name = serializers.ListSerializer(child=serializers.CharField(), required=False)",
            "",
            "",
            "class JobSerializer(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = Job",
            "",
            "",
            "class PermissionWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = JobPermission",
            "        fields = JobPermission.api_fields_write",
            "",
            "    jobs = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    credentials = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    repositories = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    users = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    groups = serializers.MultipleChoiceField(allow_blank=True, choices=[])",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        self.fields['jobs'] = serializers.MultipleChoiceField(choices=[job.id for job in Job.objects.all()])",
            "        self.fields['credentials'] = serializers.MultipleChoiceField(",
            "            choices=[creds.id for creds in JobGlobalCredentials.objects.all()]",
            "        )",
            "        self.fields['repositories'] = serializers.MultipleChoiceField(",
            "            choices=[repo.id for repo in Repository.objects.all()]",
            "        )",
            "        self.fields['users'] = serializers.MultipleChoiceField(choices=[user.id for user in USERS.objects.all()])",
            "        self.fields['groups'] = serializers.MultipleChoiceField(choices=[group.id for group in GROUPS.objects.all()])",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in JobPermission.api_fields_write:",
            "            if field in attrs:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "    @staticmethod",
            "    def create_or_update(validated_data: dict, perm: JobPermission = None):",
            "        # pylint: disable=R0912,R0915",
            "        if 'permission' in validated_data:",
            "            permission = validated_data['permission']",
            "        else:",
            "            permission = JobPermission.permission_default",
            "",
            "        if perm is None:",
            "            perm = JobPermission(",
            "                name=validated_data['name'],",
            "                permission=permission,",
            "            )",
            "",
            "        else:",
            "            perm.name = validated_data['name']",
            "            perm.permission = permission",
            "",
            "        if 'jobs_all' in validated_data:",
            "            perm.jobs_all = validated_data['jobs_all']",
            "",
            "        if 'credentials_all' in validated_data:",
            "            perm.credentials_all = validated_data['credentials_all']",
            "",
            "        if 'repositories_all' in validated_data:",
            "            perm.repositories_all = validated_data['repositories_all']",
            "",
            "        perm.save()",
            "",
            "        if 'jobs' in validated_data and is_set(validated_data['jobs']):",
            "            jobs = []",
            "            for job_id in validated_data['jobs']:",
            "                try:",
            "                    jobs.append(Job.objects.get(id=job_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.jobs.set(jobs)",
            "",
            "        if 'credentials' in validated_data and is_set(validated_data['credentials']):",
            "            credentials = []",
            "            for creds_id in validated_data['credentials']:",
            "                try:",
            "                    credentials.append(JobGlobalCredentials.objects.get(id=creds_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.credentials.set(credentials)",
            "",
            "        if 'repositories' in validated_data and is_set(validated_data['repositories']):",
            "            repositories = []",
            "            for repo_id in validated_data['repositories']:",
            "                try:",
            "                    repositories.append(Repository.objects.get(id=repo_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.repositories.set(repositories)",
            "",
            "        if 'users' in validated_data and is_set(validated_data['users']):",
            "            users = []",
            "            for user_id in validated_data['users']:",
            "                try:",
            "                    users.append(USERS.objects.get(id=user_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.users.set(users)",
            "",
            "        if 'groups' in validated_data and is_set(validated_data['groups']):",
            "            groups = []",
            "            for group_id in validated_data['groups']:",
            "                try:",
            "                    groups.append(GROUPS.objects.get(id=group_id))",
            "",
            "                except ObjectDoesNotExist:",
            "                    continue",
            "",
            "            perm.groups.set(groups)",
            "",
            "        perm.save()",
            "",
            "",
            "def build_permissions(perm_id_filter: int = None) -> (list, dict):",
            "    permissions_raw = JobPermission.objects.all()",
            "    permission_jobs_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_jobs_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_credentials_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_credentials_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_repositories_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_repositories_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_users_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_users_name = {permission.id: [] for permission in permissions_raw}",
            "    permission_groups_id = {permission.id: [] for permission in permissions_raw}",
            "    permission_groups_name = {permission.id: [] for permission in permissions_raw}",
            "",
            "    for mapping in JobPermissionMapping.objects.all():",
            "        permission_jobs_id[mapping.permission.id].append(mapping.job.id)",
            "        permission_jobs_name[mapping.permission.id].append(mapping.job.name)",
            "",
            "    for mapping in JobCredentialsPermissionMapping.objects.all():",
            "        permission_credentials_id[mapping.permission.id].append(mapping.credentials.id)",
            "        permission_credentials_name[mapping.permission.id].append(mapping.credentials.name)",
            "",
            "    for mapping in JobRepositoryPermissionMapping.objects.all():",
            "        permission_repositories_id[mapping.permission.id].append(mapping.repository.id)",
            "        permission_repositories_name[mapping.permission.id].append(mapping.repository.name)",
            "",
            "    for mapping in JobPermissionMemberUser.objects.all():",
            "        permission_users_id[mapping.permission.id].append(mapping.user.id)",
            "        permission_users_name[mapping.permission.id].append(mapping.user.username)",
            "",
            "    for mapping in JobPermissionMemberGroup.objects.all():",
            "        permission_groups_id[mapping.permission.id].append(mapping.group.id)",
            "        permission_groups_name[mapping.permission.id].append(mapping.group.name)",
            "",
            "    permissions = []",
            "",
            "    for permission in permissions_raw:",
            "        if perm_id_filter is not None:",
            "            if perm_id_filter != permission.id:",
            "                continue",
            "",
            "        permissions.append({",
            "            'id': permission.id,",
            "            'name': permission.name,",
            "            'permission': permission.permission,",
            "            'permission_name': permission.permission_name,",
            "            'jobs': permission_jobs_id[permission.id],",
            "            'jobs_all': permission.jobs_all,",
            "            'credentials': permission_credentials_id[permission.id],",
            "            'credentials_all': permission.credentials_all,",
            "            'repositories': permission_repositories_id[permission.id],",
            "            'repositories_all': permission.repositories_all,",
            "            'users': permission_users_id[permission.id],",
            "            'groups': permission_groups_id[permission.id],",
            "            'jobs_name': permission_jobs_name[permission.id],",
            "            'credentials_name': permission_credentials_name[permission.id],",
            "            'repositories_name': permission_repositories_name[permission.id],",
            "            'users_name': permission_users_name[permission.id],",
            "            'groups_name': permission_groups_name[permission.id],",
            "        })",
            "",
            "    try:",
            "        if perm_id_filter is not None:",
            "            return permissions[0]",
            "",
            "    except IndexError:",
            "        return {}",
            "",
            "    return permissions",
            "",
            "",
            "def permission_in_use(permission: JobPermission) -> bool:",
            "    in_use_jobs = JobPermissionMapping.objects.filter(permission=permission).exists()",
            "    in_use_creds = JobCredentialsPermissionMapping.objects.filter(permission=permission).exists()",
            "    return in_use_jobs or in_use_creds",
            "",
            "",
            "class APIPermission(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = PermissionReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: PermissionReadResponse},",
            "        summary='Return list of permissions',",
            "        operation_id='permission_list',",
            "    )",
            "    def get(request):",
            "        del request",
            "        return Response(build_permissions())",
            "",
            "    @extend_schema(",
            "        request=PermissionWriteRequest,",
            "        responses=api_docs_post('Permission'),",
            "        summary='Create a new Permission.',",
            "        operation_id='permission_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='permission')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage permissions'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = PermissionWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided permission data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            serializer.create_or_update(validated_data=serializer.validated_data, perm=None)",
            "",
            "        except IntegrityError as err:",
            "            return Response(",
            "                data={'msg': f\"Provided permission data is not valid: '{err}'\"},",
            "                status=400,",
            "            )",
            "",
            "        return Response({'msg': f\"Permission '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIPermissionItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: PermissionReadResponse},",
            "        summary='Return information of a permission.',",
            "        operation_id='permission_get'",
            "    )",
            "    def get(request, perm_id: int):",
            "        del request",
            "        return Response(build_permissions(perm_id_filter=perm_id))",
            "",
            "    @extend_schema(",
            "        request=PermissionWriteRequest,",
            "        responses=api_docs_put('Permission'),",
            "        summary='Modify a permission.',",
            "        operation_id='permission_edit',",
            "    )",
            "    def put(self, request, perm_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='permission')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage permissions'},",
            "                status=403,",
            "            )",
            "",
            "        serializer = PermissionWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(",
            "                data={'msg': f\"Provided permission data is not valid: '{serializer.errors}'\"},",
            "                status=400,",
            "            )",
            "",
            "        try:",
            "            permission = JobPermission.objects.get(id=perm_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            permission = None",
            "",
            "        if permission is None:",
            "            return Response(",
            "                data={'msg': f\"Permission with ID {perm_id} does not exist\"},",
            "                status=404,",
            "            )",
            "",
            "        try:",
            "            serializer.create_or_update(validated_data=serializer.validated_data, perm=permission)",
            "            return Response(data={'msg': f\"Permission '{permission.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided permission data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Permission'),",
            "        summary='Delete a permission.',",
            "        operation_id='permission_delete'",
            "    )",
            "    def delete(self, request, perm_id: int):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='permission')",
            "        if not privileged:",
            "            return Response(",
            "                data={'msg': 'Not privileged to manage permissions'},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            permission = JobPermission.objects.get(id=perm_id)",
            "            if permission is not None:",
            "                if permission_in_use(permission):",
            "                    return Response(",
            "                        data={'msg': f\"Permission '{permission.name}' cannot be deleted as it is still in use\"},",
            "                        status=400,",
            "                    )",
            "",
            "                permission.delete()",
            "                return Response(data={'msg': f\"Permission '{permission.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Permission with ID {perm_id} does not exist\"}, status=404)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "13": []
        },
        "addLocation": []
    },
    "src/ansibleguy-webui/aw/api_endpoints/repository.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " from aw.model.repository import Repository"
            },
            "2": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, LogDownloadResponse, api_docs_put, \\"
            },
            "3": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    api_docs_delete, api_docs_post"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+    api_docs_delete, api_docs_post, validate_no_xss"
            },
            "5": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from aw.utils.permission import has_manager_privileges, has_repository_permission, get_viewable_repositories"
            },
            "6": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " from aw.model.job import Job"
            },
            "7": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from aw.utils.util import unset_or_null, is_set"
            },
            "8": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 28,
                "PatchRowcode": "     name = serializers.CharField(validators=[])  # uc on update"
            },
            "10": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 29,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+    def validate(self, attrs: dict):"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+        for field in Repository.api_fields_write:"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+            if field in attrs:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+                validate_no_xss(value=attrs[field], field=field)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+        return attrs"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 36,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " "
            },
            "19": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " class RepositoryReadResponse(RepositoryWriteRequest):"
            },
            "20": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "     class Meta:"
            }
        },
        "frontPatchFile": [
            "from threading import Thread",
            "from pathlib import Path",
            "",
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.generics import GenericAPIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiParameter",
            "",
            "from aw.model.repository import Repository",
            "from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, LogDownloadResponse, api_docs_put, \\",
            "    api_docs_delete, api_docs_post",
            "from aw.utils.permission import has_manager_privileges, has_repository_permission, get_viewable_repositories",
            "from aw.model.job import Job",
            "from aw.utils.util import unset_or_null, is_set",
            "from aw.model.permission import CHOICE_PERMISSION_READ, CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE, \\",
            "    CHOICE_PERMISSION_EXECUTE",
            "from aw.execute.repository import api_update_repository",
            "from aw.api_endpoints.job_util import get_log_file_content",
            "",
            "",
            "class RepositoryWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = Repository",
            "        fields = Repository.api_fields_write",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "",
            "",
            "class RepositoryReadResponse(RepositoryWriteRequest):",
            "    class Meta:",
            "        model = Repository",
            "        fields = Repository.api_fields_read",
            "",
            "    rtype_name = serializers.CharField()",
            "    status_name = serializers.CharField()",
            "    log_stdout_url = serializers.CharField()",
            "    log_stderr_url = serializers.CharField()",
            "",
            "",
            "def repository_in_use(repository: Repository) -> bool:",
            "    return Job.objects.filter(repository=repository).exists()",
            "",
            "",
            "def validate_repository_types(repository: dict) -> (bool, str):",
            "    rtype_name = Repository.rtype_name_from_id(repository['rtype'])",
            "    if rtype_name == 'Git':",
            "        try:",
            "            if is_set(repository['git_override_initialize']) and is_set(repository['git_override_update']):",
            "                return True, ''",
            "",
            "        except KeyError:",
            "            pass",
            "",
            "        if unset_or_null(repository, 'git_origin'):",
            "            return False, 'Git Origin is required'",
            "",
            "        if unset_or_null(repository, 'git_branch'):",
            "            return False, 'Git Branch is required'",
            "",
            "    else:",
            "        if unset_or_null(repository, 'static_path'):",
            "            return False, 'Static Path is required'",
            "",
            "    return True, ''",
            "",
            "",
            "def build_repository(repository: Repository) -> dict:",
            "    data = RepositoryReadResponse(instance=repository).data",
            "    data['time_update'] = repository.time_update_str",
            "    if data['log_stderr'] is None or not Path(data['log_stderr']).is_file():",
            "        data['log_stderr'] = None",
            "        data['log_stderr_url'] = None",
            "",
            "    return data",
            "",
            "",
            "class APIRepository(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = RepositoryReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: RepositoryReadResponse},",
            "        summary='Return list of repositories',",
            "        operation_id='repository_list',",
            "    )",
            "    def get(request):",
            "        user = get_api_user(request)",
            "        repositories = []",
            "",
            "        for repository in get_viewable_repositories(user=user):",
            "            repositories.append(build_repository(repository))",
            "",
            "        return Response(data=repositories, status=200)",
            "",
            "    @extend_schema(",
            "        request=RepositoryWriteRequest,",
            "        responses=api_docs_post('Repository'),",
            "        summary='Create a new Repository.',",
            "        operation_id='repository_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='repository')",
            "        if not privileged:",
            "            return Response(data={'msg': 'Not privileged to manage repositories'}, status=403)",
            "",
            "        serializer = RepositoryWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{serializer.errors}'\"}, status=400)",
            "",
            "        rtype_valid, rtype_error = validate_repository_types(serializer.validated_data)",
            "        if not rtype_valid:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{rtype_error}'\"}, status=400)",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{err}'\"}, status=400)",
            "",
            "        return Response({'msg': f\"Repository '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIRepositoryItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'post', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: RepositoryReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Repository does not exist'),",
            "        },",
            "        summary='Return information of a repository.',",
            "        operation_id='repository_get'",
            "    )",
            "    def get(request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if not has_repository_permission(",
            "                    user=user,",
            "                    repository=repository,",
            "                    permission_needed=CHOICE_PERMISSION_READ",
            "            ):",
            "                return Response(",
            "                    data={'msg': f\"Not privileged to view the repository '{repository.name}'\"},",
            "                    status=403,",
            "                )",
            "",
            "            return Response(data=build_repository(repository), status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=RepositoryWriteRequest,",
            "        responses=api_docs_put('Repository'),",
            "        summary='Modify a repository.',",
            "        operation_id='repository_edit',",
            "    )",
            "    def put(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        serializer = RepositoryWriteRequest(data=request.data)",
            "        if not serializer.is_valid():",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{serializer.errors}'\"}, status=400)",
            "",
            "        rtype_valid, rtype_error = validate_repository_types(serializer.validated_data)",
            "        if not rtype_valid:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{rtype_error}'\"}, status=400)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            repository = None",
            "",
            "        if repository is None:",
            "            return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "        if not has_repository_permission(",
            "                user=user,",
            "                repository=repository,",
            "                permission_needed=CHOICE_PERMISSION_WRITE",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"Not privileged to modify the repository '{repository.name}'\"},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            Repository.objects.filter(id=repo_id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Repository '{repository.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Repository'),",
            "        summary='Delete a repository.',",
            "        operation_id='repository_delete'",
            "    )",
            "    def delete(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if repository is not None:",
            "                if not has_repository_permission(",
            "                        user=user,",
            "                        repository=repository,",
            "                        permission_needed=CHOICE_PERMISSION_DELETE",
            "                ):",
            "                    return Response(",
            "                        data={'msg': f\"Not privileged to delete the repository '{repository.name}'\"},",
            "                        status=403,",
            "                    )",
            "",
            "                if repository_in_use(repository):",
            "                    return Response(",
            "                        data={'msg': f\"Repository '{repository.name}' cannot be deleted as it is still in use\"},",
            "                        status=400,",
            "                    )",
            "",
            "                repository.delete()",
            "                return Response(data={'msg': f\"Repository '{repository.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(response=GenericResponse, description='Repository update initiated'),",
            "            403: OpenApiResponse(response=GenericResponse, description='Not privileged to update the repository'),",
            "            404: OpenApiResponse(response=GenericResponse, description='Repository does not exist'),",
            "        },",
            "        summary='Download/Update a repository.',",
            "        operation_id='repository_update'",
            "    )",
            "    def post(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if repository is not None:",
            "                if not has_repository_permission(",
            "                        user=user,",
            "                        repository=repository,",
            "                        permission_needed=CHOICE_PERMISSION_EXECUTE,",
            "                ):",
            "                    return Response(",
            "                        data={'msg': f\"Not privileged to update the repository '{repository.name}'\"},",
            "                        status=403,",
            "                    )",
            "",
            "                repository_update_thread = Thread(",
            "                    target=api_update_repository,",
            "                    kwargs={'repository': repository, 'user': user}",
            "                )",
            "                repository_update_thread.start()",
            "",
            "                return Response(data={'msg': f\"Repository '{repository.name}' update initiated\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "",
            "class APIRepositoryLogFile(GenericAPIView):",
            "    http_method_names = ['get']",
            "    serializer_class = LogDownloadResponse",
            "    permission_classes = API_PERMISSION",
            "    valid_logfile_type = ['stdout', 'stderr']",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(GenericResponse, description='Download repository log-file'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the repository logs'),",
            "            404: OpenApiResponse(GenericResponse, description='Repository or log-file dos not exist'),",
            "        },",
            "        summary='Download log-file of the last repository update.',",
            "        operation_id='repository_logfile',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='type', type=str, default='stdout',",
            "                description=f\"Type of log-file to download. One of {valid_logfile_type}\",",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if repository is not None:",
            "                if not has_repository_permission(",
            "                        user=user,",
            "                        repository=repository,",
            "                        permission_needed=CHOICE_PERMISSION_READ,",
            "                ):",
            "                    return Response(",
            "                        data={'msg': f\"Not privileged to view logs of the repository '{repository.name}'\"},",
            "                        status=403,",
            "                    )",
            "",
            "                logfile = repository.log_stdout",
            "                if 'type' in request.GET:",
            "                    logfile_type = request.GET['type'] if request.GET['type'] in self.valid_logfile_type else 'stdout'",
            "                    logfile = getattr(repository, f'log_{logfile_type}')",
            "",
            "                if logfile is None:",
            "                    return Response(data={'msg': f\"No logs found for repository '{repository.name}'\"}, status=404)",
            "",
            "                return get_log_file_content(logfile)",
            "",
            "        except (ObjectDoesNotExist, FileNotFoundError):",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Repository with ID '{repo_id}' or log-file does not exist\"},",
            "            status=404,",
            "        )"
        ],
        "afterPatchFile": [
            "from threading import Thread",
            "from pathlib import Path",
            "",
            "from django.core.exceptions import ObjectDoesNotExist",
            "from django.db.utils import IntegrityError",
            "from rest_framework.generics import GenericAPIView",
            "from rest_framework import serializers",
            "from rest_framework.response import Response",
            "from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiParameter",
            "",
            "from aw.model.repository import Repository",
            "from aw.api_endpoints.base import API_PERMISSION, GenericResponse, get_api_user, LogDownloadResponse, api_docs_put, \\",
            "    api_docs_delete, api_docs_post, validate_no_xss",
            "from aw.utils.permission import has_manager_privileges, has_repository_permission, get_viewable_repositories",
            "from aw.model.job import Job",
            "from aw.utils.util import unset_or_null, is_set",
            "from aw.model.permission import CHOICE_PERMISSION_READ, CHOICE_PERMISSION_WRITE, CHOICE_PERMISSION_DELETE, \\",
            "    CHOICE_PERMISSION_EXECUTE",
            "from aw.execute.repository import api_update_repository",
            "from aw.api_endpoints.job_util import get_log_file_content",
            "",
            "",
            "class RepositoryWriteRequest(serializers.ModelSerializer):",
            "    class Meta:",
            "        model = Repository",
            "        fields = Repository.api_fields_write",
            "",
            "    name = serializers.CharField(validators=[])  # uc on update",
            "",
            "    def validate(self, attrs: dict):",
            "        for field in Repository.api_fields_write:",
            "            if field in attrs:",
            "                validate_no_xss(value=attrs[field], field=field)",
            "",
            "        return attrs",
            "",
            "",
            "class RepositoryReadResponse(RepositoryWriteRequest):",
            "    class Meta:",
            "        model = Repository",
            "        fields = Repository.api_fields_read",
            "",
            "    rtype_name = serializers.CharField()",
            "    status_name = serializers.CharField()",
            "    log_stdout_url = serializers.CharField()",
            "    log_stderr_url = serializers.CharField()",
            "",
            "",
            "def repository_in_use(repository: Repository) -> bool:",
            "    return Job.objects.filter(repository=repository).exists()",
            "",
            "",
            "def validate_repository_types(repository: dict) -> (bool, str):",
            "    rtype_name = Repository.rtype_name_from_id(repository['rtype'])",
            "    if rtype_name == 'Git':",
            "        try:",
            "            if is_set(repository['git_override_initialize']) and is_set(repository['git_override_update']):",
            "                return True, ''",
            "",
            "        except KeyError:",
            "            pass",
            "",
            "        if unset_or_null(repository, 'git_origin'):",
            "            return False, 'Git Origin is required'",
            "",
            "        if unset_or_null(repository, 'git_branch'):",
            "            return False, 'Git Branch is required'",
            "",
            "    else:",
            "        if unset_or_null(repository, 'static_path'):",
            "            return False, 'Static Path is required'",
            "",
            "    return True, ''",
            "",
            "",
            "def build_repository(repository: Repository) -> dict:",
            "    data = RepositoryReadResponse(instance=repository).data",
            "    data['time_update'] = repository.time_update_str",
            "    if data['log_stderr'] is None or not Path(data['log_stderr']).is_file():",
            "        data['log_stderr'] = None",
            "        data['log_stderr_url'] = None",
            "",
            "    return data",
            "",
            "",
            "class APIRepository(GenericAPIView):",
            "    http_method_names = ['get', 'post']",
            "    serializer_class = RepositoryReadResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={200: RepositoryReadResponse},",
            "        summary='Return list of repositories',",
            "        operation_id='repository_list',",
            "    )",
            "    def get(request):",
            "        user = get_api_user(request)",
            "        repositories = []",
            "",
            "        for repository in get_viewable_repositories(user=user):",
            "            repositories.append(build_repository(repository))",
            "",
            "        return Response(data=repositories, status=200)",
            "",
            "    @extend_schema(",
            "        request=RepositoryWriteRequest,",
            "        responses=api_docs_post('Repository'),",
            "        summary='Create a new Repository.',",
            "        operation_id='repository_create',",
            "    )",
            "    def post(self, request):",
            "        privileged = has_manager_privileges(user=get_api_user(request), kind='repository')",
            "        if not privileged:",
            "            return Response(data={'msg': 'Not privileged to manage repositories'}, status=403)",
            "",
            "        serializer = RepositoryWriteRequest(data=request.data)",
            "",
            "        if not serializer.is_valid():",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{serializer.errors}'\"}, status=400)",
            "",
            "        rtype_valid, rtype_error = validate_repository_types(serializer.validated_data)",
            "        if not rtype_valid:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{rtype_error}'\"}, status=400)",
            "",
            "        try:",
            "            serializer.save()",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{err}'\"}, status=400)",
            "",
            "        return Response({'msg': f\"Repository '{serializer.validated_data['name']}' created successfully\"})",
            "",
            "",
            "class APIRepositoryItem(GenericAPIView):",
            "    http_method_names = ['get', 'put', 'post', 'delete']",
            "    serializer_class = GenericResponse",
            "    permission_classes = API_PERMISSION",
            "",
            "    @staticmethod",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: RepositoryReadResponse,",
            "            404: OpenApiResponse(response=GenericResponse, description='Repository does not exist'),",
            "        },",
            "        summary='Return information of a repository.',",
            "        operation_id='repository_get'",
            "    )",
            "    def get(request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if not has_repository_permission(",
            "                    user=user,",
            "                    repository=repository,",
            "                    permission_needed=CHOICE_PERMISSION_READ",
            "            ):",
            "                return Response(",
            "                    data={'msg': f\"Not privileged to view the repository '{repository.name}'\"},",
            "                    status=403,",
            "                )",
            "",
            "            return Response(data=build_repository(repository), status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=RepositoryWriteRequest,",
            "        responses=api_docs_put('Repository'),",
            "        summary='Modify a repository.',",
            "        operation_id='repository_edit',",
            "    )",
            "    def put(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        serializer = RepositoryWriteRequest(data=request.data)",
            "        if not serializer.is_valid():",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{serializer.errors}'\"}, status=400)",
            "",
            "        rtype_valid, rtype_error = validate_repository_types(serializer.validated_data)",
            "        if not rtype_valid:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{rtype_error}'\"}, status=400)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "",
            "        except ObjectDoesNotExist:",
            "            repository = None",
            "",
            "        if repository is None:",
            "            return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "        if not has_repository_permission(",
            "                user=user,",
            "                repository=repository,",
            "                permission_needed=CHOICE_PERMISSION_WRITE",
            "        ):",
            "            return Response(",
            "                data={'msg': f\"Not privileged to modify the repository '{repository.name}'\"},",
            "                status=403,",
            "            )",
            "",
            "        try:",
            "            Repository.objects.filter(id=repo_id).update(**serializer.validated_data)",
            "            return Response(data={'msg': f\"Repository '{repository.name}' updated\"}, status=200)",
            "",
            "        except IntegrityError as err:",
            "            return Response(data={'msg': f\"Provided repository data is not valid: '{err}'\"}, status=400)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses=api_docs_delete('Repository'),",
            "        summary='Delete a repository.',",
            "        operation_id='repository_delete'",
            "    )",
            "    def delete(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if repository is not None:",
            "                if not has_repository_permission(",
            "                        user=user,",
            "                        repository=repository,",
            "                        permission_needed=CHOICE_PERMISSION_DELETE",
            "                ):",
            "                    return Response(",
            "                        data={'msg': f\"Not privileged to delete the repository '{repository.name}'\"},",
            "                        status=403,",
            "                    )",
            "",
            "                if repository_in_use(repository):",
            "                    return Response(",
            "                        data={'msg': f\"Repository '{repository.name}' cannot be deleted as it is still in use\"},",
            "                        status=400,",
            "                    )",
            "",
            "                repository.delete()",
            "                return Response(data={'msg': f\"Repository '{repository.name}' deleted\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(response=GenericResponse, description='Repository update initiated'),",
            "            403: OpenApiResponse(response=GenericResponse, description='Not privileged to update the repository'),",
            "            404: OpenApiResponse(response=GenericResponse, description='Repository does not exist'),",
            "        },",
            "        summary='Download/Update a repository.',",
            "        operation_id='repository_update'",
            "    )",
            "    def post(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if repository is not None:",
            "                if not has_repository_permission(",
            "                        user=user,",
            "                        repository=repository,",
            "                        permission_needed=CHOICE_PERMISSION_EXECUTE,",
            "                ):",
            "                    return Response(",
            "                        data={'msg': f\"Not privileged to update the repository '{repository.name}'\"},",
            "                        status=403,",
            "                    )",
            "",
            "                repository_update_thread = Thread(",
            "                    target=api_update_repository,",
            "                    kwargs={'repository': repository, 'user': user}",
            "                )",
            "                repository_update_thread.start()",
            "",
            "                return Response(data={'msg': f\"Repository '{repository.name}' update initiated\"}, status=200)",
            "",
            "        except ObjectDoesNotExist:",
            "            pass",
            "",
            "        return Response(data={'msg': f\"Repository with ID {repo_id} does not exist\"}, status=404)",
            "",
            "",
            "class APIRepositoryLogFile(GenericAPIView):",
            "    http_method_names = ['get']",
            "    serializer_class = LogDownloadResponse",
            "    permission_classes = API_PERMISSION",
            "    valid_logfile_type = ['stdout', 'stderr']",
            "",
            "    @extend_schema(",
            "        request=None,",
            "        responses={",
            "            200: OpenApiResponse(GenericResponse, description='Download repository log-file'),",
            "            403: OpenApiResponse(GenericResponse, description='Not privileged to view the repository logs'),",
            "            404: OpenApiResponse(GenericResponse, description='Repository or log-file dos not exist'),",
            "        },",
            "        summary='Download log-file of the last repository update.',",
            "        operation_id='repository_logfile',",
            "        parameters=[",
            "            OpenApiParameter(",
            "                name='type', type=str, default='stdout',",
            "                description=f\"Type of log-file to download. One of {valid_logfile_type}\",",
            "                required=False,",
            "            ),",
            "        ],",
            "    )",
            "    def get(self, request, repo_id: int):",
            "        user = get_api_user(request)",
            "        try:",
            "            repository = Repository.objects.get(id=repo_id)",
            "            if repository is not None:",
            "                if not has_repository_permission(",
            "                        user=user,",
            "                        repository=repository,",
            "                        permission_needed=CHOICE_PERMISSION_READ,",
            "                ):",
            "                    return Response(",
            "                        data={'msg': f\"Not privileged to view logs of the repository '{repository.name}'\"},",
            "                        status=403,",
            "                    )",
            "",
            "                logfile = repository.log_stdout",
            "                if 'type' in request.GET:",
            "                    logfile_type = request.GET['type'] if request.GET['type'] in self.valid_logfile_type else 'stdout'",
            "                    logfile = getattr(repository, f'log_{logfile_type}')",
            "",
            "                if logfile is None:",
            "                    return Response(data={'msg': f\"No logs found for repository '{repository.name}'\"}, status=404)",
            "",
            "                return get_log_file_content(logfile)",
            "",
            "        except (ObjectDoesNotExist, FileNotFoundError):",
            "            pass",
            "",
            "        return Response(",
            "            data={'msg': f\"Repository with ID '{repo_id}' or log-file does not exist\"},",
            "            status=404,",
            "        )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "13": []
        },
        "addLocation": []
    }
}