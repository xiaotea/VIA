{
    "mindsdb/integrations/handlers/llama_index_handler/llama_index_handler.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " import os"
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from typing import Optional, Dict"
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-import dill"
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from llama_index import GPTVectorStoreIndex,download_loader"
            },
            "4": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from llama_index.readers.schema.base import Document"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 3,
                "PatchRowcode": "+"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 4,
                "PatchRowcode": "+import openai"
            },
            "7": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import pandas as pd"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from langchain.llms import OpenAI"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 7,
                "PatchRowcode": "+import llama_index"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+from llama_index.readers.schema.base import Document"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 9,
                "PatchRowcode": "+from llama_index import SimpleWebPageReader, QuestionAnswerPrompt"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 10,
                "PatchRowcode": "+from llama_index import ServiceContext, StorageContext, load_index_from_storage"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+from llama_index import LLMPredictor, OpenAIEmbedding"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+from llama_index.indices.vector_store.base import VectorStore"
            },
            "15": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "16": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from mindsdb.utilities.config import Config"
            },
            "17": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " from mindsdb.integrations.libs.base import BaseMLEngine"
            },
            "18": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "19": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from mindsdb.utilities.log import get_log"
            },
            "20": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "21": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "22": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-logger = get_log(\"integrations.llama_index_handler\")"
            },
            "23": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+from mindsdb.utilities.config import Config"
            },
            "25": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " "
            },
            "27": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " class LlamaIndexHandler(BaseMLEngine):"
            },
            "28": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    \"\"\""
            },
            "29": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    Integration with the LlamaIndex Python Library"
            },
            "30": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    \"\"\""
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+    \"\"\" Integration with the LlamaIndex data framework for LLM applications. \"\"\""
            },
            "32": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 20,
                "PatchRowcode": "     name = 'llama_index'"
            },
            "33": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " "
            },
            "34": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 22,
                "PatchRowcode": "     def __init__(self, *args, **kwargs):"
            },
            "35": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 23,
                "PatchRowcode": "         super().__init__(*args, **kwargs)"
            },
            "36": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 24,
                "PatchRowcode": "         self.generative = True"
            },
            "37": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.default_index_class  = 'GPTVectorStoreIndex'"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+        self.default_index_class = 'GPTVectorStoreIndex'"
            },
            "39": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 26,
                "PatchRowcode": "         self.supported_index_class = ['GPTVectorStoreIndex']"
            },
            "40": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 27,
                "PatchRowcode": "         self.default_reader = 'DFReader'"
            },
            "41": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.supported_reader = ['DFReader','SimpleWebPageReader']"
            },
            "42": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-  "
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+        self.supported_reader = ['DFReader', 'SimpleWebPageReader']"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+"
            },
            "45": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 30,
                "PatchRowcode": "     def create(self, target: str, df: Optional[pd.DataFrame] = None, args: Optional[Dict] = None) -> None:"
            },
            "46": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\""
            },
            "47": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        Raises"
            },
            "48": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ------"
            },
            "49": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ValueError"
            },
            "50": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            If the query contains an unsupported condition"
            },
            "51": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\""
            },
            "52": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "53": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 31,
                "PatchRowcode": "         if 'using' not in args:"
            },
            "54": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 32,
                "PatchRowcode": "             raise Exception(\"LlamaIndex engine requires a USING clause! Refer to its documentation for more details.\")"
            },
            "55": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " "
            },
            "56": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "57": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if 'openai_api_key' not in args['using']:"
            },
            "58": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise Exception(\"LlamaIndex engine requires a openai_api_key parameter.Refer to its documentation for more details.\")"
            },
            "59": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+        if 'prompt_template' in args['using']:"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+            self._validate_prompt_template(args['using']['prompt_template'])"
            },
            "61": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " "
            },
            "62": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "         if 'index_class' not in args['using']:"
            },
            "63": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 38,
                "PatchRowcode": "             args['using']['index_class'] = self.default_index_class"
            },
            "64": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "         elif args['using']['reader'] not in self.supported_reader:"
            },
            "65": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "             raise Exception(f\"Invalid operation mode. Please use one of {self.supported_reader}\")"
            },
            "66": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 46,
                "PatchRowcode": " "
            },
            "67": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-       "
            },
            "68": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        documents_df_reader = []"
            },
            "69": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        documents_url_reader = []"
            },
            "70": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        pred = None"
            },
            "71": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "         if args['using']['reader'] == 'DFReader':"
            },
            "72": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            for row in df.itertuples():"
            },
            "73": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                doc_str = \", \".join([str(entry) for entry in row])"
            },
            "74": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                documents_df_reader.append(Document(doc_str))  "
            },
            "75": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            pred = documents_df_reader   "
            },
            "76": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-      "
            },
            "77": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        elif args['using']['reader'] == 'SimpleWebPageReader':"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 48,
                "PatchRowcode": "+            dstrs = df.apply(lambda x: ', '.join([f'{col}: {str(entry)}' for col, entry in zip(df.columns, x)]), axis=1)"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 49,
                "PatchRowcode": "+            reader = list(map(lambda x: Document(x), dstrs.tolist()))"
            },
            "80": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 50,
                "PatchRowcode": " "
            },
            "81": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+        elif args['using']['reader'] == 'SimpleWebPageReader':"
            },
            "82": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "             if 'source_url_link' not in args['using']:"
            },
            "83": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                raise Exception(\"LlamaIndex engine requires a source_url_link parameter.Refer to its documentation for more details.\")"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+                raise Exception(\"SimpleWebPageReader requires a `source_url_link` parameter. Refer to LlamaIndex documentation for more details.\")  # noqa"
            },
            "85": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 54,
                "PatchRowcode": " "
            },
            "86": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            SimpleWebPageReader = download_loader(\"SimpleWebPageReader\")"
            },
            "87": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            documents_url_reader = SimpleWebPageReader(html_to_text=True).load_data([args['using']['source_url_link']])"
            },
            "88": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            pred = documents_url_reader "
            },
            "89": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+            reader = SimpleWebPageReader(html_to_text=True).load_data([args['using']['source_url_link']])"
            },
            "90": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 56,
                "PatchRowcode": " "
            },
            "91": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 57,
                "PatchRowcode": "         else:"
            },
            "92": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_reader}.\")  "
            },
            "93": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "94": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.model_storage.file_set('pred', dill.dumps(pred))"
            },
            "95": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.model_storage.json_set('args', args)"
            },
            "96": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "97": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "98": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "99": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def predict(self, df: Optional[pd.DataFrame] = None, args: Optional[Dict] = None) -> None:"
            },
            "100": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\""
            },
            "101": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        Returns"
            },
            "102": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        -------"
            },
            "103": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        pd.DataFrame"
            },
            "104": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            youtube \"commentThreads()\" matching the query"
            },
            "105": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        Raises"
            },
            "106": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ------"
            },
            "107": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        ValueError"
            },
            "108": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            If the query contains an unsupported condition"
            },
            "109": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\""
            },
            "110": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_reader}.\")"
            },
            "111": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 59,
                "PatchRowcode": " "
            },
            "112": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+        self.model_storage.json_set('args', args)"
            },
            "113": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+        index = self._setup_index(reader)"
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+        path = self.model_storage.fileStorage.get_path('./')"
            },
            "115": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+        index.storage_context.persist(persist_dir=path)"
            },
            "116": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 64,
                "PatchRowcode": " "
            },
            "117": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+    def predict(self, df: Optional[pd.DataFrame] = None, args: Optional[Dict] = None) -> pd.DataFrame:"
            },
            "118": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "         args = self.model_storage.json_get('args')"
            },
            "119": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        data_docs = dill.loads(self.model_storage.file_get('pred'))"
            },
            "120": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        input_keys = list(args.keys())"
            },
            "121": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+        input_column = args['using'].get('input_column', None)"
            },
            "122": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+        engine_kwargs = {}"
            },
            "123": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+"
            },
            "124": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+        prompt_template = args['using'].get('prompt_template', args.get('prompt_template', None))"
            },
            "125": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+        if prompt_template is not None:"
            },
            "126": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+            self._validate_prompt_template(prompt_template)"
            },
            "127": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+            engine_kwargs['text_qa_template'] = QuestionAnswerPrompt(prompt_template)"
            },
            "128": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 74,
                "PatchRowcode": " "
            },
            "129": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        input_column = args['using']['input_column']"
            },
            "130": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+        if input_column is None:"
            },
            "131": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 76,
                "PatchRowcode": "+            raise Exception(f'`input_column` must be provided at model creation time or through USING clause when predicting. Please try again.')  # noqa"
            },
            "132": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 77,
                "PatchRowcode": " "
            },
            "133": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "         if input_column not in df.columns:"
            },
            "134": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise RuntimeError(f'Column \"{input_column}\" not found in input data')"
            },
            "135": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+            raise Exception(f'Column \"{input_column}\" not found in input data! Please try again.')"
            },
            "136": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 80,
                "PatchRowcode": "+"
            },
            "137": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+        index_path = self.model_storage.fileStorage.get_path('./')"
            },
            "138": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+        storage_context = StorageContext.from_defaults(persist_dir=index_path)"
            },
            "139": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+        service_context = self._get_service_context()"
            },
            "140": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        index = load_index_from_storage(storage_context, service_context=service_context)"
            },
            "141": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+        query_engine = index.as_query_engine(**engine_kwargs)"
            },
            "142": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 86,
                "PatchRowcode": " "
            },
            "143": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "144": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        query_engine  = self.predict_qa_reader(data_docs)"
            },
            "145": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                "
            },
            "146": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            "
            },
            "147": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        questions = df[input_column]   "
            },
            "148": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+        questions = df[input_column]"
            },
            "149": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "         results = []"
            },
            "150": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "151": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "152": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        for question in questions:"
            },
            "153": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            query_results = query_engine.query(question)"
            },
            "154": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            results.append(query_results)"
            },
            "155": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "156": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        result_df = pd.DataFrame({'question': questions, 'predictions': results})"
            },
            "157": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 89,
                "PatchRowcode": " "
            },
            "158": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        result_df = result_df.rename(columns={'predictions': args['target']})"
            },
            "159": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+        for question in questions:"
            },
            "160": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+            query_results = query_engine.query(question)  # TODO: provide extra_info in explain_target col"
            },
            "161": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+            results.append(query_results.response)"
            },
            "162": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 93,
                "PatchRowcode": " "
            },
            "163": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+        result_df = pd.DataFrame({'question': questions, args['target']: results})  # result_df['answer'].tolist()"
            },
            "164": {
                "beforePatchRowNumber": 122,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         return result_df"
            },
            "165": {
                "beforePatchRowNumber": 123,
                "afterPatchRowNumber": 96,
                "PatchRowcode": " "
            },
            "166": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+    def _get_service_context(self):"
            },
            "167": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+        args = self.model_storage.json_get('args')"
            },
            "168": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+        openai_api_key = self._get_llama_index_api_key(args['using'])"
            },
            "169": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+        openai.api_key = openai_api_key  # TODO: shouldn't have to do this! bug?"
            },
            "170": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+        llm = OpenAI(openai_api_key=openai_api_key)  # TODO: all usual params should go here"
            },
            "171": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+        embed_model = OpenAIEmbedding(openai_api_key=openai_api_key)"
            },
            "172": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+        service_context = ServiceContext.from_defaults("
            },
            "173": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+            llm_predictor=LLMPredictor(llm=llm),"
            },
            "174": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+            embed_model=embed_model"
            },
            "175": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+        )"
            },
            "176": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 107,
                "PatchRowcode": "+        return service_context"
            },
            "177": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+    "
            },
            "178": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+    def _setup_index(self, documents):"
            },
            "179": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+        args = self.model_storage.json_get('args')"
            },
            "180": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+        indexer: VectorStore = getattr(llama_index, args['using']['index_class'])"
            },
            "181": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+        index = indexer.from_documents(documents, service_context=self._get_service_context())"
            },
            "182": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+"
            },
            "183": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+        return index"
            },
            "184": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+"
            },
            "185": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+    def _validate_prompt_template(self, prompt_template: str):"
            },
            "186": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+        if '{context_str}' not in prompt_template or '{query_str}' not in prompt_template:"
            },
            "187": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+            raise Exception(\"Provided prompt template is invalid, missing one of `{context_str}` or `{query_str}`. Please ensure both placeholders are present and try again.\")  # noqa"
            },
            "188": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 119,
                "PatchRowcode": " "
            },
            "189": {
                "beforePatchRowNumber": 125,
                "afterPatchRowNumber": 120,
                "PatchRowcode": "     def _get_llama_index_api_key(self, args, strict=True):"
            },
            "190": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\" "
            },
            "191": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+        \"\"\""
            },
            "192": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": 122,
                "PatchRowcode": "         API_KEY preference order:"
            },
            "193": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "             1. provided at model creation"
            },
            "194": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "             2. provided at engine creation"
            },
            "195": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": 125,
                "PatchRowcode": "             3. OPENAI_API_KEY env variable"
            },
            "196": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "             4. llama_index.OPENAI_API_KEY setting in config.json"
            },
            "197": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\" "
            },
            "198": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # 1"
            },
            "199": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if 'OPENAI_API_KEY' in args:"
            },
            "200": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return args['OPENAI_API_KEY']"
            },
            "201": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # 2"
            },
            "202": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        connection_args = self.engine_storage.get_connection_args()"
            },
            "203": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if 'OPENAI_API_KEY' in connection_args:"
            },
            "204": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return connection_args['OPENAI_API_KEY']"
            },
            "205": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # 3"
            },
            "206": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        api_key = os.getenv('OPENAI_API_KEY')"
            },
            "207": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if api_key is not None:"
            },
            "208": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return api_key"
            },
            "209": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # 4"
            },
            "210": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        config = Config()"
            },
            "211": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        openai_cfg = config.get('llama_index', {})"
            },
            "212": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if 'OPENAI_API_KEY' in openai_cfg:"
            },
            "213": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return openai_cfg['OPENAI_API_KEY']"
            },
            "214": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "215": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if strict:"
            },
            "216": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise Exception(f'Missing API key \"OPENAI_API_KEY\". Either re-create this ML_ENGINE specifying the `OPENAI_API_KEY` parameter,\\"
            },
            "217": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                 or re-create this model and pass the API key with `USING` syntax.')  "
            },
            "218": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "219": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def predict_qa_reader(self,documents):"
            },
            "220": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\" "
            },
            "221": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        connects with llama_index python client to predict the q&a"
            },
            "222": {
                "beforePatchRowNumber": 157,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "223": {
                "beforePatchRowNumber": 158,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"\"\" "
            },
            "224": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "225": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        args = self.model_storage.json_get('args')"
            },
            "226": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 127,
                "PatchRowcode": " "
            },
            "227": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        os.environ['OPENAI_API_KEY'] = args['using']['openai_api_key']"
            },
            "228": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        "
            },
            "229": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if args['using']['index_class'] == 'GPTVectorStoreIndex':"
            },
            "230": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            index = GPTVectorStoreIndex.from_documents(documents)"
            },
            "231": {
                "beforePatchRowNumber": 166,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        else:"
            },
            "232": {
                "beforePatchRowNumber": 167,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_index_class}.\")  "
            },
            "233": {
                "beforePatchRowNumber": 168,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    "
            },
            "234": {
                "beforePatchRowNumber": 169,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        query_engine = index.as_query_engine()"
            },
            "235": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+        Note: method is not case sensitive."
            },
            "236": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+        \"\"\""
            },
            "237": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+        key = 'OPENAI_API_KEY'"
            },
            "238": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+        for k in key, key.lower():"
            },
            "239": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+            # 1"
            },
            "240": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+            if args.get(k):"
            },
            "241": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+                return args[k]"
            },
            "242": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+            # 2"
            },
            "243": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+            connection_args = self.engine_storage.get_connection_args()"
            },
            "244": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+            if k in connection_args:"
            },
            "245": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+                return connection_args[k]"
            },
            "246": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+            # 3"
            },
            "247": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+            api_key = os.getenv(k)"
            },
            "248": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 141,
                "PatchRowcode": "+            if api_key is not None:"
            },
            "249": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 142,
                "PatchRowcode": "+                return api_key"
            },
            "250": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+            # 4"
            },
            "251": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+            config = Config()"
            },
            "252": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+            openai_cfg = config.get('llama_index', {})"
            },
            "253": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+            if k in openai_cfg:"
            },
            "254": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 147,
                "PatchRowcode": "+                return openai_cfg[k]"
            },
            "255": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": 148,
                "PatchRowcode": " "
            },
            "256": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        return query_engine"
            },
            "257": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 149,
                "PatchRowcode": "+        if strict:"
            },
            "258": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+            raise Exception(f'Missing API key \"{k}\". Either re-create this ML_ENGINE specifying the `{k}` parameter, or re-create this model and pass the API key with `USING` syntax.')  # noqa"
            }
        },
        "frontPatchFile": [
            "import os",
            "from typing import Optional, Dict",
            "import dill",
            "from llama_index import GPTVectorStoreIndex,download_loader",
            "from llama_index.readers.schema.base import Document",
            "import pandas as pd",
            "",
            "from mindsdb.utilities.config import Config",
            "from mindsdb.integrations.libs.base import BaseMLEngine",
            "",
            "from mindsdb.utilities.log import get_log",
            "",
            "",
            "logger = get_log(\"integrations.llama_index_handler\")",
            "",
            "",
            "",
            "class LlamaIndexHandler(BaseMLEngine):",
            "    \"\"\"",
            "    Integration with the LlamaIndex Python Library",
            "    \"\"\"",
            "    name = 'llama_index'",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        self.generative = True",
            "        self.default_index_class  = 'GPTVectorStoreIndex'",
            "        self.supported_index_class = ['GPTVectorStoreIndex']",
            "        self.default_reader = 'DFReader'",
            "        self.supported_reader = ['DFReader','SimpleWebPageReader']",
            "  ",
            "    def create(self, target: str, df: Optional[pd.DataFrame] = None, args: Optional[Dict] = None) -> None:",
            "        \"\"\"",
            "        Raises",
            "        ------",
            "        ValueError",
            "            If the query contains an unsupported condition",
            "        \"\"\"",
            "        ",
            "        if 'using' not in args:",
            "            raise Exception(\"LlamaIndex engine requires a USING clause! Refer to its documentation for more details.\")",
            "",
            "",
            "        if 'openai_api_key' not in args['using']:",
            "            raise Exception(\"LlamaIndex engine requires a openai_api_key parameter.Refer to its documentation for more details.\")",
            "",
            "        if 'index_class' not in args['using']:",
            "            args['using']['index_class'] = self.default_index_class",
            "        elif args['using']['index_class'] not in self.supported_index_class:",
            "            raise Exception(f\"Invalid index class argument. Please use one of {self.supported_index_class}\")",
            "",
            "        if 'reader' not in args['using']:",
            "            args['using']['reader'] = self.default_reader",
            "        elif args['using']['reader'] not in self.supported_reader:",
            "            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_reader}\")",
            "",
            "       ",
            "        documents_df_reader = []",
            "        documents_url_reader = []",
            "        pred = None",
            "        if args['using']['reader'] == 'DFReader':",
            "            for row in df.itertuples():",
            "                doc_str = \", \".join([str(entry) for entry in row])",
            "                documents_df_reader.append(Document(doc_str))  ",
            "            pred = documents_df_reader   ",
            "      ",
            "        elif args['using']['reader'] == 'SimpleWebPageReader':",
            "",
            "            if 'source_url_link' not in args['using']:",
            "                raise Exception(\"LlamaIndex engine requires a source_url_link parameter.Refer to its documentation for more details.\")",
            "",
            "            SimpleWebPageReader = download_loader(\"SimpleWebPageReader\")",
            "            documents_url_reader = SimpleWebPageReader(html_to_text=True).load_data([args['using']['source_url_link']])",
            "            pred = documents_url_reader ",
            "",
            "        else:",
            "            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_reader}.\")  ",
            "        ",
            "        self.model_storage.file_set('pred', dill.dumps(pred))",
            "        self.model_storage.json_set('args', args)",
            "",
            "        ",
            "",
            "    def predict(self, df: Optional[pd.DataFrame] = None, args: Optional[Dict] = None) -> None:",
            "        \"\"\"",
            "        Returns",
            "        -------",
            "        pd.DataFrame",
            "            youtube \"commentThreads()\" matching the query",
            "        Raises",
            "        ------",
            "        ValueError",
            "            If the query contains an unsupported condition",
            "        \"\"\"",
            "",
            "",
            "        args = self.model_storage.json_get('args')",
            "        data_docs = dill.loads(self.model_storage.file_get('pred'))",
            "        input_keys = list(args.keys())",
            "",
            "        input_column = args['using']['input_column']",
            "",
            "        if input_column not in df.columns:",
            "            raise RuntimeError(f'Column \"{input_column}\" not found in input data')",
            "",
            "        ",
            "        query_engine  = self.predict_qa_reader(data_docs)",
            "                ",
            "            ",
            "        questions = df[input_column]   ",
            "        results = []",
            "        ",
            "        ",
            "        for question in questions:",
            "            query_results = query_engine.query(question)",
            "            results.append(query_results)",
            "        ",
            "        result_df = pd.DataFrame({'question': questions, 'predictions': results})",
            "",
            "        result_df = result_df.rename(columns={'predictions': args['target']})",
            "",
            "        return result_df",
            "",
            "",
            "    def _get_llama_index_api_key(self, args, strict=True):",
            "        \"\"\" ",
            "        API_KEY preference order:",
            "            1. provided at model creation",
            "            2. provided at engine creation",
            "            3. OPENAI_API_KEY env variable",
            "            4. llama_index.OPENAI_API_KEY setting in config.json",
            "        \"\"\" ",
            "        # 1",
            "        if 'OPENAI_API_KEY' in args:",
            "            return args['OPENAI_API_KEY']",
            "        # 2",
            "        connection_args = self.engine_storage.get_connection_args()",
            "        if 'OPENAI_API_KEY' in connection_args:",
            "            return connection_args['OPENAI_API_KEY']",
            "        # 3",
            "        api_key = os.getenv('OPENAI_API_KEY')",
            "        if api_key is not None:",
            "            return api_key",
            "        # 4",
            "        config = Config()",
            "        openai_cfg = config.get('llama_index', {})",
            "        if 'OPENAI_API_KEY' in openai_cfg:",
            "            return openai_cfg['OPENAI_API_KEY']",
            "",
            "        if strict:",
            "            raise Exception(f'Missing API key \"OPENAI_API_KEY\". Either re-create this ML_ENGINE specifying the `OPENAI_API_KEY` parameter,\\",
            "                 or re-create this model and pass the API key with `USING` syntax.')  ",
            "",
            "    def predict_qa_reader(self,documents):",
            "        \"\"\" ",
            "        connects with llama_index python client to predict the q&a",
            "",
            "        \"\"\" ",
            "        ",
            "        args = self.model_storage.json_get('args')",
            "",
            "        os.environ['OPENAI_API_KEY'] = args['using']['openai_api_key']",
            "        ",
            "        if args['using']['index_class'] == 'GPTVectorStoreIndex':",
            "            index = GPTVectorStoreIndex.from_documents(documents)",
            "        else:",
            "            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_index_class}.\")  ",
            "    ",
            "        query_engine = index.as_query_engine()",
            "",
            "        return query_engine"
        ],
        "afterPatchFile": [
            "import os",
            "from typing import Optional, Dict",
            "",
            "import openai",
            "import pandas as pd",
            "from langchain.llms import OpenAI",
            "import llama_index",
            "from llama_index.readers.schema.base import Document",
            "from llama_index import SimpleWebPageReader, QuestionAnswerPrompt",
            "from llama_index import ServiceContext, StorageContext, load_index_from_storage",
            "from llama_index import LLMPredictor, OpenAIEmbedding",
            "from llama_index.indices.vector_store.base import VectorStore",
            "",
            "from mindsdb.integrations.libs.base import BaseMLEngine",
            "from mindsdb.utilities.config import Config",
            "",
            "",
            "class LlamaIndexHandler(BaseMLEngine):",
            "    \"\"\" Integration with the LlamaIndex data framework for LLM applications. \"\"\"",
            "    name = 'llama_index'",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super().__init__(*args, **kwargs)",
            "        self.generative = True",
            "        self.default_index_class = 'GPTVectorStoreIndex'",
            "        self.supported_index_class = ['GPTVectorStoreIndex']",
            "        self.default_reader = 'DFReader'",
            "        self.supported_reader = ['DFReader', 'SimpleWebPageReader']",
            "",
            "    def create(self, target: str, df: Optional[pd.DataFrame] = None, args: Optional[Dict] = None) -> None:",
            "        if 'using' not in args:",
            "            raise Exception(\"LlamaIndex engine requires a USING clause! Refer to its documentation for more details.\")",
            "",
            "        if 'prompt_template' in args['using']:",
            "            self._validate_prompt_template(args['using']['prompt_template'])",
            "",
            "        if 'index_class' not in args['using']:",
            "            args['using']['index_class'] = self.default_index_class",
            "        elif args['using']['index_class'] not in self.supported_index_class:",
            "            raise Exception(f\"Invalid index class argument. Please use one of {self.supported_index_class}\")",
            "",
            "        if 'reader' not in args['using']:",
            "            args['using']['reader'] = self.default_reader",
            "        elif args['using']['reader'] not in self.supported_reader:",
            "            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_reader}\")",
            "",
            "        if args['using']['reader'] == 'DFReader':",
            "            dstrs = df.apply(lambda x: ', '.join([f'{col}: {str(entry)}' for col, entry in zip(df.columns, x)]), axis=1)",
            "            reader = list(map(lambda x: Document(x), dstrs.tolist()))",
            "",
            "        elif args['using']['reader'] == 'SimpleWebPageReader':",
            "            if 'source_url_link' not in args['using']:",
            "                raise Exception(\"SimpleWebPageReader requires a `source_url_link` parameter. Refer to LlamaIndex documentation for more details.\")  # noqa",
            "",
            "            reader = SimpleWebPageReader(html_to_text=True).load_data([args['using']['source_url_link']])",
            "",
            "        else:",
            "            raise Exception(f\"Invalid operation mode. Please use one of {self.supported_reader}.\")",
            "",
            "        self.model_storage.json_set('args', args)",
            "        index = self._setup_index(reader)",
            "        path = self.model_storage.fileStorage.get_path('./')",
            "        index.storage_context.persist(persist_dir=path)",
            "",
            "    def predict(self, df: Optional[pd.DataFrame] = None, args: Optional[Dict] = None) -> pd.DataFrame:",
            "        args = self.model_storage.json_get('args')",
            "        input_column = args['using'].get('input_column', None)",
            "        engine_kwargs = {}",
            "",
            "        prompt_template = args['using'].get('prompt_template', args.get('prompt_template', None))",
            "        if prompt_template is not None:",
            "            self._validate_prompt_template(prompt_template)",
            "            engine_kwargs['text_qa_template'] = QuestionAnswerPrompt(prompt_template)",
            "",
            "        if input_column is None:",
            "            raise Exception(f'`input_column` must be provided at model creation time or through USING clause when predicting. Please try again.')  # noqa",
            "",
            "        if input_column not in df.columns:",
            "            raise Exception(f'Column \"{input_column}\" not found in input data! Please try again.')",
            "",
            "        index_path = self.model_storage.fileStorage.get_path('./')",
            "        storage_context = StorageContext.from_defaults(persist_dir=index_path)",
            "        service_context = self._get_service_context()",
            "        index = load_index_from_storage(storage_context, service_context=service_context)",
            "        query_engine = index.as_query_engine(**engine_kwargs)",
            "",
            "        questions = df[input_column]",
            "        results = []",
            "",
            "        for question in questions:",
            "            query_results = query_engine.query(question)  # TODO: provide extra_info in explain_target col",
            "            results.append(query_results.response)",
            "",
            "        result_df = pd.DataFrame({'question': questions, args['target']: results})  # result_df['answer'].tolist()",
            "        return result_df",
            "",
            "    def _get_service_context(self):",
            "        args = self.model_storage.json_get('args')",
            "        openai_api_key = self._get_llama_index_api_key(args['using'])",
            "        openai.api_key = openai_api_key  # TODO: shouldn't have to do this! bug?",
            "        llm = OpenAI(openai_api_key=openai_api_key)  # TODO: all usual params should go here",
            "        embed_model = OpenAIEmbedding(openai_api_key=openai_api_key)",
            "        service_context = ServiceContext.from_defaults(",
            "            llm_predictor=LLMPredictor(llm=llm),",
            "            embed_model=embed_model",
            "        )",
            "        return service_context",
            "    ",
            "    def _setup_index(self, documents):",
            "        args = self.model_storage.json_get('args')",
            "        indexer: VectorStore = getattr(llama_index, args['using']['index_class'])",
            "        index = indexer.from_documents(documents, service_context=self._get_service_context())",
            "",
            "        return index",
            "",
            "    def _validate_prompt_template(self, prompt_template: str):",
            "        if '{context_str}' not in prompt_template or '{query_str}' not in prompt_template:",
            "            raise Exception(\"Provided prompt template is invalid, missing one of `{context_str}` or `{query_str}`. Please ensure both placeholders are present and try again.\")  # noqa",
            "",
            "    def _get_llama_index_api_key(self, args, strict=True):",
            "        \"\"\"",
            "        API_KEY preference order:",
            "            1. provided at model creation",
            "            2. provided at engine creation",
            "            3. OPENAI_API_KEY env variable",
            "            4. llama_index.OPENAI_API_KEY setting in config.json",
            "",
            "        Note: method is not case sensitive.",
            "        \"\"\"",
            "        key = 'OPENAI_API_KEY'",
            "        for k in key, key.lower():",
            "            # 1",
            "            if args.get(k):",
            "                return args[k]",
            "            # 2",
            "            connection_args = self.engine_storage.get_connection_args()",
            "            if k in connection_args:",
            "                return connection_args[k]",
            "            # 3",
            "            api_key = os.getenv(k)",
            "            if api_key is not None:",
            "                return api_key",
            "            # 4",
            "            config = Config()",
            "            openai_cfg = config.get('llama_index', {})",
            "            if k in openai_cfg:",
            "                return openai_cfg[k]",
            "",
            "        if strict:",
            "            raise Exception(f'Missing API key \"{k}\". Either re-create this ML_ENGINE specifying the `{k}` parameter, or re-create this model and pass the API key with `USING` syntax.')  # noqa"
        ],
        "action": [
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2"
        ],
        "dele_reviseLocation": {
            "3": [],
            "4": [],
            "5": [],
            "8": [],
            "10": [],
            "11": [],
            "12": [],
            "13": [],
            "14": [
                "logger"
            ],
            "15": [],
            "19": [
                "LlamaIndexHandler"
            ],
            "20": [
                "LlamaIndexHandler"
            ],
            "21": [
                "LlamaIndexHandler"
            ],
            "27": [
                "LlamaIndexHandler",
                "__init__"
            ],
            "30": [
                "LlamaIndexHandler",
                "__init__"
            ],
            "31": [
                "LlamaIndexHandler"
            ],
            "33": [
                "LlamaIndexHandler",
                "create"
            ],
            "34": [
                "LlamaIndexHandler",
                "create"
            ],
            "35": [
                "LlamaIndexHandler",
                "create"
            ],
            "36": [
                "LlamaIndexHandler",
                "create"
            ],
            "37": [
                "LlamaIndexHandler",
                "create"
            ],
            "38": [
                "LlamaIndexHandler",
                "create"
            ],
            "39": [
                "LlamaIndexHandler",
                "create"
            ],
            "43": [
                "LlamaIndexHandler",
                "create"
            ],
            "44": [
                "LlamaIndexHandler",
                "create"
            ],
            "45": [
                "LlamaIndexHandler",
                "create"
            ],
            "57": [
                "LlamaIndexHandler",
                "create"
            ],
            "58": [
                "LlamaIndexHandler",
                "create"
            ],
            "59": [
                "LlamaIndexHandler",
                "create"
            ],
            "60": [
                "LlamaIndexHandler",
                "create"
            ],
            "62": [
                "LlamaIndexHandler",
                "create"
            ],
            "63": [
                "LlamaIndexHandler",
                "create"
            ],
            "64": [
                "LlamaIndexHandler",
                "create"
            ],
            "65": [
                "LlamaIndexHandler",
                "create"
            ],
            "66": [
                "LlamaIndexHandler",
                "create"
            ],
            "67": [
                "LlamaIndexHandler",
                "create"
            ],
            "70": [
                "LlamaIndexHandler",
                "create"
            ],
            "72": [
                "LlamaIndexHandler",
                "create"
            ],
            "73": [
                "LlamaIndexHandler",
                "create"
            ],
            "74": [
                "LlamaIndexHandler",
                "create"
            ],
            "77": [
                "LlamaIndexHandler",
                "create"
            ],
            "78": [
                "LlamaIndexHandler",
                "create"
            ],
            "79": [
                "LlamaIndexHandler",
                "create"
            ],
            "80": [
                "LlamaIndexHandler",
                "create"
            ],
            "81": [
                "LlamaIndexHandler"
            ],
            "82": [
                "LlamaIndexHandler"
            ],
            "83": [
                "LlamaIndexHandler"
            ],
            "84": [
                "LlamaIndexHandler",
                "predict"
            ],
            "85": [
                "LlamaIndexHandler",
                "predict"
            ],
            "86": [
                "LlamaIndexHandler",
                "predict"
            ],
            "87": [
                "LlamaIndexHandler",
                "predict"
            ],
            "88": [
                "LlamaIndexHandler",
                "predict"
            ],
            "89": [
                "LlamaIndexHandler",
                "predict"
            ],
            "90": [
                "LlamaIndexHandler",
                "predict"
            ],
            "91": [
                "LlamaIndexHandler",
                "predict"
            ],
            "92": [
                "LlamaIndexHandler",
                "predict"
            ],
            "93": [
                "LlamaIndexHandler",
                "predict"
            ],
            "94": [
                "LlamaIndexHandler",
                "predict"
            ],
            "98": [
                "LlamaIndexHandler",
                "predict"
            ],
            "99": [
                "LlamaIndexHandler",
                "predict"
            ],
            "101": [
                "LlamaIndexHandler",
                "predict"
            ],
            "104": [
                "LlamaIndexHandler",
                "predict"
            ],
            "106": [
                "LlamaIndexHandler",
                "predict"
            ],
            "107": [
                "LlamaIndexHandler",
                "predict"
            ],
            "108": [
                "LlamaIndexHandler",
                "predict"
            ],
            "109": [
                "LlamaIndexHandler",
                "predict"
            ],
            "110": [
                "LlamaIndexHandler",
                "predict"
            ],
            "112": [
                "LlamaIndexHandler",
                "predict"
            ],
            "113": [
                "LlamaIndexHandler",
                "predict"
            ],
            "114": [
                "LlamaIndexHandler",
                "predict"
            ],
            "115": [
                "LlamaIndexHandler",
                "predict"
            ],
            "116": [
                "LlamaIndexHandler",
                "predict"
            ],
            "117": [
                "LlamaIndexHandler",
                "predict"
            ],
            "118": [
                "LlamaIndexHandler",
                "predict"
            ],
            "120": [
                "LlamaIndexHandler",
                "predict"
            ],
            "126": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "132": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "133": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "134": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "135": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "136": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "137": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "138": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "139": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "140": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "141": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "142": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "143": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "144": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "145": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "146": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "147": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "148": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "149": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "150": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "151": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "152": [
                "LlamaIndexHandler",
                "_get_llama_index_api_key"
            ],
            "153": [
                "LlamaIndexHandler"
            ],
            "154": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "155": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "156": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "157": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "158": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "159": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "160": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "162": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "163": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "164": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "165": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "166": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "167": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "168": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "169": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ],
            "171": [
                "LlamaIndexHandler",
                "predict_qa_reader"
            ]
        },
        "addLocation": []
    }
}