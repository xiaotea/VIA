{
    "rdiffweb/controller/page_pref_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "         # Validate only if action is set_profile_info"
            },
            "1": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "         return super().is_submitted() and self.action.data == 'set_password'"
            },
            "2": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 90,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+    def validate_new(self, field):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+        \"\"\""
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        Make sure new password if not equals to old password."
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+        \"\"\""
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+        if self.new.data and self.new.data == self.current.data:"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+            raise ValueError(_('The new password must be different from the current password.'))"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+"
            },
            "10": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "     def populate_obj(self, user):"
            },
            "11": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "         # Check if current password is \"valid\" if Not, rate limit the"
            },
            "12": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         # number of attempts and logout user after too many invalid attempts."
            },
            "13": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 109,
                "PatchRowcode": "                     level='warning',"
            },
            "14": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 110,
                "PatchRowcode": "                 )"
            },
            "15": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "                 raise cherrypy.HTTPRedirect('/login/')"
            },
            "16": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            flash(_(\"Wrong current password.\"), level='warning')"
            },
            "17": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        else:"
            },
            "18": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # Clear number of attempts"
            },
            "19": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:"
            },
            "20": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]"
            },
            "21": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # If Valid, update password"
            },
            "22": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            try:"
            },
            "23": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                user.set_password(self.new.data)"
            },
            "24": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                flash(_(\"Password updated successfully.\"), level='success')"
            },
            "25": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            except ValueError as e:"
            },
            "26": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                flash(str(e), level='warning')"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 112,
                "PatchRowcode": "+            self.current.errors = [_(\"Wrong current password.\")]"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+            return False"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 114,
                "PatchRowcode": "+"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 115,
                "PatchRowcode": "+        # Clear number of attempts"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 116,
                "PatchRowcode": "+        if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+            del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+        try:"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 120,
                "PatchRowcode": "+            user.set_password(self.new.data)"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+            return True"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+        except ValueError as e:"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 123,
                "PatchRowcode": "+            self.new.errors = [str(e)]"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 124,
                "PatchRowcode": "+            return False"
            },
            "40": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 125,
                "PatchRowcode": " "
            },
            "41": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 126,
                "PatchRowcode": " "
            },
            "42": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 127,
                "PatchRowcode": " class RefreshForm(CherryForm):"
            },
            "43": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 160,
                "PatchRowcode": "             if profile_form.validate():"
            },
            "44": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": 161,
                "PatchRowcode": "                 profile_form.populate_obj(self.app.currentuser)"
            },
            "45": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": 162,
                "PatchRowcode": "                 flash(_(\"Profile updated successfully.\"), level='success')"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+                raise cherrypy.HTTPRedirect(\"\")"
            },
            "47": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": 164,
                "PatchRowcode": "             else:"
            },
            "48": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": 165,
                "PatchRowcode": "                 flash(profile_form.error_message, level='error')"
            },
            "49": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "         elif password_form.is_submitted():"
            },
            "50": {
                "beforePatchRowNumber": 157,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "             if password_form.validate():"
            },
            "51": {
                "beforePatchRowNumber": 158,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                password_form.populate_obj(self.app.currentuser)"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 168,
                "PatchRowcode": "+                if password_form.populate_obj(self.app.currentuser):"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 169,
                "PatchRowcode": "+                    flash(_(\"Password updated successfully.\"), level='success')"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 170,
                "PatchRowcode": "+                    raise cherrypy.HTTPRedirect(\"\")"
            },
            "55": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "             else:"
            },
            "56": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 172,
                "PatchRowcode": "                 flash(password_form.error_message, level='error')"
            },
            "57": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 173,
                "PatchRowcode": "         elif refresh_form.is_submitted():"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Maximum number of password change attempt before logout",
            "CHANGE_PASSWORD_MAX_ATTEMPT = 5",
            "CHANGE_PASSWORD_ATTEMPTS = 'change_password_attempts'",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def populate_obj(self, user):",
            "        # Check if current password is \"valid\" if Not, rate limit the",
            "        # number of attempts and logout user after too many invalid attempts.",
            "        if not user.validate_password(self.current.data):",
            "            cherrypy.session[CHANGE_PASSWORD_ATTEMPTS] = cherrypy.session.get(CHANGE_PASSWORD_ATTEMPTS, 0) + 1",
            "            attempts = cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "            if attempts >= CHANGE_PASSWORD_MAX_ATTEMPT:",
            "                cherrypy.session.clear()",
            "                cherrypy.session.regenerate()",
            "                flash(",
            "                    _(\"You were logged out because you entered the wrong password too many times.\"),",
            "                    level='warning',",
            "                )",
            "                raise cherrypy.HTTPRedirect('/login/')",
            "            flash(_(\"Wrong current password.\"), level='warning')",
            "        else:",
            "            # Clear number of attempts",
            "            if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:",
            "                del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "            # If Valid, update password",
            "            try:",
            "                user.set_password(self.new.data)",
            "                flash(_(\"Password updated successfully.\"), level='success')",
            "            except ValueError as e:",
            "                flash(str(e), level='warning')",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                password_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import cherrypy",
            "from wtforms.fields import HiddenField, PasswordField, StringField, SubmitField",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Optional, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "# Maximum number of password change attempt before logout",
            "CHANGE_PASSWORD_MAX_ATTEMPT = 5",
            "CHANGE_PASSWORD_ATTEMPTS = 'change_password_attempts'",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    action = HiddenField(default='set_profile_info')",
            "    username = StringField(_('Username'), render_kw={'readonly': True})",
            "    fullname = StringField(",
            "        _('Fullname'),",
            "        validators=[",
            "            Optional(),",
            "            Length(max=256, message=_('Fullname too long.')),",
            "            Regexp(UserObject.PATTERN_FULLNAME, message=_('Must not contain any special characters.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Email too long.\")),",
            "            Regexp(UserObject.PATTERN_EMAIL, message=_(\"Must be a valid email address.\")),",
            "        ],",
            "    )",
            "    set_profile_info = SubmitField(_('Save changes'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_profile_info'",
            "",
            "    def populate_obj(self, user):",
            "        user.fullname = self.fullname.data",
            "        user.email = self.email.data",
            "        user.add()",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    action = HiddenField(default='set_password')",
            "    current = PasswordField(",
            "        _('Current password'),",
            "        validators=[InputRequired(_(\"Current password is missing.\"))],",
            "        description=_(\"You must provide your current password in order to change it.\"),",
            "    )",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "    set_password = SubmitField(_('Update password'))",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'set_password'",
            "",
            "    def validate_new(self, field):",
            "        \"\"\"",
            "        Make sure new password if not equals to old password.",
            "        \"\"\"",
            "        if self.new.data and self.new.data == self.current.data:",
            "            raise ValueError(_('The new password must be different from the current password.'))",
            "",
            "    def populate_obj(self, user):",
            "        # Check if current password is \"valid\" if Not, rate limit the",
            "        # number of attempts and logout user after too many invalid attempts.",
            "        if not user.validate_password(self.current.data):",
            "            cherrypy.session[CHANGE_PASSWORD_ATTEMPTS] = cherrypy.session.get(CHANGE_PASSWORD_ATTEMPTS, 0) + 1",
            "            attempts = cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "            if attempts >= CHANGE_PASSWORD_MAX_ATTEMPT:",
            "                cherrypy.session.clear()",
            "                cherrypy.session.regenerate()",
            "                flash(",
            "                    _(\"You were logged out because you entered the wrong password too many times.\"),",
            "                    level='warning',",
            "                )",
            "                raise cherrypy.HTTPRedirect('/login/')",
            "            self.current.errors = [_(\"Wrong current password.\")]",
            "            return False",
            "",
            "        # Clear number of attempts",
            "        if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:",
            "            del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]",
            "",
            "        try:",
            "            user.set_password(self.new.data)",
            "            return True",
            "        except ValueError as e:",
            "            self.new.errors = [str(e)]",
            "            return False",
            "",
            "",
            "class RefreshForm(CherryForm):",
            "    action = HiddenField(default='update_repos')",
            "    update_repos = SubmitField(",
            "        _('Refresh repositories'),",
            "        description=_(",
            "            \"Refresh the list of repositories associated to your account. If you recently add a new repository and it doesn't show, you may try to refresh the list.\"",
            "        ),",
            "    )",
            "",
            "    def is_submitted(self):",
            "        # Validate only if action is set_profile_info",
            "        return super().is_submitted() and self.action.data == 'update_repos'",
            "",
            "    def populate_obj(self, user):",
            "        try:",
            "            user.refresh_repos(delete=True)",
            "            flash(_(\"Repositories successfully updated\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "",
            "class PagePrefsGeneral(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    @cherrypy.expose",
            "    def default(self, **kwargs):",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(obj=self.app.currentuser)",
            "        password_form = UserPasswordForm()",
            "        refresh_form = RefreshForm()",
            "        if profile_form.is_submitted():",
            "            if profile_form.validate():",
            "                profile_form.populate_obj(self.app.currentuser)",
            "                flash(_(\"Profile updated successfully.\"), level='success')",
            "                raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(profile_form.error_message, level='error')",
            "        elif password_form.is_submitted():",
            "            if password_form.validate():",
            "                if password_form.populate_obj(self.app.currentuser):",
            "                    flash(_(\"Password updated successfully.\"), level='success')",
            "                    raise cherrypy.HTTPRedirect(\"\")",
            "            else:",
            "                flash(password_form.error_message, level='error')",
            "        elif refresh_form.is_submitted():",
            "            if refresh_form.validate():",
            "                refresh_form.populate_obj(self.app.currentuser)",
            "            else:",
            "                flash(refresh_form.error_message, level='error')",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "            'refresh_form': refresh_form,",
            "        }",
            "        return self._compile_template(\"prefs_general.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "105": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "106": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "107": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "108": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "109": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "110": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "111": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "112": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "113": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "114": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "115": [
                "UserPasswordForm",
                "populate_obj"
            ],
            "158": [
                "PagePrefsGeneral",
                "default"
            ]
        },
        "addLocation": [
            "rdiffweb.controller.page_pref_general.UserPasswordForm.self",
            "rdiffweb.controller.page_pref_general.PagePrefsGeneral.default.password_form"
        ]
    },
    "rdiffweb/controller/tests/test_page_prefs_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "             method='POST',"
            },
            "1": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "             body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},"
            },
            "2": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "         )"
            },
            "3": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+        self.assertStatus(303)"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+        self.getPage(self.PREFS)"
            },
            "6": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "         self.assertInBody(\"Profile updated successfully.\")"
            },
            "7": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "         # Then database is updated with fullname"
            },
            "8": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "         user = UserObject.query.filter(UserObject.username == self.USERNAME).first()"
            },
            "9": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "         # Given an authenticated user"
            },
            "10": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 107,
                "PatchRowcode": "         # When update the fullname"
            },
            "11": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": 108,
                "PatchRowcode": "         self._set_profile_info(\"test@test.com\", new_fullname)"
            },
            "12": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "13": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": 109,
                "PatchRowcode": "         if expected_valid:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+            self.assertStatus(303)"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 111,
                "PatchRowcode": "+            self.getPage(self.PREFS)"
            },
            "16": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "             self.assertInBody(\"Profile updated successfully.\")"
            },
            "17": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 113,
                "PatchRowcode": "             # Then database is updated with fullname"
            },
            "18": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 114,
                "PatchRowcode": "             self.assertInBody(new_fullname)"
            },
            "19": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 115,
                "PatchRowcode": "             user = UserObject.query.filter(UserObject.username == self.USERNAME).first()"
            },
            "20": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 116,
                "PatchRowcode": "             self.assertEqual(new_fullname, user.fullname)"
            },
            "21": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 117,
                "PatchRowcode": "         else:"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+            self.assertStatus(200)"
            },
            "23": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 119,
                "PatchRowcode": "             self.assertNotInBody(\"Profile updated successfully.\")"
            },
            "24": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 120,
                "PatchRowcode": " "
            },
            "25": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 121,
                "PatchRowcode": "     def test_change_fullname_method_get(self):"
            },
            "26": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 142,
                "PatchRowcode": " "
            },
            "27": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": 143,
                "PatchRowcode": "     def test_change_email(self):"
            },
            "28": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": 144,
                "PatchRowcode": "         self._set_profile_info(\"test@test.com\")"
            },
            "29": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+        self.assertStatus(303)"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+        self.getPage(self.PREFS)"
            },
            "32": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "         self.assertInBody(\"Profile updated successfully.\")"
            },
            "33": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": 148,
                "PatchRowcode": " "
            },
            "34": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": 149,
                "PatchRowcode": "     @parameterized.expand("
            },
            "35": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 160,
                "PatchRowcode": "     )"
            },
            "36": {
                "beforePatchRowNumber": 157,
                "afterPatchRowNumber": 161,
                "PatchRowcode": "     def test_change_email_with_invalid_email(self, new_email, expected_valid):"
            },
            "37": {
                "beforePatchRowNumber": 158,
                "afterPatchRowNumber": 162,
                "PatchRowcode": "         self._set_profile_info(new_email)"
            },
            "38": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        self.assertStatus(200)"
            },
            "39": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 163,
                "PatchRowcode": "         if expected_valid:"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+            self.assertStatus(303)"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+            self.getPage(self.PREFS)"
            },
            "42": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "             self.assertInBody(\"Profile updated successfully.\")"
            },
            "43": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "             self.assertNotInBody(\"Must be a valid email address.\")"
            },
            "44": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": 168,
                "PatchRowcode": "         else:"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 169,
                "PatchRowcode": "+            self.assertStatus(200)"
            },
            "46": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": 170,
                "PatchRowcode": "             self.assertNotInBody(\"Profile updated successfully.\")"
            },
            "47": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "             self.assertInBody(\"Must be a valid email address.\")"
            },
            "48": {
                "beforePatchRowNumber": 166,
                "afterPatchRowNumber": 172,
                "PatchRowcode": " "
            },
            "49": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 178,
                "PatchRowcode": "         self.listener.user_password_changed.reset_mock()"
            },
            "50": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": 179,
                "PatchRowcode": "         # When udating user's password"
            },
            "51": {
                "beforePatchRowNumber": 174,
                "afterPatchRowNumber": 180,
                "PatchRowcode": "         self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 181,
                "PatchRowcode": "+        # Then user is redirect to same page"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+        self.assertStatus(303)"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 183,
                "PatchRowcode": "+        # Then the page return success message."
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 184,
                "PatchRowcode": "+        self.getPage(self.PREFS)"
            },
            "56": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 185,
                "PatchRowcode": "         self.assertInBody(\"Password updated successfully.\")"
            },
            "57": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 186,
                "PatchRowcode": "         # Then a notification is raised"
            },
            "58": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": 187,
                "PatchRowcode": "         self.listener.user_password_changed.assert_called_once()"
            },
            "59": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": 218,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "60": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": 219,
                "PatchRowcode": "         self.assertInBody('You were logged out because you entered the wrong password too many times.')"
            },
            "61": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": 220,
                "PatchRowcode": " "
            },
            "62": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 221,
                "PatchRowcode": "+    def test_change_password_with_same_value(self):"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 222,
                "PatchRowcode": "+        # Given a user with a password"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 223,
                "PatchRowcode": "+        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "65": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 224,
                "PatchRowcode": "+        self.assertStatus(303)"
            },
            "66": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 225,
                "PatchRowcode": "+        # When updating the pasword with the same password"
            },
            "67": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 226,
                "PatchRowcode": "+        self._set_password(\"pr3j5Dwi\", \"pr3j5Dwi\", \"pr3j5Dwi\")"
            },
            "68": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 227,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "69": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 228,
                "PatchRowcode": "+        # Then an error should be displayed"
            },
            "70": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 229,
                "PatchRowcode": "+        self.assertInBody(\"The new password must be different from the current password.\")"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 230,
                "PatchRowcode": "+"
            },
            "72": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": 231,
                "PatchRowcode": "     def test_change_password_method_get(self):"
            },
            "73": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": 232,
                "PatchRowcode": "         # Given an authenticated user"
            },
            "74": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": 233,
                "PatchRowcode": "         # Trying to update password with GET method"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test', True),",
            "            ('My Fullname', True),",
            "        ]",
            "    )",
            "    def test_change_fullname(self, new_fullname, expected_valid):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", new_fullname)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            # Then database is updated with fullname",
            "            self.assertInBody(new_fullname)",
            "            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "            self.assertEqual(new_fullname, user.fullname)",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test@test.com', True),",
            "        ]",
            "    )",
            "    def test_change_email_with_invalid_email(self, new_email, expected_valid):",
            "        self._set_profile_info(new_email)",
            "        self.assertStatus(200)",
            "        if expected_valid:",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            self.assertNotInBody(\"Must be a valid email address.\")",
            "        else:",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "            self.assertInBody(\"Must be a valid email address.\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong current password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_too_many_attemps(self):",
            "        # When udating user's password with wrong current password 5 times",
            "        for _i in range(1, 5):",
            "            self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"Wrong current password.\")",
            "        # Then user session is cleared and user is redirect to login page",
            "        self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a warning message is displayed on login page",
            "        self.getPage('/login/')",
            "        self.assertStatus(200)",
            "        self.assertInBody('You were logged out because you entered the wrong password too many times.')",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "from parameterized import parameterized",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class PagePrefGeneralTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/general\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email, fullname=None):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        if fullname:",
            "            b['fullname'] = fullname",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_get_page(self):",
            "        # When querying the page",
            "        self.getPage(self.PREFS)",
            "        # Then the page is returned",
            "        self.assertStatus(200)",
            "        self.assertInBody('User profile')",
            "",
            "    def test_change_username_noop(self):",
            "        # Given an authenticated user",
            "        # When updating the username",
            "        self.getPage(",
            "            self.PREFS,",
            "            method='POST',",
            "            body={'action': 'set_profile_info', 'email': 'test@test.com', 'username': 'test'},",
            "        )",
            "        self.assertStatus(303)",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "        # Then database is updated with fullname",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertIsNotNone(user)",
            "        self.assertEqual(\"test@test.com\", user.email)",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test', True),",
            "            ('My Fullname', True),",
            "        ]",
            "    )",
            "    def test_change_fullname(self, new_fullname, expected_valid):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", new_fullname)",
            "        if expected_valid:",
            "            self.assertStatus(303)",
            "            self.getPage(self.PREFS)",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            # Then database is updated with fullname",
            "            self.assertInBody(new_fullname)",
            "            user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "            self.assertEqual(new_fullname, user.fullname)",
            "        else:",
            "            self.assertStatus(200)",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_fullname_method_get(self):",
            "        # Given an authenticated user",
            "        # When trying to update full name using GET method",
            "        self.getPage(self.PREFS + '?action=set_profile_info&email=test@test.com')",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_fullname_too_long(self):",
            "        # Given an authenticated user",
            "        # When update the fullname",
            "        self._set_profile_info(\"test@test.com\", \"Fullname\" * 50)",
            "        # Then page return with error message",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Profile updated successfully.\")",
            "        self.assertInBody(\"Fullname too long.\")",
            "        # Then database is not updated",
            "        user = UserObject.query.filter(UserObject.username == self.USERNAME).first()",
            "        self.assertEqual(\"\", user.fullname)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertStatus(303)",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    @parameterized.expand(",
            "        [",
            "            # Invalid",
            "            ('@test.com', False),",
            "            ('test.com', False),",
            "            ('test', False),",
            "            ('test@te_st.com', False),",
            "            ('test@test.com, test2@test.com', False),",
            "            # Valid",
            "            ('test@test.com', True),",
            "        ]",
            "    )",
            "    def test_change_email_with_invalid_email(self, new_email, expected_valid):",
            "        self._set_profile_info(new_email)",
            "        if expected_valid:",
            "            self.assertStatus(303)",
            "            self.getPage(self.PREFS)",
            "            self.assertInBody(\"Profile updated successfully.\")",
            "            self.assertNotInBody(\"Must be a valid email address.\")",
            "        else:",
            "            self.assertStatus(200)",
            "            self.assertNotInBody(\"Profile updated successfully.\")",
            "            self.assertInBody(\"Must be a valid email address.\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_change_password(self):",
            "        self.listener.user_password_changed.reset_mock()",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        # Then user is redirect to same page",
            "        self.assertStatus(303)",
            "        # Then the page return success message.",
            "        self.getPage(self.PREFS)",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertInBody(\"Wrong current password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_too_many_attemps(self):",
            "        # When udating user's password with wrong current password 5 times",
            "        for _i in range(1, 5):",
            "            self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"Wrong current password.\")",
            "        # Then user session is cleared and user is redirect to login page",
            "        self._set_password('wrong', \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(303)",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/')",
            "        # Then a warning message is displayed on login page",
            "        self.getPage('/login/')",
            "        self.assertStatus(200)",
            "        self.assertInBody('You were logged out because you entered the wrong password too many times.')",
            "",
            "    def test_change_password_with_same_value(self):",
            "        # Given a user with a password",
            "        self._set_password(self.PASSWORD, \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(303)",
            "        # When updating the pasword with the same password",
            "        self._set_password(\"pr3j5Dwi\", \"pr3j5Dwi\", \"pr3j5Dwi\")",
            "        self.assertStatus(200)",
            "        # Then an error should be displayed",
            "        self.assertInBody(\"The new password must be different from the current password.\")",
            "",
            "    def test_change_password_method_get(self):",
            "        # Given an authenticated user",
            "        # Trying to update password with GET method",
            "        self.getPage(self.PREFS + '?action=set_password&new=pr3j5Dwi&confirm=pr3j5Dwi&current=' + self.PASSWORD)",
            "        # Then nothing happen",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(\"Password updated successfully.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = UserObject.get_user(self.USERNAME)",
            "        RepoObject(userid=userobj.userid, repopath='invalid').add()",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        userobj.expire()",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "85": [
                "PagePrefGeneralTest",
                "test_change_username_noop"
            ],
            "108": [
                "PagePrefGeneralTest",
                "test_change_fullname"
            ],
            "142": [
                "PagePrefGeneralTest",
                "test_change_email"
            ],
            "159": [
                "PagePrefGeneralTest",
                "test_change_email_with_invalid_email"
            ]
        },
        "addLocation": []
    }
}