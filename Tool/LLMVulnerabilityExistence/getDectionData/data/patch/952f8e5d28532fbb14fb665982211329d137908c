{
    "omeroweb/decorators.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 582,
                "afterPatchRowNumber": 582,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 583,
                "afterPatchRowNumber": 583,
                "PatchRowcode": "     def prepare_context(self, request, context, *args, **kwargs):"
            },
            "2": {
                "beforePatchRowNumber": 584,
                "afterPatchRowNumber": 584,
                "PatchRowcode": "         \"\"\" Hook for adding additional data to the context dict \"\"\""
            },
            "3": {
                "beforePatchRowNumber": 585,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        pass"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 585,
                "PatchRowcode": "+        context[\"html\"] = context.get(\"html\", {})"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 586,
                "PatchRowcode": "+        context[\"html\"][\"meta_referrer\"] = settings.HTML_META_REFERRER"
            },
            "6": {
                "beforePatchRowNumber": 586,
                "afterPatchRowNumber": 587,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 587,
                "afterPatchRowNumber": 588,
                "PatchRowcode": "     def __call__(ctx, f):"
            },
            "8": {
                "beforePatchRowNumber": 588,
                "afterPatchRowNumber": 589,
                "PatchRowcode": "         \"\"\" Here we wrap the view method f and return the wrapped method \"\"\""
            }
        },
        "frontPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "",
            "#",
            "# Copyright (C) 2011-2020 University of Dundee & Open Microscopy Environment.",
            "# All rights reserved.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "",
            "\"\"\"",
            "Decorators for use with OMERO.web applications.",
            "\"\"\"",
            "",
            "import logging",
            "import traceback",
            "from django.http import Http404, HttpResponseRedirect, JsonResponse",
            "from django.http.response import HttpResponseBase",
            "from django.shortcuts import render",
            "from django.http import HttpResponseForbidden, StreamingHttpResponse",
            "",
            "from django.conf import settings",
            "from django.utils.http import urlencode",
            "from functools import update_wrapper",
            "from django.core.urlresolvers import reverse, resolve, NoReverseMatch",
            "from django.core.cache import cache",
            "",
            "from omeroweb.utils import reverse_with_params",
            "from omeroweb.connector import Connector",
            "from omero.gateway.utils import propertiesToDict",
            "from omero import ApiUsageException",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def parse_url(lookup_view):",
            "    if not lookup_view:",
            "        raise ValueError(\"No lookup_view\")",
            "    url = None",
            "    try:",
            "        url = reverse_with_params(",
            "            viewname=lookup_view[\"viewname\"],",
            "            args=lookup_view.get(\"args\", []),",
            "            query_string=lookup_view.get(\"query_string\", None),",
            "        )",
            "    except KeyError:",
            "        # assume we've been passed a url",
            "        try:",
            "            resolve(lookup_view)",
            "            url = lookup_view",
            "        except Exception:",
            "            pass",
            "    if url is None:",
            "        logger.error(\"Reverse for '%s' not found.\" % lookup_view)",
            "        raise NoReverseMatch(\"Reverse for '%s' not found.\" % lookup_view)",
            "    return url",
            "",
            "",
            "def get_client_ip(request):",
            "    x_forwarded_for = request.META.get(\"HTTP_X_FORWARDED_FOR\")",
            "    if x_forwarded_for:",
            "        ip = x_forwarded_for.split(\",\")[-1].strip()",
            "    else:",
            "        ip = request.META.get(\"REMOTE_ADDR\")",
            "    return ip",
            "",
            "",
            "def is_public_user(request):",
            "    \"\"\"",
            "    Is the session connector created for public user?",
            "",
            "    Returns None if no connector found",
            "    \"\"\"",
            "    connector = request.session.get(\"connector\")",
            "    if connector is not None:",
            "        return connector.is_public",
            "",
            "",
            "class ConnCleaningHttpResponse(StreamingHttpResponse):",
            "    \"\"\"Extension of L{HttpResponse} which closes the OMERO connection.\"\"\"",
            "",
            "    def close(self):",
            "        super(ConnCleaningHttpResponse, self).close()",
            "        try:",
            "            logger.debug(\"Closing OMERO connection in %r\" % self)",
            "            if self.conn is not None and self.conn.c is not None:",
            "                self.conn.close(hard=False)",
            "        except Exception:",
            "            logger.error(\"Failed to clean up connection.\", exc_info=True)",
            "",
            "",
            "class TableClosingHttpResponse(ConnCleaningHttpResponse):",
            "    \"\"\"Extension of L{HttpResponse} which closes the OMERO connection.\"\"\"",
            "",
            "    def close(self):",
            "        try:",
            "            if self.table is not None:",
            "                self.table.close()",
            "        except Exception:",
            "            logger.error(\"Failed to close OMERO.table.\", exc_info=True)",
            "        # Now call super to close conn",
            "        super(TableClosingHttpResponse, self).close()",
            "",
            "",
            "class login_required(object):",
            "    \"\"\"",
            "    OMERO.web specific extension of the Django login_required() decorator,",
            "    https://docs.djangoproject.com/en/dev/topics/auth/, which is responsible",
            "    for ensuring a valid L{omero.gateway.BlitzGateway} connection. Is",
            "    configurable by various options.",
            "",
            "    doConnectionCleanup:",
            "        Used to indicate methods that may return ConnCleaningHttpResponse.",
            "        If True (default), then returning a ConnCleaningHttpResponse will",
            "        raise an Exception since cleanup is intended to be immediate; if",
            "        False, connection cleanup will be skipped ONLY when a",
            "        ConnCleaningHttpResponse is returned.",
            "    \"\"\"",
            "",
            "    def __init__(",
            "        self,",
            "        useragent=\"OMERO.web\",",
            "        isAdmin=False,",
            "        isGroupOwner=False,",
            "        doConnectionCleanup=True,",
            "        omero_group=\"-1\",",
            "        allowPublic=None,",
            "    ):",
            "        \"\"\"",
            "        Initialises the decorator.",
            "        \"\"\"",
            "        self.useragent = useragent",
            "        self.isAdmin = isAdmin",
            "        self.isGroupOwner = isGroupOwner",
            "        self.doConnectionCleanup = doConnectionCleanup",
            "        self.omero_group = omero_group",
            "        self.allowPublic = allowPublic",
            "",
            "    # To make django's method_decorator work, this is required until",
            "    # python/django sort out how argumented decorator wrapping should work",
            "    # https://github.com/openmicroscopy/openmicroscopy/pull/1820",
            "    def __getattr__(self, name):",
            "        if name == \"__name__\":",
            "            return self.__class__.__name__",
            "        else:",
            "            return super(login_required, self).getattr(name)",
            "",
            "    def get_login_url(self):",
            "        \"\"\"The URL that should be redirected to if not logged in.\"\"\"",
            "        return reverse(settings.LOGIN_VIEW)",
            "",
            "    login_url = property(get_login_url)",
            "",
            "    def get_share_connection(self, request, conn, share_id):",
            "        try:",
            "            conn.SERVICE_OPTS.setOmeroShare(share_id)",
            "            conn.getShare(share_id)",
            "            return conn",
            "        except Exception:",
            "            logger.error(\"Error activating share.\", exc_info=True)",
            "            return None",
            "",
            "    def prepare_share_connection(self, request, conn, share_id):",
            "        \"\"\"Prepares the share connection if we have a valid share ID.\"\"\"",
            "        # we always need to clear any dirty 'omero.share' values from previous",
            "        # calls",
            "        conn.SERVICE_OPTS.setOmeroShare()",
            "        if share_id is None:",
            "            return None",
            "        share = conn.getShare(share_id)",
            "        try:",
            "            if share.getOwner().id != conn.getUserId():",
            "                if share.active and not share.isExpired():",
            "                    return self.get_share_connection(request, conn, share_id)",
            "                logger.debug(\"Share is unavailable.\")",
            "                return None",
            "        except Exception:",
            "            logger.error(\"Error retrieving share connection.\", exc_info=True)",
            "            return None",
            "",
            "    def on_not_logged_in(self, request, url, error=None):",
            "        \"\"\"Called whenever the user is not logged in.\"\"\"",
            "        if request.is_ajax():",
            "            logger.debug(\"Request is Ajax, returning HTTP 403.\")",
            "            return HttpResponseForbidden()",
            "",
            "        try:",
            "            for lookup_view in settings.LOGIN_REDIRECT[\"redirect\"]:",
            "                try:",
            "                    if url == reverse(lookup_view):",
            "                        url = parse_url(settings.LOGIN_REDIRECT)",
            "                except NoReverseMatch:",
            "                    try:",
            "                        resolve(lookup_view)",
            "                        if url == lookup_view:",
            "                            url = parse_url(settings.LOGIN_REDIRECT)",
            "                    except Http404:",
            "                        logger.error(\"Cannot resolve url %s\" % lookup_view)",
            "        except KeyError:",
            "            pass",
            "        except Exception:",
            "            logger.error(\"Error while redirection on not logged in.\", exc_info=True)",
            "",
            "        args = {\"url\": url}",
            "",
            "        logger.debug(",
            "            \"Request is not Ajax, redirecting to %s?%s\"",
            "            % (self.login_url, urlencode(args))",
            "        )",
            "        return HttpResponseRedirect(\"%s?%s\" % (self.login_url, urlencode(args)))",
            "",
            "    def on_logged_in(self, request, conn):",
            "        \"\"\"",
            "        Called whenever the users is successfully logged in.",
            "        Sets the 'omero.group' option if specified in the constructor",
            "        \"\"\"",
            "        if self.omero_group is not None:",
            "            conn.SERVICE_OPTS.setOmeroGroup(self.omero_group)",
            "",
            "    def on_share_connection_prepared(self, request, conn_share):",
            "        \"\"\"Called whenever a share connection is successfully prepared.\"\"\"",
            "        pass",
            "",
            "    def verify_is_admin(self, conn):",
            "        \"\"\"",
            "        If we have been requested to by the isAdmin flag, verify the user",
            "        is an admin and raise an exception if they are not.",
            "        \"\"\"",
            "        if self.isAdmin and not conn.isAdmin():",
            "            raise Http404",
            "",
            "    def verify_is_group_owner(self, conn, gid):",
            "        \"\"\"",
            "        If we have been requested to by the isGroupOwner flag, verify the user",
            "        is the owner of the provided group. If no group is provided the user's",
            "        active session group ownership will be verified.",
            "        \"\"\"",
            "        if not self.isGroupOwner:",
            "            return",
            "        if gid is not None:",
            "            if not conn.isLeader(gid):",
            "                raise Http404",
            "        else:",
            "            if not conn.isLeader():",
            "                raise Http404",
            "",
            "    def is_valid_public_url(self, server_id, request):",
            "        \"\"\"",
            "        Verifies that the URL for the resource being requested falls within",
            "        the scope of the OMERO.webpublic URL filter.",
            "        \"\"\"",
            "        if settings.PUBLIC_ENABLED:",
            "            if not hasattr(settings, \"PUBLIC_USER\"):",
            "                logger.warn(",
            "                    \"OMERO.webpublic enabled but public user \"",
            "                    \"(omero.web.public.user) not set, disabling \"",
            "                    \"OMERO.webpublic.\"",
            "                )",
            "                settings.PUBLIC_ENABLED = False",
            "                return False",
            "            if not hasattr(settings, \"PUBLIC_PASSWORD\"):",
            "                logger.warn(",
            "                    \"OMERO.webpublic enabled but public user \"",
            "                    \"password (omero.web.public.password) not set, \"",
            "                    \"disabling OMERO.webpublic.\"",
            "                )",
            "                settings.PUBLIC_ENABLED = False",
            "                return False",
            "            if settings.PUBLIC_GET_ONLY and (request.method != \"GET\"):",
            "                return False",
            "            if self.allowPublic is None:",
            "                return settings.PUBLIC_URL_FILTER.search(request.path) is not None",
            "            return self.allowPublic",
            "        return False",
            "",
            "    def load_server_settings(self, conn, request):",
            "        \"\"\"Loads Client preferences and Read-Only status from the server.\"\"\"",
            "        try:",
            "            request.session[\"can_create\"]",
            "        except KeyError:",
            "            request.session.modified = True",
            "            request.session[\"can_create\"] = conn.canCreate()",
            "        try:",
            "            request.session[\"server_settings\"]",
            "        except Exception:",
            "            request.session.modified = True",
            "            request.session[\"server_settings\"] = {}",
            "            try:",
            "                request.session[\"server_settings\"] = propertiesToDict(",
            "                    conn.getClientSettings(), prefix=\"omero.client.\"",
            "                )",
            "            except Exception:",
            "                logger.error(traceback.format_exc())",
            "            # make extra call for omero.mail, not a part of omero.client",
            "            request.session[\"server_settings\"][\"email\"] = conn.getEmailSettings()",
            "",
            "    def get_public_user_connector(self):",
            "        \"\"\"",
            "        Returns the current cached OMERO.webpublic connector or None if",
            "        nothing has been cached.",
            "        \"\"\"",
            "        if not settings.PUBLIC_CACHE_ENABLED:",
            "            return",
            "        return cache.get(settings.PUBLIC_CACHE_KEY)",
            "",
            "    def set_public_user_connector(self, connector):",
            "        \"\"\"Sets the current cached OMERO.webpublic connector.\"\"\"",
            "        if not settings.PUBLIC_CACHE_ENABLED or connector.omero_session_key is None:",
            "            return",
            "        logger.debug(\"Setting OMERO.webpublic connector: %r\" % connector)",
            "        cache.set(settings.PUBLIC_CACHE_KEY, connector, settings.PUBLIC_CACHE_TIMEOUT)",
            "",
            "    def get_connection(self, server_id, request):",
            "        \"\"\"",
            "        Prepares a Blitz connection wrapper (from L{omero.gateway}) for",
            "        use with a view function.",
            "        \"\"\"",
            "        connection = self.get_authenticated_connection(server_id, request)",
            "        is_valid_public_url = self.is_valid_public_url(server_id, request)",
            "        logger.debug(\"Is valid public URL? %s\" % is_valid_public_url)",
            "        if connection is None and is_valid_public_url:",
            "            # If OMERO.webpublic is enabled, pick up a username and",
            "            # password from configuration and use those credentials to",
            "            # create a connection.",
            "            logger.debug(",
            "                \"OMERO.webpublic enabled, attempting to login \"",
            "                \"with configuration supplied credentials.\"",
            "            )",
            "            if server_id is None:",
            "                server_id = settings.PUBLIC_SERVER_ID",
            "            username = settings.PUBLIC_USER",
            "            password = settings.PUBLIC_PASSWORD",
            "            is_secure = settings.SECURE",
            "            logger.debug(\"Is SSL? %s\" % is_secure)",
            "            # Try and use a cached OMERO.webpublic user session key.",
            "            public_user_connector = self.get_public_user_connector()",
            "            if public_user_connector is not None:",
            "                logger.debug(",
            "                    \"Attempting to use cached OMERO.webpublic \"",
            "                    \"connector: %r\" % public_user_connector",
            "                )",
            "                connection = public_user_connector.join_connection(self.useragent)",
            "                if connection is not None:",
            "                    request.session[\"connector\"] = public_user_connector",
            "                    logger.debug(",
            "                        \"Attempt to use cached OMERO.web public \"",
            "                        \"session key successful!\"",
            "                    )",
            "                    return connection",
            "                logger.debug(",
            "                    \"Attempt to use cached OMERO.web public \" \"session key failed.\"",
            "                )",
            "            # We don't have a cached OMERO.webpublic user session key,",
            "            # create a new connection based on the credentials we've been",
            "            # given.",
            "            connector = Connector(server_id, is_secure)",
            "            connection = connector.create_connection(",
            "                self.useragent,",
            "                username,",
            "                password,",
            "                is_public=True,",
            "                userip=get_client_ip(request),",
            "            )",
            "            request.session[\"connector\"] = connector",
            "            # Clear any previous context so we don't try to access this",
            "            # NB: we also do this in WebclientLoginView.handle_logged_in()",
            "            if \"active_group\" in request.session:",
            "                del request.session[\"active_group\"]",
            "            if \"user_id\" in request.session:",
            "                del request.session[\"user_id\"]",
            "            request.session.modified = True",
            "            self.set_public_user_connector(connector)",
            "        elif connection is not None:",
            "            is_anonymous = connection.isAnonymous()",
            "            logger.debug(\"Is anonymous? %s\" % is_anonymous)",
            "            if is_anonymous and not is_valid_public_url:",
            "                if connection.c is not None:",
            "                    logger.debug(\"Closing anonymous connection\")",
            "                    connection.close(hard=False)",
            "                return None",
            "        return connection",
            "",
            "    def get_authenticated_connection(self, server_id, request):",
            "        \"\"\"",
            "        Prepares an authenticated Blitz connection wrapper (from",
            "        L{omero.gateway}) for use with a view function.",
            "        \"\"\"",
            "        # TODO: Handle previous try_super logic; is it still needed?",
            "",
            "        userip = get_client_ip(request)",
            "        session = request.session",
            "        request = request.GET",
            "        is_secure = settings.SECURE",
            "        logger.debug(\"Is SSL? %s\" % is_secure)",
            "        connector = session.get(\"connector\", None)",
            "        logger.debug(\"Connector: %s\" % connector)",
            "",
            "        if server_id is None:",
            "            # If no server id is passed, the db entry will not be used and",
            "            # instead we'll depend on the request.session and request.GET",
            "            # values",
            "            if connector is not None:",
            "                server_id = connector.server_id",
            "            else:",
            "                try:",
            "                    server_id = request[\"server\"]",
            "                except Exception:",
            "                    logger.debug(\"No Server ID available.\")",
            "                    return None",
            "",
            "        # If we have an OMERO session key in our request variables attempt",
            "        # to make a connection based on those credentials.",
            "        try:",
            "            omero_session_key = request[\"bsession\"]",
            "            connector = Connector(server_id, is_secure)",
            "        except KeyError:",
            "            # We do not have an OMERO session key in the current request.",
            "            pass",
            "        else:",
            "            # We have an OMERO session key in the current request use it",
            "            # to try join an existing connection / OMERO session.",
            "            logger.debug(",
            "                \"Have OMERO session key %s, attempting to join...\" % omero_session_key",
            "            )",
            "            connector.user_id = None",
            "            connector.omero_session_key = omero_session_key",
            "            connection = connector.join_connection(self.useragent, userip)",
            "            session[\"connector\"] = connector",
            "            return connection",
            "",
            "        # An OMERO session is not available, we're either trying to service",
            "        # a request to a login page or an anonymous request.",
            "        username = None",
            "        password = None",
            "        try:",
            "            username = request[\"username\"]",
            "            password = request[\"password\"]",
            "        except KeyError:",
            "            if connector is None:",
            "                logger.debug(\"No username or password in request, exiting.\")",
            "                # We do not have an OMERO session or a username and password",
            "                # in the current request and we do not have a valid connector.",
            "                # Raise an error (return None).",
            "                return None",
            "",
            "        if username is not None and password is not None:",
            "            # We have a username and password in the current request, or",
            "            # OMERO.webpublic is enabled and has provided us with a username",
            "            # and password via configureation. Use them to try and create a",
            "            # new connection / OMERO session.",
            "            logger.debug(\"Creating connection with username and password...\")",
            "            connector = Connector(server_id, is_secure)",
            "            connection = connector.create_connection(",
            "                self.useragent, username, password, userip=userip",
            "            )",
            "            session[\"connector\"] = connector",
            "            return connection",
            "",
            "        logger.debug(\"Django session connector: %r\" % connector)",
            "        if connector is not None:",
            "            # We have a connector, attempt to use it to join an existing",
            "            # connection / OMERO session.",
            "            connection = connector.join_connection(self.useragent, userip)",
            "            if connection is not None:",
            "                logger.debug(\"Connector valid, session successfully joined.\")",
            "                return connection",
            "            # Fall through, we the session we've been asked to join may",
            "            # be invalid and we may have other credentials as request",
            "            # variables.",
            "            logger.debug(\"Connector is no longer valid, destroying...\")",
            "            del session[\"connector\"]",
            "            return None",
            "",
            "        session[\"connector\"] = connector",
            "        return None",
            "",
            "    def __call__(ctx, f):",
            "        \"\"\"",
            "        Tries to prepare a logged in connection, then calls function and",
            "        returns the result.",
            "        \"\"\"",
            "",
            "        def wrapped(request, *args, **kwargs):",
            "            url = request.GET.get(\"url\")",
            "            if url is None or len(url) == 0:",
            "                url = request.get_full_path()",
            "",
            "            doConnectionCleanup = False",
            "",
            "            conn = kwargs.get(\"conn\", None)",
            "            error = None",
            "            server_id = kwargs.get(\"server_id\", None)",
            "            # Short circuit connection retrieval when a connection was",
            "            # provided to us via 'conn'. This is useful when in testing",
            "            # mode or when stacking view functions/methods.",
            "            if conn is None:",
            "                doConnectionCleanup = ctx.doConnectionCleanup",
            "                logger.debug(\"Connection not provided, attempting to get one.\")",
            "                try:",
            "                    conn = ctx.get_connection(server_id, request)",
            "                except Exception as x:",
            "                    logger.error(\"Error retrieving connection.\", exc_info=True)",
            "                    error = str(x)",
            "                else:",
            "                    # various configuration & checks only performed on new",
            "                    # 'conn'",
            "                    if conn is None:",
            "                        return ctx.on_not_logged_in(request, url, error)",
            "                    else:",
            "                        ctx.on_logged_in(request, conn)",
            "                    ctx.verify_is_admin(conn)",
            "                    ctx.verify_is_group_owner(conn, kwargs.get(\"gid\"))",
            "                    ctx.load_server_settings(conn, request)",
            "",
            "                    share_id = kwargs.get(\"share_id\")",
            "                    conn_share = ctx.prepare_share_connection(request, conn, share_id)",
            "                    if conn_share is not None:",
            "                        ctx.on_share_connection_prepared(request, conn_share)",
            "                        kwargs[\"conn\"] = conn_share",
            "                    else:",
            "                        kwargs[\"conn\"] = conn",
            "",
            "                    # kwargs['error'] = request.GET.get('error')",
            "                    kwargs[\"url\"] = url",
            "            retval = None",
            "            try:",
            "                retval = f(request, *args, **kwargs)",
            "            finally:",
            "                # If f() raised Exception, e.g. Http404() we must still cleanup",
            "                delayConnectionCleanup = isinstance(retval, ConnCleaningHttpResponse)",
            "                if doConnectionCleanup and delayConnectionCleanup:",
            "                    raise ApiUsageException(",
            "                        \"Methods that return a\"",
            "                        \" ConnCleaningHttpResponse must be marked with\"",
            "                        \" @login_required(doConnectionCleanup=False)\"",
            "                    )",
            "                doConnectionCleanup = not delayConnectionCleanup",
            "                logger.debug(\"Doing connection cleanup? %s\" % doConnectionCleanup)",
            "                try:",
            "                    if doConnectionCleanup:",
            "                        if conn is not None and conn.c is not None:",
            "                            conn.close(hard=False)",
            "                except Exception:",
            "                    logger.warn(\"Failed to clean up connection\", exc_info=True)",
            "            return retval",
            "",
            "        return update_wrapper(wrapped, f)",
            "",
            "",
            "class render_response(object):",
            "    \"\"\"",
            "    This decorator handles the rendering of view methods to HttpResponse. It",
            "    expects that wrapped view methods return a dict. This allows:",
            "    - The template to be specified in the method arguments OR within the view",
            "      method itself",
            "    - The dict to be returned as json if required",
            "    - The request is passed to the template context, as required by some tags",
            "      etc",
            "    - A hook is provided for adding additional data to the context, from the",
            "      L{omero.gateway.BlitzGateway} or from the request.",
            "    \"\"\"",
            "",
            "    # To make django's method_decorator work, this is required until",
            "    # python/django sort out how argumented decorator wrapping should work",
            "    # https://github.com/openmicroscopy/openmicroscopy/pull/1820",
            "    def __getattr__(self, name):",
            "        if name == \"__name__\":",
            "            return self.__class__.__name__",
            "        else:",
            "            return super(render_response, self).getattr(name)",
            "",
            "    def prepare_context(self, request, context, *args, **kwargs):",
            "        \"\"\" Hook for adding additional data to the context dict \"\"\"",
            "        pass",
            "",
            "    def __call__(ctx, f):",
            "        \"\"\" Here we wrap the view method f and return the wrapped method \"\"\"",
            "",
            "        def wrapper(request, *args, **kwargs):",
            "            \"\"\"",
            "            Wrapper calls the view function, processes the result and returns",
            "            HttpResponse\"\"\"",
            "",
            "            # call the view function itself...",
            "            context = f(request, *args, **kwargs)",
            "",
            "            # if we happen to have a Response, return it",
            "            if isinstance(context, HttpResponseBase):",
            "                return context",
            "",
            "            # get template from view dict. Can be overridden from the **kwargs",
            "            template = \"template\" in context and context[\"template\"] or None",
            "            template = kwargs.get(\"template\", template)",
            "            logger.debug(\"Rendering template: %s\" % template)",
            "",
            "            # allows us to return the dict as json  (NB: BlitzGateway objects",
            "            # don't serialize)",
            "            if template is None or template == \"json\":",
            "                # We still need to support non-dict data:",
            "                safe = type(context) is dict",
            "                return JsonResponse(context, safe=safe)",
            "            else:",
            "                # allow additional processing of context dict",
            "                ctx.prepare_context(request, context, *args, **kwargs)",
            "                return render(request, template, context)",
            "",
            "        return update_wrapper(wrapper, f)"
        ],
        "afterPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "",
            "#",
            "# Copyright (C) 2011-2020 University of Dundee & Open Microscopy Environment.",
            "# All rights reserved.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "",
            "\"\"\"",
            "Decorators for use with OMERO.web applications.",
            "\"\"\"",
            "",
            "import logging",
            "import traceback",
            "from django.http import Http404, HttpResponseRedirect, JsonResponse",
            "from django.http.response import HttpResponseBase",
            "from django.shortcuts import render",
            "from django.http import HttpResponseForbidden, StreamingHttpResponse",
            "",
            "from django.conf import settings",
            "from django.utils.http import urlencode",
            "from functools import update_wrapper",
            "from django.core.urlresolvers import reverse, resolve, NoReverseMatch",
            "from django.core.cache import cache",
            "",
            "from omeroweb.utils import reverse_with_params",
            "from omeroweb.connector import Connector",
            "from omero.gateway.utils import propertiesToDict",
            "from omero import ApiUsageException",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def parse_url(lookup_view):",
            "    if not lookup_view:",
            "        raise ValueError(\"No lookup_view\")",
            "    url = None",
            "    try:",
            "        url = reverse_with_params(",
            "            viewname=lookup_view[\"viewname\"],",
            "            args=lookup_view.get(\"args\", []),",
            "            query_string=lookup_view.get(\"query_string\", None),",
            "        )",
            "    except KeyError:",
            "        # assume we've been passed a url",
            "        try:",
            "            resolve(lookup_view)",
            "            url = lookup_view",
            "        except Exception:",
            "            pass",
            "    if url is None:",
            "        logger.error(\"Reverse for '%s' not found.\" % lookup_view)",
            "        raise NoReverseMatch(\"Reverse for '%s' not found.\" % lookup_view)",
            "    return url",
            "",
            "",
            "def get_client_ip(request):",
            "    x_forwarded_for = request.META.get(\"HTTP_X_FORWARDED_FOR\")",
            "    if x_forwarded_for:",
            "        ip = x_forwarded_for.split(\",\")[-1].strip()",
            "    else:",
            "        ip = request.META.get(\"REMOTE_ADDR\")",
            "    return ip",
            "",
            "",
            "def is_public_user(request):",
            "    \"\"\"",
            "    Is the session connector created for public user?",
            "",
            "    Returns None if no connector found",
            "    \"\"\"",
            "    connector = request.session.get(\"connector\")",
            "    if connector is not None:",
            "        return connector.is_public",
            "",
            "",
            "class ConnCleaningHttpResponse(StreamingHttpResponse):",
            "    \"\"\"Extension of L{HttpResponse} which closes the OMERO connection.\"\"\"",
            "",
            "    def close(self):",
            "        super(ConnCleaningHttpResponse, self).close()",
            "        try:",
            "            logger.debug(\"Closing OMERO connection in %r\" % self)",
            "            if self.conn is not None and self.conn.c is not None:",
            "                self.conn.close(hard=False)",
            "        except Exception:",
            "            logger.error(\"Failed to clean up connection.\", exc_info=True)",
            "",
            "",
            "class TableClosingHttpResponse(ConnCleaningHttpResponse):",
            "    \"\"\"Extension of L{HttpResponse} which closes the OMERO connection.\"\"\"",
            "",
            "    def close(self):",
            "        try:",
            "            if self.table is not None:",
            "                self.table.close()",
            "        except Exception:",
            "            logger.error(\"Failed to close OMERO.table.\", exc_info=True)",
            "        # Now call super to close conn",
            "        super(TableClosingHttpResponse, self).close()",
            "",
            "",
            "class login_required(object):",
            "    \"\"\"",
            "    OMERO.web specific extension of the Django login_required() decorator,",
            "    https://docs.djangoproject.com/en/dev/topics/auth/, which is responsible",
            "    for ensuring a valid L{omero.gateway.BlitzGateway} connection. Is",
            "    configurable by various options.",
            "",
            "    doConnectionCleanup:",
            "        Used to indicate methods that may return ConnCleaningHttpResponse.",
            "        If True (default), then returning a ConnCleaningHttpResponse will",
            "        raise an Exception since cleanup is intended to be immediate; if",
            "        False, connection cleanup will be skipped ONLY when a",
            "        ConnCleaningHttpResponse is returned.",
            "    \"\"\"",
            "",
            "    def __init__(",
            "        self,",
            "        useragent=\"OMERO.web\",",
            "        isAdmin=False,",
            "        isGroupOwner=False,",
            "        doConnectionCleanup=True,",
            "        omero_group=\"-1\",",
            "        allowPublic=None,",
            "    ):",
            "        \"\"\"",
            "        Initialises the decorator.",
            "        \"\"\"",
            "        self.useragent = useragent",
            "        self.isAdmin = isAdmin",
            "        self.isGroupOwner = isGroupOwner",
            "        self.doConnectionCleanup = doConnectionCleanup",
            "        self.omero_group = omero_group",
            "        self.allowPublic = allowPublic",
            "",
            "    # To make django's method_decorator work, this is required until",
            "    # python/django sort out how argumented decorator wrapping should work",
            "    # https://github.com/openmicroscopy/openmicroscopy/pull/1820",
            "    def __getattr__(self, name):",
            "        if name == \"__name__\":",
            "            return self.__class__.__name__",
            "        else:",
            "            return super(login_required, self).getattr(name)",
            "",
            "    def get_login_url(self):",
            "        \"\"\"The URL that should be redirected to if not logged in.\"\"\"",
            "        return reverse(settings.LOGIN_VIEW)",
            "",
            "    login_url = property(get_login_url)",
            "",
            "    def get_share_connection(self, request, conn, share_id):",
            "        try:",
            "            conn.SERVICE_OPTS.setOmeroShare(share_id)",
            "            conn.getShare(share_id)",
            "            return conn",
            "        except Exception:",
            "            logger.error(\"Error activating share.\", exc_info=True)",
            "            return None",
            "",
            "    def prepare_share_connection(self, request, conn, share_id):",
            "        \"\"\"Prepares the share connection if we have a valid share ID.\"\"\"",
            "        # we always need to clear any dirty 'omero.share' values from previous",
            "        # calls",
            "        conn.SERVICE_OPTS.setOmeroShare()",
            "        if share_id is None:",
            "            return None",
            "        share = conn.getShare(share_id)",
            "        try:",
            "            if share.getOwner().id != conn.getUserId():",
            "                if share.active and not share.isExpired():",
            "                    return self.get_share_connection(request, conn, share_id)",
            "                logger.debug(\"Share is unavailable.\")",
            "                return None",
            "        except Exception:",
            "            logger.error(\"Error retrieving share connection.\", exc_info=True)",
            "            return None",
            "",
            "    def on_not_logged_in(self, request, url, error=None):",
            "        \"\"\"Called whenever the user is not logged in.\"\"\"",
            "        if request.is_ajax():",
            "            logger.debug(\"Request is Ajax, returning HTTP 403.\")",
            "            return HttpResponseForbidden()",
            "",
            "        try:",
            "            for lookup_view in settings.LOGIN_REDIRECT[\"redirect\"]:",
            "                try:",
            "                    if url == reverse(lookup_view):",
            "                        url = parse_url(settings.LOGIN_REDIRECT)",
            "                except NoReverseMatch:",
            "                    try:",
            "                        resolve(lookup_view)",
            "                        if url == lookup_view:",
            "                            url = parse_url(settings.LOGIN_REDIRECT)",
            "                    except Http404:",
            "                        logger.error(\"Cannot resolve url %s\" % lookup_view)",
            "        except KeyError:",
            "            pass",
            "        except Exception:",
            "            logger.error(\"Error while redirection on not logged in.\", exc_info=True)",
            "",
            "        args = {\"url\": url}",
            "",
            "        logger.debug(",
            "            \"Request is not Ajax, redirecting to %s?%s\"",
            "            % (self.login_url, urlencode(args))",
            "        )",
            "        return HttpResponseRedirect(\"%s?%s\" % (self.login_url, urlencode(args)))",
            "",
            "    def on_logged_in(self, request, conn):",
            "        \"\"\"",
            "        Called whenever the users is successfully logged in.",
            "        Sets the 'omero.group' option if specified in the constructor",
            "        \"\"\"",
            "        if self.omero_group is not None:",
            "            conn.SERVICE_OPTS.setOmeroGroup(self.omero_group)",
            "",
            "    def on_share_connection_prepared(self, request, conn_share):",
            "        \"\"\"Called whenever a share connection is successfully prepared.\"\"\"",
            "        pass",
            "",
            "    def verify_is_admin(self, conn):",
            "        \"\"\"",
            "        If we have been requested to by the isAdmin flag, verify the user",
            "        is an admin and raise an exception if they are not.",
            "        \"\"\"",
            "        if self.isAdmin and not conn.isAdmin():",
            "            raise Http404",
            "",
            "    def verify_is_group_owner(self, conn, gid):",
            "        \"\"\"",
            "        If we have been requested to by the isGroupOwner flag, verify the user",
            "        is the owner of the provided group. If no group is provided the user's",
            "        active session group ownership will be verified.",
            "        \"\"\"",
            "        if not self.isGroupOwner:",
            "            return",
            "        if gid is not None:",
            "            if not conn.isLeader(gid):",
            "                raise Http404",
            "        else:",
            "            if not conn.isLeader():",
            "                raise Http404",
            "",
            "    def is_valid_public_url(self, server_id, request):",
            "        \"\"\"",
            "        Verifies that the URL for the resource being requested falls within",
            "        the scope of the OMERO.webpublic URL filter.",
            "        \"\"\"",
            "        if settings.PUBLIC_ENABLED:",
            "            if not hasattr(settings, \"PUBLIC_USER\"):",
            "                logger.warn(",
            "                    \"OMERO.webpublic enabled but public user \"",
            "                    \"(omero.web.public.user) not set, disabling \"",
            "                    \"OMERO.webpublic.\"",
            "                )",
            "                settings.PUBLIC_ENABLED = False",
            "                return False",
            "            if not hasattr(settings, \"PUBLIC_PASSWORD\"):",
            "                logger.warn(",
            "                    \"OMERO.webpublic enabled but public user \"",
            "                    \"password (omero.web.public.password) not set, \"",
            "                    \"disabling OMERO.webpublic.\"",
            "                )",
            "                settings.PUBLIC_ENABLED = False",
            "                return False",
            "            if settings.PUBLIC_GET_ONLY and (request.method != \"GET\"):",
            "                return False",
            "            if self.allowPublic is None:",
            "                return settings.PUBLIC_URL_FILTER.search(request.path) is not None",
            "            return self.allowPublic",
            "        return False",
            "",
            "    def load_server_settings(self, conn, request):",
            "        \"\"\"Loads Client preferences and Read-Only status from the server.\"\"\"",
            "        try:",
            "            request.session[\"can_create\"]",
            "        except KeyError:",
            "            request.session.modified = True",
            "            request.session[\"can_create\"] = conn.canCreate()",
            "        try:",
            "            request.session[\"server_settings\"]",
            "        except Exception:",
            "            request.session.modified = True",
            "            request.session[\"server_settings\"] = {}",
            "            try:",
            "                request.session[\"server_settings\"] = propertiesToDict(",
            "                    conn.getClientSettings(), prefix=\"omero.client.\"",
            "                )",
            "            except Exception:",
            "                logger.error(traceback.format_exc())",
            "            # make extra call for omero.mail, not a part of omero.client",
            "            request.session[\"server_settings\"][\"email\"] = conn.getEmailSettings()",
            "",
            "    def get_public_user_connector(self):",
            "        \"\"\"",
            "        Returns the current cached OMERO.webpublic connector or None if",
            "        nothing has been cached.",
            "        \"\"\"",
            "        if not settings.PUBLIC_CACHE_ENABLED:",
            "            return",
            "        return cache.get(settings.PUBLIC_CACHE_KEY)",
            "",
            "    def set_public_user_connector(self, connector):",
            "        \"\"\"Sets the current cached OMERO.webpublic connector.\"\"\"",
            "        if not settings.PUBLIC_CACHE_ENABLED or connector.omero_session_key is None:",
            "            return",
            "        logger.debug(\"Setting OMERO.webpublic connector: %r\" % connector)",
            "        cache.set(settings.PUBLIC_CACHE_KEY, connector, settings.PUBLIC_CACHE_TIMEOUT)",
            "",
            "    def get_connection(self, server_id, request):",
            "        \"\"\"",
            "        Prepares a Blitz connection wrapper (from L{omero.gateway}) for",
            "        use with a view function.",
            "        \"\"\"",
            "        connection = self.get_authenticated_connection(server_id, request)",
            "        is_valid_public_url = self.is_valid_public_url(server_id, request)",
            "        logger.debug(\"Is valid public URL? %s\" % is_valid_public_url)",
            "        if connection is None and is_valid_public_url:",
            "            # If OMERO.webpublic is enabled, pick up a username and",
            "            # password from configuration and use those credentials to",
            "            # create a connection.",
            "            logger.debug(",
            "                \"OMERO.webpublic enabled, attempting to login \"",
            "                \"with configuration supplied credentials.\"",
            "            )",
            "            if server_id is None:",
            "                server_id = settings.PUBLIC_SERVER_ID",
            "            username = settings.PUBLIC_USER",
            "            password = settings.PUBLIC_PASSWORD",
            "            is_secure = settings.SECURE",
            "            logger.debug(\"Is SSL? %s\" % is_secure)",
            "            # Try and use a cached OMERO.webpublic user session key.",
            "            public_user_connector = self.get_public_user_connector()",
            "            if public_user_connector is not None:",
            "                logger.debug(",
            "                    \"Attempting to use cached OMERO.webpublic \"",
            "                    \"connector: %r\" % public_user_connector",
            "                )",
            "                connection = public_user_connector.join_connection(self.useragent)",
            "                if connection is not None:",
            "                    request.session[\"connector\"] = public_user_connector",
            "                    logger.debug(",
            "                        \"Attempt to use cached OMERO.web public \"",
            "                        \"session key successful!\"",
            "                    )",
            "                    return connection",
            "                logger.debug(",
            "                    \"Attempt to use cached OMERO.web public \" \"session key failed.\"",
            "                )",
            "            # We don't have a cached OMERO.webpublic user session key,",
            "            # create a new connection based on the credentials we've been",
            "            # given.",
            "            connector = Connector(server_id, is_secure)",
            "            connection = connector.create_connection(",
            "                self.useragent,",
            "                username,",
            "                password,",
            "                is_public=True,",
            "                userip=get_client_ip(request),",
            "            )",
            "            request.session[\"connector\"] = connector",
            "            # Clear any previous context so we don't try to access this",
            "            # NB: we also do this in WebclientLoginView.handle_logged_in()",
            "            if \"active_group\" in request.session:",
            "                del request.session[\"active_group\"]",
            "            if \"user_id\" in request.session:",
            "                del request.session[\"user_id\"]",
            "            request.session.modified = True",
            "            self.set_public_user_connector(connector)",
            "        elif connection is not None:",
            "            is_anonymous = connection.isAnonymous()",
            "            logger.debug(\"Is anonymous? %s\" % is_anonymous)",
            "            if is_anonymous and not is_valid_public_url:",
            "                if connection.c is not None:",
            "                    logger.debug(\"Closing anonymous connection\")",
            "                    connection.close(hard=False)",
            "                return None",
            "        return connection",
            "",
            "    def get_authenticated_connection(self, server_id, request):",
            "        \"\"\"",
            "        Prepares an authenticated Blitz connection wrapper (from",
            "        L{omero.gateway}) for use with a view function.",
            "        \"\"\"",
            "        # TODO: Handle previous try_super logic; is it still needed?",
            "",
            "        userip = get_client_ip(request)",
            "        session = request.session",
            "        request = request.GET",
            "        is_secure = settings.SECURE",
            "        logger.debug(\"Is SSL? %s\" % is_secure)",
            "        connector = session.get(\"connector\", None)",
            "        logger.debug(\"Connector: %s\" % connector)",
            "",
            "        if server_id is None:",
            "            # If no server id is passed, the db entry will not be used and",
            "            # instead we'll depend on the request.session and request.GET",
            "            # values",
            "            if connector is not None:",
            "                server_id = connector.server_id",
            "            else:",
            "                try:",
            "                    server_id = request[\"server\"]",
            "                except Exception:",
            "                    logger.debug(\"No Server ID available.\")",
            "                    return None",
            "",
            "        # If we have an OMERO session key in our request variables attempt",
            "        # to make a connection based on those credentials.",
            "        try:",
            "            omero_session_key = request[\"bsession\"]",
            "            connector = Connector(server_id, is_secure)",
            "        except KeyError:",
            "            # We do not have an OMERO session key in the current request.",
            "            pass",
            "        else:",
            "            # We have an OMERO session key in the current request use it",
            "            # to try join an existing connection / OMERO session.",
            "            logger.debug(",
            "                \"Have OMERO session key %s, attempting to join...\" % omero_session_key",
            "            )",
            "            connector.user_id = None",
            "            connector.omero_session_key = omero_session_key",
            "            connection = connector.join_connection(self.useragent, userip)",
            "            session[\"connector\"] = connector",
            "            return connection",
            "",
            "        # An OMERO session is not available, we're either trying to service",
            "        # a request to a login page or an anonymous request.",
            "        username = None",
            "        password = None",
            "        try:",
            "            username = request[\"username\"]",
            "            password = request[\"password\"]",
            "        except KeyError:",
            "            if connector is None:",
            "                logger.debug(\"No username or password in request, exiting.\")",
            "                # We do not have an OMERO session or a username and password",
            "                # in the current request and we do not have a valid connector.",
            "                # Raise an error (return None).",
            "                return None",
            "",
            "        if username is not None and password is not None:",
            "            # We have a username and password in the current request, or",
            "            # OMERO.webpublic is enabled and has provided us with a username",
            "            # and password via configureation. Use them to try and create a",
            "            # new connection / OMERO session.",
            "            logger.debug(\"Creating connection with username and password...\")",
            "            connector = Connector(server_id, is_secure)",
            "            connection = connector.create_connection(",
            "                self.useragent, username, password, userip=userip",
            "            )",
            "            session[\"connector\"] = connector",
            "            return connection",
            "",
            "        logger.debug(\"Django session connector: %r\" % connector)",
            "        if connector is not None:",
            "            # We have a connector, attempt to use it to join an existing",
            "            # connection / OMERO session.",
            "            connection = connector.join_connection(self.useragent, userip)",
            "            if connection is not None:",
            "                logger.debug(\"Connector valid, session successfully joined.\")",
            "                return connection",
            "            # Fall through, we the session we've been asked to join may",
            "            # be invalid and we may have other credentials as request",
            "            # variables.",
            "            logger.debug(\"Connector is no longer valid, destroying...\")",
            "            del session[\"connector\"]",
            "            return None",
            "",
            "        session[\"connector\"] = connector",
            "        return None",
            "",
            "    def __call__(ctx, f):",
            "        \"\"\"",
            "        Tries to prepare a logged in connection, then calls function and",
            "        returns the result.",
            "        \"\"\"",
            "",
            "        def wrapped(request, *args, **kwargs):",
            "            url = request.GET.get(\"url\")",
            "            if url is None or len(url) == 0:",
            "                url = request.get_full_path()",
            "",
            "            doConnectionCleanup = False",
            "",
            "            conn = kwargs.get(\"conn\", None)",
            "            error = None",
            "            server_id = kwargs.get(\"server_id\", None)",
            "            # Short circuit connection retrieval when a connection was",
            "            # provided to us via 'conn'. This is useful when in testing",
            "            # mode or when stacking view functions/methods.",
            "            if conn is None:",
            "                doConnectionCleanup = ctx.doConnectionCleanup",
            "                logger.debug(\"Connection not provided, attempting to get one.\")",
            "                try:",
            "                    conn = ctx.get_connection(server_id, request)",
            "                except Exception as x:",
            "                    logger.error(\"Error retrieving connection.\", exc_info=True)",
            "                    error = str(x)",
            "                else:",
            "                    # various configuration & checks only performed on new",
            "                    # 'conn'",
            "                    if conn is None:",
            "                        return ctx.on_not_logged_in(request, url, error)",
            "                    else:",
            "                        ctx.on_logged_in(request, conn)",
            "                    ctx.verify_is_admin(conn)",
            "                    ctx.verify_is_group_owner(conn, kwargs.get(\"gid\"))",
            "                    ctx.load_server_settings(conn, request)",
            "",
            "                    share_id = kwargs.get(\"share_id\")",
            "                    conn_share = ctx.prepare_share_connection(request, conn, share_id)",
            "                    if conn_share is not None:",
            "                        ctx.on_share_connection_prepared(request, conn_share)",
            "                        kwargs[\"conn\"] = conn_share",
            "                    else:",
            "                        kwargs[\"conn\"] = conn",
            "",
            "                    # kwargs['error'] = request.GET.get('error')",
            "                    kwargs[\"url\"] = url",
            "            retval = None",
            "            try:",
            "                retval = f(request, *args, **kwargs)",
            "            finally:",
            "                # If f() raised Exception, e.g. Http404() we must still cleanup",
            "                delayConnectionCleanup = isinstance(retval, ConnCleaningHttpResponse)",
            "                if doConnectionCleanup and delayConnectionCleanup:",
            "                    raise ApiUsageException(",
            "                        \"Methods that return a\"",
            "                        \" ConnCleaningHttpResponse must be marked with\"",
            "                        \" @login_required(doConnectionCleanup=False)\"",
            "                    )",
            "                doConnectionCleanup = not delayConnectionCleanup",
            "                logger.debug(\"Doing connection cleanup? %s\" % doConnectionCleanup)",
            "                try:",
            "                    if doConnectionCleanup:",
            "                        if conn is not None and conn.c is not None:",
            "                            conn.close(hard=False)",
            "                except Exception:",
            "                    logger.warn(\"Failed to clean up connection\", exc_info=True)",
            "            return retval",
            "",
            "        return update_wrapper(wrapped, f)",
            "",
            "",
            "class render_response(object):",
            "    \"\"\"",
            "    This decorator handles the rendering of view methods to HttpResponse. It",
            "    expects that wrapped view methods return a dict. This allows:",
            "    - The template to be specified in the method arguments OR within the view",
            "      method itself",
            "    - The dict to be returned as json if required",
            "    - The request is passed to the template context, as required by some tags",
            "      etc",
            "    - A hook is provided for adding additional data to the context, from the",
            "      L{omero.gateway.BlitzGateway} or from the request.",
            "    \"\"\"",
            "",
            "    # To make django's method_decorator work, this is required until",
            "    # python/django sort out how argumented decorator wrapping should work",
            "    # https://github.com/openmicroscopy/openmicroscopy/pull/1820",
            "    def __getattr__(self, name):",
            "        if name == \"__name__\":",
            "            return self.__class__.__name__",
            "        else:",
            "            return super(render_response, self).getattr(name)",
            "",
            "    def prepare_context(self, request, context, *args, **kwargs):",
            "        \"\"\" Hook for adding additional data to the context dict \"\"\"",
            "        context[\"html\"] = context.get(\"html\", {})",
            "        context[\"html\"][\"meta_referrer\"] = settings.HTML_META_REFERRER",
            "",
            "    def __call__(ctx, f):",
            "        \"\"\" Here we wrap the view method f and return the wrapped method \"\"\"",
            "",
            "        def wrapper(request, *args, **kwargs):",
            "            \"\"\"",
            "            Wrapper calls the view function, processes the result and returns",
            "            HttpResponse\"\"\"",
            "",
            "            # call the view function itself...",
            "            context = f(request, *args, **kwargs)",
            "",
            "            # if we happen to have a Response, return it",
            "            if isinstance(context, HttpResponseBase):",
            "                return context",
            "",
            "            # get template from view dict. Can be overridden from the **kwargs",
            "            template = \"template\" in context and context[\"template\"] or None",
            "            template = kwargs.get(\"template\", template)",
            "            logger.debug(\"Rendering template: %s\" % template)",
            "",
            "            # allows us to return the dict as json  (NB: BlitzGateway objects",
            "            # don't serialize)",
            "            if template is None or template == \"json\":",
            "                # We still need to support non-dict data:",
            "                safe = type(context) is dict",
            "                return JsonResponse(context, safe=safe)",
            "            else:",
            "                # allow additional processing of context dict",
            "                ctx.prepare_context(request, context, *args, **kwargs)",
            "                return render(request, template, context)",
            "",
            "        return update_wrapper(wrapper, f)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "585": [
                "render_response",
                "prepare_context"
            ]
        },
        "addLocation": []
    },
    "omeroweb/settings.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 508,
                "afterPatchRowNumber": 508,
                "PatchRowcode": "         leave_none_unset,"
            },
            "1": {
                "beforePatchRowNumber": 509,
                "afterPatchRowNumber": 509,
                "PatchRowcode": "         \"The name to use for session cookies\","
            },
            "2": {
                "beforePatchRowNumber": 510,
                "afterPatchRowNumber": 510,
                "PatchRowcode": "     ],"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 511,
                "PatchRowcode": "+    \"omero.web.session_cookie_path\": ["
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 512,
                "PatchRowcode": "+        \"SESSION_COOKIE_PATH\","
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 513,
                "PatchRowcode": "+        None,"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 514,
                "PatchRowcode": "+        leave_none_unset,"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 515,
                "PatchRowcode": "+        \"The path to use for session cookies\","
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 516,
                "PatchRowcode": "+    ],"
            },
            "9": {
                "beforePatchRowNumber": 511,
                "afterPatchRowNumber": 517,
                "PatchRowcode": "     \"omero.web.session_cookie_secure\": ["
            },
            "10": {
                "beforePatchRowNumber": 512,
                "afterPatchRowNumber": 518,
                "PatchRowcode": "         \"SESSION_COOKIE_SECURE\","
            },
            "11": {
                "beforePatchRowNumber": 513,
                "afterPatchRowNumber": 519,
                "PatchRowcode": "         \"false\","
            },
            "12": {
                "beforePatchRowNumber": 866,
                "afterPatchRowNumber": 872,
                "PatchRowcode": "             ' {\"experimenter\": -1}}\\'``'"
            },
            "13": {
                "beforePatchRowNumber": 867,
                "afterPatchRowNumber": 873,
                "PatchRowcode": "         ),"
            },
            "14": {
                "beforePatchRowNumber": 868,
                "afterPatchRowNumber": 874,
                "PatchRowcode": "     ],"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 875,
                "PatchRowcode": "+    \"omero.web.redirect_allowed_hosts\": ["
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 876,
                "PatchRowcode": "+        \"REDIRECT_ALLOWED_HOSTS\","
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 877,
                "PatchRowcode": "+        \"[]\","
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 878,
                "PatchRowcode": "+        json.loads,"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 879,
                "PatchRowcode": "+        ("
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 880,
                "PatchRowcode": "+            \"If you wish to allow redirects to an external site, \""
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 881,
                "PatchRowcode": "+            \"the domains must be listed here. \""
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 882,
                "PatchRowcode": "+            'For example [\"openmicroscopy.org\"].'"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 883,
                "PatchRowcode": "+        ),"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 884,
                "PatchRowcode": "+    ],"
            },
            "25": {
                "beforePatchRowNumber": 869,
                "afterPatchRowNumber": 885,
                "PatchRowcode": "     \"omero.web.login.show_client_downloads\": ["
            },
            "26": {
                "beforePatchRowNumber": 870,
                "afterPatchRowNumber": 886,
                "PatchRowcode": "         \"SHOW_CLIENT_DOWNLOADS\","
            },
            "27": {
                "beforePatchRowNumber": 871,
                "afterPatchRowNumber": 887,
                "PatchRowcode": "         \"true\","
            },
            "28": {
                "beforePatchRowNumber": 1022,
                "afterPatchRowNumber": 1038,
                "PatchRowcode": "             \"will be authorized to make cross-site HTTP requests.\""
            },
            "29": {
                "beforePatchRowNumber": 1023,
                "afterPatchRowNumber": 1039,
                "PatchRowcode": "         ),"
            },
            "30": {
                "beforePatchRowNumber": 1024,
                "afterPatchRowNumber": 1040,
                "PatchRowcode": "     ],"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1041,
                "PatchRowcode": "+    \"omero.web.html_meta_referrer\": ["
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1042,
                "PatchRowcode": "+        \"HTML_META_REFERRER\","
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1043,
                "PatchRowcode": "+        \"origin-when-crossorigin\","
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1044,
                "PatchRowcode": "+        str,"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1045,
                "PatchRowcode": "+        ("
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1046,
                "PatchRowcode": "+            \"Default content for the HTML Meta referrer tag. \""
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1047,
                "PatchRowcode": "+            \"See https://www.w3.org/TR/referrer-policy/#referrer-policies for \""
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1048,
                "PatchRowcode": "+            \"allowed values and https://caniuse.com/#feat=referrer-policy for \""
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1049,
                "PatchRowcode": "+            \"browser compatibility. \""
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1050,
                "PatchRowcode": "+            \"Warning: Internet Explorer 11 does not support the default value \""
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1051,
                "PatchRowcode": "+            'of this setting, you may want to change this to \"origin\" after '"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1052,
                "PatchRowcode": "+            \"reviewing the linked documentation.\""
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1053,
                "PatchRowcode": "+        ),"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1054,
                "PatchRowcode": "+    ],"
            },
            "45": {
                "beforePatchRowNumber": 1025,
                "afterPatchRowNumber": 1055,
                "PatchRowcode": "     \"omero.web.x_frame_options\": ["
            },
            "46": {
                "beforePatchRowNumber": 1026,
                "afterPatchRowNumber": 1056,
                "PatchRowcode": "         \"X_FRAME_OPTIONS\","
            },
            "47": {
                "beforePatchRowNumber": 1027,
                "afterPatchRowNumber": 1057,
                "PatchRowcode": "         \"SAMEORIGIN\","
            }
        },
        "frontPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "#",
            "# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #",
            "# #                Django settings for OMERO.web project.               # #",
            "# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #",
            "#",
            "#",
            "# Copyright (c) 2008-2016 University of Dundee.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "# Author: Aleksandra Tarkowska <A(dot)Tarkowska(at)dundee(dot)ac(dot)uk>, 2008.",
            "#",
            "# Version: 1.0",
            "#",
            "",
            "",
            "import os.path",
            "import sys",
            "import logging",
            "import omero",
            "import omero.config",
            "import omero.clients",
            "import tempfile",
            "import re",
            "import json",
            "import random",
            "import string",
            "from builtins import str as text",
            "",
            "from omero_ext import portalocker",
            "from omero.util.concurrency import get_event",
            "from omeroweb.utils import sort_properties_to_tuple",
            "from omeroweb.connector import Server",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "# LOGS",
            "# NEVER DEPLOY a site into production with DEBUG turned on.",
            "# Debuging mode.",
            "# A boolean that turns on/off debug mode.",
            "# handler404 and handler500 works only when False",
            "if \"OMERO_HOME\" in os.environ:",
            "    logger.warn(\"OMERO_HOME usage is ignored in OMERO.web\")",
            "",
            "OMERODIR = os.environ.get(\"OMERODIR\")",
            "if not OMERODIR:",
            "    raise Exception(\"ERROR: OMERODIR not set\")",
            "",
            "# Logging",
            "LOGDIR = os.path.join(OMERODIR, \"var\", \"log\").replace(\"\\\\\", \"/\")",
            "",
            "if not os.path.isdir(LOGDIR):",
            "    try:",
            "        os.makedirs(LOGDIR)",
            "    except Exception:",
            "        exctype, value = sys.exc_info()[:2]",
            "        raise exctype(value)",
            "",
            "# DEBUG: Never deploy a site into production with DEBUG turned on.",
            "# Logging levels: logging.DEBUG, logging.INFO, logging.WARNING, logging.ERROR",
            "# logging.CRITICAL",
            "# FORMAT: 2010-01-01 00:00:00,000 INFO  [omeroweb.webadmin.webadmin_utils]",
            "# (proc.1308 ) getGuestConnection:20 Open connection is not available",
            "",
            "STANDARD_LOGFORMAT = (",
            "    \"%(asctime)s %(levelname)5.5s [%(name)40.40s]\"",
            "    \" (proc.%(process)5.5d) %(funcName)s():%(lineno)d %(message)s\"",
            ")",
            "",
            "FULL_REQUEST_LOGFORMAT = (",
            "    \"%(asctime)s %(levelname)5.5s [%(name)40.40s]\"",
            "    \" (proc.%(process)5.5d) %(funcName)s():%(lineno)d\"",
            "    \" HTTP %(status_code)d %(request)s\"",
            ")",
            "",
            "LOGGING_CLASS = \"omero_ext.cloghandler.ConcurrentRotatingFileHandler\"",
            "LOGSIZE = 500000000",
            "",
            "",
            "LOGGING = {",
            "    \"version\": 1,",
            "    \"disable_existing_loggers\": False,",
            "    \"formatters\": {",
            "        \"standard\": {\"format\": STANDARD_LOGFORMAT},",
            "        \"full_request\": {\"format\": FULL_REQUEST_LOGFORMAT},",
            "    },",
            "    \"filters\": {",
            "        \"require_debug_false\": {",
            "            \"()\": \"django.utils.log.RequireDebugFalse\",",
            "        },",
            "        \"require_debug_true\": {",
            "            \"()\": \"django.utils.log.RequireDebugTrue\",",
            "        },",
            "    },",
            "    \"handlers\": {",
            "        \"default\": {",
            "            \"level\": \"DEBUG\",",
            "            \"class\": LOGGING_CLASS,",
            "            \"filename\": os.path.join(LOGDIR, \"OMEROweb.log\").replace(\"\\\\\", \"/\"),",
            "            \"maxBytes\": LOGSIZE,",
            "            \"backupCount\": 10,",
            "            \"formatter\": \"standard\",",
            "        },",
            "        \"request_handler\": {",
            "            \"level\": \"DEBUG\",",
            "            \"class\": LOGGING_CLASS,",
            "            \"filename\": os.path.join(LOGDIR, \"OMEROweb.log\").replace(\"\\\\\", \"/\"),",
            "            \"maxBytes\": LOGSIZE,",
            "            \"backupCount\": 10,",
            "            \"filters\": [\"require_debug_false\"],",
            "            \"formatter\": \"full_request\",",
            "        },",
            "        \"console\": {",
            "            \"level\": \"INFO\",",
            "            \"filters\": [\"require_debug_true\"],",
            "            \"class\": \"logging.StreamHandler\",",
            "            \"formatter\": \"standard\",",
            "        },",
            "        \"mail_admins\": {",
            "            \"level\": \"ERROR\",",
            "            \"filters\": [\"require_debug_false\"],",
            "            \"class\": \"django.utils.log.AdminEmailHandler\",",
            "        },",
            "    },",
            "    \"loggers\": {",
            "        \"django.request\": {  # Stop SQL debug from logging to main logger",
            "            \"handlers\": [\"default\", \"request_handler\", \"mail_admins\"],",
            "            \"level\": \"DEBUG\",",
            "            \"propagate\": False,",
            "        },",
            "        \"django\": {\"handlers\": [\"console\"], \"level\": \"DEBUG\", \"propagate\": True},",
            "        \"\": {\"handlers\": [\"default\"], \"level\": \"DEBUG\", \"propagate\": True},",
            "    },",
            "}",
            "",
            "",
            "CONFIG_XML = os.path.join(OMERODIR, \"etc\", \"grid\", \"config.xml\")",
            "count = 10",
            "event = get_event(\"websettings\")",
            "",
            "while True:",
            "    try:",
            "        CUSTOM_SETTINGS = dict()",
            "        if os.path.exists(CONFIG_XML):",
            "            CONFIG_XML = omero.config.ConfigXml(CONFIG_XML, read_only=True)",
            "            CUSTOM_SETTINGS = CONFIG_XML.as_map()",
            "            CONFIG_XML.close()",
            "        break",
            "    except portalocker.LockException:",
            "        # logger.error(\"Exception while loading configuration retrying...\",",
            "        # exc_info=True)",
            "        exctype, value = sys.exc_info()[:2]",
            "        count -= 1",
            "        if not count:",
            "            raise exctype(value)",
            "        else:",
            "            event.wait(1)  # Wait a total of 10 seconds",
            "    except Exception:",
            "        # logger.error(\"Exception while loading configuration...\",",
            "        # exc_info=True)",
            "        exctype, value = sys.exc_info()[:2]",
            "        raise exctype(value)",
            "",
            "del event",
            "del count",
            "del get_event",
            "",
            "WSGI = \"wsgi\"",
            "WSGITCP = \"wsgi-tcp\"",
            "WSGI_TYPES = (WSGI, WSGITCP)",
            "DEVELOPMENT = \"development\"",
            "DEFAULT_SERVER_TYPE = WSGITCP",
            "ALL_SERVER_TYPES = (WSGI, WSGITCP, DEVELOPMENT)",
            "",
            "DEFAULT_SESSION_ENGINE = \"omeroweb.filesessionstore\"",
            "SESSION_ENGINE_VALUES = (",
            "    \"omeroweb.filesessionstore\",",
            "    \"django.contrib.sessions.backends.db\",",
            "    \"django.contrib.sessions.backends.file\",",
            "    \"django.contrib.sessions.backends.cache\",",
            "    \"django.contrib.sessions.backends.cached_db\",",
            ")",
            "",
            "",
            "def parse_boolean(s):",
            "    s = s.strip().lower()",
            "    if s in (\"true\", \"1\", \"t\"):",
            "        return True",
            "    return False",
            "",
            "",
            "def parse_paths(s):",
            "    return [os.path.normpath(path) for path in json.loads(s)]",
            "",
            "",
            "def check_server_type(s):",
            "    if s not in ALL_SERVER_TYPES:",
            "        raise ValueError(",
            "            \"Unknown server type: %s. Valid values are: %s\" % (s, ALL_SERVER_TYPES)",
            "        )",
            "    return s",
            "",
            "",
            "def check_session_engine(s):",
            "    if s not in SESSION_ENGINE_VALUES:",
            "        raise ValueError(",
            "            \"Unknown session engine: %s. Valid values are: %s\"",
            "            % (s, SESSION_ENGINE_VALUES)",
            "        )",
            "    return s",
            "",
            "",
            "def identity(x):",
            "    return x",
            "",
            "",
            "def str_slash(s):",
            "    if s is not None:",
            "        s = str(s)",
            "        if s and not s.endswith(\"/\"):",
            "            s += \"/\"",
            "    return s",
            "",
            "",
            "class LeaveUnset(Exception):",
            "    pass",
            "",
            "",
            "def leave_none_unset(s):",
            "    if s is None:",
            "        raise LeaveUnset()",
            "    return s",
            "",
            "",
            "def leave_none_unset_int(s):",
            "    s = leave_none_unset(s)",
            "    if s is not None:",
            "        return int(s)",
            "",
            "",
            "CUSTOM_HOST = CUSTOM_SETTINGS.get(\"Ice.Default.Host\", \"localhost\")",
            "CUSTOM_HOST = CUSTOM_SETTINGS.get(\"omero.master.host\", CUSTOM_HOST)",
            "# DO NOT EDIT!",
            "INTERNAL_SETTINGS_MAPPING = {",
            "    \"omero.qa.feedback\": [\"FEEDBACK_URL\", \"http://qa.openmicroscopy.org.uk\", str, None],",
            "    \"omero.web.upgrades.url\": [\"UPGRADES_URL\", None, leave_none_unset, None],",
            "    \"omero.web.check_version\": [\"CHECK_VERSION\", \"true\", parse_boolean, None],",
            "    # Allowed hosts:",
            "    # https://docs.djangoproject.com/en/1.8/ref/settings/#allowed-hosts",
            "    \"omero.web.allowed_hosts\": [\"ALLOWED_HOSTS\", '[\"*\"]', json.loads, None],",
            "    # Do not show WARNING (1_8.W001): The standalone TEMPLATE_* settings",
            "    # were deprecated in Django 1.8 and the TEMPLATES dictionary takes",
            "    # precedence. You must put the values of the following settings",
            "    # into your default TEMPLATES dict:",
            "    # TEMPLATE_DIRS, TEMPLATE_CONTEXT_PROCESSORS.",
            "    \"omero.web.system_checks\": [",
            "        \"SILENCED_SYSTEM_CHECKS\",",
            "        '[\"1_8.W001\"]',",
            "        json.loads,",
            "        None,",
            "    ],",
            "    # Internal email notification for omero.web.admins,",
            "    # loaded from config.xml directly",
            "    \"omero.mail.from\": [",
            "        \"SERVER_EMAIL\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"The email address that error messages come from, such as those\"",
            "            \" sent to :property:`omero.web.admins`.  Requires EMAIL properties\"",
            "            \" below.\"",
            "        ),",
            "    ],",
            "    \"omero.mail.host\": [",
            "        \"EMAIL_HOST\",",
            "        None,",
            "        identity,",
            "        \"The SMTP server host to use for sending email.\",",
            "    ],",
            "    \"omero.mail.password\": [",
            "        \"EMAIL_HOST_PASSWORD\",",
            "        None,",
            "        identity,",
            "        \"Password to use for the SMTP server.\",",
            "    ],",
            "    \"omero.mail.username\": [",
            "        \"EMAIL_HOST_USER\",",
            "        None,",
            "        identity,",
            "        \"Username to use for the SMTP server.\",",
            "    ],",
            "    \"omero.mail.port\": [\"EMAIL_PORT\", 25, identity, \"Port to use for the SMTP server.\"],",
            "    \"omero.web.admins.email_subject_prefix\": [",
            "        \"EMAIL_SUBJECT_PREFIX\",",
            "        \"[OMERO.web - admin notification]\",",
            "        str,",
            "        \"Subject-line prefix for email messages\",",
            "    ],",
            "    \"omero.mail.smtp.starttls.enable\": [",
            "        \"EMAIL_USE_TLS\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Whether to use a TLS (secure) connection when talking to the SMTP\"",
            "            \" server.\"",
            "        ),",
            "    ],",
            "}",
            "",
            "CUSTOM_SETTINGS_MAPPINGS = {",
            "    # Deployment configuration",
            "    \"omero.web.debug\": [",
            "        \"DEBUG\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"A boolean that turns on/off debug mode. \"",
            "            \"Use debug mode only in development, not in production, as it logs \"",
            "            \"sensitive and confidential information in plaintext.\"",
            "        ),",
            "    ],",
            "    \"omero.web.secret_key\": [",
            "        \"SECRET_KEY\",",
            "        None,",
            "        leave_none_unset,",
            "        (\"A boolean that sets SECRET_KEY for a particular Django \" \"installation.\"),",
            "    ],",
            "    \"omero.web.admins\": [",
            "        \"ADMINS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"A list of people who get code error notifications whenever the \"",
            "            \"application identifies a broken link or raises an unhandled \"",
            "            \"exception that results in an internal server error. This gives \"",
            "            \"the administrators immediate notification of any errors, \"",
            "            \"see :doc:`/sysadmins/mail`. \"",
            "            'Example:``\\'[[\"Full Name\", \"email address\"]]\\'``.'",
            "        ),",
            "    ],",
            "    \"omero.web.application_server\": [",
            "        \"APPLICATION_SERVER\",",
            "        DEFAULT_SERVER_TYPE,",
            "        check_server_type,",
            "        (",
            "            \"OMERO.web is configured to run in Gunicorn as a generic WSGI (TCP)\"",
            "            \"application by default. Available options: ``wsgi-tcp`` \"",
            "            \"(Gunicorn, default), ``wsgi`` (Advanced users only, e.g. manual \"",
            "            \"Apache configuration with ``mod_wsgi``).\"",
            "        ),",
            "    ],",
            "    \"omero.web.application_server.host\": [",
            "        \"APPLICATION_SERVER_HOST\",",
            "        \"127.0.0.1\",",
            "        str,",
            "        \"The front-end webserver e.g. NGINX can be set up to run on a \"",
            "        \"different host from OMERO.web. The property ensures that OMERO.web \"",
            "        \"is accessible on an external IP. It requires copying all the \"",
            "        \"OMERO.web static files to the separate NGINX server.\",",
            "    ],",
            "    \"omero.web.application_server.port\": [",
            "        \"APPLICATION_SERVER_PORT\",",
            "        4080,",
            "        int,",
            "        \"Upstream application port\",",
            "    ],",
            "    \"omero.web.application_server.max_requests\": [",
            "        \"APPLICATION_SERVER_MAX_REQUESTS\",",
            "        0,",
            "        int,",
            "        (\"The maximum number of requests a worker will process before \" \"restarting.\"),",
            "    ],",
            "    \"omero.web.middleware\": [",
            "        \"MIDDLEWARE_CLASSES_LIST\",",
            "        (",
            "            \"[\"",
            "            '{\"index\": 1, '",
            "            '\"class\": \"django.middleware.common.BrokenLinkEmailsMiddleware\"},'",
            "            '{\"index\": 2, '",
            "            '\"class\": \"django.middleware.common.CommonMiddleware\"},'",
            "            '{\"index\": 3, '",
            "            '\"class\": \"django.contrib.sessions.middleware.SessionMiddleware\"},'",
            "            '{\"index\": 4, '",
            "            '\"class\": \"django.middleware.csrf.CsrfViewMiddleware\"},'",
            "            '{\"index\": 5, '",
            "            '\"class\": \"django.contrib.messages.middleware.MessageMiddleware\"},'",
            "            '{\"index\": 6, '",
            "            '\"class\": \"django.middleware.clickjacking.XFrameOptionsMiddleware\"}'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Warning: Only system administrators should use this feature. \"",
            "            \"List of Django middleware classes in the form \"",
            "            '[{\"class\": \"class.name\", \"index\": FLOAT}]. '",
            "            \"See :djangodoc:`Django middleware <topics/http/middleware/>`.\"",
            "            \" Classes will be ordered by increasing index\"",
            "        ),",
            "    ],",
            "    \"omero.web.prefix\": [",
            "        \"FORCE_SCRIPT_NAME\",",
            "        None,",
            "        leave_none_unset,",
            "        (",
            "            \"Used as the value of the SCRIPT_NAME environment variable in any\"",
            "            \" HTTP request.\"",
            "        ),",
            "    ],",
            "    \"omero.web.use_x_forwarded_host\": [",
            "        \"USE_X_FORWARDED_HOST\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Specifies whether to use the X-Forwarded-Host header in preference \"",
            "            \"to the Host header. This should only be enabled if a proxy which \"",
            "            \"sets this header is in use.\"",
            "        ),",
            "    ],",
            "    \"omero.web.static_url\": [",
            "        \"STATIC_URL\",",
            "        \"/static/\",",
            "        str_slash,",
            "        (",
            "            \"URL to use when referring to static files. Example: ``'/static/'``\"",
            "            \" or ``'http://static.example.com/'``. Used as the base path for\"",
            "            \" asset  definitions (the Media class) and the staticfiles app. It\"",
            "            \" must end in a slash if set to a non-empty value.\"",
            "        ),",
            "    ],",
            "    \"omero.web.static_root\": [",
            "        \"STATIC_ROOT\",",
            "        os.path.join(OMERODIR, \"var\", \"static\"),",
            "        os.path.normpath,",
            "        (",
            "            \"The absolute path to the directory where collectstatic will\"",
            "            \" collect static files for deployment. If the staticfiles contrib\"",
            "            \" app is enabled (default) the collectstatic management command\"",
            "            \" will collect static files into this directory.\"",
            "        ),",
            "    ],",
            "    \"omero.web.session_engine\": [",
            "        \"SESSION_ENGINE\",",
            "        DEFAULT_SESSION_ENGINE,",
            "        check_session_engine,",
            "        (",
            "            \"Controls where Django stores session data. See :djangodoc:\"",
            "            \"`Configuring the session engine for more details <ref/settings\"",
            "            \"/#session-engine>`.\"",
            "        ),",
            "    ],",
            "    \"omero.web.session_expire_at_browser_close\": [",
            "        \"SESSION_EXPIRE_AT_BROWSER_CLOSE\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"A boolean that determines whether to expire the session when the \"",
            "            \"user closes their browser. See :djangodoc:`Django Browser-length \"",
            "            \"sessions vs. persistent sessions documentation <topics/http/\"",
            "            \"sessions/#browser-length-vs-persistent-sessions>` for more \"",
            "            \"details.\"",
            "        ),",
            "    ],",
            "    \"omero.web.caches\": [",
            "        \"CACHES\",",
            "        ('{\"default\": {\"BACKEND\":' ' \"django.core.cache.backends.dummy.DummyCache\"}}'),",
            "        json.loads,",
            "        (",
            "            \"OMERO.web offers alternative session backends to automatically\"",
            "            \" delete stale data using the cache session store backend, see \"",
            "            \":djangodoc:`Django cached session documentation <topics/http/\"",
            "            \"sessions/#using-cached-sessions>` for more details.\"",
            "        ),",
            "    ],",
            "    \"omero.web.secure\": [",
            "        \"SECURE\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (\"Force all backend OMERO.server connections to use SSL.\"),",
            "    ],",
            "    \"omero.web.session_cookie_age\": [",
            "        \"SESSION_COOKIE_AGE\",",
            "        86400,",
            "        int,",
            "        \"The age of session cookies, in seconds.\",",
            "    ],",
            "    \"omero.web.session_cookie_domain\": [",
            "        \"SESSION_COOKIE_DOMAIN\",",
            "        None,",
            "        leave_none_unset,",
            "        \"The domain to use for session cookies\",",
            "    ],",
            "    \"omero.web.session_cookie_name\": [",
            "        \"SESSION_COOKIE_NAME\",",
            "        None,",
            "        leave_none_unset,",
            "        \"The name to use for session cookies\",",
            "    ],",
            "    \"omero.web.session_cookie_secure\": [",
            "        \"SESSION_COOKIE_SECURE\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Restrict session cookies to HTTPS only, you are strongly \"",
            "            \"recommended to set this to ``true`` in production.\"",
            "        ),",
            "    ],",
            "    \"omero.web.csrf_cookie_secure\": [",
            "        \"CSRF_COOKIE_SECURE\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Restrict CSRF cookies to HTTPS only, you are strongly \"",
            "            \"recommended to set this to ``true`` in production.\"",
            "        ),",
            "    ],",
            "    \"omero.web.csrf_cookie_httponly\": [",
            "        \"CSRF_COOKIE_HTTPONLY\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Prevent CSRF cookie from being accessed in JavaScript. \"",
            "            \"Currently disabled as it breaks background JavaScript POSTs in \"",
            "            \"OMERO.web.\"",
            "        ),",
            "    ],",
            "    \"omero.web.logdir\": [\"LOGDIR\", LOGDIR, str, \"A path to the custom log directory.\"],",
            "    \"omero.web.secure_proxy_ssl_header\": [",
            "        \"SECURE_PROXY_SSL_HEADER\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"A tuple representing a HTTP header/value combination that \"",
            "            \"signifies a request is secure. Example \"",
            "            '``\\'[\"HTTP_X_FORWARDED_PROTO_OMERO_WEB\", \"https\"]\\'``. '",
            "            \"For more details see :djangodoc:`secure proxy ssl header <ref/\"",
            "            \"settings/#secure-proxy-ssl-header>`.\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_args\": [",
            "        \"WSGI_ARGS\",",
            "        None,",
            "        leave_none_unset,",
            "        (",
            "            \"A string representing Gunicorn additional arguments. \"",
            "            \"Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/latest/settings.html\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_workers\": [",
            "        \"WSGI_WORKERS\",",
            "        5,",
            "        int,",
            "        (",
            "            \"The number of worker processes for handling requests. \"",
            "            \"Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/settings.html#workers\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_timeout\": [",
            "        \"WSGI_TIMEOUT\",",
            "        60,",
            "        int,",
            "        (",
            "            \"Workers silent for more than this many seconds are killed \"",
            "            \"and restarted. Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/settings.html#timeout\"",
            "        ),",
            "    ],",
            "    # Public user",
            "    \"omero.web.public.enabled\": [",
            "        \"PUBLIC_ENABLED\",",
            "        \"false\",",
            "        parse_boolean,",
            "        \"Enable and disable the OMERO.web public user functionality.\",",
            "    ],",
            "    \"omero.web.public.url_filter\": [",
            "        \"PUBLIC_URL_FILTER\",",
            "        r\"(?#This regular expression matches nothing)a^\",",
            "        re.compile,",
            "        (",
            "            \"Set a regular expression that matches URLs the public user is \"",
            "            \"allowed to access. If this is not set, no URLs will be \"",
            "            \"publicly available.\"",
            "        ),",
            "    ],",
            "    \"omero.web.public.get_only\": [",
            "        \"PUBLIC_GET_ONLY\",",
            "        \"true\",",
            "        parse_boolean,",
            "        \"Restrict public users to GET requests only\",",
            "    ],",
            "    \"omero.web.public.server_id\": [",
            "        \"PUBLIC_SERVER_ID\",",
            "        1,",
            "        int,",
            "        \"Server to authenticate against.\",",
            "    ],",
            "    \"omero.web.public.user\": [",
            "        \"PUBLIC_USER\",",
            "        None,",
            "        leave_none_unset,",
            "        \"Username to use during authentication.\",",
            "    ],",
            "    \"omero.web.public.password\": [",
            "        \"PUBLIC_PASSWORD\",",
            "        None,",
            "        leave_none_unset,",
            "        \"Password to use during authentication.\",",
            "    ],",
            "    \"omero.web.public.cache.enabled\": [",
            "        \"PUBLIC_CACHE_ENABLED\",",
            "        \"false\",",
            "        parse_boolean,",
            "        None,",
            "    ],",
            "    \"omero.web.public.cache.key\": [",
            "        \"PUBLIC_CACHE_KEY\",",
            "        \"omero.web.public.cache.key\",",
            "        str,",
            "        None,",
            "    ],",
            "    \"omero.web.public.cache.timeout\": [\"PUBLIC_CACHE_TIMEOUT\", 60 * 60 * 24, int, None],",
            "    # Social media integration",
            "    \"omero.web.sharing.twitter\": [",
            "        \"SHARING_TWITTER\",",
            "        \"{}\",",
            "        json.loads,",
            "        (",
            "            \"Dictionary of `server-name: @twitter-site-username`, where \"",
            "            \"server-name matches a name from `omero.web.server_list`. \"",
            "            'For example: ``\\'{\"omero\": \"@openmicroscopy\"}\\'``'",
            "        ),",
            "    ],",
            "    \"omero.web.sharing.opengraph\": [",
            "        \"SHARING_OPENGRAPH\",",
            "        \"{}\",",
            "        json.loads,",
            "        (",
            "            \"Dictionary of `server-name: site-name`, where \"",
            "            \"server-name matches a name from `omero.web.server_list`. \"",
            "            'For example: ``\\'{\"omero\": \"Open Microscopy\"}\\'``'",
            "        ),",
            "    ],",
            "    # Application configuration",
            "    \"omero.web.server_list\": [",
            "        \"SERVER_LIST\",",
            "        '[[\"%s\", 4064, \"omero\"]]' % CUSTOM_HOST,",
            "        json.loads,",
            "        \"A list of servers the Web client can connect to.\",",
            "    ],",
            "    \"omero.web.ping_interval\": [",
            "        \"PING_INTERVAL\",",
            "        60000,",
            "        int,",
            "        \"Timeout interval between ping invocations in seconds\",",
            "    ],",
            "    \"omero.web.chunk_size\": [",
            "        \"CHUNK_SIZE\",",
            "        1048576,",
            "        int,",
            "        \"Size, in bytes, of the \u201cchunk\u201d\",",
            "    ],",
            "    \"omero.web.webgateway_cache\": [\"WEBGATEWAY_CACHE\", None, leave_none_unset, None],",
            "    \"omero.web.maximum_multifile_download_size\": [",
            "        \"MAXIMUM_MULTIFILE_DOWNLOAD_ZIP_SIZE\",",
            "        1024 ** 3,",
            "        int,",
            "        \"Prevent multiple files with total aggregate size greater than this \"",
            "        \"value in bytes from being downloaded as a zip archive.\",",
            "    ],",
            "    # VIEWER",
            "    \"omero.web.viewer.view\": [",
            "        \"VIEWER_VIEW\",",
            "        \"omeroweb.webclient.views.image_viewer\",",
            "        str,",
            "        (",
            "            \"Django view which handles display of, or redirection to, the \"",
            "            \"desired full image viewer.\"",
            "        ),",
            "    ],",
            "    # OPEN WITH",
            "    \"omero.web.open_with\": [",
            "        \"OPEN_WITH\",",
            "        (",
            "            '[[\"Image viewer\", \"webgateway\", {\"supported_objects\": [\"image\"],'",
            "            '\"script_url\": \"webclient/javascript/ome.openwith_viewer.js\"}]]'",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"A list of viewers that can be used to display selected Images \"",
            "            \"or other objects. Each viewer is defined as \"",
            "            '``[\"Name\", \"url\", options]``. Url is reverse(url). '",
            "            \"Selected objects are added to the url as ?image=:1&image=2\"",
            "            \"Objects supported must be specified in options with \"",
            "            'e.g. ``{\"supported_objects\":[\"images\"]}`` '",
            "            \"to enable viewer for one or more images.\"",
            "        ),",
            "    ],",
            "    # PIPELINE 1.3.20",
            "    # Pipeline is an asset packaging library for Django, providing both CSS",
            "    # and JavaScript concatenation and compression, built-in JavaScript",
            "    # template support, and optional data-URI image and font embedding.",
            "    \"omero.web.pipeline_js_compressor\": [",
            "        \"PIPELINE_JS_COMPRESSOR\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"Compressor class to be applied to JavaScript files. If empty or \"",
            "            \"None, JavaScript files won't be compressed.\"",
            "        ),",
            "    ],",
            "    \"omero.web.pipeline_css_compressor\": [",
            "        \"PIPELINE_CSS_COMPRESSOR\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"Compressor class to be applied to CSS files. If empty or None,\"",
            "            \" CSS files won't be compressed.\"",
            "        ),",
            "    ],",
            "    \"omero.web.pipeline_staticfile_storage\": [",
            "        \"STATICFILES_STORAGE\",",
            "        \"pipeline.storage.PipelineStorage\",",
            "        str,",
            "        (",
            "            \"The file storage engine to use when collecting static files with\"",
            "            \" the collectstatic management command. See `the documentation \"",
            "            \"<https://django-pipeline.readthedocs.org/en/latest/storages.html>`_\"",
            "            \" for more details.\"",
            "        ),",
            "    ],",
            "    # Customisation",
            "    \"omero.web.login_logo\": [",
            "        \"LOGIN_LOGO\",",
            "        None,",
            "        leave_none_unset,",
            "        (",
            "            \"Customize webclient login page with your own logo. Logo images \"",
            "            \"should ideally be 150 pixels high or less and will appear above \"",
            "            \"the OMERO logo. You will need to host the image somewhere else \"",
            "            \"and link to it with the OMERO logo.\"",
            "        ),",
            "    ],",
            "    \"omero.web.login_view\": [",
            "        \"LOGIN_VIEW\",",
            "        \"weblogin\",",
            "        str,",
            "        (",
            "            \"The Django view name used for login. Use this to provide an \"",
            "            \"alternative login workflow.\"",
            "        ),",
            "    ],",
            "    \"omero.web.login_incorrect_credentials_text\": [",
            "        \"LOGIN_INCORRECT_CREDENTIALS_TEXT\",",
            "        \"Connection not available, please check your user name and password.\",",
            "        str,",
            "        (",
            "            \"The error message shown to users who enter an incorrect username \"",
            "            \"or password.\"",
            "        ),",
            "    ],",
            "    \"omero.web.top_logo\": [",
            "        \"TOP_LOGO\",",
            "        \"\",",
            "        str,",
            "        (",
            "            \"Customize the webclient top bar logo. The recommended image height \"",
            "            \"is 23 pixels and it must be hosted outside of OMERO.web.\"",
            "        ),",
            "    ],",
            "    \"omero.web.top_logo_link\": [",
            "        \"TOP_LOGO_LINK\",",
            "        \"\",",
            "        str,",
            "        (\"The target location of the webclient top logo, default unlinked.\"),",
            "    ],",
            "    \"omero.web.user_dropdown\": [",
            "        \"USER_DROPDOWN\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"Whether or not to include a user dropdown in the base template.\"",
            "            \" Particularly useful when used in combination with the OMERO.web\"",
            "            \" public user where logging in may not make sense.\"",
            "        ),",
            "    ],",
            "    \"omero.web.feedback.comment.enabled\": [",
            "        \"FEEDBACK_COMMENT_ENABLED\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"Enable the feedback form for comments. \"",
            "            \"These comments are sent to the URL in ``omero.qa.feedback`` \"",
            "            \"(OME team by default).\"",
            "        ),",
            "    ],",
            "    \"omero.web.feedback.error.enabled\": [",
            "        \"FEEDBACK_ERROR_ENABLED\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"Enable the feedback form for errors. \"",
            "            \"These errors are sent to the URL in ``omero.qa.feedback`` \"",
            "            \"(OME team by default).\"",
            "        ),",
            "    ],",
            "    \"omero.web.staticfile_dirs\": [",
            "        \"STATICFILES_DIRS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Defines the additional locations the staticfiles app will traverse\"",
            "            \" if the FileSystemFinder finder is enabled, e.g. if you use the\"",
            "            \" collectstatic or findstatic management command or use the static\"",
            "            \" file serving view.\"",
            "        ),",
            "    ],",
            "    \"omero.web.template_dirs\": [",
            "        \"TEMPLATE_DIRS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"List of locations of the template source files, in search order. \"",
            "            \"Note that these paths should use Unix-style forward slashes.\"",
            "        ),",
            "    ],",
            "    \"omero.web.index_template\": [",
            "        \"INDEX_TEMPLATE\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"Define template used as an index page ``http://your_host/omero/``.\"",
            "            \"If None user is automatically redirected to the login page.\"",
            "            \"For example use 'webclient/index.html'. \"",
            "        ),",
            "    ],",
            "    \"omero.web.base_include_template\": [",
            "        \"BASE_INCLUDE_TEMPLATE\",",
            "        None,",
            "        identity,",
            "        (\"Template to be included in every page, at the end of the <body>\"),",
            "    ],",
            "    \"omero.web.login_redirect\": [",
            "        \"LOGIN_REDIRECT\",",
            "        \"{}\",",
            "        json.loads,",
            "        (",
            "            \"Redirect to the given location after logging in. It only supports \"",
            "            \"arguments for :djangodoc:`Django reverse function\"",
            "            \" <ref/urlresolvers/#reverse>`. \"",
            "            'For example: ``\\'{\"redirect\": [\"webindex\"], \"viewname\":'",
            "            ' \"load_template\", \"args\":[\"userdata\"], \"query_string\":'",
            "            ' {\"experimenter\": -1}}\\'``'",
            "        ),",
            "    ],",
            "    \"omero.web.login.show_client_downloads\": [",
            "        \"SHOW_CLIENT_DOWNLOADS\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (\"Whether to link to official client downloads on the login page\"),",
            "    ],",
            "    \"omero.web.login.client_downloads_base\": [",
            "        \"CLIENT_DOWNLOAD_GITHUB_REPO\",",
            "        \"ome/omero-insight\",",
            "        str,",
            "        (\"GitHub repository containing the Desktop client downloads\"),",
            "    ],",
            "    \"omero.web.apps\": [",
            "        \"ADDITIONAL_APPS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Add additional Django applications. For example, see\"",
            "            \" :doc:`/developers/Web/CreateApp`\"",
            "        ),",
            "    ],",
            "    \"omero.web.root_application\": [",
            "        \"OMEROWEB_ROOT_APPLICATION\",",
            "        \"\",",
            "        str,",
            "        (",
            "            \"Override the root application label that handles ``/``. \"",
            "            \"**Warning** you must ensure the application's URLs do not conflict \"",
            "            \"with other applications. \"",
            "            \"omero-gallery is an example of an application that can be used for \"",
            "            \"this (set to ``gallery``)\"",
            "        ),",
            "    ],",
            "    \"omero.web.databases\": [\"DATABASES\", \"{}\", json.loads, None],",
            "    \"omero.web.page_size\": [",
            "        \"PAGE\",",
            "        200,",
            "        int,",
            "        (",
            "            \"Number of images displayed within a dataset or 'orphaned'\"",
            "            \" container to prevent from loading them all at once.\"",
            "        ),",
            "    ],",
            "    \"omero.web.thumbnails_batch\": [",
            "        \"THUMBNAILS_BATCH\",",
            "        50,",
            "        int,",
            "        (",
            "            \"Number of thumbnails retrieved to prevent from loading them\"",
            "            \" all at once. Make sure the size is not too big, otherwise\"",
            "            \" you may exceed limit request line, see\"",
            "            \" https://docs.gunicorn.org/en/latest/settings.html\"",
            "            \"?highlight=limit_request_line\"",
            "        ),",
            "    ],",
            "    \"omero.web.ui.top_links\": [",
            "        \"TOP_LINKS\",",
            "        (",
            "            \"[\"",
            "            '[\"Data\", \"webindex\", {\"title\": \"Browse Data via Projects, Tags'",
            "            ' etc\"}],'",
            "            '[\"History\", \"history\", {\"title\": \"History\"}],'",
            "            '[\"Help\", \"https://help.openmicroscopy.org/\",'",
            "            '{\"title\":\"Open OMERO user guide in a new tab\", \"target\":\"new\"}]'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Add links to the top header: links are ``['Link Text', \"",
            "            \"'link|lookup_view', options]``, where the url is reverse('link'), \"",
            "            \"simply 'link' (for external urls) or lookup_view is a detailed \"",
            "            'dictionary {\"viewname\": \"str\", \"args\": [], \"query_string\": '",
            "            '{\"param\": \"value\" }], '",
            "            'E.g. ``\\'[\"Webtest\", \"webtest_index\"] or [\"Homepage\",'",
            "            ' \"http://...\", {\"title\": \"Homepage\", \"target\": \"new\"}'",
            "            ' ] or [\"Repository\", {\"viewname\": \"webindex\", '",
            "            '\"query_string\": {\"experimenter\": -1}}, '",
            "            '{\"title\": \"Repo\"}]\\'``'",
            "        ),",
            "    ],",
            "    \"omero.web.ui.metadata_panes\": [",
            "        \"METADATA_PANES\",",
            "        (",
            "            \"[\"",
            "            '{\"name\": \"tag\", \"label\": \"Tags\", \"index\": 1},'",
            "            '{\"name\": \"map\", \"label\": \"Key-Value Pairs\", \"index\": 2},'",
            "            '{\"name\": \"table\", \"label\": \"Tables\", \"index\": 3},'",
            "            '{\"name\": \"file\", \"label\": \"Attachments\", \"index\": 4},'",
            "            '{\"name\": \"comment\", \"label\": \"Comments\", \"index\": 5},'",
            "            '{\"name\": \"rating\", \"label\": \"Ratings\", \"index\": 6},'",
            "            '{\"name\": \"other\", \"label\": \"Others\", \"index\": 7}'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Manage Metadata pane accordion. This functionality is limited to\"",
            "            \" the existing sections.\"",
            "        ),",
            "    ],",
            "    \"omero.web.ui.right_plugins\": [",
            "        \"RIGHT_PLUGINS\",",
            "        (",
            "            '[[\"Acquisition\",'",
            "            ' \"webclient/data/includes/right_plugin.acquisition.js.html\",'",
            "            ' \"metadata_tab\"],'",
            "            # '[\"ROIs\", \"webtest/webclient_plugins/right_plugin.rois.js.html\",",
            "            # \"image_roi_tab\"],'",
            "            '[\"Preview\", \"webclient/data/includes/right_plugin.preview.js.html\"'",
            "            ', \"preview_tab\"]]'",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Add plugins to the right-hand panel. \"",
            "            \"Plugins are ``['Label', 'include.js', 'div_id']``. \"",
            "            \"The javascript loads data into ``$('#div_id')``.\"",
            "        ),",
            "    ],",
            "    \"omero.web.ui.center_plugins\": [",
            "        \"CENTER_PLUGINS\",",
            "        (",
            "            \"[\"",
            "            # '[\"Split View\",",
            "            # \"webtest/webclient_plugins/center_plugin.splitview.js.html\",",
            "            # \"split_view_panel\"],'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Add plugins to the center panels. Plugins are \"",
            "            \"``['Channel overlay',\"",
            "            \" 'webtest/webclient_plugins/center_plugin.overlay.js.html',\"",
            "            \" 'channel_overlay_panel']``. \"",
            "            \"The javascript loads data into ``$('#div_id')``.\"",
            "        ),",
            "    ],",
            "    # CORS",
            "    \"omero.web.cors_origin_whitelist\": [",
            "        \"CORS_ORIGIN_WHITELIST\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"A list of origin hostnames that are authorized to make cross-site \"",
            "            \"HTTP requests. \"",
            "            \"Used by the django-cors-headers app as described at \"",
            "            \"https://github.com/ottoyiu/django-cors-headers\"",
            "        ),",
            "    ],",
            "    \"omero.web.cors_origin_allow_all\": [",
            "        \"CORS_ORIGIN_ALLOW_ALL\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"If True, cors_origin_whitelist will not be used and all origins \"",
            "            \"will be authorized to make cross-site HTTP requests.\"",
            "        ),",
            "    ],",
            "    \"omero.web.x_frame_options\": [",
            "        \"X_FRAME_OPTIONS\",",
            "        \"SAMEORIGIN\",",
            "        str,",
            "        \"Whether to allow OMERO.web to be loaded in a frame.\",",
            "    ],",
            "    \"omero.web.django_additional_settings\": [",
            "        \"DJANGO_ADDITIONAL_SETTINGS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Additional Django settings as list of key-value tuples. \"",
            "            \"Use this to set or override Django settings that aren't managed by \"",
            "            'OMERO.web. E.g. ``[\"CUSTOM_KEY\", \"CUSTOM_VALUE\"]``'",
            "        ),",
            "    ],",
            "    \"omero.web.nginx_server_extra_config\": [",
            "        \"NGINX_SERVER_EXTRA_CONFIG\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Extra configuration lines to add to the Nginx server block. \"",
            "            \"Lines will be joined with \\\\n. \"",
            "            \"Remember to terminate lines with; when necessary.\"",
            "        ),",
            "    ],",
            "}",
            "",
            "DEPRECATED_SETTINGS_MAPPINGS = {",
            "    # Deprecated settings, description should indicate the replacement.",
            "    \"omero.web.force_script_name\": [",
            "        \"FORCE_SCRIPT_NAME\",",
            "        None,",
            "        leave_none_unset,",
            "        (\"Use omero.web.prefix instead.\"),",
            "    ],",
            "    \"omero.web.server_email\": [",
            "        \"SERVER_EMAIL\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.from instead.\"),",
            "    ],",
            "    \"omero.web.email_host\": [",
            "        \"EMAIL_HOST\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.host instead.\"),",
            "    ],",
            "    \"omero.web.email_host_password\": [",
            "        \"EMAIL_HOST_PASSWORD\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.password instead.\"),",
            "    ],",
            "    \"omero.web.email_host_user\": [",
            "        \"EMAIL_HOST_USER\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.username instead.\"),",
            "    ],",
            "    \"omero.web.email_port\": [",
            "        \"EMAIL_PORT\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.port instead.\"),",
            "    ],",
            "    \"omero.web.email_subject_prefix\": [",
            "        \"EMAIL_SUBJECT_PREFIX\",",
            "        \"[OMERO.web]\",",
            "        str,",
            "        (\"Default email subject is no longer configurable.\"),",
            "    ],",
            "    \"omero.web.email_use_tls\": [",
            "        \"EMAIL_USE_TLS\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (\"Use omero.mail.smtp.* instead to set up\" \" javax.mail.Session properties.\"),",
            "    ],",
            "    \"omero.web.plate_download.enabled\": [",
            "        \"PLATE_DOWNLOAD_ENABLED\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (\"Use omero.policy.binary_access instead to restrict download.\"),",
            "    ],",
            "    \"omero.web.viewer.initial_zoom_level\": [",
            "        \"VIEWER_INITIAL_ZOOM_LEVEL\",",
            "        None,",
            "        leave_none_unset_int,",
            "        (\"Use omero.client.viewer.initial_zoom_level instead.\"),",
            "    ],",
            "    \"omero.web.send_broken_link_emails\": [",
            "        \"SEND_BROKEN_LINK_EMAILS\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Replaced by django.middleware.common.BrokenLinkEmailsMiddleware.\"",
            "            \"To get notification set :property:`omero.web.admins` property.\"",
            "        ),",
            "    ],",
            "}",
            "",
            "del CUSTOM_HOST",
            "",
            "",
            "def check_worker_class(c):",
            "    if c == \"gevent\":",
            "        try:",
            "            import gevent  # NOQA",
            "        except ImportError:",
            "            raise ImportError(",
            "                \"You are using async workers based \"",
            "                \"on Greenlets via Gevent. Install gevent\"",
            "            )",
            "    return str(c)",
            "",
            "",
            "def check_threading(t):",
            "    if t > 1:",
            "        try:",
            "            import concurrent.futures  # NOQA",
            "        except ImportError:",
            "            raise ImportError(",
            "                \"You are using sync workers with \" \"multiple threads. Install futures\"",
            "            )",
            "    return int(t)",
            "",
            "",
            "# DEVELOPMENT_SETTINGS_MAPPINGS - WARNING: For each setting developer MUST open",
            "# a ticket that needs to be resolved before a release either by moving the",
            "# setting to CUSTOM_SETTINGS_MAPPINGS or by removing the setting at all.",
            "DEVELOPMENT_SETTINGS_MAPPINGS = {",
            "    \"omero.web.wsgi_worker_class\": [",
            "        \"WSGI_WORKER_CLASS\",",
            "        \"sync\",",
            "        check_worker_class,",
            "        (",
            "            \"The default OMERO.web uses sync workers to handle most \u201cnormal\u201d \"",
            "            \"types of workloads. Check Gunicorn Design Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/design.html\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_worker_connections\": [",
            "        \"WSGI_WORKER_CONNECTIONS\",",
            "        1000,",
            "        int,",
            "        (",
            "            \"(ASYNC WORKERS only) The maximum number of simultaneous clients. \"",
            "            \"Check Gunicorn Documentation https://docs.gunicorn.org\"",
            "            \"/en/stable/settings.html#worker-connections\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_threads\": [",
            "        \"WSGI_THREADS\",",
            "        1,",
            "        check_threading,",
            "        (",
            "            \"(SYNC WORKERS only) The number of worker threads for handling \"",
            "            \"requests. Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/settings.html#threads\"",
            "        ),",
            "    ],",
            "}",
            "",
            "",
            "def map_deprecated_settings(settings):",
            "    m = {}",
            "    for key, values in settings.items():",
            "        try:",
            "            global_name = values[0]",
            "            m[global_name] = (CUSTOM_SETTINGS[key], key)",
            "            if len(values) < 5:",
            "                # Not using default (see process_custom_settings)",
            "                values.append(False)",
            "        except KeyError:",
            "            if len(values) < 5:",
            "                values.append(True)",
            "    return m",
            "",
            "",
            "def process_custom_settings(",
            "    module, settings=\"CUSTOM_SETTINGS_MAPPINGS\", deprecated=None",
            "):",
            "    logging.info(\"Processing custom settings for module %s\" % module.__name__)",
            "",
            "    if deprecated:",
            "        deprecated_map = map_deprecated_settings(getattr(module, deprecated, {}))",
            "    else:",
            "        deprecated_map = {}",
            "",
            "    for key, values in getattr(module, settings, {}).items():",
            "        # Django may import settings.py more than once, see:",
            "        # http://blog.dscpl.com.au/2010/03/improved-wsgi-script-for-use-with.html",
            "        # In that case, the custom settings have already been processed.",
            "        if len(values) == 5:",
            "            continue",
            "",
            "        global_name, default_value, mapping, description = values",
            "",
            "        try:",
            "            global_value = CUSTOM_SETTINGS[key]",
            "            values.append(False)",
            "        except KeyError:",
            "            global_value = default_value",
            "            values.append(True)",
            "",
            "        try:",
            "            using_default = values[-1]",
            "            if global_name in deprecated_map:",
            "                dep_value, dep_key = deprecated_map[global_name]",
            "                if using_default:",
            "                    logging.warning(\"Setting %s is deprecated, use %s\", dep_key, key)",
            "                    global_value = dep_value",
            "                else:",
            "                    logging.error(",
            "                        \"%s and its deprecated key %s are both set, using %s\",",
            "                        key,",
            "                        dep_key,",
            "                        key,",
            "                    )",
            "            setattr(module, global_name, mapping(global_value))",
            "        except ValueError as e:",
            "            raise ValueError(",
            "                \"Invalid %s (%s = %r). %s. %s\"",
            "                % (global_name, key, global_value, e.args[0], description)",
            "            )",
            "        except ImportError as e:",
            "            raise ImportError(",
            "                \"ImportError: %s. %s (%s = %r).\\n%s\"",
            "                % (e.message, global_name, key, global_value, description)",
            "            )",
            "        except LeaveUnset:",
            "            pass",
            "",
            "",
            "process_custom_settings(sys.modules[__name__], \"INTERNAL_SETTINGS_MAPPING\")",
            "process_custom_settings(",
            "    sys.modules[__name__], \"CUSTOM_SETTINGS_MAPPINGS\", \"DEPRECATED_SETTINGS_MAPPINGS\"",
            ")",
            "process_custom_settings(sys.modules[__name__], \"DEVELOPMENT_SETTINGS_MAPPINGS\")",
            "",
            "if not DEBUG:  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "    LOGGING[\"loggers\"][\"django.request\"][\"level\"] = \"INFO\"",
            "    LOGGING[\"loggers\"][\"django\"][\"level\"] = \"INFO\"",
            "    LOGGING[\"loggers\"][\"\"][\"level\"] = \"INFO\"",
            "",
            "",
            "def report_settings(module):",
            "    from django.views.debug import cleanse_setting",
            "",
            "    custom_settings_mappings = getattr(module, \"CUSTOM_SETTINGS_MAPPINGS\", {})",
            "    for key in sorted(custom_settings_mappings):",
            "        values = custom_settings_mappings[key]",
            "        global_name, default_value, mapping, description, using_default = values",
            "        source = using_default and \"default\" or key",
            "        global_value = getattr(module, global_name, None)",
            "        if global_name.isupper():",
            "            logger.debug(",
            "                \"%s = %r (source:%s)\",",
            "                global_name,",
            "                cleanse_setting(global_name, global_value),",
            "                source,",
            "            )",
            "",
            "    deprecated_settings = getattr(module, \"DEPRECATED_SETTINGS_MAPPINGS\", {})",
            "    for key in sorted(deprecated_settings):",
            "        values = deprecated_settings[key]",
            "        global_name, default_value, mapping, description, using_default = values",
            "        global_value = getattr(module, global_name, None)",
            "        if global_name.isupper() and not using_default:",
            "            logger.debug(",
            "                \"%s = %r (deprecated:%s, %s)\",",
            "                global_name,",
            "                cleanse_setting(global_name, global_value),",
            "                key,",
            "                description,",
            "            )",
            "",
            "",
            "report_settings(sys.modules[__name__])",
            "",
            "SITE_ID = 1",
            "",
            "# Local time zone for this installation. Choices can be found here:",
            "# http://www.postgresql.org/docs/8.1/static/datetime-keywords.html#DATETIME-TIMEZONE-SET-TABLE",
            "# although not all variations may be possible on all operating systems.",
            "TIME_ZONE = \"Europe/London\"",
            "FIRST_DAY_OF_WEEK = 0  # 0-Monday, ... 6-Sunday",
            "",
            "# LANGUAGE_CODE: A string representing the language code for this",
            "# installation. This should be in standard language format. For example, U.S.",
            "# English is \"en-us\".",
            "LANGUAGE_CODE = \"en-gb\"",
            "",
            "# SECRET_KEY: A secret key for this particular Django installation. Used to",
            "# provide a seed in secret-key hashing algorithms. Set this to a random string,",
            "# the longer, the better. Make this unique, and don't share it with anybody.",
            "try:",
            "    SECRET_KEY",
            "except NameError:",
            "    secret_path = os.path.join(OMERODIR, \"var\", \"django_secret_key\").replace(\"\\\\\", \"/\")",
            "    if not os.path.isfile(secret_path):",
            "        try:",
            "            secret_key = \"\".join(",
            "                [",
            "                    random.SystemRandom().choice(",
            "                        \"{0}{1}{2}\".format(",
            "                            string.ascii_letters, string.digits, string.punctuation",
            "                        )",
            "                    )",
            "                    for i in range(50)",
            "                ]",
            "            )",
            "            with os.fdopen(",
            "                os.open(secret_path, os.O_WRONLY | os.O_CREAT, 0o600), \"w\"",
            "            ) as secret_file:",
            "                secret_file.write(secret_key)",
            "        except IOError:",
            "            raise IOError(",
            "                \"Please create a %s file with random characters\"",
            "                \" to generate your secret key!\" % secret_path",
            "            )",
            "    try:",
            "        with open(secret_path, \"r\") as secret_file:",
            "            SECRET_KEY = secret_file.read().strip()",
            "    except IOError:",
            "        raise IOError(\"Could not find secret key in %s!\" % secret_path)",
            "",
            "# USE_I18N: A boolean that specifies whether Django's internationalization",
            "# system should be enabled.",
            "# This provides an easy way to turn it off, for performance. If this is set to",
            "# False, Django will make some optimizations so as not to load the",
            "# internationalization machinery.",
            "USE_I18N = True",
            "",
            "# ROOT_URLCONF: A string representing the full Python import path to your root",
            "# URLconf.",
            "# For example: \"mydjangoapps.urls\". Can be overridden on a per-request basis",
            "# by setting the attribute urlconf on the incoming HttpRequest object.",
            "ROOT_URLCONF = \"omeroweb.urls\"",
            "",
            "# STATICFILES_FINDERS: The list of finder backends that know how to find",
            "# static files in various locations. The default will find files stored in the",
            "# STATICFILES_DIRS setting (using",
            "# django.contrib.staticfiles.finders.FileSystemFinder) and in a static",
            "# subdirectory of each app (using",
            "# django.contrib.staticfiles.finders.AppDirectoriesFinder)",
            "STATICFILES_FINDERS = (",
            "    \"django.contrib.staticfiles.finders.FileSystemFinder\",",
            "    \"django.contrib.staticfiles.finders.AppDirectoriesFinder\",",
            "    \"pipeline.finders.PipelineFinder\",",
            ")",
            "",
            "# STATICFILES_DIRS: This setting defines the additional locations the",
            "# staticfiles app will traverse if the FileSystemFinder finder is enabled,",
            "# e.g. if you use the collectstatic or findstatic management command or use",
            "# the static file serving view.",
            "# from CUSTOM_SETTINGS_MAPPINGS",
            "# STATICFILES_DIRS += ((\"webapp/custom_static\", path/to/statics),)  # noqa",
            "",
            "# TEMPLATES: A list containing the settings for all template engines",
            "# to be used with Django. Each item of the list is a dictionary containing",
            "# the options for an individual engine.",
            "TEMPLATES = [",
            "    {",
            "        \"BACKEND\": \"django.template.backends.django.DjangoTemplates\",",
            "        \"DIRS\": TEMPLATE_DIRS,  # noqa",
            "        \"APP_DIRS\": True,",
            "        \"OPTIONS\": {",
            "            \"builtins\": [\"omeroweb.webgateway.templatetags.defaulttags\"],",
            "            \"debug\": DEBUG,  # noqa",
            "            \"context_processors\": [",
            "                # Insert your TEMPLATE_CONTEXT_PROCESSORS here or use this",
            "                # list if you haven't customized them:",
            "                \"django.contrib.auth.context_processors.auth\",",
            "                \"django.template.context_processors.debug\",",
            "                \"django.template.context_processors.i18n\",",
            "                \"django.template.context_processors.media\",",
            "                \"django.template.context_processors.static\",",
            "                \"django.template.context_processors.tz\",",
            "                \"django.contrib.messages.context_processors.messages\",",
            "                \"omeroweb.custom_context_processor.url_suffix\",",
            "                \"omeroweb.custom_context_processor.base_include_template\",",
            "            ],",
            "        },",
            "    },",
            "]",
            "",
            "# INSTALLED_APPS: A tuple of strings designating all applications that are",
            "# enabled in this Django installation. Each string should be a full Python",
            "# path to a Python package that contains a Django application, as created by",
            "# django-admin.py startapp.",
            "INSTALLED_APPS = (",
            "    \"django.contrib.staticfiles\",",
            "    \"django.contrib.auth\",",
            "    \"django.contrib.contenttypes\",",
            "    \"django.contrib.sessions\",",
            "    \"django.contrib.sites\",",
            ")",
            "",
            "# ADDITONAL_APPS: We import any settings.py from apps. This allows them to",
            "# modify settings.",
            "# We're also processing any CUSTOM_SETTINGS_MAPPINGS defined there.",
            "for app in ADDITIONAL_APPS:  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "    # Previously the app was added to INSTALLED_APPS as 'omeroweb.app', which",
            "    # then required the app to reside within or be symlinked from within",
            "    # omeroweb, instead of just having to be somewhere on the python path.",
            "    # To allow apps to just be on the path, but keep it backwards compatible,",
            "    # try to import as omeroweb.app, if it works, keep that in INSTALLED_APPS,",
            "    # otherwise add it to INSTALLED_APPS just with its own name.",
            "    try:",
            "        __import__(\"omeroweb.%s\" % app)",
            "        INSTALLED_APPS += (\"omeroweb.%s\" % app,)",
            "    except ImportError:",
            "        INSTALLED_APPS += (app,)",
            "    try:",
            "        logger.debug(\"Attempting to import additional app settings for app: %s\" % app)",
            "        module = __import__(\"%s.settings\" % app)",
            "        process_custom_settings(module.settings)",
            "        report_settings(module.settings)",
            "    except ImportError:",
            "        logger.debug(\"Couldn't import settings from app: %s\" % app)",
            "",
            "INSTALLED_APPS += (",
            "    \"omeroweb.feedback\",",
            "    \"omeroweb.webadmin\",",
            "    \"omeroweb.webclient\",",
            "    \"omeroweb.webgateway\",",
            "    \"omeroweb.webredirect\",",
            "    \"omeroweb.api\",",
            "    \"pipeline\",",
            ")",
            "",
            "logger.debug(\"INSTALLED_APPS=%s\" % [INSTALLED_APPS])",
            "",
            "",
            "PIPELINE = {",
            "    \"STYLESHEETS\": {",
            "        \"webgateway_viewer\": {",
            "            \"source_filenames\": (",
            "                \"webgateway/css/reset.css\",",
            "                \"webgateway/css/ome.body.css\",",
            "                \"webclient/css/dusty.css\",",
            "                \"webgateway/css/ome.viewport.css\",",
            "                \"webgateway/css/ome.toolbar.css\",",
            "                \"webgateway/css/ome.gs_slider.css\",",
            "                \"webgateway/css/base.css\",",
            "                \"webgateway/css/ome.snippet_header_logo.css\",",
            "                \"webgateway/css/ome.postit.css\",",
            "                \"3rdparty/farbtastic-1.2/farbtastic.css\",",
            "                \"webgateway/css/ome.colorbtn.css\",",
            "                \"3rdparty/JQuerySpinBtn-1.3a/JQuerySpinBtn.css\",",
            "                \"3rdparty/jquery-ui-1.10.4/themes/base/jquery-ui.all.css\",",
            "                \"webgateway/css/omero_image.css\",",
            "                \"3rdparty/panojs-2.0.0/panojs.css\",",
            "            ),",
            "            \"output_filename\": \"omeroweb.viewer.min.css\",",
            "        },",
            "    },",
            "    \"CSS_COMPRESSOR\": \"pipeline.compressors.NoopCompressor\",",
            "    \"JS_COMPRESSOR\": \"pipeline.compressors.NoopCompressor\",",
            "    \"JAVASCRIPT\": {",
            "        \"webgateway_viewer\": {",
            "            \"source_filenames\": (",
            "                \"3rdparty/jquery-1.11.1.js\",",
            "                \"3rdparty/jquery-migrate-1.2.1.js\",",
            "                \"3rdparty/jquery-ui-1.10.4/js/jquery-ui.1.10.4.js\",",
            "                \"webgateway/js/ome.popup.js\",",
            "                \"3rdparty/aop-1.3.js\",",
            "                \"3rdparty/raphael-2.1.0/raphael.js\",",
            "                \"3rdparty/raphael-2.1.0/scale.raphael.js\",",
            "                \"3rdparty/panojs-2.0.0/utils.js\",",
            "                \"3rdparty/panojs-2.0.0/PanoJS.js\",",
            "                \"3rdparty/panojs-2.0.0/controls.js\",",
            "                \"3rdparty/panojs-2.0.0/pyramid_Bisque.js\",",
            "                \"3rdparty/panojs-2.0.0/pyramid_imgcnv.js\",",
            "                \"3rdparty/panojs-2.0.0/pyramid_Zoomify.js\",",
            "                \"3rdparty/panojs-2.0.0/control_thumbnail.js\",",
            "                \"3rdparty/panojs-2.0.0/control_info.js\",",
            "                \"3rdparty/panojs-2.0.0/control_svg.js\",",
            "                \"3rdparty/panojs-2.0.0/control_roi.js\",",
            "                \"3rdparty/panojs-2.0.0/control_scalebar.js\",",
            "                \"3rdparty/hammer-2.0.2/hammer.min.js\",",
            "                \"webgateway/js/ome.gs_utils.js\",",
            "                \"webgateway/js/ome.viewportImage.js\",",
            "                \"webgateway/js/ome.gs_slider.js\",",
            "                \"webgateway/js/ome.viewport.js\",",
            "                \"webgateway/js/omero_image.js\",",
            "                \"webgateway/js/ome.roidisplay.js\",",
            "                \"webgateway/js/ome.scalebardisplay.js\",",
            "                \"webgateway/js/ome.smartdialog.js\",",
            "                \"webgateway/js/ome.roiutils.js\",",
            "                \"3rdparty/JQuerySpinBtn-1.3a/JQuerySpinBtn.js\",",
            "                \"webgateway/js/ome.colorbtn.js\",",
            "                \"webgateway/js/ome.postit.js\",",
            "                \"3rdparty/jquery.selectboxes-2.2.6.js\",",
            "                \"3rdparty/farbtastic-1.2/farbtastic.js\",",
            "                \"3rdparty/jquery.mousewheel-3.0.6.js\",",
            "            ),",
            "            \"output_filename\": \"omeroweb.viewer.min.js\",",
            "        }",
            "    },",
            "}",
            "",
            "# Prevent scripting attacks from obtaining session cookie",
            "SESSION_COOKIE_HTTPONLY = True",
            "",
            "CSRF_FAILURE_VIEW = \"omeroweb.feedback.views.csrf_failure\"",
            "",
            "# Configuration for django-cors-headers app",
            "# See https://github.com/ottoyiu/django-cors-headers",
            "# Configration of allowed origins is handled by custom settings above",
            "CORS_ALLOW_CREDENTIALS = True",
            "# Needed for Django <1.9 since CSRF_TRUSTED_ORIGINS not supported",
            "CORS_REPLACE_HTTPS_REFERER = True",
            "",
            "# FEEDBACK - DO NOT MODIFY!",
            "# FEEDBACK_URL: Is now configurable for testing purpuse only. Used in",
            "# feedback.sendfeedback.SendFeedback class in order to submit errors or",
            "# comment messages to http://qa.openmicroscopy.org.uk.",
            "# FEEDBACK_APP: 6 = OMERO.web",
            "FEEDBACK_APP = 6",
            "",
            "# IGNORABLE_404_STARTS:",
            "# Default: ('/cgi-bin/', '/_vti_bin', '/_vti_inf')",
            "# IGNORABLE_404_ENDS:",
            "# Default: ('mail.pl', 'mailform.pl', 'mail.cgi', 'mailform.cgi',",
            "# 'favicon.ico', '.php')",
            "",
            "# SESSION_FILE_PATH: If you're using file-based session storage, this sets the",
            "# directory in which Django will store session data. When the default value",
            "# (None) is used, Django will use the standard temporary directory for the",
            "# system.",
            "SESSION_FILE_PATH = tempfile.gettempdir()",
            "",
            "# FILE_UPLOAD_TEMP_DIR: The directory to store data temporarily while",
            "# uploading files.",
            "FILE_UPLOAD_TEMP_DIR = tempfile.gettempdir()",
            "",
            "# # FILE_UPLOAD_MAX_MEMORY_SIZE: The maximum size (in bytes) that an upload",
            "# will be before it gets streamed to the file system.",
            "FILE_UPLOAD_MAX_MEMORY_SIZE = 2621440  # default 2621440 (i.e. 2.5 MB).",
            "",
            "# DEFAULT_IMG: Used in",
            "# webclient.webclient_gateway.OmeroWebGateway.defaultThumbnail in order to",
            "# load default image while thumbnail can't be retrieved from the server.",
            "DEFAULT_IMG = os.path.join(",
            "    os.path.dirname(__file__),",
            "    \"webgateway\",",
            "    \"static\",",
            "    \"webgateway\",",
            "    \"img\",",
            "    \"image128.png\",",
            ").replace(\"\\\\\", \"/\")",
            "",
            "# # DEFAULT_USER: Used in",
            "# webclient.webclient_gateway.OmeroWebGateway.getExperimenterDefaultPhoto in",
            "# order to load default avatar while experimenter photo can't be retrieved",
            "# from the server.",
            "DEFAULT_USER = os.path.join(",
            "    os.path.dirname(__file__),",
            "    \"webgateway\",",
            "    \"static\",",
            "    \"webgateway\",",
            "    \"img\",",
            "    \"personal32.png\",",
            ").replace(\"\\\\\", \"/\")",
            "",
            "# MANAGERS: A tuple in the same format as ADMINS that specifies who should get",
            "# broken-link notifications when",
            "# SEND_BROKEN_LINK_EMAILS=True.",
            "MANAGERS = ADMINS  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "",
            "# https://docs.djangoproject.com/en/1.6/releases/1.6/#default-session-serialization-switched-to-json",
            "# JSON serializer, which is now the default, cannot handle",
            "# omeroweb.connector.Connector object",
            "SESSION_SERIALIZER = \"django.contrib.sessions.serializers.PickleSerializer\"",
            "",
            "# Load custom settings from etc/grid/config.xml",
            "# Tue  2 Nov 2010 11:03:18 GMT -- ticket:3228",
            "# MIDDLEWARE: A tuple of middleware classes to use.",
            "MIDDLEWARE = sort_properties_to_tuple(MIDDLEWARE_CLASSES_LIST)  # noqa",
            "",
            "for k, v in DJANGO_ADDITIONAL_SETTINGS:  # noqa",
            "    setattr(sys.modules[__name__], k, v)",
            "",
            "",
            "# Load server list and freeze",
            "def load_server_list():",
            "    for s in SERVER_LIST:  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "        server = (len(s) > 2) and text(s[2]) or None",
            "        Server(host=text(s[0]), port=int(s[1]), server=server)",
            "    Server.freeze()",
            "",
            "",
            "load_server_list()"
        ],
        "afterPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "#",
            "# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #",
            "# #                Django settings for OMERO.web project.               # #",
            "# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #",
            "#",
            "#",
            "# Copyright (c) 2008-2016 University of Dundee.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "# Author: Aleksandra Tarkowska <A(dot)Tarkowska(at)dundee(dot)ac(dot)uk>, 2008.",
            "#",
            "# Version: 1.0",
            "#",
            "",
            "",
            "import os.path",
            "import sys",
            "import logging",
            "import omero",
            "import omero.config",
            "import omero.clients",
            "import tempfile",
            "import re",
            "import json",
            "import random",
            "import string",
            "from builtins import str as text",
            "",
            "from omero_ext import portalocker",
            "from omero.util.concurrency import get_event",
            "from omeroweb.utils import sort_properties_to_tuple",
            "from omeroweb.connector import Server",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "# LOGS",
            "# NEVER DEPLOY a site into production with DEBUG turned on.",
            "# Debuging mode.",
            "# A boolean that turns on/off debug mode.",
            "# handler404 and handler500 works only when False",
            "if \"OMERO_HOME\" in os.environ:",
            "    logger.warn(\"OMERO_HOME usage is ignored in OMERO.web\")",
            "",
            "OMERODIR = os.environ.get(\"OMERODIR\")",
            "if not OMERODIR:",
            "    raise Exception(\"ERROR: OMERODIR not set\")",
            "",
            "# Logging",
            "LOGDIR = os.path.join(OMERODIR, \"var\", \"log\").replace(\"\\\\\", \"/\")",
            "",
            "if not os.path.isdir(LOGDIR):",
            "    try:",
            "        os.makedirs(LOGDIR)",
            "    except Exception:",
            "        exctype, value = sys.exc_info()[:2]",
            "        raise exctype(value)",
            "",
            "# DEBUG: Never deploy a site into production with DEBUG turned on.",
            "# Logging levels: logging.DEBUG, logging.INFO, logging.WARNING, logging.ERROR",
            "# logging.CRITICAL",
            "# FORMAT: 2010-01-01 00:00:00,000 INFO  [omeroweb.webadmin.webadmin_utils]",
            "# (proc.1308 ) getGuestConnection:20 Open connection is not available",
            "",
            "STANDARD_LOGFORMAT = (",
            "    \"%(asctime)s %(levelname)5.5s [%(name)40.40s]\"",
            "    \" (proc.%(process)5.5d) %(funcName)s():%(lineno)d %(message)s\"",
            ")",
            "",
            "FULL_REQUEST_LOGFORMAT = (",
            "    \"%(asctime)s %(levelname)5.5s [%(name)40.40s]\"",
            "    \" (proc.%(process)5.5d) %(funcName)s():%(lineno)d\"",
            "    \" HTTP %(status_code)d %(request)s\"",
            ")",
            "",
            "LOGGING_CLASS = \"omero_ext.cloghandler.ConcurrentRotatingFileHandler\"",
            "LOGSIZE = 500000000",
            "",
            "",
            "LOGGING = {",
            "    \"version\": 1,",
            "    \"disable_existing_loggers\": False,",
            "    \"formatters\": {",
            "        \"standard\": {\"format\": STANDARD_LOGFORMAT},",
            "        \"full_request\": {\"format\": FULL_REQUEST_LOGFORMAT},",
            "    },",
            "    \"filters\": {",
            "        \"require_debug_false\": {",
            "            \"()\": \"django.utils.log.RequireDebugFalse\",",
            "        },",
            "        \"require_debug_true\": {",
            "            \"()\": \"django.utils.log.RequireDebugTrue\",",
            "        },",
            "    },",
            "    \"handlers\": {",
            "        \"default\": {",
            "            \"level\": \"DEBUG\",",
            "            \"class\": LOGGING_CLASS,",
            "            \"filename\": os.path.join(LOGDIR, \"OMEROweb.log\").replace(\"\\\\\", \"/\"),",
            "            \"maxBytes\": LOGSIZE,",
            "            \"backupCount\": 10,",
            "            \"formatter\": \"standard\",",
            "        },",
            "        \"request_handler\": {",
            "            \"level\": \"DEBUG\",",
            "            \"class\": LOGGING_CLASS,",
            "            \"filename\": os.path.join(LOGDIR, \"OMEROweb.log\").replace(\"\\\\\", \"/\"),",
            "            \"maxBytes\": LOGSIZE,",
            "            \"backupCount\": 10,",
            "            \"filters\": [\"require_debug_false\"],",
            "            \"formatter\": \"full_request\",",
            "        },",
            "        \"console\": {",
            "            \"level\": \"INFO\",",
            "            \"filters\": [\"require_debug_true\"],",
            "            \"class\": \"logging.StreamHandler\",",
            "            \"formatter\": \"standard\",",
            "        },",
            "        \"mail_admins\": {",
            "            \"level\": \"ERROR\",",
            "            \"filters\": [\"require_debug_false\"],",
            "            \"class\": \"django.utils.log.AdminEmailHandler\",",
            "        },",
            "    },",
            "    \"loggers\": {",
            "        \"django.request\": {  # Stop SQL debug from logging to main logger",
            "            \"handlers\": [\"default\", \"request_handler\", \"mail_admins\"],",
            "            \"level\": \"DEBUG\",",
            "            \"propagate\": False,",
            "        },",
            "        \"django\": {\"handlers\": [\"console\"], \"level\": \"DEBUG\", \"propagate\": True},",
            "        \"\": {\"handlers\": [\"default\"], \"level\": \"DEBUG\", \"propagate\": True},",
            "    },",
            "}",
            "",
            "",
            "CONFIG_XML = os.path.join(OMERODIR, \"etc\", \"grid\", \"config.xml\")",
            "count = 10",
            "event = get_event(\"websettings\")",
            "",
            "while True:",
            "    try:",
            "        CUSTOM_SETTINGS = dict()",
            "        if os.path.exists(CONFIG_XML):",
            "            CONFIG_XML = omero.config.ConfigXml(CONFIG_XML, read_only=True)",
            "            CUSTOM_SETTINGS = CONFIG_XML.as_map()",
            "            CONFIG_XML.close()",
            "        break",
            "    except portalocker.LockException:",
            "        # logger.error(\"Exception while loading configuration retrying...\",",
            "        # exc_info=True)",
            "        exctype, value = sys.exc_info()[:2]",
            "        count -= 1",
            "        if not count:",
            "            raise exctype(value)",
            "        else:",
            "            event.wait(1)  # Wait a total of 10 seconds",
            "    except Exception:",
            "        # logger.error(\"Exception while loading configuration...\",",
            "        # exc_info=True)",
            "        exctype, value = sys.exc_info()[:2]",
            "        raise exctype(value)",
            "",
            "del event",
            "del count",
            "del get_event",
            "",
            "WSGI = \"wsgi\"",
            "WSGITCP = \"wsgi-tcp\"",
            "WSGI_TYPES = (WSGI, WSGITCP)",
            "DEVELOPMENT = \"development\"",
            "DEFAULT_SERVER_TYPE = WSGITCP",
            "ALL_SERVER_TYPES = (WSGI, WSGITCP, DEVELOPMENT)",
            "",
            "DEFAULT_SESSION_ENGINE = \"omeroweb.filesessionstore\"",
            "SESSION_ENGINE_VALUES = (",
            "    \"omeroweb.filesessionstore\",",
            "    \"django.contrib.sessions.backends.db\",",
            "    \"django.contrib.sessions.backends.file\",",
            "    \"django.contrib.sessions.backends.cache\",",
            "    \"django.contrib.sessions.backends.cached_db\",",
            ")",
            "",
            "",
            "def parse_boolean(s):",
            "    s = s.strip().lower()",
            "    if s in (\"true\", \"1\", \"t\"):",
            "        return True",
            "    return False",
            "",
            "",
            "def parse_paths(s):",
            "    return [os.path.normpath(path) for path in json.loads(s)]",
            "",
            "",
            "def check_server_type(s):",
            "    if s not in ALL_SERVER_TYPES:",
            "        raise ValueError(",
            "            \"Unknown server type: %s. Valid values are: %s\" % (s, ALL_SERVER_TYPES)",
            "        )",
            "    return s",
            "",
            "",
            "def check_session_engine(s):",
            "    if s not in SESSION_ENGINE_VALUES:",
            "        raise ValueError(",
            "            \"Unknown session engine: %s. Valid values are: %s\"",
            "            % (s, SESSION_ENGINE_VALUES)",
            "        )",
            "    return s",
            "",
            "",
            "def identity(x):",
            "    return x",
            "",
            "",
            "def str_slash(s):",
            "    if s is not None:",
            "        s = str(s)",
            "        if s and not s.endswith(\"/\"):",
            "            s += \"/\"",
            "    return s",
            "",
            "",
            "class LeaveUnset(Exception):",
            "    pass",
            "",
            "",
            "def leave_none_unset(s):",
            "    if s is None:",
            "        raise LeaveUnset()",
            "    return s",
            "",
            "",
            "def leave_none_unset_int(s):",
            "    s = leave_none_unset(s)",
            "    if s is not None:",
            "        return int(s)",
            "",
            "",
            "CUSTOM_HOST = CUSTOM_SETTINGS.get(\"Ice.Default.Host\", \"localhost\")",
            "CUSTOM_HOST = CUSTOM_SETTINGS.get(\"omero.master.host\", CUSTOM_HOST)",
            "# DO NOT EDIT!",
            "INTERNAL_SETTINGS_MAPPING = {",
            "    \"omero.qa.feedback\": [\"FEEDBACK_URL\", \"http://qa.openmicroscopy.org.uk\", str, None],",
            "    \"omero.web.upgrades.url\": [\"UPGRADES_URL\", None, leave_none_unset, None],",
            "    \"omero.web.check_version\": [\"CHECK_VERSION\", \"true\", parse_boolean, None],",
            "    # Allowed hosts:",
            "    # https://docs.djangoproject.com/en/1.8/ref/settings/#allowed-hosts",
            "    \"omero.web.allowed_hosts\": [\"ALLOWED_HOSTS\", '[\"*\"]', json.loads, None],",
            "    # Do not show WARNING (1_8.W001): The standalone TEMPLATE_* settings",
            "    # were deprecated in Django 1.8 and the TEMPLATES dictionary takes",
            "    # precedence. You must put the values of the following settings",
            "    # into your default TEMPLATES dict:",
            "    # TEMPLATE_DIRS, TEMPLATE_CONTEXT_PROCESSORS.",
            "    \"omero.web.system_checks\": [",
            "        \"SILENCED_SYSTEM_CHECKS\",",
            "        '[\"1_8.W001\"]',",
            "        json.loads,",
            "        None,",
            "    ],",
            "    # Internal email notification for omero.web.admins,",
            "    # loaded from config.xml directly",
            "    \"omero.mail.from\": [",
            "        \"SERVER_EMAIL\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"The email address that error messages come from, such as those\"",
            "            \" sent to :property:`omero.web.admins`.  Requires EMAIL properties\"",
            "            \" below.\"",
            "        ),",
            "    ],",
            "    \"omero.mail.host\": [",
            "        \"EMAIL_HOST\",",
            "        None,",
            "        identity,",
            "        \"The SMTP server host to use for sending email.\",",
            "    ],",
            "    \"omero.mail.password\": [",
            "        \"EMAIL_HOST_PASSWORD\",",
            "        None,",
            "        identity,",
            "        \"Password to use for the SMTP server.\",",
            "    ],",
            "    \"omero.mail.username\": [",
            "        \"EMAIL_HOST_USER\",",
            "        None,",
            "        identity,",
            "        \"Username to use for the SMTP server.\",",
            "    ],",
            "    \"omero.mail.port\": [\"EMAIL_PORT\", 25, identity, \"Port to use for the SMTP server.\"],",
            "    \"omero.web.admins.email_subject_prefix\": [",
            "        \"EMAIL_SUBJECT_PREFIX\",",
            "        \"[OMERO.web - admin notification]\",",
            "        str,",
            "        \"Subject-line prefix for email messages\",",
            "    ],",
            "    \"omero.mail.smtp.starttls.enable\": [",
            "        \"EMAIL_USE_TLS\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Whether to use a TLS (secure) connection when talking to the SMTP\"",
            "            \" server.\"",
            "        ),",
            "    ],",
            "}",
            "",
            "CUSTOM_SETTINGS_MAPPINGS = {",
            "    # Deployment configuration",
            "    \"omero.web.debug\": [",
            "        \"DEBUG\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"A boolean that turns on/off debug mode. \"",
            "            \"Use debug mode only in development, not in production, as it logs \"",
            "            \"sensitive and confidential information in plaintext.\"",
            "        ),",
            "    ],",
            "    \"omero.web.secret_key\": [",
            "        \"SECRET_KEY\",",
            "        None,",
            "        leave_none_unset,",
            "        (\"A boolean that sets SECRET_KEY for a particular Django \" \"installation.\"),",
            "    ],",
            "    \"omero.web.admins\": [",
            "        \"ADMINS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"A list of people who get code error notifications whenever the \"",
            "            \"application identifies a broken link or raises an unhandled \"",
            "            \"exception that results in an internal server error. This gives \"",
            "            \"the administrators immediate notification of any errors, \"",
            "            \"see :doc:`/sysadmins/mail`. \"",
            "            'Example:``\\'[[\"Full Name\", \"email address\"]]\\'``.'",
            "        ),",
            "    ],",
            "    \"omero.web.application_server\": [",
            "        \"APPLICATION_SERVER\",",
            "        DEFAULT_SERVER_TYPE,",
            "        check_server_type,",
            "        (",
            "            \"OMERO.web is configured to run in Gunicorn as a generic WSGI (TCP)\"",
            "            \"application by default. Available options: ``wsgi-tcp`` \"",
            "            \"(Gunicorn, default), ``wsgi`` (Advanced users only, e.g. manual \"",
            "            \"Apache configuration with ``mod_wsgi``).\"",
            "        ),",
            "    ],",
            "    \"omero.web.application_server.host\": [",
            "        \"APPLICATION_SERVER_HOST\",",
            "        \"127.0.0.1\",",
            "        str,",
            "        \"The front-end webserver e.g. NGINX can be set up to run on a \"",
            "        \"different host from OMERO.web. The property ensures that OMERO.web \"",
            "        \"is accessible on an external IP. It requires copying all the \"",
            "        \"OMERO.web static files to the separate NGINX server.\",",
            "    ],",
            "    \"omero.web.application_server.port\": [",
            "        \"APPLICATION_SERVER_PORT\",",
            "        4080,",
            "        int,",
            "        \"Upstream application port\",",
            "    ],",
            "    \"omero.web.application_server.max_requests\": [",
            "        \"APPLICATION_SERVER_MAX_REQUESTS\",",
            "        0,",
            "        int,",
            "        (\"The maximum number of requests a worker will process before \" \"restarting.\"),",
            "    ],",
            "    \"omero.web.middleware\": [",
            "        \"MIDDLEWARE_CLASSES_LIST\",",
            "        (",
            "            \"[\"",
            "            '{\"index\": 1, '",
            "            '\"class\": \"django.middleware.common.BrokenLinkEmailsMiddleware\"},'",
            "            '{\"index\": 2, '",
            "            '\"class\": \"django.middleware.common.CommonMiddleware\"},'",
            "            '{\"index\": 3, '",
            "            '\"class\": \"django.contrib.sessions.middleware.SessionMiddleware\"},'",
            "            '{\"index\": 4, '",
            "            '\"class\": \"django.middleware.csrf.CsrfViewMiddleware\"},'",
            "            '{\"index\": 5, '",
            "            '\"class\": \"django.contrib.messages.middleware.MessageMiddleware\"},'",
            "            '{\"index\": 6, '",
            "            '\"class\": \"django.middleware.clickjacking.XFrameOptionsMiddleware\"}'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Warning: Only system administrators should use this feature. \"",
            "            \"List of Django middleware classes in the form \"",
            "            '[{\"class\": \"class.name\", \"index\": FLOAT}]. '",
            "            \"See :djangodoc:`Django middleware <topics/http/middleware/>`.\"",
            "            \" Classes will be ordered by increasing index\"",
            "        ),",
            "    ],",
            "    \"omero.web.prefix\": [",
            "        \"FORCE_SCRIPT_NAME\",",
            "        None,",
            "        leave_none_unset,",
            "        (",
            "            \"Used as the value of the SCRIPT_NAME environment variable in any\"",
            "            \" HTTP request.\"",
            "        ),",
            "    ],",
            "    \"omero.web.use_x_forwarded_host\": [",
            "        \"USE_X_FORWARDED_HOST\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Specifies whether to use the X-Forwarded-Host header in preference \"",
            "            \"to the Host header. This should only be enabled if a proxy which \"",
            "            \"sets this header is in use.\"",
            "        ),",
            "    ],",
            "    \"omero.web.static_url\": [",
            "        \"STATIC_URL\",",
            "        \"/static/\",",
            "        str_slash,",
            "        (",
            "            \"URL to use when referring to static files. Example: ``'/static/'``\"",
            "            \" or ``'http://static.example.com/'``. Used as the base path for\"",
            "            \" asset  definitions (the Media class) and the staticfiles app. It\"",
            "            \" must end in a slash if set to a non-empty value.\"",
            "        ),",
            "    ],",
            "    \"omero.web.static_root\": [",
            "        \"STATIC_ROOT\",",
            "        os.path.join(OMERODIR, \"var\", \"static\"),",
            "        os.path.normpath,",
            "        (",
            "            \"The absolute path to the directory where collectstatic will\"",
            "            \" collect static files for deployment. If the staticfiles contrib\"",
            "            \" app is enabled (default) the collectstatic management command\"",
            "            \" will collect static files into this directory.\"",
            "        ),",
            "    ],",
            "    \"omero.web.session_engine\": [",
            "        \"SESSION_ENGINE\",",
            "        DEFAULT_SESSION_ENGINE,",
            "        check_session_engine,",
            "        (",
            "            \"Controls where Django stores session data. See :djangodoc:\"",
            "            \"`Configuring the session engine for more details <ref/settings\"",
            "            \"/#session-engine>`.\"",
            "        ),",
            "    ],",
            "    \"omero.web.session_expire_at_browser_close\": [",
            "        \"SESSION_EXPIRE_AT_BROWSER_CLOSE\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"A boolean that determines whether to expire the session when the \"",
            "            \"user closes their browser. See :djangodoc:`Django Browser-length \"",
            "            \"sessions vs. persistent sessions documentation <topics/http/\"",
            "            \"sessions/#browser-length-vs-persistent-sessions>` for more \"",
            "            \"details.\"",
            "        ),",
            "    ],",
            "    \"omero.web.caches\": [",
            "        \"CACHES\",",
            "        ('{\"default\": {\"BACKEND\":' ' \"django.core.cache.backends.dummy.DummyCache\"}}'),",
            "        json.loads,",
            "        (",
            "            \"OMERO.web offers alternative session backends to automatically\"",
            "            \" delete stale data using the cache session store backend, see \"",
            "            \":djangodoc:`Django cached session documentation <topics/http/\"",
            "            \"sessions/#using-cached-sessions>` for more details.\"",
            "        ),",
            "    ],",
            "    \"omero.web.secure\": [",
            "        \"SECURE\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (\"Force all backend OMERO.server connections to use SSL.\"),",
            "    ],",
            "    \"omero.web.session_cookie_age\": [",
            "        \"SESSION_COOKIE_AGE\",",
            "        86400,",
            "        int,",
            "        \"The age of session cookies, in seconds.\",",
            "    ],",
            "    \"omero.web.session_cookie_domain\": [",
            "        \"SESSION_COOKIE_DOMAIN\",",
            "        None,",
            "        leave_none_unset,",
            "        \"The domain to use for session cookies\",",
            "    ],",
            "    \"omero.web.session_cookie_name\": [",
            "        \"SESSION_COOKIE_NAME\",",
            "        None,",
            "        leave_none_unset,",
            "        \"The name to use for session cookies\",",
            "    ],",
            "    \"omero.web.session_cookie_path\": [",
            "        \"SESSION_COOKIE_PATH\",",
            "        None,",
            "        leave_none_unset,",
            "        \"The path to use for session cookies\",",
            "    ],",
            "    \"omero.web.session_cookie_secure\": [",
            "        \"SESSION_COOKIE_SECURE\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Restrict session cookies to HTTPS only, you are strongly \"",
            "            \"recommended to set this to ``true`` in production.\"",
            "        ),",
            "    ],",
            "    \"omero.web.csrf_cookie_secure\": [",
            "        \"CSRF_COOKIE_SECURE\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Restrict CSRF cookies to HTTPS only, you are strongly \"",
            "            \"recommended to set this to ``true`` in production.\"",
            "        ),",
            "    ],",
            "    \"omero.web.csrf_cookie_httponly\": [",
            "        \"CSRF_COOKIE_HTTPONLY\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Prevent CSRF cookie from being accessed in JavaScript. \"",
            "            \"Currently disabled as it breaks background JavaScript POSTs in \"",
            "            \"OMERO.web.\"",
            "        ),",
            "    ],",
            "    \"omero.web.logdir\": [\"LOGDIR\", LOGDIR, str, \"A path to the custom log directory.\"],",
            "    \"omero.web.secure_proxy_ssl_header\": [",
            "        \"SECURE_PROXY_SSL_HEADER\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"A tuple representing a HTTP header/value combination that \"",
            "            \"signifies a request is secure. Example \"",
            "            '``\\'[\"HTTP_X_FORWARDED_PROTO_OMERO_WEB\", \"https\"]\\'``. '",
            "            \"For more details see :djangodoc:`secure proxy ssl header <ref/\"",
            "            \"settings/#secure-proxy-ssl-header>`.\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_args\": [",
            "        \"WSGI_ARGS\",",
            "        None,",
            "        leave_none_unset,",
            "        (",
            "            \"A string representing Gunicorn additional arguments. \"",
            "            \"Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/latest/settings.html\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_workers\": [",
            "        \"WSGI_WORKERS\",",
            "        5,",
            "        int,",
            "        (",
            "            \"The number of worker processes for handling requests. \"",
            "            \"Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/settings.html#workers\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_timeout\": [",
            "        \"WSGI_TIMEOUT\",",
            "        60,",
            "        int,",
            "        (",
            "            \"Workers silent for more than this many seconds are killed \"",
            "            \"and restarted. Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/settings.html#timeout\"",
            "        ),",
            "    ],",
            "    # Public user",
            "    \"omero.web.public.enabled\": [",
            "        \"PUBLIC_ENABLED\",",
            "        \"false\",",
            "        parse_boolean,",
            "        \"Enable and disable the OMERO.web public user functionality.\",",
            "    ],",
            "    \"omero.web.public.url_filter\": [",
            "        \"PUBLIC_URL_FILTER\",",
            "        r\"(?#This regular expression matches nothing)a^\",",
            "        re.compile,",
            "        (",
            "            \"Set a regular expression that matches URLs the public user is \"",
            "            \"allowed to access. If this is not set, no URLs will be \"",
            "            \"publicly available.\"",
            "        ),",
            "    ],",
            "    \"omero.web.public.get_only\": [",
            "        \"PUBLIC_GET_ONLY\",",
            "        \"true\",",
            "        parse_boolean,",
            "        \"Restrict public users to GET requests only\",",
            "    ],",
            "    \"omero.web.public.server_id\": [",
            "        \"PUBLIC_SERVER_ID\",",
            "        1,",
            "        int,",
            "        \"Server to authenticate against.\",",
            "    ],",
            "    \"omero.web.public.user\": [",
            "        \"PUBLIC_USER\",",
            "        None,",
            "        leave_none_unset,",
            "        \"Username to use during authentication.\",",
            "    ],",
            "    \"omero.web.public.password\": [",
            "        \"PUBLIC_PASSWORD\",",
            "        None,",
            "        leave_none_unset,",
            "        \"Password to use during authentication.\",",
            "    ],",
            "    \"omero.web.public.cache.enabled\": [",
            "        \"PUBLIC_CACHE_ENABLED\",",
            "        \"false\",",
            "        parse_boolean,",
            "        None,",
            "    ],",
            "    \"omero.web.public.cache.key\": [",
            "        \"PUBLIC_CACHE_KEY\",",
            "        \"omero.web.public.cache.key\",",
            "        str,",
            "        None,",
            "    ],",
            "    \"omero.web.public.cache.timeout\": [\"PUBLIC_CACHE_TIMEOUT\", 60 * 60 * 24, int, None],",
            "    # Social media integration",
            "    \"omero.web.sharing.twitter\": [",
            "        \"SHARING_TWITTER\",",
            "        \"{}\",",
            "        json.loads,",
            "        (",
            "            \"Dictionary of `server-name: @twitter-site-username`, where \"",
            "            \"server-name matches a name from `omero.web.server_list`. \"",
            "            'For example: ``\\'{\"omero\": \"@openmicroscopy\"}\\'``'",
            "        ),",
            "    ],",
            "    \"omero.web.sharing.opengraph\": [",
            "        \"SHARING_OPENGRAPH\",",
            "        \"{}\",",
            "        json.loads,",
            "        (",
            "            \"Dictionary of `server-name: site-name`, where \"",
            "            \"server-name matches a name from `omero.web.server_list`. \"",
            "            'For example: ``\\'{\"omero\": \"Open Microscopy\"}\\'``'",
            "        ),",
            "    ],",
            "    # Application configuration",
            "    \"omero.web.server_list\": [",
            "        \"SERVER_LIST\",",
            "        '[[\"%s\", 4064, \"omero\"]]' % CUSTOM_HOST,",
            "        json.loads,",
            "        \"A list of servers the Web client can connect to.\",",
            "    ],",
            "    \"omero.web.ping_interval\": [",
            "        \"PING_INTERVAL\",",
            "        60000,",
            "        int,",
            "        \"Timeout interval between ping invocations in seconds\",",
            "    ],",
            "    \"omero.web.chunk_size\": [",
            "        \"CHUNK_SIZE\",",
            "        1048576,",
            "        int,",
            "        \"Size, in bytes, of the \u201cchunk\u201d\",",
            "    ],",
            "    \"omero.web.webgateway_cache\": [\"WEBGATEWAY_CACHE\", None, leave_none_unset, None],",
            "    \"omero.web.maximum_multifile_download_size\": [",
            "        \"MAXIMUM_MULTIFILE_DOWNLOAD_ZIP_SIZE\",",
            "        1024 ** 3,",
            "        int,",
            "        \"Prevent multiple files with total aggregate size greater than this \"",
            "        \"value in bytes from being downloaded as a zip archive.\",",
            "    ],",
            "    # VIEWER",
            "    \"omero.web.viewer.view\": [",
            "        \"VIEWER_VIEW\",",
            "        \"omeroweb.webclient.views.image_viewer\",",
            "        str,",
            "        (",
            "            \"Django view which handles display of, or redirection to, the \"",
            "            \"desired full image viewer.\"",
            "        ),",
            "    ],",
            "    # OPEN WITH",
            "    \"omero.web.open_with\": [",
            "        \"OPEN_WITH\",",
            "        (",
            "            '[[\"Image viewer\", \"webgateway\", {\"supported_objects\": [\"image\"],'",
            "            '\"script_url\": \"webclient/javascript/ome.openwith_viewer.js\"}]]'",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"A list of viewers that can be used to display selected Images \"",
            "            \"or other objects. Each viewer is defined as \"",
            "            '``[\"Name\", \"url\", options]``. Url is reverse(url). '",
            "            \"Selected objects are added to the url as ?image=:1&image=2\"",
            "            \"Objects supported must be specified in options with \"",
            "            'e.g. ``{\"supported_objects\":[\"images\"]}`` '",
            "            \"to enable viewer for one or more images.\"",
            "        ),",
            "    ],",
            "    # PIPELINE 1.3.20",
            "    # Pipeline is an asset packaging library for Django, providing both CSS",
            "    # and JavaScript concatenation and compression, built-in JavaScript",
            "    # template support, and optional data-URI image and font embedding.",
            "    \"omero.web.pipeline_js_compressor\": [",
            "        \"PIPELINE_JS_COMPRESSOR\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"Compressor class to be applied to JavaScript files. If empty or \"",
            "            \"None, JavaScript files won't be compressed.\"",
            "        ),",
            "    ],",
            "    \"omero.web.pipeline_css_compressor\": [",
            "        \"PIPELINE_CSS_COMPRESSOR\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"Compressor class to be applied to CSS files. If empty or None,\"",
            "            \" CSS files won't be compressed.\"",
            "        ),",
            "    ],",
            "    \"omero.web.pipeline_staticfile_storage\": [",
            "        \"STATICFILES_STORAGE\",",
            "        \"pipeline.storage.PipelineStorage\",",
            "        str,",
            "        (",
            "            \"The file storage engine to use when collecting static files with\"",
            "            \" the collectstatic management command. See `the documentation \"",
            "            \"<https://django-pipeline.readthedocs.org/en/latest/storages.html>`_\"",
            "            \" for more details.\"",
            "        ),",
            "    ],",
            "    # Customisation",
            "    \"omero.web.login_logo\": [",
            "        \"LOGIN_LOGO\",",
            "        None,",
            "        leave_none_unset,",
            "        (",
            "            \"Customize webclient login page with your own logo. Logo images \"",
            "            \"should ideally be 150 pixels high or less and will appear above \"",
            "            \"the OMERO logo. You will need to host the image somewhere else \"",
            "            \"and link to it with the OMERO logo.\"",
            "        ),",
            "    ],",
            "    \"omero.web.login_view\": [",
            "        \"LOGIN_VIEW\",",
            "        \"weblogin\",",
            "        str,",
            "        (",
            "            \"The Django view name used for login. Use this to provide an \"",
            "            \"alternative login workflow.\"",
            "        ),",
            "    ],",
            "    \"omero.web.login_incorrect_credentials_text\": [",
            "        \"LOGIN_INCORRECT_CREDENTIALS_TEXT\",",
            "        \"Connection not available, please check your user name and password.\",",
            "        str,",
            "        (",
            "            \"The error message shown to users who enter an incorrect username \"",
            "            \"or password.\"",
            "        ),",
            "    ],",
            "    \"omero.web.top_logo\": [",
            "        \"TOP_LOGO\",",
            "        \"\",",
            "        str,",
            "        (",
            "            \"Customize the webclient top bar logo. The recommended image height \"",
            "            \"is 23 pixels and it must be hosted outside of OMERO.web.\"",
            "        ),",
            "    ],",
            "    \"omero.web.top_logo_link\": [",
            "        \"TOP_LOGO_LINK\",",
            "        \"\",",
            "        str,",
            "        (\"The target location of the webclient top logo, default unlinked.\"),",
            "    ],",
            "    \"omero.web.user_dropdown\": [",
            "        \"USER_DROPDOWN\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"Whether or not to include a user dropdown in the base template.\"",
            "            \" Particularly useful when used in combination with the OMERO.web\"",
            "            \" public user where logging in may not make sense.\"",
            "        ),",
            "    ],",
            "    \"omero.web.feedback.comment.enabled\": [",
            "        \"FEEDBACK_COMMENT_ENABLED\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"Enable the feedback form for comments. \"",
            "            \"These comments are sent to the URL in ``omero.qa.feedback`` \"",
            "            \"(OME team by default).\"",
            "        ),",
            "    ],",
            "    \"omero.web.feedback.error.enabled\": [",
            "        \"FEEDBACK_ERROR_ENABLED\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (",
            "            \"Enable the feedback form for errors. \"",
            "            \"These errors are sent to the URL in ``omero.qa.feedback`` \"",
            "            \"(OME team by default).\"",
            "        ),",
            "    ],",
            "    \"omero.web.staticfile_dirs\": [",
            "        \"STATICFILES_DIRS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Defines the additional locations the staticfiles app will traverse\"",
            "            \" if the FileSystemFinder finder is enabled, e.g. if you use the\"",
            "            \" collectstatic or findstatic management command or use the static\"",
            "            \" file serving view.\"",
            "        ),",
            "    ],",
            "    \"omero.web.template_dirs\": [",
            "        \"TEMPLATE_DIRS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"List of locations of the template source files, in search order. \"",
            "            \"Note that these paths should use Unix-style forward slashes.\"",
            "        ),",
            "    ],",
            "    \"omero.web.index_template\": [",
            "        \"INDEX_TEMPLATE\",",
            "        None,",
            "        identity,",
            "        (",
            "            \"Define template used as an index page ``http://your_host/omero/``.\"",
            "            \"If None user is automatically redirected to the login page.\"",
            "            \"For example use 'webclient/index.html'. \"",
            "        ),",
            "    ],",
            "    \"omero.web.base_include_template\": [",
            "        \"BASE_INCLUDE_TEMPLATE\",",
            "        None,",
            "        identity,",
            "        (\"Template to be included in every page, at the end of the <body>\"),",
            "    ],",
            "    \"omero.web.login_redirect\": [",
            "        \"LOGIN_REDIRECT\",",
            "        \"{}\",",
            "        json.loads,",
            "        (",
            "            \"Redirect to the given location after logging in. It only supports \"",
            "            \"arguments for :djangodoc:`Django reverse function\"",
            "            \" <ref/urlresolvers/#reverse>`. \"",
            "            'For example: ``\\'{\"redirect\": [\"webindex\"], \"viewname\":'",
            "            ' \"load_template\", \"args\":[\"userdata\"], \"query_string\":'",
            "            ' {\"experimenter\": -1}}\\'``'",
            "        ),",
            "    ],",
            "    \"omero.web.redirect_allowed_hosts\": [",
            "        \"REDIRECT_ALLOWED_HOSTS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"If you wish to allow redirects to an external site, \"",
            "            \"the domains must be listed here. \"",
            "            'For example [\"openmicroscopy.org\"].'",
            "        ),",
            "    ],",
            "    \"omero.web.login.show_client_downloads\": [",
            "        \"SHOW_CLIENT_DOWNLOADS\",",
            "        \"true\",",
            "        parse_boolean,",
            "        (\"Whether to link to official client downloads on the login page\"),",
            "    ],",
            "    \"omero.web.login.client_downloads_base\": [",
            "        \"CLIENT_DOWNLOAD_GITHUB_REPO\",",
            "        \"ome/omero-insight\",",
            "        str,",
            "        (\"GitHub repository containing the Desktop client downloads\"),",
            "    ],",
            "    \"omero.web.apps\": [",
            "        \"ADDITIONAL_APPS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Add additional Django applications. For example, see\"",
            "            \" :doc:`/developers/Web/CreateApp`\"",
            "        ),",
            "    ],",
            "    \"omero.web.root_application\": [",
            "        \"OMEROWEB_ROOT_APPLICATION\",",
            "        \"\",",
            "        str,",
            "        (",
            "            \"Override the root application label that handles ``/``. \"",
            "            \"**Warning** you must ensure the application's URLs do not conflict \"",
            "            \"with other applications. \"",
            "            \"omero-gallery is an example of an application that can be used for \"",
            "            \"this (set to ``gallery``)\"",
            "        ),",
            "    ],",
            "    \"omero.web.databases\": [\"DATABASES\", \"{}\", json.loads, None],",
            "    \"omero.web.page_size\": [",
            "        \"PAGE\",",
            "        200,",
            "        int,",
            "        (",
            "            \"Number of images displayed within a dataset or 'orphaned'\"",
            "            \" container to prevent from loading them all at once.\"",
            "        ),",
            "    ],",
            "    \"omero.web.thumbnails_batch\": [",
            "        \"THUMBNAILS_BATCH\",",
            "        50,",
            "        int,",
            "        (",
            "            \"Number of thumbnails retrieved to prevent from loading them\"",
            "            \" all at once. Make sure the size is not too big, otherwise\"",
            "            \" you may exceed limit request line, see\"",
            "            \" https://docs.gunicorn.org/en/latest/settings.html\"",
            "            \"?highlight=limit_request_line\"",
            "        ),",
            "    ],",
            "    \"omero.web.ui.top_links\": [",
            "        \"TOP_LINKS\",",
            "        (",
            "            \"[\"",
            "            '[\"Data\", \"webindex\", {\"title\": \"Browse Data via Projects, Tags'",
            "            ' etc\"}],'",
            "            '[\"History\", \"history\", {\"title\": \"History\"}],'",
            "            '[\"Help\", \"https://help.openmicroscopy.org/\",'",
            "            '{\"title\":\"Open OMERO user guide in a new tab\", \"target\":\"new\"}]'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Add links to the top header: links are ``['Link Text', \"",
            "            \"'link|lookup_view', options]``, where the url is reverse('link'), \"",
            "            \"simply 'link' (for external urls) or lookup_view is a detailed \"",
            "            'dictionary {\"viewname\": \"str\", \"args\": [], \"query_string\": '",
            "            '{\"param\": \"value\" }], '",
            "            'E.g. ``\\'[\"Webtest\", \"webtest_index\"] or [\"Homepage\",'",
            "            ' \"http://...\", {\"title\": \"Homepage\", \"target\": \"new\"}'",
            "            ' ] or [\"Repository\", {\"viewname\": \"webindex\", '",
            "            '\"query_string\": {\"experimenter\": -1}}, '",
            "            '{\"title\": \"Repo\"}]\\'``'",
            "        ),",
            "    ],",
            "    \"omero.web.ui.metadata_panes\": [",
            "        \"METADATA_PANES\",",
            "        (",
            "            \"[\"",
            "            '{\"name\": \"tag\", \"label\": \"Tags\", \"index\": 1},'",
            "            '{\"name\": \"map\", \"label\": \"Key-Value Pairs\", \"index\": 2},'",
            "            '{\"name\": \"table\", \"label\": \"Tables\", \"index\": 3},'",
            "            '{\"name\": \"file\", \"label\": \"Attachments\", \"index\": 4},'",
            "            '{\"name\": \"comment\", \"label\": \"Comments\", \"index\": 5},'",
            "            '{\"name\": \"rating\", \"label\": \"Ratings\", \"index\": 6},'",
            "            '{\"name\": \"other\", \"label\": \"Others\", \"index\": 7}'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Manage Metadata pane accordion. This functionality is limited to\"",
            "            \" the existing sections.\"",
            "        ),",
            "    ],",
            "    \"omero.web.ui.right_plugins\": [",
            "        \"RIGHT_PLUGINS\",",
            "        (",
            "            '[[\"Acquisition\",'",
            "            ' \"webclient/data/includes/right_plugin.acquisition.js.html\",'",
            "            ' \"metadata_tab\"],'",
            "            # '[\"ROIs\", \"webtest/webclient_plugins/right_plugin.rois.js.html\",",
            "            # \"image_roi_tab\"],'",
            "            '[\"Preview\", \"webclient/data/includes/right_plugin.preview.js.html\"'",
            "            ', \"preview_tab\"]]'",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Add plugins to the right-hand panel. \"",
            "            \"Plugins are ``['Label', 'include.js', 'div_id']``. \"",
            "            \"The javascript loads data into ``$('#div_id')``.\"",
            "        ),",
            "    ],",
            "    \"omero.web.ui.center_plugins\": [",
            "        \"CENTER_PLUGINS\",",
            "        (",
            "            \"[\"",
            "            # '[\"Split View\",",
            "            # \"webtest/webclient_plugins/center_plugin.splitview.js.html\",",
            "            # \"split_view_panel\"],'",
            "            \"]\"",
            "        ),",
            "        json.loads,",
            "        (",
            "            \"Add plugins to the center panels. Plugins are \"",
            "            \"``['Channel overlay',\"",
            "            \" 'webtest/webclient_plugins/center_plugin.overlay.js.html',\"",
            "            \" 'channel_overlay_panel']``. \"",
            "            \"The javascript loads data into ``$('#div_id')``.\"",
            "        ),",
            "    ],",
            "    # CORS",
            "    \"omero.web.cors_origin_whitelist\": [",
            "        \"CORS_ORIGIN_WHITELIST\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"A list of origin hostnames that are authorized to make cross-site \"",
            "            \"HTTP requests. \"",
            "            \"Used by the django-cors-headers app as described at \"",
            "            \"https://github.com/ottoyiu/django-cors-headers\"",
            "        ),",
            "    ],",
            "    \"omero.web.cors_origin_allow_all\": [",
            "        \"CORS_ORIGIN_ALLOW_ALL\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"If True, cors_origin_whitelist will not be used and all origins \"",
            "            \"will be authorized to make cross-site HTTP requests.\"",
            "        ),",
            "    ],",
            "    \"omero.web.html_meta_referrer\": [",
            "        \"HTML_META_REFERRER\",",
            "        \"origin-when-crossorigin\",",
            "        str,",
            "        (",
            "            \"Default content for the HTML Meta referrer tag. \"",
            "            \"See https://www.w3.org/TR/referrer-policy/#referrer-policies for \"",
            "            \"allowed values and https://caniuse.com/#feat=referrer-policy for \"",
            "            \"browser compatibility. \"",
            "            \"Warning: Internet Explorer 11 does not support the default value \"",
            "            'of this setting, you may want to change this to \"origin\" after '",
            "            \"reviewing the linked documentation.\"",
            "        ),",
            "    ],",
            "    \"omero.web.x_frame_options\": [",
            "        \"X_FRAME_OPTIONS\",",
            "        \"SAMEORIGIN\",",
            "        str,",
            "        \"Whether to allow OMERO.web to be loaded in a frame.\",",
            "    ],",
            "    \"omero.web.django_additional_settings\": [",
            "        \"DJANGO_ADDITIONAL_SETTINGS\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Additional Django settings as list of key-value tuples. \"",
            "            \"Use this to set or override Django settings that aren't managed by \"",
            "            'OMERO.web. E.g. ``[\"CUSTOM_KEY\", \"CUSTOM_VALUE\"]``'",
            "        ),",
            "    ],",
            "    \"omero.web.nginx_server_extra_config\": [",
            "        \"NGINX_SERVER_EXTRA_CONFIG\",",
            "        \"[]\",",
            "        json.loads,",
            "        (",
            "            \"Extra configuration lines to add to the Nginx server block. \"",
            "            \"Lines will be joined with \\\\n. \"",
            "            \"Remember to terminate lines with; when necessary.\"",
            "        ),",
            "    ],",
            "}",
            "",
            "DEPRECATED_SETTINGS_MAPPINGS = {",
            "    # Deprecated settings, description should indicate the replacement.",
            "    \"omero.web.force_script_name\": [",
            "        \"FORCE_SCRIPT_NAME\",",
            "        None,",
            "        leave_none_unset,",
            "        (\"Use omero.web.prefix instead.\"),",
            "    ],",
            "    \"omero.web.server_email\": [",
            "        \"SERVER_EMAIL\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.from instead.\"),",
            "    ],",
            "    \"omero.web.email_host\": [",
            "        \"EMAIL_HOST\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.host instead.\"),",
            "    ],",
            "    \"omero.web.email_host_password\": [",
            "        \"EMAIL_HOST_PASSWORD\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.password instead.\"),",
            "    ],",
            "    \"omero.web.email_host_user\": [",
            "        \"EMAIL_HOST_USER\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.username instead.\"),",
            "    ],",
            "    \"omero.web.email_port\": [",
            "        \"EMAIL_PORT\",",
            "        None,",
            "        identity,",
            "        (\"Use omero.mail.port instead.\"),",
            "    ],",
            "    \"omero.web.email_subject_prefix\": [",
            "        \"EMAIL_SUBJECT_PREFIX\",",
            "        \"[OMERO.web]\",",
            "        str,",
            "        (\"Default email subject is no longer configurable.\"),",
            "    ],",
            "    \"omero.web.email_use_tls\": [",
            "        \"EMAIL_USE_TLS\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (\"Use omero.mail.smtp.* instead to set up\" \" javax.mail.Session properties.\"),",
            "    ],",
            "    \"omero.web.plate_download.enabled\": [",
            "        \"PLATE_DOWNLOAD_ENABLED\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (\"Use omero.policy.binary_access instead to restrict download.\"),",
            "    ],",
            "    \"omero.web.viewer.initial_zoom_level\": [",
            "        \"VIEWER_INITIAL_ZOOM_LEVEL\",",
            "        None,",
            "        leave_none_unset_int,",
            "        (\"Use omero.client.viewer.initial_zoom_level instead.\"),",
            "    ],",
            "    \"omero.web.send_broken_link_emails\": [",
            "        \"SEND_BROKEN_LINK_EMAILS\",",
            "        \"false\",",
            "        parse_boolean,",
            "        (",
            "            \"Replaced by django.middleware.common.BrokenLinkEmailsMiddleware.\"",
            "            \"To get notification set :property:`omero.web.admins` property.\"",
            "        ),",
            "    ],",
            "}",
            "",
            "del CUSTOM_HOST",
            "",
            "",
            "def check_worker_class(c):",
            "    if c == \"gevent\":",
            "        try:",
            "            import gevent  # NOQA",
            "        except ImportError:",
            "            raise ImportError(",
            "                \"You are using async workers based \"",
            "                \"on Greenlets via Gevent. Install gevent\"",
            "            )",
            "    return str(c)",
            "",
            "",
            "def check_threading(t):",
            "    if t > 1:",
            "        try:",
            "            import concurrent.futures  # NOQA",
            "        except ImportError:",
            "            raise ImportError(",
            "                \"You are using sync workers with \" \"multiple threads. Install futures\"",
            "            )",
            "    return int(t)",
            "",
            "",
            "# DEVELOPMENT_SETTINGS_MAPPINGS - WARNING: For each setting developer MUST open",
            "# a ticket that needs to be resolved before a release either by moving the",
            "# setting to CUSTOM_SETTINGS_MAPPINGS or by removing the setting at all.",
            "DEVELOPMENT_SETTINGS_MAPPINGS = {",
            "    \"omero.web.wsgi_worker_class\": [",
            "        \"WSGI_WORKER_CLASS\",",
            "        \"sync\",",
            "        check_worker_class,",
            "        (",
            "            \"The default OMERO.web uses sync workers to handle most \u201cnormal\u201d \"",
            "            \"types of workloads. Check Gunicorn Design Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/design.html\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_worker_connections\": [",
            "        \"WSGI_WORKER_CONNECTIONS\",",
            "        1000,",
            "        int,",
            "        (",
            "            \"(ASYNC WORKERS only) The maximum number of simultaneous clients. \"",
            "            \"Check Gunicorn Documentation https://docs.gunicorn.org\"",
            "            \"/en/stable/settings.html#worker-connections\"",
            "        ),",
            "    ],",
            "    \"omero.web.wsgi_threads\": [",
            "        \"WSGI_THREADS\",",
            "        1,",
            "        check_threading,",
            "        (",
            "            \"(SYNC WORKERS only) The number of worker threads for handling \"",
            "            \"requests. Check Gunicorn Documentation \"",
            "            \"https://docs.gunicorn.org/en/stable/settings.html#threads\"",
            "        ),",
            "    ],",
            "}",
            "",
            "",
            "def map_deprecated_settings(settings):",
            "    m = {}",
            "    for key, values in settings.items():",
            "        try:",
            "            global_name = values[0]",
            "            m[global_name] = (CUSTOM_SETTINGS[key], key)",
            "            if len(values) < 5:",
            "                # Not using default (see process_custom_settings)",
            "                values.append(False)",
            "        except KeyError:",
            "            if len(values) < 5:",
            "                values.append(True)",
            "    return m",
            "",
            "",
            "def process_custom_settings(",
            "    module, settings=\"CUSTOM_SETTINGS_MAPPINGS\", deprecated=None",
            "):",
            "    logging.info(\"Processing custom settings for module %s\" % module.__name__)",
            "",
            "    if deprecated:",
            "        deprecated_map = map_deprecated_settings(getattr(module, deprecated, {}))",
            "    else:",
            "        deprecated_map = {}",
            "",
            "    for key, values in getattr(module, settings, {}).items():",
            "        # Django may import settings.py more than once, see:",
            "        # http://blog.dscpl.com.au/2010/03/improved-wsgi-script-for-use-with.html",
            "        # In that case, the custom settings have already been processed.",
            "        if len(values) == 5:",
            "            continue",
            "",
            "        global_name, default_value, mapping, description = values",
            "",
            "        try:",
            "            global_value = CUSTOM_SETTINGS[key]",
            "            values.append(False)",
            "        except KeyError:",
            "            global_value = default_value",
            "            values.append(True)",
            "",
            "        try:",
            "            using_default = values[-1]",
            "            if global_name in deprecated_map:",
            "                dep_value, dep_key = deprecated_map[global_name]",
            "                if using_default:",
            "                    logging.warning(\"Setting %s is deprecated, use %s\", dep_key, key)",
            "                    global_value = dep_value",
            "                else:",
            "                    logging.error(",
            "                        \"%s and its deprecated key %s are both set, using %s\",",
            "                        key,",
            "                        dep_key,",
            "                        key,",
            "                    )",
            "            setattr(module, global_name, mapping(global_value))",
            "        except ValueError as e:",
            "            raise ValueError(",
            "                \"Invalid %s (%s = %r). %s. %s\"",
            "                % (global_name, key, global_value, e.args[0], description)",
            "            )",
            "        except ImportError as e:",
            "            raise ImportError(",
            "                \"ImportError: %s. %s (%s = %r).\\n%s\"",
            "                % (e.message, global_name, key, global_value, description)",
            "            )",
            "        except LeaveUnset:",
            "            pass",
            "",
            "",
            "process_custom_settings(sys.modules[__name__], \"INTERNAL_SETTINGS_MAPPING\")",
            "process_custom_settings(",
            "    sys.modules[__name__], \"CUSTOM_SETTINGS_MAPPINGS\", \"DEPRECATED_SETTINGS_MAPPINGS\"",
            ")",
            "process_custom_settings(sys.modules[__name__], \"DEVELOPMENT_SETTINGS_MAPPINGS\")",
            "",
            "if not DEBUG:  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "    LOGGING[\"loggers\"][\"django.request\"][\"level\"] = \"INFO\"",
            "    LOGGING[\"loggers\"][\"django\"][\"level\"] = \"INFO\"",
            "    LOGGING[\"loggers\"][\"\"][\"level\"] = \"INFO\"",
            "",
            "",
            "def report_settings(module):",
            "    from django.views.debug import cleanse_setting",
            "",
            "    custom_settings_mappings = getattr(module, \"CUSTOM_SETTINGS_MAPPINGS\", {})",
            "    for key in sorted(custom_settings_mappings):",
            "        values = custom_settings_mappings[key]",
            "        global_name, default_value, mapping, description, using_default = values",
            "        source = using_default and \"default\" or key",
            "        global_value = getattr(module, global_name, None)",
            "        if global_name.isupper():",
            "            logger.debug(",
            "                \"%s = %r (source:%s)\",",
            "                global_name,",
            "                cleanse_setting(global_name, global_value),",
            "                source,",
            "            )",
            "",
            "    deprecated_settings = getattr(module, \"DEPRECATED_SETTINGS_MAPPINGS\", {})",
            "    for key in sorted(deprecated_settings):",
            "        values = deprecated_settings[key]",
            "        global_name, default_value, mapping, description, using_default = values",
            "        global_value = getattr(module, global_name, None)",
            "        if global_name.isupper() and not using_default:",
            "            logger.debug(",
            "                \"%s = %r (deprecated:%s, %s)\",",
            "                global_name,",
            "                cleanse_setting(global_name, global_value),",
            "                key,",
            "                description,",
            "            )",
            "",
            "",
            "report_settings(sys.modules[__name__])",
            "",
            "SITE_ID = 1",
            "",
            "# Local time zone for this installation. Choices can be found here:",
            "# http://www.postgresql.org/docs/8.1/static/datetime-keywords.html#DATETIME-TIMEZONE-SET-TABLE",
            "# although not all variations may be possible on all operating systems.",
            "TIME_ZONE = \"Europe/London\"",
            "FIRST_DAY_OF_WEEK = 0  # 0-Monday, ... 6-Sunday",
            "",
            "# LANGUAGE_CODE: A string representing the language code for this",
            "# installation. This should be in standard language format. For example, U.S.",
            "# English is \"en-us\".",
            "LANGUAGE_CODE = \"en-gb\"",
            "",
            "# SECRET_KEY: A secret key for this particular Django installation. Used to",
            "# provide a seed in secret-key hashing algorithms. Set this to a random string,",
            "# the longer, the better. Make this unique, and don't share it with anybody.",
            "try:",
            "    SECRET_KEY",
            "except NameError:",
            "    secret_path = os.path.join(OMERODIR, \"var\", \"django_secret_key\").replace(\"\\\\\", \"/\")",
            "    if not os.path.isfile(secret_path):",
            "        try:",
            "            secret_key = \"\".join(",
            "                [",
            "                    random.SystemRandom().choice(",
            "                        \"{0}{1}{2}\".format(",
            "                            string.ascii_letters, string.digits, string.punctuation",
            "                        )",
            "                    )",
            "                    for i in range(50)",
            "                ]",
            "            )",
            "            with os.fdopen(",
            "                os.open(secret_path, os.O_WRONLY | os.O_CREAT, 0o600), \"w\"",
            "            ) as secret_file:",
            "                secret_file.write(secret_key)",
            "        except IOError:",
            "            raise IOError(",
            "                \"Please create a %s file with random characters\"",
            "                \" to generate your secret key!\" % secret_path",
            "            )",
            "    try:",
            "        with open(secret_path, \"r\") as secret_file:",
            "            SECRET_KEY = secret_file.read().strip()",
            "    except IOError:",
            "        raise IOError(\"Could not find secret key in %s!\" % secret_path)",
            "",
            "# USE_I18N: A boolean that specifies whether Django's internationalization",
            "# system should be enabled.",
            "# This provides an easy way to turn it off, for performance. If this is set to",
            "# False, Django will make some optimizations so as not to load the",
            "# internationalization machinery.",
            "USE_I18N = True",
            "",
            "# ROOT_URLCONF: A string representing the full Python import path to your root",
            "# URLconf.",
            "# For example: \"mydjangoapps.urls\". Can be overridden on a per-request basis",
            "# by setting the attribute urlconf on the incoming HttpRequest object.",
            "ROOT_URLCONF = \"omeroweb.urls\"",
            "",
            "# STATICFILES_FINDERS: The list of finder backends that know how to find",
            "# static files in various locations. The default will find files stored in the",
            "# STATICFILES_DIRS setting (using",
            "# django.contrib.staticfiles.finders.FileSystemFinder) and in a static",
            "# subdirectory of each app (using",
            "# django.contrib.staticfiles.finders.AppDirectoriesFinder)",
            "STATICFILES_FINDERS = (",
            "    \"django.contrib.staticfiles.finders.FileSystemFinder\",",
            "    \"django.contrib.staticfiles.finders.AppDirectoriesFinder\",",
            "    \"pipeline.finders.PipelineFinder\",",
            ")",
            "",
            "# STATICFILES_DIRS: This setting defines the additional locations the",
            "# staticfiles app will traverse if the FileSystemFinder finder is enabled,",
            "# e.g. if you use the collectstatic or findstatic management command or use",
            "# the static file serving view.",
            "# from CUSTOM_SETTINGS_MAPPINGS",
            "# STATICFILES_DIRS += ((\"webapp/custom_static\", path/to/statics),)  # noqa",
            "",
            "# TEMPLATES: A list containing the settings for all template engines",
            "# to be used with Django. Each item of the list is a dictionary containing",
            "# the options for an individual engine.",
            "TEMPLATES = [",
            "    {",
            "        \"BACKEND\": \"django.template.backends.django.DjangoTemplates\",",
            "        \"DIRS\": TEMPLATE_DIRS,  # noqa",
            "        \"APP_DIRS\": True,",
            "        \"OPTIONS\": {",
            "            \"builtins\": [\"omeroweb.webgateway.templatetags.defaulttags\"],",
            "            \"debug\": DEBUG,  # noqa",
            "            \"context_processors\": [",
            "                # Insert your TEMPLATE_CONTEXT_PROCESSORS here or use this",
            "                # list if you haven't customized them:",
            "                \"django.contrib.auth.context_processors.auth\",",
            "                \"django.template.context_processors.debug\",",
            "                \"django.template.context_processors.i18n\",",
            "                \"django.template.context_processors.media\",",
            "                \"django.template.context_processors.static\",",
            "                \"django.template.context_processors.tz\",",
            "                \"django.contrib.messages.context_processors.messages\",",
            "                \"omeroweb.custom_context_processor.url_suffix\",",
            "                \"omeroweb.custom_context_processor.base_include_template\",",
            "            ],",
            "        },",
            "    },",
            "]",
            "",
            "# INSTALLED_APPS: A tuple of strings designating all applications that are",
            "# enabled in this Django installation. Each string should be a full Python",
            "# path to a Python package that contains a Django application, as created by",
            "# django-admin.py startapp.",
            "INSTALLED_APPS = (",
            "    \"django.contrib.staticfiles\",",
            "    \"django.contrib.auth\",",
            "    \"django.contrib.contenttypes\",",
            "    \"django.contrib.sessions\",",
            "    \"django.contrib.sites\",",
            ")",
            "",
            "# ADDITONAL_APPS: We import any settings.py from apps. This allows them to",
            "# modify settings.",
            "# We're also processing any CUSTOM_SETTINGS_MAPPINGS defined there.",
            "for app in ADDITIONAL_APPS:  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "    # Previously the app was added to INSTALLED_APPS as 'omeroweb.app', which",
            "    # then required the app to reside within or be symlinked from within",
            "    # omeroweb, instead of just having to be somewhere on the python path.",
            "    # To allow apps to just be on the path, but keep it backwards compatible,",
            "    # try to import as omeroweb.app, if it works, keep that in INSTALLED_APPS,",
            "    # otherwise add it to INSTALLED_APPS just with its own name.",
            "    try:",
            "        __import__(\"omeroweb.%s\" % app)",
            "        INSTALLED_APPS += (\"omeroweb.%s\" % app,)",
            "    except ImportError:",
            "        INSTALLED_APPS += (app,)",
            "    try:",
            "        logger.debug(\"Attempting to import additional app settings for app: %s\" % app)",
            "        module = __import__(\"%s.settings\" % app)",
            "        process_custom_settings(module.settings)",
            "        report_settings(module.settings)",
            "    except ImportError:",
            "        logger.debug(\"Couldn't import settings from app: %s\" % app)",
            "",
            "INSTALLED_APPS += (",
            "    \"omeroweb.feedback\",",
            "    \"omeroweb.webadmin\",",
            "    \"omeroweb.webclient\",",
            "    \"omeroweb.webgateway\",",
            "    \"omeroweb.webredirect\",",
            "    \"omeroweb.api\",",
            "    \"pipeline\",",
            ")",
            "",
            "logger.debug(\"INSTALLED_APPS=%s\" % [INSTALLED_APPS])",
            "",
            "",
            "PIPELINE = {",
            "    \"STYLESHEETS\": {",
            "        \"webgateway_viewer\": {",
            "            \"source_filenames\": (",
            "                \"webgateway/css/reset.css\",",
            "                \"webgateway/css/ome.body.css\",",
            "                \"webclient/css/dusty.css\",",
            "                \"webgateway/css/ome.viewport.css\",",
            "                \"webgateway/css/ome.toolbar.css\",",
            "                \"webgateway/css/ome.gs_slider.css\",",
            "                \"webgateway/css/base.css\",",
            "                \"webgateway/css/ome.snippet_header_logo.css\",",
            "                \"webgateway/css/ome.postit.css\",",
            "                \"3rdparty/farbtastic-1.2/farbtastic.css\",",
            "                \"webgateway/css/ome.colorbtn.css\",",
            "                \"3rdparty/JQuerySpinBtn-1.3a/JQuerySpinBtn.css\",",
            "                \"3rdparty/jquery-ui-1.10.4/themes/base/jquery-ui.all.css\",",
            "                \"webgateway/css/omero_image.css\",",
            "                \"3rdparty/panojs-2.0.0/panojs.css\",",
            "            ),",
            "            \"output_filename\": \"omeroweb.viewer.min.css\",",
            "        },",
            "    },",
            "    \"CSS_COMPRESSOR\": \"pipeline.compressors.NoopCompressor\",",
            "    \"JS_COMPRESSOR\": \"pipeline.compressors.NoopCompressor\",",
            "    \"JAVASCRIPT\": {",
            "        \"webgateway_viewer\": {",
            "            \"source_filenames\": (",
            "                \"3rdparty/jquery-1.11.1.js\",",
            "                \"3rdparty/jquery-migrate-1.2.1.js\",",
            "                \"3rdparty/jquery-ui-1.10.4/js/jquery-ui.1.10.4.js\",",
            "                \"webgateway/js/ome.popup.js\",",
            "                \"3rdparty/aop-1.3.js\",",
            "                \"3rdparty/raphael-2.1.0/raphael.js\",",
            "                \"3rdparty/raphael-2.1.0/scale.raphael.js\",",
            "                \"3rdparty/panojs-2.0.0/utils.js\",",
            "                \"3rdparty/panojs-2.0.0/PanoJS.js\",",
            "                \"3rdparty/panojs-2.0.0/controls.js\",",
            "                \"3rdparty/panojs-2.0.0/pyramid_Bisque.js\",",
            "                \"3rdparty/panojs-2.0.0/pyramid_imgcnv.js\",",
            "                \"3rdparty/panojs-2.0.0/pyramid_Zoomify.js\",",
            "                \"3rdparty/panojs-2.0.0/control_thumbnail.js\",",
            "                \"3rdparty/panojs-2.0.0/control_info.js\",",
            "                \"3rdparty/panojs-2.0.0/control_svg.js\",",
            "                \"3rdparty/panojs-2.0.0/control_roi.js\",",
            "                \"3rdparty/panojs-2.0.0/control_scalebar.js\",",
            "                \"3rdparty/hammer-2.0.2/hammer.min.js\",",
            "                \"webgateway/js/ome.gs_utils.js\",",
            "                \"webgateway/js/ome.viewportImage.js\",",
            "                \"webgateway/js/ome.gs_slider.js\",",
            "                \"webgateway/js/ome.viewport.js\",",
            "                \"webgateway/js/omero_image.js\",",
            "                \"webgateway/js/ome.roidisplay.js\",",
            "                \"webgateway/js/ome.scalebardisplay.js\",",
            "                \"webgateway/js/ome.smartdialog.js\",",
            "                \"webgateway/js/ome.roiutils.js\",",
            "                \"3rdparty/JQuerySpinBtn-1.3a/JQuerySpinBtn.js\",",
            "                \"webgateway/js/ome.colorbtn.js\",",
            "                \"webgateway/js/ome.postit.js\",",
            "                \"3rdparty/jquery.selectboxes-2.2.6.js\",",
            "                \"3rdparty/farbtastic-1.2/farbtastic.js\",",
            "                \"3rdparty/jquery.mousewheel-3.0.6.js\",",
            "            ),",
            "            \"output_filename\": \"omeroweb.viewer.min.js\",",
            "        }",
            "    },",
            "}",
            "",
            "# Prevent scripting attacks from obtaining session cookie",
            "SESSION_COOKIE_HTTPONLY = True",
            "",
            "CSRF_FAILURE_VIEW = \"omeroweb.feedback.views.csrf_failure\"",
            "",
            "# Configuration for django-cors-headers app",
            "# See https://github.com/ottoyiu/django-cors-headers",
            "# Configration of allowed origins is handled by custom settings above",
            "CORS_ALLOW_CREDENTIALS = True",
            "# Needed for Django <1.9 since CSRF_TRUSTED_ORIGINS not supported",
            "CORS_REPLACE_HTTPS_REFERER = True",
            "",
            "# FEEDBACK - DO NOT MODIFY!",
            "# FEEDBACK_URL: Is now configurable for testing purpuse only. Used in",
            "# feedback.sendfeedback.SendFeedback class in order to submit errors or",
            "# comment messages to http://qa.openmicroscopy.org.uk.",
            "# FEEDBACK_APP: 6 = OMERO.web",
            "FEEDBACK_APP = 6",
            "",
            "# IGNORABLE_404_STARTS:",
            "# Default: ('/cgi-bin/', '/_vti_bin', '/_vti_inf')",
            "# IGNORABLE_404_ENDS:",
            "# Default: ('mail.pl', 'mailform.pl', 'mail.cgi', 'mailform.cgi',",
            "# 'favicon.ico', '.php')",
            "",
            "# SESSION_FILE_PATH: If you're using file-based session storage, this sets the",
            "# directory in which Django will store session data. When the default value",
            "# (None) is used, Django will use the standard temporary directory for the",
            "# system.",
            "SESSION_FILE_PATH = tempfile.gettempdir()",
            "",
            "# FILE_UPLOAD_TEMP_DIR: The directory to store data temporarily while",
            "# uploading files.",
            "FILE_UPLOAD_TEMP_DIR = tempfile.gettempdir()",
            "",
            "# # FILE_UPLOAD_MAX_MEMORY_SIZE: The maximum size (in bytes) that an upload",
            "# will be before it gets streamed to the file system.",
            "FILE_UPLOAD_MAX_MEMORY_SIZE = 2621440  # default 2621440 (i.e. 2.5 MB).",
            "",
            "# DEFAULT_IMG: Used in",
            "# webclient.webclient_gateway.OmeroWebGateway.defaultThumbnail in order to",
            "# load default image while thumbnail can't be retrieved from the server.",
            "DEFAULT_IMG = os.path.join(",
            "    os.path.dirname(__file__),",
            "    \"webgateway\",",
            "    \"static\",",
            "    \"webgateway\",",
            "    \"img\",",
            "    \"image128.png\",",
            ").replace(\"\\\\\", \"/\")",
            "",
            "# # DEFAULT_USER: Used in",
            "# webclient.webclient_gateway.OmeroWebGateway.getExperimenterDefaultPhoto in",
            "# order to load default avatar while experimenter photo can't be retrieved",
            "# from the server.",
            "DEFAULT_USER = os.path.join(",
            "    os.path.dirname(__file__),",
            "    \"webgateway\",",
            "    \"static\",",
            "    \"webgateway\",",
            "    \"img\",",
            "    \"personal32.png\",",
            ").replace(\"\\\\\", \"/\")",
            "",
            "# MANAGERS: A tuple in the same format as ADMINS that specifies who should get",
            "# broken-link notifications when",
            "# SEND_BROKEN_LINK_EMAILS=True.",
            "MANAGERS = ADMINS  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "",
            "# https://docs.djangoproject.com/en/1.6/releases/1.6/#default-session-serialization-switched-to-json",
            "# JSON serializer, which is now the default, cannot handle",
            "# omeroweb.connector.Connector object",
            "SESSION_SERIALIZER = \"django.contrib.sessions.serializers.PickleSerializer\"",
            "",
            "# Load custom settings from etc/grid/config.xml",
            "# Tue  2 Nov 2010 11:03:18 GMT -- ticket:3228",
            "# MIDDLEWARE: A tuple of middleware classes to use.",
            "MIDDLEWARE = sort_properties_to_tuple(MIDDLEWARE_CLASSES_LIST)  # noqa",
            "",
            "for k, v in DJANGO_ADDITIONAL_SETTINGS:  # noqa",
            "    setattr(sys.modules[__name__], k, v)",
            "",
            "",
            "# Load server list and freeze",
            "def load_server_list():",
            "    for s in SERVER_LIST:  # from CUSTOM_SETTINGS_MAPPINGS  # noqa",
            "        server = (len(s) > 2) and text(s[2]) or None",
            "        Server(host=text(s[0]), port=int(s[1]), server=server)",
            "    Server.freeze()",
            "",
            "",
            "load_server_list()"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": []
    },
    "omeroweb/webclient/decorators.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " from omeroweb.webclient.forms import GlobalSearchForm"
            },
            "2": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " from omeroweb.utils import reverse_with_params"
            },
            "3": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from omeroweb.webgateway.marshal import eventContextMarshal"
            },
            "4": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " logger = logging.getLogger(__name__)"
            },
            "6": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 115,
                "PatchRowcode": "         context."
            },
            "8": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 116,
                "PatchRowcode": "         \"\"\""
            },
            "9": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 117,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 118,
                "PatchRowcode": "+        super(render_response, self).prepare_context(request, context, *args, **kwargs)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 119,
                "PatchRowcode": "+"
            },
            "12": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 120,
                "PatchRowcode": "         # we expect @login_required to pass us 'conn', but just in case..."
            },
            "13": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 121,
                "PatchRowcode": "         if \"conn\" not in kwargs:"
            },
            "14": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 122,
                "PatchRowcode": "             return"
            },
            "15": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 135,
                "PatchRowcode": "         public_user = omeroweb.decorators.is_public_user(request)"
            },
            "16": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 136,
                "PatchRowcode": "         if public_user is not None:"
            },
            "17": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "             context[\"ome\"][\"is_public_user\"] = public_user"
            },
            "18": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        context[\"ome\"][\"eventContext\"] = eventContextMarshal(conn.getEventContext())"
            },
            "19": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": 138,
                "PatchRowcode": "         context[\"ome\"][\"user\"] = conn.getUser"
            },
            "20": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 139,
                "PatchRowcode": "         context[\"ome\"][\"user_id\"] = request.session.get(\"user_id\", conn.getUserId())"
            },
            "21": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": 140,
                "PatchRowcode": "         context[\"ome\"][\"group_id\"] = request.session.get(\"group_id\", None)"
            }
        },
        "frontPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "",
            "#",
            "# Copyright (C) 2011 University of Dundee & Open Microscopy Environment.",
            "# All rights reserved.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "",
            "\"\"\"",
            "Decorators for use with the webclient application.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "import omeroweb.decorators",
            "from omero import constants",
            "",
            "from django.http import HttpResponse",
            "from django.conf import settings",
            "from django.core.urlresolvers import reverse",
            "from django.core.urlresolvers import NoReverseMatch",
            "",
            "from omeroweb.webclient.forms import GlobalSearchForm",
            "from omeroweb.utils import reverse_with_params",
            "from omeroweb.webgateway.marshal import eventContextMarshal",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class login_required(omeroweb.decorators.login_required):",
            "    \"\"\"",
            "    webclient specific extension of the OMERO.web login_required() decorator.",
            "    \"\"\"",
            "",
            "    def __init__(",
            "        self,",
            "        ignore_login_fail=False,",
            "        setGroupContext=False,",
            "        login_redirect=None,",
            "        **kwargs",
            "    ):",
            "        \"\"\"",
            "        Initialises the decorator.",
            "        \"\"\"",
            "        super(login_required, self).__init__(**kwargs)",
            "        self.ignore_login_fail = ignore_login_fail",
            "        self.setGroupContext = setGroupContext",
            "        self.login_redirect = login_redirect",
            "",
            "    def on_logged_in(self, request, conn):",
            "        \"\"\"Called whenever the users is successfully logged in.\"\"\"",
            "        super(login_required, self).on_logged_in(request, conn)",
            "        self.prepare_session(request)",
            "        if self.setGroupContext:",
            "            if request.session.get(\"active_group\"):",
            "                conn.SERVICE_OPTS.setOmeroGroup(request.session.get(\"active_group\"))",
            "            else:",
            "                conn.SERVICE_OPTS.setOmeroGroup(conn.getEventContext().groupId)",
            "",
            "    def on_not_logged_in(self, request, url, error=None):",
            "        \"\"\"",
            "        This can be used to fail silently (not return 403, 500 etc. E.g.",
            "        keepalive ping)",
            "        \"\"\"",
            "        if self.ignore_login_fail:",
            "            return HttpResponse(\"Connection Failed\")",
            "        if self.login_redirect is not None:",
            "            try:",
            "                url = reverse(self.login_redirect)",
            "            except Exception:",
            "                pass",
            "        return super(login_required, self).on_not_logged_in(request, url, error)",
            "",
            "    def prepare_session(self, request):",
            "        \"\"\"Prepares various session variables.\"\"\"",
            "        changes = False",
            "        if request.session.get(\"callback\") is None:",
            "            request.session[\"callback\"] = dict()",
            "            changes = True",
            "        if request.session.get(\"shares\") is None:",
            "            request.session[\"shares\"] = dict()",
            "            changes = True",
            "        if changes:",
            "            request.session.modified = True",
            "",
            "",
            "class render_response(omeroweb.decorators.render_response):",
            "    \"\"\"",
            "    Subclass for adding additional data to the 'context' dict passed to",
            "    templates",
            "    \"\"\"",
            "",
            "    def prepare_context(self, request, context, *args, **kwargs):",
            "        \"\"\"",
            "        This allows templates to access the current eventContext and user from",
            "        the L{omero.gateway.BlitzGateway}.",
            "        E.g. <h1>{{ ome.user.getFullName }}</h1>",
            "        If these are not required by the template, then they will not need to",
            "        be loaded by the Blitz Gateway.",
            "        The results are cached by Blitz Gateway, so repeated calls have no",
            "        additional cost.",
            "        We also process some values from settings and add these to the",
            "        context.",
            "        \"\"\"",
            "",
            "        # we expect @login_required to pass us 'conn', but just in case...",
            "        if \"conn\" not in kwargs:",
            "            return",
            "        conn = kwargs[\"conn\"]",
            "",
            "        # omero constants",
            "        context[\"omero\"] = {",
            "            \"constants\": {",
            "                \"NSCOMPANIONFILE\": constants.namespaces.NSCOMPANIONFILE,",
            "                \"ORIGINALMETADATA\": constants.annotation.file.ORIGINALMETADATA,",
            "                \"NSCLIENTMAPANNOTATION\": constants.metadata.NSCLIENTMAPANNOTATION,",
            "            }",
            "        }",
            "",
            "        context.setdefault(\"ome\", {})  # don't overwrite existing ome",
            "        public_user = omeroweb.decorators.is_public_user(request)",
            "        if public_user is not None:",
            "            context[\"ome\"][\"is_public_user\"] = public_user",
            "        context[\"ome\"][\"eventContext\"] = eventContextMarshal(conn.getEventContext())",
            "        context[\"ome\"][\"user\"] = conn.getUser",
            "        context[\"ome\"][\"user_id\"] = request.session.get(\"user_id\", conn.getUserId())",
            "        context[\"ome\"][\"group_id\"] = request.session.get(\"group_id\", None)",
            "        context[\"ome\"][\"active_group\"] = request.session.get(",
            "            \"active_group\", conn.getEventContext().groupId",
            "        )",
            "        context[\"global_search_form\"] = GlobalSearchForm()",
            "        context[\"ome\"][\"can_create\"] = request.session.get(\"can_create\", True)",
            "        # UI server preferences",
            "        if request.session.get(\"server_settings\"):",
            "            context[\"ome\"][\"email\"] = request.session.get(\"server_settings\").get(",
            "                \"email\", False",
            "            )",
            "            if request.session.get(\"server_settings\").get(\"ui\"):",
            "                # don't overwrite existing ui",
            "                context.setdefault(\"ui\", {\"tree\": {}})",
            "                context[\"ui\"][\"orphans\"] = (",
            "                    request.session.get(\"server_settings\")",
            "                    .get(\"ui\", {})",
            "                    .get(\"tree\", {})",
            "                    .get(\"orphans\")",
            "                )",
            "                context[\"ui\"][\"dropdown_menu\"] = (",
            "                    request.session.get(\"server_settings\")",
            "                    .get(\"ui\", {})",
            "                    .get(\"menu\", {})",
            "                    .get(\"dropdown\")",
            "                )",
            "                context[\"ui\"][\"tree\"][\"type_order\"] = (",
            "                    request.session.get(\"server_settings\")",
            "                    .get(\"ui\", {})",
            "                    .get(\"tree\", {})",
            "                    .get(\"type_order\")",
            "                )",
            "",
            "        self.load_settings(request, context, conn)",
            "",
            "    def load_settings(self, request, context, conn):",
            "",
            "        # Process various settings and add to the template context dict",
            "        ping_interval = settings.PING_INTERVAL",
            "        if ping_interval > 0:",
            "            context[\"ping_interval\"] = ping_interval",
            "",
            "        top_links = settings.TOP_LINKS",
            "        links = []",
            "        for tl in top_links:",
            "            if len(tl) < 2:",
            "                continue",
            "            link = {}",
            "            link[\"label\"] = tl[0]",
            "            link_id = tl[1]",
            "            try:",
            "                # test if complex dictionary view with args and query_string",
            "                link[\"link\"] = reverse_with_params(**link_id)",
            "            except TypeError:",
            "                # assume is only view name",
            "                try:",
            "                    link[\"link\"] = reverse(link_id)",
            "                except NoReverseMatch:",
            "                    # assume we've been passed a url",
            "                    link[\"link\"] = link_id",
            "            # simply add optional attrs dict",
            "            if len(tl) > 2:",
            "                link[\"attrs\"] = tl[2]",
            "            links.append(link)",
            "        context[\"ome\"][\"top_links\"] = links",
            "",
            "        if settings.TOP_LOGO:",
            "            context[\"ome\"][\"logo_src\"] = settings.TOP_LOGO",
            "        if settings.TOP_LOGO_LINK:",
            "            context[\"ome\"][\"logo_href\"] = settings.TOP_LOGO_LINK",
            "",
            "        metadata_panes = settings.METADATA_PANES",
            "        context[\"ome\"][\"metadata_panes\"] = metadata_panes",
            "",
            "        right_plugins = settings.RIGHT_PLUGINS",
            "        r_plugins = []",
            "        for rt in right_plugins:",
            "            label = rt[0]",
            "            include = rt[1]",
            "            plugin_id = rt[2]",
            "            r_plugins.append(",
            "                {\"label\": label, \"include\": include, \"plugin_id\": plugin_id}",
            "            )",
            "        context[\"ome\"][\"right_plugins\"] = r_plugins",
            "",
            "        center_plugins = settings.CENTER_PLUGINS",
            "        c_plugins = []",
            "        for cp in center_plugins:",
            "            label = cp[0]",
            "            include = cp[1]",
            "            plugin_id = cp[2]",
            "            c_plugins.append(",
            "                {\"label\": label, \"include\": include, \"plugin_id\": plugin_id}",
            "            )",
            "        context[\"ome\"][\"center_plugins\"] = c_plugins",
            "",
            "        context[\"ome\"][\"user_dropdown\"] = settings.USER_DROPDOWN"
        ],
        "afterPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "",
            "#",
            "# Copyright (C) 2011 University of Dundee & Open Microscopy Environment.",
            "# All rights reserved.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "",
            "\"\"\"",
            "Decorators for use with the webclient application.",
            "\"\"\"",
            "",
            "import logging",
            "",
            "import omeroweb.decorators",
            "from omero import constants",
            "",
            "from django.http import HttpResponse",
            "from django.conf import settings",
            "from django.core.urlresolvers import reverse",
            "from django.core.urlresolvers import NoReverseMatch",
            "",
            "from omeroweb.webclient.forms import GlobalSearchForm",
            "from omeroweb.utils import reverse_with_params",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class login_required(omeroweb.decorators.login_required):",
            "    \"\"\"",
            "    webclient specific extension of the OMERO.web login_required() decorator.",
            "    \"\"\"",
            "",
            "    def __init__(",
            "        self,",
            "        ignore_login_fail=False,",
            "        setGroupContext=False,",
            "        login_redirect=None,",
            "        **kwargs",
            "    ):",
            "        \"\"\"",
            "        Initialises the decorator.",
            "        \"\"\"",
            "        super(login_required, self).__init__(**kwargs)",
            "        self.ignore_login_fail = ignore_login_fail",
            "        self.setGroupContext = setGroupContext",
            "        self.login_redirect = login_redirect",
            "",
            "    def on_logged_in(self, request, conn):",
            "        \"\"\"Called whenever the users is successfully logged in.\"\"\"",
            "        super(login_required, self).on_logged_in(request, conn)",
            "        self.prepare_session(request)",
            "        if self.setGroupContext:",
            "            if request.session.get(\"active_group\"):",
            "                conn.SERVICE_OPTS.setOmeroGroup(request.session.get(\"active_group\"))",
            "            else:",
            "                conn.SERVICE_OPTS.setOmeroGroup(conn.getEventContext().groupId)",
            "",
            "    def on_not_logged_in(self, request, url, error=None):",
            "        \"\"\"",
            "        This can be used to fail silently (not return 403, 500 etc. E.g.",
            "        keepalive ping)",
            "        \"\"\"",
            "        if self.ignore_login_fail:",
            "            return HttpResponse(\"Connection Failed\")",
            "        if self.login_redirect is not None:",
            "            try:",
            "                url = reverse(self.login_redirect)",
            "            except Exception:",
            "                pass",
            "        return super(login_required, self).on_not_logged_in(request, url, error)",
            "",
            "    def prepare_session(self, request):",
            "        \"\"\"Prepares various session variables.\"\"\"",
            "        changes = False",
            "        if request.session.get(\"callback\") is None:",
            "            request.session[\"callback\"] = dict()",
            "            changes = True",
            "        if request.session.get(\"shares\") is None:",
            "            request.session[\"shares\"] = dict()",
            "            changes = True",
            "        if changes:",
            "            request.session.modified = True",
            "",
            "",
            "class render_response(omeroweb.decorators.render_response):",
            "    \"\"\"",
            "    Subclass for adding additional data to the 'context' dict passed to",
            "    templates",
            "    \"\"\"",
            "",
            "    def prepare_context(self, request, context, *args, **kwargs):",
            "        \"\"\"",
            "        This allows templates to access the current eventContext and user from",
            "        the L{omero.gateway.BlitzGateway}.",
            "        E.g. <h1>{{ ome.user.getFullName }}</h1>",
            "        If these are not required by the template, then they will not need to",
            "        be loaded by the Blitz Gateway.",
            "        The results are cached by Blitz Gateway, so repeated calls have no",
            "        additional cost.",
            "        We also process some values from settings and add these to the",
            "        context.",
            "        \"\"\"",
            "",
            "        super(render_response, self).prepare_context(request, context, *args, **kwargs)",
            "",
            "        # we expect @login_required to pass us 'conn', but just in case...",
            "        if \"conn\" not in kwargs:",
            "            return",
            "        conn = kwargs[\"conn\"]",
            "",
            "        # omero constants",
            "        context[\"omero\"] = {",
            "            \"constants\": {",
            "                \"NSCOMPANIONFILE\": constants.namespaces.NSCOMPANIONFILE,",
            "                \"ORIGINALMETADATA\": constants.annotation.file.ORIGINALMETADATA,",
            "                \"NSCLIENTMAPANNOTATION\": constants.metadata.NSCLIENTMAPANNOTATION,",
            "            }",
            "        }",
            "",
            "        context.setdefault(\"ome\", {})  # don't overwrite existing ome",
            "        public_user = omeroweb.decorators.is_public_user(request)",
            "        if public_user is not None:",
            "            context[\"ome\"][\"is_public_user\"] = public_user",
            "        context[\"ome\"][\"user\"] = conn.getUser",
            "        context[\"ome\"][\"user_id\"] = request.session.get(\"user_id\", conn.getUserId())",
            "        context[\"ome\"][\"group_id\"] = request.session.get(\"group_id\", None)",
            "        context[\"ome\"][\"active_group\"] = request.session.get(",
            "            \"active_group\", conn.getEventContext().groupId",
            "        )",
            "        context[\"global_search_form\"] = GlobalSearchForm()",
            "        context[\"ome\"][\"can_create\"] = request.session.get(\"can_create\", True)",
            "        # UI server preferences",
            "        if request.session.get(\"server_settings\"):",
            "            context[\"ome\"][\"email\"] = request.session.get(\"server_settings\").get(",
            "                \"email\", False",
            "            )",
            "            if request.session.get(\"server_settings\").get(\"ui\"):",
            "                # don't overwrite existing ui",
            "                context.setdefault(\"ui\", {\"tree\": {}})",
            "                context[\"ui\"][\"orphans\"] = (",
            "                    request.session.get(\"server_settings\")",
            "                    .get(\"ui\", {})",
            "                    .get(\"tree\", {})",
            "                    .get(\"orphans\")",
            "                )",
            "                context[\"ui\"][\"dropdown_menu\"] = (",
            "                    request.session.get(\"server_settings\")",
            "                    .get(\"ui\", {})",
            "                    .get(\"menu\", {})",
            "                    .get(\"dropdown\")",
            "                )",
            "                context[\"ui\"][\"tree\"][\"type_order\"] = (",
            "                    request.session.get(\"server_settings\")",
            "                    .get(\"ui\", {})",
            "                    .get(\"tree\", {})",
            "                    .get(\"type_order\")",
            "                )",
            "",
            "        self.load_settings(request, context, conn)",
            "",
            "    def load_settings(self, request, context, conn):",
            "",
            "        # Process various settings and add to the template context dict",
            "        ping_interval = settings.PING_INTERVAL",
            "        if ping_interval > 0:",
            "            context[\"ping_interval\"] = ping_interval",
            "",
            "        top_links = settings.TOP_LINKS",
            "        links = []",
            "        for tl in top_links:",
            "            if len(tl) < 2:",
            "                continue",
            "            link = {}",
            "            link[\"label\"] = tl[0]",
            "            link_id = tl[1]",
            "            try:",
            "                # test if complex dictionary view with args and query_string",
            "                link[\"link\"] = reverse_with_params(**link_id)",
            "            except TypeError:",
            "                # assume is only view name",
            "                try:",
            "                    link[\"link\"] = reverse(link_id)",
            "                except NoReverseMatch:",
            "                    # assume we've been passed a url",
            "                    link[\"link\"] = link_id",
            "            # simply add optional attrs dict",
            "            if len(tl) > 2:",
            "                link[\"attrs\"] = tl[2]",
            "            links.append(link)",
            "        context[\"ome\"][\"top_links\"] = links",
            "",
            "        if settings.TOP_LOGO:",
            "            context[\"ome\"][\"logo_src\"] = settings.TOP_LOGO",
            "        if settings.TOP_LOGO_LINK:",
            "            context[\"ome\"][\"logo_href\"] = settings.TOP_LOGO_LINK",
            "",
            "        metadata_panes = settings.METADATA_PANES",
            "        context[\"ome\"][\"metadata_panes\"] = metadata_panes",
            "",
            "        right_plugins = settings.RIGHT_PLUGINS",
            "        r_plugins = []",
            "        for rt in right_plugins:",
            "            label = rt[0]",
            "            include = rt[1]",
            "            plugin_id = rt[2]",
            "            r_plugins.append(",
            "                {\"label\": label, \"include\": include, \"plugin_id\": plugin_id}",
            "            )",
            "        context[\"ome\"][\"right_plugins\"] = r_plugins",
            "",
            "        center_plugins = settings.CENTER_PLUGINS",
            "        c_plugins = []",
            "        for cp in center_plugins:",
            "            label = cp[0]",
            "            include = cp[1]",
            "            plugin_id = cp[2]",
            "            c_plugins.append(",
            "                {\"label\": label, \"include\": include, \"plugin_id\": plugin_id}",
            "            )",
            "        context[\"ome\"][\"center_plugins\"] = c_plugins",
            "",
            "        context[\"ome\"][\"user_dropdown\"] = settings.USER_DROPDOWN"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "38": [],
            "137": [
                "render_response",
                "prepare_context"
            ]
        },
        "addLocation": []
    },
    "omeroweb/webclient/forms.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " from .custom_forms import AnnotationModelMultipleChoiceField"
            },
            "1": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " from .custom_forms import ObjectModelMultipleChoiceField"
            },
            "2": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " from omeroweb.webadmin.custom_forms import ExperimenterModelMultipleChoiceField"
            },
            "3": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from omeroweb.webadmin.custom_forms import GroupModelMultipleChoiceField"
            },
            "4": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " from omeroweb.webadmin.custom_forms import GroupModelChoiceField"
            },
            "5": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 41,
                "PatchRowcode": " from omeroweb.webclient.webclient_utils import formatPercentFraction"
            },
            "6": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 42,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "         return self.cleaned_data[\"expiration\"]"
            },
            "8": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 127,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 128,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class BasketShareForm(ShareForm):"
            },
            "11": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def __init__(self, *args, **kwargs):"
            },
            "12": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        super(BasketShareForm, self).__init__(*args, **kwargs)"
            },
            "13": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "14": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        try:"
            },
            "15": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.fields[\"image\"] = GroupModelMultipleChoiceField("
            },
            "16": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                queryset=kwargs[\"initial\"][\"images\"],"
            },
            "17": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                initial=kwargs[\"initial\"][\"selected\"],"
            },
            "18": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                widget=forms.SelectMultiple(attrs={\"size\": 10}),"
            },
            "19": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            )"
            },
            "20": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        except Exception:"
            },
            "21": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.fields[\"image\"] = GroupModelMultipleChoiceField("
            },
            "22": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                queryset=kwargs[\"initial\"][\"images\"],"
            },
            "23": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                widget=forms.SelectMultiple(attrs={\"size\": 10}),"
            },
            "24": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            )"
            },
            "25": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "26": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "27": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 129,
                "PatchRowcode": " class ContainerForm(NonASCIIForm):"
            },
            "28": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": 130,
                "PatchRowcode": " "
            },
            "29": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": 131,
                "PatchRowcode": "     name = forms.CharField(max_length=250, widget=forms.TextInput(attrs={\"size\": 45}))"
            }
        },
        "frontPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "#",
            "#",
            "#",
            "# Copyright (c) 2008-2015 University of Dundee.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "# Author: Aleksandra Tarkowska <A(dot)Tarkowska(at)dundee(dot)ac(dot)uk>, 2008.",
            "#",
            "# Version: 1.0",
            "#",
            "",
            "import datetime",
            "import time",
            "import logging",
            "",
            "from django.conf import settings",
            "from django import forms",
            "from django.forms.formsets import formset_factory",
            "from django.core.urlresolvers import reverse",
            "",
            "from omeroweb.custom_forms import NonASCIIForm",
            "from .custom_forms import MetadataModelChoiceField",
            "from .custom_forms import AnnotationModelMultipleChoiceField",
            "from .custom_forms import ObjectModelMultipleChoiceField",
            "from omeroweb.webadmin.custom_forms import ExperimenterModelMultipleChoiceField",
            "from omeroweb.webadmin.custom_forms import GroupModelMultipleChoiceField",
            "from omeroweb.webadmin.custom_forms import GroupModelChoiceField",
            "from omeroweb.webclient.webclient_utils import formatPercentFraction",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "##################################################################",
            "# Static values",
            "",
            "# TODO: change to reverse",
            "help_button = \"%swebgateway/img/help16.png\" % settings.STATIC_URL",
            "",
            "help_enable = (",
            "    '<span class=\"tooltip\" title=\"Enable/Disable: This option'",
            "    ' allows the owner to keep the access control of the share.\">'",
            "    '<img src=\"%s\" /></span>'",
            ") % help_button",
            "",
            "help_expire = (",
            "    '<span class=\"tooltip\" title=\"Expiry date: This date defines'",
            "    \" when the share will stop being available. Date format:\"",
            "    ' YYYY-MM-DD.\"><img src=\"%s\" /></span>'",
            ") % help_button",
            "",
            "",
            "#################################################################",
            "# Non-model Form",
            "",
            "",
            "class GlobalSearchForm(NonASCIIForm):",
            "",
            "    search_query = forms.CharField(widget=forms.TextInput(attrs={\"size\": 25}))",
            "",
            "",
            "class ShareForm(NonASCIIForm):",
            "    def __init__(self, *args, **kwargs):",
            "        super(ShareForm, self).__init__(*args, **kwargs)",
            "",
            "        try:",
            "            if kwargs[\"initial\"][\"shareMembers\"]:",
            "                pass",
            "            self.fields[\"members\"] = ExperimenterModelMultipleChoiceField(",
            "                queryset=kwargs[\"initial\"][\"experimenters\"],",
            "                initial=kwargs[\"initial\"][\"shareMembers\"],",
            "                widget=forms.SelectMultiple(attrs={\"size\": 28}),",
            "            )",
            "        except Exception:",
            "            self.fields[\"members\"] = ExperimenterModelMultipleChoiceField(",
            "                queryset=kwargs[\"initial\"][\"experimenters\"],",
            "                widget=forms.SelectMultiple(attrs={\"size\": 28}),",
            "            )",
            "        self.fields.keyOrder = [",
            "            \"message\",",
            "            \"expiration\",",
            "            \"enable\",",
            "            \"members\",",
            "        ]  # , 'guests']",
            "",
            "    message = forms.CharField(widget=forms.Textarea(attrs={\"rows\": 5, \"cols\": 50}))",
            "    expiration = forms.CharField(",
            "        max_length=100,",
            "        widget=forms.TextInput(attrs={\"size\": 10}),",
            "        label=\"Expiry date\",",
            "        help_text=help_expire,",
            "        required=False,",
            "    )",
            "    enable = forms.BooleanField(required=False, help_text=help_enable)",
            "    # guests = MultiEmailField(required=False,",
            "    # widget=forms.TextInput(attrs={'size':75}))",
            "",
            "    def clean_expiration(self):",
            "        if (",
            "            self.cleaned_data[\"expiration\"] is not None",
            "            and len(self.cleaned_data[\"expiration\"]) < 1",
            "        ):",
            "            return None",
            "        if self.cleaned_data[\"expiration\"] is not None:",
            "            d = str(self.cleaned_data[\"expiration\"]).rsplit(\"-\")",
            "            try:",
            "                date = datetime.datetime.strptime(",
            "                    (\"%s-%s-%s\" % (d[0], d[1], d[2])), \"%Y-%m-%d\"",
            "                )",
            "            except Exception:",
            "                raise forms.ValidationError(\"Date is in the wrong format. YY-MM-DD\")",
            "            if time.mktime(date.timetuple()) <= time.time():",
            "                raise forms.ValidationError(\"Expiry date must be in the future.\")",
            "        return self.cleaned_data[\"expiration\"]",
            "",
            "",
            "class BasketShareForm(ShareForm):",
            "    def __init__(self, *args, **kwargs):",
            "        super(BasketShareForm, self).__init__(*args, **kwargs)",
            "",
            "        try:",
            "            self.fields[\"image\"] = GroupModelMultipleChoiceField(",
            "                queryset=kwargs[\"initial\"][\"images\"],",
            "                initial=kwargs[\"initial\"][\"selected\"],",
            "                widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "            )",
            "        except Exception:",
            "            self.fields[\"image\"] = GroupModelMultipleChoiceField(",
            "                queryset=kwargs[\"initial\"][\"images\"],",
            "                widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "            )",
            "",
            "",
            "class ContainerForm(NonASCIIForm):",
            "",
            "    name = forms.CharField(max_length=250, widget=forms.TextInput(attrs={\"size\": 45}))",
            "    description = forms.CharField(",
            "        widget=forms.Textarea(attrs={\"rows\": 2, \"cols\": 49}), required=False",
            "    )",
            "    owner = forms.CharField(widget=forms.HiddenInput, required=False)",
            "",
            "",
            "class ContainerNameForm(NonASCIIForm):",
            "",
            "    name = forms.CharField(max_length=250, widget=forms.TextInput(attrs={\"size\": 45}))",
            "",
            "",
            "class ContainerDescriptionForm(NonASCIIForm):",
            "",
            "    description = forms.CharField(",
            "        widget=forms.Textarea(attrs={\"rows\": 3, \"cols\": 39}), required=False",
            "    )",
            "",
            "",
            "class BaseAnnotationForm(NonASCIIForm):",
            "    \"\"\"",
            "    This is the superclass of the various forms used for annotating single or",
            "    multiple objects.",
            "    All these forms use hidden fields to specify the object(s) currently being",
            "    annotated.",
            "    \"\"\"",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(BaseAnnotationForm, self).__init__(*args, **kwargs)",
            "",
            "        images = \"images\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"images\"] or list()",
            "        if len(images) > 0:",
            "            try:",
            "                self.fields[\"image\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=images,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"images\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"image\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=images,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        datasets = (",
            "            \"datasets\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"datasets\"] or list()",
            "        )",
            "        if len(datasets) > 0:",
            "            try:",
            "                self.fields[\"dataset\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=datasets,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"datasets\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"dataset\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=datasets,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        projects = (",
            "            \"projects\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"projects\"] or list()",
            "        )",
            "        if len(projects) > 0:",
            "            try:",
            "                self.fields[\"project\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=projects,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"projects\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"project\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=projects,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        screens = (",
            "            \"screens\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"screens\"] or list()",
            "        )",
            "        if len(screens) > 0:",
            "            try:",
            "                self.fields[\"screen\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=screens,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"screens\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"screen\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=screens,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        plates = \"plates\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"plates\"] or list()",
            "        if len(plates) > 0:",
            "            try:",
            "                self.fields[\"plate\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=plates,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"plates\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"plate\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=plates,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        acquisitions = (",
            "            \"acquisitions\" in kwargs[\"initial\"]",
            "            and kwargs[\"initial\"][\"acquisitions\"]",
            "            or list()",
            "        )",
            "        if len(acquisitions) > 0:",
            "            try:",
            "                self.fields[\"acquisition\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=acquisitions,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"acquisitions\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"acquisition\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=acquisitions,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        wells = \"wells\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"wells\"] or list()",
            "        if len(wells) > 0:",
            "            try:",
            "                self.fields[\"well\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=wells,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"wells\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"well\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=wells,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        shares = \"shares\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"shares\"] or list()",
            "        if len(shares) > 0:",
            "            try:",
            "                self.fields[\"share\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=shares,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"shares\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"share\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=shares,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "",
            "class TagsAnnotationForm(BaseAnnotationForm):",
            "    \"\"\"",
            "    Form for annotating one or more objects with existing Tags or New tags",
            "    \"\"\"",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(TagsAnnotationForm, self).__init__(*args, **kwargs)",
            "",
            "    tags = forms.CharField(required=False, widget=forms.HiddenInput)",
            "",
            "    def clean_tags(self):",
            "        data = self.cleaned_data[\"tags\"]",
            "        if not data:",
            "            return []",
            "        try:",
            "            data = map(int, data.split(\",\"))",
            "        except Exception:",
            "            raise forms.ValidationError()",
            "        return data",
            "",
            "",
            "class NewTagsAnnotationForm(forms.Form):",
            "    \"\"\" Helper form for new tags \"\"\"",
            "",
            "    tag = forms.CharField(required=True, widget=forms.HiddenInput)",
            "    description = forms.CharField(required=False, widget=forms.HiddenInput)",
            "    tagset = forms.IntegerField(min_value=1, required=False, widget=forms.HiddenInput)",
            "",
            "",
            "NewTagsAnnotationFormSet = formset_factory(NewTagsAnnotationForm, extra=0)",
            "",
            "",
            "class FilesAnnotationForm(BaseAnnotationForm):",
            "    def __init__(self, *args, **kwargs):",
            "        super(FilesAnnotationForm, self).__init__(*args, **kwargs)",
            "        self.fields[\"files\"] = AnnotationModelMultipleChoiceField(",
            "            queryset=kwargs[\"initial\"][\"files\"],",
            "            widget=forms.SelectMultiple(attrs={\"size\": 8, \"class\": \"existing\"}),",
            "            required=False,",
            "        )",
            "",
            "    annotation_file = forms.FileField(required=False)",
            "",
            "",
            "class CommentAnnotationForm(BaseAnnotationForm):",
            "    comment = forms.CharField(widget=forms.Textarea(attrs={\"rows\": 2, \"cols\": 39}))",
            "",
            "",
            "class ActiveGroupForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(ActiveGroupForm, self).__init__(*args, **kwargs)",
            "        try:",
            "            self.fields[\"active_group\"] = GroupModelChoiceField(",
            "                queryset=kwargs[\"initial\"][\"mygroups\"],",
            "                initial=kwargs[\"initial\"][\"activeGroup\"],",
            "                empty_label=None,",
            "                widget=forms.Select(",
            "                    attrs={",
            "                        \"onchange\": (",
            "                            \"window.location.href='\"",
            "                            + reverse(viewname=\"change_active_group\")",
            "                            + \"?url=\"",
            "                            + kwargs[\"initial\"][\"url\"]",
            "                            + \"&active_group='\"",
            "                            \"+this.options[this.selectedIndex].value\"",
            "                        )",
            "                    }",
            "                ),",
            "            )",
            "        except Exception:",
            "            self.fields[\"active_group\"] = GroupModelChoiceField(",
            "                queryset=kwargs[\"initial\"][\"mygroups\"],",
            "                initial=kwargs[\"initial\"][\"activeGroup\"],",
            "                empty_label=None,",
            "                widget=forms.Select(",
            "                    attrs={",
            "                        \"onchange\": (",
            "                            \"window.location.href='\"",
            "                            + reverse(viewname=\"change_active_group\")",
            "                            + \"?active_group='\"",
            "                            \"+this.options[this.selectedIndex].value\"",
            "                        )",
            "                    }",
            "                ),",
            "            )",
            "        self.fields.keyOrder = [\"active_group\"]",
            "",
            "",
            "class WellIndexForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(WellIndexForm, self).__init__(*args, **kwargs)",
            "        rmin, rmax = kwargs[\"initial\"][\"range\"]",
            "        choices = [(str(i), \"Field#%i\" % (i - rmin + 1)) for i in range(rmin, rmax + 1)]",
            "        self.fields[\"index\"] = forms.ChoiceField(",
            "            choices=tuple(choices),",
            "            widget=forms.Select(",
            "                attrs={",
            "                    \"onchange\": (\"changeField(this.options[this.selectedIndex].value);\")",
            "                }",
            "            ),",
            "        )",
            "        self.fields.keyOrder = [\"index\"]",
            "",
            "",
            "###############################",
            "# METADATA FORMS",
            "",
            "",
            "def save_metadata(obj, name, options=False):",
            "    s = \"javascript:save_metadata(\" + str(obj) + \", '\" + name + \"', \"",
            "    if options:",
            "        s += \"this.options[this.selectedIndex].value);\"",
            "    else:",
            "        s += \"this.value);\"",
            "",
            "    return s",
            "",
            "",
            "def set_widget_attrs(field, set_class=True):",
            "    field.widget.attrs[\"disabled\"] = True",
            "    if set_class:",
            "        field.widget.attrs[\"class\"] = \"disabled-metadata\"",
            "",
            "",
            "class MetadataChannelForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataChannelForm, self).__init__(*args, **kwargs)",
            "",
            "        # Logical channel",
            "",
            "        # Name",
            "        logicalCh = kwargs[\"initial\"][\"logicalChannel\"]",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"name\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={\"size\": 25, \"onchange\": save_metadata(logicalCh.id)}",
            "                    ),",
            "                    initial=logicalCh.name,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"name\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"name\"])",
            "        except Exception:",
            "            self.fields[\"name\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"name\"])",
            "",
            "        # excitationWave",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"excitationWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"exWave\"].getValue(),",
            "                    label=(\"Excitation (%s)\" % kwargs[\"initial\"][\"exWave\"].getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"excitationWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Excitation\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"excitationWave\"])",
            "        except Exception:",
            "            self.fields[\"excitationWave\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Excitation\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"excitationWave\"])",
            "",
            "        # emissionWave",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"emissionWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"emWave\"].getValue(),",
            "                    label=(\"Emission (%s)\" % kwargs[\"initial\"][\"emWave\"].getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"emissionWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Emission\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"emissionWave\"])",
            "        except Exception:",
            "            self.fields[\"emissionWave\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Emission\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"emissionWave\"])",
            "",
            "        # ndFilter",
            "        try:",
            "            if logicalCh is not None and logicalCh.ndFilter is not None:",
            "                self.fields[\"ndFilter\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=formatPercentFraction(logicalCh.ndFilter),",
            "                    label=\"ND filter (%)\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"ndFilter\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"ND filter (%)\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"ndFilter\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"ndFilter\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"ND filter (%)\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"ndFilter\"], set_class=False)",
            "",
            "        # pinHoleSize",
            "        try:",
            "            if logicalCh is not None and logicalCh.pinHoleSize is not None:",
            "                self.fields[\"pinHoleSize\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.pinHoleSize.getValue(),",
            "                    label=(\"Pin hole size (%s)\" % logicalCh.pinHoleSize.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pinHoleSize\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Pin hole size\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pinHoleSize\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"pinHoleSize\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Pin hole size\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pinHoleSize\"], set_class=False)",
            "",
            "        # fluor",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"fluor\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.fluor,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"fluor\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"fluor\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"fluor\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"fluor\"], set_class=False)",
            "",
            "        # Illumination",
            "        try:",
            "            if logicalCh.getIllumination() is not None:",
            "                self.fields[\"illumination\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"illuminations\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"illumination\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.getIllumination(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"illumination\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"illuminations\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"illumination\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"illumination\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"illumination\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"illumination\"], set_class=False)",
            "",
            "        # contrastMethods",
            "        try:",
            "            if logicalCh.contrastMethod is not None:",
            "                self.fields[\"contrastMethod\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"contrastMethods\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"contrastMethod\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.getContrastMethod(),",
            "                    label=\"Contrast method\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"contrastMethod\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"contrastMethods\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"contrastMethod\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Contrast method\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"contrastMethod\"])",
            "        except Exception:",
            "            self.fields[\"contrastMethod\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Contrast method\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"contrastMethod\"])",
            "",
            "        # Mode",
            "        try:",
            "            if logicalCh.getMode() is not None:",
            "                self.fields[\"mode\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"modes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"mode\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.getMode().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"mode\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"modes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"mode\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"mode\"])",
            "        except Exception:",
            "            self.fields[\"mode\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"mode\"])",
            "",
            "        # pockelCellSetting",
            "        try:",
            "            if logicalCh.pockelCellSetting is not None:",
            "                self.fields[\"pockelCellSetting\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.pockelCellSetting,",
            "                    label=\"Pockel cell\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pockelCellSetting\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Pockel cell\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pockelCellSetting\"])",
            "        except Exception:",
            "            self.fields[\"pockelCellSetting\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Pockel cell\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pockelCellSetting\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"name\",",
            "            \"excitationWave\",",
            "            \"emissionWave\",",
            "            \"ndFilter\",",
            "            \"pinHoleSize\",",
            "            \"fluor\",",
            "            \"illumination\",",
            "            \"contrastMethod\",",
            "            \"mode\",",
            "            \"pockelCellSetting\",",
            "        ]",
            "",
            "",
            "class MetadataDichroicForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataDichroicForm, self).__init__(*args, **kwargs)",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Serial number",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].serialNumber,",
            "                                \"serialNumber\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].serialNumber,",
            "                                \"serialNumber\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].lotNumber, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].lotNumber, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        self.fields.keyOrder = [\"model\", \"manufacturer\", \"serialNumber\", \"lotNumber\"]",
            "",
            "",
            "class MetadataMicroscopeForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataMicroscopeForm, self).__init__(*args, **kwargs)",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Serial number",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Type",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].getMicroscopeType() is not None:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"microscopeTypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].getMicroscopeType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"microscopeTypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "        except Exception:",
            "            self.fields[\"type\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"type\",",
            "        ]",
            "",
            "",
            "class MetadataObjectiveForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataObjectiveForm, self).__init__(*args, **kwargs)",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Serial Number",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].lotNumber, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"logicalchannel\"]",
            "                                .getObjective()",
            "                                .lotNumber,",
            "                                \"lotNumber\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Nominal Magnification",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].nominalMagnification is not None:",
            "                self.fields[\"nominalMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"nominalMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].nominalMagnification,",
            "                    label=\"Nominal magnification\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"nominalMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"nominalMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Nominal magnification\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"nominalMagnification\"])",
            "        except Exception:",
            "            self.fields[\"nominalMagnification\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Nominal magnification\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"nominalMagnification\"])",
            "",
            "        # Calibrated Magnification",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].calibratedMagnification is not None:",
            "                self.fields[\"calibratedMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"calibratedMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].calibratedMagnification,",
            "                    label=\"Calibrated magnification\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"calibratedMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"calibratedMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Calibrated magnification\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"calibratedMagnification\"])",
            "        except Exception:",
            "            self.fields[\"calibratedMagnification\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Calibrated magnification\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"calibratedMagnification\"])",
            "",
            "        # Lens NA",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].lensNA is not None:",
            "                self.fields[\"lensNA\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"lensNA\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].lensNA,",
            "                    label=\"Lens NA\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lensNA\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"lensNA\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lensNA\"])",
            "        except Exception:",
            "            self.fields[\"lensNA\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lens NA\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lensNA\"])",
            "",
            "        # Immersion",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].getImmersion() is not None:",
            "                self.fields[\"immersion\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"immersions\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"immersion\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].getImmersion().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"immersion\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"immersions\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"immersion\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"immersion\"])",
            "        except Exception:",
            "            self.fields[\"immersion\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"immersion\"])",
            "",
            "        # Correction",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].getCorrection() is not None:",
            "                self.fields[\"correction\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"corrections\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"correction\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].getCorrection().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"correction\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"corrections\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"correction\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"correction\"])",
            "",
            "        except Exception:",
            "            self.fields[\"correction\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"correction\"])",
            "",
            "        # Working Distance",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].workingDistance is not None:",
            "                self.fields[\"workingDistance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"workingDistance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].workingDistance.getValue(),",
            "                    label=(",
            "                        \"Working distance (%s)\"",
            "                        % kwargs[\"initial\"][\"objective\"].workingDistance.getSymbol()",
            "                    ),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"workingDistance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"workingDistance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Working distance\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"workingDistance\"])",
            "        except Exception:",
            "            self.fields[\"workingDistance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Working distance\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"workingDistance\"])",
            "",
            "        # Iris",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].getIris() is not None:",
            "                self.fields[\"iris\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"iris\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].getIris().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"iris\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"iris\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"iris\"])",
            "        except Exception:",
            "            self.fields[\"iris\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"iris\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"nominalMagnification\",",
            "            \"calibratedMagnification\",",
            "            \"lensNA\",",
            "            \"immersion\",",
            "            \"correction\",",
            "            \"workingDistance\",",
            "            \"iris\",",
            "        ]",
            "",
            "",
            "class MetadataObjectiveSettingsForm(MetadataObjectiveForm):",
            "",
            "    BOOLEAN_CHOICES = (",
            "        (\"\", \"---------\"),",
            "        (\"True\", \"True\"),",
            "        (\"False\", \"False\"),",
            "    )",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataObjectiveSettingsForm, self).__init__(*args, **kwargs)",
            "",
            "        # Objective Settings",
            "",
            "        # Correction Collar",
            "        try:",
            "            if kwargs[\"initial\"][\"objectiveSettings\"].correctionCollar is not None:",
            "                self.fields[\"correctionCollar\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"correctionCollar\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objectiveSettings\"].correctionCollar,",
            "                    label=\"Correction collar\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"correctionCollar\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"correctionCollar\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Correction collar\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"correctionCollar\"])",
            "        except Exception:",
            "            self.fields[\"correctionCollar\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Correction collar\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"correctionCollar\"])",
            "",
            "        # Medium",
            "        try:",
            "            if kwargs[\"initial\"][\"objectiveSettings\"].getMedium() is not None:",
            "                self.fields[\"medium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"medium\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objectiveSettings\"].getMedium().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"medium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"medium\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"medium\"])",
            "        except Exception:",
            "            self.fields[\"medium\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"medium\"])",
            "",
            "        # Refractive Index",
            "        try:",
            "            if kwargs[\"initial\"][\"objectiveSettings\"].refractiveIndex is not None:",
            "                self.fields[\"refractiveIndex\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"refractiveIndex\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objectiveSettings\"].refractiveIndex,",
            "                    label=\"Refractive index\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"refractiveIndex\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"refractiveIndex\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Refractive index\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"refractiveIndex\"])",
            "        except Exception:",
            "            self.fields[\"refractiveIndex\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Refractive index\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"refractiveIndex\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"nominalMagnification\",",
            "            \"calibratedMagnification\",",
            "            \"lensNA\",",
            "            \"immersion\",",
            "            \"correction\",",
            "            \"workingDistance\",",
            "            \"iris\",",
            "            \"correctionCollar\",",
            "            \"medium\",",
            "            \"refractiveIndex\",",
            "        ]",
            "",
            "",
            "class MetadataFilterForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataFilterForm, self).__init__(*args, **kwargs)",
            "",
            "        # Filter",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Serial Number",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Filter wheel",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].filterWheel is not None:",
            "                self.fields[\"filterWheel\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"filterWheel\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].filterWheel,",
            "                    label=\"Filter wheel\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"filterWheel\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"filterWheel\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Filter wheel\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"filterWheel\"])",
            "        except Exception:",
            "            self.fields[\"filterWheel\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Filter wheel\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"filterWheel\"])",
            "",
            "        # Type",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].getFilterType() is not None:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].getFilterType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "        except Exception:",
            "            self.fields[\"type\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "",
            "        # Cut in",
            "        tr = kwargs[\"initial\"][\"filter\"].getTransmittanceRange()",
            "        try:",
            "            if tr is not None and tr.cutIn is not None:",
            "                self.fields[\"cutIn\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutIn\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"]",
            "                    .getTransmittanceRange()",
            "                    .cutIn.getValue(),",
            "                    label=\"Cut in (%s)\" % tr.cutIn.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutIn\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutIn\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut in\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutIn\"])",
            "        except Exception:",
            "            self.fields[\"cutIn\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut in\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutIn\"])",
            "",
            "        # Cut out",
            "        try:",
            "            if tr is not None and tr.cutOut is not None:",
            "                self.fields[\"cutOut\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=tr.cutOut.getValue(),",
            "                    label=\"Cut out (%s)\" % tr.cutOut.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutOut\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut out\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutOut\"])",
            "        except Exception:",
            "            self.fields[\"cutOut\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut out\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutOut\"])",
            "",
            "        # Cut in tolerance",
            "        try:",
            "            if tr is not None and tr.cutInTolerance is not None:",
            "                self.fields[\"cutInTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutInTolerance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=tr.cutInTolerance.getValue(),",
            "                    label=(\"Cut in tolerance (%s)\" % tr.cutInTolerance.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutInTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutInTolerance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut in tolerance\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutInTolerance\"])",
            "        except Exception:",
            "            self.fields[\"cutInTolerance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut in tolerance\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutInTolerance\"])",
            "",
            "        # Cut on tolerance",
            "        try:",
            "            if tr is not None and tr.cutOutTolerance is not None:",
            "                self.fields[\"cutOutTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=tr.cutOutTolerance.getValue(),",
            "                    label=(\"Cut out tolerance (%s)\" % tr.cutOutTolerance.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutOutTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut out tolerance\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutOutTolerance\"])",
            "        except Exception:",
            "            self.fields[\"cutOutTolerance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut out tolerance\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutOutTolerance\"])",
            "",
            "        # Transmittance",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].transmittanceRange is not None:",
            "                self.fields[\"transmittance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"transmittance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=formatPercentFraction(",
            "                        kwargs[\"initial\"][\"filter\"]",
            "                        .getTransmittanceRange()",
            "                        .transmittance",
            "                    ),",
            "                    label=\"Transmittance (%)\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"transmittance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"transmittance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"transmittance\"])",
            "        except Exception:",
            "            self.fields[\"transmittance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"transmittance\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"type\",",
            "            \"filterWheel\",",
            "            \"cutIn\",",
            "            \"cutOut\",",
            "            \"cutInTolerance\",",
            "            \"cutOutTolerance\",",
            "            \"transmittance\",",
            "        ]",
            "",
            "",
            "class MetadataDetectorForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataDetectorForm, self).__init__(*args, **kwargs)",
            "",
            "        detSet = kwargs[\"initial\"][\"detectorSettings\"]",
            "        detector = kwargs[\"initial\"][\"detector\"]",
            "",
            "        # Manufacturer",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"manufacturer\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"manufacturer\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # SN",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.serialNumber,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number (NB. Untill OMERO model is updated in 4.3, this will",
            "        # throw since lotNumber is not yet supported)",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.lotNumber,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Type",
            "        try:",
            "            if detector.getDetectorType() is not None:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detector.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    initial=detector.getDetectorType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detector.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "        except Exception:",
            "            self.fields[\"type\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "",
            "        # Gain",
            "        try:",
            "            if detSet is not None:",
            "                self.fields[\"gain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={\"size\": 25, \"onchange\": save_metadata(detSet.id, \"gain\")}",
            "                    ),",
            "                    initial=detSet.gain,",
            "                    required=False,",
            "                )",
            "            elif detector is not None:",
            "                self.fields[\"gain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"gain\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.gain,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"gain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={\"size\": 25, \"onchange\": save_metadata(detSet.id, \"gain\")}",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"gain\"])",
            "        except Exception:",
            "            self.fields[\"gain\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"gain\"])",
            "",
            "        # Voltage",
            "        try:",
            "            if detSet is not None and detSet.voltage is not None:",
            "                self.fields[\"voltage\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    initial=detSet.voltage.getValue(),",
            "                    label=\"Voltage (%s)\" % detSet.voltage.getSymbol(),",
            "                    required=False,",
            "                )",
            "            elif detector is not None:",
            "                self.fields[\"voltage\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.voltage.getValue(),",
            "                    label=\"Voltage (%s)\" % detector.voltage.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"voltage\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"voltage\"])",
            "        except Exception:",
            "            self.fields[\"voltage\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"voltage\"])",
            "",
            "        # Offset",
            "        try:",
            "            if detSet is not None:",
            "                self.fields[\"offsetValue\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"offsetValue\"),",
            "                        }",
            "                    ),",
            "                    initial=detSet.offsetValue,",
            "                    label=\"Offset\",",
            "                    required=False,",
            "                )",
            "            elif detector is not None:",
            "                self.fields[\"offsetValue\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"offsetValue\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.offsetValue,",
            "                    label=\"Offset\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"offsetValue\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"offsetValue\"),",
            "                        }",
            "                    ),",
            "                    label=\"Offset\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"offsetValue\"])",
            "        except Exception:",
            "            self.fields[\"offsetValue\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Offset\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"offsetValue\"])",
            "",
            "        # Zoom",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"zoom\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.zoom,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"zoom\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"zoom\"])",
            "        except Exception:",
            "            self.fields[\"zoom\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"zoom\"])",
            "",
            "        # Amplification gain",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"amplificationGain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"amplificationGain\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.amplificationGain,",
            "                    label=\"Amplification gain\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"amplificationGain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"amplificationGain\"),",
            "                        }",
            "                    ),",
            "                    label=\"Amplification gain\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"amplificationGain\"])",
            "        except Exception:",
            "            self.fields[\"amplificationGain\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Amplification gain\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"amplificationGain\"])",
            "",
            "        # Read out rate",
            "        try:",
            "            if detSet is not None and detSet.readOutRate is not None:",
            "                self.fields[\"readOutRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"readOutRate\"),",
            "                        }",
            "                    ),",
            "                    initial=detSet.readOutRate.getValue(),",
            "                    label=(\"Read out rate (%s)\" % detSet.readOutRate.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"readOutRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"readOutRate\"),",
            "                        }",
            "                    ),",
            "                    label=\"Read out rate\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"readOutRate\"])",
            "        except Exception:",
            "            self.fields[\"readOutRate\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Read out rate\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"readOutRate\"])",
            "",
            "        # Binning",
            "        try:",
            "            if detSet is not None:",
            "                self.fields[\"binning\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"binnings\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detSet.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    initial=detSet.getBinning().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"binning\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"binnings\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detSet.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"binning\"])",
            "        except Exception:",
            "            self.fields[\"binning\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"binning\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"type\",",
            "            \"gain\",",
            "            \"voltage\",",
            "            \"offsetValue\",",
            "            \"zoom\",",
            "            \"amplificationGain\",",
            "            \"readOutRate\",",
            "            \"binning\",",
            "        ]",
            "",
            "",
            "class MetadataLightSourceForm(forms.Form):",
            "",
            "    BOOLEAN_CHOICES = (",
            "        (\"\", \"---------\"),",
            "        (\"True\", \"True\"),",
            "        (\"False\", \"False\"),",
            "    )",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataLightSourceForm, self).__init__(*args, **kwargs)",
            "",
            "        lightSource = kwargs[\"initial\"][\"lightSource\"]",
            "        lightSourceSettings = None",
            "        if \"lightSourceSettings\" in kwargs[\"initial\"]:",
            "            lightSourceSettings = kwargs[\"initial\"][\"lightSourceSettings\"]",
            "",
            "        self.lightSourceType = lightSource.OMERO_CLASS",
            "",
            "        # Manufacturer",
            "        try:",
            "            if lightSource.manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if lightSource.model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Serial Number",
            "        try:",
            "            if lightSource.serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot Number",
            "        try:",
            "            if lightSource.lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Power",
            "        try:",
            "            if lightSource.power is not None:",
            "                self.fields[\"power\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"power\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.power.getValue(),",
            "                    label=\"Power (%s)\" % lightSource.power.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"power\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"power\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"power\"])",
            "        except Exception:",
            "            self.fields[\"power\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"power\"])",
            "",
            "        # Type",
            "        try:",
            "            if lightSource.getLightSourceType() is not None:",
            "                self.fields[\"lstype\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"lstypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Type\",",
            "                    initial=lightSource.getLightSourceType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lstype\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"lstypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Type\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lstype\"])",
            "        except Exception:",
            "            self.fields[\"lstype\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Type\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lstype\"])",
            "",
            "        # Pump (laser only)",
            "        try:",
            "            # Will throw exception for non-Laser lightsources.",
            "            pump = lightSource.getPump()",
            "            pumpType = pump.OMERO_CLASS  # E.g. 'Arc'",
            "            pumpModel = pump.getModel()",
            "            pumpValue = \"%s: %s\" % (pumpType, pumpModel)",
            "            self.fields[\"pump\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=pumpValue,",
            "                required=False,",
            "            )",
            "        except Exception:",
            "            # Not a Laser - don't show Pump",
            "            self.fields[\"pump\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "        set_widget_attrs(self.fields[\"pump\"])",
            "",
            "        # Medium",
            "        try:",
            "            if lightSource.getLaserMedium() is not None:",
            "                self.fields[\"lmedium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"medium\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.getLaserMedium().value,",
            "                    label=\"Medium\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lmedium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"medium\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Medium\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lmedium\"])",
            "        except Exception:",
            "            self.fields[\"lmedium\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Medium\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lmedium\"])",
            "",
            "        # Wavelength",
            "        try:",
            "            if (",
            "                lightSourceSettings is not None",
            "                and lightSourceSettings.wavelength is not None",
            "            ):",
            "                self.fields[\"wavelength\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"wavelength\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSourceSettings.wavelength.getValue(),",
            "                    label=(",
            "                        \"Wavelength (%s)\" % lightSourceSettings.wavelength.getSymbol()",
            "                    ),",
            "                    required=False,",
            "                )",
            "            elif lightSource.wavelength is not None:",
            "                self.fields[\"wavelength\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"wavelength\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.wavelength.getValue(),",
            "                    label=(\"Wavelength (%s)\" % lightSource.wavelength.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"wavelength\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"wavelength\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"wavelength\"])",
            "        except Exception:",
            "            self.fields[\"wavelength\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"wavelength\"])",
            "",
            "        # FrequencyMultiplication",
            "        try:",
            "            if lightSource.frequencyMultiplication is not None:",
            "                self.fields[\"frequencyMultiplication\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"frequencyMultiplication\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.frequencyMultiplication,",
            "                    label=\"Frequency Multiplication\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"frequencyMultiplication\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"frequencyMultiplication\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Frequency Multiplication\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"frequencyMultiplication\"])",
            "        except Exception:",
            "            self.fields[\"frequencyMultiplication\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Frequency Multiplication\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"frequencyMultiplication\"])",
            "",
            "        # Tuneable",
            "        try:",
            "            if lightSource.tuneable is not None:",
            "                self.fields[\"tuneable\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"tuneable\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.tuneable,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"tuneable\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"tuneable\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"tuneable\"])",
            "        except Exception:",
            "            self.fields[\"tuneable\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"tuneable\"])",
            "",
            "        # Pulse",
            "        try:",
            "            if lightSource.pulse is not None:",
            "                self.fields[\"pulse\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"pulses\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pulse\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.pulse,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pulse\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"pulses\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pulse\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pulse\"])",
            "        except Exception:",
            "            self.fields[\"pulse\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pulse\"])",
            "",
            "        # Repetition Rate",
            "        try:",
            "            if lightSource.repetitionRate is not None:",
            "                self.fields[\"repetitionRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"repetitionRate\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.repetitionRate.getValue(),",
            "                    label=(",
            "                        \"Repetition rate (%s)\" % lightSource.repetitionRate.getSymbol()",
            "                    ),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"repetitionRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"repetitionRate\"),",
            "                        }",
            "                    ),",
            "                    label=\"Repetition rate\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"repetitionRate\"])",
            "        except Exception:",
            "            self.fields[\"repetitionRate\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Repetition rate\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"repetitionRate\"])",
            "",
            "        # Pockel Cell",
            "        try:",
            "            if lightSource.pockelCell is not None:",
            "                self.fields[\"pockelCell\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pockelCell\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.pockelCell,",
            "                    label=\"Pockel Cell\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pockelCell\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pockelCell\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Pockel Cell\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pockelCell\"])",
            "        except Exception:",
            "            self.fields[\"pockelCell\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Pockel Cell\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pockelCell\"])",
            "",
            "        # Attenuation",
            "        if (",
            "            lightSourceSettings is not None",
            "            and lightSourceSettings.attenuation is not None",
            "        ):",
            "            self.fields[\"attenuation\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(",
            "                    attrs={",
            "                        \"size\": 25,",
            "                        \"onchange\": save_metadata(",
            "                            lightSourceSettings.id, \"attenuation\"",
            "                        ),",
            "                    }",
            "                ),",
            "                initial=formatPercentFraction(lightSourceSettings.attenuation),",
            "                label=\"Attenuation (%)\",",
            "                required=False,",
            "            )",
            "        else:",
            "            self.fields[\"attenuation\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "        set_widget_attrs(self.fields[\"attenuation\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"power\",",
            "            \"lstype\",",
            "            \"pump\",",
            "            \"lmedium\",",
            "            \"wavelength\",",
            "            \"frequencyMultiplication\",",
            "            \"tuneable\",",
            "            \"pulse\",",
            "            \"repetitionRate\",",
            "            \"pockelCell\",",
            "            \"attenuation\",",
            "        ]",
            "",
            "",
            "class MetadataEnvironmentForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataEnvironmentForm, self).__init__(*args, **kwargs)",
            "",
            "        # Imaging environment",
            "",
            "        imagingEnv = kwargs[\"initial\"][\"image\"].getImagingEnvironment()",
            "        # Temperature",
            "        try:",
            "            if imagingEnv.temperature is not None:",
            "                self.fields[\"temperature\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"temperature\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.temperature.getValue(),",
            "                    label=(\"Temperature (%s)\" % imagingEnv.temperature.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"temperature\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"temperature\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"temperature\"])",
            "        except Exception:",
            "            self.fields[\"temperature\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"temperature\"])",
            "",
            "        # Air Pressure",
            "        try:",
            "            if imagingEnv.airPressure is not None:",
            "                self.fields[\"airPressure\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"airPressure\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.airPressure.getValue(),",
            "                    label=(\"Air Pressure (%s)\" % imagingEnv.airPressure.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"airPressure\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"airPressure\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Air Pressure\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"airPressure\"])",
            "        except Exception:",
            "            self.fields[\"airPressure\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                label=\"Air Pressure\",",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"airPressure\"])",
            "",
            "        # Humidity",
            "        try:",
            "            if imagingEnv.humidity is not None:",
            "                self.fields[\"humidity\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"humidity\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.humidity,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"humidity\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"humidity\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"humidity\"])",
            "        except Exception:",
            "            self.fields[\"humidity\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"humidity\"])",
            "",
            "        # CO2 percent",
            "        try:",
            "            if imagingEnv.co2percent is not None:",
            "                self.fields[\"co2percent\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"co2percent\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.co2percent,",
            "                    label=\"CO2 (%)\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"co2percent\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"co2percent\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"CO2 (%)\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"co2percent\"])",
            "        except Exception:",
            "            self.fields[\"co2percent\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"CO2 (%)\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"co2percent\"])",
            "",
            "        self.fields.keyOrder = [\"airPressure\", \"co2percent\", \"humidity\", \"temperature\"]",
            "",
            "",
            "class MetadataStageLabelForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataStageLabelForm, self).__init__(*args, **kwargs)",
            "",
            "        # Stage label",
            "",
            "        # Position x",
            "        try:",
            "            if kwargs[\"initial\"][\"image\"].getStageLabel() is not None:",
            "                self.fields[\"positionx\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionx\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"image\"].getStageLabel().positionx,",
            "                    label=\"Position X\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"positionx\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionx\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Position X\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"positionx\"])",
            "        except Exception:",
            "            self.fields[\"positionx\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Position X\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"positionx\"])",
            "",
            "        # Position y",
            "        try:",
            "            if kwargs[\"initial\"][\"image\"].getStageLabel() is not None:",
            "                self.fields[\"positiony\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positiony\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"image\"].getStageLabel().positiony,",
            "                    label=\"Position Y\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"positiony\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positiony\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Position Y\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"positiony\"])",
            "        except Exception:",
            "            self.fields[\"positiony\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Position Y\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"positionx\"])",
            "",
            "        # Position z",
            "        try:",
            "            if kwargs[\"initial\"][\"image\"].getStageLabel() is not None:",
            "                self.fields[\"positionz\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionz\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"image\"].getStageLabel().positionz,",
            "                    label=\"Position Z\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"positionz\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionz\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Position Z\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"positionz\"])",
            "        except Exception:",
            "            self.fields[\"positionz\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Position Z\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"positionz\"])",
            "",
            "        self.fields.keyOrder = [\"positionx\", \"positiony\", \"positionz\"]"
        ],
        "afterPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "#",
            "#",
            "#",
            "# Copyright (c) 2008-2015 University of Dundee.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "#",
            "# Author: Aleksandra Tarkowska <A(dot)Tarkowska(at)dundee(dot)ac(dot)uk>, 2008.",
            "#",
            "# Version: 1.0",
            "#",
            "",
            "import datetime",
            "import time",
            "import logging",
            "",
            "from django.conf import settings",
            "from django import forms",
            "from django.forms.formsets import formset_factory",
            "from django.core.urlresolvers import reverse",
            "",
            "from omeroweb.custom_forms import NonASCIIForm",
            "from .custom_forms import MetadataModelChoiceField",
            "from .custom_forms import AnnotationModelMultipleChoiceField",
            "from .custom_forms import ObjectModelMultipleChoiceField",
            "from omeroweb.webadmin.custom_forms import ExperimenterModelMultipleChoiceField",
            "from omeroweb.webadmin.custom_forms import GroupModelChoiceField",
            "from omeroweb.webclient.webclient_utils import formatPercentFraction",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "##################################################################",
            "# Static values",
            "",
            "# TODO: change to reverse",
            "help_button = \"%swebgateway/img/help16.png\" % settings.STATIC_URL",
            "",
            "help_enable = (",
            "    '<span class=\"tooltip\" title=\"Enable/Disable: This option'",
            "    ' allows the owner to keep the access control of the share.\">'",
            "    '<img src=\"%s\" /></span>'",
            ") % help_button",
            "",
            "help_expire = (",
            "    '<span class=\"tooltip\" title=\"Expiry date: This date defines'",
            "    \" when the share will stop being available. Date format:\"",
            "    ' YYYY-MM-DD.\"><img src=\"%s\" /></span>'",
            ") % help_button",
            "",
            "",
            "#################################################################",
            "# Non-model Form",
            "",
            "",
            "class GlobalSearchForm(NonASCIIForm):",
            "",
            "    search_query = forms.CharField(widget=forms.TextInput(attrs={\"size\": 25}))",
            "",
            "",
            "class ShareForm(NonASCIIForm):",
            "    def __init__(self, *args, **kwargs):",
            "        super(ShareForm, self).__init__(*args, **kwargs)",
            "",
            "        try:",
            "            if kwargs[\"initial\"][\"shareMembers\"]:",
            "                pass",
            "            self.fields[\"members\"] = ExperimenterModelMultipleChoiceField(",
            "                queryset=kwargs[\"initial\"][\"experimenters\"],",
            "                initial=kwargs[\"initial\"][\"shareMembers\"],",
            "                widget=forms.SelectMultiple(attrs={\"size\": 28}),",
            "            )",
            "        except Exception:",
            "            self.fields[\"members\"] = ExperimenterModelMultipleChoiceField(",
            "                queryset=kwargs[\"initial\"][\"experimenters\"],",
            "                widget=forms.SelectMultiple(attrs={\"size\": 28}),",
            "            )",
            "        self.fields.keyOrder = [",
            "            \"message\",",
            "            \"expiration\",",
            "            \"enable\",",
            "            \"members\",",
            "        ]  # , 'guests']",
            "",
            "    message = forms.CharField(widget=forms.Textarea(attrs={\"rows\": 5, \"cols\": 50}))",
            "    expiration = forms.CharField(",
            "        max_length=100,",
            "        widget=forms.TextInput(attrs={\"size\": 10}),",
            "        label=\"Expiry date\",",
            "        help_text=help_expire,",
            "        required=False,",
            "    )",
            "    enable = forms.BooleanField(required=False, help_text=help_enable)",
            "    # guests = MultiEmailField(required=False,",
            "    # widget=forms.TextInput(attrs={'size':75}))",
            "",
            "    def clean_expiration(self):",
            "        if (",
            "            self.cleaned_data[\"expiration\"] is not None",
            "            and len(self.cleaned_data[\"expiration\"]) < 1",
            "        ):",
            "            return None",
            "        if self.cleaned_data[\"expiration\"] is not None:",
            "            d = str(self.cleaned_data[\"expiration\"]).rsplit(\"-\")",
            "            try:",
            "                date = datetime.datetime.strptime(",
            "                    (\"%s-%s-%s\" % (d[0], d[1], d[2])), \"%Y-%m-%d\"",
            "                )",
            "            except Exception:",
            "                raise forms.ValidationError(\"Date is in the wrong format. YY-MM-DD\")",
            "            if time.mktime(date.timetuple()) <= time.time():",
            "                raise forms.ValidationError(\"Expiry date must be in the future.\")",
            "        return self.cleaned_data[\"expiration\"]",
            "",
            "",
            "class ContainerForm(NonASCIIForm):",
            "",
            "    name = forms.CharField(max_length=250, widget=forms.TextInput(attrs={\"size\": 45}))",
            "    description = forms.CharField(",
            "        widget=forms.Textarea(attrs={\"rows\": 2, \"cols\": 49}), required=False",
            "    )",
            "    owner = forms.CharField(widget=forms.HiddenInput, required=False)",
            "",
            "",
            "class ContainerNameForm(NonASCIIForm):",
            "",
            "    name = forms.CharField(max_length=250, widget=forms.TextInput(attrs={\"size\": 45}))",
            "",
            "",
            "class ContainerDescriptionForm(NonASCIIForm):",
            "",
            "    description = forms.CharField(",
            "        widget=forms.Textarea(attrs={\"rows\": 3, \"cols\": 39}), required=False",
            "    )",
            "",
            "",
            "class BaseAnnotationForm(NonASCIIForm):",
            "    \"\"\"",
            "    This is the superclass of the various forms used for annotating single or",
            "    multiple objects.",
            "    All these forms use hidden fields to specify the object(s) currently being",
            "    annotated.",
            "    \"\"\"",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(BaseAnnotationForm, self).__init__(*args, **kwargs)",
            "",
            "        images = \"images\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"images\"] or list()",
            "        if len(images) > 0:",
            "            try:",
            "                self.fields[\"image\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=images,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"images\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"image\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=images,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        datasets = (",
            "            \"datasets\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"datasets\"] or list()",
            "        )",
            "        if len(datasets) > 0:",
            "            try:",
            "                self.fields[\"dataset\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=datasets,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"datasets\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"dataset\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=datasets,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        projects = (",
            "            \"projects\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"projects\"] or list()",
            "        )",
            "        if len(projects) > 0:",
            "            try:",
            "                self.fields[\"project\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=projects,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"projects\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"project\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=projects,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        screens = (",
            "            \"screens\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"screens\"] or list()",
            "        )",
            "        if len(screens) > 0:",
            "            try:",
            "                self.fields[\"screen\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=screens,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"screens\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"screen\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=screens,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        plates = \"plates\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"plates\"] or list()",
            "        if len(plates) > 0:",
            "            try:",
            "                self.fields[\"plate\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=plates,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"plates\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"plate\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=plates,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        acquisitions = (",
            "            \"acquisitions\" in kwargs[\"initial\"]",
            "            and kwargs[\"initial\"][\"acquisitions\"]",
            "            or list()",
            "        )",
            "        if len(acquisitions) > 0:",
            "            try:",
            "                self.fields[\"acquisition\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=acquisitions,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"acquisitions\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"acquisition\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=acquisitions,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        wells = \"wells\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"wells\"] or list()",
            "        if len(wells) > 0:",
            "            try:",
            "                self.fields[\"well\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=wells,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"wells\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"well\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=wells,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "        shares = \"shares\" in kwargs[\"initial\"] and kwargs[\"initial\"][\"shares\"] or list()",
            "        if len(shares) > 0:",
            "            try:",
            "                self.fields[\"share\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=shares,",
            "                    initial=kwargs[\"initial\"][\"selected\"][\"shares\"],",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "            except Exception:",
            "                self.fields[\"share\"] = ObjectModelMultipleChoiceField(",
            "                    queryset=shares,",
            "                    widget=forms.SelectMultiple(attrs={\"size\": 10}),",
            "                    required=False,",
            "                )",
            "",
            "",
            "class TagsAnnotationForm(BaseAnnotationForm):",
            "    \"\"\"",
            "    Form for annotating one or more objects with existing Tags or New tags",
            "    \"\"\"",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(TagsAnnotationForm, self).__init__(*args, **kwargs)",
            "",
            "    tags = forms.CharField(required=False, widget=forms.HiddenInput)",
            "",
            "    def clean_tags(self):",
            "        data = self.cleaned_data[\"tags\"]",
            "        if not data:",
            "            return []",
            "        try:",
            "            data = map(int, data.split(\",\"))",
            "        except Exception:",
            "            raise forms.ValidationError()",
            "        return data",
            "",
            "",
            "class NewTagsAnnotationForm(forms.Form):",
            "    \"\"\" Helper form for new tags \"\"\"",
            "",
            "    tag = forms.CharField(required=True, widget=forms.HiddenInput)",
            "    description = forms.CharField(required=False, widget=forms.HiddenInput)",
            "    tagset = forms.IntegerField(min_value=1, required=False, widget=forms.HiddenInput)",
            "",
            "",
            "NewTagsAnnotationFormSet = formset_factory(NewTagsAnnotationForm, extra=0)",
            "",
            "",
            "class FilesAnnotationForm(BaseAnnotationForm):",
            "    def __init__(self, *args, **kwargs):",
            "        super(FilesAnnotationForm, self).__init__(*args, **kwargs)",
            "        self.fields[\"files\"] = AnnotationModelMultipleChoiceField(",
            "            queryset=kwargs[\"initial\"][\"files\"],",
            "            widget=forms.SelectMultiple(attrs={\"size\": 8, \"class\": \"existing\"}),",
            "            required=False,",
            "        )",
            "",
            "    annotation_file = forms.FileField(required=False)",
            "",
            "",
            "class CommentAnnotationForm(BaseAnnotationForm):",
            "    comment = forms.CharField(widget=forms.Textarea(attrs={\"rows\": 2, \"cols\": 39}))",
            "",
            "",
            "class ActiveGroupForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(ActiveGroupForm, self).__init__(*args, **kwargs)",
            "        try:",
            "            self.fields[\"active_group\"] = GroupModelChoiceField(",
            "                queryset=kwargs[\"initial\"][\"mygroups\"],",
            "                initial=kwargs[\"initial\"][\"activeGroup\"],",
            "                empty_label=None,",
            "                widget=forms.Select(",
            "                    attrs={",
            "                        \"onchange\": (",
            "                            \"window.location.href='\"",
            "                            + reverse(viewname=\"change_active_group\")",
            "                            + \"?url=\"",
            "                            + kwargs[\"initial\"][\"url\"]",
            "                            + \"&active_group='\"",
            "                            \"+this.options[this.selectedIndex].value\"",
            "                        )",
            "                    }",
            "                ),",
            "            )",
            "        except Exception:",
            "            self.fields[\"active_group\"] = GroupModelChoiceField(",
            "                queryset=kwargs[\"initial\"][\"mygroups\"],",
            "                initial=kwargs[\"initial\"][\"activeGroup\"],",
            "                empty_label=None,",
            "                widget=forms.Select(",
            "                    attrs={",
            "                        \"onchange\": (",
            "                            \"window.location.href='\"",
            "                            + reverse(viewname=\"change_active_group\")",
            "                            + \"?active_group='\"",
            "                            \"+this.options[this.selectedIndex].value\"",
            "                        )",
            "                    }",
            "                ),",
            "            )",
            "        self.fields.keyOrder = [\"active_group\"]",
            "",
            "",
            "class WellIndexForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(WellIndexForm, self).__init__(*args, **kwargs)",
            "        rmin, rmax = kwargs[\"initial\"][\"range\"]",
            "        choices = [(str(i), \"Field#%i\" % (i - rmin + 1)) for i in range(rmin, rmax + 1)]",
            "        self.fields[\"index\"] = forms.ChoiceField(",
            "            choices=tuple(choices),",
            "            widget=forms.Select(",
            "                attrs={",
            "                    \"onchange\": (\"changeField(this.options[this.selectedIndex].value);\")",
            "                }",
            "            ),",
            "        )",
            "        self.fields.keyOrder = [\"index\"]",
            "",
            "",
            "###############################",
            "# METADATA FORMS",
            "",
            "",
            "def save_metadata(obj, name, options=False):",
            "    s = \"javascript:save_metadata(\" + str(obj) + \", '\" + name + \"', \"",
            "    if options:",
            "        s += \"this.options[this.selectedIndex].value);\"",
            "    else:",
            "        s += \"this.value);\"",
            "",
            "    return s",
            "",
            "",
            "def set_widget_attrs(field, set_class=True):",
            "    field.widget.attrs[\"disabled\"] = True",
            "    if set_class:",
            "        field.widget.attrs[\"class\"] = \"disabled-metadata\"",
            "",
            "",
            "class MetadataChannelForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataChannelForm, self).__init__(*args, **kwargs)",
            "",
            "        # Logical channel",
            "",
            "        # Name",
            "        logicalCh = kwargs[\"initial\"][\"logicalChannel\"]",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"name\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={\"size\": 25, \"onchange\": save_metadata(logicalCh.id)}",
            "                    ),",
            "                    initial=logicalCh.name,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"name\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"name\"])",
            "        except Exception:",
            "            self.fields[\"name\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"name\"])",
            "",
            "        # excitationWave",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"excitationWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"exWave\"].getValue(),",
            "                    label=(\"Excitation (%s)\" % kwargs[\"initial\"][\"exWave\"].getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"excitationWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Excitation\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"excitationWave\"])",
            "        except Exception:",
            "            self.fields[\"excitationWave\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Excitation\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"excitationWave\"])",
            "",
            "        # emissionWave",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"emissionWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"emWave\"].getValue(),",
            "                    label=(\"Emission (%s)\" % kwargs[\"initial\"][\"emWave\"].getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"emissionWave\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Emission\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"emissionWave\"])",
            "        except Exception:",
            "            self.fields[\"emissionWave\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Emission\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"emissionWave\"])",
            "",
            "        # ndFilter",
            "        try:",
            "            if logicalCh is not None and logicalCh.ndFilter is not None:",
            "                self.fields[\"ndFilter\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=formatPercentFraction(logicalCh.ndFilter),",
            "                    label=\"ND filter (%)\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"ndFilter\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"ND filter (%)\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"ndFilter\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"ndFilter\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"ND filter (%)\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"ndFilter\"], set_class=False)",
            "",
            "        # pinHoleSize",
            "        try:",
            "            if logicalCh is not None and logicalCh.pinHoleSize is not None:",
            "                self.fields[\"pinHoleSize\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.pinHoleSize.getValue(),",
            "                    label=(\"Pin hole size (%s)\" % logicalCh.pinHoleSize.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pinHoleSize\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Pin hole size\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pinHoleSize\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"pinHoleSize\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Pin hole size\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pinHoleSize\"], set_class=False)",
            "",
            "        # fluor",
            "        try:",
            "            if logicalCh is not None:",
            "                self.fields[\"fluor\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.fluor,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"fluor\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"fluor\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"fluor\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"fluor\"], set_class=False)",
            "",
            "        # Illumination",
            "        try:",
            "            if logicalCh.getIllumination() is not None:",
            "                self.fields[\"illumination\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"illuminations\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"illumination\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.getIllumination(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"illumination\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"illuminations\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"illumination\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"illumination\"], set_class=False)",
            "        except Exception:",
            "            self.fields[\"illumination\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"illumination\"], set_class=False)",
            "",
            "        # contrastMethods",
            "        try:",
            "            if logicalCh.contrastMethod is not None:",
            "                self.fields[\"contrastMethod\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"contrastMethods\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"contrastMethod\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.getContrastMethod(),",
            "                    label=\"Contrast method\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"contrastMethod\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"contrastMethods\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"contrastMethod\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Contrast method\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"contrastMethod\"])",
            "        except Exception:",
            "            self.fields[\"contrastMethod\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Contrast method\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"contrastMethod\"])",
            "",
            "        # Mode",
            "        try:",
            "            if logicalCh.getMode() is not None:",
            "                self.fields[\"mode\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"modes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"mode\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.getMode().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"mode\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"modes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                logicalCh.id, \"mode\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"mode\"])",
            "        except Exception:",
            "            self.fields[\"mode\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"mode\"])",
            "",
            "        # pockelCellSetting",
            "        try:",
            "            if logicalCh.pockelCellSetting is not None:",
            "                self.fields[\"pockelCellSetting\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    initial=logicalCh.pockelCellSetting,",
            "                    label=\"Pockel cell\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pockelCellSetting\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(logicalCh.id, \"name\"),",
            "                        }",
            "                    ),",
            "                    label=\"Pockel cell\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pockelCellSetting\"])",
            "        except Exception:",
            "            self.fields[\"pockelCellSetting\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Pockel cell\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pockelCellSetting\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"name\",",
            "            \"excitationWave\",",
            "            \"emissionWave\",",
            "            \"ndFilter\",",
            "            \"pinHoleSize\",",
            "            \"fluor\",",
            "            \"illumination\",",
            "            \"contrastMethod\",",
            "            \"mode\",",
            "            \"pockelCellSetting\",",
            "        ]",
            "",
            "",
            "class MetadataDichroicForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataDichroicForm, self).__init__(*args, **kwargs)",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Serial number",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].serialNumber,",
            "                                \"serialNumber\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].serialNumber,",
            "                                \"serialNumber\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"dichroic\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].lotNumber, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"dichroic\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"dichroic\"].lotNumber, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        self.fields.keyOrder = [\"model\", \"manufacturer\", \"serialNumber\", \"lotNumber\"]",
            "",
            "",
            "class MetadataMicroscopeForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataMicroscopeForm, self).__init__(*args, **kwargs)",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Serial number",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Type",
            "        try:",
            "            if kwargs[\"initial\"][\"microscope\"].getMicroscopeType() is not None:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"microscopeTypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"microscope\"].getMicroscopeType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"microscopeTypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"microscope\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "        except Exception:",
            "            self.fields[\"type\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"type\",",
            "        ]",
            "",
            "",
            "class MetadataObjectiveForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataObjectiveForm, self).__init__(*args, **kwargs)",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Serial Number",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].lotNumber, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"logicalchannel\"]",
            "                                .getObjective()",
            "                                .lotNumber,",
            "                                \"lotNumber\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Nominal Magnification",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].nominalMagnification is not None:",
            "                self.fields[\"nominalMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"nominalMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].nominalMagnification,",
            "                    label=\"Nominal magnification\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"nominalMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"nominalMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Nominal magnification\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"nominalMagnification\"])",
            "        except Exception:",
            "            self.fields[\"nominalMagnification\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Nominal magnification\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"nominalMagnification\"])",
            "",
            "        # Calibrated Magnification",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].calibratedMagnification is not None:",
            "                self.fields[\"calibratedMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"calibratedMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].calibratedMagnification,",
            "                    label=\"Calibrated magnification\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"calibratedMagnification\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"calibratedMagnification\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Calibrated magnification\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"calibratedMagnification\"])",
            "        except Exception:",
            "            self.fields[\"calibratedMagnification\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Calibrated magnification\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"calibratedMagnification\"])",
            "",
            "        # Lens NA",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].lensNA is not None:",
            "                self.fields[\"lensNA\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"lensNA\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].lensNA,",
            "                    label=\"Lens NA\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lensNA\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"lensNA\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lensNA\"])",
            "        except Exception:",
            "            self.fields[\"lensNA\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lens NA\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lensNA\"])",
            "",
            "        # Immersion",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].getImmersion() is not None:",
            "                self.fields[\"immersion\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"immersions\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"immersion\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].getImmersion().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"immersion\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"immersions\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"immersion\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"immersion\"])",
            "        except Exception:",
            "            self.fields[\"immersion\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"immersion\"])",
            "",
            "        # Correction",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].getCorrection() is not None:",
            "                self.fields[\"correction\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"corrections\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"correction\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].getCorrection().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"correction\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"corrections\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id,",
            "                                \"correction\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"correction\"])",
            "",
            "        except Exception:",
            "            self.fields[\"correction\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"correction\"])",
            "",
            "        # Working Distance",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].workingDistance is not None:",
            "                self.fields[\"workingDistance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"workingDistance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].workingDistance.getValue(),",
            "                    label=(",
            "                        \"Working distance (%s)\"",
            "                        % kwargs[\"initial\"][\"objective\"].workingDistance.getSymbol()",
            "                    ),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"workingDistance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"workingDistance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Working distance\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"workingDistance\"])",
            "        except Exception:",
            "            self.fields[\"workingDistance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Working distance\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"workingDistance\"])",
            "",
            "        # Iris",
            "        try:",
            "            if kwargs[\"initial\"][\"objective\"].getIris() is not None:",
            "                self.fields[\"iris\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"iris\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objective\"].getIris().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"iris\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objective\"].id, \"iris\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"iris\"])",
            "        except Exception:",
            "            self.fields[\"iris\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"iris\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"nominalMagnification\",",
            "            \"calibratedMagnification\",",
            "            \"lensNA\",",
            "            \"immersion\",",
            "            \"correction\",",
            "            \"workingDistance\",",
            "            \"iris\",",
            "        ]",
            "",
            "",
            "class MetadataObjectiveSettingsForm(MetadataObjectiveForm):",
            "",
            "    BOOLEAN_CHOICES = (",
            "        (\"\", \"---------\"),",
            "        (\"True\", \"True\"),",
            "        (\"False\", \"False\"),",
            "    )",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataObjectiveSettingsForm, self).__init__(*args, **kwargs)",
            "",
            "        # Objective Settings",
            "",
            "        # Correction Collar",
            "        try:",
            "            if kwargs[\"initial\"][\"objectiveSettings\"].correctionCollar is not None:",
            "                self.fields[\"correctionCollar\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"correctionCollar\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objectiveSettings\"].correctionCollar,",
            "                    label=\"Correction collar\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"correctionCollar\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"correctionCollar\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Correction collar\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"correctionCollar\"])",
            "        except Exception:",
            "            self.fields[\"correctionCollar\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Correction collar\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"correctionCollar\"])",
            "",
            "        # Medium",
            "        try:",
            "            if kwargs[\"initial\"][\"objectiveSettings\"].getMedium() is not None:",
            "                self.fields[\"medium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"medium\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objectiveSettings\"].getMedium().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"medium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"medium\",",
            "                                options=True,",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"medium\"])",
            "        except Exception:",
            "            self.fields[\"medium\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"medium\"])",
            "",
            "        # Refractive Index",
            "        try:",
            "            if kwargs[\"initial\"][\"objectiveSettings\"].refractiveIndex is not None:",
            "                self.fields[\"refractiveIndex\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"refractiveIndex\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"objectiveSettings\"].refractiveIndex,",
            "                    label=\"Refractive index\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"refractiveIndex\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"objectiveSettings\"].id,",
            "                                \"refractiveIndex\",",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Refractive index\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"refractiveIndex\"])",
            "        except Exception:",
            "            self.fields[\"refractiveIndex\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Refractive index\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"refractiveIndex\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"nominalMagnification\",",
            "            \"calibratedMagnification\",",
            "            \"lensNA\",",
            "            \"immersion\",",
            "            \"correction\",",
            "            \"workingDistance\",",
            "            \"iris\",",
            "            \"correctionCollar\",",
            "            \"medium\",",
            "            \"refractiveIndex\",",
            "        ]",
            "",
            "",
            "class MetadataFilterForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataFilterForm, self).__init__(*args, **kwargs)",
            "",
            "        # Filter",
            "",
            "        # Manufacturer",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"manufacturer\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"model\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Serial Number",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"serialNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"lotNumber\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Filter wheel",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].filterWheel is not None:",
            "                self.fields[\"filterWheel\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"filterWheel\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].filterWheel,",
            "                    label=\"Filter wheel\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"filterWheel\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"filterWheel\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Filter wheel\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"filterWheel\"])",
            "        except Exception:",
            "            self.fields[\"filterWheel\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Filter wheel\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"filterWheel\"])",
            "",
            "        # Type",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].getFilterType() is not None:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"].getFilterType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "        except Exception:",
            "            self.fields[\"type\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "",
            "        # Cut in",
            "        tr = kwargs[\"initial\"][\"filter\"].getTransmittanceRange()",
            "        try:",
            "            if tr is not None and tr.cutIn is not None:",
            "                self.fields[\"cutIn\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutIn\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"filter\"]",
            "                    .getTransmittanceRange()",
            "                    .cutIn.getValue(),",
            "                    label=\"Cut in (%s)\" % tr.cutIn.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutIn\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutIn\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut in\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutIn\"])",
            "        except Exception:",
            "            self.fields[\"cutIn\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut in\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutIn\"])",
            "",
            "        # Cut out",
            "        try:",
            "            if tr is not None and tr.cutOut is not None:",
            "                self.fields[\"cutOut\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=tr.cutOut.getValue(),",
            "                    label=\"Cut out (%s)\" % tr.cutOut.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutOut\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut out\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutOut\"])",
            "        except Exception:",
            "            self.fields[\"cutOut\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut out\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutOut\"])",
            "",
            "        # Cut in tolerance",
            "        try:",
            "            if tr is not None and tr.cutInTolerance is not None:",
            "                self.fields[\"cutInTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutInTolerance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=tr.cutInTolerance.getValue(),",
            "                    label=(\"Cut in tolerance (%s)\" % tr.cutInTolerance.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutInTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutInTolerance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut in tolerance\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutInTolerance\"])",
            "        except Exception:",
            "            self.fields[\"cutInTolerance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut in tolerance\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutInTolerance\"])",
            "",
            "        # Cut on tolerance",
            "        try:",
            "            if tr is not None and tr.cutOutTolerance is not None:",
            "                self.fields[\"cutOutTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=tr.cutOutTolerance.getValue(),",
            "                    label=(\"Cut out tolerance (%s)\" % tr.cutOutTolerance.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"cutOutTolerance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"cutOut\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Cut out tolerance\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"cutOutTolerance\"])",
            "        except Exception:",
            "            self.fields[\"cutOutTolerance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Cut out tolerance\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"cutOutTolerance\"])",
            "",
            "        # Transmittance",
            "        try:",
            "            if kwargs[\"initial\"][\"filter\"].transmittanceRange is not None:",
            "                self.fields[\"transmittance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"transmittance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=formatPercentFraction(",
            "                        kwargs[\"initial\"][\"filter\"]",
            "                        .getTransmittanceRange()",
            "                        .transmittance",
            "                    ),",
            "                    label=\"Transmittance (%)\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"transmittance\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"filter\"].id, \"transmittance\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"transmittance\"])",
            "        except Exception:",
            "            self.fields[\"transmittance\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"transmittance\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"type\",",
            "            \"filterWheel\",",
            "            \"cutIn\",",
            "            \"cutOut\",",
            "            \"cutInTolerance\",",
            "            \"cutOutTolerance\",",
            "            \"transmittance\",",
            "        ]",
            "",
            "",
            "class MetadataDetectorForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataDetectorForm, self).__init__(*args, **kwargs)",
            "",
            "        detSet = kwargs[\"initial\"][\"detectorSettings\"]",
            "        detector = kwargs[\"initial\"][\"detector\"]",
            "",
            "        # Manufacturer",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"manufacturer\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"manufacturer\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # SN",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.serialNumber,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot number (NB. Untill OMERO model is updated in 4.3, this will",
            "        # throw since lotNumber is not yet supported)",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.lotNumber,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Type",
            "        try:",
            "            if detector.getDetectorType() is not None:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detector.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    initial=detector.getDetectorType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"type\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"types\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detector.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "        except Exception:",
            "            self.fields[\"type\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"type\"])",
            "",
            "        # Gain",
            "        try:",
            "            if detSet is not None:",
            "                self.fields[\"gain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={\"size\": 25, \"onchange\": save_metadata(detSet.id, \"gain\")}",
            "                    ),",
            "                    initial=detSet.gain,",
            "                    required=False,",
            "                )",
            "            elif detector is not None:",
            "                self.fields[\"gain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"gain\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.gain,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"gain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={\"size\": 25, \"onchange\": save_metadata(detSet.id, \"gain\")}",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"gain\"])",
            "        except Exception:",
            "            self.fields[\"gain\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"gain\"])",
            "",
            "        # Voltage",
            "        try:",
            "            if detSet is not None and detSet.voltage is not None:",
            "                self.fields[\"voltage\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    initial=detSet.voltage.getValue(),",
            "                    label=\"Voltage (%s)\" % detSet.voltage.getSymbol(),",
            "                    required=False,",
            "                )",
            "            elif detector is not None:",
            "                self.fields[\"voltage\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.voltage.getValue(),",
            "                    label=\"Voltage (%s)\" % detector.voltage.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"voltage\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"voltage\"])",
            "        except Exception:",
            "            self.fields[\"voltage\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"voltage\"])",
            "",
            "        # Offset",
            "        try:",
            "            if detSet is not None:",
            "                self.fields[\"offsetValue\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"offsetValue\"),",
            "                        }",
            "                    ),",
            "                    initial=detSet.offsetValue,",
            "                    label=\"Offset\",",
            "                    required=False,",
            "                )",
            "            elif detector is not None:",
            "                self.fields[\"offsetValue\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"offsetValue\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.offsetValue,",
            "                    label=\"Offset\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"offsetValue\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"offsetValue\"),",
            "                        }",
            "                    ),",
            "                    label=\"Offset\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"offsetValue\"])",
            "        except Exception:",
            "            self.fields[\"offsetValue\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Offset\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"offsetValue\"])",
            "",
            "        # Zoom",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"zoom\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.zoom,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"zoom\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"voltage\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"zoom\"])",
            "        except Exception:",
            "            self.fields[\"zoom\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"zoom\"])",
            "",
            "        # Amplification gain",
            "        try:",
            "            if detector is not None:",
            "                self.fields[\"amplificationGain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"amplificationGain\"),",
            "                        }",
            "                    ),",
            "                    initial=detector.amplificationGain,",
            "                    label=\"Amplification gain\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"amplificationGain\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detector.id, \"amplificationGain\"),",
            "                        }",
            "                    ),",
            "                    label=\"Amplification gain\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"amplificationGain\"])",
            "        except Exception:",
            "            self.fields[\"amplificationGain\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Amplification gain\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"amplificationGain\"])",
            "",
            "        # Read out rate",
            "        try:",
            "            if detSet is not None and detSet.readOutRate is not None:",
            "                self.fields[\"readOutRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"readOutRate\"),",
            "                        }",
            "                    ),",
            "                    initial=detSet.readOutRate.getValue(),",
            "                    label=(\"Read out rate (%s)\" % detSet.readOutRate.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"readOutRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(detSet.id, \"readOutRate\"),",
            "                        }",
            "                    ),",
            "                    label=\"Read out rate\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"readOutRate\"])",
            "        except Exception:",
            "            self.fields[\"readOutRate\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Read out rate\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"readOutRate\"])",
            "",
            "        # Binning",
            "        try:",
            "            if detSet is not None:",
            "                self.fields[\"binning\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"binnings\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detSet.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    initial=detSet.getBinning().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"binning\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"binnings\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(detSet.id, \"type\", options=True)",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"binning\"])",
            "        except Exception:",
            "            self.fields[\"binning\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"binning\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"type\",",
            "            \"gain\",",
            "            \"voltage\",",
            "            \"offsetValue\",",
            "            \"zoom\",",
            "            \"amplificationGain\",",
            "            \"readOutRate\",",
            "            \"binning\",",
            "        ]",
            "",
            "",
            "class MetadataLightSourceForm(forms.Form):",
            "",
            "    BOOLEAN_CHOICES = (",
            "        (\"\", \"---------\"),",
            "        (\"True\", \"True\"),",
            "        (\"False\", \"False\"),",
            "    )",
            "",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataLightSourceForm, self).__init__(*args, **kwargs)",
            "",
            "        lightSource = kwargs[\"initial\"][\"lightSource\"]",
            "        lightSourceSettings = None",
            "        if \"lightSourceSettings\" in kwargs[\"initial\"]:",
            "            lightSourceSettings = kwargs[\"initial\"][\"lightSourceSettings\"]",
            "",
            "        self.lightSourceType = lightSource.OMERO_CLASS",
            "",
            "        # Manufacturer",
            "        try:",
            "            if lightSource.manufacturer is not None:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.manufacturer,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"manufacturer\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "        except Exception:",
            "            self.fields[\"manufacturer\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"manufacturer\"])",
            "",
            "        # Model",
            "        try:",
            "            if lightSource.model is not None:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.model,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"model\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"model\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "        except Exception:",
            "            self.fields[\"model\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"model\"])",
            "",
            "        # Serial Number",
            "        try:",
            "            if lightSource.serialNumber is not None:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.serialNumber,",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"serialNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"serialNumber\"),",
            "                        }",
            "                    ),",
            "                    label=\"Serial number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "        except Exception:",
            "            self.fields[\"serialNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Serial number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"serialNumber\"])",
            "",
            "        # Lot Number",
            "        try:",
            "            if lightSource.lotNumber is not None:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.lotNumber,",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lotNumber\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"lotNumber\"),",
            "                        }",
            "                    ),",
            "                    label=\"Lot number\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "        except Exception:",
            "            self.fields[\"lotNumber\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Lot number\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lotNumber\"])",
            "",
            "        # Power",
            "        try:",
            "            if lightSource.power is not None:",
            "                self.fields[\"power\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"power\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.power.getValue(),",
            "                    label=\"Power (%s)\" % lightSource.power.getSymbol(),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"power\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"power\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"power\"])",
            "        except Exception:",
            "            self.fields[\"power\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"power\"])",
            "",
            "        # Type",
            "        try:",
            "            if lightSource.getLightSourceType() is not None:",
            "                self.fields[\"lstype\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"lstypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Type\",",
            "                    initial=lightSource.getLightSourceType().value,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lstype\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"lstypes\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"type\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Type\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lstype\"])",
            "        except Exception:",
            "            self.fields[\"lstype\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Type\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lstype\"])",
            "",
            "        # Pump (laser only)",
            "        try:",
            "            # Will throw exception for non-Laser lightsources.",
            "            pump = lightSource.getPump()",
            "            pumpType = pump.OMERO_CLASS  # E.g. 'Arc'",
            "            pumpModel = pump.getModel()",
            "            pumpValue = \"%s: %s\" % (pumpType, pumpModel)",
            "            self.fields[\"pump\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=pumpValue,",
            "                required=False,",
            "            )",
            "        except Exception:",
            "            # Not a Laser - don't show Pump",
            "            self.fields[\"pump\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "        set_widget_attrs(self.fields[\"pump\"])",
            "",
            "        # Medium",
            "        try:",
            "            if lightSource.getLaserMedium() is not None:",
            "                self.fields[\"lmedium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"medium\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.getLaserMedium().value,",
            "                    label=\"Medium\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"lmedium\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"mediums\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"medium\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Medium\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"lmedium\"])",
            "        except Exception:",
            "            self.fields[\"lmedium\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Medium\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"lmedium\"])",
            "",
            "        # Wavelength",
            "        try:",
            "            if (",
            "                lightSourceSettings is not None",
            "                and lightSourceSettings.wavelength is not None",
            "            ):",
            "                self.fields[\"wavelength\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"wavelength\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSourceSettings.wavelength.getValue(),",
            "                    label=(",
            "                        \"Wavelength (%s)\" % lightSourceSettings.wavelength.getSymbol()",
            "                    ),",
            "                    required=False,",
            "                )",
            "            elif lightSource.wavelength is not None:",
            "                self.fields[\"wavelength\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"wavelength\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.wavelength.getValue(),",
            "                    label=(\"Wavelength (%s)\" % lightSource.wavelength.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"wavelength\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"wavelength\"),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"wavelength\"])",
            "        except Exception:",
            "            self.fields[\"wavelength\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"wavelength\"])",
            "",
            "        # FrequencyMultiplication",
            "        try:",
            "            if lightSource.frequencyMultiplication is not None:",
            "                self.fields[\"frequencyMultiplication\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"frequencyMultiplication\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.frequencyMultiplication,",
            "                    label=\"Frequency Multiplication\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"frequencyMultiplication\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"frequencyMultiplication\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Frequency Multiplication\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"frequencyMultiplication\"])",
            "        except Exception:",
            "            self.fields[\"frequencyMultiplication\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Frequency Multiplication\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"frequencyMultiplication\"])",
            "",
            "        # Tuneable",
            "        try:",
            "            if lightSource.tuneable is not None:",
            "                self.fields[\"tuneable\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"tuneable\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.tuneable,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"tuneable\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"tuneable\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"tuneable\"])",
            "        except Exception:",
            "            self.fields[\"tuneable\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"tuneable\"])",
            "",
            "        # Pulse",
            "        try:",
            "            if lightSource.pulse is not None:",
            "                self.fields[\"pulse\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"pulses\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pulse\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.pulse,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pulse\"] = MetadataModelChoiceField(",
            "                    queryset=kwargs[\"initial\"][\"pulses\"],",
            "                    empty_label=\"Not set\",",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pulse\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pulse\"])",
            "        except Exception:",
            "            self.fields[\"pulse\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pulse\"])",
            "",
            "        # Repetition Rate",
            "        try:",
            "            if lightSource.repetitionRate is not None:",
            "                self.fields[\"repetitionRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"repetitionRate\"),",
            "                        }",
            "                    ),",
            "                    initial=lightSource.repetitionRate.getValue(),",
            "                    label=(",
            "                        \"Repetition rate (%s)\" % lightSource.repetitionRate.getSymbol()",
            "                    ),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"repetitionRate\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(lightSource.id, \"repetitionRate\"),",
            "                        }",
            "                    ),",
            "                    label=\"Repetition rate\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"repetitionRate\"])",
            "        except Exception:",
            "            self.fields[\"repetitionRate\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Repetition rate\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"repetitionRate\"])",
            "",
            "        # Pockel Cell",
            "        try:",
            "            if lightSource.pockelCell is not None:",
            "                self.fields[\"pockelCell\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pockelCell\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    initial=lightSource.pockelCell,",
            "                    label=\"Pockel Cell\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"pockelCell\"] = forms.ChoiceField(",
            "                    choices=self.BOOLEAN_CHOICES,",
            "                    widget=forms.Select(",
            "                        attrs={",
            "                            \"onchange\": save_metadata(",
            "                                lightSource.id, \"pockelCell\", options=True",
            "                            )",
            "                        }",
            "                    ),",
            "                    label=\"Pockel Cell\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"pockelCell\"])",
            "        except Exception:",
            "            self.fields[\"pockelCell\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Pockel Cell\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"pockelCell\"])",
            "",
            "        # Attenuation",
            "        if (",
            "            lightSourceSettings is not None",
            "            and lightSourceSettings.attenuation is not None",
            "        ):",
            "            self.fields[\"attenuation\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(",
            "                    attrs={",
            "                        \"size\": 25,",
            "                        \"onchange\": save_metadata(",
            "                            lightSourceSettings.id, \"attenuation\"",
            "                        ),",
            "                    }",
            "                ),",
            "                initial=formatPercentFraction(lightSourceSettings.attenuation),",
            "                label=\"Attenuation (%)\",",
            "                required=False,",
            "            )",
            "        else:",
            "            self.fields[\"attenuation\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "        set_widget_attrs(self.fields[\"attenuation\"])",
            "",
            "        self.fields.keyOrder = [",
            "            \"model\",",
            "            \"manufacturer\",",
            "            \"serialNumber\",",
            "            \"lotNumber\",",
            "            \"power\",",
            "            \"lstype\",",
            "            \"pump\",",
            "            \"lmedium\",",
            "            \"wavelength\",",
            "            \"frequencyMultiplication\",",
            "            \"tuneable\",",
            "            \"pulse\",",
            "            \"repetitionRate\",",
            "            \"pockelCell\",",
            "            \"attenuation\",",
            "        ]",
            "",
            "",
            "class MetadataEnvironmentForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataEnvironmentForm, self).__init__(*args, **kwargs)",
            "",
            "        # Imaging environment",
            "",
            "        imagingEnv = kwargs[\"initial\"][\"image\"].getImagingEnvironment()",
            "        # Temperature",
            "        try:",
            "            if imagingEnv.temperature is not None:",
            "                self.fields[\"temperature\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"temperature\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.temperature.getValue(),",
            "                    label=(\"Temperature (%s)\" % imagingEnv.temperature.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"temperature\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"temperature\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"temperature\"])",
            "        except Exception:",
            "            self.fields[\"temperature\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"temperature\"])",
            "",
            "        # Air Pressure",
            "        try:",
            "            if imagingEnv.airPressure is not None:",
            "                self.fields[\"airPressure\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"airPressure\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.airPressure.getValue(),",
            "                    label=(\"Air Pressure (%s)\" % imagingEnv.airPressure.getSymbol()),",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"airPressure\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"airPressure\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Air Pressure\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"airPressure\"])",
            "        except Exception:",
            "            self.fields[\"airPressure\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                label=\"Air Pressure\",",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"airPressure\"])",
            "",
            "        # Humidity",
            "        try:",
            "            if imagingEnv.humidity is not None:",
            "                self.fields[\"humidity\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"humidity\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.humidity,",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"humidity\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"humidity\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"humidity\"])",
            "        except Exception:",
            "            self.fields[\"humidity\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"humidity\"])",
            "",
            "        # CO2 percent",
            "        try:",
            "            if imagingEnv.co2percent is not None:",
            "                self.fields[\"co2percent\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"co2percent\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=imagingEnv.co2percent,",
            "                    label=\"CO2 (%)\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"co2percent\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"co2percent\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"CO2 (%)\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"co2percent\"])",
            "        except Exception:",
            "            self.fields[\"co2percent\"] = forms.CharField(",
            "                max_length=10,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"CO2 (%)\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"co2percent\"])",
            "",
            "        self.fields.keyOrder = [\"airPressure\", \"co2percent\", \"humidity\", \"temperature\"]",
            "",
            "",
            "class MetadataStageLabelForm(forms.Form):",
            "    def __init__(self, *args, **kwargs):",
            "        super(MetadataStageLabelForm, self).__init__(*args, **kwargs)",
            "",
            "        # Stage label",
            "",
            "        # Position x",
            "        try:",
            "            if kwargs[\"initial\"][\"image\"].getStageLabel() is not None:",
            "                self.fields[\"positionx\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionx\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"image\"].getStageLabel().positionx,",
            "                    label=\"Position X\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"positionx\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionx\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Position X\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"positionx\"])",
            "        except Exception:",
            "            self.fields[\"positionx\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Position X\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"positionx\"])",
            "",
            "        # Position y",
            "        try:",
            "            if kwargs[\"initial\"][\"image\"].getStageLabel() is not None:",
            "                self.fields[\"positiony\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positiony\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"image\"].getStageLabel().positiony,",
            "                    label=\"Position Y\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"positiony\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positiony\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Position Y\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"positiony\"])",
            "        except Exception:",
            "            self.fields[\"positiony\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Position Y\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"positionx\"])",
            "",
            "        # Position z",
            "        try:",
            "            if kwargs[\"initial\"][\"image\"].getStageLabel() is not None:",
            "                self.fields[\"positionz\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionz\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    initial=kwargs[\"initial\"][\"image\"].getStageLabel().positionz,",
            "                    label=\"Position Z\",",
            "                    required=False,",
            "                )",
            "            else:",
            "                self.fields[\"positionz\"] = forms.CharField(",
            "                    max_length=100,",
            "                    widget=forms.TextInput(",
            "                        attrs={",
            "                            \"size\": 25,",
            "                            \"onchange\": save_metadata(",
            "                                kwargs[\"initial\"][\"image\"].id, \"positionz\"",
            "                            ),",
            "                        }",
            "                    ),",
            "                    label=\"Position Z\",",
            "                    required=False,",
            "                )",
            "            set_widget_attrs(self.fields[\"positionz\"])",
            "        except Exception:",
            "            self.fields[\"positionz\"] = forms.CharField(",
            "                max_length=100,",
            "                widget=forms.TextInput(attrs={\"size\": 25}),",
            "                initial=\"N/A\",",
            "                label=\"Position Z\",",
            "                required=False,",
            "            )",
            "            set_widget_attrs(self.fields[\"positionz\"])",
            "",
            "        self.fields.keyOrder = [\"positionx\", \"positiony\", \"positionz\"]"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "40": [],
            "130": [
                "BasketShareForm"
            ],
            "131": [
                "BasketShareForm",
                "__init__"
            ],
            "132": [
                "BasketShareForm",
                "__init__"
            ],
            "133": [
                "BasketShareForm",
                "__init__"
            ],
            "134": [
                "BasketShareForm",
                "__init__"
            ],
            "135": [
                "BasketShareForm",
                "__init__"
            ],
            "136": [
                "BasketShareForm",
                "__init__"
            ],
            "137": [
                "BasketShareForm",
                "__init__"
            ],
            "138": [
                "BasketShareForm",
                "__init__"
            ],
            "139": [
                "BasketShareForm",
                "__init__"
            ],
            "140": [
                "BasketShareForm",
                "__init__"
            ],
            "141": [
                "BasketShareForm",
                "__init__"
            ],
            "142": [
                "BasketShareForm",
                "__init__"
            ],
            "143": [
                "BasketShareForm",
                "__init__"
            ],
            "144": [
                "BasketShareForm",
                "__init__"
            ],
            "145": [],
            "146": []
        },
        "addLocation": []
    },
    "omeroweb/webclient/views.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 35,
                "PatchRowcode": " import warnings"
            },
            "1": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " from past.builtins import unicode"
            },
            "2": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " from future.utils import bytes_to_native_str"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+from django.utils.http import is_safe_url"
            },
            "4": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " from time import time"
            },
            "6": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 41,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": 68,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 69,
                "PatchRowcode": " from omeroweb.webclient.webclient_utils import _formatReport, _purgeCallback"
            },
            "9": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 70,
                "PatchRowcode": " from .forms import GlobalSearchForm, ContainerForm"
            },
            "10": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from .forms import ShareForm, BasketShareForm"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+from .forms import ShareForm"
            },
            "12": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 72,
                "PatchRowcode": " from .forms import ContainerNameForm, ContainerDescriptionForm"
            },
            "13": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 73,
                "PatchRowcode": " from .forms import CommentAnnotationForm, TagsAnnotationForm"
            },
            "14": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 74,
                "PatchRowcode": " from .forms import MetadataFilterForm, MetadataDetectorForm"
            },
            "15": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 177,
                "PatchRowcode": "     return toBoolean(request.GET.get(name, default))"
            },
            "16": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": 178,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": 179,
                "PatchRowcode": " "
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 180,
                "PatchRowcode": "+def validate_redirect_url(url):"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 181,
                "PatchRowcode": "+    \"\"\""
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+    Returns a URL is safe to redirect to."
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 183,
                "PatchRowcode": "+    If url is a different host, not in settings.REDIRECT_ALLOWED_HOSTS"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 184,
                "PatchRowcode": "+    we return webclient index URL."
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 185,
                "PatchRowcode": "+    \"\"\""
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 186,
                "PatchRowcode": "+    if not is_safe_url(url, allowed_hosts=settings.REDIRECT_ALLOWED_HOSTS):"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 187,
                "PatchRowcode": "+        url = reverse(\"webindex\")"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 188,
                "PatchRowcode": "+    return url"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 189,
                "PatchRowcode": "+"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 190,
                "PatchRowcode": "+"
            },
            "29": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 191,
                "PatchRowcode": " ##############################################################################"
            },
            "30": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 192,
                "PatchRowcode": " # custom index page"
            },
            "31": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 193,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 257,
                "afterPatchRowNumber": 269,
                "PatchRowcode": "                 url = parse_url(settings.LOGIN_REDIRECT)"
            },
            "33": {
                "beforePatchRowNumber": 258,
                "afterPatchRowNumber": 270,
                "PatchRowcode": "             except Exception:"
            },
            "34": {
                "beforePatchRowNumber": 259,
                "afterPatchRowNumber": 271,
                "PatchRowcode": "                 url = reverse(\"webindex\")"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 272,
                "PatchRowcode": "+        else:"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 273,
                "PatchRowcode": "+            url = validate_redirect_url(url)"
            },
            "37": {
                "beforePatchRowNumber": 260,
                "afterPatchRowNumber": 274,
                "PatchRowcode": "         return HttpResponseRedirect(url)"
            },
            "38": {
                "beforePatchRowNumber": 261,
                "afterPatchRowNumber": 275,
                "PatchRowcode": " "
            },
            "39": {
                "beforePatchRowNumber": 262,
                "afterPatchRowNumber": 276,
                "PatchRowcode": "     def handle_not_logged_in(self, request, error=None, form=None):"
            },
            "40": {
                "beforePatchRowNumber": 335,
                "afterPatchRowNumber": 349,
                "PatchRowcode": "     \"\"\""
            },
            "41": {
                "beforePatchRowNumber": 336,
                "afterPatchRowNumber": 350,
                "PatchRowcode": "     switch_active_group(request)"
            },
            "42": {
                "beforePatchRowNumber": 337,
                "afterPatchRowNumber": 351,
                "PatchRowcode": "     url = url or reverse(\"webindex\")"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 352,
                "PatchRowcode": "+    url = validate_redirect_url(url)"
            },
            "44": {
                "beforePatchRowNumber": 338,
                "afterPatchRowNumber": 353,
                "PatchRowcode": "     return HttpResponseRedirect(url)"
            },
            "45": {
                "beforePatchRowNumber": 339,
                "afterPatchRowNumber": 354,
                "PatchRowcode": " "
            },
            "46": {
                "beforePatchRowNumber": 340,
                "afterPatchRowNumber": 355,
                "PatchRowcode": " "
            },
            "47": {
                "beforePatchRowNumber": 534,
                "afterPatchRowNumber": 549,
                "PatchRowcode": "     context[\"thumbnails_batch\"] = settings.THUMBNAILS_BATCH"
            },
            "48": {
                "beforePatchRowNumber": 535,
                "afterPatchRowNumber": 550,
                "PatchRowcode": "     context[\"current_admin_privileges\"] = conn.getCurrentAdminPrivileges()"
            },
            "49": {
                "beforePatchRowNumber": 536,
                "afterPatchRowNumber": 551,
                "PatchRowcode": "     context[\"leader_of_groups\"] = conn.getEventContext().leaderOfGroups"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 552,
                "PatchRowcode": "+    context[\"member_of_groups\"] = conn.getEventContext().memberOfGroups"
            },
            "51": {
                "beforePatchRowNumber": 537,
                "afterPatchRowNumber": 553,
                "PatchRowcode": " "
            },
            "52": {
                "beforePatchRowNumber": 538,
                "afterPatchRowNumber": 554,
                "PatchRowcode": "     return context"
            },
            "53": {
                "beforePatchRowNumber": 539,
                "afterPatchRowNumber": 555,
                "PatchRowcode": " "
            },
            "54": {
                "beforePatchRowNumber": 2871,
                "afterPatchRowNumber": 2887,
                "PatchRowcode": "                 d.update({e[0]: unicode(e[1])})"
            },
            "55": {
                "beforePatchRowNumber": 2872,
                "afterPatchRowNumber": 2888,
                "PatchRowcode": "             rdict = {\"bad\": \"true\", \"errs\": d}"
            },
            "56": {
                "beforePatchRowNumber": 2873,
                "afterPatchRowNumber": 2889,
                "PatchRowcode": "             return JsonResponse(rdict)"
            },
            "57": {
                "beforePatchRowNumber": 2874,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    elif action == \"add\":"
            },
            "58": {
                "beforePatchRowNumber": 2875,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        template = \"webclient/public/share_form.html\""
            },
            "59": {
                "beforePatchRowNumber": 2876,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        experimenters = list(conn.getExperimenters())"
            },
            "60": {
                "beforePatchRowNumber": 2877,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        experimenters.sort(key=lambda x: x.getOmeName().lower())"
            },
            "61": {
                "beforePatchRowNumber": 2878,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if o_type == \"share\":"
            },
            "62": {
                "beforePatchRowNumber": 2879,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            img_ids = request.GET.getlist(\"image\", request.POST.getlist(\"image\"))"
            },
            "63": {
                "beforePatchRowNumber": 2880,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if request.method == \"GET\" and len(img_ids) == 0:"
            },
            "64": {
                "beforePatchRowNumber": 2881,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                return HttpResponse(\"No images specified\")"
            },
            "65": {
                "beforePatchRowNumber": 2882,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            images_to_share = list(conn.getObjects(\"Image\", img_ids))"
            },
            "66": {
                "beforePatchRowNumber": 2883,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            if request.method == \"POST\":"
            },
            "67": {
                "beforePatchRowNumber": 2884,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                form = BasketShareForm("
            },
            "68": {
                "beforePatchRowNumber": 2885,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    initial={\"experimenters\": experimenters, \"images\": images_to_share},"
            },
            "69": {
                "beforePatchRowNumber": 2886,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    data=request.POST.copy(),"
            },
            "70": {
                "beforePatchRowNumber": 2887,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                )"
            },
            "71": {
                "beforePatchRowNumber": 2888,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                if form.is_valid():"
            },
            "72": {
                "beforePatchRowNumber": 2889,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    images = form.cleaned_data[\"image\"]"
            },
            "73": {
                "beforePatchRowNumber": 2890,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    message = form.cleaned_data[\"message\"]"
            },
            "74": {
                "beforePatchRowNumber": 2891,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    expiration = form.cleaned_data[\"expiration\"]"
            },
            "75": {
                "beforePatchRowNumber": 2892,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    members = form.cleaned_data[\"members\"]"
            },
            "76": {
                "beforePatchRowNumber": 2893,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    # guests = request.POST['guests']"
            },
            "77": {
                "beforePatchRowNumber": 2894,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    enable = form.cleaned_data[\"enable\"]"
            },
            "78": {
                "beforePatchRowNumber": 2895,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    host = \"%s?server=%i\" % ("
            },
            "79": {
                "beforePatchRowNumber": 2896,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        request.build_absolute_uri("
            },
            "80": {
                "beforePatchRowNumber": 2897,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                            reverse(\"load_template\", args=[\"public\"])"
            },
            "81": {
                "beforePatchRowNumber": 2898,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        ),"
            },
            "82": {
                "beforePatchRowNumber": 2899,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        int(conn.server_id),"
            },
            "83": {
                "beforePatchRowNumber": 2900,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    )"
            },
            "84": {
                "beforePatchRowNumber": 2901,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    shareId = manager.createShare("
            },
            "85": {
                "beforePatchRowNumber": 2902,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                        host, images, message, members, enable, expiration"
            },
            "86": {
                "beforePatchRowNumber": 2903,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    )"
            },
            "87": {
                "beforePatchRowNumber": 2904,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    return HttpResponse(\"shareId:%s\" % shareId)"
            },
            "88": {
                "beforePatchRowNumber": 2905,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            else:"
            },
            "89": {
                "beforePatchRowNumber": 2906,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                initial = {"
            },
            "90": {
                "beforePatchRowNumber": 2907,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    \"experimenters\": experimenters,"
            },
            "91": {
                "beforePatchRowNumber": 2908,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    \"images\": images_to_share,"
            },
            "92": {
                "beforePatchRowNumber": 2909,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    \"enable\": True,"
            },
            "93": {
                "beforePatchRowNumber": 2910,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    \"selected\": request.GET.getlist(\"image\"),"
            },
            "94": {
                "beforePatchRowNumber": 2911,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                }"
            },
            "95": {
                "beforePatchRowNumber": 2912,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                form = BasketShareForm(initial=initial)"
            },
            "96": {
                "beforePatchRowNumber": 2913,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        template = \"webclient/public/share_form.html\""
            },
            "97": {
                "beforePatchRowNumber": 2914,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        context = {\"manager\": manager, \"form\": form}"
            },
            "98": {
                "beforePatchRowNumber": 2915,
                "afterPatchRowNumber": 2890,
                "PatchRowcode": " "
            },
            "99": {
                "beforePatchRowNumber": 2916,
                "afterPatchRowNumber": 2891,
                "PatchRowcode": "     elif action == \"edit\":"
            },
            "100": {
                "beforePatchRowNumber": 2917,
                "afterPatchRowNumber": 2892,
                "PatchRowcode": "         # form for editing Shares only"
            }
        },
        "frontPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "",
            "# Copyright (C) 2008-2020 University of Dundee & Open Microscopy Environment.",
            "# All rights reserved.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\" A view functions is simply a Python function that takes a Web request and",
            "returns a Web response. This response can be the HTML contents of a Web page,",
            "or a redirect, or the 404 and 500 error, or an XML document, or an image...",
            "or anything.\"\"\"",
            "",
            "import copy",
            "import os",
            "import datetime",
            "import Ice",
            "from Ice import Exception as IceException",
            "import logging",
            "import traceback",
            "import json",
            "import re",
            "import sys",
            "import warnings",
            "from past.builtins import unicode",
            "from future.utils import bytes_to_native_str",
            "",
            "from time import time",
            "",
            "from omeroweb.version import omeroweb_buildyear as build_year",
            "from omeroweb.version import omeroweb_version as omero_version",
            "",
            "import omero",
            "import omero.scripts",
            "from omero.rtypes import wrap, unwrap, rlong, rlist",
            "",
            "from omero.gateway.utils import toBoolean",
            "",
            "from django.conf import settings",
            "from django.template import loader as template_loader",
            "from django.http import (",
            "    Http404,",
            "    HttpResponse,",
            "    HttpResponseRedirect,",
            "    JsonResponse,",
            "    HttpResponseForbidden,",
            ")",
            "from django.http import HttpResponseServerError, HttpResponseBadRequest",
            "from django.utils.http import urlencode",
            "from django.core.urlresolvers import reverse, NoReverseMatch",
            "from django.utils.encoding import smart_str",
            "from django.views.decorators.cache import never_cache",
            "from django.views.decorators.http import require_POST",
            "from django.shortcuts import render",
            "",
            "",
            "from omeroweb.webclient.webclient_utils import _formatReport, _purgeCallback",
            "from .forms import GlobalSearchForm, ContainerForm",
            "from .forms import ShareForm, BasketShareForm",
            "from .forms import ContainerNameForm, ContainerDescriptionForm",
            "from .forms import CommentAnnotationForm, TagsAnnotationForm",
            "from .forms import MetadataFilterForm, MetadataDetectorForm",
            "from .forms import MetadataChannelForm, MetadataEnvironmentForm",
            "from .forms import MetadataObjectiveForm, MetadataObjectiveSettingsForm",
            "from .forms import MetadataStageLabelForm, MetadataLightSourceForm",
            "from .forms import MetadataDichroicForm, MetadataMicroscopeForm",
            "from .forms import FilesAnnotationForm, WellIndexForm, NewTagsAnnotationFormSet",
            "",
            "from .controller.container import BaseContainer",
            "from .controller.history import BaseCalendar",
            "from .controller.search import BaseSearch",
            "from .controller.share import BaseShare",
            "",
            "from omeroweb.webadmin.forms import LoginForm",
            "",
            "from omeroweb.webgateway import views as webgateway_views",
            "from omeroweb.webgateway.marshal import graphResponseMarshal",
            "from omeroweb.webgateway.util import get_longs as webgateway_get_longs",
            "",
            "from omeroweb.feedback.views import handlerInternalError",
            "",
            "from omeroweb.webclient.decorators import login_required",
            "from omeroweb.webclient.decorators import render_response",
            "from omeroweb.webclient.show import (",
            "    Show,",
            "    IncorrectMenuError,",
            "    paths_to_object,",
            "    paths_to_tag,",
            ")",
            "from omeroweb.decorators import (",
            "    ConnCleaningHttpResponse,",
            "    parse_url,",
            "    TableClosingHttpResponse,",
            ")",
            "from omeroweb.webgateway.util import getIntOrDefault",
            "",
            "from omero.model import (",
            "    AnnotationAnnotationLinkI,",
            "    DatasetI,",
            "    DatasetImageLinkI,",
            "    ExperimenterI,",
            "    ImageI,",
            "    OriginalFileI,",
            "    PlateI,",
            "    ProjectI,",
            "    ProjectDatasetLinkI,",
            "    ScreenI,",
            "    ScreenPlateLinkI,",
            "    TagAnnotationI,",
            ")",
            "from omero import ApiUsageException, ServerError, CmdError",
            "from omeroweb.webgateway.views import LoginView",
            "",
            "from . import tree",
            "",
            "try:",
            "    import long",
            "except ImportError:",
            "    long = int",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "logger.info(\"INIT '%s'\" % os.getpid())",
            "",
            "# We want to allow a higher default limit for annotations so we can load",
            "# all the annotations expected for a PAGE of images",
            "ANNOTATIONS_LIMIT = settings.PAGE * 100",
            "",
            "",
            "def get_long_or_default(request, name, default):",
            "    \"\"\"",
            "    Retrieves a parameter from the request. If the parameter is not present",
            "    the default is returned",
            "",
            "    This does not catch exceptions as it makes sense to throw exceptions if",
            "    the arguments provided do not pass basic type validation",
            "    \"\"\"",
            "    val = None",
            "    val_raw = request.GET.get(name, default)",
            "    if val_raw is not None:",
            "        val = long(val_raw)",
            "    return val",
            "",
            "",
            "def get_list(request, name):",
            "    val = request.GET.getlist(name)",
            "    return [i for i in val if i != \"\"]",
            "",
            "",
            "def get_longs(request, name):",
            "    warnings.warn(",
            "        \"Deprecated. Use omeroweb.webgateway.util.get_longs()\", DeprecationWarning",
            "    )",
            "    return webgateway_get_longs(request, name)",
            "",
            "",
            "def get_bool_or_default(request, name, default):",
            "    \"\"\"",
            "    Retrieves a parameter from the request. If the parameter is not present",
            "    the default is returned",
            "",
            "    This does not catch exceptions as it makes sense to throw exceptions if",
            "    the arguments provided do not pass basic type validation",
            "    \"\"\"",
            "    return toBoolean(request.GET.get(name, default))",
            "",
            "",
            "##############################################################################",
            "# custom index page",
            "",
            "",
            "@never_cache",
            "@render_response()",
            "def custom_index(request, conn=None, **kwargs):",
            "    context = {\"version\": omero_version, \"build_year\": build_year}",
            "",
            "    if settings.INDEX_TEMPLATE is not None:",
            "        try:",
            "            template_loader.get_template(settings.INDEX_TEMPLATE)",
            "            context[\"template\"] = settings.INDEX_TEMPLATE",
            "        except Exception:",
            "            context[\"template\"] = \"webclient/index.html\"",
            "            context[\"error\"] = traceback.format_exception(*sys.exc_info())[-1]",
            "    else:",
            "        context[\"template\"] = \"webclient/index.html\"",
            "",
            "    return context",
            "",
            "",
            "##############################################################################",
            "# views",
            "",
            "",
            "class WebclientLoginView(LoginView):",
            "    \"\"\"",
            "    Webclient Login - Customises the superclass LoginView",
            "    for webclient. Also can be used by other Apps to log in to OMERO. Uses",
            "    the 'server' id from request to lookup the server-id (index), host and",
            "    port from settings. E.g. \"localhost\", 4064. Stores these details, along",
            "    with username, password etc in the request.session. Resets other data",
            "    parameters in the request.session. Tries to get connection to OMERO and",
            "    if this works, then we are redirected to the 'index' page or url",
            "    specified in REQUEST. If we can't connect, the login page is returned",
            "    with appropriate error messages.",
            "    \"\"\"",
            "",
            "    template = \"webclient/login.html\"",
            "    useragent = \"OMERO.web\"",
            "",
            "    def get(self, request):",
            "        \"\"\"",
            "        GET simply returns the login page",
            "        \"\"\"",
            "        return self.handle_not_logged_in(request)",
            "",
            "    def handle_logged_in(self, request, conn, connector):",
            "        \"\"\"",
            "        We override this to provide webclient-specific functionality",
            "        such as cleaning up any previous sessions (if user didn't logout)",
            "        and redirect to specified url or webclient index page.",
            "        \"\"\"",
            "",
            "        # webclient has various state that needs cleaning up...",
            "        # if 'active_group' remains in session from previous",
            "        # login, check it's valid for this user",
            "        # NB: we do this for public users in @login_required.get_connection()",
            "        if request.session.get(\"active_group\"):",
            "            if (",
            "                request.session.get(\"active_group\")",
            "                not in conn.getEventContext().memberOfGroups",
            "            ):",
            "                del request.session[\"active_group\"]",
            "        if request.session.get(\"user_id\"):",
            "            # always want to revert to logged-in user",
            "            del request.session[\"user_id\"]",
            "        if request.session.get(\"server_settings\"):",
            "            # always clean when logging in",
            "            del request.session[\"server_settings\"]",
            "        # do we ned to display server version ?",
            "        # server_version = conn.getServerVersion()",
            "        if request.POST.get(\"noredirect\"):",
            "            return HttpResponse(\"OK\")",
            "        url = request.GET.get(\"url\")",
            "        if url is None or len(url) == 0:",
            "            try:",
            "                url = parse_url(settings.LOGIN_REDIRECT)",
            "            except Exception:",
            "                url = reverse(\"webindex\")",
            "        return HttpResponseRedirect(url)",
            "",
            "    def handle_not_logged_in(self, request, error=None, form=None):",
            "        \"\"\"",
            "        Returns a response for failed login.",
            "        Reason for failure may be due to server 'error' or because",
            "        of form validation errors.",
            "",
            "        @param request:     http request",
            "        @param error:       Error message",
            "        @param form:        Instance of Login Form, populated with data",
            "        \"\"\"",
            "        if form is None:",
            "            server_id = request.GET.get(\"server\", request.POST.get(\"server\"))",
            "            if server_id is not None:",
            "                initial = {\"server\": unicode(server_id)}",
            "                form = LoginForm(initial=initial)",
            "            else:",
            "                form = LoginForm()",
            "        context = {",
            "            \"version\": omero_version,",
            "            \"build_year\": build_year,",
            "            \"error\": error,",
            "            \"form\": form,",
            "        }",
            "        url = request.GET.get(\"url\")",
            "        if url is not None and len(url) != 0:",
            "            context[\"url\"] = urlencode({\"url\": url})",
            "",
            "        if hasattr(settings, \"LOGIN_LOGO\"):",
            "            context[\"LOGIN_LOGO\"] = settings.LOGIN_LOGO",
            "",
            "        if settings.PUBLIC_ENABLED:",
            "            redirect = reverse(\"webindex\")",
            "            if settings.PUBLIC_URL_FILTER.search(redirect):",
            "                context[\"public_enabled\"] = True",
            "                context[\"public_login_redirect\"] = redirect",
            "",
            "        context[\"show_download_links\"] = settings.SHOW_CLIENT_DOWNLOADS",
            "        if settings.SHOW_CLIENT_DOWNLOADS:",
            "            ver = re.match(",
            "                (",
            "                    r\"(?P<major>\\d+)\\.\"",
            "                    r\"(?P<minor>\\d+)\\.\"",
            "                    r\"(?P<patch>\\d+\\.?)?\"",
            "                    r\"(?P<dev>(dev|a|b|rc)\\d+)?.*\"",
            "                ),",
            "                omero_version,",
            "            )",
            "            client_download_tag_re = \"^v%s\\\\.%s\\\\.[^-]+$\" % (",
            "                ver.group(\"major\"),",
            "                ver.group(\"minor\"),",
            "            )",
            "            context[\"client_download_tag_re\"] = client_download_tag_re",
            "            context[\"client_download_repo\"] = settings.CLIENT_DOWNLOAD_GITHUB_REPO",
            "",
            "        return render(request, self.template, context)",
            "",
            "",
            "@login_required(ignore_login_fail=True)",
            "def keepalive_ping(request, conn=None, **kwargs):",
            "    \"\"\" Keeps the OMERO session alive by pinging the server \"\"\"",
            "",
            "    # login_required handles ping, timeout etc, so we don't need to do",
            "    # anything else",
            "    return HttpResponse(\"OK\")",
            "",
            "",
            "@login_required()",
            "def change_active_group(request, conn=None, url=None, **kwargs):",
            "    \"\"\"",
            "    Simply changes the request.session['active_group'] which is then used by",
            "    the @login_required decorator to configure conn for any group-based",
            "    queries.",
            "    Finally this redirects to the 'url'.",
            "    \"\"\"",
            "    switch_active_group(request)",
            "    url = url or reverse(\"webindex\")",
            "    return HttpResponseRedirect(url)",
            "",
            "",
            "def switch_active_group(request, active_group=None):",
            "    \"\"\"",
            "    Simply changes the request.session['active_group'] which is then used by",
            "    the @login_required decorator to configure conn for any group-based",
            "    queries.",
            "    \"\"\"",
            "    if active_group is None:",
            "        active_group = request.GET.get(\"active_group\")",
            "    active_group = int(active_group)",
            "    if (",
            "        \"active_group\" not in request.session",
            "        or active_group != request.session[\"active_group\"]",
            "    ):",
            "        request.session.modified = True",
            "        request.session[\"active_group\"] = active_group",
            "",
            "",
            "def fake_experimenter(request, default_name=\"All members\"):",
            "    \"\"\"",
            "    Marshal faked experimenter when id is -1",
            "    Load omero.client.ui.menu.dropdown.everyone.label as username",
            "    \"\"\"",
            "    label = (",
            "        request.session.get(\"server_settings\")",
            "        .get(\"ui\", {})",
            "        .get(\"menu\", {})",
            "        .get(\"dropdown\", {})",
            "        .get(\"everyone\", {})",
            "        .get(\"label\", default_name)",
            "    )",
            "    return {",
            "        \"id\": -1,",
            "        \"omeName\": label,",
            "        \"firstName\": label,",
            "        \"lastName\": \"\",",
            "    }",
            "",
            "",
            "@login_required(login_redirect=\"webindex\")",
            "def logout(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Logout of the session and redirects to the homepage (will redirect to",
            "    login first)",
            "    \"\"\"",
            "",
            "    if request.method == \"POST\":",
            "        try:",
            "            try:",
            "                conn.close()",
            "            except Exception:",
            "                logger.error(\"Exception during logout.\", exc_info=True)",
            "        finally:",
            "            request.session.flush()",
            "        return HttpResponseRedirect(reverse(settings.LOGIN_VIEW))",
            "    else:",
            "        context = {\"url\": reverse(\"weblogout\"), \"submit\": \"Do you want to log out?\"}",
            "        template = \"webgateway/base/includes/post_form.html\"",
            "        return render(request, template, context)",
            "",
            "",
            "###########################################################################",
            "def _load_template(request, menu, conn=None, url=None, **kwargs):",
            "",
            "    \"\"\"",
            "    This view handles most of the top-level pages, as specified by 'menu' E.g.",
            "    userdata, usertags, history, search etc.",
            "    Query string 'path' that specifies an object to display in the data tree",
            "    is parsed.",
            "    We also prepare the list of users in the current group, for the",
            "    switch-user form. Change-group form is also prepared.",
            "    \"\"\"",
            "    request.session.modified = True",
            "",
            "    template = kwargs.get(\"template\", None)",
            "    if template is None:",
            "        if menu == \"userdata\":",
            "            template = \"webclient/data/containers.html\"",
            "        elif menu == \"usertags\":",
            "            template = \"webclient/data/containers.html\"",
            "        else:",
            "            # E.g. search/search.html",
            "            template = \"webclient/%s/%s.html\" % (menu, menu)",
            "",
            "    # tree support",
            "    show = kwargs.get(\"show\", Show(conn, request, menu))",
            "    # Constructor does no loading.  Show.first_selected must be called first",
            "    # in order to set up our initial state correctly.",
            "    try:",
            "        first_sel = show.first_selected",
            "    except IncorrectMenuError as e:",
            "        return HttpResponseRedirect(e.uri)",
            "    # We get the owner of the top level object, E.g. Project",
            "    # Actual api_paths_to_object() is retrieved by jsTree once loaded",
            "    initially_open_owner = show.initially_open_owner",
            "",
            "    # If we failed to find 'show'...",
            "    if request.GET.get(\"show\", None) is not None and first_sel is None:",
            "        # and we're logged in as PUBLIC user...",
            "        if (",
            "            settings.PUBLIC_ENABLED",
            "            and settings.PUBLIC_USER == conn.getUser().getOmeName()",
            "        ):",
            "            # this is likely a regular user who needs to log in as themselves.",
            "            # Login then redirect to current url",
            "            return HttpResponseRedirect(\"%s?url=%s\" % (reverse(\"weblogin\"), url))",
            "",
            "    # need to be sure that tree will be correct omero.group",
            "    if first_sel is not None:",
            "        switch_active_group(request, first_sel.details.group.id.val)",
            "",
            "    # search support",
            "    init = {}",
            "    global_search_form = GlobalSearchForm(data=request.GET.copy())",
            "    if menu == \"search\":",
            "        if global_search_form.is_valid():",
            "            init[\"query\"] = global_search_form.cleaned_data[\"search_query\"]",
            "",
            "    # get url without request string - used to refresh page after switch",
            "    # user/group etc",
            "    url = kwargs.get(\"load_template_url\", None)",
            "    if url is None:",
            "        url = reverse(viewname=\"load_template\", args=[menu])",
            "",
            "    # validate experimenter is in the active group",
            "    active_group = request.session.get(\"active_group\") or conn.getEventContext().groupId",
            "    # prepare members of group...",
            "    leaders, members = conn.getObject(\"ExperimenterGroup\", active_group).groupSummary()",
            "    userIds = [u.id for u in leaders]",
            "    userIds.extend([u.id for u in members])",
            "",
            "    # check any change in experimenter...",
            "    user_id = request.GET.get(\"experimenter\")",
            "    if initially_open_owner is not None:",
            "        if request.session.get(\"user_id\", None) != -1:",
            "            # if we're not already showing 'All Members'...",
            "            user_id = initially_open_owner",
            "    try:",
            "        user_id = long(user_id)",
            "    except Exception:",
            "        user_id = None",
            "    # check if user_id is in a currnt group",
            "    if user_id is not None:",
            "        if (",
            "            user_id",
            "            not in (",
            "                set(map(lambda x: x.id, leaders)) | set(map(lambda x: x.id, members))",
            "            )",
            "            and user_id != -1",
            "        ):",
            "            # All users in group is allowed",
            "            user_id = None",
            "    if user_id is None:",
            "        # ... or check that current user is valid in active group",
            "        user_id = request.session.get(\"user_id\", None)",
            "        if user_id is None or int(user_id) not in userIds:",
            "            if user_id != -1:  # All users in group is allowed",
            "                user_id = conn.getEventContext().userId",
            "",
            "    request.session[\"user_id\"] = user_id",
            "",
            "    myGroups = list(conn.getGroupsMemberOf())",
            "    myGroups.sort(key=lambda x: x.getName().lower())",
            "    groups = myGroups",
            "",
            "    new_container_form = ContainerForm()",
            "",
            "    # colleagues required for search.html page only.",
            "    myColleagues = {}",
            "    if menu == \"search\":",
            "        for g in groups:",
            "            g.loadLeadersAndMembers()",
            "            for c in g.leaders + g.colleagues:",
            "                myColleagues[c.id] = c",
            "        myColleagues = list(myColleagues.values())",
            "        myColleagues.sort(key=lambda x: x.getLastName().lower())",
            "",
            "    context = {",
            "        \"menu\": menu,",
            "        \"init\": init,",
            "        \"myGroups\": myGroups,",
            "        \"new_container_form\": new_container_form,",
            "        \"global_search_form\": global_search_form,",
            "    }",
            "    context[\"groups\"] = groups",
            "    context[\"myColleagues\"] = myColleagues",
            "    context[\"active_group\"] = conn.getObject(\"ExperimenterGroup\", long(active_group))",
            "    context[\"active_user\"] = conn.getObject(\"Experimenter\", long(user_id))",
            "    context[\"initially_select\"] = show.initially_select",
            "    context[\"initially_open\"] = show.initially_open",
            "    context[\"isLeader\"] = conn.isLeader()",
            "    context[\"current_url\"] = url",
            "    context[\"page_size\"] = settings.PAGE",
            "    context[\"template\"] = template",
            "    context[\"thumbnails_batch\"] = settings.THUMBNAILS_BATCH",
            "    context[\"current_admin_privileges\"] = conn.getCurrentAdminPrivileges()",
            "    context[\"leader_of_groups\"] = conn.getEventContext().leaderOfGroups",
            "",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_template(request, menu, conn=None, url=None, **kwargs):",
            "    return _load_template(request=request, menu=menu, conn=conn, url=url, **kwargs)",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def group_user_content(request, url=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Loads html content of the Groups/Users drop-down menu on main webclient",
            "    pages.",
            "    Url should be supplied in request, as target for redirect after switching",
            "    group.",
            "    \"\"\"",
            "",
            "    myGroups = list(conn.getGroupsMemberOf())",
            "    myGroups.sort(key=lambda x: x.getName().lower())",
            "    if conn.isAdmin():  # Admin can see all groups",
            "        system_groups = [",
            "            conn.getAdminService().getSecurityRoles().userGroupId,",
            "            conn.getAdminService().getSecurityRoles().guestGroupId,",
            "        ]",
            "        groups = conn.getObjects(\"ExperimenterGroup\", opts={\"load_experimenters\": True})",
            "        groups = [g for g in groups if g.getId() not in system_groups]",
            "        groups.sort(key=lambda x: x.getName().lower())",
            "    else:",
            "        groups = myGroups",
            "",
            "    for g in groups:",
            "        g.loadLeadersAndMembers()  # load leaders / members",
            "",
            "    context = {",
            "        \"template\": \"webclient/base/includes/group_user_content.html\",",
            "        \"current_url\": url,",
            "        \"groups\": groups,",
            "        \"myGroups\": myGroups,",
            "    }",
            "    return context",
            "",
            "",
            "@login_required()",
            "def api_group_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        member_id = get_long_or_default(request, \"member\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    try:",
            "        # Get the groups",
            "        groups = tree.marshal_groups(",
            "            conn=conn, member_id=member_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"groups\": groups})",
            "",
            "",
            "@login_required()",
            "def api_experimenter_detail(request, experimenter_id, conn=None, **kwargs):",
            "    # Validate parameter",
            "    try:",
            "        experimenter_id = long(experimenter_id)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid experimenter id\")",
            "",
            "    try:",
            "        # Get the experimenter",
            "        if experimenter_id < 0:",
            "            experimenter = fake_experimenter(request)",
            "        else:",
            "            # Get the experimenter",
            "            experimenter = tree.marshal_experimenter(",
            "                conn=conn, experimenter_id=experimenter_id",
            "            )",
            "            if experimenter is None:",
            "                raise Http404(\"No Experimenter found with ID %s\" % experimenter_id)",
            "        return JsonResponse({\"experimenter\": experimenter})",
            "",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "",
            "@login_required()",
            "def api_container_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        experimenter_id = get_long_or_default(request, \"id\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    # While this interface does support paging, it does so in a",
            "    # very odd way. The results per page is enforced per query so this",
            "    # will actually get the limit for projects, datasets (without",
            "    # parents), screens and plates (without parents). This is fine for",
            "    # the first page, but the second page may not be what is expected.",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    r = dict()",
            "    try:",
            "        # Get the projects",
            "        r[\"projects\"] = tree.marshal_projects(",
            "            conn=conn,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "",
            "        # Get the orphaned datasets (without project parents)",
            "        r[\"datasets\"] = tree.marshal_datasets(",
            "            conn=conn,",
            "            orphaned=True,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "",
            "        # Get the screens for the current user",
            "        r[\"screens\"] = tree.marshal_screens(",
            "            conn=conn,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "",
            "        # Get the orphaned plates (without project parents)",
            "        r[\"plates\"] = tree.marshal_plates(",
            "            conn=conn,",
            "            orphaned=True,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "        # Get the orphaned images container",
            "        try:",
            "            orph_t = request.session[\"server_settings\"][\"ui\"][\"tree\"][\"orphans\"]",
            "        except Exception:",
            "            orph_t = {\"enabled\": True}",
            "        if (",
            "            conn.isAdmin()",
            "            or conn.isLeader(gid=request.session.get(\"active_group\"))",
            "            or experimenter_id == conn.getUserId()",
            "            or orph_t.get(\"enabled\", True)",
            "        ):",
            "",
            "            orphaned = tree.marshal_orphaned(",
            "                conn=conn,",
            "                group_id=group_id,",
            "                experimenter_id=experimenter_id,",
            "                page=page,",
            "                limit=limit,",
            "            )",
            "            orphaned[\"name\"] = orph_t.get(\"name\", \"Orphaned Images\")",
            "            r[\"orphaned\"] = orphaned",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse(r)",
            "",
            "",
            "@login_required()",
            "def api_dataset_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        project_id = get_long_or_default(request, \"id\", None)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    try:",
            "        # Get the datasets",
            "        datasets = tree.marshal_datasets(",
            "            conn=conn, project_id=project_id, group_id=group_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"datasets\": datasets})",
            "",
            "",
            "@login_required()",
            "def api_image_list(request, conn=None, **kwargs):",
            "    \"\"\"Get a list of images",
            "    Specifiying dataset_id will return only images in that dataset",
            "    Specifying experimenter_id will return orpahned images for that",
            "    user",
            "    The orphaned images will include images which belong to the user",
            "    but are not in any dataset belonging to the user",
            "    Currently specifying both, experimenter_id will be ignored",
            "",
            "    \"\"\"",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        dataset_id = get_long_or_default(request, \"id\", None)",
            "        orphaned = get_bool_or_default(request, \"orphaned\", False)",
            "        load_pixels = get_bool_or_default(request, \"sizeXYZ\", False)",
            "        thumb_version = get_bool_or_default(request, \"thumbVersion\", False)",
            "        date = get_bool_or_default(request, \"date\", False)",
            "        experimenter_id = get_long_or_default(request, \"experimenter_id\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    # Share ID is in kwargs from api/share_images/<id>/ which will create",
            "    # a share connection in @login_required.",
            "    # We don't support ?share_id in query string since this would allow a",
            "    # share connection to be created for ALL urls, instead of just this one.",
            "    share_id = \"share_id\" in kwargs and long(kwargs[\"share_id\"]) or None",
            "",
            "    try:",
            "        # Get the images",
            "        images = tree.marshal_images(",
            "            conn=conn,",
            "            orphaned=orphaned,",
            "            experimenter_id=experimenter_id,",
            "            dataset_id=dataset_id,",
            "            share_id=share_id,",
            "            load_pixels=load_pixels,",
            "            group_id=group_id,",
            "            page=page,",
            "            date=date,",
            "            thumb_version=thumb_version,",
            "            limit=limit,",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"images\": images})",
            "",
            "",
            "@login_required()",
            "def api_plate_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        screen_id = get_long_or_default(request, \"id\", None)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    try:",
            "        # Get the plates",
            "        plates = tree.marshal_plates(",
            "            conn=conn, screen_id=screen_id, group_id=group_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"plates\": plates})",
            "",
            "",
            "@login_required()",
            "def api_plate_acquisition_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        plate_id = get_long_or_default(request, \"id\", None)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    # Orphaned PlateAcquisitions are not possible so querying without a",
            "    # plate is an error",
            "    if plate_id is None:",
            "        return HttpResponseBadRequest(\"id (plate) must be specified\")",
            "",
            "    try:",
            "        # Get the plate acquisitions",
            "        plate_acquisitions = tree.marshal_plate_acquisitions(",
            "            conn=conn, plate_id=plate_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"acquisitions\": plate_acquisitions})",
            "",
            "",
            "def get_object_links(conn, parent_type, parent_id, child_type, child_ids):",
            "    \"\"\" This is just used internally by api_link DELETE below \"\"\"",
            "    if parent_type == \"orphaned\":",
            "        return None",
            "    link_type = None",
            "    if parent_type == \"experimenter\":",
            "        if child_type in [\"dataset\", \"plate\", \"tag\"]:",
            "            # This will be a requested link if a dataset or plate is",
            "            # moved from the de facto orphaned datasets/plates, it isn't",
            "            # an error, but no link actually needs removing",
            "            return None",
            "    elif parent_type == \"project\":",
            "        if child_type == \"dataset\":",
            "            link_type = \"ProjectDatasetLink\"",
            "    elif parent_type == \"dataset\":",
            "        if child_type == \"image\":",
            "            link_type = \"DatasetImageLink\"",
            "    elif parent_type == \"screen\":",
            "        if child_type == \"plate\":",
            "            link_type = \"ScreenPlateLink\"",
            "    elif parent_type == \"tagset\":",
            "        if child_type == \"tag\":",
            "            link_type = \"AnnotationAnnotationLink\"",
            "    if not link_type:",
            "        raise Http404(\"json data needs 'parent_type' and 'child_type'\")",
            "",
            "    params = omero.sys.ParametersI()",
            "    params.addIds(child_ids)",
            "",
            "    qs = conn.getQueryService()",
            "    # Need to fetch child and parent, otherwise",
            "    # AnnotationAnnotationLink is not loaded",
            "    q = (",
            "        \"\"\"",
            "        from %s olink join fetch olink.child join fetch olink.parent",
            "        where olink.child.id in (:ids)",
            "        \"\"\"",
            "        % link_type",
            "    )",
            "    if parent_id:",
            "        params.add(\"pid\", rlong(parent_id))",
            "        q += \" and olink.parent.id = :pid\"",
            "",
            "    res = qs.findAllByQuery(q, params, conn.SERVICE_OPTS)",
            "",
            "    if parent_id is not None and len(res) == 0:",
            "        raise Http404(",
            "            \"No link found for %s-%s to %s-%s\"",
            "            % (parent_type, parent_id, child_type, child_ids)",
            "        )",
            "    return link_type, res",
            "",
            "",
            "def create_link(parent_type, parent_id, child_type, child_id):",
            "    \"\"\" This is just used internally by api_link DELETE below \"\"\"",
            "    if parent_type == \"experimenter\":",
            "        if child_type == \"dataset\" or child_type == \"plate\":",
            "            # This is actually not a link that needs creating, this",
            "            # dataset/plate is an orphan",
            "            return \"orphan\"",
            "    if parent_type == \"project\":",
            "        project = ProjectI(long(parent_id), False)",
            "        if child_type == \"dataset\":",
            "            dataset = DatasetI(long(child_id), False)",
            "            link = ProjectDatasetLinkI()",
            "            link.setParent(project)",
            "            link.setChild(dataset)",
            "            return link",
            "    elif parent_type == \"dataset\":",
            "        dataset = DatasetI(long(parent_id), False)",
            "        if child_type == \"image\":",
            "            image = ImageI(long(child_id), False)",
            "            link = DatasetImageLinkI()",
            "            link.setParent(dataset)",
            "            link.setChild(image)",
            "            return link",
            "    elif parent_type == \"screen\":",
            "        screen = ScreenI(long(parent_id), False)",
            "        if child_type == \"plate\":",
            "            plate = PlateI(long(child_id), False)",
            "            link = ScreenPlateLinkI()",
            "            link.setParent(screen)",
            "            link.setChild(plate)",
            "            return link",
            "    elif parent_type == \"tagset\":",
            "        if child_type == \"tag\":",
            "            link = AnnotationAnnotationLinkI()",
            "            link.setParent(TagAnnotationI(long(parent_id), False))",
            "            link.setChild(TagAnnotationI(long(child_id), False))",
            "            return link",
            "    return None",
            "",
            "",
            "def get_objects_owners(conn, child_type, child_ids):",
            "    \"\"\"",
            "    Returns a dict of child_id: owner_id",
            "    \"\"\"",
            "    if child_type == \"tag\":",
            "        child_type = \"Annotation\"",
            "    owners = {}",
            "    for obj in conn.getObjects(child_type, child_ids):",
            "        owners[obj.id] = obj.details.owner.id.val",
            "    return owners",
            "",
            "",
            "@login_required()",
            "def api_links(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Entry point for the api_links methods.",
            "    We delegate depending on request method to",
            "    create or delete links between objects.",
            "    \"\"\"",
            "    if request.method not in [\"POST\", \"DELETE\"]:",
            "        return JsonResponse(",
            "            {\"Error\": \"Need to POST or DELETE JSON data to update links\"}, status=405",
            "        )",
            "    # Handle link creation/deletion",
            "    try:",
            "        json_data = json.loads(request.body)",
            "    except TypeError:",
            "        # for Python 3.5",
            "        json_data = json.loads(bytes_to_native_str(request.body))",
            "",
            "    if request.method == \"POST\":",
            "        return _api_links_POST(conn, json_data)",
            "    elif request.method == \"DELETE\":",
            "        return _api_links_DELETE(conn, json_data)",
            "",
            "",
            "def _api_links_POST(conn, json_data, **kwargs):",
            "    \"\"\"Creates links between objects specified by a json",
            "    blob in the request body.",
            "    e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "    When creating a link, fails silently if ValidationException",
            "    (E.g. adding an image to a Dataset that already has that image).",
            "    \"\"\"",
            "",
            "    response = {\"success\": False}",
            "",
            "    # json is [parent_type][parent_id][child_type][childIds]",
            "    # e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "",
            "    linksToSave = []",
            "    write_owned = \"WriteOwned\" in conn.getCurrentAdminPrivileges()",
            "    user_id = conn.getUserId()",
            "    for parent_type, parents in json_data.items():",
            "        if parent_type in (\"orphaned\", \"experimenter\"):",
            "            continue",
            "        for parent_id, children in parents.items():",
            "            for child_type, child_ids in children.items():",
            "                # batch look-up owners of all child objects",
            "                child_owners = get_objects_owners(conn, child_type, child_ids)",
            "                for child_id in child_ids:",
            "                    parent_id = int(parent_id)",
            "                    link = create_link(parent_type, parent_id, child_type, child_id)",
            "                    if link and link != \"orphan\":",
            "                        # link owner should match child owner",
            "                        if write_owned and child_owners[child_id] != user_id:",
            "                            link.details.owner = ExperimenterI(",
            "                                child_owners[child_id], False",
            "                            )",
            "                        linksToSave.append(link)",
            "",
            "    if len(linksToSave) > 0:",
            "        # Need to set context to correct group (E.g parent group)",
            "        ptype = parent_type.title()",
            "        if ptype in [\"Tagset\", \"Tag\"]:",
            "            ptype = \"TagAnnotation\"",
            "        p = conn.getQueryService().get(ptype, parent_id, conn.SERVICE_OPTS)",
            "        conn.SERVICE_OPTS.setOmeroGroup(p.details.group.id.val)",
            "        logger.info(\"api_link: Saving %s links\" % len(linksToSave))",
            "",
            "        try:",
            "            # We try to save all at once, for speed.",
            "            conn.saveArray(linksToSave)",
            "            response[\"success\"] = True",
            "        except Exception:",
            "            logger.info(",
            "                \"api_link: Exception on saveArray with %s links\" % len(linksToSave)",
            "            )",
            "            # If this fails, e.g. ValidationException because link",
            "            # already exists, try to save individual links",
            "            for link in linksToSave:",
            "                try:",
            "                    conn.saveObject(link)",
            "                except Exception:",
            "                    pass",
            "            response[\"success\"] = True",
            "",
            "    return JsonResponse(response)",
            "",
            "",
            "def _api_links_DELETE(conn, json_data):",
            "    \"\"\"Deletes links between objects specified by a json",
            "    blob in the request body.",
            "    e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "    \"\"\"",
            "",
            "    response = {\"success\": False}",
            "",
            "    # json is [parent_type][parent_id][child_type][childIds]",
            "    # e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "    for parent_type, parents in json_data.items():",
            "        if parent_type == \"orphaned\":",
            "            continue",
            "        for parent_id, children in parents.items():",
            "            for child_type, child_ids in children.items():",
            "                objLnks = get_object_links(",
            "                    conn, parent_type, parent_id, child_type, child_ids",
            "                )",
            "                if objLnks is None:",
            "                    continue",
            "                linkType, links = objLnks",
            "                linkIds = [r.id.val for r in links]",
            "                logger.info(\"api_link: Deleting %s links\" % len(linkIds))",
            "                conn.deleteObjects(linkType, linkIds, wait=True)",
            "                # webclient needs to know what is orphaned",
            "                linkType, remainingLinks = get_object_links(",
            "                    conn, parent_type, None, child_type, child_ids",
            "                )",
            "                # return remaining links in same format as json above",
            "                # e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "                for rl in remainingLinks:",
            "                    pid = rl.parent.id.val",
            "                    cid = rl.child.id.val",
            "                    # Deleting links still in progress above - ignore these",
            "                    if pid == int(parent_id):",
            "                        continue",
            "                    if parent_type not in response:",
            "                        response[parent_type] = {}",
            "                    if pid not in response[parent_type]:",
            "                        response[parent_type][pid] = {child_type: []}",
            "                    response[parent_type][pid][child_type].append(cid)",
            "",
            "    # If we got here, DELETE was OK",
            "    response[\"success\"] = True",
            "",
            "    return JsonResponse(response)",
            "",
            "",
            "@login_required()",
            "def api_parent_links(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Get a list of links as",
            "    {'data': [{id: 12, child:{type:'image', id:1},",
            "               parent:{type:'dataset', id:2}] }",
            "",
            "    Supports ?image=1,2 and ?image=1&image=2",
            "    \"\"\"",
            "    parent_types = {\"image\": \"dataset\", \"dataset\": \"project\", \"plate\": \"screen\"}",
            "    parents = []",
            "    for child_type, parent_type in parent_types.items():",
            "        ids = request.GET.getlist(child_type)",
            "        if len(ids) == 0:",
            "            continue",
            "        # support for ?image=1,2",
            "        child_ids = []",
            "        for id in ids:",
            "            for i in id.split(\",\"):",
            "                child_ids.append(i)",
            "",
            "        link_type, result = get_object_links(",
            "            conn, parent_type, None, child_type, child_ids",
            "        )",
            "        for link in result:",
            "            parents.append(",
            "                {",
            "                    \"id\": link.id.val,",
            "                    \"parent\": {\"type\": parent_type, \"id\": link.parent.id.val},",
            "                    \"child\": {\"type\": child_type, \"id\": link.child.id.val},",
            "                }",
            "            )",
            "",
            "    return JsonResponse({\"data\": parents})",
            "",
            "",
            "@login_required()",
            "def api_paths_to_object(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This finds the paths to objects in the hierarchy. It returns only",
            "    the path, not the object hierarchy itself.",
            "",
            "    An example usage is for the 'show' functionality",
            "    Example to go to the image with id 1 somewhere in the tree.",
            "    http://localhost:8000/webclient/?show=image-1",
            "",
            "    This method can tell the webclient exactly what needs to be",
            "    dynamically loaded to display this in the jstree.",
            "    \"\"\"",
            "",
            "    try:",
            "        experimenter_id = get_long_or_default(request, \"experimenter\", None)",
            "        project_id = get_long_or_default(request, \"project\", None)",
            "        dataset_id = get_long_or_default(request, \"dataset\", None)",
            "        image_id = get_long_or_default(request, \"image\", None)",
            "        screen_id = get_long_or_default(request, \"screen\", None)",
            "        plate_id = get_long_or_default(request, \"plate\", None)",
            "        acquisition_id = get_long_or_default(request, \"run\", None)",
            "        # acquisition will override 'run' if both are specified as they are",
            "        # the same thing",
            "        acquisition_id = get_long_or_default(request, \"acquisition\", acquisition_id)",
            "        well_id = request.GET.get(\"well\", None)",
            "        tag_id = get_long_or_default(request, \"tag\", None)",
            "        tagset_id = get_long_or_default(request, \"tagset\", None)",
            "        roi_id = get_long_or_default(request, \"roi\", None)",
            "        shape_id = get_long_or_default(request, \"shape\", None)",
            "        group_id = get_long_or_default(request, \"group\", None)",
            "        page_size = get_long_or_default(request, \"page_size\", settings.PAGE)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if tag_id is not None or tagset_id is not None:",
            "        paths = paths_to_tag(conn, experimenter_id, tagset_id, tag_id)",
            "",
            "    else:",
            "        paths = paths_to_object(",
            "            conn,",
            "            experimenter_id,",
            "            project_id,",
            "            dataset_id,",
            "            image_id,",
            "            screen_id,",
            "            plate_id,",
            "            acquisition_id,",
            "            well_id,",
            "            group_id,",
            "            page_size,",
            "            roi_id,",
            "            shape_id,",
            "        )",
            "    return JsonResponse({\"paths\": paths})",
            "",
            "",
            "@login_required()",
            "def api_tags_and_tagged_list(request, conn=None, **kwargs):",
            "    if request.method == \"GET\":",
            "        return api_tags_and_tagged_list_GET(request, conn, **kwargs)",
            "    elif request.method == \"DELETE\":",
            "        return api_tags_and_tagged_list_DELETE(request, conn, **kwargs)",
            "",
            "",
            "def api_tags_and_tagged_list_GET(request, conn=None, **kwargs):",
            "    \"\"\"Get a list of tags",
            "    Specifiying tag_id will return any sub-tags, sub-tagsets and",
            "    objects tagged with that id",
            "    If no tagset_id is specifed it will return tags which have no",
            "    parent",
            "    \"\"\"",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        tag_id = get_long_or_default(request, \"id\", None)",
            "        experimenter_id = get_long_or_default(request, \"experimenter_id\", -1)",
            "        orphaned = get_bool_or_default(request, \"orphaned\", False)",
            "        load_pixels = get_bool_or_default(request, \"sizeXYZ\", False)",
            "        date = get_bool_or_default(request, \"date\", False)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    try:",
            "        # Get ALL data (all owners) under specified tags",
            "        if tag_id is not None:",
            "            tagged = tree.marshal_tagged(",
            "                conn=conn,",
            "                experimenter_id=experimenter_id,",
            "                tag_id=tag_id,",
            "                group_id=group_id,",
            "                page=page,",
            "                load_pixels=load_pixels,",
            "                date=date,",
            "                limit=limit,",
            "            )",
            "        else:",
            "            tagged = {}",
            "",
            "        # Get 'tags' under tag_id",
            "        tagged[\"tags\"] = tree.marshal_tags(",
            "            conn=conn,",
            "            orphaned=orphaned,",
            "            experimenter_id=experimenter_id,",
            "            tag_id=tag_id,",
            "            group_id=group_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse(tagged)",
            "",
            "",
            "def api_tags_and_tagged_list_DELETE(request, conn=None, **kwargs):",
            "    \"\"\"Delete the listed tags by ids\"\"\"",
            "    # Get parameters",
            "    try:",
            "        tag_ids = get_longs(request, \"id\")",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    dcs = list()",
            "",
            "    handle = None",
            "    try:",
            "        for tag_id in tag_ids:",
            "            dcs.append(omero.cmd.Delete(\"/Annotation\", tag_id))",
            "        doall = omero.cmd.DoAll()",
            "        doall.requests = dcs",
            "        handle = conn.c.sf.submit(doall, conn.SERVICE_OPTS)",
            "",
            "        try:",
            "            conn._waitOnCmd(handle)",
            "        finally:",
            "            handle.close()",
            "",
            "    except CmdError as e:",
            "        return HttpResponseBadRequest(e.message)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse(\"\")",
            "",
            "",
            "@login_required()",
            "def api_annotations(request, conn=None, **kwargs):",
            "",
            "    r = request.GET",
            "    image_ids = get_list(request, \"image\")",
            "    dataset_ids = get_list(request, \"dataset\")",
            "    project_ids = get_list(request, \"project\")",
            "    screen_ids = get_list(request, \"screen\")",
            "    plate_ids = get_list(request, \"plate\")",
            "    run_ids = get_list(request, \"acquisition\")",
            "    well_ids = get_list(request, \"well\")",
            "    page = get_long_or_default(request, \"page\", 1)",
            "    limit = get_long_or_default(request, \"limit\", ANNOTATIONS_LIMIT)",
            "",
            "    ann_type = r.get(\"type\", None)",
            "    ns = r.get(\"ns\", None)",
            "",
            "    anns, exps = tree.marshal_annotations(",
            "        conn,",
            "        project_ids=project_ids,",
            "        dataset_ids=dataset_ids,",
            "        image_ids=image_ids,",
            "        screen_ids=screen_ids,",
            "        plate_ids=plate_ids,",
            "        run_ids=run_ids,",
            "        well_ids=well_ids,",
            "        ann_type=ann_type,",
            "        ns=ns,",
            "        page=page,",
            "        limit=limit,",
            "    )",
            "",
            "    return JsonResponse({\"annotations\": anns, \"experimenters\": exps})",
            "",
            "",
            "@login_required()",
            "def api_share_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        member_id = get_long_or_default(request, \"member_id\", -1)",
            "        owner_id = get_long_or_default(request, \"owner_id\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    # Like with api_container_list, this is a combination of",
            "    # results which will each be able to return up to the limit in page",
            "    # size",
            "",
            "    try:",
            "        # Get the shares",
            "        shares = tree.marshal_shares(",
            "            conn=conn, member_id=member_id, owner_id=owner_id, page=page, limit=limit",
            "        )",
            "        # Get the discussions",
            "        discussions = tree.marshal_discussions(",
            "            conn=conn, member_id=member_id, owner_id=owner_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"shares\": shares, \"discussions\": discussions})",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_plate(request, o1_type=None, o1_id=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    This loads data for the center panel, via AJAX calls.",
            "    Used for Datasets, Plates & Orphaned Images.",
            "    \"\"\"",
            "",
            "    # get index of the plate",
            "    index = getIntOrDefault(request, \"index\", 0)",
            "",
            "    # prepare data. E.g. kw = {}  or  {'plate': 301L}  or",
            "    # 'acquisition': 301L}",
            "    kw = dict()",
            "    if o1_type is not None:",
            "        if o1_id is not None and int(o1_id) > 0:",
            "            kw[str(o1_type)] = long(o1_id)",
            "",
            "    try:",
            "        manager = BaseContainer(conn, **kw)",
            "    except AttributeError as x:",
            "        return handlerInternalError(request, x)",
            "",
            "    # prepare forms",
            "    form_well_index = None",
            "",
            "    context = {\"manager\": manager, \"form_well_index\": form_well_index, \"index\": index}",
            "",
            "    # load data & template",
            "    template = None",
            "    if \"plate\" in kw or \"acquisition\" in kw:",
            "        fields = manager.getNumberOfFields()",
            "        if fields is not None:",
            "            form_well_index = WellIndexForm(initial={\"index\": index, \"range\": fields})",
            "            if index == 0:",
            "                index = fields[0]",
            "",
            "        # Show parameter will be well-1|well-2",
            "        show = request.GET.get(\"show\")",
            "        if show is not None:",
            "            wells_to_select = []",
            "            for w in show.split(\"|\"):",
            "                if \"well-\" in w:",
            "                    wells_to_select.append(w.replace(\"well-\", \"\"))",
            "            context[\"select_wells\"] = \",\".join(wells_to_select)",
            "",
            "        context[\"baseurl\"] = reverse(\"webgateway\").rstrip(\"/\")",
            "        context[\"form_well_index\"] = form_well_index",
            "        context[\"index\"] = index",
            "        context[\"thumbnails_batch\"] = settings.THUMBNAILS_BATCH",
            "        template = \"webclient/data/plate.html\"",
            "        if o1_type == \"acquisition\":",
            "            context[\"acquisition\"] = o1_id",
            "",
            "    context[\"isLeader\"] = conn.isLeader()",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_chgrp_groups(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Get the potential groups we can move selected data to.",
            "    These will be groups that the owner(s) of selected objects is a member of.",
            "    Objects are specified by query string like: ?Image=1,2&Dataset=3",
            "    If no selected objects are specified, simply list the groups that the",
            "    current user is a member of.",
            "    Groups list will exclude the 'current' group context.",
            "    \"\"\"",
            "",
            "    ownerIds = []",
            "    currentGroups = set()",
            "    groupSets = []",
            "    groups = {}",
            "    owners = {}",
            "    for dtype in (\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\"):",
            "        oids = request.GET.get(dtype, None)",
            "        if oids is not None:",
            "            for o in conn.getObjects(dtype, oids.split(\",\")):",
            "                ownerIds.append(o.getDetails().owner.id.val)",
            "                currentGroups.add(o.getDetails().group.id.val)",
            "    ownerIds = list(set(ownerIds))",
            "    # In case we were passed no objects or they weren't found",
            "    if len(ownerIds) == 0:",
            "        ownerIds = [conn.getUserId()]",
            "    for owner in conn.getObjects(",
            "        \"Experimenter\", ownerIds, opts={\"load_experimentergroups\": True}",
            "    ):",
            "        # Each owner has a set of groups",
            "        gids = []",
            "        owners[owner.id] = owner.getFullName()",
            "        for group in owner.copyGroupExperimenterMap():",
            "            groups[group.parent.id.val] = group.parent",
            "            gids.append(group.parent.id.val)",
            "        groupSets.append(set(gids))",
            "",
            "    # Can move to groups that all owners are members of...",
            "    targetGroupIds = set.intersection(*groupSets)",
            "    # ...but not 'user' group",
            "    userGroupId = conn.getAdminService().getSecurityRoles().userGroupId",
            "    if userGroupId in targetGroupIds:",
            "        targetGroupIds.remove(userGroupId)",
            "",
            "    # if all the Objects are in a single group, exclude it from the target",
            "    # groups",
            "    if len(currentGroups) == 1:",
            "        curr_grp = currentGroups.pop()",
            "        if curr_grp in targetGroupIds:",
            "            targetGroupIds.remove(curr_grp)",
            "",
            "    def getPerms(group):",
            "        p = group.getDetails().permissions",
            "        return {",
            "            \"write\": p.isGroupWrite(),",
            "            \"annotate\": p.isGroupAnnotate(),",
            "            \"read\": p.isGroupRead(),",
            "        }",
            "",
            "    # From groupIds, create a list of group dicts for json",
            "    targetGroups = []",
            "    for gid in targetGroupIds:",
            "        targetGroups.append(",
            "            {\"id\": gid, \"name\": groups[gid].name.val, \"perms\": getPerms(groups[gid])}",
            "        )",
            "    targetGroups.sort(key=lambda x: x[\"name\"])",
            "",
            "    owners = [[k, v] for k, v in owners.items()]",
            "",
            "    return {\"owners\": owners, \"groups\": targetGroups}",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_chgrp_target(request, group_id, target_type, conn=None, **kwargs):",
            "    \"\"\" Loads a tree for user to pick target Project, Dataset or Screen \"\"\"",
            "",
            "    # filter by group (not switching group)",
            "    conn.SERVICE_OPTS.setOmeroGroup(int(group_id))",
            "    owner = getIntOrDefault(request, \"owner\", None)",
            "",
            "    manager = BaseContainer(conn)",
            "    manager.listContainerHierarchy(owner)",
            "    template = \"webclient/data/chgrp_target_tree.html\"",
            "",
            "    context = {\"manager\": manager, \"target_type\": target_type, \"template\": template}",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_searching(request, form=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Handles AJAX calls to search",
            "    \"\"\"",
            "    manager = BaseSearch(conn)",
            "",
            "    foundById = []",
            "    # form = 'form' if we are searching. Get query from request...",
            "    r = request.GET",
            "    if form is not None:",
            "        query_search = r.get(\"query\", None)",
            "        if query_search is None:",
            "            return HttpResponse(\"No search '?query' included\")",
            "        query_search = query_search.replace(\"+\", \" \")",
            "        advanced = toBoolean(r.get(\"advanced\"))",
            "        # If this is an advanced search use 'advanced_search' for query",
            "        if advanced:",
            "            query_search = r.get(\"advanced_search\")",
            "        template = \"webclient/search/search_details.html\"",
            "",
            "        onlyTypes = r.getlist(\"datatype\")",
            "        fields = r.getlist(\"field\")",
            "        searchGroup = r.get(\"searchGroup\", None)",
            "        ownedBy = r.get(\"ownedBy\", None)",
            "",
            "        useAcquisitionDate = toBoolean(r.get(\"useAcquisitionDate\"))",
            "        startdate = r.get(\"startdateinput\", None)",
            "        startdate = startdate is not None and smart_str(startdate) or None",
            "        enddate = r.get(\"enddateinput\", None)",
            "        enddate = enddate is not None and smart_str(enddate) or None",
            "        date = None",
            "        if startdate is not None:",
            "            if enddate is None:",
            "                n = datetime.datetime.now()",
            "                enddate = \"%s-%02d-%02d\" % (n.year, n.month, n.day)",
            "            date = \"%s_%s\" % (startdate, enddate)",
            "",
            "        # by default, if user has not specified any types:",
            "        if len(onlyTypes) == 0:",
            "            onlyTypes = [\"images\"]",
            "",
            "        # search is carried out and results are stored in",
            "        # manager.containers.images etc.",
            "        manager.search(",
            "            query_search,",
            "            onlyTypes,",
            "            fields,",
            "            searchGroup,",
            "            ownedBy,",
            "            useAcquisitionDate,",
            "            date,",
            "            rawQuery=advanced,",
            "        )",
            "",
            "        # if the query is only numbers (separated by commas or spaces)",
            "        # we search for objects by ID",
            "        isIds = re.compile(r\"^[\\d ,]+$\")",
            "        if isIds.search(query_search) is not None:",
            "            conn.SERVICE_OPTS.setOmeroGroup(-1)",
            "            idSet = set()",
            "            for queryId in re.split(\" |,\", query_search):",
            "                if len(queryId) == 0:",
            "                    continue",
            "                try:",
            "                    searchById = long(queryId)",
            "                    if searchById in idSet:",
            "                        continue",
            "                    idSet.add(searchById)",
            "                    for t in onlyTypes:",
            "                        t = t[0:-1]  # remove 's'",
            "                        if t in (",
            "                            \"project\",",
            "                            \"dataset\",",
            "                            \"image\",",
            "                            \"screen\",",
            "                            \"plate\",",
            "                            \"well\",",
            "                        ):",
            "                            obj = conn.getObject(t, searchById)",
            "                            if obj is not None:",
            "                                foundById.append({\"otype\": t, \"obj\": obj})",
            "                except ValueError:",
            "                    pass",
            "",
            "    else:",
            "        # simply display the search home page.",
            "        template = \"webclient/search/search.html\"",
            "",
            "    context = {",
            "        \"manager\": manager,",
            "        \"foundById\": foundById,",
            "        \"resultCount\": manager.c_size + len(foundById),",
            "    }",
            "    context[\"template\"] = template",
            "    context[\"thumbnails_batch\"] = settings.THUMBNAILS_BATCH",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_details(request, c_type, c_id, conn=None, share_id=None, **kwargs):",
            "    \"\"\"",
            "    This page is the right-hand panel 'general metadata', first tab only.",
            "    Shown for Projects, Datasets, Images, Screens, Plates, Wells, Tags etc.",
            "    The data and annotations are loaded by the manager. Display of appropriate",
            "    data is handled by the template.",
            "    \"\"\"",
            "",
            "    # the index of a field within a well",
            "    index = getIntOrDefault(request, \"index\", 0)",
            "",
            "    context = dict()",
            "",
            "    # we only expect a single object, but forms can take multiple objects",
            "    images = c_type == \"image\" and list(conn.getObjects(\"Image\", [c_id])) or list()",
            "    datasets = (",
            "        c_type == \"dataset\" and list(conn.getObjects(\"Dataset\", [c_id])) or list()",
            "    )",
            "    projects = (",
            "        c_type == \"project\" and list(conn.getObjects(\"Project\", [c_id])) or list()",
            "    )",
            "    screens = c_type == \"screen\" and list(conn.getObjects(\"Screen\", [c_id])) or list()",
            "    plates = c_type == \"plate\" and list(conn.getObjects(\"Plate\", [c_id])) or list()",
            "    acquisitions = (",
            "        c_type == \"acquisition\"",
            "        and list(conn.getObjects(\"PlateAcquisition\", [c_id]))",
            "        or list()",
            "    )",
            "    shares = (",
            "        (c_type == \"share\" or c_type == \"discussion\")",
            "        and [conn.getShare(c_id)]",
            "        or list()",
            "    )",
            "    wells = c_type == \"well\" and list(conn.getObjects(\"Well\", [c_id])) or list()",
            "",
            "    # we simply set up the annotation form, passing the objects to be",
            "    # annotated.",
            "    selected = {",
            "        \"images\": c_type == \"image\" and [c_id] or [],",
            "        \"datasets\": c_type == \"dataset\" and [c_id] or [],",
            "        \"projects\": c_type == \"project\" and [c_id] or [],",
            "        \"screens\": c_type == \"screen\" and [c_id] or [],",
            "        \"plates\": c_type == \"plate\" and [c_id] or [],",
            "        \"acquisitions\": c_type == \"acquisition\" and [c_id] or [],",
            "        \"wells\": c_type == \"well\" and [c_id] or [],",
            "        \"shares\": ((c_type == \"share\" or c_type == \"discussion\") and [c_id] or []),",
            "    }",
            "",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": images,",
            "        \"datasets\": datasets,",
            "        \"projects\": projects,",
            "        \"screens\": screens,",
            "        \"plates\": plates,",
            "        \"acquisitions\": acquisitions,",
            "        \"wells\": wells,",
            "        \"shares\": shares,",
            "    }",
            "",
            "    form_comment = None",
            "    figScripts = None",
            "    if c_type in (\"share\", \"discussion\"):",
            "        template = \"webclient/annotations/annotations_share.html\"",
            "        manager = BaseShare(conn, c_id)",
            "        manager.getAllUsers(c_id)",
            "        manager.getComments(c_id)",
            "        form_comment = CommentAnnotationForm(initial=initial)",
            "    else:",
            "        try:",
            "            manager = BaseContainer(conn, **{str(c_type): long(c_id), \"index\": index})",
            "        except AttributeError as x:",
            "            return handlerInternalError(request, x)",
            "        if share_id is not None:",
            "            template = \"webclient/annotations/annotations_share.html\"",
            "            context[\"share\"] = BaseShare(conn, share_id)",
            "        else:",
            "            template = \"webclient/annotations/metadata_general.html\"",
            "            context[\"canExportAsJpg\"] = manager.canExportAsJpg(request)",
            "            context[\"annotationCounts\"] = manager.getAnnotationCounts()",
            "            figScripts = manager.listFigureScripts()",
            "    context[\"manager\"] = manager",
            "",
            "    if c_type in (\"tag\", \"tagset\"):",
            "        context[\"insight_ns\"] = omero.rtypes.rstring(",
            "            omero.constants.metadata.NSINSIGHTTAGSET",
            "        ).val",
            "    if form_comment is not None:",
            "        context[\"form_comment\"] = form_comment",
            "",
            "    context[\"figScripts\"] = figScripts",
            "    context[\"template\"] = template",
            "    context[\"webclient_path\"] = reverse(\"webindex\")",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_preview(request, c_type, c_id, conn=None, share_id=None, **kwargs):",
            "    \"\"\"",
            "    This is the image 'Preview' tab for the right-hand panel.",
            "    \"\"\"",
            "    context = {}",
            "",
            "    # the index of a field within a well",
            "    index = getIntOrDefault(request, \"index\", 0)",
            "",
            "    manager = BaseContainer(conn, **{str(c_type): long(c_id)})",
            "    if share_id:",
            "        context[\"share\"] = BaseShare(conn, share_id)",
            "    if c_type == \"well\":",
            "        manager.image = manager.well.getImage(index)",
            "",
            "    allRdefs = manager.image.getAllRenderingDefs()",
            "    rdefs = {}",
            "    rdefId = manager.image.getRenderingDefId()",
            "    # remove duplicates per user",
            "    for r in allRdefs:",
            "        ownerId = r[\"owner\"][\"id\"]",
            "        r[\"current\"] = r[\"id\"] == rdefId",
            "        # if duplicate rdefs for user, pick one with highest ID",
            "        if ownerId not in rdefs or rdefs[ownerId][\"id\"] < r[\"id\"]:",
            "            rdefs[ownerId] = r",
            "    rdefs = rdefs.values()",
            "    # format into rdef strings,",
            "    # E.g. {c: '1|3118:35825$FF0000,2|2086:18975$FFFF00', m: 'c'}",
            "    rdefQueries = []",
            "    for r in rdefs:",
            "        chs = []",
            "        for i, c in enumerate(r[\"c\"]):",
            "            act = \"-\"",
            "            if c[\"active\"]:",
            "                act = \"\"",
            "            color = c[\"lut\"] if \"lut\" in c else c[\"color\"]",
            "            reverse = \"r\" if c[\"inverted\"] else \"-r\"",
            "            chs.append(",
            "                \"%s%s|%s:%s%s$%s\" % (act, i + 1, c[\"start\"], c[\"end\"], reverse, color)",
            "            )",
            "        rdefQueries.append(",
            "            {",
            "                \"id\": r[\"id\"],",
            "                \"owner\": r[\"owner\"],",
            "                \"c\": \",\".join(chs),",
            "                \"m\": r[\"model\"] == \"greyscale\" and \"g\" or \"c\",",
            "            }",
            "        )",
            "    max_w, max_h = conn.getMaxPlaneSize()",
            "    size_x = manager.image.getSizeX()",
            "    size_y = manager.image.getSizeY()",
            "",
            "    context[\"tiledImage\"] = (size_x * size_y) > (max_w * max_h)",
            "    context[\"manager\"] = manager",
            "    context[\"rdefsJson\"] = json.dumps(rdefQueries)",
            "    context[\"rdefs\"] = rdefs",
            "    context[\"template\"] = \"webclient/annotations/metadata_preview.html\"",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_hierarchy(request, c_type, c_id, conn=None, **kwargs):",
            "    \"\"\"",
            "    This loads the ancestors of the specified object and displays them in a",
            "    static tree.",
            "    Used by an AJAX call from the metadata_general panel.",
            "    \"\"\"",
            "    manager = BaseContainer(conn, **{str(c_type): long(c_id)})",
            "",
            "    context = {\"manager\": manager}",
            "    context[\"template\"] = \"webclient/annotations/metadata_hierarchy.html\"",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_acquisition(",
            "    request, c_type, c_id, conn=None, share_id=None, **kwargs",
            "):",
            "    \"\"\"",
            "    The acquisition tab of the right-hand panel. Only loaded for images.",
            "    TODO: urls regex should make sure that c_type is only 'image' OR 'well'",
            "    \"\"\"",
            "    try:",
            "        if c_type in (\"share\", \"discussion\"):",
            "            template = \"webclient/annotations/annotations_share.html\"",
            "            manager = BaseShare(conn, c_id)",
            "            manager.getAllUsers(c_id)",
            "            manager.getComments(c_id)",
            "        else:",
            "            template = \"webclient/annotations/metadata_acquisition.html\"",
            "            manager = BaseContainer(conn, **{str(c_type): long(c_id)})",
            "    except AttributeError as x:",
            "        return handlerInternalError(request, x)",
            "",
            "    form_environment = None",
            "    form_objective = None",
            "    form_microscope = None",
            "    form_instrument_objectives = list()",
            "    form_stageLabel = None",
            "    form_filters = list()",
            "    form_dichroics = list()",
            "    form_detectors = list()",
            "    form_channels = list()",
            "    form_lasers = list()",
            "",
            "    lasertypes = list(conn.getEnumerationEntries(\"LaserType\"))",
            "    arctypes = list(conn.getEnumerationEntries(\"ArcType\"))",
            "    filamenttypes = list(conn.getEnumerationEntries(\"FilamentType\"))",
            "",
            "    # various enums we need for the forms (don't load unless needed)",
            "    mediums = None",
            "    immersions = None",
            "    corrections = None",
            "",
            "    if c_type == \"image\":",
            "        if share_id is None:",
            "            manager.companionFiles()",
            "        manager.channelMetadata()",
            "        for theC, ch in enumerate(manager.channel_metadata):",
            "            logicalChannel = ch.getLogicalChannel()",
            "            if logicalChannel is not None:",
            "                channel = dict()",
            "                channel[\"form\"] = MetadataChannelForm(",
            "                    initial={",
            "                        \"logicalChannel\": logicalChannel,",
            "                        \"exWave\": ch.getExcitationWave(units=True),",
            "                        \"emWave\": ch.getEmissionWave(units=True),",
            "                        \"illuminations\": list(",
            "                            conn.getEnumerationEntries(\"IlluminationI\")",
            "                        ),",
            "                        \"contrastMethods\": list(",
            "                            conn.getEnumerationEntries(\"ContrastMethodI\")",
            "                        ),",
            "                        \"modes\": list(conn.getEnumerationEntries(\"AcquisitionModeI\")),",
            "                    }",
            "                )",
            "                # 9853 Much metadata is not available to 'shares'",
            "                if share_id is None:",
            "                    lightPath = logicalChannel.getLightPath()",
            "                    if lightPath is not None:",
            "                        channel[\"form_dichroic\"] = None",
            "                        channel[\"form_excitation_filters\"] = list()",
            "                        channel[\"form_emission_filters\"] = list()",
            "                        lightPathDichroic = lightPath.getDichroic()",
            "                        if lightPathDichroic is not None:",
            "                            channel[\"form_dichroic\"] = MetadataDichroicForm(",
            "                                initial={\"dichroic\": lightPathDichroic}",
            "                            )",
            "                        filterTypes = list(conn.getEnumerationEntries(\"FilterTypeI\"))",
            "                        for f in lightPath.getEmissionFilters():",
            "                            channel[\"form_emission_filters\"].append(",
            "                                MetadataFilterForm(",
            "                                    initial={\"filter\": f, \"types\": filterTypes}",
            "                                )",
            "                            )",
            "                        for f in lightPath.getExcitationFilters():",
            "                            channel[\"form_excitation_filters\"].append(",
            "                                MetadataFilterForm(",
            "                                    initial={\"filter\": f, \"types\": filterTypes}",
            "                                )",
            "                            )",
            "",
            "                    detectorSettings = logicalChannel.getDetectorSettings()",
            "                    if (",
            "                        detectorSettings._obj is not None",
            "                        and detectorSettings.getDetector()",
            "                    ):",
            "                        channel[\"form_detector_settings\"] = MetadataDetectorForm(",
            "                            initial={",
            "                                \"detectorSettings\": detectorSettings,",
            "                                \"detector\": detectorSettings.getDetector(),",
            "                                \"types\": list(",
            "                                    conn.getEnumerationEntries(\"DetectorTypeI\")",
            "                                ),",
            "                                \"binnings\": list(conn.getEnumerationEntries(\"Binning\")),",
            "                            }",
            "                        )",
            "",
            "                    lightSourceSettings = logicalChannel.getLightSourceSettings()",
            "                    if (",
            "                        lightSourceSettings is not None",
            "                        and lightSourceSettings._obj is not None",
            "                    ):",
            "                        lightSrc = lightSourceSettings.getLightSource()",
            "                        if lightSrc is not None:",
            "                            lstypes = lasertypes",
            "                            if lightSrc.OMERO_CLASS == \"Arc\":",
            "                                lstypes = arctypes",
            "                            elif lightSrc.OMERO_CLASS == \"Filament\":",
            "                                lstypes = filamenttypes",
            "                            channel[\"form_light_source\"] = MetadataLightSourceForm(",
            "                                initial={",
            "                                    \"lightSource\": lightSrc,",
            "                                    \"lightSourceSettings\": lightSourceSettings,",
            "                                    \"lstypes\": lstypes,",
            "                                    \"mediums\": list(",
            "                                        conn.getEnumerationEntries(\"LaserMediumI\")",
            "                                    ),",
            "                                    \"pulses\": list(",
            "                                        conn.getEnumerationEntries(\"PulseI\")",
            "                                    ),",
            "                                }",
            "                            )",
            "                # TODO: We don't display filter sets here yet since they are",
            "                # not populated on Import by BioFormats.",
            "                channel[\"label\"] = ch.getLabel()",
            "                color = ch.getColor()",
            "                channel[\"color\"] = color is not None and color.getHtml() or None",
            "                planeInfo = (",
            "                    manager.image",
            "                    and manager.image.getPrimaryPixels().copyPlaneInfo(",
            "                        theC=theC, theZ=0",
            "                    )",
            "                )",
            "                plane_info = []",
            "",
            "                for pi in planeInfo:",
            "                    deltaT = pi.getDeltaT(units=\"SECOND\")",
            "                    exposure = pi.getExposureTime(units=\"SECOND\")",
            "                    if deltaT is None and exposure is None:",
            "                        continue",
            "                    if deltaT is not None:",
            "                        deltaT = deltaT.getValue()",
            "                    if exposure is not None:",
            "                        exposure = exposure.getValue()",
            "                    plane_info.append(",
            "                        {\"theT\": pi.theT, \"deltaT\": deltaT, \"exposureTime\": exposure}",
            "                    )",
            "                channel[\"plane_info\"] = plane_info",
            "",
            "                form_channels.append(channel)",
            "",
            "        try:",
            "            image = manager.well.getWellSample().image()",
            "        except Exception:",
            "            image = manager.image",
            "",
            "        if share_id is None:  # 9853",
            "            if image.getObjectiveSettings() is not None:",
            "                # load the enums if needed and create our Objective Form",
            "                if mediums is None:",
            "                    mediums = list(conn.getEnumerationEntries(\"MediumI\"))",
            "                if immersions is None:",
            "                    immersions = list(conn.getEnumerationEntries(\"ImmersionI\"))",
            "                if corrections is None:",
            "                    corrections = list(conn.getEnumerationEntries(\"CorrectionI\"))",
            "                form_objective = MetadataObjectiveSettingsForm(",
            "                    initial={",
            "                        \"objectiveSettings\": image.getObjectiveSettings(),",
            "                        \"objective\": image.getObjectiveSettings().getObjective(),",
            "                        \"mediums\": mediums,",
            "                        \"immersions\": immersions,",
            "                        \"corrections\": corrections,",
            "                    }",
            "                )",
            "            if image.getImagingEnvironment() is not None:",
            "                form_environment = MetadataEnvironmentForm(initial={\"image\": image})",
            "            if image.getStageLabel() is not None:",
            "                form_stageLabel = MetadataStageLabelForm(initial={\"image\": image})",
            "",
            "            instrument = image.getInstrument()",
            "            if instrument is not None:",
            "                if instrument.getMicroscope() is not None:",
            "                    form_microscope = MetadataMicroscopeForm(",
            "                        initial={",
            "                            \"microscopeTypes\": list(",
            "                                conn.getEnumerationEntries(\"MicroscopeTypeI\")",
            "                            ),",
            "                            \"microscope\": instrument.getMicroscope(),",
            "                        }",
            "                    )",
            "",
            "                objectives = instrument.getObjectives()",
            "                for o in objectives:",
            "                    # load the enums if needed and create our Objective Form",
            "                    if mediums is None:",
            "                        mediums = list(conn.getEnumerationEntries(\"MediumI\"))",
            "                    if immersions is None:",
            "                        immersions = list(conn.getEnumerationEntries(\"ImmersionI\"))",
            "                    if corrections is None:",
            "                        corrections = list(conn.getEnumerationEntries(\"CorrectionI\"))",
            "                    obj_form = MetadataObjectiveForm(",
            "                        initial={",
            "                            \"objective\": o,",
            "                            \"mediums\": mediums,",
            "                            \"immersions\": immersions,",
            "                            \"corrections\": corrections,",
            "                        }",
            "                    )",
            "                    form_instrument_objectives.append(obj_form)",
            "                filters = list(instrument.getFilters())",
            "                if len(filters) > 0:",
            "                    for f in filters:",
            "                        form_filter = MetadataFilterForm(",
            "                            initial={",
            "                                \"filter\": f,",
            "                                \"types\": list(",
            "                                    conn.getEnumerationEntries(\"FilterTypeI\")",
            "                                ),",
            "                            }",
            "                        )",
            "                        form_filters.append(form_filter)",
            "",
            "                dichroics = list(instrument.getDichroics())",
            "                for d in dichroics:",
            "                    form_dichroic = MetadataDichroicForm(initial={\"dichroic\": d})",
            "                    form_dichroics.append(form_dichroic)",
            "",
            "                detectors = list(instrument.getDetectors())",
            "                if len(detectors) > 0:",
            "                    for d in detectors:",
            "                        form_detector = MetadataDetectorForm(",
            "                            initial={",
            "                                \"detectorSettings\": None,",
            "                                \"detector\": d,",
            "                                \"types\": list(",
            "                                    conn.getEnumerationEntries(\"DetectorTypeI\")",
            "                                ),",
            "                            }",
            "                        )",
            "                        form_detectors.append(form_detector)",
            "",
            "                lasers = list(instrument.getLightSources())",
            "                if len(lasers) > 0:",
            "                    for laser in lasers:",
            "                        lstypes = lasertypes",
            "                        if laser.OMERO_CLASS == \"Arc\":",
            "                            lstypes = arctypes",
            "                        elif laser.OMERO_CLASS == \"Filament\":",
            "                            lstypes = filamenttypes",
            "                        form_laser = MetadataLightSourceForm(",
            "                            initial={",
            "                                \"lightSource\": laser,",
            "                                \"lstypes\": lstypes,",
            "                                \"mediums\": list(",
            "                                    conn.getEnumerationEntries(\"LaserMediumI\")",
            "                                ),",
            "                                \"pulses\": list(conn.getEnumerationEntries(\"PulseI\")),",
            "                            }",
            "                        )",
            "                        form_lasers.append(form_laser)",
            "",
            "    # TODO: remove this 'if' since we should only have c_type = 'image'?",
            "    context = {\"manager\": manager, \"share_id\": share_id}",
            "    if c_type not in (\"share\", \"discussion\", \"tag\"):",
            "        context[\"form_channels\"] = form_channels",
            "        context[\"form_environment\"] = form_environment",
            "        context[\"form_objective\"] = form_objective",
            "        context[\"form_microscope\"] = form_microscope",
            "        context[\"form_instrument_objectives\"] = form_instrument_objectives",
            "        context[\"form_filters\"] = form_filters",
            "        context[\"form_dichroics\"] = form_dichroics",
            "        context[\"form_detectors\"] = form_detectors",
            "        context[\"form_lasers\"] = form_lasers",
            "        context[\"form_stageLabel\"] = form_stageLabel",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_original_metadata(request, imageId, conn=None, share_id=None, **kwargs):",
            "",
            "    image = conn.getObject(\"Image\", imageId)",
            "    if image is None:",
            "        raise Http404(\"No Image found with ID %s\" % imageId)",
            "",
            "    context = {",
            "        \"template\": \"webclient/annotations/original_metadata.html\",",
            "        \"imageId\": image.getId(),",
            "    }",
            "    try:",
            "        om = image.loadOriginalMetadata()",
            "        if om is not None:",
            "            context[\"original_metadata\"] = om[0]",
            "            context[\"global_metadata\"] = om[1]",
            "            context[\"series_metadata\"] = om[2]",
            "    except omero.LockTimeout:",
            "        # 408 is Request Timeout",
            "        return HttpResponse(content=\"LockTimeout\", status=408)",
            "    return context",
            "",
            "",
            "###########################################################################",
            "# ACTIONS",
            "",
            "# Annotation in the right-hand panel is handled the same way for single",
            "# objects (metadata_general.html)",
            "# AND for batch annotation (batch_annotate.html) by 4 forms:",
            "# Comment (this is loaded in the initial page)",
            "# Tags (the empty form is in the initial page but fields are loaded via AJAX)",
            "# Local File (this is loaded in the initial page)",
            "# Existing File (the empty form is in the initial page but field is loaded via",
            "# AJAX)",
            "#",
            "# In each case, the form itself contains hidden fields to specify the",
            "# object(s) being annotated",
            "# All forms inherit from a single form that has these fields.",
            "",
            "",
            "def getObjects(request, conn=None):",
            "    \"\"\"",
            "    Prepare objects for use in the annotation forms.",
            "    These objects are required by the form superclass to populate hidden",
            "    fields, so we know what we're annotating on submission",
            "    \"\"\"",
            "    r = request.GET or request.POST",
            "    images = (",
            "        len(r.getlist(\"image\")) > 0",
            "        and list(conn.getObjects(\"Image\", r.getlist(\"image\")))",
            "        or list()",
            "    )",
            "    datasets = (",
            "        len(r.getlist(\"dataset\")) > 0",
            "        and list(conn.getObjects(\"Dataset\", r.getlist(\"dataset\")))",
            "        or list()",
            "    )",
            "    projects = (",
            "        len(r.getlist(\"project\")) > 0",
            "        and list(conn.getObjects(\"Project\", r.getlist(\"project\")))",
            "        or list()",
            "    )",
            "    screens = (",
            "        len(r.getlist(\"screen\")) > 0",
            "        and list(conn.getObjects(\"Screen\", r.getlist(\"screen\")))",
            "        or list()",
            "    )",
            "    plates = (",
            "        len(r.getlist(\"plate\")) > 0",
            "        and list(conn.getObjects(\"Plate\", r.getlist(\"plate\")))",
            "        or list()",
            "    )",
            "    acquisitions = (",
            "        len(r.getlist(\"acquisition\")) > 0",
            "        and list(conn.getObjects(\"PlateAcquisition\", r.getlist(\"acquisition\")))",
            "        or list()",
            "    )",
            "    shares = (",
            "        len(r.getlist(\"share\")) > 0 and [conn.getShare(r.getlist(\"share\")[0])] or list()",
            "    )",
            "    wells = (",
            "        len(r.getlist(\"well\")) > 0",
            "        and list(conn.getObjects(\"Well\", r.getlist(\"well\")))",
            "        or list()",
            "    )",
            "    return {",
            "        \"image\": images,",
            "        \"dataset\": datasets,",
            "        \"project\": projects,",
            "        \"screen\": screens,",
            "        \"plate\": plates,",
            "        \"acquisition\": acquisitions,",
            "        \"well\": wells,",
            "        \"share\": shares,",
            "    }",
            "",
            "",
            "def getIds(request):",
            "    \"\"\"",
            "    Used by forms to indicate the currently selected objects prepared above",
            "    \"\"\"",
            "    r = request.GET or request.POST",
            "    selected = {",
            "        \"images\": r.getlist(\"image\"),",
            "        \"datasets\": r.getlist(\"dataset\"),",
            "        \"projects\": r.getlist(\"project\"),",
            "        \"screens\": r.getlist(\"screen\"),",
            "        \"plates\": r.getlist(\"plate\"),",
            "        \"acquisitions\": r.getlist(\"acquisition\"),",
            "        \"wells\": r.getlist(\"well\"),",
            "        \"shares\": r.getlist(\"share\"),",
            "    }",
            "    return selected",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def batch_annotate(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This page gives a form for batch annotation.",
            "    Local File form and Comment form are loaded. Other forms are loaded via",
            "    AJAX",
            "    \"\"\"",
            "",
            "    objs = getObjects(request, conn)",
            "",
            "    # get groups for selected objects - setGroup() and create links",
            "    obj_ids = []",
            "    obj_labels = []",
            "    groupIds = set()",
            "    annotationBlocked = False",
            "    for key in objs:",
            "        obj_ids += [\"%s=%s\" % (key, o.id) for o in objs[key]]",
            "        for o in objs[key]:",
            "            groupIds.add(o.getDetails().group.id.val)",
            "            if not o.canAnnotate():",
            "                annotationBlocked = (",
            "                    \"Can't add annotations because you don't\" \" have permissions\"",
            "                )",
            "            obj_labels.append({\"type\": key.title(), \"id\": o.id, \"name\": o.getName()})",
            "    obj_string = \"&\".join(obj_ids)",
            "    link_string = \"|\".join(obj_ids).replace(\"=\", \"-\")",
            "    if len(groupIds) == 0:",
            "        # No supported objects found.",
            "        # If multiple tags / tagsets selected, return placeholder",
            "        if (",
            "            len(request.GET.getlist(\"tag\")) > 0",
            "            or len(request.GET.getlist(\"tagset\")) > 0",
            "        ):",
            "            return HttpResponse(\"<h2>Can't batch annotate tags</h2>\")",
            "        else:",
            "            return handlerInternalError(request, \"No objects found\")",
            "    groupId = list(groupIds)[0]",
            "    conn.SERVICE_OPTS.setOmeroGroup(groupId)",
            "",
            "    manager = BaseContainer(conn)",
            "    figScripts = manager.listFigureScripts(objs)",
            "    canExportAsJpg = manager.canExportAsJpg(request, objs)",
            "    filesetInfo = None",
            "    iids = []",
            "    if \"image\" in objs and len(objs[\"image\"]) > 0:",
            "        iids = [i.getId() for i in objs[\"image\"]]",
            "    if len(iids) > 0:",
            "        filesetInfo = conn.getFilesetFilesInfo(iids)",
            "        archivedInfo = conn.getArchivedFilesInfo(iids)",
            "        filesetInfo[\"count\"] += archivedInfo[\"count\"]",
            "        filesetInfo[\"size\"] += archivedInfo[\"size\"]",
            "",
            "    context = {",
            "        \"iids\": iids,",
            "        \"obj_string\": obj_string,",
            "        \"link_string\": link_string,",
            "        \"obj_labels\": obj_labels,",
            "        \"batch_ann\": True,",
            "        \"figScripts\": figScripts,",
            "        \"canExportAsJpg\": canExportAsJpg,",
            "        \"filesetInfo\": filesetInfo,",
            "        \"annotationBlocked\": annotationBlocked,",
            "        \"differentGroups\": False,",
            "    }",
            "    if len(groupIds) > 1:",
            "        context[\"annotationBlocked\"] = (",
            "            \"Can't add annotations because\" \" objects are in different groups\"",
            "        )",
            "        context[\"differentGroups\"] = True  # E.g. don't run scripts etc",
            "    context[\"canDownload\"] = manager.canDownload(objs)",
            "    context[\"template\"] = \"webclient/annotations/batch_annotate.html\"",
            "    context[\"webclient_path\"] = reverse(\"webindex\")",
            "    context[\"annotationCounts\"] = manager.getBatchAnnotationCounts(",
            "        getObjects(request, conn)",
            "    )",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_file(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    On 'POST', This handles attaching an existing file-annotation(s) and/or",
            "    upload of a new file to one or more objects",
            "    Otherwise it generates the form for choosing file-annotations & local",
            "    files.",
            "    \"\"\"",
            "    oids = getObjects(request, conn)",
            "    selected = getIds(request)",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": oids[\"image\"],",
            "        \"datasets\": oids[\"dataset\"],",
            "        \"projects\": oids[\"project\"],",
            "        \"screens\": oids[\"screen\"],",
            "        \"plates\": oids[\"plate\"],",
            "        \"acquisitions\": oids[\"acquisition\"],",
            "        \"wells\": oids[\"well\"],",
            "    }",
            "",
            "    # Use the first object we find to set context (assume all objects are in",
            "    # same group!)",
            "    for obs in oids.values():",
            "        if len(obs) > 0:",
            "            conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "            break",
            "",
            "    obj_count = sum([len(selected[types]) for types in selected])",
            "    if obj_count == 0:",
            "        raise Http404(\"Need to specify objects via e.g. ?image=1\")",
            "",
            "    # Get appropriate manager, either to list available Files to add to single",
            "    # object, or list ALL Files (multiple objects)",
            "    manager = None",
            "    if obj_count == 1:",
            "        for t in selected:",
            "            if len(selected[t]) > 0:",
            "                o_type = t[:-1]  # \"images\" -> \"image\"",
            "                o_id = selected[t][0]",
            "                break",
            "        if o_type in (",
            "            \"dataset\",",
            "            \"project\",",
            "            \"image\",",
            "            \"screen\",",
            "            \"plate\",",
            "            \"acquisition\",",
            "            \"well\",",
            "            \"comment\",",
            "            \"file\",",
            "            \"tag\",",
            "            \"tagset\",",
            "        ):",
            "            if o_type == \"tagset\":",
            "                # TODO: this should be handled by the BaseContainer",
            "                o_type = \"tag\"",
            "            kw = {}",
            "            if o_type is not None and int(o_id) > 0:",
            "                kw[str(o_type)] = int(o_id)",
            "            try:",
            "                manager = BaseContainer(conn, **kw)",
            "            except AttributeError as x:",
            "                return handlerInternalError(request, x)",
            "",
            "    if manager is not None:",
            "        files = manager.getFilesByObject()",
            "    else:",
            "        manager = BaseContainer(conn)",
            "        for dtype, objs in oids.items():",
            "            if len(objs) > 0:",
            "                # NB: we only support a single data-type now. E.g. 'image' OR",
            "                # 'dataset' etc.",
            "                files = manager.getFilesByObject(",
            "                    parent_type=dtype, parent_ids=[o.getId() for o in objs]",
            "                )",
            "                break",
            "",
            "    initial[\"files\"] = files",
            "",
            "    if request.method == \"POST\":",
            "        # handle form submission",
            "        form_file = FilesAnnotationForm(initial=initial, data=request.POST.copy())",
            "        if form_file.is_valid():",
            "            # Link existing files...",
            "            files = form_file.cleaned_data[\"files\"]",
            "            added_files = []",
            "            if files is not None and len(files) > 0:",
            "                added_files = manager.createAnnotationsLinks(\"file\", files, oids)",
            "            # upload new file",
            "            fileupload = (",
            "                \"annotation_file\" in request.FILES",
            "                and request.FILES[\"annotation_file\"]",
            "                or None",
            "            )",
            "            if fileupload is not None and fileupload != \"\":",
            "                newFileId = manager.createFileAnnotations(fileupload, oids)",
            "                added_files.append(newFileId)",
            "            return JsonResponse({\"fileIds\": added_files})",
            "        else:",
            "            return HttpResponse(form_file.errors)",
            "",
            "    else:",
            "        form_file = FilesAnnotationForm(initial=initial)",
            "        context = {\"form_file\": form_file}",
            "        template = \"webclient/annotations/files_form.html\"",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_rating(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Handle adding Rating to one or more objects",
            "    \"\"\"",
            "    if request.method != \"POST\":",
            "        raise Http404(\"Only POST supported\")",
            "    rating = getIntOrDefault(request, \"rating\", 0)",
            "    oids = getObjects(request, conn)",
            "",
            "    # add / update rating",
            "    for otype, objs in oids.items():",
            "        for o in objs:",
            "            o.setRating(rating)",
            "",
            "    # return a summary of ratings",
            "    return JsonResponse({\"success\": True})",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_comment(request, conn=None, **kwargs):",
            "    \"\"\"Handle adding Comments to one or more objects",
            "    Unbound instance of Comment form not available.",
            "    If the form has been submitted, a bound instance of the form",
            "    is created using request.POST\"\"\"",
            "",
            "    if request.method != \"POST\":",
            "        raise Http404(\"Unbound instance of form not available.\")",
            "",
            "    oids = getObjects(request, conn)",
            "    selected = getIds(request)",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": oids[\"image\"],",
            "        \"datasets\": oids[\"dataset\"],",
            "        \"projects\": oids[\"project\"],",
            "        \"screens\": oids[\"screen\"],",
            "        \"plates\": oids[\"plate\"],",
            "        \"acquisitions\": oids[\"acquisition\"],",
            "        \"wells\": oids[\"well\"],",
            "        \"shares\": oids[\"share\"],",
            "    }",
            "",
            "    # Use the first object we find to set context (assume all objects are in",
            "    # same group!) this does not aplly to share",
            "    if len(oids[\"share\"]) < 1:",
            "        for obs in oids.values():",
            "            if len(obs) > 0:",
            "                conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "                break",
            "",
            "    # Handle form submission...",
            "    form_multi = CommentAnnotationForm(initial=initial, data=request.POST.copy())",
            "    if form_multi.is_valid():",
            "        # In each case below, we pass the {'object_type': [ids]} map",
            "        content = form_multi.cleaned_data[\"comment\"]",
            "        if content is not None and content != \"\":",
            "            if oids[\"share\"] is not None and len(oids[\"share\"]) > 0:",
            "                sid = oids[\"share\"][0].id",
            "                manager = BaseShare(conn, sid)",
            "                host = \"%s?server=%i\" % (",
            "                    request.build_absolute_uri(",
            "                        reverse(\"load_template\", args=[\"public\"])",
            "                    ),",
            "                    int(conn.server_id),",
            "                )",
            "                textAnn = manager.addComment(host, content)",
            "                # For shares we need to return html for display...",
            "                context = {",
            "                    \"tann\": textAnn,",
            "                    \"added_by\": conn.getUserId(),",
            "                    \"template\": \"webclient/annotations/comment.html\",",
            "                }",
            "            else:",
            "                # ...otherwise Comments are re-loaded by AJAX json",
            "                # so we don't *need* to return anything",
            "                manager = BaseContainer(conn)",
            "                annId = manager.createCommentAnnotations(content, oids)",
            "                context = {\"annId\": annId, \"added_by\": conn.getUserId()}",
            "            return context",
            "    else:",
            "        # TODO: handle invalid form error",
            "        return HttpResponse(str(form_multi.errors))",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_map(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Handle adding Map Annotations to one or more objects",
            "    POST data \"mapAnnotation\" should be list of ['key':'value'] pairs.",
            "    \"\"\"",
            "",
            "    if request.method != \"POST\":",
            "        raise Http404(",
            "            \"Need to POST map annotation data as list of\" \" ['key', 'value'] pairs\"",
            "        )",
            "",
            "    oids = getObjects(request, conn)",
            "",
            "    # Use the first object we find to set context (assume all objects are in",
            "    # same group!)",
            "    # this does not aplly to share",
            "    if len(oids[\"share\"]) < 1:",
            "        for obs in oids.values():",
            "            if len(obs) > 0:",
            "                conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "                break",
            "",
            "    data = request.POST.get(\"mapAnnotation\")",
            "    data = json.loads(data)",
            "",
            "    annIds = request.POST.getlist(\"annId\")",
            "    ns = request.POST.get(\"ns\", omero.constants.metadata.NSCLIENTMAPANNOTATION)",
            "",
            "    # Create a new annotation",
            "    if len(annIds) == 0 and len(data) > 0:",
            "        duplicate = request.POST.get(\"duplicate\", \"false\")",
            "        duplicate.lower() == \"true\"",
            "        # For 'client' map annotations, we enforce 1 annotation per object",
            "        if ns == omero.constants.metadata.NSCLIENTMAPANNOTATION:",
            "            duplicate = True",
            "        if duplicate:",
            "            # Create a new Map Annotation for each object:",
            "            for k, objs in oids.items():",
            "                for obj in objs:",
            "                    ann = omero.gateway.MapAnnotationWrapper(conn)",
            "                    ann.setValue(data)",
            "                    ann.setNs(ns)",
            "                    ann.save()",
            "                    annIds.append(ann.getId())",
            "                    obj.linkAnnotation(ann)",
            "        else:",
            "            # Create single Map Annotation and link to all objects",
            "            ann = omero.gateway.MapAnnotationWrapper(conn)",
            "            ann.setValue(data)",
            "            ann.setNs(ns)",
            "            ann.save()",
            "            annIds.append(ann.getId())",
            "            for k, objs in oids.items():",
            "                for obj in objs:",
            "                    obj.linkAnnotation(ann)",
            "    # Or update existing annotations",
            "    else:",
            "        for annId in annIds:",
            "            ann = conn.getObject(\"MapAnnotation\", annId)",
            "            if ann is None:",
            "                continue",
            "            if len(data) > 0:",
            "                ann.setValue(data)",
            "                ann.save()",
            "            else:",
            "                # Delete if no data",
            "                handle = conn.deleteObjects(\"/Annotation\", [annId])",
            "                try:",
            "                    conn._waitOnCmd(handle)",
            "                finally:",
            "                    handle.close()",
            "        if len(data) == 0:",
            "            annIds = None",
            "",
            "    return {\"annId\": annIds}",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def marshal_tagging_form_data(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Provides json data to ome.tagging_form.js",
            "    \"\"\"",
            "",
            "    group = get_long_or_default(request, \"group\", -1)",
            "    conn.SERVICE_OPTS.setOmeroGroup(str(group))",
            "    try:",
            "        offset = int(request.GET.get(\"offset\"))",
            "        limit = int(request.GET.get(\"limit\", 1000))",
            "    except Exception:",
            "        offset = limit = None",
            "",
            "    jsonmode = request.GET.get(\"jsonmode\")",
            "    if jsonmode == \"tagcount\":",
            "        tag_count = conn.getTagCount()",
            "        return dict(tag_count=tag_count)",
            "",
            "    manager = BaseContainer(conn)",
            "    manager.loadTagsRecursive(eid=-1, offset=offset, limit=limit)",
            "    all_tags = manager.tags_recursive",
            "    all_tags_owners = manager.tags_recursive_owners",
            "",
            "    if jsonmode == \"tags\":",
            "        # send tag information without descriptions",
            "        r = list((i, t, o, s) for i, d, t, o, s in all_tags)",
            "        return r",
            "",
            "    elif jsonmode == \"desc\":",
            "        # send descriptions for tags",
            "        return dict((i, d) for i, d, t, o, s in all_tags)",
            "",
            "    elif jsonmode == \"owners\":",
            "        # send owner information",
            "        return all_tags_owners",
            "",
            "    return HttpResponse()",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_tags(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This handles creation AND submission of Tags form, adding new AND/OR",
            "    existing tags to one or more objects",
            "    \"\"\"",
            "",
            "    oids = getObjects(request, conn)",
            "    selected = getIds(request)",
            "    obj_count = sum([len(selected[types]) for types in selected])",
            "",
            "    # Get appropriate manager, either to list available Tags to add to single",
            "    # object, or list ALL Tags (multiple objects)",
            "    manager = None",
            "    self_id = conn.getEventContext().userId",
            "",
            "    tags = []",
            "",
            "    # Use the first object we find to set context (assume all objects are",
            "    # in same group!)",
            "    for obs in oids.values():",
            "        if len(obs) > 0:",
            "            conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "            break",
            "",
            "    # Make a list of all current tags",
            "    # As would be on right column of tagging dialog...",
            "    taglist, users = tree.marshal_annotations(",
            "        conn,",
            "        project_ids=selected[\"projects\"],",
            "        dataset_ids=selected[\"datasets\"],",
            "        image_ids=selected[\"images\"],",
            "        screen_ids=selected[\"screens\"],",
            "        plate_ids=selected[\"plates\"],",
            "        run_ids=selected[\"acquisitions\"],",
            "        well_ids=selected[\"wells\"],",
            "        ann_type=\"tag\",",
            "        # If we reach this limit we'll get some tags not removed",
            "        limit=ANNOTATIONS_LIMIT,",
            "    )",
            "",
            "    userMap = {}",
            "    for exp in users:",
            "        userMap[exp[\"id\"]] = exp",
            "",
            "    # For batch annotate, only include tags that user has added to all objects",
            "    if obj_count > 1:",
            "        # count my links",
            "        myLinkCount = {}",
            "        for t in taglist:",
            "            tid = t[\"id\"]",
            "            if tid not in myLinkCount:",
            "                myLinkCount[tid] = 0",
            "            if t[\"link\"][\"owner\"][\"id\"] == self_id:",
            "                myLinkCount[tid] += 1",
            "        # filter",
            "        taglist = [t for t in taglist if myLinkCount[t[\"id\"]] == obj_count]",
            "",
            "    selected_tags = []",
            "    for tag in taglist:",
            "        linkOwnerId = tag[\"link\"][\"owner\"][\"id\"]",
            "        owner = userMap[linkOwnerId]",
            "        ownerName = \"%s %s\" % (owner[\"firstName\"], owner[\"lastName\"])",
            "        canDelete = True",
            "        created = tag[\"link\"][\"date\"]",
            "        linkOwned = linkOwnerId == self_id",
            "        selected_tags.append(",
            "            (tag[\"id\"], self_id, ownerName, canDelete, created, linkOwned)",
            "        )",
            "",
            "    # selected_tags is really a list of tag LINKS.",
            "    # May be several links per tag.id",
            "    selected_tags.sort(key=lambda x: x[0])",
            "",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": oids[\"image\"],",
            "        \"datasets\": oids[\"dataset\"],",
            "        \"projects\": oids[\"project\"],",
            "        \"screens\": oids[\"screen\"],",
            "        \"plates\": oids[\"plate\"],",
            "        \"acquisitions\": oids[\"acquisition\"],",
            "        \"wells\": oids[\"well\"],",
            "    }",
            "",
            "    if request.method == \"POST\":",
            "        # handle form submission",
            "        form_tags = TagsAnnotationForm(initial=initial, data=request.POST.copy())",
            "        newtags_formset = NewTagsAnnotationFormSet(",
            "            prefix=\"newtags\", data=request.POST.copy()",
            "        )",
            "        # Create new tags or Link existing tags...",
            "        if form_tags.is_valid() and newtags_formset.is_valid():",
            "            # filter down previously selected tags to the ones linked by",
            "            # current user",
            "            selected_tag_ids = [stag[0] for stag in selected_tags if stag[5]]",
            "            # Remove duplicates from tag IDs",
            "            selected_tag_ids = list(set(selected_tag_ids))",
            "            post_tags = list(form_tags.cleaned_data[\"tags\"])",
            "            tags = [tag for tag in post_tags if tag not in selected_tag_ids]",
            "            removed = [tag for tag in selected_tag_ids if tag not in post_tags]",
            "            manager = BaseContainer(conn)",
            "            if tags:",
            "                manager.createAnnotationsLinks(\"tag\", tags, oids)",
            "            new_tags = []",
            "            for form in newtags_formset.forms:",
            "                new_tags.append(",
            "                    manager.createTagAnnotations(",
            "                        form.cleaned_data[\"tag\"],",
            "                        form.cleaned_data[\"description\"],",
            "                        oids,",
            "                        tag_group_id=form.cleaned_data[\"tagset\"],",
            "                    )",
            "                )",
            "            # only remove Tags where the link is owned by self_id",
            "            for remove in removed:",
            "                tag_manager = BaseContainer(conn, tag=remove)",
            "                tag_manager.remove(",
            "                    [",
            "                        \"%s-%s\" % (dtype, obj.id)",
            "                        for dtype, objs in oids.items()",
            "                        for obj in objs",
            "                    ],",
            "                    tag_owner_id=self_id,",
            "                )",
            "            return JsonResponse({\"added\": tags, \"removed\": removed, \"new\": new_tags})",
            "        else:",
            "            # TODO: handle invalid form error",
            "            return HttpResponse(str(form_tags.errors))",
            "",
            "    else:",
            "        form_tags = TagsAnnotationForm(initial=initial)",
            "        newtags_formset = NewTagsAnnotationFormSet(prefix=\"newtags\")",
            "        context = {",
            "            \"form_tags\": form_tags,",
            "            \"newtags_formset\": newtags_formset,",
            "            \"selected_tags\": selected_tags,",
            "        }",
            "        template = \"webclient/annotations/tags_form.html\"",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "@render_response()",
            "def edit_channel_names(request, imageId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Edit and save channel names",
            "    \"\"\"",
            "    image = conn.getObject(\"Image\", imageId)",
            "    sizeC = image.getSizeC()",
            "    channelNames = {}",
            "    nameDict = {}",
            "    for i in range(sizeC):",
            "        cname = request.POST.get(\"channel%d\" % i, None)",
            "        if cname is not None:",
            "            cname = smart_str(cname)[:255]  # Truncate to fit in DB",
            "            channelNames[\"channel%d\" % i] = cname",
            "            nameDict[i + 1] = cname",
            "    # If the 'Apply to Dataset' button was used to submit...",
            "    if request.POST.get(\"confirm_apply\", None) is not None:",
            "        # plate-123 OR dataset-234",
            "        parentId = request.POST.get(\"parentId\", None)",
            "        if parentId is not None:",
            "            ptype = parentId.split(\"-\")[0].title()",
            "            pid = long(parentId.split(\"-\")[1])",
            "            counts = conn.setChannelNames(ptype, [pid], nameDict, channelCount=sizeC)",
            "    else:",
            "        counts = conn.setChannelNames(\"Image\", [image.getId()], nameDict)",
            "    rv = {\"channelNames\": channelNames}",
            "    if counts:",
            "        rv[\"imageCount\"] = counts[\"imageCount\"]",
            "        rv[\"updateCount\"] = counts[\"updateCount\"]",
            "        return rv",
            "    else:",
            "        return {\"error\": \"No parent found to apply Channel Names\"}",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "@render_response()",
            "def manage_action_containers(",
            "    request, action, o_type=None, o_id=None, conn=None, **kwargs",
            "):",
            "    \"\"\"",
            "    Handles many different actions on various objects.",
            "",
            "    @param action:      \"addnewcontainer\", (creates a new Project, Dataset,",
            "                        Screen), \"editname\", \"savename\", \"editdescription\",",
            "                        \"savedescription\",  (used as GET and POST for in-line",
            "                        editing),",
            "                        \"removefromshare\", (tree P/D/I moving etc)",
            "                        \"delete\", \"deletemany\"      (delete objects)",
            "                        \"remove\" (remove tag/comment from object)",
            "    @param o_type:      \"dataset\", \"project\", \"image\", \"screen\", \"plate\",",
            "                        \"acquisition\", \"well\",\"comment\", \"file\", \"tag\",",
            "                        \"tagset\",\"share\", \"sharecomment\"",
            "    \"\"\"",
            "    template = None",
            "",
            "    manager = None",
            "    if o_type in (",
            "        \"dataset\",",
            "        \"project\",",
            "        \"image\",",
            "        \"screen\",",
            "        \"plate\",",
            "        \"acquisition\",",
            "        \"well\",",
            "        \"comment\",",
            "        \"file\",",
            "        \"tag\",",
            "        \"tagset\",",
            "    ):",
            "        kw = {}",
            "        if o_type is not None and int(o_id) > 0:",
            "            o_id = int(o_id)",
            "            kw[str(o_type)] = o_id",
            "        try:",
            "            manager = BaseContainer(conn, **kw)",
            "        except AttributeError as x:",
            "            return handlerInternalError(request, x)",
            "    elif o_type in (\"share\", \"sharecomment\", \"chat\"):",
            "        manager = BaseShare(conn, o_id)",
            "    else:",
            "        manager = BaseContainer(conn)",
            "",
            "    form = None",
            "    if action == \"addnewcontainer\":",
            "        # Used within the jsTree to add a new Project, Dataset, Tag,",
            "        # Tagset etc under a specified parent OR top-level",
            "        if not request.method == \"POST\":",
            "            return JsonResponse(",
            "                {\"Error\": \"Must use POST to create container\"}, status=405",
            "            )",
            "",
            "        form = ContainerForm(data=request.POST.copy())",
            "        if form.is_valid():",
            "            logger.debug(\"Create new in %s: %s\" % (o_type, str(form.cleaned_data)))",
            "            name = form.cleaned_data[\"name\"]",
            "            description = form.cleaned_data[\"description\"]",
            "            owner = form.cleaned_data[\"owner\"]",
            "",
            "            if o_type == \"project\" and hasattr(manager, o_type) and o_id > 0:",
            "                oid = manager.createDataset(name, description, owner=owner)",
            "            elif o_type == \"tagset\" and o_id > 0:",
            "                oid = manager.createTag(name, description, owner=owner)",
            "            elif request.POST.get(\"folder_type\") in (",
            "                \"project\",",
            "                \"screen\",",
            "                \"dataset\",",
            "                \"tag\",",
            "                \"tagset\",",
            "            ):",
            "                # No parent specified. We can create orphaned 'project',",
            "                # 'dataset' etc.",
            "                folder_type = request.POST.get(\"folder_type\")",
            "                if folder_type == \"dataset\":",
            "                    oid = manager.createDataset(",
            "                        name,",
            "                        description,",
            "                        owner=owner,",
            "                        img_ids=request.POST.getlist(\"image\", None),",
            "                    )",
            "                else:",
            "                    oid = conn.createContainer(",
            "                        folder_type, name, description, owner=owner",
            "                    )",
            "            else:",
            "                return HttpResponseServerError(\"Object does not exist\")",
            "            rdict = {\"bad\": \"false\", \"id\": oid}",
            "            return JsonResponse(rdict)",
            "        else:",
            "            d = dict()",
            "            for e in form.errors.items():",
            "                d.update({e[0]: unicode(e[1])})",
            "            rdict = {\"bad\": \"true\", \"errs\": d}",
            "            return JsonResponse(rdict)",
            "    elif action == \"add\":",
            "        template = \"webclient/public/share_form.html\"",
            "        experimenters = list(conn.getExperimenters())",
            "        experimenters.sort(key=lambda x: x.getOmeName().lower())",
            "        if o_type == \"share\":",
            "            img_ids = request.GET.getlist(\"image\", request.POST.getlist(\"image\"))",
            "            if request.method == \"GET\" and len(img_ids) == 0:",
            "                return HttpResponse(\"No images specified\")",
            "            images_to_share = list(conn.getObjects(\"Image\", img_ids))",
            "            if request.method == \"POST\":",
            "                form = BasketShareForm(",
            "                    initial={\"experimenters\": experimenters, \"images\": images_to_share},",
            "                    data=request.POST.copy(),",
            "                )",
            "                if form.is_valid():",
            "                    images = form.cleaned_data[\"image\"]",
            "                    message = form.cleaned_data[\"message\"]",
            "                    expiration = form.cleaned_data[\"expiration\"]",
            "                    members = form.cleaned_data[\"members\"]",
            "                    # guests = request.POST['guests']",
            "                    enable = form.cleaned_data[\"enable\"]",
            "                    host = \"%s?server=%i\" % (",
            "                        request.build_absolute_uri(",
            "                            reverse(\"load_template\", args=[\"public\"])",
            "                        ),",
            "                        int(conn.server_id),",
            "                    )",
            "                    shareId = manager.createShare(",
            "                        host, images, message, members, enable, expiration",
            "                    )",
            "                    return HttpResponse(\"shareId:%s\" % shareId)",
            "            else:",
            "                initial = {",
            "                    \"experimenters\": experimenters,",
            "                    \"images\": images_to_share,",
            "                    \"enable\": True,",
            "                    \"selected\": request.GET.getlist(\"image\"),",
            "                }",
            "                form = BasketShareForm(initial=initial)",
            "        template = \"webclient/public/share_form.html\"",
            "        context = {\"manager\": manager, \"form\": form}",
            "",
            "    elif action == \"edit\":",
            "        # form for editing Shares only",
            "        if o_id is None:",
            "            raise Http404(\"No share ID\")",
            "        if o_type == \"share\" and int(o_id) > 0:",
            "            template = \"webclient/public/share_form.html\"",
            "            manager.getMembers(o_id)",
            "            manager.getComments(o_id)",
            "            experimenters = list(conn.getExperimenters())",
            "            experimenters.sort(key=lambda x: x.getOmeName().lower())",
            "            initial = {",
            "                \"message\": manager.share.message,",
            "                \"expiration\": \"\",",
            "                \"shareMembers\": manager.membersInShare,",
            "                \"enable\": manager.share.active,",
            "                \"experimenters\": experimenters,",
            "            }",
            "            if manager.share.getExpireDate() is not None:",
            "                initial[\"expiration\"] = manager.share.getExpireDate().strftime(",
            "                    \"%Y-%m-%d\"",
            "                )",
            "            form = ShareForm(initial=initial)  # 'guests':share.guestsInShare,",
            "            context = {\"manager\": manager, \"form\": form}",
            "    elif action == \"save\":",
            "        # Handles submission of the 'edit' form above. TODO: not used now?",
            "        if not request.method == \"POST\":",
            "            return HttpResponseRedirect(",
            "                reverse(\"manage_action_containers\", args=[\"edit\", o_type, o_id])",
            "            )",
            "        if o_type == \"share\":",
            "            experimenters = list(conn.getExperimenters())",
            "            experimenters.sort(key=lambda x: x.getOmeName().lower())",
            "            form = ShareForm(",
            "                initial={\"experimenters\": experimenters}, data=request.POST.copy()",
            "            )",
            "            if form.is_valid():",
            "                logger.debug(\"Update share: %s\" % (str(form.cleaned_data)))",
            "                message = form.cleaned_data[\"message\"]",
            "                expiration = form.cleaned_data[\"expiration\"]",
            "                members = form.cleaned_data[\"members\"]",
            "                # guests = request.POST['guests']",
            "                enable = form.cleaned_data[\"enable\"]",
            "                host = \"%s?server=%i\" % (",
            "                    request.build_absolute_uri(",
            "                        reverse(\"load_template\", args=[\"public\"])",
            "                    ),",
            "                    int(conn.server_id),",
            "                )",
            "                manager.updateShareOrDiscussion(",
            "                    host, message, members, enable, expiration",
            "                )",
            "                r = \"enable\" if enable else \"disable\"",
            "                return HttpResponse(r)",
            "            else:",
            "                template = \"webclient/public/share_form.html\"",
            "                context = {\"share\": manager, \"form\": form}",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"editname\":",
            "        # start editing 'name' in-line",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            obj = getattr(manager, o_type)",
            "            template = \"webclient/ajax_form/container_form_ajax.html\"",
            "            if o_type == \"tag\":",
            "                txtValue = obj.textValue",
            "            else:",
            "                txtValue = obj.getName()",
            "            form = ContainerNameForm(initial={\"name\": txtValue})",
            "            context = {\"manager\": manager, \"form\": form}",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"savename\":",
            "        # Save name edit in-line",
            "        if not request.method == \"POST\":",
            "            return HttpResponseRedirect(",
            "                reverse(\"manage_action_containers\", args=[\"edit\", o_type, o_id])",
            "            )",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            form = ContainerNameForm(data=request.POST.copy())",
            "            if form.is_valid():",
            "                logger.debug(\"Update name form:\" + str(form.cleaned_data))",
            "                name = form.cleaned_data[\"name\"]",
            "                rdict = {\"bad\": \"false\", \"o_type\": o_type}",
            "                manager.updateName(o_type, name)",
            "                return JsonResponse(rdict)",
            "            else:",
            "                d = dict()",
            "                for e in form.errors.items():",
            "                    d.update({e[0]: unicode(e[1])})",
            "                rdict = {\"bad\": \"true\", \"errs\": d}",
            "                return JsonResponse(rdict)",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"editdescription\":",
            "        # start editing description in-line",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            obj = getattr(manager, o_type)",
            "            template = \"webclient/ajax_form/container_form_ajax.html\"",
            "            form = ContainerDescriptionForm(initial={\"description\": obj.description})",
            "            context = {\"manager\": manager, \"form\": form}",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"savedescription\":",
            "        # Save editing of description in-line",
            "        if not request.method == \"POST\":",
            "            return HttpResponseServerError(",
            "                \"Action '%s' on the '%s' id:%s cannot be complited\"",
            "                % (action, o_type, o_id)",
            "            )",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            form = ContainerDescriptionForm(data=request.POST.copy())",
            "            if form.is_valid():",
            "                logger.debug(\"Update name form:\" + str(form.cleaned_data))",
            "                description = form.cleaned_data[\"description\"]",
            "                manager.updateDescription(o_type, description)",
            "                rdict = {\"bad\": \"false\"}",
            "                return JsonResponse(rdict)",
            "            else:",
            "                d = dict()",
            "                for e in form.errors.items():",
            "                    d.update({e[0]: unicode(e[1])})",
            "                rdict = {\"bad\": \"true\", \"errs\": d}",
            "                return JsonResponse(rdict)",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"remove\":",
            "        # Handles removal of comment, tag from",
            "        # Object etc.",
            "        # E.g. image-123  or image-1|image-2",
            "        parents = request.POST[\"parent\"]",
            "        try:",
            "            manager.remove(parents.split(\"|\"))",
            "        except Exception as x:",
            "            logger.error(traceback.format_exc())",
            "            rdict = {\"bad\": \"true\", \"errs\": str(x)}",
            "            return JsonResponse(rdict)",
            "",
            "        rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    elif action == \"removefromshare\":",
            "        image_id = request.POST.get(\"source\")",
            "        try:",
            "            manager.removeImage(image_id)",
            "        except Exception as x:",
            "            logger.error(traceback.format_exc())",
            "            rdict = {\"bad\": \"true\", \"errs\": str(x)}",
            "            return JsonResponse(rdict)",
            "        rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    elif action == \"delete\":",
            "        # Handles delete of a file attached to object.",
            "        child = toBoolean(request.POST.get(\"child\"))",
            "        anns = toBoolean(request.POST.get(\"anns\"))",
            "        try:",
            "            handle = manager.deleteItem(child, anns)",
            "            request.session[\"callback\"][str(handle)] = {",
            "                \"job_type\": \"delete\",",
            "                \"delmany\": False,",
            "                \"did\": o_id,",
            "                \"dtype\": o_type,",
            "                \"status\": \"in progress\",",
            "                \"error\": 0,",
            "                \"dreport\": _formatReport(handle),",
            "                \"start_time\": datetime.datetime.now(),",
            "            }",
            "            request.session.modified = True",
            "        except Exception as x:",
            "            logger.error(",
            "                \"Failed to delete: %r\" % {\"did\": o_id, \"dtype\": o_type}, exc_info=True",
            "            )",
            "            rdict = {\"bad\": \"true\", \"errs\": str(x)}",
            "        else:",
            "            rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    elif action == \"deletemany\":",
            "        # Handles multi-delete from jsTree.",
            "        object_ids = {",
            "            \"Image\": request.POST.getlist(\"image\"),",
            "            \"Dataset\": request.POST.getlist(\"dataset\"),",
            "            \"Project\": request.POST.getlist(\"project\"),",
            "            \"Annotation\": request.POST.getlist(\"tag\"),",
            "            \"Screen\": request.POST.getlist(\"screen\"),",
            "            \"Plate\": request.POST.getlist(\"plate\"),",
            "            \"Well\": request.POST.getlist(\"well\"),",
            "            \"PlateAcquisition\": request.POST.getlist(\"acquisition\"),",
            "        }",
            "        child = toBoolean(request.POST.get(\"child\"))",
            "        anns = toBoolean(request.POST.get(\"anns\"))",
            "        logger.debug(",
            "            \"Delete many: child? %s anns? %s object_ids %s\" % (child, anns, object_ids)",
            "        )",
            "        try:",
            "            for key, ids in object_ids.items():",
            "                if ids is not None and len(ids) > 0:",
            "                    handle = manager.deleteObjects(key, ids, child, anns)",
            "                    if key == \"PlateAcquisition\":",
            "                        key = \"Plate Run\"  # for nicer user message",
            "                    dMap = {",
            "                        \"job_type\": \"delete\",",
            "                        \"start_time\": datetime.datetime.now(),",
            "                        \"status\": \"in progress\",",
            "                        \"error\": 0,",
            "                        \"dreport\": _formatReport(handle),",
            "                        \"dtype\": key,",
            "                    }",
            "                    if len(ids) > 1:",
            "                        dMap[\"delmany\"] = len(ids)",
            "                        dMap[\"did\"] = ids",
            "                    else:",
            "                        dMap[\"delmany\"] = False",
            "                        dMap[\"did\"] = ids[0]",
            "                    request.session[\"callback\"][str(handle)] = dMap",
            "            request.session.modified = True",
            "        except Exception:",
            "            logger.error(",
            "                \"Failed to delete: %r\" % {\"did\": ids, \"dtype\": key}, exc_info=True",
            "            )",
            "            # Ajax error handling will allow user to submit bug report",
            "            raise",
            "        else:",
            "            rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required(doConnectionCleanup=False)",
            "def get_original_file(request, fileId, download=False, conn=None, **kwargs):",
            "    \"\"\"",
            "    Returns the specified original file as an http response. Used for",
            "    displaying text or png/jpeg etc files in browser",
            "    \"\"\"",
            "",
            "    # May be viewing results of a script run in a different group.",
            "    conn.SERVICE_OPTS.setOmeroGroup(-1)",
            "",
            "    orig_file = conn.getObject(\"OriginalFile\", fileId)",
            "    if orig_file is None:",
            "        return handlerInternalError(",
            "            request, \"Original File does not exist (id:%s).\" % (fileId)",
            "        )",
            "",
            "    rsp = ConnCleaningHttpResponse(orig_file.getFileInChunks(buf=settings.CHUNK_SIZE))",
            "    rsp.conn = conn",
            "    mimetype = orig_file.mimetype",
            "    if mimetype == \"text/x-python\":",
            "        mimetype = \"text/plain\"  # allows display in browser",
            "    rsp[\"Content-Type\"] = mimetype",
            "    rsp[\"Content-Length\"] = orig_file.getSize()",
            "",
            "    if download:",
            "        downloadName = orig_file.name.replace(\" \", \"_\")",
            "        downloadName = downloadName.replace(\",\", \".\")",
            "        rsp[\"Content-Disposition\"] = \"attachment; filename=%s\" % downloadName",
            "    return rsp",
            "",
            "",
            "@login_required(doConnectionCleanup=False)",
            "@render_response()",
            "def omero_table(request, file_id, mtype=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Download OMERO.table as CSV (streaming response) or return as HTML or json",
            "",
            "    @param file_id:     OriginalFile ID",
            "    @param mtype:       None for html table or 'csv' or 'json'",
            "    @param conn:        BlitzGateway connection",
            "    \"\"\"",
            "",
            "    query = request.GET.get(\"query\", \"*\")",
            "    offset = get_long_or_default(request, \"offset\", 0)",
            "    limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "    iviewer_url = None",
            "    try:",
            "        iviewer_url = reverse(\"omero_iviewer_index\")",
            "    except NoReverseMatch:",
            "        pass",
            "",
            "    # Check if file exists since _table_query() doesn't check",
            "    file_id = long(file_id)",
            "    orig_file = conn.getObject(\"OriginalFile\", file_id)",
            "    if orig_file is None:",
            "        raise Http404(\"OriginalFile %s not found\" % file_id)",
            "",
            "    lazy = mtype == \"csv\"",
            "    context = webgateway_views._table_query(",
            "        request, file_id, conn=conn, query=query, offset=offset, limit=limit, lazy=lazy",
            "    )",
            "",
            "    if context.get(\"error\") or not context.get(\"data\"):",
            "        return JsonResponse(context)",
            "",
            "    # OR, return as csv or html",
            "    if mtype == \"csv\":",
            "        table_data = context.get(\"data\")",
            "",
            "        def csv_gen():",
            "            csv_cols = \",\".join(table_data.get(\"columns\"))",
            "            yield csv_cols",
            "            for rows in table_data.get(\"lazy_rows\"):",
            "                yield (",
            "                    \"\\n\" + \"\\n\".join([\",\".join([str(d) for d in row]) for row in rows])",
            "                )",
            "",
            "        downloadName = orig_file.name.replace(\" \", \"_\").replace(\",\", \".\")",
            "        downloadName = downloadName + \".csv\"",
            "",
            "        rsp = TableClosingHttpResponse(csv_gen(), content_type=\"text/csv\")",
            "        rsp.conn = conn",
            "        rsp.table = context.get(\"table\")",
            "        rsp[\"Content-Type\"] = \"application/force-download\"",
            "        # rsp['Content-Length'] = ann.getFileSize()",
            "        rsp[\"Content-Disposition\"] = \"attachment; filename=%s\" % downloadName",
            "        return rsp",
            "",
            "    context[\"data\"][\"name\"] = orig_file.name",
            "    context[\"data\"][\"path\"] = orig_file.path",
            "    context[\"data\"][\"id\"] = file_id",
            "    context[\"meta\"][\"query\"] = query",
            "",
            "    # check if offset matches an integer page number:",
            "    if offset == 0 or offset / limit == offset // limit:",
            "        context[\"meta\"][\"page\"] = (offset // limit) + 1 if offset > 0 else 1",
            "",
            "    # pagination links",
            "    url = reverse(\"omero_table\", args=[file_id])",
            "    context[\"meta\"][\"url\"] = url",
            "    url += \"?limit=%s\" % limit",
            "    if query != \"*\":",
            "        url += \"&query=%s\" % query",
            "    if (offset + limit) < context[\"meta\"][\"totalCount\"]:",
            "        context[\"meta\"][\"next\"] = url + \"&offset=%s\" % (offset + limit)",
            "    if offset > 0:",
            "        context[\"meta\"][\"prev\"] = url + \"&offset=%s\" % (max(0, offset - limit))",
            "",
            "    # by default, return context as JSON data",
            "    if mtype is None:",
            "        context[\"template\"] = \"webclient/annotations/omero_table.html\"",
            "        context[\"iviewer_url\"] = iviewer_url",
            "        col_types = context[\"data\"][\"column_types\"]",
            "        if \"ImageColumn\" in col_types:",
            "            context[\"image_column_index\"] = col_types.index(\"ImageColumn\")",
            "        if \"WellColumn\" in col_types:",
            "            context[\"well_column_index\"] = col_types.index(\"WellColumn\")",
            "        if \"RoiColumn\" in col_types:",
            "            context[\"roi_column_index\"] = col_types.index(\"RoiColumn\")",
            "        # provide example queries - pick first DoubleColumn...",
            "        for idx, c_type in enumerate(col_types):",
            "            if c_type in (\"DoubleColumn\", \"LongColumn\"):",
            "                col_name = context[\"data\"][\"columns\"][idx]",
            "                # find first few non-empty cells...",
            "                vals = []",
            "                for row in context[\"data\"][\"rows\"]:",
            "                    if row[idx]:",
            "                        vals.append(row[idx])",
            "                    if len(vals) > 3:",
            "                        break",
            "                if \" \" in col_name or len(vals) < 2:",
            "                    # Don't support queries on columns with spaces",
            "                    continue",
            "                context[\"example_column\"] = col_name",
            "                context[\"example_min_value\"] = min(vals)",
            "                context[\"example_max_value\"] = max(vals)",
            "                break",
            "",
            "    return context",
            "",
            "",
            "@login_required(doConnectionCleanup=False)",
            "def download_annotation(request, annId, conn=None, **kwargs):",
            "    \"\"\" Returns the file annotation as an http response for download \"\"\"",
            "    ann = conn.getObject(\"FileAnnotation\", annId)",
            "    if ann is None:",
            "        return handlerInternalError(",
            "            request, \"FileAnnotation does not exist (id:%s).\" % (annId)",
            "        )",
            "",
            "    rsp = ConnCleaningHttpResponse(ann.getFileInChunks(buf=settings.CHUNK_SIZE))",
            "    rsp.conn = conn",
            "    rsp[\"Content-Type\"] = \"application/force-download\"",
            "    rsp[\"Content-Length\"] = ann.getFileSize()",
            "    rsp[\"Content-Disposition\"] = \"attachment; filename=%s\" % (",
            "        ann.getFileName().replace(\" \", \"_\")",
            "    )",
            "    return rsp",
            "",
            "",
            "@login_required()",
            "def download_orig_metadata(request, imageId, conn=None, **kwargs):",
            "    \"\"\" Downloads the 'Original Metadata' as a text file \"\"\"",
            "",
            "    image = conn.getObject(\"Image\", imageId)",
            "    if image is None:",
            "        raise Http404(\"No Image found with ID %s\" % imageId)",
            "",
            "    om = image.loadOriginalMetadata()",
            "",
            "    txtLines = [\"[Global Metadata]\"]",
            "    txtLines.extend([\"%s=%s\" % (kv[0], kv[1]) for kv in om[1]])",
            "",
            "    txtLines.append(\"[Series Metadata]\")",
            "    txtLines.extend([\"%s=%s\" % (kv[0], kv[1]) for kv in om[2]])",
            "    rspText = \"\\n\".join(txtLines)",
            "",
            "    rsp = HttpResponse(rspText)",
            "    rsp[\"Content-Type\"] = \"application/force-download\"",
            "    rsp[\"Content-Length\"] = len(rspText)",
            "    rsp[\"Content-Disposition\"] = \"attachment; filename=Original_Metadata.txt\"",
            "    return rsp",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def download_placeholder(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Page displays a simple \"Preparing download...\" message and redirects to",
            "    the 'url'.",
            "    We construct the url and query string from request: 'url' and 'ids'.",
            "    \"\"\"",
            "",
            "    format = request.GET.get(\"format\", None)",
            "    if format is not None:",
            "        download_url = reverse(\"download_as\")",
            "        zipName = \"Export_as_%s\" % format",
            "    else:",
            "        download_url = reverse(\"archived_files\")",
            "        zipName = \"OriginalFileDownload\"",
            "    targetIds = request.GET.get(\"ids\")  # E.g. image-1|image-2",
            "    defaultName = request.GET.get(\"name\", zipName)  # default zip name",
            "    defaultName = os.path.basename(defaultName)  # remove path",
            "",
            "    if targetIds is None:",
            "        raise Http404(\"No IDs specified. E.g. ?ids=image-1|image-2\")",
            "",
            "    ids = targetIds.split(\"|\")",
            "",
            "    fileLists = []",
            "    fileCount = 0",
            "    filesTotalSize = 0",
            "    # If we're downloading originals, list original files so user can",
            "    # download individual files.",
            "    if format is None:",
            "        imgIds = []",
            "        wellIds = []",
            "        for i in ids:",
            "            if i.split(\"-\")[0] == \"image\":",
            "                imgIds.append(i.split(\"-\")[1])",
            "            elif i.split(\"-\")[0] == \"well\":",
            "                wellIds.append(i.split(\"-\")[1])",
            "",
            "        images = []",
            "        # Get images...",
            "        if imgIds:",
            "            images = list(conn.getObjects(\"Image\", imgIds))",
            "",
            "        if len(images) == 0:",
            "            raise Http404(\"No images found.\")",
            "",
            "        # Have a list of files per fileset (or per image without fileset)",
            "        fsIds = set()",
            "        fileIds = set()",
            "        for image in images:",
            "            fs = image.getFileset()",
            "            if fs is not None:",
            "                # Make sure we've not processed this fileset before.",
            "                if fs.id in fsIds:",
            "                    continue",
            "                fsIds.add(fs.id)",
            "            files = list(image.getImportedImageFiles())",
            "            fList = []",
            "            for f in files:",
            "                if f.id in fileIds:",
            "                    continue",
            "                fileIds.add(f.id)",
            "                fList.append({\"id\": f.id, \"name\": f.name, \"size\": f.getSize()})",
            "                filesTotalSize += f.getSize()",
            "            if len(fList) > 0:",
            "                fileLists.append(fList)",
            "        fileCount = sum([len(fList) for fList in fileLists])",
            "    else:",
            "        # E.g. JPEG/PNG - 1 file per image",
            "        fileCount = len(ids)",
            "",
            "    query = \"&\".join([_id.replace(\"-\", \"=\") for _id in ids])",
            "    download_url = download_url + \"?\" + query",
            "    if format is not None:",
            "        download_url = download_url + \"&format=%s\" % format",
            "",
            "    context = {",
            "        \"template\": \"webclient/annotations/download_placeholder.html\",",
            "        \"url\": download_url,",
            "        \"defaultName\": defaultName,",
            "        \"fileLists\": fileLists,",
            "        \"fileCount\": fileCount,",
            "        \"filesTotalSize\": filesTotalSize,",
            "    }",
            "    if filesTotalSize > settings.MAXIMUM_MULTIFILE_DOWNLOAD_ZIP_SIZE:",
            "        context[\"downloadTooLarge\"] = settings.MAXIMUM_MULTIFILE_DOWNLOAD_ZIP_SIZE",
            "    return context",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "@render_response()",
            "def load_calendar(request, year=None, month=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Loads the calendar which is displayed in the left panel of the history",
            "    page.",
            "    Shows current month by default. Filter by experimenter",
            "    \"\"\"",
            "",
            "    template = \"webclient/history/calendar.html\"",
            "    filter_user_id = request.session.get(\"user_id\")",
            "",
            "    if year is not None and month is not None:",
            "        controller = BaseCalendar(conn=conn, year=year, month=month, eid=filter_user_id)",
            "    else:",
            "        today = datetime.datetime.today()",
            "        controller = BaseCalendar(",
            "            conn=conn, year=today.year, month=today.month, eid=filter_user_id",
            "        )",
            "    controller.create_calendar()",
            "",
            "    context = {\"controller\": controller}",
            "",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "@render_response()",
            "def load_history(request, year, month, day, conn=None, **kwargs):",
            "    \"\"\" The data for a particular date that is loaded into the center panel \"\"\"",
            "",
            "    if year is None or month is None or day is None:",
            "        raise Http404(\"Year, month, and day are required\")",
            "",
            "    template = \"webclient/history/history_details.html\"",
            "",
            "    # get page",
            "    page = int(request.GET.get(\"page\", 1))",
            "",
            "    filter_user_id = request.session.get(\"user_id\")",
            "    controller = BaseCalendar(",
            "        conn=conn, year=year, month=month, day=day, eid=filter_user_id",
            "    )",
            "    controller.get_items(page)",
            "",
            "    context = {\"controller\": controller}",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "def getObjectUrl(conn, obj):",
            "    \"\"\"",
            "    This provides a url to browse to the specified omero.model.ObjectI P/D/I,",
            "    S/P, FileAnnotation etc. used to display results from the scripting",
            "    service",
            "    E.g webclient/userdata/?path=image-12601",
            "    If the object is a file annotation, try to browse to the parent P/D/I",
            "    \"\"\"",
            "    base_url = reverse(viewname=\"load_template\", args=[\"userdata\"])",
            "",
            "    # if we have a File Annotation, then we want our URL to be for the parent",
            "    # object...",
            "    if isinstance(obj, omero.model.FileAnnotationI):",
            "        fa = conn.getObject(\"Annotation\", obj.id.val)",
            "        for ptype in [\"project\", \"dataset\", \"image\"]:",
            "            links = list(fa.getParentLinks(ptype))",
            "            if len(links) > 0:",
            "                obj = links[0].parent",
            "                break",
            "",
            "    if obj.__class__.__name__ in (",
            "        \"ImageI\",",
            "        \"DatasetI\",",
            "        \"ProjectI\",",
            "        \"ScreenI\",",
            "        \"PlateI\",",
            "        \"WellI\",",
            "    ):",
            "        otype = obj.__class__.__name__[:-1].lower()",
            "        base_url += \"?show=%s-%s\" % (otype, obj.id.val)",
            "        return base_url",
            "",
            "",
            "######################",
            "# Activities window & Progressbar",
            "def update_callback(request, cbString, **kwargs):",
            "    \"\"\"Update a callback handle with  key/value pairs\"\"\"",
            "    for key, value in kwargs.items():",
            "        request.session[\"callback\"][cbString][key] = value",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def activities(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This refreshes callback handles (delete, scripts, chgrp etc) and provides",
            "    html to update Activities window & Progressbar.",
            "    The returned html contains details for ALL callbacks in web session,",
            "    regardless of their status.",
            "    We also add counts of jobs, failures and 'in progress' to update status",
            "    bar.",
            "    \"\"\"",
            "",
            "    in_progress = 0",
            "    failure = 0",
            "    new_results = []",
            "    _purgeCallback(request)",
            "",
            "    # If we have a jobId (not added to request.session) just process it...",
            "    # ONLY used for chgrp/chown dry-run.",
            "    jobId = request.GET.get(\"jobId\", None)",
            "    if jobId is not None:",
            "        jobId = str(jobId)",
            "        try:",
            "            prx = omero.cmd.HandlePrx.checkedCast(conn.c.ic.stringToProxy(jobId))",
            "            status = prx.getStatus()",
            "            logger.debug(\"job status: %s\", status)",
            "            rsp = prx.getResponse()",
            "            if rsp is not None:",
            "                rv = graphResponseMarshal(conn, rsp)",
            "                rv[\"finished\"] = True",
            "            else:",
            "                rv = {\"finished\": False}",
            "            rv[\"status\"] = {",
            "                \"currentStep\": status.currentStep,",
            "                \"steps\": status.steps,",
            "                \"startTime\": status.startTime,",
            "                \"stopTime\": status.stopTime,",
            "            }",
            "        except IceException:",
            "            rv = {\"finished\": True}",
            "        return rv",
            "",
            "    elif request.method == \"DELETE\":",
            "        try:",
            "            json_data = json.loads(request.body)",
            "        except TypeError:",
            "            # for Python 3.5",
            "            json_data = json.loads(bytes_to_native_str(request.body))",
            "        jobId = json_data.get(\"jobId\", None)",
            "        if jobId is not None:",
            "            jobId = str(jobId)",
            "            rv = {\"jobId\": jobId}",
            "            try:",
            "                prx = omero.cmd.HandlePrx.checkedCast(conn.c.ic.stringToProxy(jobId))",
            "                status = prx.getStatus()",
            "                logger.debug(\"pre-cancel() job status: %s\", status)",
            "                rv[\"status\"] = {",
            "                    \"currentStep\": status.currentStep,",
            "                    \"steps\": status.steps,",
            "                    \"startTime\": status.startTime,",
            "                    \"stopTime\": status.stopTime,",
            "                }",
            "                prx.cancel()",
            "            except omero.LockTimeout:",
            "                # expected that it will take > 5 seconds to cancel",
            "                logger.info(\"Timeout on prx.cancel()\")",
            "        return rv",
            "",
            "    # test each callback for failure, errors, completion, results etc",
            "    for cbString in request.session.get(\"callback\").keys():",
            "        callbackDict = request.session[\"callback\"][cbString]",
            "        job_type = callbackDict[\"job_type\"]",
            "",
            "        status = callbackDict[\"status\"]",
            "        if status == \"failed\":",
            "            failure += 1",
            "",
            "        request.session.modified = True",
            "",
            "        # update chgrp / chown",
            "        if job_type in (\"chgrp\", \"chown\"):",
            "            if status not in (\"failed\", \"finished\"):",
            "                rsp = None",
            "                try:",
            "                    prx = omero.cmd.HandlePrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                    rsp = prx.getResponse()",
            "                    close_handle = False",
            "                    try:",
            "                        # if response is None, then we're still in progress,",
            "                        # otherwise...",
            "                        if rsp is not None:",
            "                            close_handle = True",
            "                            new_results.append(cbString)",
            "                            if isinstance(rsp, omero.cmd.ERR):",
            "                                rsp_params = \", \".join(",
            "                                    [",
            "                                        \"%s: %s\" % (k, v)",
            "                                        for k, v in rsp.parameters.items()",
            "                                    ]",
            "                                )",
            "                                logger.error(",
            "                                    \"%s failed with: %s\" % (job_type, rsp_params)",
            "                                )",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    status=\"failed\",",
            "                                    report=\"%s %s\" % (rsp.name, rsp_params),",
            "                                    error=1,",
            "                                )",
            "                            elif isinstance(rsp, omero.cmd.OK):",
            "                                update_callback(request, cbString, status=\"finished\")",
            "                        else:",
            "                            in_progress += 1",
            "                    finally:",
            "                        prx.close(close_handle)",
            "                except Exception:",
            "                    logger.info(",
            "                        \"Activities %s handle not found: %s\" % (job_type, cbString)",
            "                    )",
            "                    continue",
            "        elif job_type == \"send_email\":",
            "            if status not in (\"failed\", \"finished\"):",
            "                rsp = None",
            "                try:",
            "                    prx = omero.cmd.HandlePrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                    callback = omero.callbacks.CmdCallbackI(",
            "                        conn.c, prx, foreground_poll=True",
            "                    )",
            "                    rsp = callback.getResponse()",
            "                    close_handle = False",
            "                    try:",
            "                        # if response is None, then we're still in progress,",
            "                        # otherwise...",
            "                        if rsp is not None:",
            "                            close_handle = True",
            "                            new_results.append(cbString)",
            "",
            "                            if isinstance(rsp, omero.cmd.ERR):",
            "                                rsp_params = \", \".join(",
            "                                    [",
            "                                        \"%s: %s\" % (k, v)",
            "                                        for k, v in rsp.parameters.items()",
            "                                    ]",
            "                                )",
            "                                logger.error(\"send_email failed with: %s\" % rsp_params)",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    status=\"failed\",",
            "                                    report={\"error\": rsp_params},",
            "                                    error=1,",
            "                                )",
            "                            else:",
            "                                total = (",
            "                                    rsp.success",
            "                                    + len(rsp.invalidusers)",
            "                                    + len(rsp.invalidemails)",
            "                                )",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    status=\"finished\",",
            "                                    rsp={\"success\": rsp.success, \"total\": total},",
            "                                )",
            "                                if (",
            "                                    len(rsp.invalidusers) > 0",
            "                                    or len(rsp.invalidemails) > 0",
            "                                ):",
            "                                    invalidusers = [",
            "                                        e.getFullName()",
            "                                        for e in list(",
            "                                            conn.getObjects(",
            "                                                \"Experimenter\", rsp.invalidusers",
            "                                            )",
            "                                        )",
            "                                    ]",
            "                                    update_callback(",
            "                                        request,",
            "                                        cbString,",
            "                                        report={",
            "                                            \"invalidusers\": invalidusers,",
            "                                            \"invalidemails\": rsp.invalidemails,",
            "                                        },",
            "                                    )",
            "                        else:",
            "                            in_progress += 1",
            "                    finally:",
            "                        callback.close(close_handle)",
            "                except Exception:",
            "                    logger.error(traceback.format_exc())",
            "                    logger.info(\"Activities send_email handle not found: %s\" % cbString)",
            "",
            "        # update delete",
            "        elif job_type == \"delete\":",
            "            if status not in (\"failed\", \"finished\"):",
            "                try:",
            "                    handle = omero.cmd.HandlePrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                    cb = omero.callbacks.CmdCallbackI(",
            "                        conn.c, handle, foreground_poll=True",
            "                    )",
            "                    rsp = cb.getResponse()",
            "                    close_handle = False",
            "                    try:",
            "                        if not rsp:  # Response not available",
            "                            update_callback(",
            "                                request,",
            "                                cbString,",
            "                                error=0,",
            "                                status=\"in progress\",",
            "                                dreport=_formatReport(handle),",
            "                            )",
            "                            in_progress += 1",
            "                        else:  # Response available",
            "                            close_handle = True",
            "                            new_results.append(cbString)",
            "                            rsp = cb.getResponse()",
            "                            err = isinstance(rsp, omero.cmd.ERR)",
            "                            if err:",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    error=1,",
            "                                    status=\"failed\",",
            "                                    dreport=_formatReport(handle),",
            "                                )",
            "                                failure += 1",
            "                            else:",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    error=0,",
            "                                    status=\"finished\",",
            "                                    dreport=_formatReport(handle),",
            "                                )",
            "                    finally:",
            "                        cb.close(close_handle)",
            "                except Ice.ObjectNotExistException:",
            "                    update_callback(",
            "                        request, cbString, error=0, status=\"finished\", dreport=None",
            "                    )",
            "                except Exception as x:",
            "                    logger.error(traceback.format_exc())",
            "                    logger.error(\"Status job '%s'error:\" % cbString)",
            "                    update_callback(",
            "                        request, cbString, error=1, status=\"failed\", dreport=str(x)",
            "                    )",
            "                    failure += 1",
            "",
            "        # update scripts",
            "        elif job_type == \"script\":",
            "            # if error on runScript, the cbString is not a ProcessCallback...",
            "            if not cbString.startswith(\"ProcessCallback\"):",
            "                continue  # ignore",
            "            if status not in (\"failed\", \"finished\"):",
            "                logger.info(\"Check callback on script: %s\" % cbString)",
            "                try:",
            "                    proc = omero.grid.ScriptProcessPrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                except IceException:",
            "                    update_callback(",
            "                        request,",
            "                        cbString,",
            "                        status=\"failed\",",
            "                        Message=\"No process found for job\",",
            "                        error=1,",
            "                    )",
            "                    continue",
            "                cb = omero.scripts.ProcessCallbackI(conn.c, proc)",
            "                # check if we get something back from the handle...",
            "                if cb.block(0):  # ms.",
            "                    cb.close()",
            "                    try:",
            "                        # we can only retrieve this ONCE - must save results",
            "                        results = proc.getResults(0, conn.SERVICE_OPTS)",
            "                        update_callback(request, cbString, status=\"finished\")",
            "                        new_results.append(cbString)",
            "                    except Exception:",
            "                        update_callback(",
            "                            request,",
            "                            cbString,",
            "                            status=\"finished\",",
            "                            Message=\"Failed to get results\",",
            "                        )",
            "                        logger.info(\"Failed on proc.getResults() for OMERO.script\")",
            "                        continue",
            "                    # value could be rstring, rlong, robject",
            "                    rMap = {}",
            "                    for key, value in results.items():",
            "                        v = value.getValue()",
            "                        if key in (\"stdout\", \"stderr\", \"Message\"):",
            "                            if key in (\"stderr\", \"stdout\"):",
            "                                # just save the id of original file",
            "                                v = v.id.val",
            "                            update_kwargs = {key: v}",
            "                            update_callback(request, cbString, **update_kwargs)",
            "                        else:",
            "                            if hasattr(v, \"id\"):",
            "                                # do we have an object (ImageI,",
            "                                # FileAnnotationI etc)",
            "                                obj_data = {",
            "                                    \"id\": v.id.val,",
            "                                    \"type\": v.__class__.__name__[:-1],",
            "                                }",
            "                                obj_data[\"browse_url\"] = getObjectUrl(conn, v)",
            "                                if v.isLoaded() and hasattr(v, \"file\"):",
            "                                    # try:",
            "                                    mimetypes = {",
            "                                        \"image/png\": \"png\",",
            "                                        \"image/jpeg\": \"jpeg\",",
            "                                        \"text/plain\": \"text\",",
            "                                    }",
            "                                    if v.file.mimetype.val in mimetypes:",
            "                                        obj_data[\"fileType\"] = mimetypes[",
            "                                            v.file.mimetype.val",
            "                                        ]",
            "                                        obj_data[\"fileId\"] = v.file.id.val",
            "                                    obj_data[\"name\"] = v.file.name.val",
            "                                    # except Exception:",
            "                                    #    pass",
            "                                if v.isLoaded() and hasattr(v, \"name\"):",
            "                                    # E.g Image, OriginalFile etc",
            "                                    name = unwrap(v.name)",
            "                                    if name is not None:",
            "                                        # E.g. FileAnnotation has null name",
            "                                        obj_data[\"name\"] = name",
            "                                rMap[key] = obj_data",
            "                            else:",
            "                                rMap[key] = unwrap(v)",
            "                    update_callback(request, cbString, results=rMap)",
            "                else:",
            "                    in_progress += 1",
            "",
            "    # having updated the request.session, we can now prepare the data for http",
            "    # response",
            "    rv = {}",
            "    for cbString in request.session.get(\"callback\").keys():",
            "        # make a copy of the map in session, so that we can replace non",
            "        # json-compatible objects, without modifying session",
            "        rv[cbString] = copy.copy(request.session[\"callback\"][cbString])",
            "",
            "    # return json (used for testing)",
            "    if \"template\" in kwargs and kwargs[\"template\"] == \"json\":",
            "        for cbString in request.session.get(\"callback\").keys():",
            "            rv[cbString][\"start_time\"] = str(",
            "                request.session[\"callback\"][cbString][\"start_time\"]",
            "            )",
            "        rv[\"inprogress\"] = in_progress",
            "        rv[\"failure\"] = failure",
            "        rv[\"jobs\"] = len(request.session[\"callback\"])",
            "        return JsonResponse(rv)  # json",
            "",
            "    jobs = []",
            "    new_errors = False",
            "    for key, data in rv.items():",
            "        # E.g. key: ProcessCallback/39f77932-c447-40d8-8f99-910b5a531a25 -t:tcp -h 10.211.55.2 -p 54727:tcp -h 10.37.129.2 -p 54727:tcp -h 10.12.2.21 -p 54727  # noqa",
            "        # create id we can use as html id,",
            "        # E.g. 39f77932-c447-40d8-8f99-910b5a531a25",
            "        if len(key.split(\" \")) > 0:",
            "            htmlId = key.split(\" \")[0]",
            "            if len(htmlId.split(\"/\")) > 1:",
            "                htmlId = htmlId.split(\"/\")[1]",
            "        rv[key][\"id\"] = htmlId",
            "        rv[key][\"key\"] = key",
            "        if key in new_results:",
            "            rv[key][\"new\"] = True",
            "            if \"error\" in data and data[\"error\"] > 0:",
            "                new_errors = True",
            "        jobs.append(rv[key])",
            "",
            "    jobs.sort(key=lambda x: x[\"start_time\"], reverse=True)",
            "    context = {",
            "        \"sizeOfJobs\": len(request.session[\"callback\"]),",
            "        \"jobs\": jobs,",
            "        \"inprogress\": in_progress,",
            "        \"new_results\": len(new_results),",
            "        \"new_errors\": new_errors,",
            "        \"failure\": failure,",
            "    }",
            "",
            "    context[\"template\"] = \"webclient/activities/activitiesContent.html\"",
            "    return context",
            "",
            "",
            "@login_required()",
            "def activities_update(request, action, **kwargs):",
            "    \"\"\"",
            "    If the above 'action' == 'clean' then we clear jobs from",
            "    request.session['callback'] either a single job (if 'jobKey' is specified",
            "    in POST) or all jobs (apart from those in progress)",
            "    \"\"\"",
            "",
            "    request.session.modified = True",
            "",
            "    if action == \"clean\":",
            "        if \"jobKey\" in request.POST:",
            "            jobId = request.POST.get(\"jobKey\")",
            "            rv = {}",
            "            if jobId in request.session[\"callback\"]:",
            "                del request.session[\"callback\"][jobId]",
            "                request.session.modified = True",
            "                rv[\"removed\"] = True",
            "            else:",
            "                rv[\"removed\"] = False",
            "            return JsonResponse(rv)",
            "        else:",
            "            jobs = list(request.session[\"callback\"].items())",
            "            for key, data in jobs:",
            "                if data[\"status\"] != \"in progress\":",
            "                    del request.session[\"callback\"][key]",
            "    return HttpResponse(\"OK\")",
            "",
            "",
            "##############################################################################",
            "# User Photo",
            "",
            "",
            "@login_required()",
            "def avatar(request, oid=None, conn=None, **kwargs):",
            "    \"\"\" Returns the experimenter's photo \"\"\"",
            "    photo = conn.getExperimenterPhoto(oid)",
            "    return HttpResponse(photo, content_type=\"image/jpeg\")",
            "",
            "",
            "##############################################################################",
            "# webgateway extention",
            "",
            "",
            "@login_required()",
            "def image_viewer(request, iid, share_id=None, **kwargs):",
            "    \"\"\" Delegates to webgateway, using share connection if appropriate \"\"\"",
            "    kwargs[\"viewport_server\"] = (",
            "        share_id is not None and reverse(\"webindex\") + share_id or reverse(\"webindex\")",
            "    )",
            "    # remove any trailing slash",
            "    kwargs[\"viewport_server\"] = kwargs[\"viewport_server\"].rstrip(\"/\")",
            "    return webgateway_views.full_viewer(request, iid, **kwargs)",
            "",
            "",
            "##############################################################################",
            "# scripting service....",
            "@login_required()",
            "@render_response()",
            "def list_scripts(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    List the available scripts - Just officical scripts for now",
            "",
            "    If all scripts are under a single top-level directory, this is",
            "    removed by default. To prevent this, use ?full_path=true",
            "    \"\"\"",
            "    scriptService = conn.getScriptService()",
            "    scripts = scriptService.getScripts()",
            "",
            "    # group scripts into 'folders' (path), named by parent folder name",
            "    scriptMenu = {}",
            "    scripts_to_ignore = (",
            "        request.session.get(\"server_settings\", {})",
            "        .get(\"scripts_to_ignore\", \"\")",
            "        .split(\",\")",
            "    )",
            "    for s in scripts:",
            "        scriptId = s.id.val",
            "        path = s.path.val",
            "        name = s.name.val",
            "        fullpath = os.path.join(path, name)",
            "        if fullpath in scripts_to_ignore:",
            "            logger.info(\"Ignoring script %r\" % fullpath)",
            "            continue",
            "",
            "        # We want to build a hierarchical <ul> <li> structure",
            "        # Each <ul> is a {}, each <li> is either a script 'name': <id> or",
            "        # directory 'name': {ul}",
            "",
            "        ul = scriptMenu",
            "        dirs = fullpath.split(os.path.sep)",
            "        for li, d in enumerate(dirs):",
            "            if len(d) == 0:",
            "                continue",
            "            if d not in ul:",
            "                # if last component in path:",
            "                if li + 1 == len(dirs):",
            "                    ul[d] = scriptId",
            "                else:",
            "                    ul[d] = {}",
            "            ul = ul[d]",
            "",
            "    # convert <ul> maps into lists and sort",
            "",
            "    def ul_to_list(ul):",
            "        dir_list = []",
            "        for name, value in ul.items():",
            "            if isinstance(value, dict):",
            "                # value is a directory",
            "                dir_list.append({\"name\": name, \"ul\": ul_to_list(value)})",
            "            else:",
            "                dir_list.append({\"name\": name, \"id\": value})",
            "        dir_list.sort(key=lambda x: x[\"name\"].lower())",
            "        return dir_list",
            "",
            "    scriptList = ul_to_list(scriptMenu)",
            "",
            "    # If we have a single top-level directory, we can skip it",
            "    if not request.GET.get(\"full_path\") and len(scriptList) == 1:",
            "        scriptList = scriptList[0][\"ul\"]",
            "",
            "    return scriptList",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def script_ui(request, scriptId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Generates an html form for the parameters of a defined script.",
            "    \"\"\"",
            "    scriptService = conn.getScriptService()",
            "",
            "    try:",
            "        params = scriptService.getParams(long(scriptId))",
            "    except Exception as ex:",
            "        if ex.message.lower().startswith(\"no processor available\"):",
            "            return {",
            "                \"template\": \"webclient/scripts/no_processor.html\",",
            "                \"scriptId\": scriptId,",
            "            }",
            "        raise ex",
            "    if params is None:",
            "        return HttpResponse()",
            "",
            "    paramData = {}",
            "",
            "    paramData[\"id\"] = long(scriptId)",
            "    paramData[\"name\"] = params.name.replace(\"_\", \" \")",
            "    paramData[\"description\"] = params.description",
            "    paramData[\"authors\"] = \", \".join([a for a in params.authors])",
            "    paramData[\"contact\"] = params.contact",
            "    paramData[\"version\"] = params.version",
            "    paramData[\"institutions\"] = \", \".join([i for i in params.institutions])",
            "",
            "    inputs = []  # use a list so we can sort by 'grouping'",
            "    Data_TypeParam = None",
            "    IDsParam = None",
            "    for key, param in params.inputs.items():",
            "        i = {}",
            "        i[\"name\"] = key.replace(\"_\", \" \")",
            "        i[\"key\"] = key",
            "        if not param.optional:",
            "            i[\"required\"] = True",
            "        i[\"description\"] = param.description",
            "        if param.min:",
            "            i[\"min\"] = str(param.min.getValue())",
            "        if param.max:",
            "            i[\"max\"] = str(param.max.getValue())",
            "        if param.values:",
            "            i[\"options\"] = [v.getValue() for v in param.values.getValue()]",
            "        if param.useDefault:",
            "            i[\"default\"] = unwrap(param.prototype)",
            "            if isinstance(i[\"default\"], omero.model.IObject):",
            "                i[\"default\"] = None",
            "        pt = unwrap(param.prototype)",
            "        if pt.__class__.__name__ == \"dict\":",
            "            i[\"map\"] = True",
            "        elif pt.__class__.__name__ == \"list\":",
            "            i[\"list\"] = True",
            "            if \"default\" in i:",
            "                i[\"default\"] = \",\".join([str(d) for d in i[\"default\"]])",
            "        elif isinstance(pt, bool):",
            "            i[\"boolean\"] = True",
            "        elif isinstance(pt, int) or isinstance(pt, long):",
            "            # will stop the user entering anything other than numbers.",
            "            i[\"number\"] = \"number\"",
            "        elif isinstance(pt, float):",
            "            i[\"number\"] = \"float\"",
            "",
            "        # if we got a value for this key in the page request, use this as",
            "        # default",
            "        if request.GET.get(key, None) is not None:",
            "            i[\"default\"] = request.GET.get(key, None)",
            "",
            "        # E.g  \"\"  (string) or [0] (int list) or 0.0 (float)",
            "        i[\"prototype\"] = unwrap(param.prototype)",
            "        i[\"grouping\"] = param.grouping",
            "        inputs.append(i)",
            "",
            "        if key == \"IDs\":",
            "            IDsParam = i  # remember these...",
            "        if key == \"Data_Type\":",
            "            Data_TypeParam = i",
            "    inputs.sort(key=lambda i: i[\"grouping\"])",
            "",
            "    # if we have Data_Type param - use the request parameters to populate IDs",
            "    if (",
            "        Data_TypeParam is not None",
            "        and IDsParam is not None",
            "        and \"options\" in Data_TypeParam",
            "    ):",
            "        IDsParam[\"default\"] = \"\"",
            "        for dtype in Data_TypeParam[\"options\"]:",
            "            if request.GET.get(dtype, None) is not None:",
            "                Data_TypeParam[\"default\"] = dtype",
            "                IDsParam[\"default\"] = request.GET.get(dtype, \"\")",
            "                break  # only use the first match",
            "        # if we've not found a match, check whether we have \"Well\" selected",
            "        if len(IDsParam[\"default\"]) == 0 and request.GET.get(\"Well\", None) is not None:",
            "            if \"Image\" in Data_TypeParam[\"options\"]:",
            "                wellIds = [long(j) for j in request.GET.get(\"Well\", None).split(\",\")]",
            "                wellIdx = 0",
            "                try:",
            "                    wellIdx = int(request.GET.get(\"Index\", 0))",
            "                except Exception:",
            "                    pass",
            "                wells = conn.getObjects(\"Well\", wellIds)",
            "                imgIds = [str(w.getImage(wellIdx).getId()) for w in wells]",
            "                Data_TypeParam[\"default\"] = \"Image\"",
            "                IDsParam[\"default\"] = \",\".join(imgIds)",
            "",
            "    # try to determine hierarchies in the groupings - ONLY handle 1 hierarchy",
            "    # level now (not recursive!)",
            "    for i in range(len(inputs)):",
            "        if len(inputs) <= i:",
            "            # we may remove items from inputs as we go - need to check",
            "            break",
            "        param = inputs[i]",
            "        grouping = param[\"grouping\"]  # E.g  03",
            "        param[\"children\"] = list()",
            "        while len(inputs) > i + 1:",
            "            nextGrp = inputs[i + 1][\"grouping\"]  # E.g. 03.1",
            "            if nextGrp.split(\".\")[0] == grouping:",
            "                param[\"children\"].append(inputs[i + 1])",
            "                inputs.pop(i + 1)",
            "            else:",
            "                break",
            "",
            "    paramData[\"inputs\"] = inputs",
            "",
            "    return {",
            "        \"template\": \"webclient/scripts/script_ui.html\",",
            "        \"paramData\": paramData,",
            "        \"scriptId\": scriptId,",
            "    }",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def figure_script(request, scriptName, conn=None, **kwargs):",
            "    \"\"\"",
            "    Show a UI for running figure scripts",
            "    \"\"\"",
            "",
            "    imageIds = request.GET.get(\"Image\", None)  # comma - delimited list",
            "    datasetIds = request.GET.get(\"Dataset\", None)",
            "    wellIds = request.GET.get(\"Well\", None)",
            "",
            "    if wellIds is not None:",
            "        wellIds = [long(i) for i in wellIds.split(\",\")]",
            "        wells = conn.getObjects(\"Well\", wellIds)",
            "        wellIdx = getIntOrDefault(request, \"Index\", 0)",
            "        imageIds = [str(w.getImage(wellIdx).getId()) for w in wells]",
            "        imageIds = \",\".join(imageIds)",
            "    if imageIds is None and datasetIds is None:",
            "        return HttpResponse(",
            "            \"Need to specify /?Image=1,2 or /?Dataset=1,2 or /?Well=1,2\"",
            "        )",
            "",
            "    def validateIds(dtype, ids):",
            "        ints = [int(oid) for oid in ids.split(\",\")]",
            "        validObjs = {}",
            "        for obj in conn.getObjects(dtype, ints):",
            "            validObjs[obj.id] = obj",
            "        filteredIds = [iid for iid in ints if iid in validObjs.keys()]",
            "        if len(filteredIds) == 0:",
            "            raise Http404(\"No %ss found with IDs %s\" % (dtype, ids))",
            "        else:",
            "            # Now we can specify group context - All should be same group",
            "            gid = list(validObjs.values())[0].getDetails().group.id.val",
            "            conn.SERVICE_OPTS.setOmeroGroup(gid)",
            "        return filteredIds, validObjs",
            "",
            "    context = {}",
            "",
            "    if imageIds is not None:",
            "        imageIds, validImages = validateIds(\"Image\", imageIds)",
            "        context[\"idString\"] = \",\".join([str(i) for i in imageIds])",
            "        context[\"dtype\"] = \"Image\"",
            "    if datasetIds is not None:",
            "        datasetIds, validDatasets = validateIds(\"Dataset\", datasetIds)",
            "        context[\"idString\"] = \",\".join([str(i) for i in datasetIds])",
            "        context[\"dtype\"] = \"Dataset\"",
            "",
            "    if scriptName == \"SplitView\":",
            "        scriptPath = \"/omero/figure_scripts/Split_View_Figure.py\"",
            "        template = \"webclient/scripts/split_view_figure.html\"",
            "        # Lookup Tags & Datasets (for row labels)",
            "        imgDict = []  # A list of data about each image.",
            "        for iId in imageIds:",
            "            data = {\"id\": iId}",
            "            img = validImages[iId]",
            "            data[\"name\"] = img.getName()",
            "            tags = [",
            "                ann.getTextValue()",
            "                for ann in img.listAnnotations()",
            "                if ann._obj.__class__ == omero.model.TagAnnotationI",
            "            ]",
            "            data[\"tags\"] = tags",
            "            data[\"datasets\"] = [d.getName() for d in img.listParents()]",
            "            imgDict.append(data)",
            "",
            "        # Use the first image as a reference",
            "        image = validImages[imageIds[0]]",
            "        context[\"imgDict\"] = imgDict",
            "        context[\"image\"] = image",
            "        context[\"channels\"] = image.getChannels()",
            "",
            "    elif scriptName == \"Thumbnail\":",
            "        scriptPath = \"/omero/figure_scripts/Thumbnail_Figure.py\"",
            "        template = \"webclient/scripts/thumbnail_figure.html\"",
            "",
            "        def loadImageTags(imageIds):",
            "            tagLinks = conn.getAnnotationLinks(\"Image\", parent_ids=imageIds)",
            "            linkMap = {}  # group tags. {imageId: [tags]}",
            "            tagMap = {}",
            "            for iId in imageIds:",
            "                linkMap[iId] = []",
            "            for link in tagLinks:",
            "                c = link.getChild()",
            "                if c._obj.__class__ == omero.model.TagAnnotationI:",
            "                    tagMap[c.id] = c",
            "                    linkMap[link.getParent().id].append(c)",
            "            imageTags = []",
            "            for iId in imageIds:",
            "                imageTags.append({\"id\": iId, \"tags\": linkMap[iId]})",
            "            tags = []",
            "            for tId, t in tagMap.items():",
            "                tags.append(t)",
            "            return imageTags, tags",
            "",
            "        thumbSets = []  # multiple collections of images",
            "        tags = []",
            "        figureName = \"Thumbnail_Figure\"",
            "        if datasetIds is not None:",
            "            for d in conn.getObjects(\"Dataset\", datasetIds):",
            "                imgIds = [i.id for i in d.listChildren()]",
            "                imageTags, ts = loadImageTags(imgIds)",
            "                thumbSets.append({\"name\": d.getName(), \"imageTags\": imageTags})",
            "                tags.extend(ts)",
            "            figureName = thumbSets[0][\"name\"]",
            "        else:",
            "            imageTags, ts = loadImageTags(imageIds)",
            "            thumbSets.append({\"name\": \"images\", \"imageTags\": imageTags})",
            "            tags.extend(ts)",
            "            parent = conn.getObject(\"Image\", imageIds[0]).getParent()",
            "            figureName = parent.getName() or \"Thumbnail Figure\"",
            "            context[\"parent_id\"] = parent.getId()",
            "        uniqueTagIds = set()  # remove duplicates",
            "        uniqueTags = []",
            "        for t in tags:",
            "            if t.id not in uniqueTagIds:",
            "                uniqueTags.append(t)",
            "                uniqueTagIds.add(t.id)",
            "        uniqueTags.sort(key=lambda x: x.getTextValue().lower())",
            "        context[\"thumbSets\"] = thumbSets",
            "        context[\"tags\"] = uniqueTags",
            "        context[\"figureName\"] = figureName.replace(\" \", \"_\")",
            "",
            "    elif scriptName == \"MakeMovie\":",
            "        scriptPath = \"/omero/export_scripts/Make_Movie.py\"",
            "        template = \"webclient/scripts/make_movie.html\"",
            "",
            "        # expect to run on a single image at a time",
            "        image = conn.getObject(\"Image\", imageIds[0])",
            "        # remove extension (if 3 chars or less)",
            "        movieName = image.getName().rsplit(\".\", 1)",
            "        if len(movieName) > 1 and len(movieName[1]) > 3:",
            "            movieName = \".\".join(movieName)",
            "        else:",
            "            movieName = movieName[0]",
            "        # make sure name is not a path",
            "        context[\"movieName\"] = os.path.basename(movieName)",
            "        chs = []",
            "        for c in image.getChannels():",
            "            chs.append(",
            "                {",
            "                    \"active\": c.isActive(),",
            "                    \"color\": c.getColor().getHtml(),",
            "                    \"label\": c.getLabel(),",
            "                }",
            "            )",
            "        context[\"channels\"] = chs",
            "        context[\"sizeT\"] = image.getSizeT()",
            "        context[\"sizeZ\"] = image.getSizeZ()",
            "",
            "    scriptService = conn.getScriptService()",
            "    scriptId = scriptService.getScriptID(scriptPath)",
            "    if scriptId < 0:",
            "        raise AttributeError(\"No script found for path '%s'\" % scriptPath)",
            "",
            "    context[\"template\"] = template",
            "    context[\"scriptId\"] = scriptId",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def fileset_check(request, action, conn=None, **kwargs):",
            "    \"\"\"",
            "    Check whether Images / Datasets etc contain partial Multi-image filesets.",
            "    Used by chgrp or delete dialogs to test whether we can perform this",
            "    'action'.",
            "    \"\"\"",
            "    dtypeIds = {}",
            "    for dtype in (\"Image\", \"Dataset\", \"Project\"):",
            "        ids = request.GET.get(dtype, None)",
            "        if ids is not None:",
            "            dtypeIds[dtype] = [int(i) for i in ids.split(\",\")]",
            "    splitFilesets = conn.getContainerService().getImagesBySplitFilesets(",
            "        dtypeIds, None, conn.SERVICE_OPTS",
            "    )",
            "",
            "    splits = []",
            "    for fsId, splitIds in splitFilesets.items():",
            "        splits.append(",
            "            {",
            "                \"id\": fsId,",
            "                \"attempted_iids\": splitIds[True],",
            "                \"blocking_iids\": splitIds[False],",
            "            }",
            "        )",
            "",
            "    context = {\"split_filesets\": splits}",
            "    context[\"action\"] = action",
            "    if action == \"chgrp\":",
            "        context[\"action\"] = \"move\"",
            "    context[\"template\"] = \"webclient/activities/\" \"fileset_check_dialog_content.html\"",
            "",
            "    return context",
            "",
            "",
            "def getAllObjects(",
            "    conn, project_ids, dataset_ids, image_ids, screen_ids, plate_ids, experimenter_id",
            "):",
            "    \"\"\"",
            "    Given a list of containers and images, calculate all the descendants",
            "    and necessary siblings (for any filesets)",
            "    \"\"\"",
            "    # TODO Handle None inputs, maybe add defaults",
            "    params = omero.sys.ParametersI()",
            "    qs = conn.getQueryService()",
            "",
            "    project_ids = set(project_ids)",
            "    dataset_ids = set(dataset_ids)",
            "    image_ids = set(image_ids)",
            "    fileset_ids = set([])",
            "    plate_ids = set(plate_ids)",
            "    screen_ids = set(screen_ids)",
            "",
            "    # Get any datasets for projects",
            "    if project_ids:",
            "        params.map = {}",
            "        params.map[\"pids\"] = rlist([rlong(x) for x in list(project_ids)])",
            "        q = \"\"\"",
            "            select pdlink.child.id",
            "            from ProjectDatasetLink pdlink",
            "            where pdlink.parent.id in (:pids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            dataset_ids.add(e[0].val)",
            "",
            "    # Get any plates for screens",
            "    if screen_ids:",
            "        params.map = {}",
            "        params.map[\"sids\"] = rlist([rlong(x) for x in screen_ids])",
            "        q = \"\"\"",
            "            select splink.child.id",
            "            from ScreenPlateLink splink",
            "            where splink.parent.id in (:sids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            plate_ids.add(e[0].val)",
            "",
            "    # Get any images for datasets",
            "    if dataset_ids:",
            "        params.map = {}",
            "        params.map[\"dids\"] = rlist([rlong(x) for x in dataset_ids])",
            "        q = \"\"\"",
            "            select dilink.child.id,",
            "                   dilink.child.fileset.id",
            "            from DatasetImageLink dilink",
            "            where dilink.parent.id in (:dids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            image_ids.add(e[0].val)",
            "            # Some images in Dataset may not have fileset",
            "            if e[1] is not None:",
            "                fileset_ids.add(e[1].val)",
            "",
            "    # Get any images for plates",
            "    # TODO Seemed no need to add the filesets for plates as it isn't possible",
            "    # to link it from outside of its plate. This may be true for the client,",
            "    # but it certainly isn't true for the model so maybe allow this to also get",
            "    # filesets",
            "    if plate_ids:",
            "        params.map = {}",
            "        params.map[\"plids\"] = rlist([rlong(x) for x in plate_ids])",
            "        q = \"\"\"",
            "            select ws.image.id",
            "            from WellSample ws",
            "            join ws.plateAcquisition pa",
            "            where pa.plate.id in (:plids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            image_ids.add(e[0].val)",
            "",
            "    # Get any extra images due to filesets",
            "    if fileset_ids:",
            "        params.map = {}",
            "        params.map[\"fsids\"] = rlist([rlong(x) for x in fileset_ids])",
            "        q = \"\"\"",
            "            select image.id",
            "            from Image image",
            "            left outer join image.datasetLinks dilink",
            "            where image.fileset.id in (select fs.id",
            "                                       from Image im",
            "                                       join im.fileset fs",
            "                                       where fs.id in (:fsids)",
            "                                       group by fs.id",
            "                                       having count(im.id)>1)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            image_ids.add(e[0].val)",
            "",
            "    # Get any additional datasets that may need updating as their children have",
            "    # been snatched.",
            "    # TODO Need to differentiate which orphaned directories need refreshing",
            "    extra_dataset_ids = set([])",
            "    extra_orphaned = False",
            "    if image_ids:",
            "        params.map = {",
            "            \"iids\": rlist([rlong(x) for x in image_ids]),",
            "        }",
            "",
            "        exclude_datasets = \"\"",
            "        if dataset_ids:",
            "            params.map[\"dids\"] = rlist([rlong(x) for x in dataset_ids])",
            "            # Make sure to allow parentless results as well as those",
            "            # that do not match a dataset being removed",
            "            exclude_datasets = \"\"\"",
            "                               and (",
            "                                    dilink.parent.id not in (:dids)",
            "                                    or dilink.parent.id = null",
            "                                   )",
            "                               \"\"\"",
            "",
            "        q = (",
            "            \"\"\"",
            "            select distinct dilink.parent.id",
            "            from Image image",
            "            left outer join image.datasetLinks dilink",
            "            where image.id in (:iids)",
            "            %s",
            "            and (select count(dilink2.child.id)",
            "                 from DatasetImageLink dilink2",
            "                 where dilink2.parent.id = dilink.parent.id",
            "                 and dilink2.child.id not in (:iids)) = 0",
            "            \"\"\"",
            "            % exclude_datasets",
            "        )",
            "",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            if e:",
            "                extra_dataset_ids.add(e[0].val)",
            "            else:",
            "                extra_orphaned = True",
            "",
            "    # Get any additional projects that may need updating as their children have",
            "    # been snatched. There is no need to check for orphans because if a dataset",
            "    # is being removed from somewhere else, it can not exist as an orphan.",
            "    extra_project_ids = set([])",
            "    if dataset_ids:",
            "        params.map = {\"dids\": rlist([rlong(x) for x in dataset_ids])}",
            "",
            "        exclude_projects = \"\"",
            "        if project_ids:",
            "            params.map[\"pids\"] = rlist([rlong(x) for x in project_ids])",
            "            exclude_projects = \"and pdlink.parent.id not in (:pids)\"",
            "",
            "        q = (",
            "            \"\"\"",
            "            select distinct pdlink.parent.id",
            "            from ProjectDatasetLink pdlink",
            "            where pdlink.child.id in (:dids)",
            "            %s",
            "            and (select count(pdlink2.child.id)",
            "                 from ProjectDatasetLink pdlink2",
            "                 where pdlink2.parent.id = pdlink.parent.id",
            "                 and pdlink2.child.id not in (:dids)) = 0",
            "            \"\"\"",
            "            % exclude_projects",
            "        )",
            "",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            extra_project_ids.add(e[0].val)",
            "",
            "    # We now have the complete list of objects that will change group",
            "    # We also have an additional list of datasets/projects that may have had",
            "    # snatched children and thus may need updating in the client if the",
            "    # dataset/project has gone from N to 0 children",
            "",
            "    result = {",
            "        # These objects are completely removed",
            "        \"remove\": {",
            "            \"project\": list(project_ids),",
            "            \"dataset\": list(dataset_ids),",
            "            \"screen\": list(screen_ids),",
            "            \"plate\": list(plate_ids),",
            "            \"image\": list(image_ids),",
            "        },",
            "        # These objects now have no children",
            "        \"childless\": {",
            "            \"project\": list(extra_project_ids),",
            "            \"dataset\": list(extra_dataset_ids),",
            "            \"orphaned\": extra_orphaned,",
            "        },",
            "    }",
            "    return result",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "def chgrpDryRun(request, conn=None, **kwargs):",
            "    return dryRun(request, action=\"chgrp\", conn=conn, **kwargs)",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "def dryRun(request, action, conn=None, **kwargs):",
            "    \"\"\"Submit chgrp or chown dry-run\"\"\"",
            "    targetObjects = {}",
            "    dtypes = [\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\", \"Fileset\"]",
            "    for dtype in dtypes:",
            "        oids = request.POST.get(dtype, None)",
            "        if oids is not None:",
            "            obj_ids = [int(oid) for oid in oids.split(\",\")]",
            "            targetObjects[dtype] = obj_ids",
            "",
            "    if action == \"chgrp\":",
            "        target_id = getIntOrDefault(request, \"group_id\", None)",
            "    elif action == \"chown\":",
            "        target_id = getIntOrDefault(request, \"owner_id\", None)",
            "    handle = conn.submitDryRun(action, targetObjects, target_id)",
            "    jobId = str(handle)",
            "    return HttpResponse(jobId)",
            "",
            "",
            "@login_required()",
            "def chgrp(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Moves data to a new group, using the chgrp queue.",
            "    Handles submission of chgrp form: all data in POST.",
            "    Adds the callback handle to the request.session['callback']['jobId']",
            "    \"\"\"",
            "    if not request.method == \"POST\":",
            "        return JsonResponse({\"Error\": \"Need to POST to chgrp\"}, status=405)",
            "    # Get the target group_id",
            "    group_id = getIntOrDefault(request, \"group_id\", None)",
            "    if group_id is None:",
            "        return JsonResponse({\"Error\": \"chgrp: No group_id specified\"})",
            "    group_id = long(group_id)",
            "",
            "    def getObjectOwnerId(r):",
            "        for t in [\"Dataset\", \"Image\", \"Plate\"]:",
            "            ids = r.POST.get(t, None)",
            "            if ids is not None:",
            "                for o in list(conn.getObjects(t, ids.split(\",\"))):",
            "                    return o.getDetails().owner.id.val",
            "",
            "    group = conn.getObject(\"ExperimenterGroup\", group_id)",
            "    new_container_name = request.POST.get(\"new_container_name\", None)",
            "    new_container_type = request.POST.get(\"new_container_type\", None)",
            "    container_id = None",
            "",
            "    # Context must be set to owner of data, E.g. to create links.",
            "    ownerId = getObjectOwnerId(request)",
            "    conn.SERVICE_OPTS.setOmeroUser(ownerId)",
            "    if (",
            "        new_container_name is not None",
            "        and len(new_container_name) > 0",
            "        and new_container_type is not None",
            "    ):",
            "        conn.SERVICE_OPTS.setOmeroGroup(group_id)",
            "        container_id = conn.createContainer(new_container_type, new_container_name)",
            "    # No new container, check if target is specified",
            "    if container_id is None:",
            "        # E.g. \"dataset-234\"",
            "        target_id = request.POST.get(\"target_id\", None)",
            "        container_id = target_id is not None and target_id.split(\"-\")[1] or None",
            "    dtypes = [\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\"]",
            "    for dtype in dtypes:",
            "        # Get all requested objects of this type",
            "        oids = request.POST.get(dtype, None)",
            "        if oids is not None:",
            "            obj_ids = [int(oid) for oid in oids.split(\",\")]",
            "            # TODO Doesn't the filesets only apply to images?",
            "            # if 'filesets' are specified, make sure we move ALL Fileset Images",
            "            fsIds = request.POST.getlist(\"fileset\")",
            "            if len(fsIds) > 0:",
            "                # If a dataset is being moved and there is a split fileset",
            "                # then those images need to go somewhere in the new",
            "                if dtype == \"Dataset\":",
            "                    conn.regroupFilesets(dsIds=obj_ids, fsIds=fsIds)",
            "                else:",
            "                    for fs in conn.getObjects(\"Fileset\", fsIds):",
            "                        obj_ids.extend([i.id for i in fs.copyImages()])",
            "                    obj_ids = list(set(obj_ids))  # remove duplicates",
            "            logger.debug(\"chgrp to group:%s %s-%s\" % (group_id, dtype, obj_ids))",
            "            handle = conn.chgrpObjects(dtype, obj_ids, group_id, container_id)",
            "            jobId = str(handle)",
            "            request.session[\"callback\"][jobId] = {",
            "                \"job_type\": \"chgrp\",",
            "                \"group\": group.getName(),",
            "                \"to_group_id\": group_id,",
            "                \"dtype\": dtype,",
            "                \"obj_ids\": obj_ids,",
            "                \"job_name\": \"Change group\",",
            "                \"start_time\": datetime.datetime.now(),",
            "                \"status\": \"in progress\",",
            "            }",
            "            request.session.modified = True",
            "",
            "    # Update contains a list of images/containers that need to be",
            "    # updated.",
            "",
            "    project_ids = request.POST.get(\"Project\", [])",
            "    dataset_ids = request.POST.get(\"Dataset\", [])",
            "    image_ids = request.POST.get(\"Image\", [])",
            "    screen_ids = request.POST.get(\"Screen\", [])",
            "    plate_ids = request.POST.get(\"Plate\", [])",
            "",
            "    if project_ids:",
            "        project_ids = [long(x) for x in project_ids.split(\",\")]",
            "    if dataset_ids:",
            "        dataset_ids = [long(x) for x in dataset_ids.split(\",\")]",
            "    if image_ids:",
            "        image_ids = [long(x) for x in image_ids.split(\",\")]",
            "    if screen_ids:",
            "        screen_ids = [long(x) for x in screen_ids.split(\",\")]",
            "    if plate_ids:",
            "        plate_ids = [long(x) for x in plate_ids.split(\",\")]",
            "",
            "    # TODO Change this user_id to be an experimenter_id in the request as it",
            "    # is possible that a user is chgrping data from another user so it is",
            "    # that users orphaned that will need updating. Or maybe all orphaned",
            "    # directories could potentially need updating?",
            "",
            "    # Create a list of objects that have been changed by this operation. This",
            "    # can be used by the client to visually update.",
            "    update = getAllObjects(",
            "        conn,",
            "        project_ids,",
            "        dataset_ids,",
            "        image_ids,",
            "        screen_ids,",
            "        plate_ids,",
            "        request.session.get(\"user_id\"),",
            "    )",
            "",
            "    # return HttpResponse(\"OK\")",
            "    return JsonResponse({\"update\": update})",
            "",
            "",
            "@login_required()",
            "def chown(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Moves data to a new owner, using the chown queue.",
            "    Handles submission of chown form: all data in POST.",
            "    Adds the callback handle to the request.session['callback']['jobId']",
            "    \"\"\"",
            "    if not request.method == \"POST\":",
            "        return JsonResponse({\"Error\": \"Need to POST to chown\"}, status=405)",
            "    # Get the target owner_id",
            "    owner_id = getIntOrDefault(request, \"owner_id\", None)",
            "    if owner_id is None:",
            "        return JsonResponse({\"Error\": \"chown: No owner_id specified\"})",
            "    owner_id = int(owner_id)",
            "    exp = conn.getObject(\"Experimenter\", owner_id)",
            "    if exp is None:",
            "        return JsonResponse({\"Error\": \"chown: Experimenter not found\" % owner_id})",
            "",
            "    dtypes = [\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\"]",
            "    jobIds = []",
            "    for dtype in dtypes:",
            "        # Get all requested objects of this type",
            "        oids = request.POST.get(dtype, None)",
            "        if oids is not None:",
            "            obj_ids = [int(oid) for oid in oids.split(\",\")]",
            "            logger.debug(\"chown to owner:%s %s-%s\" % (owner_id, dtype, obj_ids))",
            "            handle = conn.chownObjects(dtype, obj_ids, owner_id)",
            "            jobId = str(handle)",
            "            jobIds.append(jobId)",
            "            request.session[\"callback\"][jobId] = {",
            "                \"job_type\": \"chown\",",
            "                \"owner\": exp.getFullName(),",
            "                \"to_owner_id\": owner_id,",
            "                \"dtype\": dtype,",
            "                \"obj_ids\": obj_ids,",
            "                \"job_name\": \"Change owner\",",
            "                \"start_time\": datetime.datetime.now(),",
            "                \"status\": \"in progress\",",
            "            }",
            "            request.session.modified = True",
            "",
            "    return JsonResponse({\"jobIds\": jobIds})",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "def script_run(request, scriptId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Runs a script using values in a POST",
            "    \"\"\"",
            "    scriptService = conn.getScriptService()",
            "",
            "    inputMap = {}",
            "",
            "    sId = long(scriptId)",
            "",
            "    try:",
            "        params = scriptService.getParams(sId)",
            "    except Exception as x:",
            "        if x.message and x.message.startswith(\"No processor available\"):",
            "            # Delegate to run_script() for handling 'No processor available'",
            "            rsp = run_script(request, conn, sId, inputMap, scriptName=\"Script\")",
            "            return JsonResponse(rsp)",
            "        else:",
            "            raise",
            "    params = scriptService.getParams(sId)",
            "    scriptName = params.name.replace(\"_\", \" \").replace(\".py\", \"\")",
            "",
            "    logger.debug(\"Script: run with request.POST: %s\" % request.POST)",
            "",
            "    # upload new file",
            "    fileupload = (",
            "        \"file_annotation\" in request.FILES and request.FILES[\"file_annotation\"] or None",
            "    )",
            "    fileAnnId = None",
            "    if fileupload is not None and fileupload != \"\":",
            "        manager = BaseContainer(conn)",
            "        fileAnnId = manager.createFileAnnotations(fileupload, [])",
            "",
            "    for key, param in params.inputs.items():",
            "        prototype = param.prototype",
            "        pclass = prototype.__class__",
            "",
            "        if key == \"File_Annotation\" and fileAnnId is not None:",
            "            inputMap[key] = pclass(str(fileAnnId))",
            "            continue",
            "",
            "        # handle bool separately, since unchecked checkbox will not be in",
            "        # request.POST",
            "        if pclass == omero.rtypes.RBoolI:",
            "            value = key in request.POST",
            "            inputMap[key] = pclass(value)",
            "            continue",
            "",
            "        if pclass.__name__ == \"RMapI\":",
            "            keyName = \"%s_key0\" % key",
            "            valueName = \"%s_value0\" % key",
            "            row = 0",
            "            paramMap = {}",
            "            while keyName in request.POST:",
            "                # the key and value don't have any data-type defined by",
            "                # scripts - just use string",
            "                k = str(request.POST[keyName])",
            "                v = request.POST[valueName]",
            "                if len(k) > 0 and len(v) > 0:",
            "                    paramMap[str(k)] = v",
            "                row += 1",
            "                keyName = \"%s_key%d\" % (key, row)",
            "                valueName = \"%s_value%d\" % (key, row)",
            "            if len(paramMap) > 0:",
            "                inputMap[key] = wrap(paramMap)",
            "            continue",
            "",
            "        if key in request.POST:",
            "            if pclass == omero.rtypes.RListI:",
            "                values = request.POST.getlist(key)",
            "                if len(values) == 0:",
            "                    continue",
            "                if len(values) == 1:  # process comma-separated list",
            "                    if len(values[0]) == 0:",
            "                        continue",
            "                    values = values[0].split(\",\")",
            "",
            "                # try to determine 'type' of values in our list",
            "                listClass = omero.rtypes.RStringI",
            "                pval = prototype.val  # list",
            "                # check if a value type has been set (first item of prototype",
            "                # list)",
            "                if len(pval) > 0:",
            "                    listClass = pval[0].__class__",
            "                    if listClass == int(1).__class__:",
            "                        listClass = omero.rtypes.rint",
            "                    if listClass == long(1).__class__:",
            "                        listClass = omero.rtypes.rlong",
            "",
            "                # construct our list, using appropriate 'type'",
            "                valueList = []",
            "                for v in values:",
            "                    try:",
            "                        # RStringI() will encode any unicode",
            "                        obj = listClass(v.strip())",
            "                    except Exception:",
            "                        logger.debug(\"Invalid entry for '%s' : %s\" % (key, v))",
            "                        continue",
            "                    if isinstance(obj, omero.model.IObject):",
            "                        valueList.append(omero.rtypes.robject(obj))",
            "                    else:",
            "                        valueList.append(obj)",
            "                inputMap[key] = omero.rtypes.rlist(valueList)",
            "",
            "            # Handle other rtypes: String, Long, Int etc.",
            "            else:",
            "                value = request.POST[key]",
            "                if len(value) == 0:",
            "                    continue",
            "                try:",
            "                    inputMap[key] = pclass(value)",
            "                except Exception:",
            "                    logger.debug(\"Invalid entry for '%s' : %s\" % (key, value))",
            "                    continue",
            "",
            "    # If we have objects specified via 'IDs' and 'DataType', try to pick",
            "    # correct group",
            "    if \"IDs\" in inputMap and \"Data_Type\" in inputMap:",
            "        gid = conn.SERVICE_OPTS.getOmeroGroup()",
            "        conn.SERVICE_OPTS.setOmeroGroup(\"-1\")",
            "        try:",
            "            firstObj = conn.getObject(",
            "                inputMap[\"Data_Type\"].val, unwrap(inputMap[\"IDs\"])[0]",
            "            )",
            "            newGid = firstObj.getDetails().group.id.val",
            "            conn.SERVICE_OPTS.setOmeroGroup(newGid)",
            "        except Exception:",
            "            logger.debug(traceback.format_exc())",
            "            # if inputMap values not as expected or firstObj is None",
            "            conn.SERVICE_OPTS.setOmeroGroup(gid)",
            "",
            "    try:",
            "        # Try/except in case inputs are not serializable, e.g. unicode",
            "        logger.debug(\"Running script %s with \" \"params %s\" % (scriptName, inputMap))",
            "    except Exception:",
            "        pass",
            "    rsp = run_script(request, conn, sId, inputMap, scriptName)",
            "    return JsonResponse(rsp)",
            "",
            "",
            "@login_required(isAdmin=True)",
            "@render_response()",
            "def script_upload(request, conn=None, **kwargs):",
            "    \"\"\"Script upload UI\"\"\"",
            "",
            "    if request.method != \"POST\":",
            "        return {\"template\": \"webclient/scripts/upload_script.html\"}",
            "",
            "    # Get script path, name and text",
            "    script_path = request.POST.get(\"script_path\")",
            "    script_file = request.FILES[\"script_file\"]",
            "    script_file.seek(0)",
            "    script_text = script_file.read().decode(\"utf-8\")",
            "",
            "    if not script_path.endswith(\"/\"):",
            "        script_path = script_path + \"/\"",
            "    script_path = script_path + script_file.name",
            "",
            "    # If script exists, replace. Otherwise upload",
            "    scriptService = conn.getScriptService()",
            "    script_id = scriptService.getScriptID(script_path)",
            "",
            "    try:",
            "        if script_id > 0:",
            "            orig_file = OriginalFileI(script_id, False)",
            "            scriptService.editScript(orig_file, script_text)",
            "            message = \"Script Replaced: %s\" % script_file.name",
            "        else:",
            "            script_id = scriptService.uploadOfficialScript(script_path, script_text)",
            "            message = \"Script Uploaded: %s\" % script_file.name",
            "    except omero.ValidationException as ex:",
            "        message = str(ex)",
            "",
            "    return {\"Message\": message, \"script_id\": script_id}",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "def ome_tiff_script(request, imageId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Uses the scripting service (Batch Image Export script) to generate",
            "    OME-TIFF for an image and attach this as a file annotation to the image.",
            "    Script will show up in the 'Activities' for users to monitor and download",
            "    result etc.",
            "    \"\"\"",
            "",
            "    scriptService = conn.getScriptService()",
            "    sId = scriptService.getScriptID(\"/omero/export_scripts/Batch_Image_Export.py\")",
            "",
            "    image = conn.getObject(\"Image\", imageId)",
            "    if image is not None:",
            "        gid = image.getDetails().group.id.val",
            "        conn.SERVICE_OPTS.setOmeroGroup(gid)",
            "    imageIds = [long(imageId)]",
            "    inputMap = {",
            "        \"Data_Type\": wrap(\"Image\"),",
            "        \"IDs\": rlist([rlong(id) for id in imageIds]),",
            "    }",
            "    inputMap[\"Format\"] = wrap(\"OME-TIFF\")",
            "    rsp = run_script(request, conn, sId, inputMap, scriptName=\"Create OME-TIFF\")",
            "    return JsonResponse(rsp)",
            "",
            "",
            "def run_script(request, conn, sId, inputMap, scriptName=\"Script\"):",
            "    \"\"\"",
            "    Starts running a script, adding details to the request.session so that it",
            "    shows up in the webclient Activities panel and results are available there",
            "    etc.",
            "    \"\"\"",
            "    request.session.modified = True",
            "    scriptService = conn.getScriptService()",
            "    try:",
            "        handle = scriptService.runScript(sId, inputMap, None, conn.SERVICE_OPTS)",
            "        # E.g. ProcessCallback/4ab13b23-22c9-4b5f-9318-40f9a1acc4e9 -t:tcp -h  10.37.129.2 -p 53154:tcp -h 10.211.55.2 -p 53154:tcp -h 10.12.1.230 -p 53154 # noqa",
            "        jobId = str(handle)",
            "        status = \"in progress\"",
            "        request.session[\"callback\"][jobId] = {",
            "            \"job_type\": \"script\",",
            "            \"job_name\": scriptName,",
            "            \"start_time\": datetime.datetime.now(),",
            "            \"status\": status,",
            "        }",
            "        request.session.modified = True",
            "    except Exception as x:",
            "        jobId = str(time())  # E.g. 1312803670.6076391",
            "        # handle python 2 or 3 errors",
            "        message = x.message if hasattr(x, \"message\") else (x.args[0] if x.args else \"\")",
            "        if message and message.startswith(\"No processor available\"):",
            "            # omero.ResourceError",
            "            logger.info(traceback.format_exc())",
            "            error = \"No Processor Available\"",
            "            status = \"no processor available\"",
            "            message = \"\"  # template displays message and link",
            "        else:",
            "            logger.error(traceback.format_exc())",
            "            error = traceback.format_exc()",
            "            status = \"failed\"",
            "            message = x.message",
            "        # save the error to http session, for display in 'Activities' window",
            "        request.session[\"callback\"][jobId] = {",
            "            \"job_type\": \"script\",",
            "            \"job_name\": scriptName,",
            "            \"start_time\": datetime.datetime.now(),",
            "            \"status\": status,",
            "            \"Message\": message,",
            "            \"error\": error,",
            "        }",
            "        return {\"status\": status, \"error\": error}",
            "",
            "    return {\"jobId\": jobId, \"status\": status}",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def ome_tiff_info(request, imageId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Query to see if we have an OME-TIFF attached to the image (assume only 1,",
            "    since Batch Image Export will delete old ones)",
            "    \"\"\"",
            "    # Any existing OME-TIFF will appear in list",
            "    links = list(",
            "        conn.getAnnotationLinks(",
            "            \"Image\", [imageId], ns=omero.constants.namespaces.NSOMETIFF",
            "        )",
            "    )",
            "    rv = {}",
            "    if len(links) > 0:",
            "        # use highest ID === most recent",
            "        links.sort(key=lambda x: x.getId(), reverse=True)",
            "        annlink = links[0]",
            "        created = annlink.creationEventDate()",
            "        annId = annlink.getChild().getId()",
            "        from omeroweb.webgateway.templatetags.common_filters import ago",
            "",
            "        download = reverse(\"download_annotation\", args=[annId])",
            "        rv = {",
            "            \"created\": str(created),",
            "            \"ago\": ago(created),",
            "            \"id\": annId,",
            "            \"download\": download,",
            "        }",
            "    return rv  # will get returned as json by default"
        ],
        "afterPatchFile": [
            "#!/usr/bin/env python",
            "# -*- coding: utf-8 -*-",
            "",
            "# Copyright (C) 2008-2020 University of Dundee & Open Microscopy Environment.",
            "# All rights reserved.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU Affero General Public License as",
            "# published by the Free Software Foundation, either version 3 of the",
            "# License, or (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU Affero General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU Affero General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "\"\"\" A view functions is simply a Python function that takes a Web request and",
            "returns a Web response. This response can be the HTML contents of a Web page,",
            "or a redirect, or the 404 and 500 error, or an XML document, or an image...",
            "or anything.\"\"\"",
            "",
            "import copy",
            "import os",
            "import datetime",
            "import Ice",
            "from Ice import Exception as IceException",
            "import logging",
            "import traceback",
            "import json",
            "import re",
            "import sys",
            "import warnings",
            "from past.builtins import unicode",
            "from future.utils import bytes_to_native_str",
            "from django.utils.http import is_safe_url",
            "",
            "from time import time",
            "",
            "from omeroweb.version import omeroweb_buildyear as build_year",
            "from omeroweb.version import omeroweb_version as omero_version",
            "",
            "import omero",
            "import omero.scripts",
            "from omero.rtypes import wrap, unwrap, rlong, rlist",
            "",
            "from omero.gateway.utils import toBoolean",
            "",
            "from django.conf import settings",
            "from django.template import loader as template_loader",
            "from django.http import (",
            "    Http404,",
            "    HttpResponse,",
            "    HttpResponseRedirect,",
            "    JsonResponse,",
            "    HttpResponseForbidden,",
            ")",
            "from django.http import HttpResponseServerError, HttpResponseBadRequest",
            "from django.utils.http import urlencode",
            "from django.core.urlresolvers import reverse, NoReverseMatch",
            "from django.utils.encoding import smart_str",
            "from django.views.decorators.cache import never_cache",
            "from django.views.decorators.http import require_POST",
            "from django.shortcuts import render",
            "",
            "",
            "from omeroweb.webclient.webclient_utils import _formatReport, _purgeCallback",
            "from .forms import GlobalSearchForm, ContainerForm",
            "from .forms import ShareForm",
            "from .forms import ContainerNameForm, ContainerDescriptionForm",
            "from .forms import CommentAnnotationForm, TagsAnnotationForm",
            "from .forms import MetadataFilterForm, MetadataDetectorForm",
            "from .forms import MetadataChannelForm, MetadataEnvironmentForm",
            "from .forms import MetadataObjectiveForm, MetadataObjectiveSettingsForm",
            "from .forms import MetadataStageLabelForm, MetadataLightSourceForm",
            "from .forms import MetadataDichroicForm, MetadataMicroscopeForm",
            "from .forms import FilesAnnotationForm, WellIndexForm, NewTagsAnnotationFormSet",
            "",
            "from .controller.container import BaseContainer",
            "from .controller.history import BaseCalendar",
            "from .controller.search import BaseSearch",
            "from .controller.share import BaseShare",
            "",
            "from omeroweb.webadmin.forms import LoginForm",
            "",
            "from omeroweb.webgateway import views as webgateway_views",
            "from omeroweb.webgateway.marshal import graphResponseMarshal",
            "from omeroweb.webgateway.util import get_longs as webgateway_get_longs",
            "",
            "from omeroweb.feedback.views import handlerInternalError",
            "",
            "from omeroweb.webclient.decorators import login_required",
            "from omeroweb.webclient.decorators import render_response",
            "from omeroweb.webclient.show import (",
            "    Show,",
            "    IncorrectMenuError,",
            "    paths_to_object,",
            "    paths_to_tag,",
            ")",
            "from omeroweb.decorators import (",
            "    ConnCleaningHttpResponse,",
            "    parse_url,",
            "    TableClosingHttpResponse,",
            ")",
            "from omeroweb.webgateway.util import getIntOrDefault",
            "",
            "from omero.model import (",
            "    AnnotationAnnotationLinkI,",
            "    DatasetI,",
            "    DatasetImageLinkI,",
            "    ExperimenterI,",
            "    ImageI,",
            "    OriginalFileI,",
            "    PlateI,",
            "    ProjectI,",
            "    ProjectDatasetLinkI,",
            "    ScreenI,",
            "    ScreenPlateLinkI,",
            "    TagAnnotationI,",
            ")",
            "from omero import ApiUsageException, ServerError, CmdError",
            "from omeroweb.webgateway.views import LoginView",
            "",
            "from . import tree",
            "",
            "try:",
            "    import long",
            "except ImportError:",
            "    long = int",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "logger.info(\"INIT '%s'\" % os.getpid())",
            "",
            "# We want to allow a higher default limit for annotations so we can load",
            "# all the annotations expected for a PAGE of images",
            "ANNOTATIONS_LIMIT = settings.PAGE * 100",
            "",
            "",
            "def get_long_or_default(request, name, default):",
            "    \"\"\"",
            "    Retrieves a parameter from the request. If the parameter is not present",
            "    the default is returned",
            "",
            "    This does not catch exceptions as it makes sense to throw exceptions if",
            "    the arguments provided do not pass basic type validation",
            "    \"\"\"",
            "    val = None",
            "    val_raw = request.GET.get(name, default)",
            "    if val_raw is not None:",
            "        val = long(val_raw)",
            "    return val",
            "",
            "",
            "def get_list(request, name):",
            "    val = request.GET.getlist(name)",
            "    return [i for i in val if i != \"\"]",
            "",
            "",
            "def get_longs(request, name):",
            "    warnings.warn(",
            "        \"Deprecated. Use omeroweb.webgateway.util.get_longs()\", DeprecationWarning",
            "    )",
            "    return webgateway_get_longs(request, name)",
            "",
            "",
            "def get_bool_or_default(request, name, default):",
            "    \"\"\"",
            "    Retrieves a parameter from the request. If the parameter is not present",
            "    the default is returned",
            "",
            "    This does not catch exceptions as it makes sense to throw exceptions if",
            "    the arguments provided do not pass basic type validation",
            "    \"\"\"",
            "    return toBoolean(request.GET.get(name, default))",
            "",
            "",
            "def validate_redirect_url(url):",
            "    \"\"\"",
            "    Returns a URL is safe to redirect to.",
            "    If url is a different host, not in settings.REDIRECT_ALLOWED_HOSTS",
            "    we return webclient index URL.",
            "    \"\"\"",
            "    if not is_safe_url(url, allowed_hosts=settings.REDIRECT_ALLOWED_HOSTS):",
            "        url = reverse(\"webindex\")",
            "    return url",
            "",
            "",
            "##############################################################################",
            "# custom index page",
            "",
            "",
            "@never_cache",
            "@render_response()",
            "def custom_index(request, conn=None, **kwargs):",
            "    context = {\"version\": omero_version, \"build_year\": build_year}",
            "",
            "    if settings.INDEX_TEMPLATE is not None:",
            "        try:",
            "            template_loader.get_template(settings.INDEX_TEMPLATE)",
            "            context[\"template\"] = settings.INDEX_TEMPLATE",
            "        except Exception:",
            "            context[\"template\"] = \"webclient/index.html\"",
            "            context[\"error\"] = traceback.format_exception(*sys.exc_info())[-1]",
            "    else:",
            "        context[\"template\"] = \"webclient/index.html\"",
            "",
            "    return context",
            "",
            "",
            "##############################################################################",
            "# views",
            "",
            "",
            "class WebclientLoginView(LoginView):",
            "    \"\"\"",
            "    Webclient Login - Customises the superclass LoginView",
            "    for webclient. Also can be used by other Apps to log in to OMERO. Uses",
            "    the 'server' id from request to lookup the server-id (index), host and",
            "    port from settings. E.g. \"localhost\", 4064. Stores these details, along",
            "    with username, password etc in the request.session. Resets other data",
            "    parameters in the request.session. Tries to get connection to OMERO and",
            "    if this works, then we are redirected to the 'index' page or url",
            "    specified in REQUEST. If we can't connect, the login page is returned",
            "    with appropriate error messages.",
            "    \"\"\"",
            "",
            "    template = \"webclient/login.html\"",
            "    useragent = \"OMERO.web\"",
            "",
            "    def get(self, request):",
            "        \"\"\"",
            "        GET simply returns the login page",
            "        \"\"\"",
            "        return self.handle_not_logged_in(request)",
            "",
            "    def handle_logged_in(self, request, conn, connector):",
            "        \"\"\"",
            "        We override this to provide webclient-specific functionality",
            "        such as cleaning up any previous sessions (if user didn't logout)",
            "        and redirect to specified url or webclient index page.",
            "        \"\"\"",
            "",
            "        # webclient has various state that needs cleaning up...",
            "        # if 'active_group' remains in session from previous",
            "        # login, check it's valid for this user",
            "        # NB: we do this for public users in @login_required.get_connection()",
            "        if request.session.get(\"active_group\"):",
            "            if (",
            "                request.session.get(\"active_group\")",
            "                not in conn.getEventContext().memberOfGroups",
            "            ):",
            "                del request.session[\"active_group\"]",
            "        if request.session.get(\"user_id\"):",
            "            # always want to revert to logged-in user",
            "            del request.session[\"user_id\"]",
            "        if request.session.get(\"server_settings\"):",
            "            # always clean when logging in",
            "            del request.session[\"server_settings\"]",
            "        # do we ned to display server version ?",
            "        # server_version = conn.getServerVersion()",
            "        if request.POST.get(\"noredirect\"):",
            "            return HttpResponse(\"OK\")",
            "        url = request.GET.get(\"url\")",
            "        if url is None or len(url) == 0:",
            "            try:",
            "                url = parse_url(settings.LOGIN_REDIRECT)",
            "            except Exception:",
            "                url = reverse(\"webindex\")",
            "        else:",
            "            url = validate_redirect_url(url)",
            "        return HttpResponseRedirect(url)",
            "",
            "    def handle_not_logged_in(self, request, error=None, form=None):",
            "        \"\"\"",
            "        Returns a response for failed login.",
            "        Reason for failure may be due to server 'error' or because",
            "        of form validation errors.",
            "",
            "        @param request:     http request",
            "        @param error:       Error message",
            "        @param form:        Instance of Login Form, populated with data",
            "        \"\"\"",
            "        if form is None:",
            "            server_id = request.GET.get(\"server\", request.POST.get(\"server\"))",
            "            if server_id is not None:",
            "                initial = {\"server\": unicode(server_id)}",
            "                form = LoginForm(initial=initial)",
            "            else:",
            "                form = LoginForm()",
            "        context = {",
            "            \"version\": omero_version,",
            "            \"build_year\": build_year,",
            "            \"error\": error,",
            "            \"form\": form,",
            "        }",
            "        url = request.GET.get(\"url\")",
            "        if url is not None and len(url) != 0:",
            "            context[\"url\"] = urlencode({\"url\": url})",
            "",
            "        if hasattr(settings, \"LOGIN_LOGO\"):",
            "            context[\"LOGIN_LOGO\"] = settings.LOGIN_LOGO",
            "",
            "        if settings.PUBLIC_ENABLED:",
            "            redirect = reverse(\"webindex\")",
            "            if settings.PUBLIC_URL_FILTER.search(redirect):",
            "                context[\"public_enabled\"] = True",
            "                context[\"public_login_redirect\"] = redirect",
            "",
            "        context[\"show_download_links\"] = settings.SHOW_CLIENT_DOWNLOADS",
            "        if settings.SHOW_CLIENT_DOWNLOADS:",
            "            ver = re.match(",
            "                (",
            "                    r\"(?P<major>\\d+)\\.\"",
            "                    r\"(?P<minor>\\d+)\\.\"",
            "                    r\"(?P<patch>\\d+\\.?)?\"",
            "                    r\"(?P<dev>(dev|a|b|rc)\\d+)?.*\"",
            "                ),",
            "                omero_version,",
            "            )",
            "            client_download_tag_re = \"^v%s\\\\.%s\\\\.[^-]+$\" % (",
            "                ver.group(\"major\"),",
            "                ver.group(\"minor\"),",
            "            )",
            "            context[\"client_download_tag_re\"] = client_download_tag_re",
            "            context[\"client_download_repo\"] = settings.CLIENT_DOWNLOAD_GITHUB_REPO",
            "",
            "        return render(request, self.template, context)",
            "",
            "",
            "@login_required(ignore_login_fail=True)",
            "def keepalive_ping(request, conn=None, **kwargs):",
            "    \"\"\" Keeps the OMERO session alive by pinging the server \"\"\"",
            "",
            "    # login_required handles ping, timeout etc, so we don't need to do",
            "    # anything else",
            "    return HttpResponse(\"OK\")",
            "",
            "",
            "@login_required()",
            "def change_active_group(request, conn=None, url=None, **kwargs):",
            "    \"\"\"",
            "    Simply changes the request.session['active_group'] which is then used by",
            "    the @login_required decorator to configure conn for any group-based",
            "    queries.",
            "    Finally this redirects to the 'url'.",
            "    \"\"\"",
            "    switch_active_group(request)",
            "    url = url or reverse(\"webindex\")",
            "    url = validate_redirect_url(url)",
            "    return HttpResponseRedirect(url)",
            "",
            "",
            "def switch_active_group(request, active_group=None):",
            "    \"\"\"",
            "    Simply changes the request.session['active_group'] which is then used by",
            "    the @login_required decorator to configure conn for any group-based",
            "    queries.",
            "    \"\"\"",
            "    if active_group is None:",
            "        active_group = request.GET.get(\"active_group\")",
            "    active_group = int(active_group)",
            "    if (",
            "        \"active_group\" not in request.session",
            "        or active_group != request.session[\"active_group\"]",
            "    ):",
            "        request.session.modified = True",
            "        request.session[\"active_group\"] = active_group",
            "",
            "",
            "def fake_experimenter(request, default_name=\"All members\"):",
            "    \"\"\"",
            "    Marshal faked experimenter when id is -1",
            "    Load omero.client.ui.menu.dropdown.everyone.label as username",
            "    \"\"\"",
            "    label = (",
            "        request.session.get(\"server_settings\")",
            "        .get(\"ui\", {})",
            "        .get(\"menu\", {})",
            "        .get(\"dropdown\", {})",
            "        .get(\"everyone\", {})",
            "        .get(\"label\", default_name)",
            "    )",
            "    return {",
            "        \"id\": -1,",
            "        \"omeName\": label,",
            "        \"firstName\": label,",
            "        \"lastName\": \"\",",
            "    }",
            "",
            "",
            "@login_required(login_redirect=\"webindex\")",
            "def logout(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Logout of the session and redirects to the homepage (will redirect to",
            "    login first)",
            "    \"\"\"",
            "",
            "    if request.method == \"POST\":",
            "        try:",
            "            try:",
            "                conn.close()",
            "            except Exception:",
            "                logger.error(\"Exception during logout.\", exc_info=True)",
            "        finally:",
            "            request.session.flush()",
            "        return HttpResponseRedirect(reverse(settings.LOGIN_VIEW))",
            "    else:",
            "        context = {\"url\": reverse(\"weblogout\"), \"submit\": \"Do you want to log out?\"}",
            "        template = \"webgateway/base/includes/post_form.html\"",
            "        return render(request, template, context)",
            "",
            "",
            "###########################################################################",
            "def _load_template(request, menu, conn=None, url=None, **kwargs):",
            "",
            "    \"\"\"",
            "    This view handles most of the top-level pages, as specified by 'menu' E.g.",
            "    userdata, usertags, history, search etc.",
            "    Query string 'path' that specifies an object to display in the data tree",
            "    is parsed.",
            "    We also prepare the list of users in the current group, for the",
            "    switch-user form. Change-group form is also prepared.",
            "    \"\"\"",
            "    request.session.modified = True",
            "",
            "    template = kwargs.get(\"template\", None)",
            "    if template is None:",
            "        if menu == \"userdata\":",
            "            template = \"webclient/data/containers.html\"",
            "        elif menu == \"usertags\":",
            "            template = \"webclient/data/containers.html\"",
            "        else:",
            "            # E.g. search/search.html",
            "            template = \"webclient/%s/%s.html\" % (menu, menu)",
            "",
            "    # tree support",
            "    show = kwargs.get(\"show\", Show(conn, request, menu))",
            "    # Constructor does no loading.  Show.first_selected must be called first",
            "    # in order to set up our initial state correctly.",
            "    try:",
            "        first_sel = show.first_selected",
            "    except IncorrectMenuError as e:",
            "        return HttpResponseRedirect(e.uri)",
            "    # We get the owner of the top level object, E.g. Project",
            "    # Actual api_paths_to_object() is retrieved by jsTree once loaded",
            "    initially_open_owner = show.initially_open_owner",
            "",
            "    # If we failed to find 'show'...",
            "    if request.GET.get(\"show\", None) is not None and first_sel is None:",
            "        # and we're logged in as PUBLIC user...",
            "        if (",
            "            settings.PUBLIC_ENABLED",
            "            and settings.PUBLIC_USER == conn.getUser().getOmeName()",
            "        ):",
            "            # this is likely a regular user who needs to log in as themselves.",
            "            # Login then redirect to current url",
            "            return HttpResponseRedirect(\"%s?url=%s\" % (reverse(\"weblogin\"), url))",
            "",
            "    # need to be sure that tree will be correct omero.group",
            "    if first_sel is not None:",
            "        switch_active_group(request, first_sel.details.group.id.val)",
            "",
            "    # search support",
            "    init = {}",
            "    global_search_form = GlobalSearchForm(data=request.GET.copy())",
            "    if menu == \"search\":",
            "        if global_search_form.is_valid():",
            "            init[\"query\"] = global_search_form.cleaned_data[\"search_query\"]",
            "",
            "    # get url without request string - used to refresh page after switch",
            "    # user/group etc",
            "    url = kwargs.get(\"load_template_url\", None)",
            "    if url is None:",
            "        url = reverse(viewname=\"load_template\", args=[menu])",
            "",
            "    # validate experimenter is in the active group",
            "    active_group = request.session.get(\"active_group\") or conn.getEventContext().groupId",
            "    # prepare members of group...",
            "    leaders, members = conn.getObject(\"ExperimenterGroup\", active_group).groupSummary()",
            "    userIds = [u.id for u in leaders]",
            "    userIds.extend([u.id for u in members])",
            "",
            "    # check any change in experimenter...",
            "    user_id = request.GET.get(\"experimenter\")",
            "    if initially_open_owner is not None:",
            "        if request.session.get(\"user_id\", None) != -1:",
            "            # if we're not already showing 'All Members'...",
            "            user_id = initially_open_owner",
            "    try:",
            "        user_id = long(user_id)",
            "    except Exception:",
            "        user_id = None",
            "    # check if user_id is in a currnt group",
            "    if user_id is not None:",
            "        if (",
            "            user_id",
            "            not in (",
            "                set(map(lambda x: x.id, leaders)) | set(map(lambda x: x.id, members))",
            "            )",
            "            and user_id != -1",
            "        ):",
            "            # All users in group is allowed",
            "            user_id = None",
            "    if user_id is None:",
            "        # ... or check that current user is valid in active group",
            "        user_id = request.session.get(\"user_id\", None)",
            "        if user_id is None or int(user_id) not in userIds:",
            "            if user_id != -1:  # All users in group is allowed",
            "                user_id = conn.getEventContext().userId",
            "",
            "    request.session[\"user_id\"] = user_id",
            "",
            "    myGroups = list(conn.getGroupsMemberOf())",
            "    myGroups.sort(key=lambda x: x.getName().lower())",
            "    groups = myGroups",
            "",
            "    new_container_form = ContainerForm()",
            "",
            "    # colleagues required for search.html page only.",
            "    myColleagues = {}",
            "    if menu == \"search\":",
            "        for g in groups:",
            "            g.loadLeadersAndMembers()",
            "            for c in g.leaders + g.colleagues:",
            "                myColleagues[c.id] = c",
            "        myColleagues = list(myColleagues.values())",
            "        myColleagues.sort(key=lambda x: x.getLastName().lower())",
            "",
            "    context = {",
            "        \"menu\": menu,",
            "        \"init\": init,",
            "        \"myGroups\": myGroups,",
            "        \"new_container_form\": new_container_form,",
            "        \"global_search_form\": global_search_form,",
            "    }",
            "    context[\"groups\"] = groups",
            "    context[\"myColleagues\"] = myColleagues",
            "    context[\"active_group\"] = conn.getObject(\"ExperimenterGroup\", long(active_group))",
            "    context[\"active_user\"] = conn.getObject(\"Experimenter\", long(user_id))",
            "    context[\"initially_select\"] = show.initially_select",
            "    context[\"initially_open\"] = show.initially_open",
            "    context[\"isLeader\"] = conn.isLeader()",
            "    context[\"current_url\"] = url",
            "    context[\"page_size\"] = settings.PAGE",
            "    context[\"template\"] = template",
            "    context[\"thumbnails_batch\"] = settings.THUMBNAILS_BATCH",
            "    context[\"current_admin_privileges\"] = conn.getCurrentAdminPrivileges()",
            "    context[\"leader_of_groups\"] = conn.getEventContext().leaderOfGroups",
            "    context[\"member_of_groups\"] = conn.getEventContext().memberOfGroups",
            "",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_template(request, menu, conn=None, url=None, **kwargs):",
            "    return _load_template(request=request, menu=menu, conn=conn, url=url, **kwargs)",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def group_user_content(request, url=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Loads html content of the Groups/Users drop-down menu on main webclient",
            "    pages.",
            "    Url should be supplied in request, as target for redirect after switching",
            "    group.",
            "    \"\"\"",
            "",
            "    myGroups = list(conn.getGroupsMemberOf())",
            "    myGroups.sort(key=lambda x: x.getName().lower())",
            "    if conn.isAdmin():  # Admin can see all groups",
            "        system_groups = [",
            "            conn.getAdminService().getSecurityRoles().userGroupId,",
            "            conn.getAdminService().getSecurityRoles().guestGroupId,",
            "        ]",
            "        groups = conn.getObjects(\"ExperimenterGroup\", opts={\"load_experimenters\": True})",
            "        groups = [g for g in groups if g.getId() not in system_groups]",
            "        groups.sort(key=lambda x: x.getName().lower())",
            "    else:",
            "        groups = myGroups",
            "",
            "    for g in groups:",
            "        g.loadLeadersAndMembers()  # load leaders / members",
            "",
            "    context = {",
            "        \"template\": \"webclient/base/includes/group_user_content.html\",",
            "        \"current_url\": url,",
            "        \"groups\": groups,",
            "        \"myGroups\": myGroups,",
            "    }",
            "    return context",
            "",
            "",
            "@login_required()",
            "def api_group_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        member_id = get_long_or_default(request, \"member\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    try:",
            "        # Get the groups",
            "        groups = tree.marshal_groups(",
            "            conn=conn, member_id=member_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"groups\": groups})",
            "",
            "",
            "@login_required()",
            "def api_experimenter_detail(request, experimenter_id, conn=None, **kwargs):",
            "    # Validate parameter",
            "    try:",
            "        experimenter_id = long(experimenter_id)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid experimenter id\")",
            "",
            "    try:",
            "        # Get the experimenter",
            "        if experimenter_id < 0:",
            "            experimenter = fake_experimenter(request)",
            "        else:",
            "            # Get the experimenter",
            "            experimenter = tree.marshal_experimenter(",
            "                conn=conn, experimenter_id=experimenter_id",
            "            )",
            "            if experimenter is None:",
            "                raise Http404(\"No Experimenter found with ID %s\" % experimenter_id)",
            "        return JsonResponse({\"experimenter\": experimenter})",
            "",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "",
            "@login_required()",
            "def api_container_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        experimenter_id = get_long_or_default(request, \"id\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    # While this interface does support paging, it does so in a",
            "    # very odd way. The results per page is enforced per query so this",
            "    # will actually get the limit for projects, datasets (without",
            "    # parents), screens and plates (without parents). This is fine for",
            "    # the first page, but the second page may not be what is expected.",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    r = dict()",
            "    try:",
            "        # Get the projects",
            "        r[\"projects\"] = tree.marshal_projects(",
            "            conn=conn,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "",
            "        # Get the orphaned datasets (without project parents)",
            "        r[\"datasets\"] = tree.marshal_datasets(",
            "            conn=conn,",
            "            orphaned=True,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "",
            "        # Get the screens for the current user",
            "        r[\"screens\"] = tree.marshal_screens(",
            "            conn=conn,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "",
            "        # Get the orphaned plates (without project parents)",
            "        r[\"plates\"] = tree.marshal_plates(",
            "            conn=conn,",
            "            orphaned=True,",
            "            group_id=group_id,",
            "            experimenter_id=experimenter_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "        # Get the orphaned images container",
            "        try:",
            "            orph_t = request.session[\"server_settings\"][\"ui\"][\"tree\"][\"orphans\"]",
            "        except Exception:",
            "            orph_t = {\"enabled\": True}",
            "        if (",
            "            conn.isAdmin()",
            "            or conn.isLeader(gid=request.session.get(\"active_group\"))",
            "            or experimenter_id == conn.getUserId()",
            "            or orph_t.get(\"enabled\", True)",
            "        ):",
            "",
            "            orphaned = tree.marshal_orphaned(",
            "                conn=conn,",
            "                group_id=group_id,",
            "                experimenter_id=experimenter_id,",
            "                page=page,",
            "                limit=limit,",
            "            )",
            "            orphaned[\"name\"] = orph_t.get(\"name\", \"Orphaned Images\")",
            "            r[\"orphaned\"] = orphaned",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse(r)",
            "",
            "",
            "@login_required()",
            "def api_dataset_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        project_id = get_long_or_default(request, \"id\", None)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    try:",
            "        # Get the datasets",
            "        datasets = tree.marshal_datasets(",
            "            conn=conn, project_id=project_id, group_id=group_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"datasets\": datasets})",
            "",
            "",
            "@login_required()",
            "def api_image_list(request, conn=None, **kwargs):",
            "    \"\"\"Get a list of images",
            "    Specifiying dataset_id will return only images in that dataset",
            "    Specifying experimenter_id will return orpahned images for that",
            "    user",
            "    The orphaned images will include images which belong to the user",
            "    but are not in any dataset belonging to the user",
            "    Currently specifying both, experimenter_id will be ignored",
            "",
            "    \"\"\"",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        dataset_id = get_long_or_default(request, \"id\", None)",
            "        orphaned = get_bool_or_default(request, \"orphaned\", False)",
            "        load_pixels = get_bool_or_default(request, \"sizeXYZ\", False)",
            "        thumb_version = get_bool_or_default(request, \"thumbVersion\", False)",
            "        date = get_bool_or_default(request, \"date\", False)",
            "        experimenter_id = get_long_or_default(request, \"experimenter_id\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    # Share ID is in kwargs from api/share_images/<id>/ which will create",
            "    # a share connection in @login_required.",
            "    # We don't support ?share_id in query string since this would allow a",
            "    # share connection to be created for ALL urls, instead of just this one.",
            "    share_id = \"share_id\" in kwargs and long(kwargs[\"share_id\"]) or None",
            "",
            "    try:",
            "        # Get the images",
            "        images = tree.marshal_images(",
            "            conn=conn,",
            "            orphaned=orphaned,",
            "            experimenter_id=experimenter_id,",
            "            dataset_id=dataset_id,",
            "            share_id=share_id,",
            "            load_pixels=load_pixels,",
            "            group_id=group_id,",
            "            page=page,",
            "            date=date,",
            "            thumb_version=thumb_version,",
            "            limit=limit,",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"images\": images})",
            "",
            "",
            "@login_required()",
            "def api_plate_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        screen_id = get_long_or_default(request, \"id\", None)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if not conn.isValidGroup(group_id):",
            "        return HttpResponseForbidden(\"Not a member of Group: %s\" % group_id)",
            "",
            "    try:",
            "        # Get the plates",
            "        plates = tree.marshal_plates(",
            "            conn=conn, screen_id=screen_id, group_id=group_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"plates\": plates})",
            "",
            "",
            "@login_required()",
            "def api_plate_acquisition_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        plate_id = get_long_or_default(request, \"id\", None)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    # Orphaned PlateAcquisitions are not possible so querying without a",
            "    # plate is an error",
            "    if plate_id is None:",
            "        return HttpResponseBadRequest(\"id (plate) must be specified\")",
            "",
            "    try:",
            "        # Get the plate acquisitions",
            "        plate_acquisitions = tree.marshal_plate_acquisitions(",
            "            conn=conn, plate_id=plate_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"acquisitions\": plate_acquisitions})",
            "",
            "",
            "def get_object_links(conn, parent_type, parent_id, child_type, child_ids):",
            "    \"\"\" This is just used internally by api_link DELETE below \"\"\"",
            "    if parent_type == \"orphaned\":",
            "        return None",
            "    link_type = None",
            "    if parent_type == \"experimenter\":",
            "        if child_type in [\"dataset\", \"plate\", \"tag\"]:",
            "            # This will be a requested link if a dataset or plate is",
            "            # moved from the de facto orphaned datasets/plates, it isn't",
            "            # an error, but no link actually needs removing",
            "            return None",
            "    elif parent_type == \"project\":",
            "        if child_type == \"dataset\":",
            "            link_type = \"ProjectDatasetLink\"",
            "    elif parent_type == \"dataset\":",
            "        if child_type == \"image\":",
            "            link_type = \"DatasetImageLink\"",
            "    elif parent_type == \"screen\":",
            "        if child_type == \"plate\":",
            "            link_type = \"ScreenPlateLink\"",
            "    elif parent_type == \"tagset\":",
            "        if child_type == \"tag\":",
            "            link_type = \"AnnotationAnnotationLink\"",
            "    if not link_type:",
            "        raise Http404(\"json data needs 'parent_type' and 'child_type'\")",
            "",
            "    params = omero.sys.ParametersI()",
            "    params.addIds(child_ids)",
            "",
            "    qs = conn.getQueryService()",
            "    # Need to fetch child and parent, otherwise",
            "    # AnnotationAnnotationLink is not loaded",
            "    q = (",
            "        \"\"\"",
            "        from %s olink join fetch olink.child join fetch olink.parent",
            "        where olink.child.id in (:ids)",
            "        \"\"\"",
            "        % link_type",
            "    )",
            "    if parent_id:",
            "        params.add(\"pid\", rlong(parent_id))",
            "        q += \" and olink.parent.id = :pid\"",
            "",
            "    res = qs.findAllByQuery(q, params, conn.SERVICE_OPTS)",
            "",
            "    if parent_id is not None and len(res) == 0:",
            "        raise Http404(",
            "            \"No link found for %s-%s to %s-%s\"",
            "            % (parent_type, parent_id, child_type, child_ids)",
            "        )",
            "    return link_type, res",
            "",
            "",
            "def create_link(parent_type, parent_id, child_type, child_id):",
            "    \"\"\" This is just used internally by api_link DELETE below \"\"\"",
            "    if parent_type == \"experimenter\":",
            "        if child_type == \"dataset\" or child_type == \"plate\":",
            "            # This is actually not a link that needs creating, this",
            "            # dataset/plate is an orphan",
            "            return \"orphan\"",
            "    if parent_type == \"project\":",
            "        project = ProjectI(long(parent_id), False)",
            "        if child_type == \"dataset\":",
            "            dataset = DatasetI(long(child_id), False)",
            "            link = ProjectDatasetLinkI()",
            "            link.setParent(project)",
            "            link.setChild(dataset)",
            "            return link",
            "    elif parent_type == \"dataset\":",
            "        dataset = DatasetI(long(parent_id), False)",
            "        if child_type == \"image\":",
            "            image = ImageI(long(child_id), False)",
            "            link = DatasetImageLinkI()",
            "            link.setParent(dataset)",
            "            link.setChild(image)",
            "            return link",
            "    elif parent_type == \"screen\":",
            "        screen = ScreenI(long(parent_id), False)",
            "        if child_type == \"plate\":",
            "            plate = PlateI(long(child_id), False)",
            "            link = ScreenPlateLinkI()",
            "            link.setParent(screen)",
            "            link.setChild(plate)",
            "            return link",
            "    elif parent_type == \"tagset\":",
            "        if child_type == \"tag\":",
            "            link = AnnotationAnnotationLinkI()",
            "            link.setParent(TagAnnotationI(long(parent_id), False))",
            "            link.setChild(TagAnnotationI(long(child_id), False))",
            "            return link",
            "    return None",
            "",
            "",
            "def get_objects_owners(conn, child_type, child_ids):",
            "    \"\"\"",
            "    Returns a dict of child_id: owner_id",
            "    \"\"\"",
            "    if child_type == \"tag\":",
            "        child_type = \"Annotation\"",
            "    owners = {}",
            "    for obj in conn.getObjects(child_type, child_ids):",
            "        owners[obj.id] = obj.details.owner.id.val",
            "    return owners",
            "",
            "",
            "@login_required()",
            "def api_links(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Entry point for the api_links methods.",
            "    We delegate depending on request method to",
            "    create or delete links between objects.",
            "    \"\"\"",
            "    if request.method not in [\"POST\", \"DELETE\"]:",
            "        return JsonResponse(",
            "            {\"Error\": \"Need to POST or DELETE JSON data to update links\"}, status=405",
            "        )",
            "    # Handle link creation/deletion",
            "    try:",
            "        json_data = json.loads(request.body)",
            "    except TypeError:",
            "        # for Python 3.5",
            "        json_data = json.loads(bytes_to_native_str(request.body))",
            "",
            "    if request.method == \"POST\":",
            "        return _api_links_POST(conn, json_data)",
            "    elif request.method == \"DELETE\":",
            "        return _api_links_DELETE(conn, json_data)",
            "",
            "",
            "def _api_links_POST(conn, json_data, **kwargs):",
            "    \"\"\"Creates links between objects specified by a json",
            "    blob in the request body.",
            "    e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "    When creating a link, fails silently if ValidationException",
            "    (E.g. adding an image to a Dataset that already has that image).",
            "    \"\"\"",
            "",
            "    response = {\"success\": False}",
            "",
            "    # json is [parent_type][parent_id][child_type][childIds]",
            "    # e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "",
            "    linksToSave = []",
            "    write_owned = \"WriteOwned\" in conn.getCurrentAdminPrivileges()",
            "    user_id = conn.getUserId()",
            "    for parent_type, parents in json_data.items():",
            "        if parent_type in (\"orphaned\", \"experimenter\"):",
            "            continue",
            "        for parent_id, children in parents.items():",
            "            for child_type, child_ids in children.items():",
            "                # batch look-up owners of all child objects",
            "                child_owners = get_objects_owners(conn, child_type, child_ids)",
            "                for child_id in child_ids:",
            "                    parent_id = int(parent_id)",
            "                    link = create_link(parent_type, parent_id, child_type, child_id)",
            "                    if link and link != \"orphan\":",
            "                        # link owner should match child owner",
            "                        if write_owned and child_owners[child_id] != user_id:",
            "                            link.details.owner = ExperimenterI(",
            "                                child_owners[child_id], False",
            "                            )",
            "                        linksToSave.append(link)",
            "",
            "    if len(linksToSave) > 0:",
            "        # Need to set context to correct group (E.g parent group)",
            "        ptype = parent_type.title()",
            "        if ptype in [\"Tagset\", \"Tag\"]:",
            "            ptype = \"TagAnnotation\"",
            "        p = conn.getQueryService().get(ptype, parent_id, conn.SERVICE_OPTS)",
            "        conn.SERVICE_OPTS.setOmeroGroup(p.details.group.id.val)",
            "        logger.info(\"api_link: Saving %s links\" % len(linksToSave))",
            "",
            "        try:",
            "            # We try to save all at once, for speed.",
            "            conn.saveArray(linksToSave)",
            "            response[\"success\"] = True",
            "        except Exception:",
            "            logger.info(",
            "                \"api_link: Exception on saveArray with %s links\" % len(linksToSave)",
            "            )",
            "            # If this fails, e.g. ValidationException because link",
            "            # already exists, try to save individual links",
            "            for link in linksToSave:",
            "                try:",
            "                    conn.saveObject(link)",
            "                except Exception:",
            "                    pass",
            "            response[\"success\"] = True",
            "",
            "    return JsonResponse(response)",
            "",
            "",
            "def _api_links_DELETE(conn, json_data):",
            "    \"\"\"Deletes links between objects specified by a json",
            "    blob in the request body.",
            "    e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "    \"\"\"",
            "",
            "    response = {\"success\": False}",
            "",
            "    # json is [parent_type][parent_id][child_type][childIds]",
            "    # e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "    for parent_type, parents in json_data.items():",
            "        if parent_type == \"orphaned\":",
            "            continue",
            "        for parent_id, children in parents.items():",
            "            for child_type, child_ids in children.items():",
            "                objLnks = get_object_links(",
            "                    conn, parent_type, parent_id, child_type, child_ids",
            "                )",
            "                if objLnks is None:",
            "                    continue",
            "                linkType, links = objLnks",
            "                linkIds = [r.id.val for r in links]",
            "                logger.info(\"api_link: Deleting %s links\" % len(linkIds))",
            "                conn.deleteObjects(linkType, linkIds, wait=True)",
            "                # webclient needs to know what is orphaned",
            "                linkType, remainingLinks = get_object_links(",
            "                    conn, parent_type, None, child_type, child_ids",
            "                )",
            "                # return remaining links in same format as json above",
            "                # e.g. {\"dataset\":{\"10\":{\"image\":[1,2,3]}}}",
            "                for rl in remainingLinks:",
            "                    pid = rl.parent.id.val",
            "                    cid = rl.child.id.val",
            "                    # Deleting links still in progress above - ignore these",
            "                    if pid == int(parent_id):",
            "                        continue",
            "                    if parent_type not in response:",
            "                        response[parent_type] = {}",
            "                    if pid not in response[parent_type]:",
            "                        response[parent_type][pid] = {child_type: []}",
            "                    response[parent_type][pid][child_type].append(cid)",
            "",
            "    # If we got here, DELETE was OK",
            "    response[\"success\"] = True",
            "",
            "    return JsonResponse(response)",
            "",
            "",
            "@login_required()",
            "def api_parent_links(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Get a list of links as",
            "    {'data': [{id: 12, child:{type:'image', id:1},",
            "               parent:{type:'dataset', id:2}] }",
            "",
            "    Supports ?image=1,2 and ?image=1&image=2",
            "    \"\"\"",
            "    parent_types = {\"image\": \"dataset\", \"dataset\": \"project\", \"plate\": \"screen\"}",
            "    parents = []",
            "    for child_type, parent_type in parent_types.items():",
            "        ids = request.GET.getlist(child_type)",
            "        if len(ids) == 0:",
            "            continue",
            "        # support for ?image=1,2",
            "        child_ids = []",
            "        for id in ids:",
            "            for i in id.split(\",\"):",
            "                child_ids.append(i)",
            "",
            "        link_type, result = get_object_links(",
            "            conn, parent_type, None, child_type, child_ids",
            "        )",
            "        for link in result:",
            "            parents.append(",
            "                {",
            "                    \"id\": link.id.val,",
            "                    \"parent\": {\"type\": parent_type, \"id\": link.parent.id.val},",
            "                    \"child\": {\"type\": child_type, \"id\": link.child.id.val},",
            "                }",
            "            )",
            "",
            "    return JsonResponse({\"data\": parents})",
            "",
            "",
            "@login_required()",
            "def api_paths_to_object(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This finds the paths to objects in the hierarchy. It returns only",
            "    the path, not the object hierarchy itself.",
            "",
            "    An example usage is for the 'show' functionality",
            "    Example to go to the image with id 1 somewhere in the tree.",
            "    http://localhost:8000/webclient/?show=image-1",
            "",
            "    This method can tell the webclient exactly what needs to be",
            "    dynamically loaded to display this in the jstree.",
            "    \"\"\"",
            "",
            "    try:",
            "        experimenter_id = get_long_or_default(request, \"experimenter\", None)",
            "        project_id = get_long_or_default(request, \"project\", None)",
            "        dataset_id = get_long_or_default(request, \"dataset\", None)",
            "        image_id = get_long_or_default(request, \"image\", None)",
            "        screen_id = get_long_or_default(request, \"screen\", None)",
            "        plate_id = get_long_or_default(request, \"plate\", None)",
            "        acquisition_id = get_long_or_default(request, \"run\", None)",
            "        # acquisition will override 'run' if both are specified as they are",
            "        # the same thing",
            "        acquisition_id = get_long_or_default(request, \"acquisition\", acquisition_id)",
            "        well_id = request.GET.get(\"well\", None)",
            "        tag_id = get_long_or_default(request, \"tag\", None)",
            "        tagset_id = get_long_or_default(request, \"tagset\", None)",
            "        roi_id = get_long_or_default(request, \"roi\", None)",
            "        shape_id = get_long_or_default(request, \"shape\", None)",
            "        group_id = get_long_or_default(request, \"group\", None)",
            "        page_size = get_long_or_default(request, \"page_size\", settings.PAGE)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    if tag_id is not None or tagset_id is not None:",
            "        paths = paths_to_tag(conn, experimenter_id, tagset_id, tag_id)",
            "",
            "    else:",
            "        paths = paths_to_object(",
            "            conn,",
            "            experimenter_id,",
            "            project_id,",
            "            dataset_id,",
            "            image_id,",
            "            screen_id,",
            "            plate_id,",
            "            acquisition_id,",
            "            well_id,",
            "            group_id,",
            "            page_size,",
            "            roi_id,",
            "            shape_id,",
            "        )",
            "    return JsonResponse({\"paths\": paths})",
            "",
            "",
            "@login_required()",
            "def api_tags_and_tagged_list(request, conn=None, **kwargs):",
            "    if request.method == \"GET\":",
            "        return api_tags_and_tagged_list_GET(request, conn, **kwargs)",
            "    elif request.method == \"DELETE\":",
            "        return api_tags_and_tagged_list_DELETE(request, conn, **kwargs)",
            "",
            "",
            "def api_tags_and_tagged_list_GET(request, conn=None, **kwargs):",
            "    \"\"\"Get a list of tags",
            "    Specifiying tag_id will return any sub-tags, sub-tagsets and",
            "    objects tagged with that id",
            "    If no tagset_id is specifed it will return tags which have no",
            "    parent",
            "    \"\"\"",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        group_id = get_long_or_default(request, \"group\", -1)",
            "        tag_id = get_long_or_default(request, \"id\", None)",
            "        experimenter_id = get_long_or_default(request, \"experimenter_id\", -1)",
            "        orphaned = get_bool_or_default(request, \"orphaned\", False)",
            "        load_pixels = get_bool_or_default(request, \"sizeXYZ\", False)",
            "        date = get_bool_or_default(request, \"date\", False)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    try:",
            "        # Get ALL data (all owners) under specified tags",
            "        if tag_id is not None:",
            "            tagged = tree.marshal_tagged(",
            "                conn=conn,",
            "                experimenter_id=experimenter_id,",
            "                tag_id=tag_id,",
            "                group_id=group_id,",
            "                page=page,",
            "                load_pixels=load_pixels,",
            "                date=date,",
            "                limit=limit,",
            "            )",
            "        else:",
            "            tagged = {}",
            "",
            "        # Get 'tags' under tag_id",
            "        tagged[\"tags\"] = tree.marshal_tags(",
            "            conn=conn,",
            "            orphaned=orphaned,",
            "            experimenter_id=experimenter_id,",
            "            tag_id=tag_id,",
            "            group_id=group_id,",
            "            page=page,",
            "            limit=limit,",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse(tagged)",
            "",
            "",
            "def api_tags_and_tagged_list_DELETE(request, conn=None, **kwargs):",
            "    \"\"\"Delete the listed tags by ids\"\"\"",
            "    # Get parameters",
            "    try:",
            "        tag_ids = get_longs(request, \"id\")",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    dcs = list()",
            "",
            "    handle = None",
            "    try:",
            "        for tag_id in tag_ids:",
            "            dcs.append(omero.cmd.Delete(\"/Annotation\", tag_id))",
            "        doall = omero.cmd.DoAll()",
            "        doall.requests = dcs",
            "        handle = conn.c.sf.submit(doall, conn.SERVICE_OPTS)",
            "",
            "        try:",
            "            conn._waitOnCmd(handle)",
            "        finally:",
            "            handle.close()",
            "",
            "    except CmdError as e:",
            "        return HttpResponseBadRequest(e.message)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse(\"\")",
            "",
            "",
            "@login_required()",
            "def api_annotations(request, conn=None, **kwargs):",
            "",
            "    r = request.GET",
            "    image_ids = get_list(request, \"image\")",
            "    dataset_ids = get_list(request, \"dataset\")",
            "    project_ids = get_list(request, \"project\")",
            "    screen_ids = get_list(request, \"screen\")",
            "    plate_ids = get_list(request, \"plate\")",
            "    run_ids = get_list(request, \"acquisition\")",
            "    well_ids = get_list(request, \"well\")",
            "    page = get_long_or_default(request, \"page\", 1)",
            "    limit = get_long_or_default(request, \"limit\", ANNOTATIONS_LIMIT)",
            "",
            "    ann_type = r.get(\"type\", None)",
            "    ns = r.get(\"ns\", None)",
            "",
            "    anns, exps = tree.marshal_annotations(",
            "        conn,",
            "        project_ids=project_ids,",
            "        dataset_ids=dataset_ids,",
            "        image_ids=image_ids,",
            "        screen_ids=screen_ids,",
            "        plate_ids=plate_ids,",
            "        run_ids=run_ids,",
            "        well_ids=well_ids,",
            "        ann_type=ann_type,",
            "        ns=ns,",
            "        page=page,",
            "        limit=limit,",
            "    )",
            "",
            "    return JsonResponse({\"annotations\": anns, \"experimenters\": exps})",
            "",
            "",
            "@login_required()",
            "def api_share_list(request, conn=None, **kwargs):",
            "    # Get parameters",
            "    try:",
            "        page = get_long_or_default(request, \"page\", 1)",
            "        limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "        member_id = get_long_or_default(request, \"member_id\", -1)",
            "        owner_id = get_long_or_default(request, \"owner_id\", -1)",
            "    except ValueError:",
            "        return HttpResponseBadRequest(\"Invalid parameter value\")",
            "",
            "    # Like with api_container_list, this is a combination of",
            "    # results which will each be able to return up to the limit in page",
            "    # size",
            "",
            "    try:",
            "        # Get the shares",
            "        shares = tree.marshal_shares(",
            "            conn=conn, member_id=member_id, owner_id=owner_id, page=page, limit=limit",
            "        )",
            "        # Get the discussions",
            "        discussions = tree.marshal_discussions(",
            "            conn=conn, member_id=member_id, owner_id=owner_id, page=page, limit=limit",
            "        )",
            "    except ApiUsageException as e:",
            "        return HttpResponseBadRequest(e.serverStackTrace)",
            "    except ServerError as e:",
            "        return HttpResponseServerError(e.serverStackTrace)",
            "    except IceException as e:",
            "        return HttpResponseServerError(e.message)",
            "",
            "    return JsonResponse({\"shares\": shares, \"discussions\": discussions})",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_plate(request, o1_type=None, o1_id=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    This loads data for the center panel, via AJAX calls.",
            "    Used for Datasets, Plates & Orphaned Images.",
            "    \"\"\"",
            "",
            "    # get index of the plate",
            "    index = getIntOrDefault(request, \"index\", 0)",
            "",
            "    # prepare data. E.g. kw = {}  or  {'plate': 301L}  or",
            "    # 'acquisition': 301L}",
            "    kw = dict()",
            "    if o1_type is not None:",
            "        if o1_id is not None and int(o1_id) > 0:",
            "            kw[str(o1_type)] = long(o1_id)",
            "",
            "    try:",
            "        manager = BaseContainer(conn, **kw)",
            "    except AttributeError as x:",
            "        return handlerInternalError(request, x)",
            "",
            "    # prepare forms",
            "    form_well_index = None",
            "",
            "    context = {\"manager\": manager, \"form_well_index\": form_well_index, \"index\": index}",
            "",
            "    # load data & template",
            "    template = None",
            "    if \"plate\" in kw or \"acquisition\" in kw:",
            "        fields = manager.getNumberOfFields()",
            "        if fields is not None:",
            "            form_well_index = WellIndexForm(initial={\"index\": index, \"range\": fields})",
            "            if index == 0:",
            "                index = fields[0]",
            "",
            "        # Show parameter will be well-1|well-2",
            "        show = request.GET.get(\"show\")",
            "        if show is not None:",
            "            wells_to_select = []",
            "            for w in show.split(\"|\"):",
            "                if \"well-\" in w:",
            "                    wells_to_select.append(w.replace(\"well-\", \"\"))",
            "            context[\"select_wells\"] = \",\".join(wells_to_select)",
            "",
            "        context[\"baseurl\"] = reverse(\"webgateway\").rstrip(\"/\")",
            "        context[\"form_well_index\"] = form_well_index",
            "        context[\"index\"] = index",
            "        context[\"thumbnails_batch\"] = settings.THUMBNAILS_BATCH",
            "        template = \"webclient/data/plate.html\"",
            "        if o1_type == \"acquisition\":",
            "            context[\"acquisition\"] = o1_id",
            "",
            "    context[\"isLeader\"] = conn.isLeader()",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_chgrp_groups(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Get the potential groups we can move selected data to.",
            "    These will be groups that the owner(s) of selected objects is a member of.",
            "    Objects are specified by query string like: ?Image=1,2&Dataset=3",
            "    If no selected objects are specified, simply list the groups that the",
            "    current user is a member of.",
            "    Groups list will exclude the 'current' group context.",
            "    \"\"\"",
            "",
            "    ownerIds = []",
            "    currentGroups = set()",
            "    groupSets = []",
            "    groups = {}",
            "    owners = {}",
            "    for dtype in (\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\"):",
            "        oids = request.GET.get(dtype, None)",
            "        if oids is not None:",
            "            for o in conn.getObjects(dtype, oids.split(\",\")):",
            "                ownerIds.append(o.getDetails().owner.id.val)",
            "                currentGroups.add(o.getDetails().group.id.val)",
            "    ownerIds = list(set(ownerIds))",
            "    # In case we were passed no objects or they weren't found",
            "    if len(ownerIds) == 0:",
            "        ownerIds = [conn.getUserId()]",
            "    for owner in conn.getObjects(",
            "        \"Experimenter\", ownerIds, opts={\"load_experimentergroups\": True}",
            "    ):",
            "        # Each owner has a set of groups",
            "        gids = []",
            "        owners[owner.id] = owner.getFullName()",
            "        for group in owner.copyGroupExperimenterMap():",
            "            groups[group.parent.id.val] = group.parent",
            "            gids.append(group.parent.id.val)",
            "        groupSets.append(set(gids))",
            "",
            "    # Can move to groups that all owners are members of...",
            "    targetGroupIds = set.intersection(*groupSets)",
            "    # ...but not 'user' group",
            "    userGroupId = conn.getAdminService().getSecurityRoles().userGroupId",
            "    if userGroupId in targetGroupIds:",
            "        targetGroupIds.remove(userGroupId)",
            "",
            "    # if all the Objects are in a single group, exclude it from the target",
            "    # groups",
            "    if len(currentGroups) == 1:",
            "        curr_grp = currentGroups.pop()",
            "        if curr_grp in targetGroupIds:",
            "            targetGroupIds.remove(curr_grp)",
            "",
            "    def getPerms(group):",
            "        p = group.getDetails().permissions",
            "        return {",
            "            \"write\": p.isGroupWrite(),",
            "            \"annotate\": p.isGroupAnnotate(),",
            "            \"read\": p.isGroupRead(),",
            "        }",
            "",
            "    # From groupIds, create a list of group dicts for json",
            "    targetGroups = []",
            "    for gid in targetGroupIds:",
            "        targetGroups.append(",
            "            {\"id\": gid, \"name\": groups[gid].name.val, \"perms\": getPerms(groups[gid])}",
            "        )",
            "    targetGroups.sort(key=lambda x: x[\"name\"])",
            "",
            "    owners = [[k, v] for k, v in owners.items()]",
            "",
            "    return {\"owners\": owners, \"groups\": targetGroups}",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_chgrp_target(request, group_id, target_type, conn=None, **kwargs):",
            "    \"\"\" Loads a tree for user to pick target Project, Dataset or Screen \"\"\"",
            "",
            "    # filter by group (not switching group)",
            "    conn.SERVICE_OPTS.setOmeroGroup(int(group_id))",
            "    owner = getIntOrDefault(request, \"owner\", None)",
            "",
            "    manager = BaseContainer(conn)",
            "    manager.listContainerHierarchy(owner)",
            "    template = \"webclient/data/chgrp_target_tree.html\"",
            "",
            "    context = {\"manager\": manager, \"target_type\": target_type, \"template\": template}",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_searching(request, form=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Handles AJAX calls to search",
            "    \"\"\"",
            "    manager = BaseSearch(conn)",
            "",
            "    foundById = []",
            "    # form = 'form' if we are searching. Get query from request...",
            "    r = request.GET",
            "    if form is not None:",
            "        query_search = r.get(\"query\", None)",
            "        if query_search is None:",
            "            return HttpResponse(\"No search '?query' included\")",
            "        query_search = query_search.replace(\"+\", \" \")",
            "        advanced = toBoolean(r.get(\"advanced\"))",
            "        # If this is an advanced search use 'advanced_search' for query",
            "        if advanced:",
            "            query_search = r.get(\"advanced_search\")",
            "        template = \"webclient/search/search_details.html\"",
            "",
            "        onlyTypes = r.getlist(\"datatype\")",
            "        fields = r.getlist(\"field\")",
            "        searchGroup = r.get(\"searchGroup\", None)",
            "        ownedBy = r.get(\"ownedBy\", None)",
            "",
            "        useAcquisitionDate = toBoolean(r.get(\"useAcquisitionDate\"))",
            "        startdate = r.get(\"startdateinput\", None)",
            "        startdate = startdate is not None and smart_str(startdate) or None",
            "        enddate = r.get(\"enddateinput\", None)",
            "        enddate = enddate is not None and smart_str(enddate) or None",
            "        date = None",
            "        if startdate is not None:",
            "            if enddate is None:",
            "                n = datetime.datetime.now()",
            "                enddate = \"%s-%02d-%02d\" % (n.year, n.month, n.day)",
            "            date = \"%s_%s\" % (startdate, enddate)",
            "",
            "        # by default, if user has not specified any types:",
            "        if len(onlyTypes) == 0:",
            "            onlyTypes = [\"images\"]",
            "",
            "        # search is carried out and results are stored in",
            "        # manager.containers.images etc.",
            "        manager.search(",
            "            query_search,",
            "            onlyTypes,",
            "            fields,",
            "            searchGroup,",
            "            ownedBy,",
            "            useAcquisitionDate,",
            "            date,",
            "            rawQuery=advanced,",
            "        )",
            "",
            "        # if the query is only numbers (separated by commas or spaces)",
            "        # we search for objects by ID",
            "        isIds = re.compile(r\"^[\\d ,]+$\")",
            "        if isIds.search(query_search) is not None:",
            "            conn.SERVICE_OPTS.setOmeroGroup(-1)",
            "            idSet = set()",
            "            for queryId in re.split(\" |,\", query_search):",
            "                if len(queryId) == 0:",
            "                    continue",
            "                try:",
            "                    searchById = long(queryId)",
            "                    if searchById in idSet:",
            "                        continue",
            "                    idSet.add(searchById)",
            "                    for t in onlyTypes:",
            "                        t = t[0:-1]  # remove 's'",
            "                        if t in (",
            "                            \"project\",",
            "                            \"dataset\",",
            "                            \"image\",",
            "                            \"screen\",",
            "                            \"plate\",",
            "                            \"well\",",
            "                        ):",
            "                            obj = conn.getObject(t, searchById)",
            "                            if obj is not None:",
            "                                foundById.append({\"otype\": t, \"obj\": obj})",
            "                except ValueError:",
            "                    pass",
            "",
            "    else:",
            "        # simply display the search home page.",
            "        template = \"webclient/search/search.html\"",
            "",
            "    context = {",
            "        \"manager\": manager,",
            "        \"foundById\": foundById,",
            "        \"resultCount\": manager.c_size + len(foundById),",
            "    }",
            "    context[\"template\"] = template",
            "    context[\"thumbnails_batch\"] = settings.THUMBNAILS_BATCH",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_details(request, c_type, c_id, conn=None, share_id=None, **kwargs):",
            "    \"\"\"",
            "    This page is the right-hand panel 'general metadata', first tab only.",
            "    Shown for Projects, Datasets, Images, Screens, Plates, Wells, Tags etc.",
            "    The data and annotations are loaded by the manager. Display of appropriate",
            "    data is handled by the template.",
            "    \"\"\"",
            "",
            "    # the index of a field within a well",
            "    index = getIntOrDefault(request, \"index\", 0)",
            "",
            "    context = dict()",
            "",
            "    # we only expect a single object, but forms can take multiple objects",
            "    images = c_type == \"image\" and list(conn.getObjects(\"Image\", [c_id])) or list()",
            "    datasets = (",
            "        c_type == \"dataset\" and list(conn.getObjects(\"Dataset\", [c_id])) or list()",
            "    )",
            "    projects = (",
            "        c_type == \"project\" and list(conn.getObjects(\"Project\", [c_id])) or list()",
            "    )",
            "    screens = c_type == \"screen\" and list(conn.getObjects(\"Screen\", [c_id])) or list()",
            "    plates = c_type == \"plate\" and list(conn.getObjects(\"Plate\", [c_id])) or list()",
            "    acquisitions = (",
            "        c_type == \"acquisition\"",
            "        and list(conn.getObjects(\"PlateAcquisition\", [c_id]))",
            "        or list()",
            "    )",
            "    shares = (",
            "        (c_type == \"share\" or c_type == \"discussion\")",
            "        and [conn.getShare(c_id)]",
            "        or list()",
            "    )",
            "    wells = c_type == \"well\" and list(conn.getObjects(\"Well\", [c_id])) or list()",
            "",
            "    # we simply set up the annotation form, passing the objects to be",
            "    # annotated.",
            "    selected = {",
            "        \"images\": c_type == \"image\" and [c_id] or [],",
            "        \"datasets\": c_type == \"dataset\" and [c_id] or [],",
            "        \"projects\": c_type == \"project\" and [c_id] or [],",
            "        \"screens\": c_type == \"screen\" and [c_id] or [],",
            "        \"plates\": c_type == \"plate\" and [c_id] or [],",
            "        \"acquisitions\": c_type == \"acquisition\" and [c_id] or [],",
            "        \"wells\": c_type == \"well\" and [c_id] or [],",
            "        \"shares\": ((c_type == \"share\" or c_type == \"discussion\") and [c_id] or []),",
            "    }",
            "",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": images,",
            "        \"datasets\": datasets,",
            "        \"projects\": projects,",
            "        \"screens\": screens,",
            "        \"plates\": plates,",
            "        \"acquisitions\": acquisitions,",
            "        \"wells\": wells,",
            "        \"shares\": shares,",
            "    }",
            "",
            "    form_comment = None",
            "    figScripts = None",
            "    if c_type in (\"share\", \"discussion\"):",
            "        template = \"webclient/annotations/annotations_share.html\"",
            "        manager = BaseShare(conn, c_id)",
            "        manager.getAllUsers(c_id)",
            "        manager.getComments(c_id)",
            "        form_comment = CommentAnnotationForm(initial=initial)",
            "    else:",
            "        try:",
            "            manager = BaseContainer(conn, **{str(c_type): long(c_id), \"index\": index})",
            "        except AttributeError as x:",
            "            return handlerInternalError(request, x)",
            "        if share_id is not None:",
            "            template = \"webclient/annotations/annotations_share.html\"",
            "            context[\"share\"] = BaseShare(conn, share_id)",
            "        else:",
            "            template = \"webclient/annotations/metadata_general.html\"",
            "            context[\"canExportAsJpg\"] = manager.canExportAsJpg(request)",
            "            context[\"annotationCounts\"] = manager.getAnnotationCounts()",
            "            figScripts = manager.listFigureScripts()",
            "    context[\"manager\"] = manager",
            "",
            "    if c_type in (\"tag\", \"tagset\"):",
            "        context[\"insight_ns\"] = omero.rtypes.rstring(",
            "            omero.constants.metadata.NSINSIGHTTAGSET",
            "        ).val",
            "    if form_comment is not None:",
            "        context[\"form_comment\"] = form_comment",
            "",
            "    context[\"figScripts\"] = figScripts",
            "    context[\"template\"] = template",
            "    context[\"webclient_path\"] = reverse(\"webindex\")",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_preview(request, c_type, c_id, conn=None, share_id=None, **kwargs):",
            "    \"\"\"",
            "    This is the image 'Preview' tab for the right-hand panel.",
            "    \"\"\"",
            "    context = {}",
            "",
            "    # the index of a field within a well",
            "    index = getIntOrDefault(request, \"index\", 0)",
            "",
            "    manager = BaseContainer(conn, **{str(c_type): long(c_id)})",
            "    if share_id:",
            "        context[\"share\"] = BaseShare(conn, share_id)",
            "    if c_type == \"well\":",
            "        manager.image = manager.well.getImage(index)",
            "",
            "    allRdefs = manager.image.getAllRenderingDefs()",
            "    rdefs = {}",
            "    rdefId = manager.image.getRenderingDefId()",
            "    # remove duplicates per user",
            "    for r in allRdefs:",
            "        ownerId = r[\"owner\"][\"id\"]",
            "        r[\"current\"] = r[\"id\"] == rdefId",
            "        # if duplicate rdefs for user, pick one with highest ID",
            "        if ownerId not in rdefs or rdefs[ownerId][\"id\"] < r[\"id\"]:",
            "            rdefs[ownerId] = r",
            "    rdefs = rdefs.values()",
            "    # format into rdef strings,",
            "    # E.g. {c: '1|3118:35825$FF0000,2|2086:18975$FFFF00', m: 'c'}",
            "    rdefQueries = []",
            "    for r in rdefs:",
            "        chs = []",
            "        for i, c in enumerate(r[\"c\"]):",
            "            act = \"-\"",
            "            if c[\"active\"]:",
            "                act = \"\"",
            "            color = c[\"lut\"] if \"lut\" in c else c[\"color\"]",
            "            reverse = \"r\" if c[\"inverted\"] else \"-r\"",
            "            chs.append(",
            "                \"%s%s|%s:%s%s$%s\" % (act, i + 1, c[\"start\"], c[\"end\"], reverse, color)",
            "            )",
            "        rdefQueries.append(",
            "            {",
            "                \"id\": r[\"id\"],",
            "                \"owner\": r[\"owner\"],",
            "                \"c\": \",\".join(chs),",
            "                \"m\": r[\"model\"] == \"greyscale\" and \"g\" or \"c\",",
            "            }",
            "        )",
            "    max_w, max_h = conn.getMaxPlaneSize()",
            "    size_x = manager.image.getSizeX()",
            "    size_y = manager.image.getSizeY()",
            "",
            "    context[\"tiledImage\"] = (size_x * size_y) > (max_w * max_h)",
            "    context[\"manager\"] = manager",
            "    context[\"rdefsJson\"] = json.dumps(rdefQueries)",
            "    context[\"rdefs\"] = rdefs",
            "    context[\"template\"] = \"webclient/annotations/metadata_preview.html\"",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_hierarchy(request, c_type, c_id, conn=None, **kwargs):",
            "    \"\"\"",
            "    This loads the ancestors of the specified object and displays them in a",
            "    static tree.",
            "    Used by an AJAX call from the metadata_general panel.",
            "    \"\"\"",
            "    manager = BaseContainer(conn, **{str(c_type): long(c_id)})",
            "",
            "    context = {\"manager\": manager}",
            "    context[\"template\"] = \"webclient/annotations/metadata_hierarchy.html\"",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_metadata_acquisition(",
            "    request, c_type, c_id, conn=None, share_id=None, **kwargs",
            "):",
            "    \"\"\"",
            "    The acquisition tab of the right-hand panel. Only loaded for images.",
            "    TODO: urls regex should make sure that c_type is only 'image' OR 'well'",
            "    \"\"\"",
            "    try:",
            "        if c_type in (\"share\", \"discussion\"):",
            "            template = \"webclient/annotations/annotations_share.html\"",
            "            manager = BaseShare(conn, c_id)",
            "            manager.getAllUsers(c_id)",
            "            manager.getComments(c_id)",
            "        else:",
            "            template = \"webclient/annotations/metadata_acquisition.html\"",
            "            manager = BaseContainer(conn, **{str(c_type): long(c_id)})",
            "    except AttributeError as x:",
            "        return handlerInternalError(request, x)",
            "",
            "    form_environment = None",
            "    form_objective = None",
            "    form_microscope = None",
            "    form_instrument_objectives = list()",
            "    form_stageLabel = None",
            "    form_filters = list()",
            "    form_dichroics = list()",
            "    form_detectors = list()",
            "    form_channels = list()",
            "    form_lasers = list()",
            "",
            "    lasertypes = list(conn.getEnumerationEntries(\"LaserType\"))",
            "    arctypes = list(conn.getEnumerationEntries(\"ArcType\"))",
            "    filamenttypes = list(conn.getEnumerationEntries(\"FilamentType\"))",
            "",
            "    # various enums we need for the forms (don't load unless needed)",
            "    mediums = None",
            "    immersions = None",
            "    corrections = None",
            "",
            "    if c_type == \"image\":",
            "        if share_id is None:",
            "            manager.companionFiles()",
            "        manager.channelMetadata()",
            "        for theC, ch in enumerate(manager.channel_metadata):",
            "            logicalChannel = ch.getLogicalChannel()",
            "            if logicalChannel is not None:",
            "                channel = dict()",
            "                channel[\"form\"] = MetadataChannelForm(",
            "                    initial={",
            "                        \"logicalChannel\": logicalChannel,",
            "                        \"exWave\": ch.getExcitationWave(units=True),",
            "                        \"emWave\": ch.getEmissionWave(units=True),",
            "                        \"illuminations\": list(",
            "                            conn.getEnumerationEntries(\"IlluminationI\")",
            "                        ),",
            "                        \"contrastMethods\": list(",
            "                            conn.getEnumerationEntries(\"ContrastMethodI\")",
            "                        ),",
            "                        \"modes\": list(conn.getEnumerationEntries(\"AcquisitionModeI\")),",
            "                    }",
            "                )",
            "                # 9853 Much metadata is not available to 'shares'",
            "                if share_id is None:",
            "                    lightPath = logicalChannel.getLightPath()",
            "                    if lightPath is not None:",
            "                        channel[\"form_dichroic\"] = None",
            "                        channel[\"form_excitation_filters\"] = list()",
            "                        channel[\"form_emission_filters\"] = list()",
            "                        lightPathDichroic = lightPath.getDichroic()",
            "                        if lightPathDichroic is not None:",
            "                            channel[\"form_dichroic\"] = MetadataDichroicForm(",
            "                                initial={\"dichroic\": lightPathDichroic}",
            "                            )",
            "                        filterTypes = list(conn.getEnumerationEntries(\"FilterTypeI\"))",
            "                        for f in lightPath.getEmissionFilters():",
            "                            channel[\"form_emission_filters\"].append(",
            "                                MetadataFilterForm(",
            "                                    initial={\"filter\": f, \"types\": filterTypes}",
            "                                )",
            "                            )",
            "                        for f in lightPath.getExcitationFilters():",
            "                            channel[\"form_excitation_filters\"].append(",
            "                                MetadataFilterForm(",
            "                                    initial={\"filter\": f, \"types\": filterTypes}",
            "                                )",
            "                            )",
            "",
            "                    detectorSettings = logicalChannel.getDetectorSettings()",
            "                    if (",
            "                        detectorSettings._obj is not None",
            "                        and detectorSettings.getDetector()",
            "                    ):",
            "                        channel[\"form_detector_settings\"] = MetadataDetectorForm(",
            "                            initial={",
            "                                \"detectorSettings\": detectorSettings,",
            "                                \"detector\": detectorSettings.getDetector(),",
            "                                \"types\": list(",
            "                                    conn.getEnumerationEntries(\"DetectorTypeI\")",
            "                                ),",
            "                                \"binnings\": list(conn.getEnumerationEntries(\"Binning\")),",
            "                            }",
            "                        )",
            "",
            "                    lightSourceSettings = logicalChannel.getLightSourceSettings()",
            "                    if (",
            "                        lightSourceSettings is not None",
            "                        and lightSourceSettings._obj is not None",
            "                    ):",
            "                        lightSrc = lightSourceSettings.getLightSource()",
            "                        if lightSrc is not None:",
            "                            lstypes = lasertypes",
            "                            if lightSrc.OMERO_CLASS == \"Arc\":",
            "                                lstypes = arctypes",
            "                            elif lightSrc.OMERO_CLASS == \"Filament\":",
            "                                lstypes = filamenttypes",
            "                            channel[\"form_light_source\"] = MetadataLightSourceForm(",
            "                                initial={",
            "                                    \"lightSource\": lightSrc,",
            "                                    \"lightSourceSettings\": lightSourceSettings,",
            "                                    \"lstypes\": lstypes,",
            "                                    \"mediums\": list(",
            "                                        conn.getEnumerationEntries(\"LaserMediumI\")",
            "                                    ),",
            "                                    \"pulses\": list(",
            "                                        conn.getEnumerationEntries(\"PulseI\")",
            "                                    ),",
            "                                }",
            "                            )",
            "                # TODO: We don't display filter sets here yet since they are",
            "                # not populated on Import by BioFormats.",
            "                channel[\"label\"] = ch.getLabel()",
            "                color = ch.getColor()",
            "                channel[\"color\"] = color is not None and color.getHtml() or None",
            "                planeInfo = (",
            "                    manager.image",
            "                    and manager.image.getPrimaryPixels().copyPlaneInfo(",
            "                        theC=theC, theZ=0",
            "                    )",
            "                )",
            "                plane_info = []",
            "",
            "                for pi in planeInfo:",
            "                    deltaT = pi.getDeltaT(units=\"SECOND\")",
            "                    exposure = pi.getExposureTime(units=\"SECOND\")",
            "                    if deltaT is None and exposure is None:",
            "                        continue",
            "                    if deltaT is not None:",
            "                        deltaT = deltaT.getValue()",
            "                    if exposure is not None:",
            "                        exposure = exposure.getValue()",
            "                    plane_info.append(",
            "                        {\"theT\": pi.theT, \"deltaT\": deltaT, \"exposureTime\": exposure}",
            "                    )",
            "                channel[\"plane_info\"] = plane_info",
            "",
            "                form_channels.append(channel)",
            "",
            "        try:",
            "            image = manager.well.getWellSample().image()",
            "        except Exception:",
            "            image = manager.image",
            "",
            "        if share_id is None:  # 9853",
            "            if image.getObjectiveSettings() is not None:",
            "                # load the enums if needed and create our Objective Form",
            "                if mediums is None:",
            "                    mediums = list(conn.getEnumerationEntries(\"MediumI\"))",
            "                if immersions is None:",
            "                    immersions = list(conn.getEnumerationEntries(\"ImmersionI\"))",
            "                if corrections is None:",
            "                    corrections = list(conn.getEnumerationEntries(\"CorrectionI\"))",
            "                form_objective = MetadataObjectiveSettingsForm(",
            "                    initial={",
            "                        \"objectiveSettings\": image.getObjectiveSettings(),",
            "                        \"objective\": image.getObjectiveSettings().getObjective(),",
            "                        \"mediums\": mediums,",
            "                        \"immersions\": immersions,",
            "                        \"corrections\": corrections,",
            "                    }",
            "                )",
            "            if image.getImagingEnvironment() is not None:",
            "                form_environment = MetadataEnvironmentForm(initial={\"image\": image})",
            "            if image.getStageLabel() is not None:",
            "                form_stageLabel = MetadataStageLabelForm(initial={\"image\": image})",
            "",
            "            instrument = image.getInstrument()",
            "            if instrument is not None:",
            "                if instrument.getMicroscope() is not None:",
            "                    form_microscope = MetadataMicroscopeForm(",
            "                        initial={",
            "                            \"microscopeTypes\": list(",
            "                                conn.getEnumerationEntries(\"MicroscopeTypeI\")",
            "                            ),",
            "                            \"microscope\": instrument.getMicroscope(),",
            "                        }",
            "                    )",
            "",
            "                objectives = instrument.getObjectives()",
            "                for o in objectives:",
            "                    # load the enums if needed and create our Objective Form",
            "                    if mediums is None:",
            "                        mediums = list(conn.getEnumerationEntries(\"MediumI\"))",
            "                    if immersions is None:",
            "                        immersions = list(conn.getEnumerationEntries(\"ImmersionI\"))",
            "                    if corrections is None:",
            "                        corrections = list(conn.getEnumerationEntries(\"CorrectionI\"))",
            "                    obj_form = MetadataObjectiveForm(",
            "                        initial={",
            "                            \"objective\": o,",
            "                            \"mediums\": mediums,",
            "                            \"immersions\": immersions,",
            "                            \"corrections\": corrections,",
            "                        }",
            "                    )",
            "                    form_instrument_objectives.append(obj_form)",
            "                filters = list(instrument.getFilters())",
            "                if len(filters) > 0:",
            "                    for f in filters:",
            "                        form_filter = MetadataFilterForm(",
            "                            initial={",
            "                                \"filter\": f,",
            "                                \"types\": list(",
            "                                    conn.getEnumerationEntries(\"FilterTypeI\")",
            "                                ),",
            "                            }",
            "                        )",
            "                        form_filters.append(form_filter)",
            "",
            "                dichroics = list(instrument.getDichroics())",
            "                for d in dichroics:",
            "                    form_dichroic = MetadataDichroicForm(initial={\"dichroic\": d})",
            "                    form_dichroics.append(form_dichroic)",
            "",
            "                detectors = list(instrument.getDetectors())",
            "                if len(detectors) > 0:",
            "                    for d in detectors:",
            "                        form_detector = MetadataDetectorForm(",
            "                            initial={",
            "                                \"detectorSettings\": None,",
            "                                \"detector\": d,",
            "                                \"types\": list(",
            "                                    conn.getEnumerationEntries(\"DetectorTypeI\")",
            "                                ),",
            "                            }",
            "                        )",
            "                        form_detectors.append(form_detector)",
            "",
            "                lasers = list(instrument.getLightSources())",
            "                if len(lasers) > 0:",
            "                    for laser in lasers:",
            "                        lstypes = lasertypes",
            "                        if laser.OMERO_CLASS == \"Arc\":",
            "                            lstypes = arctypes",
            "                        elif laser.OMERO_CLASS == \"Filament\":",
            "                            lstypes = filamenttypes",
            "                        form_laser = MetadataLightSourceForm(",
            "                            initial={",
            "                                \"lightSource\": laser,",
            "                                \"lstypes\": lstypes,",
            "                                \"mediums\": list(",
            "                                    conn.getEnumerationEntries(\"LaserMediumI\")",
            "                                ),",
            "                                \"pulses\": list(conn.getEnumerationEntries(\"PulseI\")),",
            "                            }",
            "                        )",
            "                        form_lasers.append(form_laser)",
            "",
            "    # TODO: remove this 'if' since we should only have c_type = 'image'?",
            "    context = {\"manager\": manager, \"share_id\": share_id}",
            "    if c_type not in (\"share\", \"discussion\", \"tag\"):",
            "        context[\"form_channels\"] = form_channels",
            "        context[\"form_environment\"] = form_environment",
            "        context[\"form_objective\"] = form_objective",
            "        context[\"form_microscope\"] = form_microscope",
            "        context[\"form_instrument_objectives\"] = form_instrument_objectives",
            "        context[\"form_filters\"] = form_filters",
            "        context[\"form_dichroics\"] = form_dichroics",
            "        context[\"form_detectors\"] = form_detectors",
            "        context[\"form_lasers\"] = form_lasers",
            "        context[\"form_stageLabel\"] = form_stageLabel",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def load_original_metadata(request, imageId, conn=None, share_id=None, **kwargs):",
            "",
            "    image = conn.getObject(\"Image\", imageId)",
            "    if image is None:",
            "        raise Http404(\"No Image found with ID %s\" % imageId)",
            "",
            "    context = {",
            "        \"template\": \"webclient/annotations/original_metadata.html\",",
            "        \"imageId\": image.getId(),",
            "    }",
            "    try:",
            "        om = image.loadOriginalMetadata()",
            "        if om is not None:",
            "            context[\"original_metadata\"] = om[0]",
            "            context[\"global_metadata\"] = om[1]",
            "            context[\"series_metadata\"] = om[2]",
            "    except omero.LockTimeout:",
            "        # 408 is Request Timeout",
            "        return HttpResponse(content=\"LockTimeout\", status=408)",
            "    return context",
            "",
            "",
            "###########################################################################",
            "# ACTIONS",
            "",
            "# Annotation in the right-hand panel is handled the same way for single",
            "# objects (metadata_general.html)",
            "# AND for batch annotation (batch_annotate.html) by 4 forms:",
            "# Comment (this is loaded in the initial page)",
            "# Tags (the empty form is in the initial page but fields are loaded via AJAX)",
            "# Local File (this is loaded in the initial page)",
            "# Existing File (the empty form is in the initial page but field is loaded via",
            "# AJAX)",
            "#",
            "# In each case, the form itself contains hidden fields to specify the",
            "# object(s) being annotated",
            "# All forms inherit from a single form that has these fields.",
            "",
            "",
            "def getObjects(request, conn=None):",
            "    \"\"\"",
            "    Prepare objects for use in the annotation forms.",
            "    These objects are required by the form superclass to populate hidden",
            "    fields, so we know what we're annotating on submission",
            "    \"\"\"",
            "    r = request.GET or request.POST",
            "    images = (",
            "        len(r.getlist(\"image\")) > 0",
            "        and list(conn.getObjects(\"Image\", r.getlist(\"image\")))",
            "        or list()",
            "    )",
            "    datasets = (",
            "        len(r.getlist(\"dataset\")) > 0",
            "        and list(conn.getObjects(\"Dataset\", r.getlist(\"dataset\")))",
            "        or list()",
            "    )",
            "    projects = (",
            "        len(r.getlist(\"project\")) > 0",
            "        and list(conn.getObjects(\"Project\", r.getlist(\"project\")))",
            "        or list()",
            "    )",
            "    screens = (",
            "        len(r.getlist(\"screen\")) > 0",
            "        and list(conn.getObjects(\"Screen\", r.getlist(\"screen\")))",
            "        or list()",
            "    )",
            "    plates = (",
            "        len(r.getlist(\"plate\")) > 0",
            "        and list(conn.getObjects(\"Plate\", r.getlist(\"plate\")))",
            "        or list()",
            "    )",
            "    acquisitions = (",
            "        len(r.getlist(\"acquisition\")) > 0",
            "        and list(conn.getObjects(\"PlateAcquisition\", r.getlist(\"acquisition\")))",
            "        or list()",
            "    )",
            "    shares = (",
            "        len(r.getlist(\"share\")) > 0 and [conn.getShare(r.getlist(\"share\")[0])] or list()",
            "    )",
            "    wells = (",
            "        len(r.getlist(\"well\")) > 0",
            "        and list(conn.getObjects(\"Well\", r.getlist(\"well\")))",
            "        or list()",
            "    )",
            "    return {",
            "        \"image\": images,",
            "        \"dataset\": datasets,",
            "        \"project\": projects,",
            "        \"screen\": screens,",
            "        \"plate\": plates,",
            "        \"acquisition\": acquisitions,",
            "        \"well\": wells,",
            "        \"share\": shares,",
            "    }",
            "",
            "",
            "def getIds(request):",
            "    \"\"\"",
            "    Used by forms to indicate the currently selected objects prepared above",
            "    \"\"\"",
            "    r = request.GET or request.POST",
            "    selected = {",
            "        \"images\": r.getlist(\"image\"),",
            "        \"datasets\": r.getlist(\"dataset\"),",
            "        \"projects\": r.getlist(\"project\"),",
            "        \"screens\": r.getlist(\"screen\"),",
            "        \"plates\": r.getlist(\"plate\"),",
            "        \"acquisitions\": r.getlist(\"acquisition\"),",
            "        \"wells\": r.getlist(\"well\"),",
            "        \"shares\": r.getlist(\"share\"),",
            "    }",
            "    return selected",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def batch_annotate(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This page gives a form for batch annotation.",
            "    Local File form and Comment form are loaded. Other forms are loaded via",
            "    AJAX",
            "    \"\"\"",
            "",
            "    objs = getObjects(request, conn)",
            "",
            "    # get groups for selected objects - setGroup() and create links",
            "    obj_ids = []",
            "    obj_labels = []",
            "    groupIds = set()",
            "    annotationBlocked = False",
            "    for key in objs:",
            "        obj_ids += [\"%s=%s\" % (key, o.id) for o in objs[key]]",
            "        for o in objs[key]:",
            "            groupIds.add(o.getDetails().group.id.val)",
            "            if not o.canAnnotate():",
            "                annotationBlocked = (",
            "                    \"Can't add annotations because you don't\" \" have permissions\"",
            "                )",
            "            obj_labels.append({\"type\": key.title(), \"id\": o.id, \"name\": o.getName()})",
            "    obj_string = \"&\".join(obj_ids)",
            "    link_string = \"|\".join(obj_ids).replace(\"=\", \"-\")",
            "    if len(groupIds) == 0:",
            "        # No supported objects found.",
            "        # If multiple tags / tagsets selected, return placeholder",
            "        if (",
            "            len(request.GET.getlist(\"tag\")) > 0",
            "            or len(request.GET.getlist(\"tagset\")) > 0",
            "        ):",
            "            return HttpResponse(\"<h2>Can't batch annotate tags</h2>\")",
            "        else:",
            "            return handlerInternalError(request, \"No objects found\")",
            "    groupId = list(groupIds)[0]",
            "    conn.SERVICE_OPTS.setOmeroGroup(groupId)",
            "",
            "    manager = BaseContainer(conn)",
            "    figScripts = manager.listFigureScripts(objs)",
            "    canExportAsJpg = manager.canExportAsJpg(request, objs)",
            "    filesetInfo = None",
            "    iids = []",
            "    if \"image\" in objs and len(objs[\"image\"]) > 0:",
            "        iids = [i.getId() for i in objs[\"image\"]]",
            "    if len(iids) > 0:",
            "        filesetInfo = conn.getFilesetFilesInfo(iids)",
            "        archivedInfo = conn.getArchivedFilesInfo(iids)",
            "        filesetInfo[\"count\"] += archivedInfo[\"count\"]",
            "        filesetInfo[\"size\"] += archivedInfo[\"size\"]",
            "",
            "    context = {",
            "        \"iids\": iids,",
            "        \"obj_string\": obj_string,",
            "        \"link_string\": link_string,",
            "        \"obj_labels\": obj_labels,",
            "        \"batch_ann\": True,",
            "        \"figScripts\": figScripts,",
            "        \"canExportAsJpg\": canExportAsJpg,",
            "        \"filesetInfo\": filesetInfo,",
            "        \"annotationBlocked\": annotationBlocked,",
            "        \"differentGroups\": False,",
            "    }",
            "    if len(groupIds) > 1:",
            "        context[\"annotationBlocked\"] = (",
            "            \"Can't add annotations because\" \" objects are in different groups\"",
            "        )",
            "        context[\"differentGroups\"] = True  # E.g. don't run scripts etc",
            "    context[\"canDownload\"] = manager.canDownload(objs)",
            "    context[\"template\"] = \"webclient/annotations/batch_annotate.html\"",
            "    context[\"webclient_path\"] = reverse(\"webindex\")",
            "    context[\"annotationCounts\"] = manager.getBatchAnnotationCounts(",
            "        getObjects(request, conn)",
            "    )",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_file(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    On 'POST', This handles attaching an existing file-annotation(s) and/or",
            "    upload of a new file to one or more objects",
            "    Otherwise it generates the form for choosing file-annotations & local",
            "    files.",
            "    \"\"\"",
            "    oids = getObjects(request, conn)",
            "    selected = getIds(request)",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": oids[\"image\"],",
            "        \"datasets\": oids[\"dataset\"],",
            "        \"projects\": oids[\"project\"],",
            "        \"screens\": oids[\"screen\"],",
            "        \"plates\": oids[\"plate\"],",
            "        \"acquisitions\": oids[\"acquisition\"],",
            "        \"wells\": oids[\"well\"],",
            "    }",
            "",
            "    # Use the first object we find to set context (assume all objects are in",
            "    # same group!)",
            "    for obs in oids.values():",
            "        if len(obs) > 0:",
            "            conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "            break",
            "",
            "    obj_count = sum([len(selected[types]) for types in selected])",
            "    if obj_count == 0:",
            "        raise Http404(\"Need to specify objects via e.g. ?image=1\")",
            "",
            "    # Get appropriate manager, either to list available Files to add to single",
            "    # object, or list ALL Files (multiple objects)",
            "    manager = None",
            "    if obj_count == 1:",
            "        for t in selected:",
            "            if len(selected[t]) > 0:",
            "                o_type = t[:-1]  # \"images\" -> \"image\"",
            "                o_id = selected[t][0]",
            "                break",
            "        if o_type in (",
            "            \"dataset\",",
            "            \"project\",",
            "            \"image\",",
            "            \"screen\",",
            "            \"plate\",",
            "            \"acquisition\",",
            "            \"well\",",
            "            \"comment\",",
            "            \"file\",",
            "            \"tag\",",
            "            \"tagset\",",
            "        ):",
            "            if o_type == \"tagset\":",
            "                # TODO: this should be handled by the BaseContainer",
            "                o_type = \"tag\"",
            "            kw = {}",
            "            if o_type is not None and int(o_id) > 0:",
            "                kw[str(o_type)] = int(o_id)",
            "            try:",
            "                manager = BaseContainer(conn, **kw)",
            "            except AttributeError as x:",
            "                return handlerInternalError(request, x)",
            "",
            "    if manager is not None:",
            "        files = manager.getFilesByObject()",
            "    else:",
            "        manager = BaseContainer(conn)",
            "        for dtype, objs in oids.items():",
            "            if len(objs) > 0:",
            "                # NB: we only support a single data-type now. E.g. 'image' OR",
            "                # 'dataset' etc.",
            "                files = manager.getFilesByObject(",
            "                    parent_type=dtype, parent_ids=[o.getId() for o in objs]",
            "                )",
            "                break",
            "",
            "    initial[\"files\"] = files",
            "",
            "    if request.method == \"POST\":",
            "        # handle form submission",
            "        form_file = FilesAnnotationForm(initial=initial, data=request.POST.copy())",
            "        if form_file.is_valid():",
            "            # Link existing files...",
            "            files = form_file.cleaned_data[\"files\"]",
            "            added_files = []",
            "            if files is not None and len(files) > 0:",
            "                added_files = manager.createAnnotationsLinks(\"file\", files, oids)",
            "            # upload new file",
            "            fileupload = (",
            "                \"annotation_file\" in request.FILES",
            "                and request.FILES[\"annotation_file\"]",
            "                or None",
            "            )",
            "            if fileupload is not None and fileupload != \"\":",
            "                newFileId = manager.createFileAnnotations(fileupload, oids)",
            "                added_files.append(newFileId)",
            "            return JsonResponse({\"fileIds\": added_files})",
            "        else:",
            "            return HttpResponse(form_file.errors)",
            "",
            "    else:",
            "        form_file = FilesAnnotationForm(initial=initial)",
            "        context = {\"form_file\": form_file}",
            "        template = \"webclient/annotations/files_form.html\"",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_rating(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Handle adding Rating to one or more objects",
            "    \"\"\"",
            "    if request.method != \"POST\":",
            "        raise Http404(\"Only POST supported\")",
            "    rating = getIntOrDefault(request, \"rating\", 0)",
            "    oids = getObjects(request, conn)",
            "",
            "    # add / update rating",
            "    for otype, objs in oids.items():",
            "        for o in objs:",
            "            o.setRating(rating)",
            "",
            "    # return a summary of ratings",
            "    return JsonResponse({\"success\": True})",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_comment(request, conn=None, **kwargs):",
            "    \"\"\"Handle adding Comments to one or more objects",
            "    Unbound instance of Comment form not available.",
            "    If the form has been submitted, a bound instance of the form",
            "    is created using request.POST\"\"\"",
            "",
            "    if request.method != \"POST\":",
            "        raise Http404(\"Unbound instance of form not available.\")",
            "",
            "    oids = getObjects(request, conn)",
            "    selected = getIds(request)",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": oids[\"image\"],",
            "        \"datasets\": oids[\"dataset\"],",
            "        \"projects\": oids[\"project\"],",
            "        \"screens\": oids[\"screen\"],",
            "        \"plates\": oids[\"plate\"],",
            "        \"acquisitions\": oids[\"acquisition\"],",
            "        \"wells\": oids[\"well\"],",
            "        \"shares\": oids[\"share\"],",
            "    }",
            "",
            "    # Use the first object we find to set context (assume all objects are in",
            "    # same group!) this does not aplly to share",
            "    if len(oids[\"share\"]) < 1:",
            "        for obs in oids.values():",
            "            if len(obs) > 0:",
            "                conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "                break",
            "",
            "    # Handle form submission...",
            "    form_multi = CommentAnnotationForm(initial=initial, data=request.POST.copy())",
            "    if form_multi.is_valid():",
            "        # In each case below, we pass the {'object_type': [ids]} map",
            "        content = form_multi.cleaned_data[\"comment\"]",
            "        if content is not None and content != \"\":",
            "            if oids[\"share\"] is not None and len(oids[\"share\"]) > 0:",
            "                sid = oids[\"share\"][0].id",
            "                manager = BaseShare(conn, sid)",
            "                host = \"%s?server=%i\" % (",
            "                    request.build_absolute_uri(",
            "                        reverse(\"load_template\", args=[\"public\"])",
            "                    ),",
            "                    int(conn.server_id),",
            "                )",
            "                textAnn = manager.addComment(host, content)",
            "                # For shares we need to return html for display...",
            "                context = {",
            "                    \"tann\": textAnn,",
            "                    \"added_by\": conn.getUserId(),",
            "                    \"template\": \"webclient/annotations/comment.html\",",
            "                }",
            "            else:",
            "                # ...otherwise Comments are re-loaded by AJAX json",
            "                # so we don't *need* to return anything",
            "                manager = BaseContainer(conn)",
            "                annId = manager.createCommentAnnotations(content, oids)",
            "                context = {\"annId\": annId, \"added_by\": conn.getUserId()}",
            "            return context",
            "    else:",
            "        # TODO: handle invalid form error",
            "        return HttpResponse(str(form_multi.errors))",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_map(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Handle adding Map Annotations to one or more objects",
            "    POST data \"mapAnnotation\" should be list of ['key':'value'] pairs.",
            "    \"\"\"",
            "",
            "    if request.method != \"POST\":",
            "        raise Http404(",
            "            \"Need to POST map annotation data as list of\" \" ['key', 'value'] pairs\"",
            "        )",
            "",
            "    oids = getObjects(request, conn)",
            "",
            "    # Use the first object we find to set context (assume all objects are in",
            "    # same group!)",
            "    # this does not aplly to share",
            "    if len(oids[\"share\"]) < 1:",
            "        for obs in oids.values():",
            "            if len(obs) > 0:",
            "                conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "                break",
            "",
            "    data = request.POST.get(\"mapAnnotation\")",
            "    data = json.loads(data)",
            "",
            "    annIds = request.POST.getlist(\"annId\")",
            "    ns = request.POST.get(\"ns\", omero.constants.metadata.NSCLIENTMAPANNOTATION)",
            "",
            "    # Create a new annotation",
            "    if len(annIds) == 0 and len(data) > 0:",
            "        duplicate = request.POST.get(\"duplicate\", \"false\")",
            "        duplicate.lower() == \"true\"",
            "        # For 'client' map annotations, we enforce 1 annotation per object",
            "        if ns == omero.constants.metadata.NSCLIENTMAPANNOTATION:",
            "            duplicate = True",
            "        if duplicate:",
            "            # Create a new Map Annotation for each object:",
            "            for k, objs in oids.items():",
            "                for obj in objs:",
            "                    ann = omero.gateway.MapAnnotationWrapper(conn)",
            "                    ann.setValue(data)",
            "                    ann.setNs(ns)",
            "                    ann.save()",
            "                    annIds.append(ann.getId())",
            "                    obj.linkAnnotation(ann)",
            "        else:",
            "            # Create single Map Annotation and link to all objects",
            "            ann = omero.gateway.MapAnnotationWrapper(conn)",
            "            ann.setValue(data)",
            "            ann.setNs(ns)",
            "            ann.save()",
            "            annIds.append(ann.getId())",
            "            for k, objs in oids.items():",
            "                for obj in objs:",
            "                    obj.linkAnnotation(ann)",
            "    # Or update existing annotations",
            "    else:",
            "        for annId in annIds:",
            "            ann = conn.getObject(\"MapAnnotation\", annId)",
            "            if ann is None:",
            "                continue",
            "            if len(data) > 0:",
            "                ann.setValue(data)",
            "                ann.save()",
            "            else:",
            "                # Delete if no data",
            "                handle = conn.deleteObjects(\"/Annotation\", [annId])",
            "                try:",
            "                    conn._waitOnCmd(handle)",
            "                finally:",
            "                    handle.close()",
            "        if len(data) == 0:",
            "            annIds = None",
            "",
            "    return {\"annId\": annIds}",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def marshal_tagging_form_data(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Provides json data to ome.tagging_form.js",
            "    \"\"\"",
            "",
            "    group = get_long_or_default(request, \"group\", -1)",
            "    conn.SERVICE_OPTS.setOmeroGroup(str(group))",
            "    try:",
            "        offset = int(request.GET.get(\"offset\"))",
            "        limit = int(request.GET.get(\"limit\", 1000))",
            "    except Exception:",
            "        offset = limit = None",
            "",
            "    jsonmode = request.GET.get(\"jsonmode\")",
            "    if jsonmode == \"tagcount\":",
            "        tag_count = conn.getTagCount()",
            "        return dict(tag_count=tag_count)",
            "",
            "    manager = BaseContainer(conn)",
            "    manager.loadTagsRecursive(eid=-1, offset=offset, limit=limit)",
            "    all_tags = manager.tags_recursive",
            "    all_tags_owners = manager.tags_recursive_owners",
            "",
            "    if jsonmode == \"tags\":",
            "        # send tag information without descriptions",
            "        r = list((i, t, o, s) for i, d, t, o, s in all_tags)",
            "        return r",
            "",
            "    elif jsonmode == \"desc\":",
            "        # send descriptions for tags",
            "        return dict((i, d) for i, d, t, o, s in all_tags)",
            "",
            "    elif jsonmode == \"owners\":",
            "        # send owner information",
            "        return all_tags_owners",
            "",
            "    return HttpResponse()",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def annotate_tags(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This handles creation AND submission of Tags form, adding new AND/OR",
            "    existing tags to one or more objects",
            "    \"\"\"",
            "",
            "    oids = getObjects(request, conn)",
            "    selected = getIds(request)",
            "    obj_count = sum([len(selected[types]) for types in selected])",
            "",
            "    # Get appropriate manager, either to list available Tags to add to single",
            "    # object, or list ALL Tags (multiple objects)",
            "    manager = None",
            "    self_id = conn.getEventContext().userId",
            "",
            "    tags = []",
            "",
            "    # Use the first object we find to set context (assume all objects are",
            "    # in same group!)",
            "    for obs in oids.values():",
            "        if len(obs) > 0:",
            "            conn.SERVICE_OPTS.setOmeroGroup(obs[0].getDetails().group.id.val)",
            "            break",
            "",
            "    # Make a list of all current tags",
            "    # As would be on right column of tagging dialog...",
            "    taglist, users = tree.marshal_annotations(",
            "        conn,",
            "        project_ids=selected[\"projects\"],",
            "        dataset_ids=selected[\"datasets\"],",
            "        image_ids=selected[\"images\"],",
            "        screen_ids=selected[\"screens\"],",
            "        plate_ids=selected[\"plates\"],",
            "        run_ids=selected[\"acquisitions\"],",
            "        well_ids=selected[\"wells\"],",
            "        ann_type=\"tag\",",
            "        # If we reach this limit we'll get some tags not removed",
            "        limit=ANNOTATIONS_LIMIT,",
            "    )",
            "",
            "    userMap = {}",
            "    for exp in users:",
            "        userMap[exp[\"id\"]] = exp",
            "",
            "    # For batch annotate, only include tags that user has added to all objects",
            "    if obj_count > 1:",
            "        # count my links",
            "        myLinkCount = {}",
            "        for t in taglist:",
            "            tid = t[\"id\"]",
            "            if tid not in myLinkCount:",
            "                myLinkCount[tid] = 0",
            "            if t[\"link\"][\"owner\"][\"id\"] == self_id:",
            "                myLinkCount[tid] += 1",
            "        # filter",
            "        taglist = [t for t in taglist if myLinkCount[t[\"id\"]] == obj_count]",
            "",
            "    selected_tags = []",
            "    for tag in taglist:",
            "        linkOwnerId = tag[\"link\"][\"owner\"][\"id\"]",
            "        owner = userMap[linkOwnerId]",
            "        ownerName = \"%s %s\" % (owner[\"firstName\"], owner[\"lastName\"])",
            "        canDelete = True",
            "        created = tag[\"link\"][\"date\"]",
            "        linkOwned = linkOwnerId == self_id",
            "        selected_tags.append(",
            "            (tag[\"id\"], self_id, ownerName, canDelete, created, linkOwned)",
            "        )",
            "",
            "    # selected_tags is really a list of tag LINKS.",
            "    # May be several links per tag.id",
            "    selected_tags.sort(key=lambda x: x[0])",
            "",
            "    initial = {",
            "        \"selected\": selected,",
            "        \"images\": oids[\"image\"],",
            "        \"datasets\": oids[\"dataset\"],",
            "        \"projects\": oids[\"project\"],",
            "        \"screens\": oids[\"screen\"],",
            "        \"plates\": oids[\"plate\"],",
            "        \"acquisitions\": oids[\"acquisition\"],",
            "        \"wells\": oids[\"well\"],",
            "    }",
            "",
            "    if request.method == \"POST\":",
            "        # handle form submission",
            "        form_tags = TagsAnnotationForm(initial=initial, data=request.POST.copy())",
            "        newtags_formset = NewTagsAnnotationFormSet(",
            "            prefix=\"newtags\", data=request.POST.copy()",
            "        )",
            "        # Create new tags or Link existing tags...",
            "        if form_tags.is_valid() and newtags_formset.is_valid():",
            "            # filter down previously selected tags to the ones linked by",
            "            # current user",
            "            selected_tag_ids = [stag[0] for stag in selected_tags if stag[5]]",
            "            # Remove duplicates from tag IDs",
            "            selected_tag_ids = list(set(selected_tag_ids))",
            "            post_tags = list(form_tags.cleaned_data[\"tags\"])",
            "            tags = [tag for tag in post_tags if tag not in selected_tag_ids]",
            "            removed = [tag for tag in selected_tag_ids if tag not in post_tags]",
            "            manager = BaseContainer(conn)",
            "            if tags:",
            "                manager.createAnnotationsLinks(\"tag\", tags, oids)",
            "            new_tags = []",
            "            for form in newtags_formset.forms:",
            "                new_tags.append(",
            "                    manager.createTagAnnotations(",
            "                        form.cleaned_data[\"tag\"],",
            "                        form.cleaned_data[\"description\"],",
            "                        oids,",
            "                        tag_group_id=form.cleaned_data[\"tagset\"],",
            "                    )",
            "                )",
            "            # only remove Tags where the link is owned by self_id",
            "            for remove in removed:",
            "                tag_manager = BaseContainer(conn, tag=remove)",
            "                tag_manager.remove(",
            "                    [",
            "                        \"%s-%s\" % (dtype, obj.id)",
            "                        for dtype, objs in oids.items()",
            "                        for obj in objs",
            "                    ],",
            "                    tag_owner_id=self_id,",
            "                )",
            "            return JsonResponse({\"added\": tags, \"removed\": removed, \"new\": new_tags})",
            "        else:",
            "            # TODO: handle invalid form error",
            "            return HttpResponse(str(form_tags.errors))",
            "",
            "    else:",
            "        form_tags = TagsAnnotationForm(initial=initial)",
            "        newtags_formset = NewTagsAnnotationFormSet(prefix=\"newtags\")",
            "        context = {",
            "            \"form_tags\": form_tags,",
            "            \"newtags_formset\": newtags_formset,",
            "            \"selected_tags\": selected_tags,",
            "        }",
            "        template = \"webclient/annotations/tags_form.html\"",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "@render_response()",
            "def edit_channel_names(request, imageId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Edit and save channel names",
            "    \"\"\"",
            "    image = conn.getObject(\"Image\", imageId)",
            "    sizeC = image.getSizeC()",
            "    channelNames = {}",
            "    nameDict = {}",
            "    for i in range(sizeC):",
            "        cname = request.POST.get(\"channel%d\" % i, None)",
            "        if cname is not None:",
            "            cname = smart_str(cname)[:255]  # Truncate to fit in DB",
            "            channelNames[\"channel%d\" % i] = cname",
            "            nameDict[i + 1] = cname",
            "    # If the 'Apply to Dataset' button was used to submit...",
            "    if request.POST.get(\"confirm_apply\", None) is not None:",
            "        # plate-123 OR dataset-234",
            "        parentId = request.POST.get(\"parentId\", None)",
            "        if parentId is not None:",
            "            ptype = parentId.split(\"-\")[0].title()",
            "            pid = long(parentId.split(\"-\")[1])",
            "            counts = conn.setChannelNames(ptype, [pid], nameDict, channelCount=sizeC)",
            "    else:",
            "        counts = conn.setChannelNames(\"Image\", [image.getId()], nameDict)",
            "    rv = {\"channelNames\": channelNames}",
            "    if counts:",
            "        rv[\"imageCount\"] = counts[\"imageCount\"]",
            "        rv[\"updateCount\"] = counts[\"updateCount\"]",
            "        return rv",
            "    else:",
            "        return {\"error\": \"No parent found to apply Channel Names\"}",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "@render_response()",
            "def manage_action_containers(",
            "    request, action, o_type=None, o_id=None, conn=None, **kwargs",
            "):",
            "    \"\"\"",
            "    Handles many different actions on various objects.",
            "",
            "    @param action:      \"addnewcontainer\", (creates a new Project, Dataset,",
            "                        Screen), \"editname\", \"savename\", \"editdescription\",",
            "                        \"savedescription\",  (used as GET and POST for in-line",
            "                        editing),",
            "                        \"removefromshare\", (tree P/D/I moving etc)",
            "                        \"delete\", \"deletemany\"      (delete objects)",
            "                        \"remove\" (remove tag/comment from object)",
            "    @param o_type:      \"dataset\", \"project\", \"image\", \"screen\", \"plate\",",
            "                        \"acquisition\", \"well\",\"comment\", \"file\", \"tag\",",
            "                        \"tagset\",\"share\", \"sharecomment\"",
            "    \"\"\"",
            "    template = None",
            "",
            "    manager = None",
            "    if o_type in (",
            "        \"dataset\",",
            "        \"project\",",
            "        \"image\",",
            "        \"screen\",",
            "        \"plate\",",
            "        \"acquisition\",",
            "        \"well\",",
            "        \"comment\",",
            "        \"file\",",
            "        \"tag\",",
            "        \"tagset\",",
            "    ):",
            "        kw = {}",
            "        if o_type is not None and int(o_id) > 0:",
            "            o_id = int(o_id)",
            "            kw[str(o_type)] = o_id",
            "        try:",
            "            manager = BaseContainer(conn, **kw)",
            "        except AttributeError as x:",
            "            return handlerInternalError(request, x)",
            "    elif o_type in (\"share\", \"sharecomment\", \"chat\"):",
            "        manager = BaseShare(conn, o_id)",
            "    else:",
            "        manager = BaseContainer(conn)",
            "",
            "    form = None",
            "    if action == \"addnewcontainer\":",
            "        # Used within the jsTree to add a new Project, Dataset, Tag,",
            "        # Tagset etc under a specified parent OR top-level",
            "        if not request.method == \"POST\":",
            "            return JsonResponse(",
            "                {\"Error\": \"Must use POST to create container\"}, status=405",
            "            )",
            "",
            "        form = ContainerForm(data=request.POST.copy())",
            "        if form.is_valid():",
            "            logger.debug(\"Create new in %s: %s\" % (o_type, str(form.cleaned_data)))",
            "            name = form.cleaned_data[\"name\"]",
            "            description = form.cleaned_data[\"description\"]",
            "            owner = form.cleaned_data[\"owner\"]",
            "",
            "            if o_type == \"project\" and hasattr(manager, o_type) and o_id > 0:",
            "                oid = manager.createDataset(name, description, owner=owner)",
            "            elif o_type == \"tagset\" and o_id > 0:",
            "                oid = manager.createTag(name, description, owner=owner)",
            "            elif request.POST.get(\"folder_type\") in (",
            "                \"project\",",
            "                \"screen\",",
            "                \"dataset\",",
            "                \"tag\",",
            "                \"tagset\",",
            "            ):",
            "                # No parent specified. We can create orphaned 'project',",
            "                # 'dataset' etc.",
            "                folder_type = request.POST.get(\"folder_type\")",
            "                if folder_type == \"dataset\":",
            "                    oid = manager.createDataset(",
            "                        name,",
            "                        description,",
            "                        owner=owner,",
            "                        img_ids=request.POST.getlist(\"image\", None),",
            "                    )",
            "                else:",
            "                    oid = conn.createContainer(",
            "                        folder_type, name, description, owner=owner",
            "                    )",
            "            else:",
            "                return HttpResponseServerError(\"Object does not exist\")",
            "            rdict = {\"bad\": \"false\", \"id\": oid}",
            "            return JsonResponse(rdict)",
            "        else:",
            "            d = dict()",
            "            for e in form.errors.items():",
            "                d.update({e[0]: unicode(e[1])})",
            "            rdict = {\"bad\": \"true\", \"errs\": d}",
            "            return JsonResponse(rdict)",
            "",
            "    elif action == \"edit\":",
            "        # form for editing Shares only",
            "        if o_id is None:",
            "            raise Http404(\"No share ID\")",
            "        if o_type == \"share\" and int(o_id) > 0:",
            "            template = \"webclient/public/share_form.html\"",
            "            manager.getMembers(o_id)",
            "            manager.getComments(o_id)",
            "            experimenters = list(conn.getExperimenters())",
            "            experimenters.sort(key=lambda x: x.getOmeName().lower())",
            "            initial = {",
            "                \"message\": manager.share.message,",
            "                \"expiration\": \"\",",
            "                \"shareMembers\": manager.membersInShare,",
            "                \"enable\": manager.share.active,",
            "                \"experimenters\": experimenters,",
            "            }",
            "            if manager.share.getExpireDate() is not None:",
            "                initial[\"expiration\"] = manager.share.getExpireDate().strftime(",
            "                    \"%Y-%m-%d\"",
            "                )",
            "            form = ShareForm(initial=initial)  # 'guests':share.guestsInShare,",
            "            context = {\"manager\": manager, \"form\": form}",
            "    elif action == \"save\":",
            "        # Handles submission of the 'edit' form above. TODO: not used now?",
            "        if not request.method == \"POST\":",
            "            return HttpResponseRedirect(",
            "                reverse(\"manage_action_containers\", args=[\"edit\", o_type, o_id])",
            "            )",
            "        if o_type == \"share\":",
            "            experimenters = list(conn.getExperimenters())",
            "            experimenters.sort(key=lambda x: x.getOmeName().lower())",
            "            form = ShareForm(",
            "                initial={\"experimenters\": experimenters}, data=request.POST.copy()",
            "            )",
            "            if form.is_valid():",
            "                logger.debug(\"Update share: %s\" % (str(form.cleaned_data)))",
            "                message = form.cleaned_data[\"message\"]",
            "                expiration = form.cleaned_data[\"expiration\"]",
            "                members = form.cleaned_data[\"members\"]",
            "                # guests = request.POST['guests']",
            "                enable = form.cleaned_data[\"enable\"]",
            "                host = \"%s?server=%i\" % (",
            "                    request.build_absolute_uri(",
            "                        reverse(\"load_template\", args=[\"public\"])",
            "                    ),",
            "                    int(conn.server_id),",
            "                )",
            "                manager.updateShareOrDiscussion(",
            "                    host, message, members, enable, expiration",
            "                )",
            "                r = \"enable\" if enable else \"disable\"",
            "                return HttpResponse(r)",
            "            else:",
            "                template = \"webclient/public/share_form.html\"",
            "                context = {\"share\": manager, \"form\": form}",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"editname\":",
            "        # start editing 'name' in-line",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            obj = getattr(manager, o_type)",
            "            template = \"webclient/ajax_form/container_form_ajax.html\"",
            "            if o_type == \"tag\":",
            "                txtValue = obj.textValue",
            "            else:",
            "                txtValue = obj.getName()",
            "            form = ContainerNameForm(initial={\"name\": txtValue})",
            "            context = {\"manager\": manager, \"form\": form}",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"savename\":",
            "        # Save name edit in-line",
            "        if not request.method == \"POST\":",
            "            return HttpResponseRedirect(",
            "                reverse(\"manage_action_containers\", args=[\"edit\", o_type, o_id])",
            "            )",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            form = ContainerNameForm(data=request.POST.copy())",
            "            if form.is_valid():",
            "                logger.debug(\"Update name form:\" + str(form.cleaned_data))",
            "                name = form.cleaned_data[\"name\"]",
            "                rdict = {\"bad\": \"false\", \"o_type\": o_type}",
            "                manager.updateName(o_type, name)",
            "                return JsonResponse(rdict)",
            "            else:",
            "                d = dict()",
            "                for e in form.errors.items():",
            "                    d.update({e[0]: unicode(e[1])})",
            "                rdict = {\"bad\": \"true\", \"errs\": d}",
            "                return JsonResponse(rdict)",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"editdescription\":",
            "        # start editing description in-line",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            obj = getattr(manager, o_type)",
            "            template = \"webclient/ajax_form/container_form_ajax.html\"",
            "            form = ContainerDescriptionForm(initial={\"description\": obj.description})",
            "            context = {\"manager\": manager, \"form\": form}",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"savedescription\":",
            "        # Save editing of description in-line",
            "        if not request.method == \"POST\":",
            "            return HttpResponseServerError(",
            "                \"Action '%s' on the '%s' id:%s cannot be complited\"",
            "                % (action, o_type, o_id)",
            "            )",
            "        if hasattr(manager, o_type) and o_id > 0:",
            "            form = ContainerDescriptionForm(data=request.POST.copy())",
            "            if form.is_valid():",
            "                logger.debug(\"Update name form:\" + str(form.cleaned_data))",
            "                description = form.cleaned_data[\"description\"]",
            "                manager.updateDescription(o_type, description)",
            "                rdict = {\"bad\": \"false\"}",
            "                return JsonResponse(rdict)",
            "            else:",
            "                d = dict()",
            "                for e in form.errors.items():",
            "                    d.update({e[0]: unicode(e[1])})",
            "                rdict = {\"bad\": \"true\", \"errs\": d}",
            "                return JsonResponse(rdict)",
            "        else:",
            "            return HttpResponseServerError(\"Object does not exist\")",
            "    elif action == \"remove\":",
            "        # Handles removal of comment, tag from",
            "        # Object etc.",
            "        # E.g. image-123  or image-1|image-2",
            "        parents = request.POST[\"parent\"]",
            "        try:",
            "            manager.remove(parents.split(\"|\"))",
            "        except Exception as x:",
            "            logger.error(traceback.format_exc())",
            "            rdict = {\"bad\": \"true\", \"errs\": str(x)}",
            "            return JsonResponse(rdict)",
            "",
            "        rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    elif action == \"removefromshare\":",
            "        image_id = request.POST.get(\"source\")",
            "        try:",
            "            manager.removeImage(image_id)",
            "        except Exception as x:",
            "            logger.error(traceback.format_exc())",
            "            rdict = {\"bad\": \"true\", \"errs\": str(x)}",
            "            return JsonResponse(rdict)",
            "        rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    elif action == \"delete\":",
            "        # Handles delete of a file attached to object.",
            "        child = toBoolean(request.POST.get(\"child\"))",
            "        anns = toBoolean(request.POST.get(\"anns\"))",
            "        try:",
            "            handle = manager.deleteItem(child, anns)",
            "            request.session[\"callback\"][str(handle)] = {",
            "                \"job_type\": \"delete\",",
            "                \"delmany\": False,",
            "                \"did\": o_id,",
            "                \"dtype\": o_type,",
            "                \"status\": \"in progress\",",
            "                \"error\": 0,",
            "                \"dreport\": _formatReport(handle),",
            "                \"start_time\": datetime.datetime.now(),",
            "            }",
            "            request.session.modified = True",
            "        except Exception as x:",
            "            logger.error(",
            "                \"Failed to delete: %r\" % {\"did\": o_id, \"dtype\": o_type}, exc_info=True",
            "            )",
            "            rdict = {\"bad\": \"true\", \"errs\": str(x)}",
            "        else:",
            "            rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    elif action == \"deletemany\":",
            "        # Handles multi-delete from jsTree.",
            "        object_ids = {",
            "            \"Image\": request.POST.getlist(\"image\"),",
            "            \"Dataset\": request.POST.getlist(\"dataset\"),",
            "            \"Project\": request.POST.getlist(\"project\"),",
            "            \"Annotation\": request.POST.getlist(\"tag\"),",
            "            \"Screen\": request.POST.getlist(\"screen\"),",
            "            \"Plate\": request.POST.getlist(\"plate\"),",
            "            \"Well\": request.POST.getlist(\"well\"),",
            "            \"PlateAcquisition\": request.POST.getlist(\"acquisition\"),",
            "        }",
            "        child = toBoolean(request.POST.get(\"child\"))",
            "        anns = toBoolean(request.POST.get(\"anns\"))",
            "        logger.debug(",
            "            \"Delete many: child? %s anns? %s object_ids %s\" % (child, anns, object_ids)",
            "        )",
            "        try:",
            "            for key, ids in object_ids.items():",
            "                if ids is not None and len(ids) > 0:",
            "                    handle = manager.deleteObjects(key, ids, child, anns)",
            "                    if key == \"PlateAcquisition\":",
            "                        key = \"Plate Run\"  # for nicer user message",
            "                    dMap = {",
            "                        \"job_type\": \"delete\",",
            "                        \"start_time\": datetime.datetime.now(),",
            "                        \"status\": \"in progress\",",
            "                        \"error\": 0,",
            "                        \"dreport\": _formatReport(handle),",
            "                        \"dtype\": key,",
            "                    }",
            "                    if len(ids) > 1:",
            "                        dMap[\"delmany\"] = len(ids)",
            "                        dMap[\"did\"] = ids",
            "                    else:",
            "                        dMap[\"delmany\"] = False",
            "                        dMap[\"did\"] = ids[0]",
            "                    request.session[\"callback\"][str(handle)] = dMap",
            "            request.session.modified = True",
            "        except Exception:",
            "            logger.error(",
            "                \"Failed to delete: %r\" % {\"did\": ids, \"dtype\": key}, exc_info=True",
            "            )",
            "            # Ajax error handling will allow user to submit bug report",
            "            raise",
            "        else:",
            "            rdict = {\"bad\": \"false\"}",
            "        return JsonResponse(rdict)",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required(doConnectionCleanup=False)",
            "def get_original_file(request, fileId, download=False, conn=None, **kwargs):",
            "    \"\"\"",
            "    Returns the specified original file as an http response. Used for",
            "    displaying text or png/jpeg etc files in browser",
            "    \"\"\"",
            "",
            "    # May be viewing results of a script run in a different group.",
            "    conn.SERVICE_OPTS.setOmeroGroup(-1)",
            "",
            "    orig_file = conn.getObject(\"OriginalFile\", fileId)",
            "    if orig_file is None:",
            "        return handlerInternalError(",
            "            request, \"Original File does not exist (id:%s).\" % (fileId)",
            "        )",
            "",
            "    rsp = ConnCleaningHttpResponse(orig_file.getFileInChunks(buf=settings.CHUNK_SIZE))",
            "    rsp.conn = conn",
            "    mimetype = orig_file.mimetype",
            "    if mimetype == \"text/x-python\":",
            "        mimetype = \"text/plain\"  # allows display in browser",
            "    rsp[\"Content-Type\"] = mimetype",
            "    rsp[\"Content-Length\"] = orig_file.getSize()",
            "",
            "    if download:",
            "        downloadName = orig_file.name.replace(\" \", \"_\")",
            "        downloadName = downloadName.replace(\",\", \".\")",
            "        rsp[\"Content-Disposition\"] = \"attachment; filename=%s\" % downloadName",
            "    return rsp",
            "",
            "",
            "@login_required(doConnectionCleanup=False)",
            "@render_response()",
            "def omero_table(request, file_id, mtype=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Download OMERO.table as CSV (streaming response) or return as HTML or json",
            "",
            "    @param file_id:     OriginalFile ID",
            "    @param mtype:       None for html table or 'csv' or 'json'",
            "    @param conn:        BlitzGateway connection",
            "    \"\"\"",
            "",
            "    query = request.GET.get(\"query\", \"*\")",
            "    offset = get_long_or_default(request, \"offset\", 0)",
            "    limit = get_long_or_default(request, \"limit\", settings.PAGE)",
            "    iviewer_url = None",
            "    try:",
            "        iviewer_url = reverse(\"omero_iviewer_index\")",
            "    except NoReverseMatch:",
            "        pass",
            "",
            "    # Check if file exists since _table_query() doesn't check",
            "    file_id = long(file_id)",
            "    orig_file = conn.getObject(\"OriginalFile\", file_id)",
            "    if orig_file is None:",
            "        raise Http404(\"OriginalFile %s not found\" % file_id)",
            "",
            "    lazy = mtype == \"csv\"",
            "    context = webgateway_views._table_query(",
            "        request, file_id, conn=conn, query=query, offset=offset, limit=limit, lazy=lazy",
            "    )",
            "",
            "    if context.get(\"error\") or not context.get(\"data\"):",
            "        return JsonResponse(context)",
            "",
            "    # OR, return as csv or html",
            "    if mtype == \"csv\":",
            "        table_data = context.get(\"data\")",
            "",
            "        def csv_gen():",
            "            csv_cols = \",\".join(table_data.get(\"columns\"))",
            "            yield csv_cols",
            "            for rows in table_data.get(\"lazy_rows\"):",
            "                yield (",
            "                    \"\\n\" + \"\\n\".join([\",\".join([str(d) for d in row]) for row in rows])",
            "                )",
            "",
            "        downloadName = orig_file.name.replace(\" \", \"_\").replace(\",\", \".\")",
            "        downloadName = downloadName + \".csv\"",
            "",
            "        rsp = TableClosingHttpResponse(csv_gen(), content_type=\"text/csv\")",
            "        rsp.conn = conn",
            "        rsp.table = context.get(\"table\")",
            "        rsp[\"Content-Type\"] = \"application/force-download\"",
            "        # rsp['Content-Length'] = ann.getFileSize()",
            "        rsp[\"Content-Disposition\"] = \"attachment; filename=%s\" % downloadName",
            "        return rsp",
            "",
            "    context[\"data\"][\"name\"] = orig_file.name",
            "    context[\"data\"][\"path\"] = orig_file.path",
            "    context[\"data\"][\"id\"] = file_id",
            "    context[\"meta\"][\"query\"] = query",
            "",
            "    # check if offset matches an integer page number:",
            "    if offset == 0 or offset / limit == offset // limit:",
            "        context[\"meta\"][\"page\"] = (offset // limit) + 1 if offset > 0 else 1",
            "",
            "    # pagination links",
            "    url = reverse(\"omero_table\", args=[file_id])",
            "    context[\"meta\"][\"url\"] = url",
            "    url += \"?limit=%s\" % limit",
            "    if query != \"*\":",
            "        url += \"&query=%s\" % query",
            "    if (offset + limit) < context[\"meta\"][\"totalCount\"]:",
            "        context[\"meta\"][\"next\"] = url + \"&offset=%s\" % (offset + limit)",
            "    if offset > 0:",
            "        context[\"meta\"][\"prev\"] = url + \"&offset=%s\" % (max(0, offset - limit))",
            "",
            "    # by default, return context as JSON data",
            "    if mtype is None:",
            "        context[\"template\"] = \"webclient/annotations/omero_table.html\"",
            "        context[\"iviewer_url\"] = iviewer_url",
            "        col_types = context[\"data\"][\"column_types\"]",
            "        if \"ImageColumn\" in col_types:",
            "            context[\"image_column_index\"] = col_types.index(\"ImageColumn\")",
            "        if \"WellColumn\" in col_types:",
            "            context[\"well_column_index\"] = col_types.index(\"WellColumn\")",
            "        if \"RoiColumn\" in col_types:",
            "            context[\"roi_column_index\"] = col_types.index(\"RoiColumn\")",
            "        # provide example queries - pick first DoubleColumn...",
            "        for idx, c_type in enumerate(col_types):",
            "            if c_type in (\"DoubleColumn\", \"LongColumn\"):",
            "                col_name = context[\"data\"][\"columns\"][idx]",
            "                # find first few non-empty cells...",
            "                vals = []",
            "                for row in context[\"data\"][\"rows\"]:",
            "                    if row[idx]:",
            "                        vals.append(row[idx])",
            "                    if len(vals) > 3:",
            "                        break",
            "                if \" \" in col_name or len(vals) < 2:",
            "                    # Don't support queries on columns with spaces",
            "                    continue",
            "                context[\"example_column\"] = col_name",
            "                context[\"example_min_value\"] = min(vals)",
            "                context[\"example_max_value\"] = max(vals)",
            "                break",
            "",
            "    return context",
            "",
            "",
            "@login_required(doConnectionCleanup=False)",
            "def download_annotation(request, annId, conn=None, **kwargs):",
            "    \"\"\" Returns the file annotation as an http response for download \"\"\"",
            "    ann = conn.getObject(\"FileAnnotation\", annId)",
            "    if ann is None:",
            "        return handlerInternalError(",
            "            request, \"FileAnnotation does not exist (id:%s).\" % (annId)",
            "        )",
            "",
            "    rsp = ConnCleaningHttpResponse(ann.getFileInChunks(buf=settings.CHUNK_SIZE))",
            "    rsp.conn = conn",
            "    rsp[\"Content-Type\"] = \"application/force-download\"",
            "    rsp[\"Content-Length\"] = ann.getFileSize()",
            "    rsp[\"Content-Disposition\"] = \"attachment; filename=%s\" % (",
            "        ann.getFileName().replace(\" \", \"_\")",
            "    )",
            "    return rsp",
            "",
            "",
            "@login_required()",
            "def download_orig_metadata(request, imageId, conn=None, **kwargs):",
            "    \"\"\" Downloads the 'Original Metadata' as a text file \"\"\"",
            "",
            "    image = conn.getObject(\"Image\", imageId)",
            "    if image is None:",
            "        raise Http404(\"No Image found with ID %s\" % imageId)",
            "",
            "    om = image.loadOriginalMetadata()",
            "",
            "    txtLines = [\"[Global Metadata]\"]",
            "    txtLines.extend([\"%s=%s\" % (kv[0], kv[1]) for kv in om[1]])",
            "",
            "    txtLines.append(\"[Series Metadata]\")",
            "    txtLines.extend([\"%s=%s\" % (kv[0], kv[1]) for kv in om[2]])",
            "    rspText = \"\\n\".join(txtLines)",
            "",
            "    rsp = HttpResponse(rspText)",
            "    rsp[\"Content-Type\"] = \"application/force-download\"",
            "    rsp[\"Content-Length\"] = len(rspText)",
            "    rsp[\"Content-Disposition\"] = \"attachment; filename=Original_Metadata.txt\"",
            "    return rsp",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def download_placeholder(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Page displays a simple \"Preparing download...\" message and redirects to",
            "    the 'url'.",
            "    We construct the url and query string from request: 'url' and 'ids'.",
            "    \"\"\"",
            "",
            "    format = request.GET.get(\"format\", None)",
            "    if format is not None:",
            "        download_url = reverse(\"download_as\")",
            "        zipName = \"Export_as_%s\" % format",
            "    else:",
            "        download_url = reverse(\"archived_files\")",
            "        zipName = \"OriginalFileDownload\"",
            "    targetIds = request.GET.get(\"ids\")  # E.g. image-1|image-2",
            "    defaultName = request.GET.get(\"name\", zipName)  # default zip name",
            "    defaultName = os.path.basename(defaultName)  # remove path",
            "",
            "    if targetIds is None:",
            "        raise Http404(\"No IDs specified. E.g. ?ids=image-1|image-2\")",
            "",
            "    ids = targetIds.split(\"|\")",
            "",
            "    fileLists = []",
            "    fileCount = 0",
            "    filesTotalSize = 0",
            "    # If we're downloading originals, list original files so user can",
            "    # download individual files.",
            "    if format is None:",
            "        imgIds = []",
            "        wellIds = []",
            "        for i in ids:",
            "            if i.split(\"-\")[0] == \"image\":",
            "                imgIds.append(i.split(\"-\")[1])",
            "            elif i.split(\"-\")[0] == \"well\":",
            "                wellIds.append(i.split(\"-\")[1])",
            "",
            "        images = []",
            "        # Get images...",
            "        if imgIds:",
            "            images = list(conn.getObjects(\"Image\", imgIds))",
            "",
            "        if len(images) == 0:",
            "            raise Http404(\"No images found.\")",
            "",
            "        # Have a list of files per fileset (or per image without fileset)",
            "        fsIds = set()",
            "        fileIds = set()",
            "        for image in images:",
            "            fs = image.getFileset()",
            "            if fs is not None:",
            "                # Make sure we've not processed this fileset before.",
            "                if fs.id in fsIds:",
            "                    continue",
            "                fsIds.add(fs.id)",
            "            files = list(image.getImportedImageFiles())",
            "            fList = []",
            "            for f in files:",
            "                if f.id in fileIds:",
            "                    continue",
            "                fileIds.add(f.id)",
            "                fList.append({\"id\": f.id, \"name\": f.name, \"size\": f.getSize()})",
            "                filesTotalSize += f.getSize()",
            "            if len(fList) > 0:",
            "                fileLists.append(fList)",
            "        fileCount = sum([len(fList) for fList in fileLists])",
            "    else:",
            "        # E.g. JPEG/PNG - 1 file per image",
            "        fileCount = len(ids)",
            "",
            "    query = \"&\".join([_id.replace(\"-\", \"=\") for _id in ids])",
            "    download_url = download_url + \"?\" + query",
            "    if format is not None:",
            "        download_url = download_url + \"&format=%s\" % format",
            "",
            "    context = {",
            "        \"template\": \"webclient/annotations/download_placeholder.html\",",
            "        \"url\": download_url,",
            "        \"defaultName\": defaultName,",
            "        \"fileLists\": fileLists,",
            "        \"fileCount\": fileCount,",
            "        \"filesTotalSize\": filesTotalSize,",
            "    }",
            "    if filesTotalSize > settings.MAXIMUM_MULTIFILE_DOWNLOAD_ZIP_SIZE:",
            "        context[\"downloadTooLarge\"] = settings.MAXIMUM_MULTIFILE_DOWNLOAD_ZIP_SIZE",
            "    return context",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "@render_response()",
            "def load_calendar(request, year=None, month=None, conn=None, **kwargs):",
            "    \"\"\"",
            "    Loads the calendar which is displayed in the left panel of the history",
            "    page.",
            "    Shows current month by default. Filter by experimenter",
            "    \"\"\"",
            "",
            "    template = \"webclient/history/calendar.html\"",
            "    filter_user_id = request.session.get(\"user_id\")",
            "",
            "    if year is not None and month is not None:",
            "        controller = BaseCalendar(conn=conn, year=year, month=month, eid=filter_user_id)",
            "    else:",
            "        today = datetime.datetime.today()",
            "        controller = BaseCalendar(",
            "            conn=conn, year=today.year, month=today.month, eid=filter_user_id",
            "        )",
            "    controller.create_calendar()",
            "",
            "    context = {\"controller\": controller}",
            "",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "@render_response()",
            "def load_history(request, year, month, day, conn=None, **kwargs):",
            "    \"\"\" The data for a particular date that is loaded into the center panel \"\"\"",
            "",
            "    if year is None or month is None or day is None:",
            "        raise Http404(\"Year, month, and day are required\")",
            "",
            "    template = \"webclient/history/history_details.html\"",
            "",
            "    # get page",
            "    page = int(request.GET.get(\"page\", 1))",
            "",
            "    filter_user_id = request.session.get(\"user_id\")",
            "    controller = BaseCalendar(",
            "        conn=conn, year=year, month=month, day=day, eid=filter_user_id",
            "    )",
            "    controller.get_items(page)",
            "",
            "    context = {\"controller\": controller}",
            "    context[\"template\"] = template",
            "    return context",
            "",
            "",
            "def getObjectUrl(conn, obj):",
            "    \"\"\"",
            "    This provides a url to browse to the specified omero.model.ObjectI P/D/I,",
            "    S/P, FileAnnotation etc. used to display results from the scripting",
            "    service",
            "    E.g webclient/userdata/?path=image-12601",
            "    If the object is a file annotation, try to browse to the parent P/D/I",
            "    \"\"\"",
            "    base_url = reverse(viewname=\"load_template\", args=[\"userdata\"])",
            "",
            "    # if we have a File Annotation, then we want our URL to be for the parent",
            "    # object...",
            "    if isinstance(obj, omero.model.FileAnnotationI):",
            "        fa = conn.getObject(\"Annotation\", obj.id.val)",
            "        for ptype in [\"project\", \"dataset\", \"image\"]:",
            "            links = list(fa.getParentLinks(ptype))",
            "            if len(links) > 0:",
            "                obj = links[0].parent",
            "                break",
            "",
            "    if obj.__class__.__name__ in (",
            "        \"ImageI\",",
            "        \"DatasetI\",",
            "        \"ProjectI\",",
            "        \"ScreenI\",",
            "        \"PlateI\",",
            "        \"WellI\",",
            "    ):",
            "        otype = obj.__class__.__name__[:-1].lower()",
            "        base_url += \"?show=%s-%s\" % (otype, obj.id.val)",
            "        return base_url",
            "",
            "",
            "######################",
            "# Activities window & Progressbar",
            "def update_callback(request, cbString, **kwargs):",
            "    \"\"\"Update a callback handle with  key/value pairs\"\"\"",
            "    for key, value in kwargs.items():",
            "        request.session[\"callback\"][cbString][key] = value",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def activities(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    This refreshes callback handles (delete, scripts, chgrp etc) and provides",
            "    html to update Activities window & Progressbar.",
            "    The returned html contains details for ALL callbacks in web session,",
            "    regardless of their status.",
            "    We also add counts of jobs, failures and 'in progress' to update status",
            "    bar.",
            "    \"\"\"",
            "",
            "    in_progress = 0",
            "    failure = 0",
            "    new_results = []",
            "    _purgeCallback(request)",
            "",
            "    # If we have a jobId (not added to request.session) just process it...",
            "    # ONLY used for chgrp/chown dry-run.",
            "    jobId = request.GET.get(\"jobId\", None)",
            "    if jobId is not None:",
            "        jobId = str(jobId)",
            "        try:",
            "            prx = omero.cmd.HandlePrx.checkedCast(conn.c.ic.stringToProxy(jobId))",
            "            status = prx.getStatus()",
            "            logger.debug(\"job status: %s\", status)",
            "            rsp = prx.getResponse()",
            "            if rsp is not None:",
            "                rv = graphResponseMarshal(conn, rsp)",
            "                rv[\"finished\"] = True",
            "            else:",
            "                rv = {\"finished\": False}",
            "            rv[\"status\"] = {",
            "                \"currentStep\": status.currentStep,",
            "                \"steps\": status.steps,",
            "                \"startTime\": status.startTime,",
            "                \"stopTime\": status.stopTime,",
            "            }",
            "        except IceException:",
            "            rv = {\"finished\": True}",
            "        return rv",
            "",
            "    elif request.method == \"DELETE\":",
            "        try:",
            "            json_data = json.loads(request.body)",
            "        except TypeError:",
            "            # for Python 3.5",
            "            json_data = json.loads(bytes_to_native_str(request.body))",
            "        jobId = json_data.get(\"jobId\", None)",
            "        if jobId is not None:",
            "            jobId = str(jobId)",
            "            rv = {\"jobId\": jobId}",
            "            try:",
            "                prx = omero.cmd.HandlePrx.checkedCast(conn.c.ic.stringToProxy(jobId))",
            "                status = prx.getStatus()",
            "                logger.debug(\"pre-cancel() job status: %s\", status)",
            "                rv[\"status\"] = {",
            "                    \"currentStep\": status.currentStep,",
            "                    \"steps\": status.steps,",
            "                    \"startTime\": status.startTime,",
            "                    \"stopTime\": status.stopTime,",
            "                }",
            "                prx.cancel()",
            "            except omero.LockTimeout:",
            "                # expected that it will take > 5 seconds to cancel",
            "                logger.info(\"Timeout on prx.cancel()\")",
            "        return rv",
            "",
            "    # test each callback for failure, errors, completion, results etc",
            "    for cbString in request.session.get(\"callback\").keys():",
            "        callbackDict = request.session[\"callback\"][cbString]",
            "        job_type = callbackDict[\"job_type\"]",
            "",
            "        status = callbackDict[\"status\"]",
            "        if status == \"failed\":",
            "            failure += 1",
            "",
            "        request.session.modified = True",
            "",
            "        # update chgrp / chown",
            "        if job_type in (\"chgrp\", \"chown\"):",
            "            if status not in (\"failed\", \"finished\"):",
            "                rsp = None",
            "                try:",
            "                    prx = omero.cmd.HandlePrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                    rsp = prx.getResponse()",
            "                    close_handle = False",
            "                    try:",
            "                        # if response is None, then we're still in progress,",
            "                        # otherwise...",
            "                        if rsp is not None:",
            "                            close_handle = True",
            "                            new_results.append(cbString)",
            "                            if isinstance(rsp, omero.cmd.ERR):",
            "                                rsp_params = \", \".join(",
            "                                    [",
            "                                        \"%s: %s\" % (k, v)",
            "                                        for k, v in rsp.parameters.items()",
            "                                    ]",
            "                                )",
            "                                logger.error(",
            "                                    \"%s failed with: %s\" % (job_type, rsp_params)",
            "                                )",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    status=\"failed\",",
            "                                    report=\"%s %s\" % (rsp.name, rsp_params),",
            "                                    error=1,",
            "                                )",
            "                            elif isinstance(rsp, omero.cmd.OK):",
            "                                update_callback(request, cbString, status=\"finished\")",
            "                        else:",
            "                            in_progress += 1",
            "                    finally:",
            "                        prx.close(close_handle)",
            "                except Exception:",
            "                    logger.info(",
            "                        \"Activities %s handle not found: %s\" % (job_type, cbString)",
            "                    )",
            "                    continue",
            "        elif job_type == \"send_email\":",
            "            if status not in (\"failed\", \"finished\"):",
            "                rsp = None",
            "                try:",
            "                    prx = omero.cmd.HandlePrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                    callback = omero.callbacks.CmdCallbackI(",
            "                        conn.c, prx, foreground_poll=True",
            "                    )",
            "                    rsp = callback.getResponse()",
            "                    close_handle = False",
            "                    try:",
            "                        # if response is None, then we're still in progress,",
            "                        # otherwise...",
            "                        if rsp is not None:",
            "                            close_handle = True",
            "                            new_results.append(cbString)",
            "",
            "                            if isinstance(rsp, omero.cmd.ERR):",
            "                                rsp_params = \", \".join(",
            "                                    [",
            "                                        \"%s: %s\" % (k, v)",
            "                                        for k, v in rsp.parameters.items()",
            "                                    ]",
            "                                )",
            "                                logger.error(\"send_email failed with: %s\" % rsp_params)",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    status=\"failed\",",
            "                                    report={\"error\": rsp_params},",
            "                                    error=1,",
            "                                )",
            "                            else:",
            "                                total = (",
            "                                    rsp.success",
            "                                    + len(rsp.invalidusers)",
            "                                    + len(rsp.invalidemails)",
            "                                )",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    status=\"finished\",",
            "                                    rsp={\"success\": rsp.success, \"total\": total},",
            "                                )",
            "                                if (",
            "                                    len(rsp.invalidusers) > 0",
            "                                    or len(rsp.invalidemails) > 0",
            "                                ):",
            "                                    invalidusers = [",
            "                                        e.getFullName()",
            "                                        for e in list(",
            "                                            conn.getObjects(",
            "                                                \"Experimenter\", rsp.invalidusers",
            "                                            )",
            "                                        )",
            "                                    ]",
            "                                    update_callback(",
            "                                        request,",
            "                                        cbString,",
            "                                        report={",
            "                                            \"invalidusers\": invalidusers,",
            "                                            \"invalidemails\": rsp.invalidemails,",
            "                                        },",
            "                                    )",
            "                        else:",
            "                            in_progress += 1",
            "                    finally:",
            "                        callback.close(close_handle)",
            "                except Exception:",
            "                    logger.error(traceback.format_exc())",
            "                    logger.info(\"Activities send_email handle not found: %s\" % cbString)",
            "",
            "        # update delete",
            "        elif job_type == \"delete\":",
            "            if status not in (\"failed\", \"finished\"):",
            "                try:",
            "                    handle = omero.cmd.HandlePrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                    cb = omero.callbacks.CmdCallbackI(",
            "                        conn.c, handle, foreground_poll=True",
            "                    )",
            "                    rsp = cb.getResponse()",
            "                    close_handle = False",
            "                    try:",
            "                        if not rsp:  # Response not available",
            "                            update_callback(",
            "                                request,",
            "                                cbString,",
            "                                error=0,",
            "                                status=\"in progress\",",
            "                                dreport=_formatReport(handle),",
            "                            )",
            "                            in_progress += 1",
            "                        else:  # Response available",
            "                            close_handle = True",
            "                            new_results.append(cbString)",
            "                            rsp = cb.getResponse()",
            "                            err = isinstance(rsp, omero.cmd.ERR)",
            "                            if err:",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    error=1,",
            "                                    status=\"failed\",",
            "                                    dreport=_formatReport(handle),",
            "                                )",
            "                                failure += 1",
            "                            else:",
            "                                update_callback(",
            "                                    request,",
            "                                    cbString,",
            "                                    error=0,",
            "                                    status=\"finished\",",
            "                                    dreport=_formatReport(handle),",
            "                                )",
            "                    finally:",
            "                        cb.close(close_handle)",
            "                except Ice.ObjectNotExistException:",
            "                    update_callback(",
            "                        request, cbString, error=0, status=\"finished\", dreport=None",
            "                    )",
            "                except Exception as x:",
            "                    logger.error(traceback.format_exc())",
            "                    logger.error(\"Status job '%s'error:\" % cbString)",
            "                    update_callback(",
            "                        request, cbString, error=1, status=\"failed\", dreport=str(x)",
            "                    )",
            "                    failure += 1",
            "",
            "        # update scripts",
            "        elif job_type == \"script\":",
            "            # if error on runScript, the cbString is not a ProcessCallback...",
            "            if not cbString.startswith(\"ProcessCallback\"):",
            "                continue  # ignore",
            "            if status not in (\"failed\", \"finished\"):",
            "                logger.info(\"Check callback on script: %s\" % cbString)",
            "                try:",
            "                    proc = omero.grid.ScriptProcessPrx.checkedCast(",
            "                        conn.c.ic.stringToProxy(cbString)",
            "                    )",
            "                except IceException:",
            "                    update_callback(",
            "                        request,",
            "                        cbString,",
            "                        status=\"failed\",",
            "                        Message=\"No process found for job\",",
            "                        error=1,",
            "                    )",
            "                    continue",
            "                cb = omero.scripts.ProcessCallbackI(conn.c, proc)",
            "                # check if we get something back from the handle...",
            "                if cb.block(0):  # ms.",
            "                    cb.close()",
            "                    try:",
            "                        # we can only retrieve this ONCE - must save results",
            "                        results = proc.getResults(0, conn.SERVICE_OPTS)",
            "                        update_callback(request, cbString, status=\"finished\")",
            "                        new_results.append(cbString)",
            "                    except Exception:",
            "                        update_callback(",
            "                            request,",
            "                            cbString,",
            "                            status=\"finished\",",
            "                            Message=\"Failed to get results\",",
            "                        )",
            "                        logger.info(\"Failed on proc.getResults() for OMERO.script\")",
            "                        continue",
            "                    # value could be rstring, rlong, robject",
            "                    rMap = {}",
            "                    for key, value in results.items():",
            "                        v = value.getValue()",
            "                        if key in (\"stdout\", \"stderr\", \"Message\"):",
            "                            if key in (\"stderr\", \"stdout\"):",
            "                                # just save the id of original file",
            "                                v = v.id.val",
            "                            update_kwargs = {key: v}",
            "                            update_callback(request, cbString, **update_kwargs)",
            "                        else:",
            "                            if hasattr(v, \"id\"):",
            "                                # do we have an object (ImageI,",
            "                                # FileAnnotationI etc)",
            "                                obj_data = {",
            "                                    \"id\": v.id.val,",
            "                                    \"type\": v.__class__.__name__[:-1],",
            "                                }",
            "                                obj_data[\"browse_url\"] = getObjectUrl(conn, v)",
            "                                if v.isLoaded() and hasattr(v, \"file\"):",
            "                                    # try:",
            "                                    mimetypes = {",
            "                                        \"image/png\": \"png\",",
            "                                        \"image/jpeg\": \"jpeg\",",
            "                                        \"text/plain\": \"text\",",
            "                                    }",
            "                                    if v.file.mimetype.val in mimetypes:",
            "                                        obj_data[\"fileType\"] = mimetypes[",
            "                                            v.file.mimetype.val",
            "                                        ]",
            "                                        obj_data[\"fileId\"] = v.file.id.val",
            "                                    obj_data[\"name\"] = v.file.name.val",
            "                                    # except Exception:",
            "                                    #    pass",
            "                                if v.isLoaded() and hasattr(v, \"name\"):",
            "                                    # E.g Image, OriginalFile etc",
            "                                    name = unwrap(v.name)",
            "                                    if name is not None:",
            "                                        # E.g. FileAnnotation has null name",
            "                                        obj_data[\"name\"] = name",
            "                                rMap[key] = obj_data",
            "                            else:",
            "                                rMap[key] = unwrap(v)",
            "                    update_callback(request, cbString, results=rMap)",
            "                else:",
            "                    in_progress += 1",
            "",
            "    # having updated the request.session, we can now prepare the data for http",
            "    # response",
            "    rv = {}",
            "    for cbString in request.session.get(\"callback\").keys():",
            "        # make a copy of the map in session, so that we can replace non",
            "        # json-compatible objects, without modifying session",
            "        rv[cbString] = copy.copy(request.session[\"callback\"][cbString])",
            "",
            "    # return json (used for testing)",
            "    if \"template\" in kwargs and kwargs[\"template\"] == \"json\":",
            "        for cbString in request.session.get(\"callback\").keys():",
            "            rv[cbString][\"start_time\"] = str(",
            "                request.session[\"callback\"][cbString][\"start_time\"]",
            "            )",
            "        rv[\"inprogress\"] = in_progress",
            "        rv[\"failure\"] = failure",
            "        rv[\"jobs\"] = len(request.session[\"callback\"])",
            "        return JsonResponse(rv)  # json",
            "",
            "    jobs = []",
            "    new_errors = False",
            "    for key, data in rv.items():",
            "        # E.g. key: ProcessCallback/39f77932-c447-40d8-8f99-910b5a531a25 -t:tcp -h 10.211.55.2 -p 54727:tcp -h 10.37.129.2 -p 54727:tcp -h 10.12.2.21 -p 54727  # noqa",
            "        # create id we can use as html id,",
            "        # E.g. 39f77932-c447-40d8-8f99-910b5a531a25",
            "        if len(key.split(\" \")) > 0:",
            "            htmlId = key.split(\" \")[0]",
            "            if len(htmlId.split(\"/\")) > 1:",
            "                htmlId = htmlId.split(\"/\")[1]",
            "        rv[key][\"id\"] = htmlId",
            "        rv[key][\"key\"] = key",
            "        if key in new_results:",
            "            rv[key][\"new\"] = True",
            "            if \"error\" in data and data[\"error\"] > 0:",
            "                new_errors = True",
            "        jobs.append(rv[key])",
            "",
            "    jobs.sort(key=lambda x: x[\"start_time\"], reverse=True)",
            "    context = {",
            "        \"sizeOfJobs\": len(request.session[\"callback\"]),",
            "        \"jobs\": jobs,",
            "        \"inprogress\": in_progress,",
            "        \"new_results\": len(new_results),",
            "        \"new_errors\": new_errors,",
            "        \"failure\": failure,",
            "    }",
            "",
            "    context[\"template\"] = \"webclient/activities/activitiesContent.html\"",
            "    return context",
            "",
            "",
            "@login_required()",
            "def activities_update(request, action, **kwargs):",
            "    \"\"\"",
            "    If the above 'action' == 'clean' then we clear jobs from",
            "    request.session['callback'] either a single job (if 'jobKey' is specified",
            "    in POST) or all jobs (apart from those in progress)",
            "    \"\"\"",
            "",
            "    request.session.modified = True",
            "",
            "    if action == \"clean\":",
            "        if \"jobKey\" in request.POST:",
            "            jobId = request.POST.get(\"jobKey\")",
            "            rv = {}",
            "            if jobId in request.session[\"callback\"]:",
            "                del request.session[\"callback\"][jobId]",
            "                request.session.modified = True",
            "                rv[\"removed\"] = True",
            "            else:",
            "                rv[\"removed\"] = False",
            "            return JsonResponse(rv)",
            "        else:",
            "            jobs = list(request.session[\"callback\"].items())",
            "            for key, data in jobs:",
            "                if data[\"status\"] != \"in progress\":",
            "                    del request.session[\"callback\"][key]",
            "    return HttpResponse(\"OK\")",
            "",
            "",
            "##############################################################################",
            "# User Photo",
            "",
            "",
            "@login_required()",
            "def avatar(request, oid=None, conn=None, **kwargs):",
            "    \"\"\" Returns the experimenter's photo \"\"\"",
            "    photo = conn.getExperimenterPhoto(oid)",
            "    return HttpResponse(photo, content_type=\"image/jpeg\")",
            "",
            "",
            "##############################################################################",
            "# webgateway extention",
            "",
            "",
            "@login_required()",
            "def image_viewer(request, iid, share_id=None, **kwargs):",
            "    \"\"\" Delegates to webgateway, using share connection if appropriate \"\"\"",
            "    kwargs[\"viewport_server\"] = (",
            "        share_id is not None and reverse(\"webindex\") + share_id or reverse(\"webindex\")",
            "    )",
            "    # remove any trailing slash",
            "    kwargs[\"viewport_server\"] = kwargs[\"viewport_server\"].rstrip(\"/\")",
            "    return webgateway_views.full_viewer(request, iid, **kwargs)",
            "",
            "",
            "##############################################################################",
            "# scripting service....",
            "@login_required()",
            "@render_response()",
            "def list_scripts(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    List the available scripts - Just officical scripts for now",
            "",
            "    If all scripts are under a single top-level directory, this is",
            "    removed by default. To prevent this, use ?full_path=true",
            "    \"\"\"",
            "    scriptService = conn.getScriptService()",
            "    scripts = scriptService.getScripts()",
            "",
            "    # group scripts into 'folders' (path), named by parent folder name",
            "    scriptMenu = {}",
            "    scripts_to_ignore = (",
            "        request.session.get(\"server_settings\", {})",
            "        .get(\"scripts_to_ignore\", \"\")",
            "        .split(\",\")",
            "    )",
            "    for s in scripts:",
            "        scriptId = s.id.val",
            "        path = s.path.val",
            "        name = s.name.val",
            "        fullpath = os.path.join(path, name)",
            "        if fullpath in scripts_to_ignore:",
            "            logger.info(\"Ignoring script %r\" % fullpath)",
            "            continue",
            "",
            "        # We want to build a hierarchical <ul> <li> structure",
            "        # Each <ul> is a {}, each <li> is either a script 'name': <id> or",
            "        # directory 'name': {ul}",
            "",
            "        ul = scriptMenu",
            "        dirs = fullpath.split(os.path.sep)",
            "        for li, d in enumerate(dirs):",
            "            if len(d) == 0:",
            "                continue",
            "            if d not in ul:",
            "                # if last component in path:",
            "                if li + 1 == len(dirs):",
            "                    ul[d] = scriptId",
            "                else:",
            "                    ul[d] = {}",
            "            ul = ul[d]",
            "",
            "    # convert <ul> maps into lists and sort",
            "",
            "    def ul_to_list(ul):",
            "        dir_list = []",
            "        for name, value in ul.items():",
            "            if isinstance(value, dict):",
            "                # value is a directory",
            "                dir_list.append({\"name\": name, \"ul\": ul_to_list(value)})",
            "            else:",
            "                dir_list.append({\"name\": name, \"id\": value})",
            "        dir_list.sort(key=lambda x: x[\"name\"].lower())",
            "        return dir_list",
            "",
            "    scriptList = ul_to_list(scriptMenu)",
            "",
            "    # If we have a single top-level directory, we can skip it",
            "    if not request.GET.get(\"full_path\") and len(scriptList) == 1:",
            "        scriptList = scriptList[0][\"ul\"]",
            "",
            "    return scriptList",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def script_ui(request, scriptId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Generates an html form for the parameters of a defined script.",
            "    \"\"\"",
            "    scriptService = conn.getScriptService()",
            "",
            "    try:",
            "        params = scriptService.getParams(long(scriptId))",
            "    except Exception as ex:",
            "        if ex.message.lower().startswith(\"no processor available\"):",
            "            return {",
            "                \"template\": \"webclient/scripts/no_processor.html\",",
            "                \"scriptId\": scriptId,",
            "            }",
            "        raise ex",
            "    if params is None:",
            "        return HttpResponse()",
            "",
            "    paramData = {}",
            "",
            "    paramData[\"id\"] = long(scriptId)",
            "    paramData[\"name\"] = params.name.replace(\"_\", \" \")",
            "    paramData[\"description\"] = params.description",
            "    paramData[\"authors\"] = \", \".join([a for a in params.authors])",
            "    paramData[\"contact\"] = params.contact",
            "    paramData[\"version\"] = params.version",
            "    paramData[\"institutions\"] = \", \".join([i for i in params.institutions])",
            "",
            "    inputs = []  # use a list so we can sort by 'grouping'",
            "    Data_TypeParam = None",
            "    IDsParam = None",
            "    for key, param in params.inputs.items():",
            "        i = {}",
            "        i[\"name\"] = key.replace(\"_\", \" \")",
            "        i[\"key\"] = key",
            "        if not param.optional:",
            "            i[\"required\"] = True",
            "        i[\"description\"] = param.description",
            "        if param.min:",
            "            i[\"min\"] = str(param.min.getValue())",
            "        if param.max:",
            "            i[\"max\"] = str(param.max.getValue())",
            "        if param.values:",
            "            i[\"options\"] = [v.getValue() for v in param.values.getValue()]",
            "        if param.useDefault:",
            "            i[\"default\"] = unwrap(param.prototype)",
            "            if isinstance(i[\"default\"], omero.model.IObject):",
            "                i[\"default\"] = None",
            "        pt = unwrap(param.prototype)",
            "        if pt.__class__.__name__ == \"dict\":",
            "            i[\"map\"] = True",
            "        elif pt.__class__.__name__ == \"list\":",
            "            i[\"list\"] = True",
            "            if \"default\" in i:",
            "                i[\"default\"] = \",\".join([str(d) for d in i[\"default\"]])",
            "        elif isinstance(pt, bool):",
            "            i[\"boolean\"] = True",
            "        elif isinstance(pt, int) or isinstance(pt, long):",
            "            # will stop the user entering anything other than numbers.",
            "            i[\"number\"] = \"number\"",
            "        elif isinstance(pt, float):",
            "            i[\"number\"] = \"float\"",
            "",
            "        # if we got a value for this key in the page request, use this as",
            "        # default",
            "        if request.GET.get(key, None) is not None:",
            "            i[\"default\"] = request.GET.get(key, None)",
            "",
            "        # E.g  \"\"  (string) or [0] (int list) or 0.0 (float)",
            "        i[\"prototype\"] = unwrap(param.prototype)",
            "        i[\"grouping\"] = param.grouping",
            "        inputs.append(i)",
            "",
            "        if key == \"IDs\":",
            "            IDsParam = i  # remember these...",
            "        if key == \"Data_Type\":",
            "            Data_TypeParam = i",
            "    inputs.sort(key=lambda i: i[\"grouping\"])",
            "",
            "    # if we have Data_Type param - use the request parameters to populate IDs",
            "    if (",
            "        Data_TypeParam is not None",
            "        and IDsParam is not None",
            "        and \"options\" in Data_TypeParam",
            "    ):",
            "        IDsParam[\"default\"] = \"\"",
            "        for dtype in Data_TypeParam[\"options\"]:",
            "            if request.GET.get(dtype, None) is not None:",
            "                Data_TypeParam[\"default\"] = dtype",
            "                IDsParam[\"default\"] = request.GET.get(dtype, \"\")",
            "                break  # only use the first match",
            "        # if we've not found a match, check whether we have \"Well\" selected",
            "        if len(IDsParam[\"default\"]) == 0 and request.GET.get(\"Well\", None) is not None:",
            "            if \"Image\" in Data_TypeParam[\"options\"]:",
            "                wellIds = [long(j) for j in request.GET.get(\"Well\", None).split(\",\")]",
            "                wellIdx = 0",
            "                try:",
            "                    wellIdx = int(request.GET.get(\"Index\", 0))",
            "                except Exception:",
            "                    pass",
            "                wells = conn.getObjects(\"Well\", wellIds)",
            "                imgIds = [str(w.getImage(wellIdx).getId()) for w in wells]",
            "                Data_TypeParam[\"default\"] = \"Image\"",
            "                IDsParam[\"default\"] = \",\".join(imgIds)",
            "",
            "    # try to determine hierarchies in the groupings - ONLY handle 1 hierarchy",
            "    # level now (not recursive!)",
            "    for i in range(len(inputs)):",
            "        if len(inputs) <= i:",
            "            # we may remove items from inputs as we go - need to check",
            "            break",
            "        param = inputs[i]",
            "        grouping = param[\"grouping\"]  # E.g  03",
            "        param[\"children\"] = list()",
            "        while len(inputs) > i + 1:",
            "            nextGrp = inputs[i + 1][\"grouping\"]  # E.g. 03.1",
            "            if nextGrp.split(\".\")[0] == grouping:",
            "                param[\"children\"].append(inputs[i + 1])",
            "                inputs.pop(i + 1)",
            "            else:",
            "                break",
            "",
            "    paramData[\"inputs\"] = inputs",
            "",
            "    return {",
            "        \"template\": \"webclient/scripts/script_ui.html\",",
            "        \"paramData\": paramData,",
            "        \"scriptId\": scriptId,",
            "    }",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def figure_script(request, scriptName, conn=None, **kwargs):",
            "    \"\"\"",
            "    Show a UI for running figure scripts",
            "    \"\"\"",
            "",
            "    imageIds = request.GET.get(\"Image\", None)  # comma - delimited list",
            "    datasetIds = request.GET.get(\"Dataset\", None)",
            "    wellIds = request.GET.get(\"Well\", None)",
            "",
            "    if wellIds is not None:",
            "        wellIds = [long(i) for i in wellIds.split(\",\")]",
            "        wells = conn.getObjects(\"Well\", wellIds)",
            "        wellIdx = getIntOrDefault(request, \"Index\", 0)",
            "        imageIds = [str(w.getImage(wellIdx).getId()) for w in wells]",
            "        imageIds = \",\".join(imageIds)",
            "    if imageIds is None and datasetIds is None:",
            "        return HttpResponse(",
            "            \"Need to specify /?Image=1,2 or /?Dataset=1,2 or /?Well=1,2\"",
            "        )",
            "",
            "    def validateIds(dtype, ids):",
            "        ints = [int(oid) for oid in ids.split(\",\")]",
            "        validObjs = {}",
            "        for obj in conn.getObjects(dtype, ints):",
            "            validObjs[obj.id] = obj",
            "        filteredIds = [iid for iid in ints if iid in validObjs.keys()]",
            "        if len(filteredIds) == 0:",
            "            raise Http404(\"No %ss found with IDs %s\" % (dtype, ids))",
            "        else:",
            "            # Now we can specify group context - All should be same group",
            "            gid = list(validObjs.values())[0].getDetails().group.id.val",
            "            conn.SERVICE_OPTS.setOmeroGroup(gid)",
            "        return filteredIds, validObjs",
            "",
            "    context = {}",
            "",
            "    if imageIds is not None:",
            "        imageIds, validImages = validateIds(\"Image\", imageIds)",
            "        context[\"idString\"] = \",\".join([str(i) for i in imageIds])",
            "        context[\"dtype\"] = \"Image\"",
            "    if datasetIds is not None:",
            "        datasetIds, validDatasets = validateIds(\"Dataset\", datasetIds)",
            "        context[\"idString\"] = \",\".join([str(i) for i in datasetIds])",
            "        context[\"dtype\"] = \"Dataset\"",
            "",
            "    if scriptName == \"SplitView\":",
            "        scriptPath = \"/omero/figure_scripts/Split_View_Figure.py\"",
            "        template = \"webclient/scripts/split_view_figure.html\"",
            "        # Lookup Tags & Datasets (for row labels)",
            "        imgDict = []  # A list of data about each image.",
            "        for iId in imageIds:",
            "            data = {\"id\": iId}",
            "            img = validImages[iId]",
            "            data[\"name\"] = img.getName()",
            "            tags = [",
            "                ann.getTextValue()",
            "                for ann in img.listAnnotations()",
            "                if ann._obj.__class__ == omero.model.TagAnnotationI",
            "            ]",
            "            data[\"tags\"] = tags",
            "            data[\"datasets\"] = [d.getName() for d in img.listParents()]",
            "            imgDict.append(data)",
            "",
            "        # Use the first image as a reference",
            "        image = validImages[imageIds[0]]",
            "        context[\"imgDict\"] = imgDict",
            "        context[\"image\"] = image",
            "        context[\"channels\"] = image.getChannels()",
            "",
            "    elif scriptName == \"Thumbnail\":",
            "        scriptPath = \"/omero/figure_scripts/Thumbnail_Figure.py\"",
            "        template = \"webclient/scripts/thumbnail_figure.html\"",
            "",
            "        def loadImageTags(imageIds):",
            "            tagLinks = conn.getAnnotationLinks(\"Image\", parent_ids=imageIds)",
            "            linkMap = {}  # group tags. {imageId: [tags]}",
            "            tagMap = {}",
            "            for iId in imageIds:",
            "                linkMap[iId] = []",
            "            for link in tagLinks:",
            "                c = link.getChild()",
            "                if c._obj.__class__ == omero.model.TagAnnotationI:",
            "                    tagMap[c.id] = c",
            "                    linkMap[link.getParent().id].append(c)",
            "            imageTags = []",
            "            for iId in imageIds:",
            "                imageTags.append({\"id\": iId, \"tags\": linkMap[iId]})",
            "            tags = []",
            "            for tId, t in tagMap.items():",
            "                tags.append(t)",
            "            return imageTags, tags",
            "",
            "        thumbSets = []  # multiple collections of images",
            "        tags = []",
            "        figureName = \"Thumbnail_Figure\"",
            "        if datasetIds is not None:",
            "            for d in conn.getObjects(\"Dataset\", datasetIds):",
            "                imgIds = [i.id for i in d.listChildren()]",
            "                imageTags, ts = loadImageTags(imgIds)",
            "                thumbSets.append({\"name\": d.getName(), \"imageTags\": imageTags})",
            "                tags.extend(ts)",
            "            figureName = thumbSets[0][\"name\"]",
            "        else:",
            "            imageTags, ts = loadImageTags(imageIds)",
            "            thumbSets.append({\"name\": \"images\", \"imageTags\": imageTags})",
            "            tags.extend(ts)",
            "            parent = conn.getObject(\"Image\", imageIds[0]).getParent()",
            "            figureName = parent.getName() or \"Thumbnail Figure\"",
            "            context[\"parent_id\"] = parent.getId()",
            "        uniqueTagIds = set()  # remove duplicates",
            "        uniqueTags = []",
            "        for t in tags:",
            "            if t.id not in uniqueTagIds:",
            "                uniqueTags.append(t)",
            "                uniqueTagIds.add(t.id)",
            "        uniqueTags.sort(key=lambda x: x.getTextValue().lower())",
            "        context[\"thumbSets\"] = thumbSets",
            "        context[\"tags\"] = uniqueTags",
            "        context[\"figureName\"] = figureName.replace(\" \", \"_\")",
            "",
            "    elif scriptName == \"MakeMovie\":",
            "        scriptPath = \"/omero/export_scripts/Make_Movie.py\"",
            "        template = \"webclient/scripts/make_movie.html\"",
            "",
            "        # expect to run on a single image at a time",
            "        image = conn.getObject(\"Image\", imageIds[0])",
            "        # remove extension (if 3 chars or less)",
            "        movieName = image.getName().rsplit(\".\", 1)",
            "        if len(movieName) > 1 and len(movieName[1]) > 3:",
            "            movieName = \".\".join(movieName)",
            "        else:",
            "            movieName = movieName[0]",
            "        # make sure name is not a path",
            "        context[\"movieName\"] = os.path.basename(movieName)",
            "        chs = []",
            "        for c in image.getChannels():",
            "            chs.append(",
            "                {",
            "                    \"active\": c.isActive(),",
            "                    \"color\": c.getColor().getHtml(),",
            "                    \"label\": c.getLabel(),",
            "                }",
            "            )",
            "        context[\"channels\"] = chs",
            "        context[\"sizeT\"] = image.getSizeT()",
            "        context[\"sizeZ\"] = image.getSizeZ()",
            "",
            "    scriptService = conn.getScriptService()",
            "    scriptId = scriptService.getScriptID(scriptPath)",
            "    if scriptId < 0:",
            "        raise AttributeError(\"No script found for path '%s'\" % scriptPath)",
            "",
            "    context[\"template\"] = template",
            "    context[\"scriptId\"] = scriptId",
            "    return context",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def fileset_check(request, action, conn=None, **kwargs):",
            "    \"\"\"",
            "    Check whether Images / Datasets etc contain partial Multi-image filesets.",
            "    Used by chgrp or delete dialogs to test whether we can perform this",
            "    'action'.",
            "    \"\"\"",
            "    dtypeIds = {}",
            "    for dtype in (\"Image\", \"Dataset\", \"Project\"):",
            "        ids = request.GET.get(dtype, None)",
            "        if ids is not None:",
            "            dtypeIds[dtype] = [int(i) for i in ids.split(\",\")]",
            "    splitFilesets = conn.getContainerService().getImagesBySplitFilesets(",
            "        dtypeIds, None, conn.SERVICE_OPTS",
            "    )",
            "",
            "    splits = []",
            "    for fsId, splitIds in splitFilesets.items():",
            "        splits.append(",
            "            {",
            "                \"id\": fsId,",
            "                \"attempted_iids\": splitIds[True],",
            "                \"blocking_iids\": splitIds[False],",
            "            }",
            "        )",
            "",
            "    context = {\"split_filesets\": splits}",
            "    context[\"action\"] = action",
            "    if action == \"chgrp\":",
            "        context[\"action\"] = \"move\"",
            "    context[\"template\"] = \"webclient/activities/\" \"fileset_check_dialog_content.html\"",
            "",
            "    return context",
            "",
            "",
            "def getAllObjects(",
            "    conn, project_ids, dataset_ids, image_ids, screen_ids, plate_ids, experimenter_id",
            "):",
            "    \"\"\"",
            "    Given a list of containers and images, calculate all the descendants",
            "    and necessary siblings (for any filesets)",
            "    \"\"\"",
            "    # TODO Handle None inputs, maybe add defaults",
            "    params = omero.sys.ParametersI()",
            "    qs = conn.getQueryService()",
            "",
            "    project_ids = set(project_ids)",
            "    dataset_ids = set(dataset_ids)",
            "    image_ids = set(image_ids)",
            "    fileset_ids = set([])",
            "    plate_ids = set(plate_ids)",
            "    screen_ids = set(screen_ids)",
            "",
            "    # Get any datasets for projects",
            "    if project_ids:",
            "        params.map = {}",
            "        params.map[\"pids\"] = rlist([rlong(x) for x in list(project_ids)])",
            "        q = \"\"\"",
            "            select pdlink.child.id",
            "            from ProjectDatasetLink pdlink",
            "            where pdlink.parent.id in (:pids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            dataset_ids.add(e[0].val)",
            "",
            "    # Get any plates for screens",
            "    if screen_ids:",
            "        params.map = {}",
            "        params.map[\"sids\"] = rlist([rlong(x) for x in screen_ids])",
            "        q = \"\"\"",
            "            select splink.child.id",
            "            from ScreenPlateLink splink",
            "            where splink.parent.id in (:sids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            plate_ids.add(e[0].val)",
            "",
            "    # Get any images for datasets",
            "    if dataset_ids:",
            "        params.map = {}",
            "        params.map[\"dids\"] = rlist([rlong(x) for x in dataset_ids])",
            "        q = \"\"\"",
            "            select dilink.child.id,",
            "                   dilink.child.fileset.id",
            "            from DatasetImageLink dilink",
            "            where dilink.parent.id in (:dids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            image_ids.add(e[0].val)",
            "            # Some images in Dataset may not have fileset",
            "            if e[1] is not None:",
            "                fileset_ids.add(e[1].val)",
            "",
            "    # Get any images for plates",
            "    # TODO Seemed no need to add the filesets for plates as it isn't possible",
            "    # to link it from outside of its plate. This may be true for the client,",
            "    # but it certainly isn't true for the model so maybe allow this to also get",
            "    # filesets",
            "    if plate_ids:",
            "        params.map = {}",
            "        params.map[\"plids\"] = rlist([rlong(x) for x in plate_ids])",
            "        q = \"\"\"",
            "            select ws.image.id",
            "            from WellSample ws",
            "            join ws.plateAcquisition pa",
            "            where pa.plate.id in (:plids)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            image_ids.add(e[0].val)",
            "",
            "    # Get any extra images due to filesets",
            "    if fileset_ids:",
            "        params.map = {}",
            "        params.map[\"fsids\"] = rlist([rlong(x) for x in fileset_ids])",
            "        q = \"\"\"",
            "            select image.id",
            "            from Image image",
            "            left outer join image.datasetLinks dilink",
            "            where image.fileset.id in (select fs.id",
            "                                       from Image im",
            "                                       join im.fileset fs",
            "                                       where fs.id in (:fsids)",
            "                                       group by fs.id",
            "                                       having count(im.id)>1)",
            "            \"\"\"",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            image_ids.add(e[0].val)",
            "",
            "    # Get any additional datasets that may need updating as their children have",
            "    # been snatched.",
            "    # TODO Need to differentiate which orphaned directories need refreshing",
            "    extra_dataset_ids = set([])",
            "    extra_orphaned = False",
            "    if image_ids:",
            "        params.map = {",
            "            \"iids\": rlist([rlong(x) for x in image_ids]),",
            "        }",
            "",
            "        exclude_datasets = \"\"",
            "        if dataset_ids:",
            "            params.map[\"dids\"] = rlist([rlong(x) for x in dataset_ids])",
            "            # Make sure to allow parentless results as well as those",
            "            # that do not match a dataset being removed",
            "            exclude_datasets = \"\"\"",
            "                               and (",
            "                                    dilink.parent.id not in (:dids)",
            "                                    or dilink.parent.id = null",
            "                                   )",
            "                               \"\"\"",
            "",
            "        q = (",
            "            \"\"\"",
            "            select distinct dilink.parent.id",
            "            from Image image",
            "            left outer join image.datasetLinks dilink",
            "            where image.id in (:iids)",
            "            %s",
            "            and (select count(dilink2.child.id)",
            "                 from DatasetImageLink dilink2",
            "                 where dilink2.parent.id = dilink.parent.id",
            "                 and dilink2.child.id not in (:iids)) = 0",
            "            \"\"\"",
            "            % exclude_datasets",
            "        )",
            "",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            if e:",
            "                extra_dataset_ids.add(e[0].val)",
            "            else:",
            "                extra_orphaned = True",
            "",
            "    # Get any additional projects that may need updating as their children have",
            "    # been snatched. There is no need to check for orphans because if a dataset",
            "    # is being removed from somewhere else, it can not exist as an orphan.",
            "    extra_project_ids = set([])",
            "    if dataset_ids:",
            "        params.map = {\"dids\": rlist([rlong(x) for x in dataset_ids])}",
            "",
            "        exclude_projects = \"\"",
            "        if project_ids:",
            "            params.map[\"pids\"] = rlist([rlong(x) for x in project_ids])",
            "            exclude_projects = \"and pdlink.parent.id not in (:pids)\"",
            "",
            "        q = (",
            "            \"\"\"",
            "            select distinct pdlink.parent.id",
            "            from ProjectDatasetLink pdlink",
            "            where pdlink.child.id in (:dids)",
            "            %s",
            "            and (select count(pdlink2.child.id)",
            "                 from ProjectDatasetLink pdlink2",
            "                 where pdlink2.parent.id = pdlink.parent.id",
            "                 and pdlink2.child.id not in (:dids)) = 0",
            "            \"\"\"",
            "            % exclude_projects",
            "        )",
            "",
            "        for e in qs.projection(q, params, conn.SERVICE_OPTS):",
            "            extra_project_ids.add(e[0].val)",
            "",
            "    # We now have the complete list of objects that will change group",
            "    # We also have an additional list of datasets/projects that may have had",
            "    # snatched children and thus may need updating in the client if the",
            "    # dataset/project has gone from N to 0 children",
            "",
            "    result = {",
            "        # These objects are completely removed",
            "        \"remove\": {",
            "            \"project\": list(project_ids),",
            "            \"dataset\": list(dataset_ids),",
            "            \"screen\": list(screen_ids),",
            "            \"plate\": list(plate_ids),",
            "            \"image\": list(image_ids),",
            "        },",
            "        # These objects now have no children",
            "        \"childless\": {",
            "            \"project\": list(extra_project_ids),",
            "            \"dataset\": list(extra_dataset_ids),",
            "            \"orphaned\": extra_orphaned,",
            "        },",
            "    }",
            "    return result",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "def chgrpDryRun(request, conn=None, **kwargs):",
            "    return dryRun(request, action=\"chgrp\", conn=conn, **kwargs)",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "def dryRun(request, action, conn=None, **kwargs):",
            "    \"\"\"Submit chgrp or chown dry-run\"\"\"",
            "    targetObjects = {}",
            "    dtypes = [\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\", \"Fileset\"]",
            "    for dtype in dtypes:",
            "        oids = request.POST.get(dtype, None)",
            "        if oids is not None:",
            "            obj_ids = [int(oid) for oid in oids.split(\",\")]",
            "            targetObjects[dtype] = obj_ids",
            "",
            "    if action == \"chgrp\":",
            "        target_id = getIntOrDefault(request, \"group_id\", None)",
            "    elif action == \"chown\":",
            "        target_id = getIntOrDefault(request, \"owner_id\", None)",
            "    handle = conn.submitDryRun(action, targetObjects, target_id)",
            "    jobId = str(handle)",
            "    return HttpResponse(jobId)",
            "",
            "",
            "@login_required()",
            "def chgrp(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Moves data to a new group, using the chgrp queue.",
            "    Handles submission of chgrp form: all data in POST.",
            "    Adds the callback handle to the request.session['callback']['jobId']",
            "    \"\"\"",
            "    if not request.method == \"POST\":",
            "        return JsonResponse({\"Error\": \"Need to POST to chgrp\"}, status=405)",
            "    # Get the target group_id",
            "    group_id = getIntOrDefault(request, \"group_id\", None)",
            "    if group_id is None:",
            "        return JsonResponse({\"Error\": \"chgrp: No group_id specified\"})",
            "    group_id = long(group_id)",
            "",
            "    def getObjectOwnerId(r):",
            "        for t in [\"Dataset\", \"Image\", \"Plate\"]:",
            "            ids = r.POST.get(t, None)",
            "            if ids is not None:",
            "                for o in list(conn.getObjects(t, ids.split(\",\"))):",
            "                    return o.getDetails().owner.id.val",
            "",
            "    group = conn.getObject(\"ExperimenterGroup\", group_id)",
            "    new_container_name = request.POST.get(\"new_container_name\", None)",
            "    new_container_type = request.POST.get(\"new_container_type\", None)",
            "    container_id = None",
            "",
            "    # Context must be set to owner of data, E.g. to create links.",
            "    ownerId = getObjectOwnerId(request)",
            "    conn.SERVICE_OPTS.setOmeroUser(ownerId)",
            "    if (",
            "        new_container_name is not None",
            "        and len(new_container_name) > 0",
            "        and new_container_type is not None",
            "    ):",
            "        conn.SERVICE_OPTS.setOmeroGroup(group_id)",
            "        container_id = conn.createContainer(new_container_type, new_container_name)",
            "    # No new container, check if target is specified",
            "    if container_id is None:",
            "        # E.g. \"dataset-234\"",
            "        target_id = request.POST.get(\"target_id\", None)",
            "        container_id = target_id is not None and target_id.split(\"-\")[1] or None",
            "    dtypes = [\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\"]",
            "    for dtype in dtypes:",
            "        # Get all requested objects of this type",
            "        oids = request.POST.get(dtype, None)",
            "        if oids is not None:",
            "            obj_ids = [int(oid) for oid in oids.split(\",\")]",
            "            # TODO Doesn't the filesets only apply to images?",
            "            # if 'filesets' are specified, make sure we move ALL Fileset Images",
            "            fsIds = request.POST.getlist(\"fileset\")",
            "            if len(fsIds) > 0:",
            "                # If a dataset is being moved and there is a split fileset",
            "                # then those images need to go somewhere in the new",
            "                if dtype == \"Dataset\":",
            "                    conn.regroupFilesets(dsIds=obj_ids, fsIds=fsIds)",
            "                else:",
            "                    for fs in conn.getObjects(\"Fileset\", fsIds):",
            "                        obj_ids.extend([i.id for i in fs.copyImages()])",
            "                    obj_ids = list(set(obj_ids))  # remove duplicates",
            "            logger.debug(\"chgrp to group:%s %s-%s\" % (group_id, dtype, obj_ids))",
            "            handle = conn.chgrpObjects(dtype, obj_ids, group_id, container_id)",
            "            jobId = str(handle)",
            "            request.session[\"callback\"][jobId] = {",
            "                \"job_type\": \"chgrp\",",
            "                \"group\": group.getName(),",
            "                \"to_group_id\": group_id,",
            "                \"dtype\": dtype,",
            "                \"obj_ids\": obj_ids,",
            "                \"job_name\": \"Change group\",",
            "                \"start_time\": datetime.datetime.now(),",
            "                \"status\": \"in progress\",",
            "            }",
            "            request.session.modified = True",
            "",
            "    # Update contains a list of images/containers that need to be",
            "    # updated.",
            "",
            "    project_ids = request.POST.get(\"Project\", [])",
            "    dataset_ids = request.POST.get(\"Dataset\", [])",
            "    image_ids = request.POST.get(\"Image\", [])",
            "    screen_ids = request.POST.get(\"Screen\", [])",
            "    plate_ids = request.POST.get(\"Plate\", [])",
            "",
            "    if project_ids:",
            "        project_ids = [long(x) for x in project_ids.split(\",\")]",
            "    if dataset_ids:",
            "        dataset_ids = [long(x) for x in dataset_ids.split(\",\")]",
            "    if image_ids:",
            "        image_ids = [long(x) for x in image_ids.split(\",\")]",
            "    if screen_ids:",
            "        screen_ids = [long(x) for x in screen_ids.split(\",\")]",
            "    if plate_ids:",
            "        plate_ids = [long(x) for x in plate_ids.split(\",\")]",
            "",
            "    # TODO Change this user_id to be an experimenter_id in the request as it",
            "    # is possible that a user is chgrping data from another user so it is",
            "    # that users orphaned that will need updating. Or maybe all orphaned",
            "    # directories could potentially need updating?",
            "",
            "    # Create a list of objects that have been changed by this operation. This",
            "    # can be used by the client to visually update.",
            "    update = getAllObjects(",
            "        conn,",
            "        project_ids,",
            "        dataset_ids,",
            "        image_ids,",
            "        screen_ids,",
            "        plate_ids,",
            "        request.session.get(\"user_id\"),",
            "    )",
            "",
            "    # return HttpResponse(\"OK\")",
            "    return JsonResponse({\"update\": update})",
            "",
            "",
            "@login_required()",
            "def chown(request, conn=None, **kwargs):",
            "    \"\"\"",
            "    Moves data to a new owner, using the chown queue.",
            "    Handles submission of chown form: all data in POST.",
            "    Adds the callback handle to the request.session['callback']['jobId']",
            "    \"\"\"",
            "    if not request.method == \"POST\":",
            "        return JsonResponse({\"Error\": \"Need to POST to chown\"}, status=405)",
            "    # Get the target owner_id",
            "    owner_id = getIntOrDefault(request, \"owner_id\", None)",
            "    if owner_id is None:",
            "        return JsonResponse({\"Error\": \"chown: No owner_id specified\"})",
            "    owner_id = int(owner_id)",
            "    exp = conn.getObject(\"Experimenter\", owner_id)",
            "    if exp is None:",
            "        return JsonResponse({\"Error\": \"chown: Experimenter not found\" % owner_id})",
            "",
            "    dtypes = [\"Project\", \"Dataset\", \"Image\", \"Screen\", \"Plate\"]",
            "    jobIds = []",
            "    for dtype in dtypes:",
            "        # Get all requested objects of this type",
            "        oids = request.POST.get(dtype, None)",
            "        if oids is not None:",
            "            obj_ids = [int(oid) for oid in oids.split(\",\")]",
            "            logger.debug(\"chown to owner:%s %s-%s\" % (owner_id, dtype, obj_ids))",
            "            handle = conn.chownObjects(dtype, obj_ids, owner_id)",
            "            jobId = str(handle)",
            "            jobIds.append(jobId)",
            "            request.session[\"callback\"][jobId] = {",
            "                \"job_type\": \"chown\",",
            "                \"owner\": exp.getFullName(),",
            "                \"to_owner_id\": owner_id,",
            "                \"dtype\": dtype,",
            "                \"obj_ids\": obj_ids,",
            "                \"job_name\": \"Change owner\",",
            "                \"start_time\": datetime.datetime.now(),",
            "                \"status\": \"in progress\",",
            "            }",
            "            request.session.modified = True",
            "",
            "    return JsonResponse({\"jobIds\": jobIds})",
            "",
            "",
            "@login_required(setGroupContext=True)",
            "def script_run(request, scriptId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Runs a script using values in a POST",
            "    \"\"\"",
            "    scriptService = conn.getScriptService()",
            "",
            "    inputMap = {}",
            "",
            "    sId = long(scriptId)",
            "",
            "    try:",
            "        params = scriptService.getParams(sId)",
            "    except Exception as x:",
            "        if x.message and x.message.startswith(\"No processor available\"):",
            "            # Delegate to run_script() for handling 'No processor available'",
            "            rsp = run_script(request, conn, sId, inputMap, scriptName=\"Script\")",
            "            return JsonResponse(rsp)",
            "        else:",
            "            raise",
            "    params = scriptService.getParams(sId)",
            "    scriptName = params.name.replace(\"_\", \" \").replace(\".py\", \"\")",
            "",
            "    logger.debug(\"Script: run with request.POST: %s\" % request.POST)",
            "",
            "    # upload new file",
            "    fileupload = (",
            "        \"file_annotation\" in request.FILES and request.FILES[\"file_annotation\"] or None",
            "    )",
            "    fileAnnId = None",
            "    if fileupload is not None and fileupload != \"\":",
            "        manager = BaseContainer(conn)",
            "        fileAnnId = manager.createFileAnnotations(fileupload, [])",
            "",
            "    for key, param in params.inputs.items():",
            "        prototype = param.prototype",
            "        pclass = prototype.__class__",
            "",
            "        if key == \"File_Annotation\" and fileAnnId is not None:",
            "            inputMap[key] = pclass(str(fileAnnId))",
            "            continue",
            "",
            "        # handle bool separately, since unchecked checkbox will not be in",
            "        # request.POST",
            "        if pclass == omero.rtypes.RBoolI:",
            "            value = key in request.POST",
            "            inputMap[key] = pclass(value)",
            "            continue",
            "",
            "        if pclass.__name__ == \"RMapI\":",
            "            keyName = \"%s_key0\" % key",
            "            valueName = \"%s_value0\" % key",
            "            row = 0",
            "            paramMap = {}",
            "            while keyName in request.POST:",
            "                # the key and value don't have any data-type defined by",
            "                # scripts - just use string",
            "                k = str(request.POST[keyName])",
            "                v = request.POST[valueName]",
            "                if len(k) > 0 and len(v) > 0:",
            "                    paramMap[str(k)] = v",
            "                row += 1",
            "                keyName = \"%s_key%d\" % (key, row)",
            "                valueName = \"%s_value%d\" % (key, row)",
            "            if len(paramMap) > 0:",
            "                inputMap[key] = wrap(paramMap)",
            "            continue",
            "",
            "        if key in request.POST:",
            "            if pclass == omero.rtypes.RListI:",
            "                values = request.POST.getlist(key)",
            "                if len(values) == 0:",
            "                    continue",
            "                if len(values) == 1:  # process comma-separated list",
            "                    if len(values[0]) == 0:",
            "                        continue",
            "                    values = values[0].split(\",\")",
            "",
            "                # try to determine 'type' of values in our list",
            "                listClass = omero.rtypes.RStringI",
            "                pval = prototype.val  # list",
            "                # check if a value type has been set (first item of prototype",
            "                # list)",
            "                if len(pval) > 0:",
            "                    listClass = pval[0].__class__",
            "                    if listClass == int(1).__class__:",
            "                        listClass = omero.rtypes.rint",
            "                    if listClass == long(1).__class__:",
            "                        listClass = omero.rtypes.rlong",
            "",
            "                # construct our list, using appropriate 'type'",
            "                valueList = []",
            "                for v in values:",
            "                    try:",
            "                        # RStringI() will encode any unicode",
            "                        obj = listClass(v.strip())",
            "                    except Exception:",
            "                        logger.debug(\"Invalid entry for '%s' : %s\" % (key, v))",
            "                        continue",
            "                    if isinstance(obj, omero.model.IObject):",
            "                        valueList.append(omero.rtypes.robject(obj))",
            "                    else:",
            "                        valueList.append(obj)",
            "                inputMap[key] = omero.rtypes.rlist(valueList)",
            "",
            "            # Handle other rtypes: String, Long, Int etc.",
            "            else:",
            "                value = request.POST[key]",
            "                if len(value) == 0:",
            "                    continue",
            "                try:",
            "                    inputMap[key] = pclass(value)",
            "                except Exception:",
            "                    logger.debug(\"Invalid entry for '%s' : %s\" % (key, value))",
            "                    continue",
            "",
            "    # If we have objects specified via 'IDs' and 'DataType', try to pick",
            "    # correct group",
            "    if \"IDs\" in inputMap and \"Data_Type\" in inputMap:",
            "        gid = conn.SERVICE_OPTS.getOmeroGroup()",
            "        conn.SERVICE_OPTS.setOmeroGroup(\"-1\")",
            "        try:",
            "            firstObj = conn.getObject(",
            "                inputMap[\"Data_Type\"].val, unwrap(inputMap[\"IDs\"])[0]",
            "            )",
            "            newGid = firstObj.getDetails().group.id.val",
            "            conn.SERVICE_OPTS.setOmeroGroup(newGid)",
            "        except Exception:",
            "            logger.debug(traceback.format_exc())",
            "            # if inputMap values not as expected or firstObj is None",
            "            conn.SERVICE_OPTS.setOmeroGroup(gid)",
            "",
            "    try:",
            "        # Try/except in case inputs are not serializable, e.g. unicode",
            "        logger.debug(\"Running script %s with \" \"params %s\" % (scriptName, inputMap))",
            "    except Exception:",
            "        pass",
            "    rsp = run_script(request, conn, sId, inputMap, scriptName)",
            "    return JsonResponse(rsp)",
            "",
            "",
            "@login_required(isAdmin=True)",
            "@render_response()",
            "def script_upload(request, conn=None, **kwargs):",
            "    \"\"\"Script upload UI\"\"\"",
            "",
            "    if request.method != \"POST\":",
            "        return {\"template\": \"webclient/scripts/upload_script.html\"}",
            "",
            "    # Get script path, name and text",
            "    script_path = request.POST.get(\"script_path\")",
            "    script_file = request.FILES[\"script_file\"]",
            "    script_file.seek(0)",
            "    script_text = script_file.read().decode(\"utf-8\")",
            "",
            "    if not script_path.endswith(\"/\"):",
            "        script_path = script_path + \"/\"",
            "    script_path = script_path + script_file.name",
            "",
            "    # If script exists, replace. Otherwise upload",
            "    scriptService = conn.getScriptService()",
            "    script_id = scriptService.getScriptID(script_path)",
            "",
            "    try:",
            "        if script_id > 0:",
            "            orig_file = OriginalFileI(script_id, False)",
            "            scriptService.editScript(orig_file, script_text)",
            "            message = \"Script Replaced: %s\" % script_file.name",
            "        else:",
            "            script_id = scriptService.uploadOfficialScript(script_path, script_text)",
            "            message = \"Script Uploaded: %s\" % script_file.name",
            "    except omero.ValidationException as ex:",
            "        message = str(ex)",
            "",
            "    return {\"Message\": message, \"script_id\": script_id}",
            "",
            "",
            "@require_POST",
            "@login_required()",
            "def ome_tiff_script(request, imageId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Uses the scripting service (Batch Image Export script) to generate",
            "    OME-TIFF for an image and attach this as a file annotation to the image.",
            "    Script will show up in the 'Activities' for users to monitor and download",
            "    result etc.",
            "    \"\"\"",
            "",
            "    scriptService = conn.getScriptService()",
            "    sId = scriptService.getScriptID(\"/omero/export_scripts/Batch_Image_Export.py\")",
            "",
            "    image = conn.getObject(\"Image\", imageId)",
            "    if image is not None:",
            "        gid = image.getDetails().group.id.val",
            "        conn.SERVICE_OPTS.setOmeroGroup(gid)",
            "    imageIds = [long(imageId)]",
            "    inputMap = {",
            "        \"Data_Type\": wrap(\"Image\"),",
            "        \"IDs\": rlist([rlong(id) for id in imageIds]),",
            "    }",
            "    inputMap[\"Format\"] = wrap(\"OME-TIFF\")",
            "    rsp = run_script(request, conn, sId, inputMap, scriptName=\"Create OME-TIFF\")",
            "    return JsonResponse(rsp)",
            "",
            "",
            "def run_script(request, conn, sId, inputMap, scriptName=\"Script\"):",
            "    \"\"\"",
            "    Starts running a script, adding details to the request.session so that it",
            "    shows up in the webclient Activities panel and results are available there",
            "    etc.",
            "    \"\"\"",
            "    request.session.modified = True",
            "    scriptService = conn.getScriptService()",
            "    try:",
            "        handle = scriptService.runScript(sId, inputMap, None, conn.SERVICE_OPTS)",
            "        # E.g. ProcessCallback/4ab13b23-22c9-4b5f-9318-40f9a1acc4e9 -t:tcp -h  10.37.129.2 -p 53154:tcp -h 10.211.55.2 -p 53154:tcp -h 10.12.1.230 -p 53154 # noqa",
            "        jobId = str(handle)",
            "        status = \"in progress\"",
            "        request.session[\"callback\"][jobId] = {",
            "            \"job_type\": \"script\",",
            "            \"job_name\": scriptName,",
            "            \"start_time\": datetime.datetime.now(),",
            "            \"status\": status,",
            "        }",
            "        request.session.modified = True",
            "    except Exception as x:",
            "        jobId = str(time())  # E.g. 1312803670.6076391",
            "        # handle python 2 or 3 errors",
            "        message = x.message if hasattr(x, \"message\") else (x.args[0] if x.args else \"\")",
            "        if message and message.startswith(\"No processor available\"):",
            "            # omero.ResourceError",
            "            logger.info(traceback.format_exc())",
            "            error = \"No Processor Available\"",
            "            status = \"no processor available\"",
            "            message = \"\"  # template displays message and link",
            "        else:",
            "            logger.error(traceback.format_exc())",
            "            error = traceback.format_exc()",
            "            status = \"failed\"",
            "            message = x.message",
            "        # save the error to http session, for display in 'Activities' window",
            "        request.session[\"callback\"][jobId] = {",
            "            \"job_type\": \"script\",",
            "            \"job_name\": scriptName,",
            "            \"start_time\": datetime.datetime.now(),",
            "            \"status\": status,",
            "            \"Message\": message,",
            "            \"error\": error,",
            "        }",
            "        return {\"status\": status, \"error\": error}",
            "",
            "    return {\"jobId\": jobId, \"status\": status}",
            "",
            "",
            "@login_required()",
            "@render_response()",
            "def ome_tiff_info(request, imageId, conn=None, **kwargs):",
            "    \"\"\"",
            "    Query to see if we have an OME-TIFF attached to the image (assume only 1,",
            "    since Batch Image Export will delete old ones)",
            "    \"\"\"",
            "    # Any existing OME-TIFF will appear in list",
            "    links = list(",
            "        conn.getAnnotationLinks(",
            "            \"Image\", [imageId], ns=omero.constants.namespaces.NSOMETIFF",
            "        )",
            "    )",
            "    rv = {}",
            "    if len(links) > 0:",
            "        # use highest ID === most recent",
            "        links.sort(key=lambda x: x.getId(), reverse=True)",
            "        annlink = links[0]",
            "        created = annlink.creationEventDate()",
            "        annId = annlink.getChild().getId()",
            "        from omeroweb.webgateway.templatetags.common_filters import ago",
            "",
            "        download = reverse(\"download_annotation\", args=[annId])",
            "        rv = {",
            "            \"created\": str(created),",
            "            \"ago\": ago(created),",
            "            \"id\": annId,",
            "            \"download\": download,",
            "        }",
            "    return rv  # will get returned as json by default"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "70": [],
            "2874": [
                "manage_action_containers"
            ],
            "2875": [
                "manage_action_containers"
            ],
            "2876": [
                "manage_action_containers"
            ],
            "2877": [
                "manage_action_containers"
            ],
            "2878": [
                "manage_action_containers"
            ],
            "2879": [
                "manage_action_containers"
            ],
            "2880": [
                "manage_action_containers"
            ],
            "2881": [
                "manage_action_containers"
            ],
            "2882": [
                "manage_action_containers"
            ],
            "2883": [
                "manage_action_containers"
            ],
            "2884": [
                "manage_action_containers"
            ],
            "2885": [
                "manage_action_containers"
            ],
            "2886": [
                "manage_action_containers"
            ],
            "2887": [
                "manage_action_containers"
            ],
            "2888": [
                "manage_action_containers"
            ],
            "2889": [
                "manage_action_containers"
            ],
            "2890": [
                "manage_action_containers"
            ],
            "2891": [
                "manage_action_containers"
            ],
            "2892": [
                "manage_action_containers"
            ],
            "2893": [
                "manage_action_containers"
            ],
            "2894": [
                "manage_action_containers"
            ],
            "2895": [
                "manage_action_containers"
            ],
            "2896": [
                "manage_action_containers"
            ],
            "2897": [
                "manage_action_containers"
            ],
            "2898": [
                "manage_action_containers"
            ],
            "2899": [
                "manage_action_containers"
            ],
            "2900": [
                "manage_action_containers"
            ],
            "2901": [
                "manage_action_containers"
            ],
            "2902": [
                "manage_action_containers"
            ],
            "2903": [
                "manage_action_containers"
            ],
            "2904": [
                "manage_action_containers"
            ],
            "2905": [
                "manage_action_containers"
            ],
            "2906": [
                "manage_action_containers"
            ],
            "2907": [
                "manage_action_containers"
            ],
            "2908": [
                "manage_action_containers"
            ],
            "2909": [
                "manage_action_containers"
            ],
            "2910": [
                "manage_action_containers"
            ],
            "2911": [
                "manage_action_containers"
            ],
            "2912": [
                "manage_action_containers"
            ],
            "2913": [
                "manage_action_containers"
            ],
            "2914": [
                "manage_action_containers"
            ]
        },
        "addLocation": []
    }
}