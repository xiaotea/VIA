{
    "modoboa/core/templatetags/core_tags.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 79,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 80,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 81,
                "PatchRowcode": " @register.simple_tag"
            },
            "3": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-def user_menu(user, selection):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+def user_menu(request, selection):"
            },
            "5": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "     entries = ["
            },
            "6": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "         {\"name\": \"user\","
            },
            "7": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 85,
                "PatchRowcode": "          \"img\": \"fa fa-user\","
            },
            "8": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-         \"label\": user.fullname,"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+         \"label\": request.user.fullname,"
            },
            "10": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "          \"menu\": ["
            },
            "11": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "                 {\"name\": \"settings\","
            },
            "12": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "                  \"img\": \"fa fa-list\","
            },
            "13": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "     ]"
            },
            "14": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 94,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "     extra_entries = signals.extra_user_menu_entries.send("
            },
            "16": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        sender=\"user_menu\", location=\"options_menu\", user=user)"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+        sender=\"user_menu\", location=\"options_menu\", user=request.user)"
            },
            "18": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "     extra_entries = reduce("
            },
            "19": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "         lambda a, b: a + b, [entry[1] for entry in extra_entries])"
            },
            "20": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "     entries[0][\"menu\"] += ("
            },
            "21": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        extra_entries + [{\"name\": \"logout\","
            },
            "22": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                          \"url\": reverse(\"core:logout\"),"
            },
            "23": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                          \"label\": _(\"Logout\"),"
            },
            "24": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                          \"img\": \"fa fa-sign-out\"}]"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+        extra_entries + [{"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 101,
                "PatchRowcode": "+            \"name\": \"logout\","
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+            \"url\": reverse(\"core:logout\"),"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+            \"label\": _(\"Logout\"),"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+            \"img\": \"fa fa-sign-out\","
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+            \"method\": \"post\""
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+        }]"
            },
            "32": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 107,
                "PatchRowcode": "     )"
            },
            "33": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 108,
                "PatchRowcode": "     return render_to_string(\"common/menulist.html\", {"
            },
            "34": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        \"selection\": selection, \"entries\": entries, \"user\": user"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 109,
                "PatchRowcode": "+        \"request\": request, \"selection\": selection,"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+        \"entries\": entries, \"user\": request.user"
            },
            "37": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "     })"
            },
            "38": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": 112,
                "PatchRowcode": " "
            },
            "39": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": 113,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "\"\"\"Custom tags for Core application.\"\"\"",
            "",
            "import os",
            "import re",
            "from functools import reduce",
            "",
            "import pkg_resources",
            "",
            "from django import template",
            "from django.conf import settings",
            "from django.contrib.sessions.models import Session",
            "from django.template.loader import render_to_string",
            "from django.urls import reverse",
            "from django.utils import timezone",
            "from django.utils.encoding import smart_str",
            "from django.utils.safestring import mark_safe",
            "from django.utils.translation import get_language, gettext as _",
            "",
            "from .. import models",
            "from .. import signals",
            "",
            "register = template.Library()",
            "",
            "",
            "@register.simple_tag",
            "def core_menu(selection, user):",
            "    \"\"\"Build the top level menu.\"\"\"",
            "    entries = signals.extra_admin_menu_entries.send(",
            "        sender=\"core_menu\", location=\"top_menu\", user=user)",
            "    entries = reduce(lambda a, b: a + b, [entry[1] for entry in entries])",
            "    if user.is_superuser:",
            "        entries += [",
            "            {\"name\": \"settings\",",
            "             \"label\": _(\"Modoboa\"),",
            "             \"url\": reverse(\"core:index\")}",
            "        ]",
            "    if not len(entries):",
            "        return \"\"",
            "    return render_to_string(\"common/menulist.html\", {",
            "        \"entries\": entries,",
            "        \"selection\": selection,",
            "        \"user\": user}",
            "    )",
            "",
            "",
            "@register.simple_tag",
            "def extensions_menu(selection, user):",
            "    menu = signals.extra_user_menu_entries.send(",
            "        sender=\"core_menu\", location=\"top_menu\", user=user)",
            "    menu = reduce(lambda a, b: a + b, [entry[1] for entry in menu])",
            "    return render_to_string(\"common/menulist.html\", {",
            "        \"selection\": selection, \"entries\": menu, \"user\": user",
            "    })",
            "",
            "",
            "@register.simple_tag",
            "def admin_menu(selection, user):",
            "    entries = [",
            "        {\"name\": \"info\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"info/\",",
            "         \"label\": _(\"Information\")},",
            "        {\"name\": \"logs\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"logs/?sort_order=-date_created\",",
            "         \"label\": _(\"Logs\")},",
            "        {\"name\": \"parameters\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"parameters/\",",
            "         \"img\": \"\",",
            "         \"label\": _(\"Parameters\")},",
            "    ]",
            "    return render_to_string(\"common/menu.html\", {",
            "        \"entries\": entries,",
            "        \"css\": \"nav nav-sidebar\",",
            "        \"selection\": selection,",
            "        \"user\": user",
            "    })",
            "",
            "",
            "@register.simple_tag",
            "def user_menu(user, selection):",
            "    entries = [",
            "        {\"name\": \"user\",",
            "         \"img\": \"fa fa-user\",",
            "         \"label\": user.fullname,",
            "         \"menu\": [",
            "                {\"name\": \"settings\",",
            "                 \"img\": \"fa fa-list\",",
            "                 \"label\": _(\"Settings\"),",
            "                 \"url\": reverse(\"core:user_index\")}",
            "         ]}",
            "    ]",
            "",
            "    extra_entries = signals.extra_user_menu_entries.send(",
            "        sender=\"user_menu\", location=\"options_menu\", user=user)",
            "    extra_entries = reduce(",
            "        lambda a, b: a + b, [entry[1] for entry in extra_entries])",
            "    entries[0][\"menu\"] += (",
            "        extra_entries + [{\"name\": \"logout\",",
            "                          \"url\": reverse(\"core:logout\"),",
            "                          \"label\": _(\"Logout\"),",
            "                          \"img\": \"fa fa-sign-out\"}]",
            "    )",
            "    return render_to_string(\"common/menulist.html\", {",
            "        \"selection\": selection, \"entries\": entries, \"user\": user",
            "    })",
            "",
            "",
            "@register.simple_tag",
            "def uprefs_menu(selection, user):",
            "    entries = [",
            "        {\"name\": \"profile\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"profile/\",",
            "         \"label\": _(\"Profile\")},",
            "        {\"name\": \"preferences\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"preferences/\",",
            "         \"label\": _(\"Preferences\")},",
            "        {\"name\": \"security\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"security/\",",
            "         \"label\": _(\"Security\")},",
            "    ]",
            "    if user.is_superuser:",
            "        entries.append({",
            "            \"name\": \"api\",",
            "            \"class\": \"ajaxnav\",",
            "            \"url\": \"api/\",",
            "            \"label\": _(\"API\"),",
            "        })",
            "    extra_entries = signals.extra_user_menu_entries.send(",
            "        sender=\"user_menu\", location=\"uprefs_menu\", user=user)",
            "    extra_entries = reduce(",
            "        lambda a, b: a + b, [entry[1] for entry in extra_entries])",
            "    entries += extra_entries",
            "    entries = sorted(entries, key=lambda e: e[\"label\"])",
            "    return render_to_string(\"common/menu.html\", {",
            "        \"entries\": entries,",
            "        \"css\": \"nav nav-sidebar\",",
            "        \"selection\": selection,",
            "        \"user\": user",
            "    })",
            "",
            "",
            "@register.filter",
            "def colorize_level(level):",
            "    \"\"\"A simple filter a text using a boostrap color.\"\"\"",
            "    classes = {",
            "        \"INFO\": \"text-info\",",
            "        \"WARNING\": \"text-warning\",",
            "        \"CRITICAL\": \"text-danger\"",
            "    }",
            "    if level not in classes:",
            "        return level",
            "    return \"<p class='%s'>%s</p>\" % (classes[level], level)",
            "",
            "",
            "@register.filter",
            "def tohtml(message):",
            "    \"\"\"Simple tag to format a text using HTML.\"\"\"",
            "    return re.sub(r\"'(.*?)'\", r\"<strong>\\g<1></strong>\", message)",
            "",
            "",
            "@register.simple_tag",
            "def visirule(field):",
            "    if not hasattr(field, \"form\") or \\",
            "            not hasattr(field.form, \"visirules\") or \\",
            "            field.html_name not in field.form.visirules:",
            "        return \"\"",
            "    rule = field.form.visirules[field.html_name]",
            "    return mark_safe(",
            "        \" data-visibility-field='{}' data-visibility-value='{}' \"",
            "        .format(rule[\"field\"], rule[\"value\"]))",
            "",
            "",
            "@register.simple_tag",
            "def get_version():",
            "    return pkg_resources.get_distribution(\"modoboa\").version",
            "",
            "",
            "class ConnectedUsers(template.Node):",
            "",
            "    def __init__(self, varname):",
            "        self.varname = varname",
            "",
            "    def render(self, context):",
            "        sessions = Session.objects.filter(expire_date__gte=timezone.now())",
            "        uid_list = []",
            "        # Build a list of user ids from that query",
            "        for session in sessions:",
            "            data = session.get_decoded()",
            "            uid = data.get(\"_auth_user_id\", None)",
            "            if uid:",
            "                uid_list.append(uid)",
            "",
            "        # Query all logged in users based on id list",
            "        context[self.varname] = (",
            "            models.User.objects.filter(pk__in=uid_list).distinct())",
            "        return \"\"",
            "",
            "",
            "@register.tag",
            "def connected_users(parser, token):",
            "    try:",
            "        tag, a, varname = token.split_contents()",
            "    except ValueError:",
            "        raise template.TemplateSyntaxError(",
            "            \"connected_users usage: {% connected_users as users %}\"",
            "        )",
            "    return ConnectedUsers(varname)",
            "",
            "",
            "@register.simple_tag",
            "def get_modoboa_logo():",
            "    try:",
            "        logo = settings.MODOBOA_CUSTOM_LOGO",
            "    except AttributeError:",
            "        logo = None",
            "    if logo is None:",
            "        return os.path.join(settings.STATIC_URL, \"css/modoboa.png\")",
            "    return logo",
            "",
            "",
            "@register.simple_tag",
            "def load_optionalmenu(user):",
            "    menu = signals.extra_user_menu_entries.send(",
            "        sender=\"user_menu\", location=\"top_menu_middle\", user=user)",
            "    menu = reduce(",
            "        lambda a, b: a + b, [entry[1] for entry in menu])",
            "    return template.loader.render_to_string(",
            "        \"common/menulist.html\",",
            "        {\"entries\": menu, \"user\": user}",
            "    )",
            "",
            "",
            "@register.simple_tag",
            "def display_messages(msgs):",
            "    text = \"\"",
            "    level = \"info\"",
            "    for m in msgs:",
            "        level = m.tags",
            "        text += smart_str(m) + \"\\\\\\n\"",
            "",
            "    if level == \"info\":",
            "        level = \"success\"",
            "        timeout = \"2000\"",
            "    else:",
            "        timeout = \"undefined\"",
            "",
            "    return mark_safe(\"\"\"",
            "<script type=\"text/javascript\">",
            "    $(document).ready(function() {",
            "        $('body').notify('%s', '%s', %s);",
            "    });",
            "</script>",
            "\"\"\" % (level, text, timeout))",
            "",
            "",
            "@register.filter",
            "def currencyfmt(amount):",
            "    \"\"\"Simple temp. filter to replace babel.\"\"\"",
            "    lang = get_language()",
            "    if lang == \"fr\":",
            "        return u\"{} \u20ac\".format(amount)",
            "    return u\"\u20ac{}\".format(amount)"
        ],
        "afterPatchFile": [
            "\"\"\"Custom tags for Core application.\"\"\"",
            "",
            "import os",
            "import re",
            "from functools import reduce",
            "",
            "import pkg_resources",
            "",
            "from django import template",
            "from django.conf import settings",
            "from django.contrib.sessions.models import Session",
            "from django.template.loader import render_to_string",
            "from django.urls import reverse",
            "from django.utils import timezone",
            "from django.utils.encoding import smart_str",
            "from django.utils.safestring import mark_safe",
            "from django.utils.translation import get_language, gettext as _",
            "",
            "from .. import models",
            "from .. import signals",
            "",
            "register = template.Library()",
            "",
            "",
            "@register.simple_tag",
            "def core_menu(selection, user):",
            "    \"\"\"Build the top level menu.\"\"\"",
            "    entries = signals.extra_admin_menu_entries.send(",
            "        sender=\"core_menu\", location=\"top_menu\", user=user)",
            "    entries = reduce(lambda a, b: a + b, [entry[1] for entry in entries])",
            "    if user.is_superuser:",
            "        entries += [",
            "            {\"name\": \"settings\",",
            "             \"label\": _(\"Modoboa\"),",
            "             \"url\": reverse(\"core:index\")}",
            "        ]",
            "    if not len(entries):",
            "        return \"\"",
            "    return render_to_string(\"common/menulist.html\", {",
            "        \"entries\": entries,",
            "        \"selection\": selection,",
            "        \"user\": user}",
            "    )",
            "",
            "",
            "@register.simple_tag",
            "def extensions_menu(selection, user):",
            "    menu = signals.extra_user_menu_entries.send(",
            "        sender=\"core_menu\", location=\"top_menu\", user=user)",
            "    menu = reduce(lambda a, b: a + b, [entry[1] for entry in menu])",
            "    return render_to_string(\"common/menulist.html\", {",
            "        \"selection\": selection, \"entries\": menu, \"user\": user",
            "    })",
            "",
            "",
            "@register.simple_tag",
            "def admin_menu(selection, user):",
            "    entries = [",
            "        {\"name\": \"info\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"info/\",",
            "         \"label\": _(\"Information\")},",
            "        {\"name\": \"logs\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"logs/?sort_order=-date_created\",",
            "         \"label\": _(\"Logs\")},",
            "        {\"name\": \"parameters\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"parameters/\",",
            "         \"img\": \"\",",
            "         \"label\": _(\"Parameters\")},",
            "    ]",
            "    return render_to_string(\"common/menu.html\", {",
            "        \"entries\": entries,",
            "        \"css\": \"nav nav-sidebar\",",
            "        \"selection\": selection,",
            "        \"user\": user",
            "    })",
            "",
            "",
            "@register.simple_tag",
            "def user_menu(request, selection):",
            "    entries = [",
            "        {\"name\": \"user\",",
            "         \"img\": \"fa fa-user\",",
            "         \"label\": request.user.fullname,",
            "         \"menu\": [",
            "                {\"name\": \"settings\",",
            "                 \"img\": \"fa fa-list\",",
            "                 \"label\": _(\"Settings\"),",
            "                 \"url\": reverse(\"core:user_index\")}",
            "         ]}",
            "    ]",
            "",
            "    extra_entries = signals.extra_user_menu_entries.send(",
            "        sender=\"user_menu\", location=\"options_menu\", user=request.user)",
            "    extra_entries = reduce(",
            "        lambda a, b: a + b, [entry[1] for entry in extra_entries])",
            "    entries[0][\"menu\"] += (",
            "        extra_entries + [{",
            "            \"name\": \"logout\",",
            "            \"url\": reverse(\"core:logout\"),",
            "            \"label\": _(\"Logout\"),",
            "            \"img\": \"fa fa-sign-out\",",
            "            \"method\": \"post\"",
            "        }]",
            "    )",
            "    return render_to_string(\"common/menulist.html\", {",
            "        \"request\": request, \"selection\": selection,",
            "        \"entries\": entries, \"user\": request.user",
            "    })",
            "",
            "",
            "@register.simple_tag",
            "def uprefs_menu(selection, user):",
            "    entries = [",
            "        {\"name\": \"profile\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"profile/\",",
            "         \"label\": _(\"Profile\")},",
            "        {\"name\": \"preferences\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"preferences/\",",
            "         \"label\": _(\"Preferences\")},",
            "        {\"name\": \"security\",",
            "         \"class\": \"ajaxnav\",",
            "         \"url\": \"security/\",",
            "         \"label\": _(\"Security\")},",
            "    ]",
            "    if user.is_superuser:",
            "        entries.append({",
            "            \"name\": \"api\",",
            "            \"class\": \"ajaxnav\",",
            "            \"url\": \"api/\",",
            "            \"label\": _(\"API\"),",
            "        })",
            "    extra_entries = signals.extra_user_menu_entries.send(",
            "        sender=\"user_menu\", location=\"uprefs_menu\", user=user)",
            "    extra_entries = reduce(",
            "        lambda a, b: a + b, [entry[1] for entry in extra_entries])",
            "    entries += extra_entries",
            "    entries = sorted(entries, key=lambda e: e[\"label\"])",
            "    return render_to_string(\"common/menu.html\", {",
            "        \"entries\": entries,",
            "        \"css\": \"nav nav-sidebar\",",
            "        \"selection\": selection,",
            "        \"user\": user",
            "    })",
            "",
            "",
            "@register.filter",
            "def colorize_level(level):",
            "    \"\"\"A simple filter a text using a boostrap color.\"\"\"",
            "    classes = {",
            "        \"INFO\": \"text-info\",",
            "        \"WARNING\": \"text-warning\",",
            "        \"CRITICAL\": \"text-danger\"",
            "    }",
            "    if level not in classes:",
            "        return level",
            "    return \"<p class='%s'>%s</p>\" % (classes[level], level)",
            "",
            "",
            "@register.filter",
            "def tohtml(message):",
            "    \"\"\"Simple tag to format a text using HTML.\"\"\"",
            "    return re.sub(r\"'(.*?)'\", r\"<strong>\\g<1></strong>\", message)",
            "",
            "",
            "@register.simple_tag",
            "def visirule(field):",
            "    if not hasattr(field, \"form\") or \\",
            "            not hasattr(field.form, \"visirules\") or \\",
            "            field.html_name not in field.form.visirules:",
            "        return \"\"",
            "    rule = field.form.visirules[field.html_name]",
            "    return mark_safe(",
            "        \" data-visibility-field='{}' data-visibility-value='{}' \"",
            "        .format(rule[\"field\"], rule[\"value\"]))",
            "",
            "",
            "@register.simple_tag",
            "def get_version():",
            "    return pkg_resources.get_distribution(\"modoboa\").version",
            "",
            "",
            "class ConnectedUsers(template.Node):",
            "",
            "    def __init__(self, varname):",
            "        self.varname = varname",
            "",
            "    def render(self, context):",
            "        sessions = Session.objects.filter(expire_date__gte=timezone.now())",
            "        uid_list = []",
            "        # Build a list of user ids from that query",
            "        for session in sessions:",
            "            data = session.get_decoded()",
            "            uid = data.get(\"_auth_user_id\", None)",
            "            if uid:",
            "                uid_list.append(uid)",
            "",
            "        # Query all logged in users based on id list",
            "        context[self.varname] = (",
            "            models.User.objects.filter(pk__in=uid_list).distinct())",
            "        return \"\"",
            "",
            "",
            "@register.tag",
            "def connected_users(parser, token):",
            "    try:",
            "        tag, a, varname = token.split_contents()",
            "    except ValueError:",
            "        raise template.TemplateSyntaxError(",
            "            \"connected_users usage: {% connected_users as users %}\"",
            "        )",
            "    return ConnectedUsers(varname)",
            "",
            "",
            "@register.simple_tag",
            "def get_modoboa_logo():",
            "    try:",
            "        logo = settings.MODOBOA_CUSTOM_LOGO",
            "    except AttributeError:",
            "        logo = None",
            "    if logo is None:",
            "        return os.path.join(settings.STATIC_URL, \"css/modoboa.png\")",
            "    return logo",
            "",
            "",
            "@register.simple_tag",
            "def load_optionalmenu(user):",
            "    menu = signals.extra_user_menu_entries.send(",
            "        sender=\"user_menu\", location=\"top_menu_middle\", user=user)",
            "    menu = reduce(",
            "        lambda a, b: a + b, [entry[1] for entry in menu])",
            "    return template.loader.render_to_string(",
            "        \"common/menulist.html\",",
            "        {\"entries\": menu, \"user\": user}",
            "    )",
            "",
            "",
            "@register.simple_tag",
            "def display_messages(msgs):",
            "    text = \"\"",
            "    level = \"info\"",
            "    for m in msgs:",
            "        level = m.tags",
            "        text += smart_str(m) + \"\\\\\\n\"",
            "",
            "    if level == \"info\":",
            "        level = \"success\"",
            "        timeout = \"2000\"",
            "    else:",
            "        timeout = \"undefined\"",
            "",
            "    return mark_safe(\"\"\"",
            "<script type=\"text/javascript\">",
            "    $(document).ready(function() {",
            "        $('body').notify('%s', '%s', %s);",
            "    });",
            "</script>",
            "\"\"\" % (level, text, timeout))",
            "",
            "",
            "@register.filter",
            "def currencyfmt(amount):",
            "    \"\"\"Simple temp. filter to replace babel.\"\"\"",
            "    lang = get_language()",
            "    if lang == \"fr\":",
            "        return u\"{} \u20ac\".format(amount)",
            "    return u\"\u20ac{}\".format(amount)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "82": [
                "user_menu"
            ],
            "86": [
                "user_menu"
            ],
            "96": [
                "user_menu"
            ],
            "100": [
                "user_menu"
            ],
            "101": [
                "user_menu"
            ],
            "102": [
                "user_menu"
            ],
            "103": [
                "user_menu"
            ],
            "106": [
                "user_menu"
            ]
        },
        "addLocation": []
    },
    "modoboa/core/views/auth.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from django.utils.translation import gettext as _"
            },
            "1": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from django.views import generic"
            },
            "2": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from django.views.decorators.cache import never_cache"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+from django.views.decorators.http import require_http_methods"
            },
            "4": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from django.contrib.auth import ("
            },
            "6": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": "     authenticate, login, logout, views as auth_views"
            },
            "7": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 127,
                "PatchRowcode": " dologin = never_cache(dologin)"
            },
            "8": {
                "beforePatchRowNumber": 127,
                "afterPatchRowNumber": 128,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 128,
                "afterPatchRowNumber": 129,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+@require_http_methods([\"POST\"])"
            },
            "11": {
                "beforePatchRowNumber": 129,
                "afterPatchRowNumber": 131,
                "PatchRowcode": " def dologout(request):"
            },
            "12": {
                "beforePatchRowNumber": 130,
                "afterPatchRowNumber": 132,
                "PatchRowcode": "     \"\"\"Logout current user.\"\"\""
            },
            "13": {
                "beforePatchRowNumber": 131,
                "afterPatchRowNumber": 133,
                "PatchRowcode": "     if not request.user.is_anonymous:"
            }
        },
        "frontPatchFile": [
            "\"\"\"Core authentication views.\"\"\"",
            "",
            "import logging",
            "",
            "import oath",
            "",
            "from django.conf import settings",
            "from django.http import (",
            "    HttpResponse, HttpResponseRedirect, Http404, JsonResponse)",
            "from django.template.loader import render_to_string",
            "from django.urls import reverse",
            "from django.utils import translation",
            "from django.utils.encoding import force_bytes",
            "from django.utils.html import escape",
            "from django.utils.http import urlsafe_base64_encode",
            "from django.utils.translation import gettext as _",
            "from django.views import generic",
            "from django.views.decorators.cache import never_cache",
            "",
            "from django.contrib.auth import (",
            "    authenticate, login, logout, views as auth_views",
            ")",
            "from django.contrib.auth.mixins import LoginRequiredMixin",
            "from django.contrib.auth.tokens import default_token_generator",
            "",
            "import django_otp",
            "",
            "from modoboa.core import forms",
            "from modoboa.core.password_hashers import get_password_hasher",
            "from modoboa.lib import cryptutils",
            "from modoboa.lib.views import UserFormKwargsMixin",
            "from modoboa.parameters import tools as param_tools",
            "",
            "from .. import models",
            "from .. import sms_backends",
            "from .. import signals",
            "from .base import find_nextlocation",
            "",
            "logger = logging.getLogger(\"modoboa.auth\")",
            "",
            "",
            "def dologin(request):",
            "    \"\"\"Try to authenticate.\"\"\"",
            "    error = None",
            "    if request.method == \"POST\":",
            "        form = forms.LoginForm(request.POST)",
            "        if form.is_valid():",
            "            logger = logging.getLogger(\"modoboa.auth\")",
            "            user = authenticate(username=form.cleaned_data[\"username\"],",
            "                                password=form.cleaned_data[\"password\"])",
            "            if user and user.is_active:",
            "                condition = (",
            "                    user.is_local and",
            "                    param_tools.get_global_parameter(",
            "                        \"update_scheme\", raise_exception=False)",
            "                )",
            "                if condition:",
            "                    # check if password scheme is correct",
            "                    scheme = param_tools.get_global_parameter(",
            "                        \"password_scheme\", raise_exception=False)",
            "                    # use SHA512CRYPT as default fallback",
            "                    if scheme is None:",
            "                        pwhash = get_password_hasher('sha512crypt')()",
            "                    else:",
            "                        pwhash = get_password_hasher(scheme)()",
            "                    if not user.password.startswith(pwhash.scheme):",
            "                        logging.info(",
            "                            _(\"Password scheme mismatch. Updating %s password\"),",
            "                            user.username",
            "                        )",
            "                        user.set_password(form.cleaned_data[\"password\"])",
            "                        user.save()",
            "                    if pwhash.needs_rehash(user.password):",
            "                        logging.info(",
            "                            _(\"Password hash parameter missmatch. \"",
            "                              \"Updating %s password\"),",
            "                            user.username",
            "                        )",
            "                        user.set_password(form.cleaned_data[\"password\"])",
            "                        user.save()",
            "",
            "                login(request, user)",
            "                if not form.cleaned_data[\"rememberme\"]:",
            "                    request.session.set_expiry(0)",
            "",
            "                translation.activate(request.user.language)",
            "",
            "                logger.info(",
            "                    _(\"User '%s' successfully logged in\") % user.username",
            "                )",
            "                signals.user_login.send(",
            "                    sender=\"dologin\",",
            "                    username=form.cleaned_data[\"username\"],",
            "                    password=form.cleaned_data[\"password\"])",
            "                response = HttpResponseRedirect(find_nextlocation(request, user))",
            "                response.set_cookie(settings.LANGUAGE_COOKIE_NAME, request.user.language)",
            "                return response",
            "",
            "            error = _(",
            "                \"Your username and password didn't match. Please try again.\")",
            "            logger.warning(",
            "                \"Failed connection attempt from '%(addr)s' as user '%(user)s'\"",
            "                % {\"addr\": request.META[\"REMOTE_ADDR\"],",
            "                   \"user\": escape(form.cleaned_data[\"username\"])}",
            "            )",
            "",
            "        nextlocation = request.POST.get(\"next\", \"\")",
            "        httpcode = 401",
            "    else:",
            "        form = forms.LoginForm()",
            "        nextlocation = request.GET.get(\"next\", \"\")",
            "        httpcode = 200",
            "",
            "    announcements = signals.get_announcements.send(",
            "        sender=\"login\", location=\"loginpage\")",
            "    announcements = [announcement[1] for announcement in announcements]",
            "    return HttpResponse(",
            "        render_to_string(",
            "            \"registration/login.html\", {",
            "                \"form\": form, \"error\": error, \"next\": nextlocation,",
            "                \"annoucements\": announcements},",
            "            request),",
            "        status=httpcode)",
            "",
            "",
            "dologin = never_cache(dologin)",
            "",
            "",
            "def dologout(request):",
            "    \"\"\"Logout current user.\"\"\"",
            "    if not request.user.is_anonymous:",
            "        signals.user_logout.send(sender=\"dologout\", request=request)",
            "        logger = logging.getLogger(\"modoboa.auth\")",
            "        logger.info(",
            "            _(\"User '{}' successfully logged out\").format(",
            "                request.user.username))",
            "        logout(request)",
            "    return HttpResponseRedirect(reverse(\"core:login\"))",
            "",
            "",
            "class PasswordResetView(auth_views.PasswordResetView):",
            "    \"\"\"Custom view to override form.\"\"\"",
            "",
            "    form_class = forms.PasswordResetForm",
            "",
            "    def setup(self, request, *args, **kwargs):",
            "        super().setup(request, *args, **kwargs)",
            "        self.from_email = request.localconfig.parameters.get_value(",
            "            \"sender_address\"",
            "        )",
            "",
            "    def get_context_data(self, **kwargs):",
            "        \"\"\"Include help text.\"\"\"",
            "        context = super().get_context_data(**kwargs)",
            "        context[\"announcement\"] = (",
            "            self.request.localconfig.parameters",
            "            .get_value(\"password_recovery_msg\")",
            "        )",
            "        return context",
            "",
            "    def form_valid(self, form):",
            "        \"\"\"Redirect to code verification page if needed.\"\"\"",
            "        sms_password_recovery = (",
            "            self.request.localconfig.parameters",
            "            .get_value(\"sms_password_recovery\")",
            "        )",
            "        if not sms_password_recovery:",
            "            return super().form_valid(form)",
            "        user = models.User._default_manager.filter(",
            "            email=form.cleaned_data[\"email\"], phone_number__isnull=False",
            "        ).first()",
            "        if not user:",
            "            # Fallback to email",
            "            return super().form_valid(form)",
            "        backend = sms_backends.get_active_backend(",
            "            self.request.localconfig.parameters)",
            "        secret = cryptutils.random_hex_key(20)",
            "        code = oath.totp(secret)",
            "        text = _(",
            "            \"Please use the following code to recover your Modoboa password: {}\"",
            "            .format(code)",
            "        )",
            "        if not backend.send(text, [str(user.phone_number)]):",
            "            return super().form_valid(form)",
            "        self.request.session[\"user_pk\"] = user.pk",
            "        self.request.session[\"totp_secret\"] = secret",
            "        return HttpResponseRedirect(reverse(\"password_reset_confirm_code\"))",
            "",
            "",
            "class VerifySMSCodeView(generic.FormView):",
            "    \"\"\"View to verify a code received by SMS.\"\"\"",
            "",
            "    form_class = forms.VerifySMSCodeForm",
            "    template_name = \"registration/password_reset_confirm_code.html\"",
            "",
            "    def get_form_kwargs(self):",
            "        \"\"\"Include totp secret in kwargs.\"\"\"",
            "        kwargs = super().get_form_kwargs()",
            "        try:",
            "            kwargs.update({\"totp_secret\": self.request.session[\"totp_secret\"]})",
            "        except KeyError:",
            "            raise Http404",
            "        return kwargs",
            "",
            "    def form_valid(self, form):",
            "        \"\"\"Redirect to reset password form.\"\"\"",
            "        user = models.User.objects.get(pk=self.request.session.pop(\"user_pk\"))",
            "        self.request.session.pop(\"totp_secret\")",
            "        token = default_token_generator.make_token(user)",
            "        uid = urlsafe_base64_encode(force_bytes(user.pk))",
            "        url = reverse(\"password_reset_confirm\", args=[uid, token])",
            "        return HttpResponseRedirect(url)",
            "",
            "",
            "class ResendSMSCodeView(generic.View):",
            "    \"\"\"A view to resend validation code.\"\"\"",
            "",
            "    def get(self, request, *args, **kwargs):",
            "        sms_password_recovery = (",
            "            self.request.localconfig.parameters",
            "            .get_value(\"sms_password_recovery\")",
            "        )",
            "        if not sms_password_recovery:",
            "            raise Http404",
            "        try:",
            "            user = models.User._default_manager.get(",
            "                pk=self.request.session[\"user_pk\"])",
            "        except KeyError:",
            "            raise Http404",
            "        backend = sms_backends.get_active_backend(",
            "            self.request.localconfig.parameters)",
            "        secret = cryptutils.random_hex_key(20)",
            "        code = oath.totp(secret)",
            "        text = _(",
            "            \"Please use the following code to recover your Modoboa password: {}\"",
            "            .format(code)",
            "        )",
            "        if not backend.send(text, [user.phone_number]):",
            "            raise Http404",
            "        self.request.session[\"totp_secret\"] = secret",
            "        return JsonResponse({\"status\": \"ok\"})",
            "",
            "",
            "class TwoFactorCodeVerifyView(LoginRequiredMixin,",
            "                              UserFormKwargsMixin,",
            "                              generic.FormView):",
            "    \"\"\"View to verify a 2FA code after login.\"\"\"",
            "",
            "    form_class = forms.Verify2FACodeForm",
            "    template_name = \"registration/twofactor_code_verify.html\"",
            "",
            "    def form_valid(self, form):",
            "        \"\"\"Login user.\"\"\"",
            "        django_otp.login(self.request, form.cleaned_data[\"tfa_code\"])",
            "        return HttpResponseRedirect(",
            "            find_nextlocation(self.request, self.request.user)",
            "        )"
        ],
        "afterPatchFile": [
            "\"\"\"Core authentication views.\"\"\"",
            "",
            "import logging",
            "",
            "import oath",
            "",
            "from django.conf import settings",
            "from django.http import (",
            "    HttpResponse, HttpResponseRedirect, Http404, JsonResponse)",
            "from django.template.loader import render_to_string",
            "from django.urls import reverse",
            "from django.utils import translation",
            "from django.utils.encoding import force_bytes",
            "from django.utils.html import escape",
            "from django.utils.http import urlsafe_base64_encode",
            "from django.utils.translation import gettext as _",
            "from django.views import generic",
            "from django.views.decorators.cache import never_cache",
            "from django.views.decorators.http import require_http_methods",
            "",
            "from django.contrib.auth import (",
            "    authenticate, login, logout, views as auth_views",
            ")",
            "from django.contrib.auth.mixins import LoginRequiredMixin",
            "from django.contrib.auth.tokens import default_token_generator",
            "",
            "import django_otp",
            "",
            "from modoboa.core import forms",
            "from modoboa.core.password_hashers import get_password_hasher",
            "from modoboa.lib import cryptutils",
            "from modoboa.lib.views import UserFormKwargsMixin",
            "from modoboa.parameters import tools as param_tools",
            "",
            "from .. import models",
            "from .. import sms_backends",
            "from .. import signals",
            "from .base import find_nextlocation",
            "",
            "logger = logging.getLogger(\"modoboa.auth\")",
            "",
            "",
            "def dologin(request):",
            "    \"\"\"Try to authenticate.\"\"\"",
            "    error = None",
            "    if request.method == \"POST\":",
            "        form = forms.LoginForm(request.POST)",
            "        if form.is_valid():",
            "            logger = logging.getLogger(\"modoboa.auth\")",
            "            user = authenticate(username=form.cleaned_data[\"username\"],",
            "                                password=form.cleaned_data[\"password\"])",
            "            if user and user.is_active:",
            "                condition = (",
            "                    user.is_local and",
            "                    param_tools.get_global_parameter(",
            "                        \"update_scheme\", raise_exception=False)",
            "                )",
            "                if condition:",
            "                    # check if password scheme is correct",
            "                    scheme = param_tools.get_global_parameter(",
            "                        \"password_scheme\", raise_exception=False)",
            "                    # use SHA512CRYPT as default fallback",
            "                    if scheme is None:",
            "                        pwhash = get_password_hasher('sha512crypt')()",
            "                    else:",
            "                        pwhash = get_password_hasher(scheme)()",
            "                    if not user.password.startswith(pwhash.scheme):",
            "                        logging.info(",
            "                            _(\"Password scheme mismatch. Updating %s password\"),",
            "                            user.username",
            "                        )",
            "                        user.set_password(form.cleaned_data[\"password\"])",
            "                        user.save()",
            "                    if pwhash.needs_rehash(user.password):",
            "                        logging.info(",
            "                            _(\"Password hash parameter missmatch. \"",
            "                              \"Updating %s password\"),",
            "                            user.username",
            "                        )",
            "                        user.set_password(form.cleaned_data[\"password\"])",
            "                        user.save()",
            "",
            "                login(request, user)",
            "                if not form.cleaned_data[\"rememberme\"]:",
            "                    request.session.set_expiry(0)",
            "",
            "                translation.activate(request.user.language)",
            "",
            "                logger.info(",
            "                    _(\"User '%s' successfully logged in\") % user.username",
            "                )",
            "                signals.user_login.send(",
            "                    sender=\"dologin\",",
            "                    username=form.cleaned_data[\"username\"],",
            "                    password=form.cleaned_data[\"password\"])",
            "                response = HttpResponseRedirect(find_nextlocation(request, user))",
            "                response.set_cookie(settings.LANGUAGE_COOKIE_NAME, request.user.language)",
            "                return response",
            "",
            "            error = _(",
            "                \"Your username and password didn't match. Please try again.\")",
            "            logger.warning(",
            "                \"Failed connection attempt from '%(addr)s' as user '%(user)s'\"",
            "                % {\"addr\": request.META[\"REMOTE_ADDR\"],",
            "                   \"user\": escape(form.cleaned_data[\"username\"])}",
            "            )",
            "",
            "        nextlocation = request.POST.get(\"next\", \"\")",
            "        httpcode = 401",
            "    else:",
            "        form = forms.LoginForm()",
            "        nextlocation = request.GET.get(\"next\", \"\")",
            "        httpcode = 200",
            "",
            "    announcements = signals.get_announcements.send(",
            "        sender=\"login\", location=\"loginpage\")",
            "    announcements = [announcement[1] for announcement in announcements]",
            "    return HttpResponse(",
            "        render_to_string(",
            "            \"registration/login.html\", {",
            "                \"form\": form, \"error\": error, \"next\": nextlocation,",
            "                \"annoucements\": announcements},",
            "            request),",
            "        status=httpcode)",
            "",
            "",
            "dologin = never_cache(dologin)",
            "",
            "",
            "@require_http_methods([\"POST\"])",
            "def dologout(request):",
            "    \"\"\"Logout current user.\"\"\"",
            "    if not request.user.is_anonymous:",
            "        signals.user_logout.send(sender=\"dologout\", request=request)",
            "        logger = logging.getLogger(\"modoboa.auth\")",
            "        logger.info(",
            "            _(\"User '{}' successfully logged out\").format(",
            "                request.user.username))",
            "        logout(request)",
            "    return HttpResponseRedirect(reverse(\"core:login\"))",
            "",
            "",
            "class PasswordResetView(auth_views.PasswordResetView):",
            "    \"\"\"Custom view to override form.\"\"\"",
            "",
            "    form_class = forms.PasswordResetForm",
            "",
            "    def setup(self, request, *args, **kwargs):",
            "        super().setup(request, *args, **kwargs)",
            "        self.from_email = request.localconfig.parameters.get_value(",
            "            \"sender_address\"",
            "        )",
            "",
            "    def get_context_data(self, **kwargs):",
            "        \"\"\"Include help text.\"\"\"",
            "        context = super().get_context_data(**kwargs)",
            "        context[\"announcement\"] = (",
            "            self.request.localconfig.parameters",
            "            .get_value(\"password_recovery_msg\")",
            "        )",
            "        return context",
            "",
            "    def form_valid(self, form):",
            "        \"\"\"Redirect to code verification page if needed.\"\"\"",
            "        sms_password_recovery = (",
            "            self.request.localconfig.parameters",
            "            .get_value(\"sms_password_recovery\")",
            "        )",
            "        if not sms_password_recovery:",
            "            return super().form_valid(form)",
            "        user = models.User._default_manager.filter(",
            "            email=form.cleaned_data[\"email\"], phone_number__isnull=False",
            "        ).first()",
            "        if not user:",
            "            # Fallback to email",
            "            return super().form_valid(form)",
            "        backend = sms_backends.get_active_backend(",
            "            self.request.localconfig.parameters)",
            "        secret = cryptutils.random_hex_key(20)",
            "        code = oath.totp(secret)",
            "        text = _(",
            "            \"Please use the following code to recover your Modoboa password: {}\"",
            "            .format(code)",
            "        )",
            "        if not backend.send(text, [str(user.phone_number)]):",
            "            return super().form_valid(form)",
            "        self.request.session[\"user_pk\"] = user.pk",
            "        self.request.session[\"totp_secret\"] = secret",
            "        return HttpResponseRedirect(reverse(\"password_reset_confirm_code\"))",
            "",
            "",
            "class VerifySMSCodeView(generic.FormView):",
            "    \"\"\"View to verify a code received by SMS.\"\"\"",
            "",
            "    form_class = forms.VerifySMSCodeForm",
            "    template_name = \"registration/password_reset_confirm_code.html\"",
            "",
            "    def get_form_kwargs(self):",
            "        \"\"\"Include totp secret in kwargs.\"\"\"",
            "        kwargs = super().get_form_kwargs()",
            "        try:",
            "            kwargs.update({\"totp_secret\": self.request.session[\"totp_secret\"]})",
            "        except KeyError:",
            "            raise Http404",
            "        return kwargs",
            "",
            "    def form_valid(self, form):",
            "        \"\"\"Redirect to reset password form.\"\"\"",
            "        user = models.User.objects.get(pk=self.request.session.pop(\"user_pk\"))",
            "        self.request.session.pop(\"totp_secret\")",
            "        token = default_token_generator.make_token(user)",
            "        uid = urlsafe_base64_encode(force_bytes(user.pk))",
            "        url = reverse(\"password_reset_confirm\", args=[uid, token])",
            "        return HttpResponseRedirect(url)",
            "",
            "",
            "class ResendSMSCodeView(generic.View):",
            "    \"\"\"A view to resend validation code.\"\"\"",
            "",
            "    def get(self, request, *args, **kwargs):",
            "        sms_password_recovery = (",
            "            self.request.localconfig.parameters",
            "            .get_value(\"sms_password_recovery\")",
            "        )",
            "        if not sms_password_recovery:",
            "            raise Http404",
            "        try:",
            "            user = models.User._default_manager.get(",
            "                pk=self.request.session[\"user_pk\"])",
            "        except KeyError:",
            "            raise Http404",
            "        backend = sms_backends.get_active_backend(",
            "            self.request.localconfig.parameters)",
            "        secret = cryptutils.random_hex_key(20)",
            "        code = oath.totp(secret)",
            "        text = _(",
            "            \"Please use the following code to recover your Modoboa password: {}\"",
            "            .format(code)",
            "        )",
            "        if not backend.send(text, [user.phone_number]):",
            "            raise Http404",
            "        self.request.session[\"totp_secret\"] = secret",
            "        return JsonResponse({\"status\": \"ok\"})",
            "",
            "",
            "class TwoFactorCodeVerifyView(LoginRequiredMixin,",
            "                              UserFormKwargsMixin,",
            "                              generic.FormView):",
            "    \"\"\"View to verify a 2FA code after login.\"\"\"",
            "",
            "    form_class = forms.Verify2FACodeForm",
            "    template_name = \"registration/twofactor_code_verify.html\"",
            "",
            "    def form_valid(self, form):",
            "        \"\"\"Login user.\"\"\"",
            "        django_otp.login(self.request, form.cleaned_data[\"tfa_code\"])",
            "        return HttpResponseRedirect(",
            "            find_nextlocation(self.request, self.request.user)",
            "        )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": []
    },
    "modoboa/lib/templatetags/lib_tags.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from datetime import datetime"
            },
            "1": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " from django import template"
            },
            "3": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from django.template import Context, Template"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 6,
                "PatchRowcode": "+from django.template import Context, RequestContext, Template"
            },
            "5": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from django.utils.safestring import mark_safe"
            },
            "6": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " from django.utils.translation import gettext as _"
            },
            "7": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "     return t.render(Context({\"link\": linkdef, \"mdclass\": mdclass}))"
            },
            "9": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 52,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 53,
                "PatchRowcode": " "
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+@register.simple_tag"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+def render_post_link(linkdef, request):"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+    t = Template(\"\"\"<form method=\"post\" action=\"{{ link.url }}\">"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+{% csrf_token %}"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+<a class=\"menu-link\" href=\"#\" onclick=\"this.parentNode.submit()\">{% if link.img %}<i class=\"{{ link.img }}\"></i>{% endif %}{{ link.label }}</a>"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+</form>\"\"\")"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+    return t.render(RequestContext(request, {\"link\": linkdef}))"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+"
            },
            "20": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 63,
                "PatchRowcode": " @register.simple_tag"
            },
            "21": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 64,
                "PatchRowcode": " def progress_color(value):"
            },
            "22": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "     value = int(value)"
            }
        },
        "frontPatchFile": [
            "\"\"\"Custom template tags.\"\"\"",
            "",
            "from datetime import datetime",
            "",
            "from django import template",
            "from django.template import Context, Template",
            "from django.utils.safestring import mark_safe",
            "from django.utils.translation import gettext as _",
            "",
            "from modoboa.core import signals as core_signals",
            "",
            "register = template.Library()",
            "",
            "",
            "@register.simple_tag",
            "def join(items, sep=\",\"):",
            "    res = \"\"",
            "    for k, v in list(items.items()):",
            "        if res != \"\":",
            "            res += sep",
            "        res += \"%s : '%s'\" % (k, v)",
            "    return res",
            "",
            "",
            "@register.simple_tag",
            "def tolist(values):",
            "    return mark_safe(\"[%s]\" % \",\".join(['\"%s\"' % v for v in values]))",
            "",
            "",
            "@register.simple_tag",
            "def alert(msg, typ):",
            "    t = Template(\"\"\"<div class=\"alert alert-{{ type }}\" role=\"alert\">",
            "<button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button>",
            "{{ msg }}",
            "</div>\"\"\")  # NOQA:E501",
            "    return t.render(Context({\"type\": typ, \"msg\": msg}))",
            "",
            "",
            "@register.simple_tag",
            "def render_link(linkdef, mdclass=\"\"):",
            "    t = Template(\"\"\"<a href=\"{{ link.url }}\" name=\"{{ link.name }}\" title=\"{{ link.title }}\"",
            "{% if link.modal %}data-toggle=\"ajaxmodal{% if link.autowidth %}-autowidth{% endif %}\"{% endif %}",
            "{% if link.modalcb %}modalcb=\"{{ link.modalcb }}\"{% endif %}",
            "{% if link.closecb %}closecb=\"{{ link.closecb }}\"{% endif %}",
            "class=\"{{ mdclass }}{% if link.class %} {{ link.class }}{% endif %}\"",
            "{% if link.confirm %} onclick=\"return confirm('{{ link.confirm }}')\"{% endif %}",
            "{% for attr, value in link.extra_attributes.items %} {{ attr }}=\"{{ value }}\"{% endfor %}",
            ">",
            "{% if link.img %}<i class=\"{{ link.img }}\"></i>{% endif %}",
            "{{ link.label }}</a>\"\"\")  # NOQA:E501",
            "    return t.render(Context({\"link\": linkdef, \"mdclass\": mdclass}))",
            "",
            "",
            "@register.simple_tag",
            "def progress_color(value):",
            "    value = int(value)",
            "    if value < 50:",
            "        return \"progress-bar progress-bar-info\"",
            "    if value < 80:",
            "        return \"progress-bar progress-bar-warning\"",
            "    return \"progress-bar progress-bar-danger\"",
            "",
            "",
            "@register.filter",
            "def fromunix(value):",
            "    return datetime.fromtimestamp(int(value))",
            "",
            "",
            "@register.simple_tag",
            "def render_tags(tags):",
            "    t = Template(\"\"\"{% for tag in tags %}",
            "<span class=\"label label-{% if tag.color %}{{ tag.color }}{% else %}default{% endif %}\">",
            "  <a href=\"#\" class=\"filter {{ tag.type }}\" name=\"{{ tag.name }}\">{{ tag.label }}</a>",
            "</span>",
            "{% endfor %}",
            "\"\"\")  # NOQA:E501",
            "    return t.render(Context({\"tags\": tags}))",
            "",
            "",
            "@register.simple_tag",
            "def extra_static_content(caller, st_type, user):",
            "    \"\"\"Get extra static content from extensions.",
            "",
            "    :param str caller: the application (location) responsible for the call",
            "    :param str st_type: content type (css or js)",
            "    :param ``User`` user: connected user",
            "    \"\"\"",
            "    tpl = template.Template(",
            "        \"{% for sc in static_content %}{{ sc|safe }}{% endfor %}\"",
            "    )",
            "    static_content = core_signals.extra_static_content.send(",
            "        sender=\"extra_static_content\",",
            "        caller=caller, st_type=st_type, user=user)",
            "    static_content = [result[1] for result in static_content]",
            "    return tpl.render(",
            "        template.Context({\"static_content\": static_content})",
            "    )",
            "",
            "",
            "@register.filter(name=\"localize_header_name\")",
            "def localize_header_name(headername):",
            "    \"\"\" Localizes the header names \"\"\"",
            "    names = {",
            "        \"From\": _(\"From\"),",
            "        \"To\": _(\"To\"),",
            "        \"Date\": _(\"Date\"),",
            "        \"Subject\": _(\"Subject\")",
            "    }",
            "    return names.get(headername, headername)"
        ],
        "afterPatchFile": [
            "\"\"\"Custom template tags.\"\"\"",
            "",
            "from datetime import datetime",
            "",
            "from django import template",
            "from django.template import Context, RequestContext, Template",
            "from django.utils.safestring import mark_safe",
            "from django.utils.translation import gettext as _",
            "",
            "from modoboa.core import signals as core_signals",
            "",
            "register = template.Library()",
            "",
            "",
            "@register.simple_tag",
            "def join(items, sep=\",\"):",
            "    res = \"\"",
            "    for k, v in list(items.items()):",
            "        if res != \"\":",
            "            res += sep",
            "        res += \"%s : '%s'\" % (k, v)",
            "    return res",
            "",
            "",
            "@register.simple_tag",
            "def tolist(values):",
            "    return mark_safe(\"[%s]\" % \",\".join(['\"%s\"' % v for v in values]))",
            "",
            "",
            "@register.simple_tag",
            "def alert(msg, typ):",
            "    t = Template(\"\"\"<div class=\"alert alert-{{ type }}\" role=\"alert\">",
            "<button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button>",
            "{{ msg }}",
            "</div>\"\"\")  # NOQA:E501",
            "    return t.render(Context({\"type\": typ, \"msg\": msg}))",
            "",
            "",
            "@register.simple_tag",
            "def render_link(linkdef, mdclass=\"\"):",
            "    t = Template(\"\"\"<a href=\"{{ link.url }}\" name=\"{{ link.name }}\" title=\"{{ link.title }}\"",
            "{% if link.modal %}data-toggle=\"ajaxmodal{% if link.autowidth %}-autowidth{% endif %}\"{% endif %}",
            "{% if link.modalcb %}modalcb=\"{{ link.modalcb }}\"{% endif %}",
            "{% if link.closecb %}closecb=\"{{ link.closecb }}\"{% endif %}",
            "class=\"{{ mdclass }}{% if link.class %} {{ link.class }}{% endif %}\"",
            "{% if link.confirm %} onclick=\"return confirm('{{ link.confirm }}')\"{% endif %}",
            "{% for attr, value in link.extra_attributes.items %} {{ attr }}=\"{{ value }}\"{% endfor %}",
            ">",
            "{% if link.img %}<i class=\"{{ link.img }}\"></i>{% endif %}",
            "{{ link.label }}</a>\"\"\")  # NOQA:E501",
            "    return t.render(Context({\"link\": linkdef, \"mdclass\": mdclass}))",
            "",
            "",
            "@register.simple_tag",
            "def render_post_link(linkdef, request):",
            "    t = Template(\"\"\"<form method=\"post\" action=\"{{ link.url }}\">",
            "{% csrf_token %}",
            "<a class=\"menu-link\" href=\"#\" onclick=\"this.parentNode.submit()\">{% if link.img %}<i class=\"{{ link.img }}\"></i>{% endif %}{{ link.label }}</a>",
            "</form>\"\"\")",
            "    return t.render(RequestContext(request, {\"link\": linkdef}))",
            "",
            "",
            "@register.simple_tag",
            "def progress_color(value):",
            "    value = int(value)",
            "    if value < 50:",
            "        return \"progress-bar progress-bar-info\"",
            "    if value < 80:",
            "        return \"progress-bar progress-bar-warning\"",
            "    return \"progress-bar progress-bar-danger\"",
            "",
            "",
            "@register.filter",
            "def fromunix(value):",
            "    return datetime.fromtimestamp(int(value))",
            "",
            "",
            "@register.simple_tag",
            "def render_tags(tags):",
            "    t = Template(\"\"\"{% for tag in tags %}",
            "<span class=\"label label-{% if tag.color %}{{ tag.color }}{% else %}default{% endif %}\">",
            "  <a href=\"#\" class=\"filter {{ tag.type }}\" name=\"{{ tag.name }}\">{{ tag.label }}</a>",
            "</span>",
            "{% endfor %}",
            "\"\"\")  # NOQA:E501",
            "    return t.render(Context({\"tags\": tags}))",
            "",
            "",
            "@register.simple_tag",
            "def extra_static_content(caller, st_type, user):",
            "    \"\"\"Get extra static content from extensions.",
            "",
            "    :param str caller: the application (location) responsible for the call",
            "    :param str st_type: content type (css or js)",
            "    :param ``User`` user: connected user",
            "    \"\"\"",
            "    tpl = template.Template(",
            "        \"{% for sc in static_content %}{{ sc|safe }}{% endfor %}\"",
            "    )",
            "    static_content = core_signals.extra_static_content.send(",
            "        sender=\"extra_static_content\",",
            "        caller=caller, st_type=st_type, user=user)",
            "    static_content = [result[1] for result in static_content]",
            "    return tpl.render(",
            "        template.Context({\"static_content\": static_content})",
            "    )",
            "",
            "",
            "@register.filter(name=\"localize_header_name\")",
            "def localize_header_name(headername):",
            "    \"\"\" Localizes the header names \"\"\"",
            "    names = {",
            "        \"From\": _(\"From\"),",
            "        \"To\": _(\"To\"),",
            "        \"Date\": _(\"Date\"),",
            "        \"Subject\": _(\"Subject\")",
            "    }",
            "    return names.get(headername, headername)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "6": []
        },
        "addLocation": []
    }
}