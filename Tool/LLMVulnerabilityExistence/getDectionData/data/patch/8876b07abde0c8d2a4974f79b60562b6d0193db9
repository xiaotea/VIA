{
    "confidant/routes/credentials.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " @blueprint.route('/v1/credentials', methods=['GET'])"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "4": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " @authnz.require_auth"
            },
            "5": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 41,
                "PatchRowcode": " def get_credential_list():"
            },
            "6": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 42,
                "PatchRowcode": "     \"\"\""
            },
            "7": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": 133,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": 134,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 135,
                "PatchRowcode": " @blueprint.route('/v1/credentials/<id>', methods=['GET'])"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "11": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 137,
                "PatchRowcode": " @authnz.require_auth"
            },
            "12": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 138,
                "PatchRowcode": " def get_credential(id):"
            },
            "13": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 139,
                "PatchRowcode": "     \"\"\""
            },
            "14": {
                "beforePatchRowNumber": 369,
                "afterPatchRowNumber": 371,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 370,
                "afterPatchRowNumber": 372,
                "PatchRowcode": " "
            },
            "16": {
                "beforePatchRowNumber": 371,
                "afterPatchRowNumber": 373,
                "PatchRowcode": " @blueprint.route('/v1/archive/credentials/<id>', methods=['GET'])"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 374,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "18": {
                "beforePatchRowNumber": 372,
                "afterPatchRowNumber": 375,
                "PatchRowcode": " @authnz.require_auth"
            },
            "19": {
                "beforePatchRowNumber": 373,
                "afterPatchRowNumber": 376,
                "PatchRowcode": " def get_archive_credential_revisions(id):"
            },
            "20": {
                "beforePatchRowNumber": 374,
                "afterPatchRowNumber": 377,
                "PatchRowcode": "     \"\"\""
            },
            "21": {
                "beforePatchRowNumber": 451,
                "afterPatchRowNumber": 454,
                "PatchRowcode": " "
            },
            "22": {
                "beforePatchRowNumber": 452,
                "afterPatchRowNumber": 455,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 453,
                "afterPatchRowNumber": 456,
                "PatchRowcode": " @blueprint.route('/v1/archive/credentials', methods=['GET'])"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 457,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "25": {
                "beforePatchRowNumber": 454,
                "afterPatchRowNumber": 458,
                "PatchRowcode": " @authnz.require_auth"
            },
            "26": {
                "beforePatchRowNumber": 455,
                "afterPatchRowNumber": 459,
                "PatchRowcode": " def get_archive_credential_list():"
            },
            "27": {
                "beforePatchRowNumber": 456,
                "afterPatchRowNumber": 460,
                "PatchRowcode": "     \"\"\""
            },
            "28": {
                "beforePatchRowNumber": 534,
                "afterPatchRowNumber": 538,
                "PatchRowcode": " "
            },
            "29": {
                "beforePatchRowNumber": 535,
                "afterPatchRowNumber": 539,
                "PatchRowcode": " "
            },
            "30": {
                "beforePatchRowNumber": 536,
                "afterPatchRowNumber": 540,
                "PatchRowcode": " @blueprint.route('/v1/credentials', methods=['POST'])"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 541,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "32": {
                "beforePatchRowNumber": 537,
                "afterPatchRowNumber": 542,
                "PatchRowcode": " @authnz.require_auth"
            },
            "33": {
                "beforePatchRowNumber": 538,
                "afterPatchRowNumber": 543,
                "PatchRowcode": " @authnz.require_csrf_token"
            },
            "34": {
                "beforePatchRowNumber": 539,
                "afterPatchRowNumber": 544,
                "PatchRowcode": " @maintenance.check_maintenance_mode"
            },
            "35": {
                "beforePatchRowNumber": 727,
                "afterPatchRowNumber": 732,
                "PatchRowcode": " "
            },
            "36": {
                "beforePatchRowNumber": 728,
                "afterPatchRowNumber": 733,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": 729,
                "afterPatchRowNumber": 734,
                "PatchRowcode": " @blueprint.route('/v1/credentials/<id>', methods=['PUT'])"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 735,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "39": {
                "beforePatchRowNumber": 730,
                "afterPatchRowNumber": 736,
                "PatchRowcode": " @authnz.require_auth"
            },
            "40": {
                "beforePatchRowNumber": 731,
                "afterPatchRowNumber": 737,
                "PatchRowcode": " @authnz.require_csrf_token"
            },
            "41": {
                "beforePatchRowNumber": 732,
                "afterPatchRowNumber": 738,
                "PatchRowcode": " @maintenance.check_maintenance_mode"
            },
            "42": {
                "beforePatchRowNumber": 952,
                "afterPatchRowNumber": 958,
                "PatchRowcode": " "
            },
            "43": {
                "beforePatchRowNumber": 953,
                "afterPatchRowNumber": 959,
                "PatchRowcode": " "
            },
            "44": {
                "beforePatchRowNumber": 954,
                "afterPatchRowNumber": 960,
                "PatchRowcode": " @blueprint.route('/v1/credentials/<id>/<to_revision>', methods=['PUT'])"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 961,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "46": {
                "beforePatchRowNumber": 955,
                "afterPatchRowNumber": 962,
                "PatchRowcode": " @authnz.require_auth"
            },
            "47": {
                "beforePatchRowNumber": 956,
                "afterPatchRowNumber": 963,
                "PatchRowcode": " @authnz.require_csrf_token"
            },
            "48": {
                "beforePatchRowNumber": 957,
                "afterPatchRowNumber": 964,
                "PatchRowcode": " @maintenance.check_maintenance_mode"
            }
        },
        "frontPatchFile": [
            "import base64",
            "import json",
            "import logging",
            "import re",
            "import uuid",
            "",
            "from flask import blueprints, jsonify, request",
            "from pynamodb.exceptions import DoesNotExist, PutError",
            "",
            "from confidant import authnz, clients, settings",
            "from confidant.models.credential import Credential",
            "from confidant.schema.credentials import (",
            "    CredentialResponse,",
            "    CredentialsResponse,",
            "    credential_response_schema,",
            "    credentials_response_schema,",
            "    RevisionsResponse,",
            "    revisions_response_schema,",
            ")",
            "from confidant.services import (",
            "    credentialmanager,",
            "    graphite,",
            "    keymanager,",
            "    servicemanager,",
            "    webhook,",
            ")",
            "from confidant.services.ciphermanager import CipherManager",
            "from confidant.utils import maintenance, misc, stats",
            "from confidant.utils.dynamodb import decode_last_evaluated_key",
            "",
            "logger = logging.getLogger(__name__)",
            "blueprint = blueprints.Blueprint('credentials', __name__)",
            "",
            "acl_module_check = misc.load_module(settings.ACL_MODULE)",
            "VALUE_LENGTH = 50",
            "",
            "",
            "@blueprint.route('/v1/credentials', methods=['GET'])",
            "@authnz.require_auth",
            "def get_credential_list():",
            "    \"\"\"",
            "    Returns a list of the metadata of all the current revision of credentials.",
            "",
            "    .. :quickref: Credentials; Get a list of the metadata for all current",
            "                  credential revisions.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"credentials\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [],",
            "             \"credential_pairs\": {},",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         next_page: null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list credentials.",
            "    \"\"\"",
            "    with stats.timer('list_credentials'):",
            "        if not acl_module_check(resource_type='credential', action='list'):",
            "            msg = \"{} does not have access to list credentials\".format(",
            "                authnz.get_logged_in_user()",
            "            )",
            "            error_msg = {'error': msg}",
            "            return jsonify(error_msg), 403",
            "",
            "        limit = request.args.get(",
            "            'limit',",
            "            default=None,",
            "            type=int,",
            "        )",
            "        page = request.args.get(",
            "            'page',",
            "            default=None,",
            "            type=str",
            "        )",
            "        if page:",
            "            try:",
            "                page = decode_last_evaluated_key(page)",
            "            except Exception:",
            "                logger.exception('Failed to parse provided page')",
            "                return jsonify({'error': 'Failed to parse page'}), 400",
            "        if limit:",
            "            results = Credential.data_type_date_index.query(",
            "                'credential',",
            "                scan_index_forward=False,",
            "                limit=limit,",
            "                last_evaluated_key=page,",
            "            )",
            "            credentials_response = CredentialsResponse.from_credentials(",
            "                [credential for credential in results],",
            "                next_page=results.last_evaluated_key,",
            "            )",
            "        else:",
            "            credentials_response = CredentialsResponse.from_credentials([",
            "                credential",
            "                for credential in",
            "                Credential.data_type_date_index.query('credential')",
            "            ])",
            "",
            "        return credentials_response_schema.dumps(credentials_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>', methods=['GET'])",
            "@authnz.require_auth",
            "def get_credential(id):",
            "    \"\"\"",
            "    Returns a credential object for the provided credential id.",
            "",
            "    .. :quickref: Credential; Get a credential from the provided id.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :param id: The credential ID to get.",
            "    :type id: str",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"...\",",
            "         \"name\": \"Example Credential\",",
            "         \"credential_keys\": [",
            "           \"api_key\",",
            "           \"api_user\"",
            "         ],",
            "         \"credential_pairs\": {",
            "           \"api_key\": \"1234\",",
            "           \"api_user\": \"example_user\"",
            "         },",
            "         \"metadata\": {",
            "           \"example_metadata_key\": \"example_value\"",
            "         },",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"documentation\": \"Example documentation\",",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"permissions\": {",
            "           \"metadata\": true,",
            "           \"get\": true,",
            "           \"update\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get the credential for",
            "                     the provided ID.",
            "    :statuscode 404: The provided credential ID does not exist.",
            "    \"\"\"",
            "    with stats.timer('get_credential_by_id'):",
            "        metadata_only = misc.get_boolean(request.args.get('metadata_only'))",
            "",
            "        if not acl_module_check(resource_type='credential',",
            "                                action='metadata',",
            "                                resource_id=id):",
            "            msg = \"{} does not have access to credential {}\".format(",
            "                authnz.get_logged_in_user(),",
            "                id",
            "            )",
            "            error_msg = {'error': msg, 'reference': id}",
            "            return jsonify(error_msg), 403",
            "",
            "        try:",
            "            credential = Credential.get(id)",
            "        except DoesNotExist:",
            "            logger.warning(",
            "                'Item with id {0} does not exist.'.format(id)",
            "            )",
            "            return jsonify({}), 404",
            "        if credential.data_type != 'credential':",
            "            return jsonify({}), 404",
            "",
            "        permissions = {",
            "            'metadata': True,",
            "            'get': acl_module_check(",
            "                resource_type='credential',",
            "                action='get',",
            "                resource_id=id",
            "            ),",
            "            'update': acl_module_check(",
            "                resource_type='credential',",
            "                action='update',",
            "                resource_id=id",
            "            ),",
            "        }",
            "        include_credential_pairs = False",
            "        if not metadata_only and acl_module_check(resource_type='credential',",
            "                                                  action='get',",
            "                                                  resource_id=id):",
            "            permissions['get'] = True",
            "            include_credential_pairs = True",
            "",
            "            if settings.ENABLE_SAVE_LAST_DECRYPTION_TIME:",
            "                # Also try to save the archived credential to stay consistent",
            "                try:",
            "                    archived_credential = Credential.get(",
            "                        '{}-{}'.format(id, credential.revision)",
            "                    )",
            "                except DoesNotExist:",
            "                    archived_credential = None",
            "                    logger.error('Archived credential {}-{} not found'.format(",
            "                            id, credential.revision)",
            "                    )",
            "                now = misc.utcnow()",
            "                credential.last_decrypted_date = now",
            "                credential.save()",
            "                if archived_credential:",
            "                    archived_credential.last_decrypted_date = now",
            "                    archived_credential.save()",
            "",
            "            log_line = \"{0} get credential {1}\".format(",
            "                authnz.get_logged_in_user(),",
            "                id",
            "            )",
            "            logger.info(log_line)",
            "",
            "        credential_response = CredentialResponse.from_credential(",
            "            credential,",
            "            include_credential_keys=True,",
            "            include_credential_pairs=include_credential_pairs,",
            "        )",
            "        credential_response.permissions = permissions",
            "",
            "        return credential_response_schema.dumps(credential_response)",
            "",
            "",
            "@blueprint.route(",
            "    '/v1/credentials/<id>/<old_revision>/<new_revision>',",
            "    methods=['GET']",
            ")",
            "@authnz.require_auth",
            "def diff_credential(id, old_revision, new_revision):",
            "    \"\"\"",
            "    Returns a diff between old_revision and new_revision for the provided",
            "    credential id.",
            "",
            "    .. :quickref: Credential Diff; Get a diff of two revisions of a credential.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials/abcd12345bf4f1cafe8e722d3860404/1/2",
            "",
            "    :param id: The credential ID to get.",
            "    :type id: str",
            "    :param old_revision: One of the two revisions to diff against.",
            "    :type old_revision: int",
            "    :param new_revision: One of the two revisions to diff against.",
            "    :type new_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"name\": {",
            "           \"added\": \"New credential name\",",
            "           \"removed\": \"Example credential name\"",
            "         },",
            "         \"credential_pairs\": {",
            "           \"added\": [",
            "             \"api_key\",",
            "             \"api_user\"",
            "           ],",
            "           \"removed\": [",
            "             \"api_certificate\"",
            "           ]",
            "         },",
            "         \"metadata\": {",
            "           \"added\": \"example_key\"",
            "         },",
            "         \"enabled\": {",
            "           \"added\": false,",
            "           \"removed\": true",
            "         },",
            "         \"documentation\": {",
            "           \"added\": \"The way you rotate this credential is to...\",",
            "           \"removed\": \"Example documentation\"",
            "         },",
            "         \"modified_date\": {",
            "           \"added\": \"2019-12-16T23:16:11.413299+00:00\",",
            "           \"removed\": \"2019-11-16T23:16:11.413299+00:00\"",
            "         },",
            "         \"modified_by\": {",
            "           \"added\": \"rlane@example.com\",",
            "           \"removed\": \"testuser@example.com\"",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to diff the provided",
            "                     credential ID.",
            "    :statuscode 404: The provided credential ID or one of the provided",
            "                     revisions does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to diff credential {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        old_credential = Credential.get('{}-{}'.format(id, old_revision))",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Credential not found.'}), 404",
            "    if old_credential.data_type != 'archive-credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        new_credential = Credential.get('{}-{}'.format(id, new_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if new_credential.data_type != 'archive-credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    return jsonify(old_credential.diff(new_credential))",
            "",
            "",
            "@blueprint.route('/v1/archive/credentials/<id>', methods=['GET'])",
            "@authnz.require_auth",
            "def get_archive_credential_revisions(id):",
            "    \"\"\"",
            "    Returns a list of the metadata of all the revisions of the provided",
            "    credential.",
            "",
            "    .. :quickref: Credential Revisions; Get a list of the metadata of all the",
            "                  revisions of the provided credential.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"revisions\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404-1\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [],",
            "             \"credential_pairs\": {},",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         next_page: null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get credential",
            "                     metadata for the provided credential ID.",
            "    :statuscode 404: The provided credential ID does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to credential {} revisions\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        cred = Credential.get(id)",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if (cred.data_type != 'credential' and",
            "            cred.data_type != 'archive-credential'):",
            "        return jsonify({}), 404",
            "    revisions_response = RevisionsResponse.from_credentials(",
            "        Credential.batch_get(",
            "            credentialmanager.get_revision_ids_for_credential(cred)",
            "        )",
            "    )",
            "    return revisions_response_schema.dumps(revisions_response)",
            "",
            "",
            "@blueprint.route('/v1/archive/credentials', methods=['GET'])",
            "@authnz.require_auth",
            "def get_archive_credential_list():",
            "    \"\"\"",
            "    Returns a list of the metadata of all the history revisions of credentials.",
            "",
            "    .. :quickref: Credential History; Get a list of the metadata for all history",
            "                  revision credentials.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"revisions\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404-1\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [],",
            "             \"credential_pairs\": {},",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         next_page: null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list credentials",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential', action='list'):",
            "        msg = \"{} does not have access to list credentials\".format(",
            "            authnz.get_logged_in_user()",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "",
            "    limit = request.args.get(",
            "        'limit',",
            "        default=settings.HISTORY_PAGE_LIMIT,",
            "        type=int,",
            "    )",
            "    page = request.args.get('page', default=None, type=str)",
            "    if page:",
            "        try:",
            "            page = decode_last_evaluated_key(page)",
            "        except Exception:",
            "            logger.exception('Failed to parse provided page')",
            "            return jsonify({'error': 'Failed to parse page'}), 400",
            "    results = Credential.data_type_date_index.query(",
            "        'archive-credential',",
            "        scan_index_forward=False,",
            "        limit=limit,",
            "        last_evaluated_key=page,",
            "    )",
            "    credentials_response = CredentialsResponse.from_credentials(",
            "        [credential for credential in results],",
            "        next_page=results.last_evaluated_key,",
            "    )",
            "    return credentials_response_schema.dumps(credentials_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials', methods=['POST'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def create_credential():",
            "    '''",
            "    Create a credential using the data provided in the POST body.",
            "",
            "    .. :quickref: Credential; Create a credential using the data provided in",
            "                  the post body.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       POST /v1/credentials",
            "",
            "    :<json string name: The friendly name for the credential. (required)",
            "    :<json Dictionary{string: string} credential_pairs: A dictionary of",
            "      arbitrary key/value pairs to be encrypted at rest. (required)",
            "    :<json Dictionary{string: string} metadata: A dictionary of arbitrary key/",
            "      value pairs for custom per-credential end-user extensions. This is not",
            "      encrypted at rest.",
            "    :<json boolean enabled: Whether or not this credential is enabled.",
            "      (default: true)",
            "    :<json string documentation: End-user provided documentation for this",
            "      credential. (required)",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "          \"name\": \"Example Credential\",",
            "          \"credential_keys\": [\"example_credential_key\"],",
            "          \"credential_pairs\": {",
            "            \"example_credential_key\": \"example_credential_value\"",
            "          },",
            "          \"metadata\": {",
            "            \"example_metadata_key\": \"example_value\"",
            "          },",
            "          \"revision\": 1,",
            "          \"enabled\": true,",
            "          \"documentation\": \"Example documentation\",",
            "          \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "          \"modified_by\": \"rlane@example.com\",",
            "          \"permissions\": {",
            "            \"metadata\": true,",
            "            \"get\": true,",
            "            \"update\": true",
            "          }",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; either the data provided was not in the",
            "                     correct format, or a required field was not provided.",
            "    :statuscode 403: Client does not have access to create credentials.",
            "    '''",
            "    with stats.timer('create_credential'):",
            "        if not acl_module_check(resource_type='credential', action='create'):",
            "            msg = f\"{authnz.get_logged_in_user()}\"",
            "            msg += \"does not have access to create credentials\"",
            "            error_msg = {'error': msg}",
            "            return jsonify(error_msg), 403",
            "",
            "        data = request.get_json()",
            "        if not data.get('documentation') \\",
            "                and settings.get('ENFORCE_DOCUMENTATION'):",
            "            return jsonify({'error': 'documentation is a required field'}), 400",
            "        if not data.get('credential_pairs'):",
            "            error = {'error': 'credential_pairs is a required field'}",
            "            return jsonify(error), 400",
            "        if not isinstance(data.get('metadata', {}), dict):",
            "            return jsonify({'error': 'metadata must be a dict'}), 400",
            "        # Ensure credential pair keys are lowercase",
            "        credential_pairs = credentialmanager.lowercase_credential_pairs(",
            "            data['credential_pairs']",
            "        )",
            "        _check, ret = credentialmanager.check_credential_pair_values(",
            "            credential_pairs",
            "        )",
            "        if not _check:",
            "            return jsonify(ret), 400",
            "        for cred in Credential.data_type_date_index.query(",
            "                'credential', filter_condition=Credential.name == data['name']):",
            "            # Conflict, the name already exists",
            "            msg = f'Name already exists. See id: {cred.id}'",
            "            return jsonify({'error': msg, 'reference': cred.id}), 409",
            "        # Generate an initial stable ID to allow name changes",
            "        id = str(uuid.uuid4()).replace('-', '')",
            "        # Try to save to the archive",
            "        revision = 1",
            "        credential_pairs = json.dumps(credential_pairs)",
            "        data_key = keymanager.create_datakey(encryption_context={'id': id})",
            "        cipher = CipherManager(data_key['plaintext'], version=2)",
            "        credential_pairs = cipher.encrypt(credential_pairs)",
            "        last_rotation_date = misc.utcnow()",
            "",
            "        cred = Credential(",
            "            id=f'{id}-{revision}',",
            "            data_type='archive-credential',",
            "            name=data.get('name'),",
            "            credential_pairs=credential_pairs,",
            "            metadata=data.get('metadata'),",
            "            revision=revision,",
            "            enabled=data.get('enabled'),",
            "            data_key=data_key['ciphertext'],",
            "            cipher_version=2,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=data.get('documentation'),",
            "            tags=data.get('tags', []),",
            "            last_rotation_date=last_rotation_date,",
            "        ).save()",
            "        # Make this the current revision",
            "        cred = Credential(",
            "            id=id,",
            "            data_type='credential',",
            "            name=data.get('name'),",
            "            credential_pairs=credential_pairs,",
            "            metadata=data.get('metadata'),",
            "            revision=revision,",
            "            enabled=data.get('enabled'),",
            "            data_key=data_key['ciphertext'],",
            "            cipher_version=2,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=data.get('documentation'),",
            "            tags=data.get('tags', []),",
            "            last_rotation_date=last_rotation_date,",
            "        )",
            "        cred.save()",
            "        permissions = {",
            "            'metadata': True,",
            "            'get': True,",
            "            'update': True,",
            "        }",
            "        credential_response = CredentialResponse.from_credential(",
            "            cred,",
            "            include_credential_keys=True,",
            "            include_credential_pairs=True,",
            "        )",
            "        credential_response.permissions = permissions",
            "        return credential_response_schema.dumps(credential_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>/services', methods=['GET'])",
            "@authnz.require_auth",
            "def get_credential_dependencies(id):",
            "    \"\"\"",
            "    Returns a list of services that this credential is mapped to.",
            "",
            "    .. :quickref: Credential Mappings; Get a list of services that this",
            "                  credential is mapped to.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials/abcd12345bf4f1cafe8e722d3860404/services",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"services\": [\"example-development\", \"example2-development\"]",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get metadata for the",
            "                     provided credential.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to get dependencies for credential {}\"",
            "        msg = msg.format(authnz.get_logged_in_user(), id)",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    services = servicemanager.get_services_for_credential(id)",
            "    _services = [{'id': x.id, 'enabled': x.enabled} for x in services]",
            "    return jsonify({'services': _services})",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>', methods=['PUT'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def update_credential(id):",
            "    '''",
            "    Update the provided credential using the data provided in the POST body.",
            "",
            "    .. :quickref: Credential; Update the provided credential using the data",
            "                  provided in the post body.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :param id: The credential ID to update.",
            "    :type id: str",
            "    :<json string name: The friendly name for the credential.",
            "    :<json Dictionary{string: string} credential_pairs: A dictionary of",
            "      arbitrary key/value pairs to be encrypted at rest.",
            "    :<json Dictionary{string: string} metadata: A dictionary of arbitrary key/",
            "      value pairs for custom per-credential end-user extensions. This is not",
            "      encrypted at rest.",
            "    :<json boolean enabled: Whether or not this credential is enabled.",
            "    :<json string documentation: End-user provided documentation for this",
            "      credential.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "          \"name\": \"Example Credential\",",
            "          \"credential_keys\": [\"example_credential_key\"],",
            "          \"credential_pairs\": {",
            "            \"example_credential_key\": \"example_credential_value\"",
            "          },",
            "          \"metadata\": {",
            "            \"example_metadata_key\": \"example_value\"",
            "          },",
            "          \"revision\": 1,",
            "          \"enabled\": true,",
            "          \"documentation\": \"Example documentation\",",
            "          \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "          \"modified_by\": \"rlane@example.com\",",
            "          \"permissions\": {",
            "            \"metadata\": true,",
            "            \"get\": true,",
            "            \"update\": true",
            "          }",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; either the data provided was not in the",
            "                     correct format, or the update would create conflicting",
            "                     credential keys in a mapped service.",
            "    :statuscode 403: Client does not have access to update the provided",
            "                     credential ID.",
            "    '''",
            "    with stats.timer('update_credential'):",
            "        if not acl_module_check(resource_type='credential',",
            "                                action='update',",
            "                                resource_id=id):",
            "            msg = f\"{authnz.get_logged_in_user()}\"",
            "            msg += f\"does not have access to update credential {id}\"",
            "            error_msg = {'error': msg, 'reference': id}",
            "            return jsonify(error_msg), 403",
            "",
            "        try:",
            "            _cred = Credential.get(id)",
            "        except DoesNotExist:",
            "            return jsonify({'error': 'Credential not found.'}), 404",
            "        if _cred.data_type != 'credential':",
            "            msg = 'id provided is not a credential.'",
            "            return jsonify({'error': msg}), 400",
            "",
            "        data = request.get_json()",
            "        if not isinstance(data.get('metadata', {}), dict):",
            "            return jsonify({'error': 'metadata must be a dict'}), 400",
            "",
            "        # We check for a name change and ensure it doesn't conflict with an",
            "        # existing credential name",
            "        if data.get('name') != _cred.name:",
            "            for cred in Credential.data_type_date_index.query(",
            "                    'credential',",
            "                    filter_condition=Credential.name == data.get('name')):",
            "                # Conflict, the name already exists",
            "                msg = f'Name already exists. See id: {cred.id}'",
            "                return jsonify({'error': msg, 'reference': cred.id}), 409",
            "",
            "        update = {",
            "            'name': data.get('name', _cred.name),",
            "            'last_rotation_date': _cred.last_rotation_date,",
            "            'credential_pairs': _cred.credential_pairs,",
            "            'enabled': _cred.enabled,",
            "            'metadata': data.get('metadata', _cred.metadata),",
            "            'documentation': data.get('documentation', _cred.documentation),",
            "            'tags': data.get('tags', _cred.tags),",
            "        }",
            "        # Enforce documentation, EXCEPT if we are restoring an old revision",
            "        if (not update['documentation'] and",
            "                settings.get('ENFORCE_DOCUMENTATION') and",
            "                not data.get('revision')):",
            "            return jsonify({'error': 'documentation is a required field'}), 400",
            "        if 'enabled' in data:",
            "            if not isinstance(data['enabled'], bool):",
            "                return jsonify({'error': 'Enabled must be a boolean.'}), 400",
            "            update['enabled'] = data['enabled']",
            "",
            "        services = servicemanager.get_services_for_credential(id)",
            "        revision = credentialmanager.get_latest_credential_revision(",
            "            id,",
            "            _cred.revision",
            "        )",
            "        if 'credential_pairs' in data:",
            "            # Ensure the credential is not empty",
            "            if data['credential_pairs'] == {}:",
            "                error = {'error': 'Credential Pairs cannot be empty.'}",
            "                return jsonify(error), 400",
            "",
            "            # Ensure credential pair keys are lowercase",
            "            credential_pairs = credentialmanager.lowercase_credential_pairs(",
            "                data['credential_pairs']",
            "            )",
            "            _check, ret = credentialmanager.check_credential_pair_values(",
            "                credential_pairs",
            "            )",
            "            if not _check:",
            "                return jsonify(ret), 400",
            "            # Ensure credential pairs don't conflicts with pairs from other",
            "            # services",
            "            conflicts = servicemanager.pair_key_conflicts_for_services(",
            "                id,",
            "                list(credential_pairs.keys()),",
            "                services",
            "            )",
            "            if conflicts:",
            "                ret = {",
            "                    'error': 'Conflicting key pairs in mapped service.',",
            "                    'conflicts': conflicts",
            "                }",
            "                return jsonify(ret), 400",
            "",
            "            # If the credential pair passed in the update is different from the",
            "            # decrypted credential pair of the most recent revision, assume that",
            "            # this is a new credential pair and update last_rotation_date",
            "            if credential_pairs != _cred.decrypted_credential_pairs:",
            "                update['last_rotation_date'] = misc.utcnow()",
            "",
            "            data_key = keymanager.create_datakey(encryption_context={'id': id})",
            "            cipher = CipherManager(data_key['plaintext'], version=2)",
            "            update['credential_pairs'] = cipher.encrypt(",
            "                json.dumps(credential_pairs)",
            "            )",
            "",
            "        # Try to save to the archive",
            "        try:",
            "            Credential(",
            "                id=f'{id}-{revision}',",
            "                name=update['name'],",
            "                data_type='archive-credential',",
            "                credential_pairs=update['credential_pairs'],",
            "                metadata=update['metadata'],",
            "                enabled=update['enabled'],",
            "                revision=revision,",
            "                data_key=data_key['ciphertext'],",
            "                cipher_version=2,",
            "                modified_by=authnz.get_logged_in_user(),",
            "                documentation=update['documentation'],",
            "                tags=update['tags'],",
            "                last_rotation_date=update['last_rotation_date'],",
            "            ).save()",
            "        except PutError as e:",
            "            logger.error(e)",
            "            error = {'error': 'Failed to add credential to archive.'}",
            "            return jsonify(error), 500",
            "        try:",
            "            cred = Credential(",
            "                id=id,",
            "                name=update['name'],",
            "                data_type='credential',",
            "                credential_pairs=update['credential_pairs'],",
            "                metadata=update['metadata'],",
            "                enabled=update['enabled'],",
            "                revision=revision,",
            "                data_key=data_key['ciphertext'],",
            "                cipher_version=2,",
            "                modified_by=authnz.get_logged_in_user(),",
            "                documentation=update['documentation'],",
            "                tags=update['tags'],",
            "                last_rotation_date=update['last_rotation_date'],",
            "            )",
            "            cred.save()",
            "        except PutError as e:",
            "            logger.error(e)",
            "            error = {'error': 'Failed to update active credential.'}",
            "            return jsonify(error), 500",
            "",
            "        if services:",
            "            service_names = [x.id for x in services]",
            "            msg = f'Updated credential \"{cred.name}\"'",
            "            msg += f'({cred.id}); Revision {cred.revision}'",
            "            graphite.send_event(service_names, msg)",
            "            webhook.send_event('credential_update', service_names, [cred.id])",
            "        permissions = {",
            "            'metadata': True,",
            "            'get': True,",
            "            'update': True,",
            "        }",
            "        credential_response = CredentialResponse.from_credential(",
            "            cred,",
            "            include_credential_keys=True,",
            "            include_credential_pairs=True,",
            "        )",
            "        credential_response.permissions = permissions",
            "        return credential_response_schema.dumps(credential_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>/<to_revision>', methods=['PUT'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def revert_credential_to_revision(id, to_revision):",
            "    '''",
            "    Revert the provided credential to the provided revision.",
            "",
            "    .. :quickref: Credential; Revert the provided credential to the provided",
            "                  revision",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/credentials/abcd12345bf4f1cafe8e722d3860404/1",
            "",
            "    :param id: The credential ID to revert.",
            "    :type id: str",
            "    :param to_revision: The revision to revert this credential to.",
            "    :type to_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "          \"name\": \"Example Credential\",",
            "          \"credential_keys\": [\"example_credential_key\"],",
            "          \"credential_pairs\": {},",
            "          \"metadata\": {",
            "            \"example_metadata_key\": \"example_value\"",
            "          },",
            "          \"revision\": 1,",
            "          \"enabled\": true,",
            "          \"documentation\": \"Example documentation\",",
            "          \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "          \"modified_by\": \"rlane@example.com\",",
            "          \"permissions\": {",
            "            \"metadata\": true,",
            "            \"get\": true,",
            "            \"update\": true",
            "          }",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; the update would create conflicting",
            "                     credential keys in a mapped service.",
            "    :statuscode 403: Client does not have access to revert the provided",
            "                     credential ID.",
            "    '''",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='revert',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to revert credential {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        current_credential = Credential.get(id)",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Credential not found.'}), 404",
            "    if current_credential.data_type != 'credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    new_revision = credentialmanager.get_latest_credential_revision(",
            "        id,",
            "        current_credential.revision",
            "    )",
            "    try:",
            "        revert_credential = Credential.get('{}-{}'.format(id, to_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if revert_credential.data_type != 'archive-credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    if revert_credential.equals(current_credential):",
            "        ret = {",
            "            'error': 'No difference between old and new credential.'",
            "        }",
            "        return jsonify(ret), 400",
            "    services = servicemanager.get_services_for_credential(id)",
            "    if revert_credential.credential_pairs:",
            "        _credential_pairs = revert_credential.decrypted_credential_pairs",
            "        _check, ret = credentialmanager.check_credential_pair_values(",
            "            _credential_pairs",
            "        )",
            "        if not _check:",
            "            return jsonify(ret), 400",
            "        # Ensure credential pairs don't conflicts with pairs from other",
            "        # services",
            "        conflicts = servicemanager.pair_key_conflicts_for_services(",
            "            id,",
            "            list(_credential_pairs.keys()),",
            "            services",
            "        )",
            "        if conflicts:",
            "            ret = {",
            "                'error': 'Conflicting key pairs in mapped service.',",
            "                'conflicts': conflicts",
            "            }",
            "            return jsonify(ret), 400",
            "    # Try to save to the archive",
            "    try:",
            "        Credential(",
            "            id='{0}-{1}'.format(id, new_revision),",
            "            name=revert_credential.name,",
            "            data_type='archive-credential',",
            "            credential_pairs=revert_credential.credential_pairs,",
            "            metadata=revert_credential.metadata,",
            "            enabled=revert_credential.enabled,",
            "            revision=new_revision,",
            "            data_key=revert_credential.data_key,",
            "            cipher_version=revert_credential.cipher_version,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=revert_credential.documentation,",
            "            tags=revert_credential.tags,",
            "            last_rotation_date=revert_credential.last_rotation_date,",
            "        ).save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to add credential to archive.'}), 500",
            "    try:",
            "        cred = Credential(",
            "            id=id,",
            "            name=revert_credential.name,",
            "            data_type='credential',",
            "            credential_pairs=revert_credential.credential_pairs,",
            "            metadata=revert_credential.metadata,",
            "            enabled=revert_credential.enabled,",
            "            revision=new_revision,",
            "            data_key=revert_credential.data_key,",
            "            cipher_version=revert_credential.cipher_version,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=revert_credential.documentation,",
            "            tags=revert_credential.tags,",
            "            last_rotation_date=revert_credential.last_rotation_date,",
            "        )",
            "        cred.save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to update active credential.'}), 500",
            "    if services:",
            "        service_names = [x.id for x in services]",
            "        msg = 'Updated credential \"{0}\" ({1}); Revision {2}'",
            "        msg = msg.format(cred.name, cred.id, cred.revision)",
            "        graphite.send_event(service_names, msg)",
            "        webhook.send_event('credential_update', service_names, [cred.id])",
            "    return credential_response_schema.dumps(",
            "        CredentialResponse.from_credential(cred)",
            "    )",
            "",
            "",
            "@blueprint.route('/v1/value_generator', methods=['GET'])",
            "def generate_value():",
            "    \"\"\"",
            "    Returns a randomly generated value, for use in credential pairs.",
            "",
            "    .. :quickref: Random Value; Get a randomly generated value, for use in",
            "                  credential pairs.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/value_generator",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"value\": \"c5S0w08YwU4PY3EZ7eQf4QYYUIT6ryyKOydhjyTti9pjPuMU00\"",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    \"\"\"",
            "    kms_client = clients.get_boto_client('kms', endpoint_url=settings.KMS_URL)",
            "    value = kms_client.generate_random(NumberOfBytes=128)['Plaintext']",
            "    value = base64.urlsafe_b64encode(value).decode('UTF-8')",
            "    value = re.sub(r'[\\W_]+', '', value)",
            "    if len(value) > VALUE_LENGTH:",
            "        value = value[:VALUE_LENGTH]",
            "    return jsonify({'value': value})",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>/archive', methods=['POST'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def archive_credential(id):",
            "    '''",
            "    Archive the provided credential.",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       POST /v1/credentials/abcd12345bf4f1cafe8e722d3860404/archive",
            "",
            "    :param id: The credential ID to update.",
            "    :<json bool force: Run the archive operation, if false will only validate",
            "        the provided input",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"result\": \"success\"",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input or state",
            "    :statuscode 403: Client does not have access to archive the provided",
            "                     credential ID.",
            "    '''",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='archive',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to archive credential {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        _cred = Credential.get(id)",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Credential not found.'}), 404",
            "    if _cred.data_type != 'credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "",
            "    data = request.get_json()",
            "    force = data.get('force', False) if data else False",
            "    if not isinstance(force, bool):",
            "        return jsonify({'error': 'force must be a boolean.'}), 400",
            "",
            "    failed = credentialmanager.archive_credentials([_cred], force)",
            "    if failed and id in failed:",
            "        return jsonify({'error': failed[id]}), 400",
            "",
            "    result = 'dry-run success'",
            "    if force:",
            "        result = 'success'",
            "    return jsonify({'result': result}), 200"
        ],
        "afterPatchFile": [
            "import base64",
            "import json",
            "import logging",
            "import re",
            "import uuid",
            "",
            "from flask import blueprints, jsonify, request",
            "from pynamodb.exceptions import DoesNotExist, PutError",
            "",
            "from confidant import authnz, clients, settings",
            "from confidant.models.credential import Credential",
            "from confidant.schema.credentials import (",
            "    CredentialResponse,",
            "    CredentialsResponse,",
            "    credential_response_schema,",
            "    credentials_response_schema,",
            "    RevisionsResponse,",
            "    revisions_response_schema,",
            ")",
            "from confidant.services import (",
            "    credentialmanager,",
            "    graphite,",
            "    keymanager,",
            "    servicemanager,",
            "    webhook,",
            ")",
            "from confidant.services.ciphermanager import CipherManager",
            "from confidant.utils import maintenance, misc, stats",
            "from confidant.utils.dynamodb import decode_last_evaluated_key",
            "",
            "logger = logging.getLogger(__name__)",
            "blueprint = blueprints.Blueprint('credentials', __name__)",
            "",
            "acl_module_check = misc.load_module(settings.ACL_MODULE)",
            "VALUE_LENGTH = 50",
            "",
            "",
            "@blueprint.route('/v1/credentials', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_credential_list():",
            "    \"\"\"",
            "    Returns a list of the metadata of all the current revision of credentials.",
            "",
            "    .. :quickref: Credentials; Get a list of the metadata for all current",
            "                  credential revisions.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"credentials\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [],",
            "             \"credential_pairs\": {},",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         next_page: null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list credentials.",
            "    \"\"\"",
            "    with stats.timer('list_credentials'):",
            "        if not acl_module_check(resource_type='credential', action='list'):",
            "            msg = \"{} does not have access to list credentials\".format(",
            "                authnz.get_logged_in_user()",
            "            )",
            "            error_msg = {'error': msg}",
            "            return jsonify(error_msg), 403",
            "",
            "        limit = request.args.get(",
            "            'limit',",
            "            default=None,",
            "            type=int,",
            "        )",
            "        page = request.args.get(",
            "            'page',",
            "            default=None,",
            "            type=str",
            "        )",
            "        if page:",
            "            try:",
            "                page = decode_last_evaluated_key(page)",
            "            except Exception:",
            "                logger.exception('Failed to parse provided page')",
            "                return jsonify({'error': 'Failed to parse page'}), 400",
            "        if limit:",
            "            results = Credential.data_type_date_index.query(",
            "                'credential',",
            "                scan_index_forward=False,",
            "                limit=limit,",
            "                last_evaluated_key=page,",
            "            )",
            "            credentials_response = CredentialsResponse.from_credentials(",
            "                [credential for credential in results],",
            "                next_page=results.last_evaluated_key,",
            "            )",
            "        else:",
            "            credentials_response = CredentialsResponse.from_credentials([",
            "                credential",
            "                for credential in",
            "                Credential.data_type_date_index.query('credential')",
            "            ])",
            "",
            "        return credentials_response_schema.dumps(credentials_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_credential(id):",
            "    \"\"\"",
            "    Returns a credential object for the provided credential id.",
            "",
            "    .. :quickref: Credential; Get a credential from the provided id.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :param id: The credential ID to get.",
            "    :type id: str",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"...\",",
            "         \"name\": \"Example Credential\",",
            "         \"credential_keys\": [",
            "           \"api_key\",",
            "           \"api_user\"",
            "         ],",
            "         \"credential_pairs\": {",
            "           \"api_key\": \"1234\",",
            "           \"api_user\": \"example_user\"",
            "         },",
            "         \"metadata\": {",
            "           \"example_metadata_key\": \"example_value\"",
            "         },",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"documentation\": \"Example documentation\",",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"permissions\": {",
            "           \"metadata\": true,",
            "           \"get\": true,",
            "           \"update\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get the credential for",
            "                     the provided ID.",
            "    :statuscode 404: The provided credential ID does not exist.",
            "    \"\"\"",
            "    with stats.timer('get_credential_by_id'):",
            "        metadata_only = misc.get_boolean(request.args.get('metadata_only'))",
            "",
            "        if not acl_module_check(resource_type='credential',",
            "                                action='metadata',",
            "                                resource_id=id):",
            "            msg = \"{} does not have access to credential {}\".format(",
            "                authnz.get_logged_in_user(),",
            "                id",
            "            )",
            "            error_msg = {'error': msg, 'reference': id}",
            "            return jsonify(error_msg), 403",
            "",
            "        try:",
            "            credential = Credential.get(id)",
            "        except DoesNotExist:",
            "            logger.warning(",
            "                'Item with id {0} does not exist.'.format(id)",
            "            )",
            "            return jsonify({}), 404",
            "        if credential.data_type != 'credential':",
            "            return jsonify({}), 404",
            "",
            "        permissions = {",
            "            'metadata': True,",
            "            'get': acl_module_check(",
            "                resource_type='credential',",
            "                action='get',",
            "                resource_id=id",
            "            ),",
            "            'update': acl_module_check(",
            "                resource_type='credential',",
            "                action='update',",
            "                resource_id=id",
            "            ),",
            "        }",
            "        include_credential_pairs = False",
            "        if not metadata_only and acl_module_check(resource_type='credential',",
            "                                                  action='get',",
            "                                                  resource_id=id):",
            "            permissions['get'] = True",
            "            include_credential_pairs = True",
            "",
            "            if settings.ENABLE_SAVE_LAST_DECRYPTION_TIME:",
            "                # Also try to save the archived credential to stay consistent",
            "                try:",
            "                    archived_credential = Credential.get(",
            "                        '{}-{}'.format(id, credential.revision)",
            "                    )",
            "                except DoesNotExist:",
            "                    archived_credential = None",
            "                    logger.error('Archived credential {}-{} not found'.format(",
            "                            id, credential.revision)",
            "                    )",
            "                now = misc.utcnow()",
            "                credential.last_decrypted_date = now",
            "                credential.save()",
            "                if archived_credential:",
            "                    archived_credential.last_decrypted_date = now",
            "                    archived_credential.save()",
            "",
            "            log_line = \"{0} get credential {1}\".format(",
            "                authnz.get_logged_in_user(),",
            "                id",
            "            )",
            "            logger.info(log_line)",
            "",
            "        credential_response = CredentialResponse.from_credential(",
            "            credential,",
            "            include_credential_keys=True,",
            "            include_credential_pairs=include_credential_pairs,",
            "        )",
            "        credential_response.permissions = permissions",
            "",
            "        return credential_response_schema.dumps(credential_response)",
            "",
            "",
            "@blueprint.route(",
            "    '/v1/credentials/<id>/<old_revision>/<new_revision>',",
            "    methods=['GET']",
            ")",
            "@authnz.require_auth",
            "def diff_credential(id, old_revision, new_revision):",
            "    \"\"\"",
            "    Returns a diff between old_revision and new_revision for the provided",
            "    credential id.",
            "",
            "    .. :quickref: Credential Diff; Get a diff of two revisions of a credential.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials/abcd12345bf4f1cafe8e722d3860404/1/2",
            "",
            "    :param id: The credential ID to get.",
            "    :type id: str",
            "    :param old_revision: One of the two revisions to diff against.",
            "    :type old_revision: int",
            "    :param new_revision: One of the two revisions to diff against.",
            "    :type new_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"name\": {",
            "           \"added\": \"New credential name\",",
            "           \"removed\": \"Example credential name\"",
            "         },",
            "         \"credential_pairs\": {",
            "           \"added\": [",
            "             \"api_key\",",
            "             \"api_user\"",
            "           ],",
            "           \"removed\": [",
            "             \"api_certificate\"",
            "           ]",
            "         },",
            "         \"metadata\": {",
            "           \"added\": \"example_key\"",
            "         },",
            "         \"enabled\": {",
            "           \"added\": false,",
            "           \"removed\": true",
            "         },",
            "         \"documentation\": {",
            "           \"added\": \"The way you rotate this credential is to...\",",
            "           \"removed\": \"Example documentation\"",
            "         },",
            "         \"modified_date\": {",
            "           \"added\": \"2019-12-16T23:16:11.413299+00:00\",",
            "           \"removed\": \"2019-11-16T23:16:11.413299+00:00\"",
            "         },",
            "         \"modified_by\": {",
            "           \"added\": \"rlane@example.com\",",
            "           \"removed\": \"testuser@example.com\"",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to diff the provided",
            "                     credential ID.",
            "    :statuscode 404: The provided credential ID or one of the provided",
            "                     revisions does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to diff credential {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        old_credential = Credential.get('{}-{}'.format(id, old_revision))",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Credential not found.'}), 404",
            "    if old_credential.data_type != 'archive-credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        new_credential = Credential.get('{}-{}'.format(id, new_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if new_credential.data_type != 'archive-credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    return jsonify(old_credential.diff(new_credential))",
            "",
            "",
            "@blueprint.route('/v1/archive/credentials/<id>', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_archive_credential_revisions(id):",
            "    \"\"\"",
            "    Returns a list of the metadata of all the revisions of the provided",
            "    credential.",
            "",
            "    .. :quickref: Credential Revisions; Get a list of the metadata of all the",
            "                  revisions of the provided credential.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"revisions\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404-1\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [],",
            "             \"credential_pairs\": {},",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         next_page: null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get credential",
            "                     metadata for the provided credential ID.",
            "    :statuscode 404: The provided credential ID does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to credential {} revisions\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        cred = Credential.get(id)",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if (cred.data_type != 'credential' and",
            "            cred.data_type != 'archive-credential'):",
            "        return jsonify({}), 404",
            "    revisions_response = RevisionsResponse.from_credentials(",
            "        Credential.batch_get(",
            "            credentialmanager.get_revision_ids_for_credential(cred)",
            "        )",
            "    )",
            "    return revisions_response_schema.dumps(revisions_response)",
            "",
            "",
            "@blueprint.route('/v1/archive/credentials', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_archive_credential_list():",
            "    \"\"\"",
            "    Returns a list of the metadata of all the history revisions of credentials.",
            "",
            "    .. :quickref: Credential History; Get a list of the metadata for all history",
            "                  revision credentials.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"revisions\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404-1\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [],",
            "             \"credential_pairs\": {},",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         next_page: null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list credentials",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential', action='list'):",
            "        msg = \"{} does not have access to list credentials\".format(",
            "            authnz.get_logged_in_user()",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "",
            "    limit = request.args.get(",
            "        'limit',",
            "        default=settings.HISTORY_PAGE_LIMIT,",
            "        type=int,",
            "    )",
            "    page = request.args.get('page', default=None, type=str)",
            "    if page:",
            "        try:",
            "            page = decode_last_evaluated_key(page)",
            "        except Exception:",
            "            logger.exception('Failed to parse provided page')",
            "            return jsonify({'error': 'Failed to parse page'}), 400",
            "    results = Credential.data_type_date_index.query(",
            "        'archive-credential',",
            "        scan_index_forward=False,",
            "        limit=limit,",
            "        last_evaluated_key=page,",
            "    )",
            "    credentials_response = CredentialsResponse.from_credentials(",
            "        [credential for credential in results],",
            "        next_page=results.last_evaluated_key,",
            "    )",
            "    return credentials_response_schema.dumps(credentials_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials', methods=['POST'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def create_credential():",
            "    '''",
            "    Create a credential using the data provided in the POST body.",
            "",
            "    .. :quickref: Credential; Create a credential using the data provided in",
            "                  the post body.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       POST /v1/credentials",
            "",
            "    :<json string name: The friendly name for the credential. (required)",
            "    :<json Dictionary{string: string} credential_pairs: A dictionary of",
            "      arbitrary key/value pairs to be encrypted at rest. (required)",
            "    :<json Dictionary{string: string} metadata: A dictionary of arbitrary key/",
            "      value pairs for custom per-credential end-user extensions. This is not",
            "      encrypted at rest.",
            "    :<json boolean enabled: Whether or not this credential is enabled.",
            "      (default: true)",
            "    :<json string documentation: End-user provided documentation for this",
            "      credential. (required)",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "          \"name\": \"Example Credential\",",
            "          \"credential_keys\": [\"example_credential_key\"],",
            "          \"credential_pairs\": {",
            "            \"example_credential_key\": \"example_credential_value\"",
            "          },",
            "          \"metadata\": {",
            "            \"example_metadata_key\": \"example_value\"",
            "          },",
            "          \"revision\": 1,",
            "          \"enabled\": true,",
            "          \"documentation\": \"Example documentation\",",
            "          \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "          \"modified_by\": \"rlane@example.com\",",
            "          \"permissions\": {",
            "            \"metadata\": true,",
            "            \"get\": true,",
            "            \"update\": true",
            "          }",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; either the data provided was not in the",
            "                     correct format, or a required field was not provided.",
            "    :statuscode 403: Client does not have access to create credentials.",
            "    '''",
            "    with stats.timer('create_credential'):",
            "        if not acl_module_check(resource_type='credential', action='create'):",
            "            msg = f\"{authnz.get_logged_in_user()}\"",
            "            msg += \"does not have access to create credentials\"",
            "            error_msg = {'error': msg}",
            "            return jsonify(error_msg), 403",
            "",
            "        data = request.get_json()",
            "        if not data.get('documentation') \\",
            "                and settings.get('ENFORCE_DOCUMENTATION'):",
            "            return jsonify({'error': 'documentation is a required field'}), 400",
            "        if not data.get('credential_pairs'):",
            "            error = {'error': 'credential_pairs is a required field'}",
            "            return jsonify(error), 400",
            "        if not isinstance(data.get('metadata', {}), dict):",
            "            return jsonify({'error': 'metadata must be a dict'}), 400",
            "        # Ensure credential pair keys are lowercase",
            "        credential_pairs = credentialmanager.lowercase_credential_pairs(",
            "            data['credential_pairs']",
            "        )",
            "        _check, ret = credentialmanager.check_credential_pair_values(",
            "            credential_pairs",
            "        )",
            "        if not _check:",
            "            return jsonify(ret), 400",
            "        for cred in Credential.data_type_date_index.query(",
            "                'credential', filter_condition=Credential.name == data['name']):",
            "            # Conflict, the name already exists",
            "            msg = f'Name already exists. See id: {cred.id}'",
            "            return jsonify({'error': msg, 'reference': cred.id}), 409",
            "        # Generate an initial stable ID to allow name changes",
            "        id = str(uuid.uuid4()).replace('-', '')",
            "        # Try to save to the archive",
            "        revision = 1",
            "        credential_pairs = json.dumps(credential_pairs)",
            "        data_key = keymanager.create_datakey(encryption_context={'id': id})",
            "        cipher = CipherManager(data_key['plaintext'], version=2)",
            "        credential_pairs = cipher.encrypt(credential_pairs)",
            "        last_rotation_date = misc.utcnow()",
            "",
            "        cred = Credential(",
            "            id=f'{id}-{revision}',",
            "            data_type='archive-credential',",
            "            name=data.get('name'),",
            "            credential_pairs=credential_pairs,",
            "            metadata=data.get('metadata'),",
            "            revision=revision,",
            "            enabled=data.get('enabled'),",
            "            data_key=data_key['ciphertext'],",
            "            cipher_version=2,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=data.get('documentation'),",
            "            tags=data.get('tags', []),",
            "            last_rotation_date=last_rotation_date,",
            "        ).save()",
            "        # Make this the current revision",
            "        cred = Credential(",
            "            id=id,",
            "            data_type='credential',",
            "            name=data.get('name'),",
            "            credential_pairs=credential_pairs,",
            "            metadata=data.get('metadata'),",
            "            revision=revision,",
            "            enabled=data.get('enabled'),",
            "            data_key=data_key['ciphertext'],",
            "            cipher_version=2,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=data.get('documentation'),",
            "            tags=data.get('tags', []),",
            "            last_rotation_date=last_rotation_date,",
            "        )",
            "        cred.save()",
            "        permissions = {",
            "            'metadata': True,",
            "            'get': True,",
            "            'update': True,",
            "        }",
            "        credential_response = CredentialResponse.from_credential(",
            "            cred,",
            "            include_credential_keys=True,",
            "            include_credential_pairs=True,",
            "        )",
            "        credential_response.permissions = permissions",
            "        return credential_response_schema.dumps(credential_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>/services', methods=['GET'])",
            "@authnz.require_auth",
            "def get_credential_dependencies(id):",
            "    \"\"\"",
            "    Returns a list of services that this credential is mapped to.",
            "",
            "    .. :quickref: Credential Mappings; Get a list of services that this",
            "                  credential is mapped to.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/credentials/abcd12345bf4f1cafe8e722d3860404/services",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"services\": [\"example-development\", \"example2-development\"]",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get metadata for the",
            "                     provided credential.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to get dependencies for credential {}\"",
            "        msg = msg.format(authnz.get_logged_in_user(), id)",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    services = servicemanager.get_services_for_credential(id)",
            "    _services = [{'id': x.id, 'enabled': x.enabled} for x in services]",
            "    return jsonify({'services': _services})",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>', methods=['PUT'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def update_credential(id):",
            "    '''",
            "    Update the provided credential using the data provided in the POST body.",
            "",
            "    .. :quickref: Credential; Update the provided credential using the data",
            "                  provided in the post body.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/credentials/abcd12345bf4f1cafe8e722d3860404",
            "",
            "    :param id: The credential ID to update.",
            "    :type id: str",
            "    :<json string name: The friendly name for the credential.",
            "    :<json Dictionary{string: string} credential_pairs: A dictionary of",
            "      arbitrary key/value pairs to be encrypted at rest.",
            "    :<json Dictionary{string: string} metadata: A dictionary of arbitrary key/",
            "      value pairs for custom per-credential end-user extensions. This is not",
            "      encrypted at rest.",
            "    :<json boolean enabled: Whether or not this credential is enabled.",
            "    :<json string documentation: End-user provided documentation for this",
            "      credential.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "          \"name\": \"Example Credential\",",
            "          \"credential_keys\": [\"example_credential_key\"],",
            "          \"credential_pairs\": {",
            "            \"example_credential_key\": \"example_credential_value\"",
            "          },",
            "          \"metadata\": {",
            "            \"example_metadata_key\": \"example_value\"",
            "          },",
            "          \"revision\": 1,",
            "          \"enabled\": true,",
            "          \"documentation\": \"Example documentation\",",
            "          \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "          \"modified_by\": \"rlane@example.com\",",
            "          \"permissions\": {",
            "            \"metadata\": true,",
            "            \"get\": true,",
            "            \"update\": true",
            "          }",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; either the data provided was not in the",
            "                     correct format, or the update would create conflicting",
            "                     credential keys in a mapped service.",
            "    :statuscode 403: Client does not have access to update the provided",
            "                     credential ID.",
            "    '''",
            "    with stats.timer('update_credential'):",
            "        if not acl_module_check(resource_type='credential',",
            "                                action='update',",
            "                                resource_id=id):",
            "            msg = f\"{authnz.get_logged_in_user()}\"",
            "            msg += f\"does not have access to update credential {id}\"",
            "            error_msg = {'error': msg, 'reference': id}",
            "            return jsonify(error_msg), 403",
            "",
            "        try:",
            "            _cred = Credential.get(id)",
            "        except DoesNotExist:",
            "            return jsonify({'error': 'Credential not found.'}), 404",
            "        if _cred.data_type != 'credential':",
            "            msg = 'id provided is not a credential.'",
            "            return jsonify({'error': msg}), 400",
            "",
            "        data = request.get_json()",
            "        if not isinstance(data.get('metadata', {}), dict):",
            "            return jsonify({'error': 'metadata must be a dict'}), 400",
            "",
            "        # We check for a name change and ensure it doesn't conflict with an",
            "        # existing credential name",
            "        if data.get('name') != _cred.name:",
            "            for cred in Credential.data_type_date_index.query(",
            "                    'credential',",
            "                    filter_condition=Credential.name == data.get('name')):",
            "                # Conflict, the name already exists",
            "                msg = f'Name already exists. See id: {cred.id}'",
            "                return jsonify({'error': msg, 'reference': cred.id}), 409",
            "",
            "        update = {",
            "            'name': data.get('name', _cred.name),",
            "            'last_rotation_date': _cred.last_rotation_date,",
            "            'credential_pairs': _cred.credential_pairs,",
            "            'enabled': _cred.enabled,",
            "            'metadata': data.get('metadata', _cred.metadata),",
            "            'documentation': data.get('documentation', _cred.documentation),",
            "            'tags': data.get('tags', _cred.tags),",
            "        }",
            "        # Enforce documentation, EXCEPT if we are restoring an old revision",
            "        if (not update['documentation'] and",
            "                settings.get('ENFORCE_DOCUMENTATION') and",
            "                not data.get('revision')):",
            "            return jsonify({'error': 'documentation is a required field'}), 400",
            "        if 'enabled' in data:",
            "            if not isinstance(data['enabled'], bool):",
            "                return jsonify({'error': 'Enabled must be a boolean.'}), 400",
            "            update['enabled'] = data['enabled']",
            "",
            "        services = servicemanager.get_services_for_credential(id)",
            "        revision = credentialmanager.get_latest_credential_revision(",
            "            id,",
            "            _cred.revision",
            "        )",
            "        if 'credential_pairs' in data:",
            "            # Ensure the credential is not empty",
            "            if data['credential_pairs'] == {}:",
            "                error = {'error': 'Credential Pairs cannot be empty.'}",
            "                return jsonify(error), 400",
            "",
            "            # Ensure credential pair keys are lowercase",
            "            credential_pairs = credentialmanager.lowercase_credential_pairs(",
            "                data['credential_pairs']",
            "            )",
            "            _check, ret = credentialmanager.check_credential_pair_values(",
            "                credential_pairs",
            "            )",
            "            if not _check:",
            "                return jsonify(ret), 400",
            "            # Ensure credential pairs don't conflicts with pairs from other",
            "            # services",
            "            conflicts = servicemanager.pair_key_conflicts_for_services(",
            "                id,",
            "                list(credential_pairs.keys()),",
            "                services",
            "            )",
            "            if conflicts:",
            "                ret = {",
            "                    'error': 'Conflicting key pairs in mapped service.',",
            "                    'conflicts': conflicts",
            "                }",
            "                return jsonify(ret), 400",
            "",
            "            # If the credential pair passed in the update is different from the",
            "            # decrypted credential pair of the most recent revision, assume that",
            "            # this is a new credential pair and update last_rotation_date",
            "            if credential_pairs != _cred.decrypted_credential_pairs:",
            "                update['last_rotation_date'] = misc.utcnow()",
            "",
            "            data_key = keymanager.create_datakey(encryption_context={'id': id})",
            "            cipher = CipherManager(data_key['plaintext'], version=2)",
            "            update['credential_pairs'] = cipher.encrypt(",
            "                json.dumps(credential_pairs)",
            "            )",
            "",
            "        # Try to save to the archive",
            "        try:",
            "            Credential(",
            "                id=f'{id}-{revision}',",
            "                name=update['name'],",
            "                data_type='archive-credential',",
            "                credential_pairs=update['credential_pairs'],",
            "                metadata=update['metadata'],",
            "                enabled=update['enabled'],",
            "                revision=revision,",
            "                data_key=data_key['ciphertext'],",
            "                cipher_version=2,",
            "                modified_by=authnz.get_logged_in_user(),",
            "                documentation=update['documentation'],",
            "                tags=update['tags'],",
            "                last_rotation_date=update['last_rotation_date'],",
            "            ).save()",
            "        except PutError as e:",
            "            logger.error(e)",
            "            error = {'error': 'Failed to add credential to archive.'}",
            "            return jsonify(error), 500",
            "        try:",
            "            cred = Credential(",
            "                id=id,",
            "                name=update['name'],",
            "                data_type='credential',",
            "                credential_pairs=update['credential_pairs'],",
            "                metadata=update['metadata'],",
            "                enabled=update['enabled'],",
            "                revision=revision,",
            "                data_key=data_key['ciphertext'],",
            "                cipher_version=2,",
            "                modified_by=authnz.get_logged_in_user(),",
            "                documentation=update['documentation'],",
            "                tags=update['tags'],",
            "                last_rotation_date=update['last_rotation_date'],",
            "            )",
            "            cred.save()",
            "        except PutError as e:",
            "            logger.error(e)",
            "            error = {'error': 'Failed to update active credential.'}",
            "            return jsonify(error), 500",
            "",
            "        if services:",
            "            service_names = [x.id for x in services]",
            "            msg = f'Updated credential \"{cred.name}\"'",
            "            msg += f'({cred.id}); Revision {cred.revision}'",
            "            graphite.send_event(service_names, msg)",
            "            webhook.send_event('credential_update', service_names, [cred.id])",
            "        permissions = {",
            "            'metadata': True,",
            "            'get': True,",
            "            'update': True,",
            "        }",
            "        credential_response = CredentialResponse.from_credential(",
            "            cred,",
            "            include_credential_keys=True,",
            "            include_credential_pairs=True,",
            "        )",
            "        credential_response.permissions = permissions",
            "        return credential_response_schema.dumps(credential_response)",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>/<to_revision>', methods=['PUT'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def revert_credential_to_revision(id, to_revision):",
            "    '''",
            "    Revert the provided credential to the provided revision.",
            "",
            "    .. :quickref: Credential; Revert the provided credential to the provided",
            "                  revision",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/credentials/abcd12345bf4f1cafe8e722d3860404/1",
            "",
            "    :param id: The credential ID to revert.",
            "    :type id: str",
            "    :param to_revision: The revision to revert this credential to.",
            "    :type to_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "          \"name\": \"Example Credential\",",
            "          \"credential_keys\": [\"example_credential_key\"],",
            "          \"credential_pairs\": {},",
            "          \"metadata\": {",
            "            \"example_metadata_key\": \"example_value\"",
            "          },",
            "          \"revision\": 1,",
            "          \"enabled\": true,",
            "          \"documentation\": \"Example documentation\",",
            "          \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "          \"modified_by\": \"rlane@example.com\",",
            "          \"permissions\": {",
            "            \"metadata\": true,",
            "            \"get\": true,",
            "            \"update\": true",
            "          }",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; the update would create conflicting",
            "                     credential keys in a mapped service.",
            "    :statuscode 403: Client does not have access to revert the provided",
            "                     credential ID.",
            "    '''",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='revert',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to revert credential {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        current_credential = Credential.get(id)",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Credential not found.'}), 404",
            "    if current_credential.data_type != 'credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    new_revision = credentialmanager.get_latest_credential_revision(",
            "        id,",
            "        current_credential.revision",
            "    )",
            "    try:",
            "        revert_credential = Credential.get('{}-{}'.format(id, to_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if revert_credential.data_type != 'archive-credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "    if revert_credential.equals(current_credential):",
            "        ret = {",
            "            'error': 'No difference between old and new credential.'",
            "        }",
            "        return jsonify(ret), 400",
            "    services = servicemanager.get_services_for_credential(id)",
            "    if revert_credential.credential_pairs:",
            "        _credential_pairs = revert_credential.decrypted_credential_pairs",
            "        _check, ret = credentialmanager.check_credential_pair_values(",
            "            _credential_pairs",
            "        )",
            "        if not _check:",
            "            return jsonify(ret), 400",
            "        # Ensure credential pairs don't conflicts with pairs from other",
            "        # services",
            "        conflicts = servicemanager.pair_key_conflicts_for_services(",
            "            id,",
            "            list(_credential_pairs.keys()),",
            "            services",
            "        )",
            "        if conflicts:",
            "            ret = {",
            "                'error': 'Conflicting key pairs in mapped service.',",
            "                'conflicts': conflicts",
            "            }",
            "            return jsonify(ret), 400",
            "    # Try to save to the archive",
            "    try:",
            "        Credential(",
            "            id='{0}-{1}'.format(id, new_revision),",
            "            name=revert_credential.name,",
            "            data_type='archive-credential',",
            "            credential_pairs=revert_credential.credential_pairs,",
            "            metadata=revert_credential.metadata,",
            "            enabled=revert_credential.enabled,",
            "            revision=new_revision,",
            "            data_key=revert_credential.data_key,",
            "            cipher_version=revert_credential.cipher_version,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=revert_credential.documentation,",
            "            tags=revert_credential.tags,",
            "            last_rotation_date=revert_credential.last_rotation_date,",
            "        ).save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to add credential to archive.'}), 500",
            "    try:",
            "        cred = Credential(",
            "            id=id,",
            "            name=revert_credential.name,",
            "            data_type='credential',",
            "            credential_pairs=revert_credential.credential_pairs,",
            "            metadata=revert_credential.metadata,",
            "            enabled=revert_credential.enabled,",
            "            revision=new_revision,",
            "            data_key=revert_credential.data_key,",
            "            cipher_version=revert_credential.cipher_version,",
            "            modified_by=authnz.get_logged_in_user(),",
            "            documentation=revert_credential.documentation,",
            "            tags=revert_credential.tags,",
            "            last_rotation_date=revert_credential.last_rotation_date,",
            "        )",
            "        cred.save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to update active credential.'}), 500",
            "    if services:",
            "        service_names = [x.id for x in services]",
            "        msg = 'Updated credential \"{0}\" ({1}); Revision {2}'",
            "        msg = msg.format(cred.name, cred.id, cred.revision)",
            "        graphite.send_event(service_names, msg)",
            "        webhook.send_event('credential_update', service_names, [cred.id])",
            "    return credential_response_schema.dumps(",
            "        CredentialResponse.from_credential(cred)",
            "    )",
            "",
            "",
            "@blueprint.route('/v1/value_generator', methods=['GET'])",
            "def generate_value():",
            "    \"\"\"",
            "    Returns a randomly generated value, for use in credential pairs.",
            "",
            "    .. :quickref: Random Value; Get a randomly generated value, for use in",
            "                  credential pairs.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/value_generator",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"value\": \"c5S0w08YwU4PY3EZ7eQf4QYYUIT6ryyKOydhjyTti9pjPuMU00\"",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    \"\"\"",
            "    kms_client = clients.get_boto_client('kms', endpoint_url=settings.KMS_URL)",
            "    value = kms_client.generate_random(NumberOfBytes=128)['Plaintext']",
            "    value = base64.urlsafe_b64encode(value).decode('UTF-8')",
            "    value = re.sub(r'[\\W_]+', '', value)",
            "    if len(value) > VALUE_LENGTH:",
            "        value = value[:VALUE_LENGTH]",
            "    return jsonify({'value': value})",
            "",
            "",
            "@blueprint.route('/v1/credentials/<id>/archive', methods=['POST'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def archive_credential(id):",
            "    '''",
            "    Archive the provided credential.",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       POST /v1/credentials/abcd12345bf4f1cafe8e722d3860404/archive",
            "",
            "    :param id: The credential ID to update.",
            "    :<json bool force: Run the archive operation, if false will only validate",
            "        the provided input",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "        {",
            "          \"result\": \"success\"",
            "        }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input or state",
            "    :statuscode 403: Client does not have access to archive the provided",
            "                     credential ID.",
            "    '''",
            "    if not acl_module_check(resource_type='credential',",
            "                            action='archive',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to archive credential {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        _cred = Credential.get(id)",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Credential not found.'}), 404",
            "    if _cred.data_type != 'credential':",
            "        msg = 'id provided is not a credential.'",
            "        return jsonify({'error': msg}), 400",
            "",
            "    data = request.get_json()",
            "    force = data.get('force', False) if data else False",
            "    if not isinstance(force, bool):",
            "        return jsonify({'error': 'force must be a boolean.'}), 400",
            "",
            "    failed = credentialmanager.archive_credentials([_cred], force)",
            "    if failed and id in failed:",
            "        return jsonify({'error': failed[id]}), 400",
            "",
            "    result = 'dry-run success'",
            "    if force:",
            "        result = 'success'",
            "    return jsonify({'result': result}), 200"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": []
    },
    "confidant/routes/services.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 76,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 77,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 78,
                "PatchRowcode": " @blueprint.route('/v1/services', methods=['GET'])"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "4": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 80,
                "PatchRowcode": " @authnz.require_auth"
            },
            "5": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 81,
                "PatchRowcode": " def get_service_list():"
            },
            "6": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 82,
                "PatchRowcode": "     \"\"\""
            },
            "7": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": 165,
                "PatchRowcode": "             services_response = ServicesResponse.from_services("
            },
            "8": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "                 Service.data_type_date_index.query('service'),"
            },
            "9": {
                "beforePatchRowNumber": 166,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "             )"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 168,
                "PatchRowcode": "+"
            },
            "11": {
                "beforePatchRowNumber": 167,
                "afterPatchRowNumber": 169,
                "PatchRowcode": "         return services_response_schema.dumps(services_response)"
            },
            "12": {
                "beforePatchRowNumber": 168,
                "afterPatchRowNumber": 170,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 169,
                "afterPatchRowNumber": 171,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": 172,
                "PatchRowcode": " @blueprint.route('/v1/services/<id>', methods=['GET'])"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 173,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "16": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": 174,
                "PatchRowcode": " @authnz.require_auth"
            },
            "17": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 175,
                "PatchRowcode": " def get_service(id):"
            },
            "18": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": 176,
                "PatchRowcode": "     '''"
            },
            "19": {
                "beforePatchRowNumber": 334,
                "afterPatchRowNumber": 337,
                "PatchRowcode": " "
            },
            "20": {
                "beforePatchRowNumber": 335,
                "afterPatchRowNumber": 338,
                "PatchRowcode": " "
            },
            "21": {
                "beforePatchRowNumber": 336,
                "afterPatchRowNumber": 339,
                "PatchRowcode": " @blueprint.route('/v1/archive/services/<id>', methods=['GET'])"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 340,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "23": {
                "beforePatchRowNumber": 337,
                "afterPatchRowNumber": 341,
                "PatchRowcode": " @authnz.require_auth"
            },
            "24": {
                "beforePatchRowNumber": 338,
                "afterPatchRowNumber": 342,
                "PatchRowcode": " def get_archive_service_revisions(id):"
            },
            "25": {
                "beforePatchRowNumber": 339,
                "afterPatchRowNumber": 343,
                "PatchRowcode": "     \"\"\""
            },
            "26": {
                "beforePatchRowNumber": 414,
                "afterPatchRowNumber": 418,
                "PatchRowcode": " "
            },
            "27": {
                "beforePatchRowNumber": 415,
                "afterPatchRowNumber": 419,
                "PatchRowcode": " "
            },
            "28": {
                "beforePatchRowNumber": 416,
                "afterPatchRowNumber": 420,
                "PatchRowcode": " @blueprint.route('/v1/archive/services', methods=['GET'])"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 421,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "30": {
                "beforePatchRowNumber": 417,
                "afterPatchRowNumber": 422,
                "PatchRowcode": " @authnz.require_auth"
            },
            "31": {
                "beforePatchRowNumber": 418,
                "afterPatchRowNumber": 423,
                "PatchRowcode": " def get_archive_service_list():"
            },
            "32": {
                "beforePatchRowNumber": 419,
                "afterPatchRowNumber": 424,
                "PatchRowcode": "     \"\"\""
            },
            "33": {
                "beforePatchRowNumber": 492,
                "afterPatchRowNumber": 497,
                "PatchRowcode": " "
            },
            "34": {
                "beforePatchRowNumber": 493,
                "afterPatchRowNumber": 498,
                "PatchRowcode": " "
            },
            "35": {
                "beforePatchRowNumber": 494,
                "afterPatchRowNumber": 499,
                "PatchRowcode": " @blueprint.route('/v1/services/<id>', methods=['PUT'])"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 500,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "37": {
                "beforePatchRowNumber": 495,
                "afterPatchRowNumber": 501,
                "PatchRowcode": " @authnz.require_auth"
            },
            "38": {
                "beforePatchRowNumber": 496,
                "afterPatchRowNumber": 502,
                "PatchRowcode": " @authnz.require_csrf_token"
            },
            "39": {
                "beforePatchRowNumber": 497,
                "afterPatchRowNumber": 503,
                "PatchRowcode": " @maintenance.check_maintenance_mode"
            },
            "40": {
                "beforePatchRowNumber": 701,
                "afterPatchRowNumber": 707,
                "PatchRowcode": " "
            },
            "41": {
                "beforePatchRowNumber": 702,
                "afterPatchRowNumber": 708,
                "PatchRowcode": " "
            },
            "42": {
                "beforePatchRowNumber": 703,
                "afterPatchRowNumber": 709,
                "PatchRowcode": " @blueprint.route('/v1/services/<id>/<to_revision>', methods=['PUT'])"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 710,
                "PatchRowcode": "+@misc.prevent_xss_decorator"
            },
            "44": {
                "beforePatchRowNumber": 704,
                "afterPatchRowNumber": 711,
                "PatchRowcode": " @authnz.require_auth"
            },
            "45": {
                "beforePatchRowNumber": 705,
                "afterPatchRowNumber": 712,
                "PatchRowcode": " @authnz.require_csrf_token"
            },
            "46": {
                "beforePatchRowNumber": 706,
                "afterPatchRowNumber": 713,
                "PatchRowcode": " @maintenance.check_maintenance_mode"
            }
        },
        "frontPatchFile": [
            "import logging",
            "",
            "from flask import blueprints, jsonify, request",
            "from pynamodb.exceptions import DoesNotExist, PutError",
            "",
            "from confidant import authnz, settings",
            "from confidant.models.service import Service",
            "from confidant.schema.services import (",
            "    ServiceResponse,",
            "    ServicesResponse,",
            "    service_expanded_response_schema,",
            "    services_response_schema,",
            "    RevisionsResponse,",
            "    revisions_response_schema,",
            ")",
            "from confidant.services import (",
            "    credentialmanager,",
            "    iamrolemanager,",
            "    keymanager,",
            "    servicemanager,",
            "    webhook,",
            ")",
            "from confidant.utils import maintenance, misc, stats",
            "from confidant.utils.dynamodb import decode_last_evaluated_key",
            "",
            "logger = logging.getLogger(__name__)",
            "blueprint = blueprints.Blueprint('services', __name__)",
            "",
            "acl_module_check = misc.load_module(settings.ACL_MODULE)",
            "",
            "",
            "@blueprint.route('/v1/roles', methods=['GET'])",
            "@authnz.require_auth",
            "def get_iam_roles_list():",
            "    \"\"\"",
            "    Get a list of IAM roles from the configured AWS account.",
            "",
            "    .. :quickref: IAM Roles; Get a list of IAM roles from the configured",
            "                  AWS account.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/roles",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"roles\": [",
            "           'example-development',",
            "           'example2-development',",
            "           ...",
            "         ]",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list services.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='list'):",
            "        msg = \"{} does not have access to list services\".format(",
            "            authnz.get_logged_in_user()",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "",
            "    roles = iamrolemanager.get_iam_roles()",
            "    return jsonify({'roles': roles})",
            "",
            "",
            "@blueprint.route('/v1/services', methods=['GET'])",
            "@authnz.require_auth",
            "def get_service_list():",
            "    \"\"\"",
            "    Get a list of current service revisions.",
            "",
            "    .. :quickref: Services; Get a list of current service revisions.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/services",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "    :query int limit: Limit of items per each page (required for pagination)",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"services\": [",
            "           {",
            "             \"id\": \"example-development\",",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"account\": null,",
            "             \"credentials\": [],",
            "             \"blind_credentials\": [],",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"next_page\": null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list services.",
            "    \"\"\"",
            "    with stats.timer('list_services'):",
            "        if not acl_module_check(resource_type='service',",
            "                                action='list'):",
            "            msg = \"{} does not have access to list services\".format(",
            "                authnz.get_logged_in_user()",
            "            )",
            "            error_msg = {'error': msg}",
            "            return jsonify(error_msg), 403",
            "",
            "        limit = request.args.get(",
            "            'limit',",
            "            default=None,",
            "            type=int,",
            "        )",
            "        page = request.args.get(",
            "            'page',",
            "            default=None,",
            "            type=str",
            "        )",
            "",
            "        if page:",
            "            try:",
            "                page = decode_last_evaluated_key(page)",
            "            except Exception:",
            "                logger.exception('Failed to parse provided page')",
            "                return jsonify({'error': 'Failed to parse page'}), 400",
            "",
            "        if limit:",
            "            results = Service.data_type_date_index.query(",
            "                'service',",
            "                scan_index_forward=False,",
            "                limit=limit,",
            "                last_evaluated_key=page,",
            "            )",
            "            services_response = ServicesResponse.from_services(",
            "                [result for result in results],",
            "                next_page=results.last_evaluated_key",
            "            )",
            "        else:",
            "            services_response = ServicesResponse.from_services(",
            "                Service.data_type_date_index.query('service'),",
            "            )",
            "        return services_response_schema.dumps(services_response)",
            "",
            "",
            "@blueprint.route('/v1/services/<id>', methods=['GET'])",
            "@authnz.require_auth",
            "def get_service(id):",
            "    '''",
            "    Get a service object from the provided service ID.",
            "",
            "    .. :quickref: Service; Get a service object from the provided service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/services/example-development",
            "",
            "    :param id: The service ID to get.",
            "    :type id: str",
            "    :query boolean metadata_only: If true, only fetch metadata for this",
            "      service, and do not respond with decrypted credential pairs in the",
            "      credential responses.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"account\": null,",
            "         \"credentials\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [\"test_key\"],",
            "             \"credential_pairs\": {",
            "               \"test_key\": \"test_value\"",
            "             },",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"blind_credentials\": [],",
            "         \"permissions\": {",
            "           \"metadata\": true,",
            "           \"get\": true,",
            "           \"update\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get the service ID",
            "                     provided.",
            "    '''",
            "    with stats.timer('get_service_by_id'):",
            "        with stats.timer('get_service_by_id.acl_check_get_service'):",
            "            permissions = {",
            "                'metadata': False,",
            "                'get': False,",
            "                'update': False,",
            "            }",
            "            metadata_only = misc.get_boolean(request.args.get('metadata_only'))",
            "            logged_in_user = authnz.get_logged_in_user()",
            "            action = 'metadata' if metadata_only else 'get'",
            "            if action == 'metadata':",
            "                permissions['metadata'] = acl_module_check(",
            "                    resource_type='service',",
            "                    action='metadata',",
            "                    resource_id=id,",
            "                )",
            "            elif action == 'get':",
            "                permissions['get'] = acl_module_check(",
            "                    resource_type='service',",
            "                    action='get',",
            "                    resource_id=id,",
            "                )",
            "            if not permissions[action]:",
            "                msg = \"{} does not have access to get service {}\".format(",
            "                    authnz.get_logged_in_user(),",
            "                    id",
            "                )",
            "                error_msg = {'error': msg, 'reference': id}",
            "                logger.warning(msg)",
            "                return jsonify(error_msg), 403",
            "",
            "            logger.info(",
            "                f'get_service called on id={id} by '",
            "                f'user={logged_in_user} metadata_only={metadata_only}'",
            "            )",
            "",
            "        with stats.timer('get_service_by_id.db_get_service'):",
            "            try:",
            "                service = Service.get(id)",
            "                if not authnz.service_in_account(service.account):",
            "                    logger.warning(",
            "                        f'Authz failed for service {id} (wrong account).'",
            "                    )",
            "                    msg = 'Authenticated user is not authorized.'",
            "                    return jsonify({'error': msg}), 401",
            "            except DoesNotExist:",
            "                logger.warning(f'Item with id={id} does not exist.')",
            "                return jsonify({}), 404",
            "            except Exception as e:",
            "                logger.warning('Exception occurred: {0}'.format(e))",
            "                raise e",
            "",
            "        if (service.data_type != 'service' and",
            "                service.data_type != 'archive-service'):",
            "            logger.warning('Item with id {0} is not a service.'.format(id))",
            "            return jsonify({}), 404",
            "        logger.debug('Authz succeeded for service {0}.'.format(id))",
            "",
            "        with stats.timer('get_service_by_id.db_get_credentials'):",
            "            try:",
            "                credentials = \\",
            "                    credentialmanager.get_credentials(service.credentials)",
            "            except KeyError:",
            "                logger.exception('KeyError occurred in getting credentials')",
            "                return jsonify({'error': 'Decryption error.'}), 500",
            "",
            "        with stats.timer('get_service_by_id.db_get_blind_credentials'):",
            "            blind_credentials = credentialmanager.get_blind_credentials(",
            "                service.blind_credentials,",
            "            )",
            "",
            "        with stats.timer('get_service_by_id.acl_check_update_service'):",
            "            # TODO: this check can be expensive, so we're gating",
            "            # only to user auth. We should probably add an argument that",
            "            # opts in for permission hints, rather than always checking them",
            "            if authnz.user_is_user_type('user'):",
            "                combined_cred_ids = (",
            "                    list(service.credentials) + list(service.blind_credentials)",
            "                )",
            "                permissions['update'] = acl_module_check(",
            "                    resource_type='service',",
            "                    action='update',",
            "                    resource_id=id,",
            "                    kwargs={",
            "                        'credential_ids': combined_cred_ids,",
            "                    },",
            "                )",
            "",
            "        with stats.timer('get_service_by_id.build_response'):",
            "            service_response = ServiceResponse.from_service_expanded(",
            "                service,",
            "                credentials=credentials,",
            "                blind_credentials=blind_credentials,",
            "                metadata_only=metadata_only,",
            "            )",
            "            service_response.permissions = permissions",
            "            return service_expanded_response_schema.dumps(service_response)",
            "",
            "",
            "@blueprint.route('/v1/archive/services/<id>', methods=['GET'])",
            "@authnz.require_auth",
            "def get_archive_service_revisions(id):",
            "    \"\"\"",
            "    Get a list of revisions for the specified service ID.",
            "",
            "    .. :quickref: Service History; Get a list of revisions for the specified",
            "                  service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/services/example-development",
            "",
            "    :param id: The service ID to get.",
            "    :type id: str",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"revisions\": [",
            "           {",
            "             \"id\": \"example-development-1\",",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"account\": null,",
            "             \"credentials\": [],",
            "             \"blind_credentials\": [],",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"next_page\": null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get metadata for the",
            "                     provided service ID.",
            "    :statuscode 404: Specified ID does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to service {} revisions\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "    try:",
            "        service = Service.get(id)",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if (service.data_type != 'service' and",
            "            service.data_type != 'archive-service'):",
            "        return jsonify({}), 404",
            "    _range = range(1, service.revision + 1)",
            "    ids = []",
            "    for i in _range:",
            "        ids.append(\"{0}-{1}\".format(id, i))",
            "    revisions_response = RevisionsResponse.from_services(",
            "        Service.batch_get(ids)",
            "    )",
            "    return revisions_response_schema.dumps(revisions_response)",
            "",
            "",
            "@blueprint.route('/v1/archive/services', methods=['GET'])",
            "@authnz.require_auth",
            "def get_archive_service_list():",
            "    \"\"\"",
            "    Get a list of service history revisions.",
            "",
            "    .. :quickref: Service History; Get a list of service history revisions.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/services",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"services\": [",
            "           {",
            "             \"id\": \"example-development-1\",",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"account\": null,",
            "             \"credentials\": [],",
            "             \"blind_credentials\": [],",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"next_page\": null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list services.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='list'):",
            "        msg = \"{} does not have access to list services\".format(",
            "            authnz.get_logged_in_user()",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "    limit = request.args.get(",
            "        'limit',",
            "        default=settings.HISTORY_PAGE_LIMIT,",
            "        type=int,",
            "    )",
            "    page = request.args.get('page', default=None, type=str)",
            "    if page:",
            "        try:",
            "            page = decode_last_evaluated_key(page)",
            "        except Exception:",
            "            logger.exception('Failed to parse provided page')",
            "            return jsonify({'error': 'Failed to parse page'}), 400",
            "    results = Service.data_type_date_index.query(",
            "        'archive-service',",
            "        scan_index_forward=False,",
            "        limit=limit,",
            "        last_evaluated_key=page,",
            "    )",
            "    services_response = ServicesResponse.from_services(",
            "        [service for service in results],",
            "        next_page=results.last_evaluated_key,",
            "    )",
            "    return services_response_schema.dumps(services_response)",
            "",
            "",
            "@blueprint.route('/v1/services/<id>', methods=['PUT'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def map_service_credentials(id):",
            "    \"\"\"",
            "    Create or update a service to credential mapping.",
            "",
            "    .. :quickref: Service; Create or update a service to credential mapping",
            "                  with the data provided in the PUT body.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/services/example-development",
            "",
            "    :param id: The service ID to create or update.",
            "    :type id: str",
            "    :<json List[string] credentials: A list of credential IDs to map to this",
            "      service.",
            "    :<json List[string] blind_credentials: A list of blind_credential IDs to",
            "      map to this service.",
            "    :<json boolean enabled: Whether or not this service is enabled.",
            "      (default: true)",
            "    :<json string account: An AWS account to scope this service to.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"account\": null,",
            "         \"credentials\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [\"test_key\"],",
            "             \"credential_pairs\": {",
            "               \"test_key\": \"test_value\"",
            "             },",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"blind_credentials\": [],",
            "         \"permissions\": {}",
            "           \"metadata\": True,",
            "           \"get\": True,",
            "           \"update\": True",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; Either required fields were not provided",
            "                     or credentials being mapped would result in credential key",
            "                     conflicts.",
            "    :statuscode 403: Client does not have permissions to create or update the",
            "                     specified service ID.",
            "    \"\"\"",
            "    try:",
            "        _service = Service.get(id)",
            "        if _service.data_type != 'service':",
            "            msg = 'id provided is not a service.'",
            "            return jsonify({'error': msg}), 400",
            "        revision = servicemanager.get_latest_service_revision(",
            "            id,",
            "            _service.revision",
            "        )",
            "    except DoesNotExist:",
            "        revision = 1",
            "        _service = None",
            "",
            "    if revision == 1 and not acl_module_check(",
            "          resource_type='service',",
            "          action='create',",
            "          resource_id=id,",
            "    ):",
            "        msg = \"{} does not have access to create service {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    data = request.get_json()",
            "    credentials = data.get('credentials', [])",
            "    blind_credentials = data.get('blind_credentials', [])",
            "    combined_credentials = credentials + blind_credentials",
            "    if _service:",
            "        new_credentials = set(combined_credentials).difference(",
            "            _service.credentials.union(_service.blind_credentials)",
            "        )",
            "    else:",
            "        # new service created, all credentials are new",
            "        new_credentials = set(combined_credentials)",
            "",
            "    if not acl_module_check(",
            "          resource_type='service',",
            "          action='update',",
            "          resource_id=id,",
            "          kwargs={",
            "              'credential_ids': combined_credentials,",
            "              'new_credential_ids': new_credentials,",
            "          }",
            "    ):",
            "        msg = (\"{} does not have access to map the credentials \"",
            "               \"because they do not own the credentials being added\")",
            "        msg = msg.format(authnz.get_logged_in_user())",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    conflicts = credentialmanager.pair_key_conflicts_for_credentials(",
            "        credentials,",
            "        blind_credentials,",
            "    )",
            "    if conflicts:",
            "        ret = {",
            "            'error': 'Conflicting key pairs in mapped service.',",
            "            'conflicts': conflicts",
            "        }",
            "        return jsonify(ret), 400",
            "",
            "    accounts = list(settings.SCOPED_AUTH_KEYS.values())",
            "    if data.get('account') and data['account'] not in accounts:",
            "        ret = {'error': '{0} is not a valid account.'}",
            "        return jsonify(ret), 400",
            "",
            "    # If this is the first revision, we should attempt to create a grant for",
            "    # this service.",
            "    if revision == 1:",
            "        try:",
            "            keymanager.ensure_grants(id)",
            "        except keymanager.ServiceCreateGrantError:",
            "            msg = 'Failed to add grants for {0}.'.format(id)",
            "            logger.error(msg)",
            "    credentials = credentialmanager.get_credentials(data.get('credentials'))",
            "    blind_credentials = credentialmanager.get_blind_credentials(",
            "        data.get('blind_credentials'),",
            "    )",
            "    # Use the IDs from the fetched IDs, to ensure we filter any archived",
            "    # credential IDs.",
            "    filtered_credential_ids = [cred.id for cred in credentials]",
            "    # Try to save to the archive",
            "",
            "    try:",
            "        Service(",
            "            id='{0}-{1}'.format(id, revision),",
            "            data_type='archive-service',",
            "            credentials=filtered_credential_ids,",
            "            blind_credentials=data.get('blind_credentials'),",
            "            account=data.get('account'),",
            "            enabled=data.get('enabled'),",
            "            revision=revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        ).save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to add service to archive.'}), 500",
            "",
            "    try:",
            "        service = Service(",
            "            id=id,",
            "            data_type='service',",
            "            credentials=filtered_credential_ids,",
            "            blind_credentials=data.get('blind_credentials'),",
            "            account=data.get('account'),",
            "            enabled=data.get('enabled'),",
            "            revision=revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        )",
            "        service.save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to update active service.'}), 500",
            "    servicemanager.send_service_mapping_graphite_event(service, _service)",
            "    webhook.send_event('service_update', [service.id], service.credentials)",
            "    permissions = {",
            "        'create': True,",
            "        'metadata': True,",
            "        'get': True,",
            "        'update': True,",
            "    }",
            "    service_response = ServiceResponse.from_service_expanded(",
            "        service,",
            "        credentials=credentials,",
            "        blind_credentials=blind_credentials,",
            "    )",
            "    service_response.permissions = permissions",
            "    return service_expanded_response_schema.dumps(service_response)",
            "",
            "",
            "@blueprint.route('/v1/services/<id>/<to_revision>', methods=['PUT'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def revert_service_to_revision(id, to_revision):",
            "    '''",
            "    Revert the provided service to the provided revision.",
            "",
            "    .. :quickref: Service; Revert the provided service to the provided",
            "                  revision",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/services/example-development/1",
            "",
            "    :param id: The service ID to revert.",
            "    :type id: str",
            "    :param to_revision: The revision to revert this service to.",
            "    :type to_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "         \"name\": \"Example Credential\",",
            "         \"credential_keys\": [\"test_key\"],",
            "         \"credential_pairs\": {",
            "           \"test_key\": \"test_value\"",
            "         },",
            "         \"metadata\": {",
            "           \"example_metadata_key\": \"example_value\"",
            "         },",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"documentation\": \"Example documentation\",",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"permissions\": {}",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; the update would create conflicting",
            "                     credential keys in the service mapping.",
            "    :statuscode 403: Client does not have access to revert the provided",
            "                     service ID.",
            "    '''",
            "    if not acl_module_check(resource_type='service',",
            "                            action='revert',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to revert service {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        current_service = Service.get(id)",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if current_service.data_type != 'service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    new_revision = servicemanager.get_latest_service_revision(",
            "        id,",
            "        current_service.revision",
            "    )",
            "    try:",
            "        revert_service = Service.get('{}-{}'.format(id, to_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if revert_service.data_type != 'archive-service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    if revert_service.credentials or revert_service.blind_credentials:",
            "        conflicts = credentialmanager.pair_key_conflicts_for_credentials(",
            "            revert_service.credentials,",
            "            revert_service.blind_credentials,",
            "        )",
            "        if conflicts:",
            "            ret = {",
            "                'error': 'Conflicting key pairs in mapped service.',",
            "                'conflicts': conflicts",
            "            }",
            "            return jsonify(ret), 400",
            "    credentials = credentialmanager.get_credentials(",
            "        revert_service.credentials,",
            "    )",
            "    blind_credentials = credentialmanager.get_blind_credentials(",
            "        revert_service.blind_credentials,",
            "    )",
            "    # Use the IDs from the fetched IDs, to ensure we filter any archived",
            "    # credential IDs.",
            "    revert_service.credentials = [cred.id for cred in credentials]",
            "    if revert_service.equals(current_service):",
            "        ret = {",
            "            'error': 'No difference between old and new service.'",
            "        }",
            "        return jsonify(ret), 400",
            "    # Try to save to the archive",
            "    try:",
            "        Service(",
            "            id='{0}-{1}'.format(id, new_revision),",
            "            data_type='archive-service',",
            "            credentials=revert_service.credentials,",
            "            blind_credentials=revert_service.blind_credentials,",
            "            account=revert_service.account,",
            "            enabled=revert_service.enabled,",
            "            revision=new_revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        ).save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to add service to archive.'}), 500",
            "",
            "    try:",
            "        service = Service(",
            "            id=id,",
            "            data_type='service',",
            "            credentials=revert_service.credentials,",
            "            blind_credentials=revert_service.blind_credentials,",
            "            account=revert_service.account,",
            "            enabled=revert_service.enabled,",
            "            revision=new_revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        )",
            "        service.save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to update active service.'}), 500",
            "    servicemanager.send_service_mapping_graphite_event(service, current_service)",
            "    webhook.send_event(",
            "        'service_update',",
            "        [service.id],",
            "        service.credentials,",
            "    )",
            "    return service_expanded_response_schema.dumps(",
            "        ServiceResponse.from_service_expanded(",
            "            service,",
            "            credentials=credentials,",
            "            blind_credentials=blind_credentials,",
            "        )",
            "    )",
            "",
            "",
            "@blueprint.route(",
            "    '/v1/services/<id>/<old_revision>/<new_revision>',",
            "    methods=['GET']",
            ")",
            "@authnz.require_auth",
            "def diff_service(id, old_revision, new_revision):",
            "    \"\"\"",
            "    Returns a diff between old_revision and new_revision for the provided",
            "    service id.",
            "",
            "    .. :quickref: Service Diff; Get a diff of two revisions of a service.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/services/example-development/1/2",
            "",
            "    :param id: The service ID to get.",
            "    :type id: str",
            "    :param old_revision: One of the two revisions to diff against.",
            "    :type old_revision: int",
            "    :param new_revision: One of the two revisions to diff against.",
            "    :type new_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"enabled\": {",
            "           \"added\": true,",
            "           \"removed\": false",
            "         },",
            "         \"credentials\": {",
            "           \"added\": [",
            "             \"abcd12345bf4f1cafe8e722d3860404\"",
            "           ],",
            "           \"removed\": [",
            "             \"aaaa33335bf4f1cafe8e722d3860404\"",
            "           ]",
            "         },",
            "         \"blind_credentials\": {},",
            "         \"modified_date\": {",
            "           \"added\": \"2019-12-16T23:16:11.413299+00:00\",",
            "           \"removed\": \"2019-11-16T23:16:11.413299+00:00\"",
            "         },",
            "         \"modified_by\": {",
            "           \"added\": \"rlane@example.com\",",
            "           \"removed\": \"testuser@example.com\"",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to diff the provided",
            "                     service ID.",
            "    :statuscode 404: The provided service ID or one of the provided",
            "                     revisions does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to diff service {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        old_service = Service.get('{}-{}'.format(id, old_revision))",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Service not found.'}), 404",
            "    if old_service.data_type != 'archive-service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        new_service = Service.get('{}-{}'.format(id, new_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if new_service.data_type != 'archive-service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    return jsonify(old_service.diff(new_service))",
            "",
            "",
            "@blueprint.route('/v1/grants/<id>', methods=['PUT'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def ensure_grants(id):",
            "    \"\"\"",
            "    Ensure grants are set for the provided service ID.",
            "",
            "    .. :quickref: KMS Grants; Ensure grants are set for the provided service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/grants/example-development",
            "",
            "    :param id: The service ID to ensure grants for.",
            "    :type id: str",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"grants\": {",
            "           \"encrypt_grant\": true,",
            "           \"decrypt_grant\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input. The service provided does not exist.",
            "    :statuscode 403: Client does not have permissions to create or update the",
            "                     specified service ID.",
            "    \"\"\"",
            "    # we pass [] in for the credential IDs, because this action isn't related",
            "    # to adding or removing credentials, but just a generic update of a",
            "    # service.",
            "    if not acl_module_check(",
            "          resource_type='service',",
            "          action='update',",
            "          resource_id=id,",
            "          kwargs={",
            "              'credential_ids': [],",
            "          }",
            "    ):",
            "        msg = \"{} does not have access to ensure grants for service {}\"",
            "        msg = msg.format(authnz.get_logged_in_user(), id)",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "    try:",
            "        _service = Service.get(id)",
            "        if _service.data_type != 'service':",
            "            msg = 'id provided is not a service.'",
            "            return jsonify({'error': msg}), 400",
            "    except DoesNotExist:",
            "        msg = 'id provided does not exist.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        keymanager.ensure_grants(id)",
            "    except keymanager.ServiceCreateGrantError:",
            "        msg = 'Failed to add grants for service.'",
            "        logger.error(msg)",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        grants = keymanager.grants_exist(id)",
            "    except keymanager.ServiceGetGrantError:",
            "        msg = 'Failed to get grants.'",
            "        return jsonify({'error': msg}), 500",
            "    return jsonify({",
            "        'id': id,",
            "        'grants': grants",
            "    })",
            "",
            "",
            "@blueprint.route('/v1/grants/<id>', methods=['GET'])",
            "@authnz.require_auth",
            "def get_grants(id):",
            "    \"\"\"",
            "    Get grants for the provided service ID.",
            "",
            "    .. :quickref: KMS Grants; Get grants for the provided service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/grants/example-development",
            "",
            "    :param id: The service ID to ensure grants for.",
            "    :type id: str",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"grants\": {",
            "           \"encrypt_grant\": true,",
            "           \"decrypt_grant\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input. The service provided does not exist.",
            "    :statuscode 403: Client does not have permissions to get service metadata",
            "                     for the specified service ID.",
            "    \"\"\"",
            "    if not acl_module_check(",
            "          resource_type='service',",
            "          action='metadata',",
            "          resource_id=id,",
            "    ):",
            "        msg = \"{} does not have access to get grants for service {}\"",
            "        msg = msg.format(authnz.get_logged_in_user(), id)",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "    try:",
            "        _service = Service.get(id)",
            "        if _service.data_type != 'service':",
            "            msg = 'id provided is not a service.'",
            "            return jsonify({'error': msg}), 400",
            "    except DoesNotExist:",
            "        msg = 'id provided does not exist.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        grants = keymanager.grants_exist(id)",
            "    except keymanager.ServiceGetGrantError:",
            "        msg = 'Failed to get grants.'",
            "        return jsonify({'error': msg}), 500",
            "    return jsonify({",
            "        'id': id,",
            "        'grants': grants",
            "    })"
        ],
        "afterPatchFile": [
            "import logging",
            "",
            "from flask import blueprints, jsonify, request",
            "from pynamodb.exceptions import DoesNotExist, PutError",
            "",
            "from confidant import authnz, settings",
            "from confidant.models.service import Service",
            "from confidant.schema.services import (",
            "    ServiceResponse,",
            "    ServicesResponse,",
            "    service_expanded_response_schema,",
            "    services_response_schema,",
            "    RevisionsResponse,",
            "    revisions_response_schema,",
            ")",
            "from confidant.services import (",
            "    credentialmanager,",
            "    iamrolemanager,",
            "    keymanager,",
            "    servicemanager,",
            "    webhook,",
            ")",
            "from confidant.utils import maintenance, misc, stats",
            "from confidant.utils.dynamodb import decode_last_evaluated_key",
            "",
            "logger = logging.getLogger(__name__)",
            "blueprint = blueprints.Blueprint('services', __name__)",
            "",
            "acl_module_check = misc.load_module(settings.ACL_MODULE)",
            "",
            "",
            "@blueprint.route('/v1/roles', methods=['GET'])",
            "@authnz.require_auth",
            "def get_iam_roles_list():",
            "    \"\"\"",
            "    Get a list of IAM roles from the configured AWS account.",
            "",
            "    .. :quickref: IAM Roles; Get a list of IAM roles from the configured",
            "                  AWS account.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/roles",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"roles\": [",
            "           'example-development',",
            "           'example2-development',",
            "           ...",
            "         ]",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list services.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='list'):",
            "        msg = \"{} does not have access to list services\".format(",
            "            authnz.get_logged_in_user()",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "",
            "    roles = iamrolemanager.get_iam_roles()",
            "    return jsonify({'roles': roles})",
            "",
            "",
            "@blueprint.route('/v1/services', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_service_list():",
            "    \"\"\"",
            "    Get a list of current service revisions.",
            "",
            "    .. :quickref: Services; Get a list of current service revisions.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/services",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "    :query int limit: Limit of items per each page (required for pagination)",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"services\": [",
            "           {",
            "             \"id\": \"example-development\",",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"account\": null,",
            "             \"credentials\": [],",
            "             \"blind_credentials\": [],",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"next_page\": null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list services.",
            "    \"\"\"",
            "    with stats.timer('list_services'):",
            "        if not acl_module_check(resource_type='service',",
            "                                action='list'):",
            "            msg = \"{} does not have access to list services\".format(",
            "                authnz.get_logged_in_user()",
            "            )",
            "            error_msg = {'error': msg}",
            "            return jsonify(error_msg), 403",
            "",
            "        limit = request.args.get(",
            "            'limit',",
            "            default=None,",
            "            type=int,",
            "        )",
            "        page = request.args.get(",
            "            'page',",
            "            default=None,",
            "            type=str",
            "        )",
            "",
            "        if page:",
            "            try:",
            "                page = decode_last_evaluated_key(page)",
            "            except Exception:",
            "                logger.exception('Failed to parse provided page')",
            "                return jsonify({'error': 'Failed to parse page'}), 400",
            "",
            "        if limit:",
            "            results = Service.data_type_date_index.query(",
            "                'service',",
            "                scan_index_forward=False,",
            "                limit=limit,",
            "                last_evaluated_key=page,",
            "            )",
            "            services_response = ServicesResponse.from_services(",
            "                [result for result in results],",
            "                next_page=results.last_evaluated_key",
            "            )",
            "        else:",
            "            services_response = ServicesResponse.from_services(",
            "                Service.data_type_date_index.query('service'),",
            "            )",
            "",
            "        return services_response_schema.dumps(services_response)",
            "",
            "",
            "@blueprint.route('/v1/services/<id>', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_service(id):",
            "    '''",
            "    Get a service object from the provided service ID.",
            "",
            "    .. :quickref: Service; Get a service object from the provided service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/services/example-development",
            "",
            "    :param id: The service ID to get.",
            "    :type id: str",
            "    :query boolean metadata_only: If true, only fetch metadata for this",
            "      service, and do not respond with decrypted credential pairs in the",
            "      credential responses.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"account\": null,",
            "         \"credentials\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [\"test_key\"],",
            "             \"credential_pairs\": {",
            "               \"test_key\": \"test_value\"",
            "             },",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"blind_credentials\": [],",
            "         \"permissions\": {",
            "           \"metadata\": true,",
            "           \"get\": true,",
            "           \"update\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get the service ID",
            "                     provided.",
            "    '''",
            "    with stats.timer('get_service_by_id'):",
            "        with stats.timer('get_service_by_id.acl_check_get_service'):",
            "            permissions = {",
            "                'metadata': False,",
            "                'get': False,",
            "                'update': False,",
            "            }",
            "            metadata_only = misc.get_boolean(request.args.get('metadata_only'))",
            "            logged_in_user = authnz.get_logged_in_user()",
            "            action = 'metadata' if metadata_only else 'get'",
            "            if action == 'metadata':",
            "                permissions['metadata'] = acl_module_check(",
            "                    resource_type='service',",
            "                    action='metadata',",
            "                    resource_id=id,",
            "                )",
            "            elif action == 'get':",
            "                permissions['get'] = acl_module_check(",
            "                    resource_type='service',",
            "                    action='get',",
            "                    resource_id=id,",
            "                )",
            "            if not permissions[action]:",
            "                msg = \"{} does not have access to get service {}\".format(",
            "                    authnz.get_logged_in_user(),",
            "                    id",
            "                )",
            "                error_msg = {'error': msg, 'reference': id}",
            "                logger.warning(msg)",
            "                return jsonify(error_msg), 403",
            "",
            "            logger.info(",
            "                f'get_service called on id={id} by '",
            "                f'user={logged_in_user} metadata_only={metadata_only}'",
            "            )",
            "",
            "        with stats.timer('get_service_by_id.db_get_service'):",
            "            try:",
            "                service = Service.get(id)",
            "                if not authnz.service_in_account(service.account):",
            "                    logger.warning(",
            "                        f'Authz failed for service {id} (wrong account).'",
            "                    )",
            "                    msg = 'Authenticated user is not authorized.'",
            "                    return jsonify({'error': msg}), 401",
            "            except DoesNotExist:",
            "                logger.warning(f'Item with id={id} does not exist.')",
            "                return jsonify({}), 404",
            "            except Exception as e:",
            "                logger.warning('Exception occurred: {0}'.format(e))",
            "                raise e",
            "",
            "        if (service.data_type != 'service' and",
            "                service.data_type != 'archive-service'):",
            "            logger.warning('Item with id {0} is not a service.'.format(id))",
            "            return jsonify({}), 404",
            "        logger.debug('Authz succeeded for service {0}.'.format(id))",
            "",
            "        with stats.timer('get_service_by_id.db_get_credentials'):",
            "            try:",
            "                credentials = \\",
            "                    credentialmanager.get_credentials(service.credentials)",
            "            except KeyError:",
            "                logger.exception('KeyError occurred in getting credentials')",
            "                return jsonify({'error': 'Decryption error.'}), 500",
            "",
            "        with stats.timer('get_service_by_id.db_get_blind_credentials'):",
            "            blind_credentials = credentialmanager.get_blind_credentials(",
            "                service.blind_credentials,",
            "            )",
            "",
            "        with stats.timer('get_service_by_id.acl_check_update_service'):",
            "            # TODO: this check can be expensive, so we're gating",
            "            # only to user auth. We should probably add an argument that",
            "            # opts in for permission hints, rather than always checking them",
            "            if authnz.user_is_user_type('user'):",
            "                combined_cred_ids = (",
            "                    list(service.credentials) + list(service.blind_credentials)",
            "                )",
            "                permissions['update'] = acl_module_check(",
            "                    resource_type='service',",
            "                    action='update',",
            "                    resource_id=id,",
            "                    kwargs={",
            "                        'credential_ids': combined_cred_ids,",
            "                    },",
            "                )",
            "",
            "        with stats.timer('get_service_by_id.build_response'):",
            "            service_response = ServiceResponse.from_service_expanded(",
            "                service,",
            "                credentials=credentials,",
            "                blind_credentials=blind_credentials,",
            "                metadata_only=metadata_only,",
            "            )",
            "            service_response.permissions = permissions",
            "            return service_expanded_response_schema.dumps(service_response)",
            "",
            "",
            "@blueprint.route('/v1/archive/services/<id>', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_archive_service_revisions(id):",
            "    \"\"\"",
            "    Get a list of revisions for the specified service ID.",
            "",
            "    .. :quickref: Service History; Get a list of revisions for the specified",
            "                  service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/services/example-development",
            "",
            "    :param id: The service ID to get.",
            "    :type id: str",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"revisions\": [",
            "           {",
            "             \"id\": \"example-development-1\",",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"account\": null,",
            "             \"credentials\": [],",
            "             \"blind_credentials\": [],",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"next_page\": null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to get metadata for the",
            "                     provided service ID.",
            "    :statuscode 404: Specified ID does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to service {} revisions\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "    try:",
            "        service = Service.get(id)",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if (service.data_type != 'service' and",
            "            service.data_type != 'archive-service'):",
            "        return jsonify({}), 404",
            "    _range = range(1, service.revision + 1)",
            "    ids = []",
            "    for i in _range:",
            "        ids.append(\"{0}-{1}\".format(id, i))",
            "    revisions_response = RevisionsResponse.from_services(",
            "        Service.batch_get(ids)",
            "    )",
            "    return revisions_response_schema.dumps(revisions_response)",
            "",
            "",
            "@blueprint.route('/v1/archive/services', methods=['GET'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "def get_archive_service_list():",
            "    \"\"\"",
            "    Get a list of service history revisions.",
            "",
            "    .. :quickref: Service History; Get a list of service history revisions.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/archive/services",
            "",
            "    :query string next_page: If paged results were returned in a call, this",
            "                             query string can be used to fetch the next page.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"services\": [",
            "           {",
            "             \"id\": \"example-development-1\",",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"account\": null,",
            "             \"credentials\": [],",
            "             \"blind_credentials\": [],",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"next_page\": null",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to list services.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='list'):",
            "        msg = \"{} does not have access to list services\".format(",
            "            authnz.get_logged_in_user()",
            "        )",
            "        error_msg = {'error': msg}",
            "        return jsonify(error_msg), 403",
            "    limit = request.args.get(",
            "        'limit',",
            "        default=settings.HISTORY_PAGE_LIMIT,",
            "        type=int,",
            "    )",
            "    page = request.args.get('page', default=None, type=str)",
            "    if page:",
            "        try:",
            "            page = decode_last_evaluated_key(page)",
            "        except Exception:",
            "            logger.exception('Failed to parse provided page')",
            "            return jsonify({'error': 'Failed to parse page'}), 400",
            "    results = Service.data_type_date_index.query(",
            "        'archive-service',",
            "        scan_index_forward=False,",
            "        limit=limit,",
            "        last_evaluated_key=page,",
            "    )",
            "    services_response = ServicesResponse.from_services(",
            "        [service for service in results],",
            "        next_page=results.last_evaluated_key,",
            "    )",
            "    return services_response_schema.dumps(services_response)",
            "",
            "",
            "@blueprint.route('/v1/services/<id>', methods=['PUT'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def map_service_credentials(id):",
            "    \"\"\"",
            "    Create or update a service to credential mapping.",
            "",
            "    .. :quickref: Service; Create or update a service to credential mapping",
            "                  with the data provided in the PUT body.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/services/example-development",
            "",
            "    :param id: The service ID to create or update.",
            "    :type id: str",
            "    :<json List[string] credentials: A list of credential IDs to map to this",
            "      service.",
            "    :<json List[string] blind_credentials: A list of blind_credential IDs to",
            "      map to this service.",
            "    :<json boolean enabled: Whether or not this service is enabled.",
            "      (default: true)",
            "    :<json string account: An AWS account to scope this service to.",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"account\": null,",
            "         \"credentials\": [",
            "           {",
            "             \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "             \"name\": \"Example Credential\",",
            "             \"credential_keys\": [\"test_key\"],",
            "             \"credential_pairs\": {",
            "               \"test_key\": \"test_value\"",
            "             },",
            "             \"metadata\": {",
            "               \"example_metadata_key\": \"example_value\"",
            "             },",
            "             \"revision\": 1,",
            "             \"enabled\": true,",
            "             \"documentation\": \"Example documentation\",",
            "             \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "             \"modified_by\": \"rlane@example.com\",",
            "             \"permissions\": {}",
            "           },",
            "           ...",
            "         ],",
            "         \"blind_credentials\": [],",
            "         \"permissions\": {}",
            "           \"metadata\": True,",
            "           \"get\": True,",
            "           \"update\": True",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; Either required fields were not provided",
            "                     or credentials being mapped would result in credential key",
            "                     conflicts.",
            "    :statuscode 403: Client does not have permissions to create or update the",
            "                     specified service ID.",
            "    \"\"\"",
            "    try:",
            "        _service = Service.get(id)",
            "        if _service.data_type != 'service':",
            "            msg = 'id provided is not a service.'",
            "            return jsonify({'error': msg}), 400",
            "        revision = servicemanager.get_latest_service_revision(",
            "            id,",
            "            _service.revision",
            "        )",
            "    except DoesNotExist:",
            "        revision = 1",
            "        _service = None",
            "",
            "    if revision == 1 and not acl_module_check(",
            "          resource_type='service',",
            "          action='create',",
            "          resource_id=id,",
            "    ):",
            "        msg = \"{} does not have access to create service {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    data = request.get_json()",
            "    credentials = data.get('credentials', [])",
            "    blind_credentials = data.get('blind_credentials', [])",
            "    combined_credentials = credentials + blind_credentials",
            "    if _service:",
            "        new_credentials = set(combined_credentials).difference(",
            "            _service.credentials.union(_service.blind_credentials)",
            "        )",
            "    else:",
            "        # new service created, all credentials are new",
            "        new_credentials = set(combined_credentials)",
            "",
            "    if not acl_module_check(",
            "          resource_type='service',",
            "          action='update',",
            "          resource_id=id,",
            "          kwargs={",
            "              'credential_ids': combined_credentials,",
            "              'new_credential_ids': new_credentials,",
            "          }",
            "    ):",
            "        msg = (\"{} does not have access to map the credentials \"",
            "               \"because they do not own the credentials being added\")",
            "        msg = msg.format(authnz.get_logged_in_user())",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    conflicts = credentialmanager.pair_key_conflicts_for_credentials(",
            "        credentials,",
            "        blind_credentials,",
            "    )",
            "    if conflicts:",
            "        ret = {",
            "            'error': 'Conflicting key pairs in mapped service.',",
            "            'conflicts': conflicts",
            "        }",
            "        return jsonify(ret), 400",
            "",
            "    accounts = list(settings.SCOPED_AUTH_KEYS.values())",
            "    if data.get('account') and data['account'] not in accounts:",
            "        ret = {'error': '{0} is not a valid account.'}",
            "        return jsonify(ret), 400",
            "",
            "    # If this is the first revision, we should attempt to create a grant for",
            "    # this service.",
            "    if revision == 1:",
            "        try:",
            "            keymanager.ensure_grants(id)",
            "        except keymanager.ServiceCreateGrantError:",
            "            msg = 'Failed to add grants for {0}.'.format(id)",
            "            logger.error(msg)",
            "    credentials = credentialmanager.get_credentials(data.get('credentials'))",
            "    blind_credentials = credentialmanager.get_blind_credentials(",
            "        data.get('blind_credentials'),",
            "    )",
            "    # Use the IDs from the fetched IDs, to ensure we filter any archived",
            "    # credential IDs.",
            "    filtered_credential_ids = [cred.id for cred in credentials]",
            "    # Try to save to the archive",
            "",
            "    try:",
            "        Service(",
            "            id='{0}-{1}'.format(id, revision),",
            "            data_type='archive-service',",
            "            credentials=filtered_credential_ids,",
            "            blind_credentials=data.get('blind_credentials'),",
            "            account=data.get('account'),",
            "            enabled=data.get('enabled'),",
            "            revision=revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        ).save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to add service to archive.'}), 500",
            "",
            "    try:",
            "        service = Service(",
            "            id=id,",
            "            data_type='service',",
            "            credentials=filtered_credential_ids,",
            "            blind_credentials=data.get('blind_credentials'),",
            "            account=data.get('account'),",
            "            enabled=data.get('enabled'),",
            "            revision=revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        )",
            "        service.save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to update active service.'}), 500",
            "    servicemanager.send_service_mapping_graphite_event(service, _service)",
            "    webhook.send_event('service_update', [service.id], service.credentials)",
            "    permissions = {",
            "        'create': True,",
            "        'metadata': True,",
            "        'get': True,",
            "        'update': True,",
            "    }",
            "    service_response = ServiceResponse.from_service_expanded(",
            "        service,",
            "        credentials=credentials,",
            "        blind_credentials=blind_credentials,",
            "    )",
            "    service_response.permissions = permissions",
            "    return service_expanded_response_schema.dumps(service_response)",
            "",
            "",
            "@blueprint.route('/v1/services/<id>/<to_revision>', methods=['PUT'])",
            "@misc.prevent_xss_decorator",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def revert_service_to_revision(id, to_revision):",
            "    '''",
            "    Revert the provided service to the provided revision.",
            "",
            "    .. :quickref: Service; Revert the provided service to the provided",
            "                  revision",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/services/example-development/1",
            "",
            "    :param id: The service ID to revert.",
            "    :type id: str",
            "    :param to_revision: The revision to revert this service to.",
            "    :type to_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"abcd12345bf4f1cafe8e722d3860404\",",
            "         \"name\": \"Example Credential\",",
            "         \"credential_keys\": [\"test_key\"],",
            "         \"credential_pairs\": {",
            "           \"test_key\": \"test_value\"",
            "         },",
            "         \"metadata\": {",
            "           \"example_metadata_key\": \"example_value\"",
            "         },",
            "         \"revision\": 1,",
            "         \"enabled\": true,",
            "         \"documentation\": \"Example documentation\",",
            "         \"modified_date\": \"2019-12-16T23:16:11.413299+00:00\",",
            "         \"modified_by\": \"rlane@example.com\",",
            "         \"permissions\": {}",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input; the update would create conflicting",
            "                     credential keys in the service mapping.",
            "    :statuscode 403: Client does not have access to revert the provided",
            "                     service ID.",
            "    '''",
            "    if not acl_module_check(resource_type='service',",
            "                            action='revert',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to revert service {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        current_service = Service.get(id)",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if current_service.data_type != 'service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    new_revision = servicemanager.get_latest_service_revision(",
            "        id,",
            "        current_service.revision",
            "    )",
            "    try:",
            "        revert_service = Service.get('{}-{}'.format(id, to_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if revert_service.data_type != 'archive-service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    if revert_service.credentials or revert_service.blind_credentials:",
            "        conflicts = credentialmanager.pair_key_conflicts_for_credentials(",
            "            revert_service.credentials,",
            "            revert_service.blind_credentials,",
            "        )",
            "        if conflicts:",
            "            ret = {",
            "                'error': 'Conflicting key pairs in mapped service.',",
            "                'conflicts': conflicts",
            "            }",
            "            return jsonify(ret), 400",
            "    credentials = credentialmanager.get_credentials(",
            "        revert_service.credentials,",
            "    )",
            "    blind_credentials = credentialmanager.get_blind_credentials(",
            "        revert_service.blind_credentials,",
            "    )",
            "    # Use the IDs from the fetched IDs, to ensure we filter any archived",
            "    # credential IDs.",
            "    revert_service.credentials = [cred.id for cred in credentials]",
            "    if revert_service.equals(current_service):",
            "        ret = {",
            "            'error': 'No difference between old and new service.'",
            "        }",
            "        return jsonify(ret), 400",
            "    # Try to save to the archive",
            "    try:",
            "        Service(",
            "            id='{0}-{1}'.format(id, new_revision),",
            "            data_type='archive-service',",
            "            credentials=revert_service.credentials,",
            "            blind_credentials=revert_service.blind_credentials,",
            "            account=revert_service.account,",
            "            enabled=revert_service.enabled,",
            "            revision=new_revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        ).save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to add service to archive.'}), 500",
            "",
            "    try:",
            "        service = Service(",
            "            id=id,",
            "            data_type='service',",
            "            credentials=revert_service.credentials,",
            "            blind_credentials=revert_service.blind_credentials,",
            "            account=revert_service.account,",
            "            enabled=revert_service.enabled,",
            "            revision=new_revision,",
            "            modified_by=authnz.get_logged_in_user()",
            "        )",
            "        service.save()",
            "    except PutError as e:",
            "        logger.error(e)",
            "        return jsonify({'error': 'Failed to update active service.'}), 500",
            "    servicemanager.send_service_mapping_graphite_event(service, current_service)",
            "    webhook.send_event(",
            "        'service_update',",
            "        [service.id],",
            "        service.credentials,",
            "    )",
            "    return service_expanded_response_schema.dumps(",
            "        ServiceResponse.from_service_expanded(",
            "            service,",
            "            credentials=credentials,",
            "            blind_credentials=blind_credentials,",
            "        )",
            "    )",
            "",
            "",
            "@blueprint.route(",
            "    '/v1/services/<id>/<old_revision>/<new_revision>',",
            "    methods=['GET']",
            ")",
            "@authnz.require_auth",
            "def diff_service(id, old_revision, new_revision):",
            "    \"\"\"",
            "    Returns a diff between old_revision and new_revision for the provided",
            "    service id.",
            "",
            "    .. :quickref: Service Diff; Get a diff of two revisions of a service.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/services/example-development/1/2",
            "",
            "    :param id: The service ID to get.",
            "    :type id: str",
            "    :param old_revision: One of the two revisions to diff against.",
            "    :type old_revision: int",
            "    :param new_revision: One of the two revisions to diff against.",
            "    :type new_revision: int",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"enabled\": {",
            "           \"added\": true,",
            "           \"removed\": false",
            "         },",
            "         \"credentials\": {",
            "           \"added\": [",
            "             \"abcd12345bf4f1cafe8e722d3860404\"",
            "           ],",
            "           \"removed\": [",
            "             \"aaaa33335bf4f1cafe8e722d3860404\"",
            "           ]",
            "         },",
            "         \"blind_credentials\": {},",
            "         \"modified_date\": {",
            "           \"added\": \"2019-12-16T23:16:11.413299+00:00\",",
            "           \"removed\": \"2019-11-16T23:16:11.413299+00:00\"",
            "         },",
            "         \"modified_by\": {",
            "           \"added\": \"rlane@example.com\",",
            "           \"removed\": \"testuser@example.com\"",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 403: Client does not have permissions to diff the provided",
            "                     service ID.",
            "    :statuscode 404: The provided service ID or one of the provided",
            "                     revisions does not exist.",
            "    \"\"\"",
            "    if not acl_module_check(resource_type='service',",
            "                            action='metadata',",
            "                            resource_id=id):",
            "        msg = \"{} does not have access to diff service {}\".format(",
            "            authnz.get_logged_in_user(),",
            "            id",
            "        )",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "",
            "    try:",
            "        old_service = Service.get('{}-{}'.format(id, old_revision))",
            "    except DoesNotExist:",
            "        return jsonify({'error': 'Service not found.'}), 404",
            "    if old_service.data_type != 'archive-service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        new_service = Service.get('{}-{}'.format(id, new_revision))",
            "    except DoesNotExist:",
            "        logger.warning(",
            "            'Item with id {0} does not exist.'.format(id)",
            "        )",
            "        return jsonify({}), 404",
            "    if new_service.data_type != 'archive-service':",
            "        msg = 'id provided is not a service.'",
            "        return jsonify({'error': msg}), 400",
            "    return jsonify(old_service.diff(new_service))",
            "",
            "",
            "@blueprint.route('/v1/grants/<id>', methods=['PUT'])",
            "@authnz.require_auth",
            "@authnz.require_csrf_token",
            "@maintenance.check_maintenance_mode",
            "def ensure_grants(id):",
            "    \"\"\"",
            "    Ensure grants are set for the provided service ID.",
            "",
            "    .. :quickref: KMS Grants; Ensure grants are set for the provided service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       PUT /v1/grants/example-development",
            "",
            "    :param id: The service ID to ensure grants for.",
            "    :type id: str",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"grants\": {",
            "           \"encrypt_grant\": true,",
            "           \"decrypt_grant\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input. The service provided does not exist.",
            "    :statuscode 403: Client does not have permissions to create or update the",
            "                     specified service ID.",
            "    \"\"\"",
            "    # we pass [] in for the credential IDs, because this action isn't related",
            "    # to adding or removing credentials, but just a generic update of a",
            "    # service.",
            "    if not acl_module_check(",
            "          resource_type='service',",
            "          action='update',",
            "          resource_id=id,",
            "          kwargs={",
            "              'credential_ids': [],",
            "          }",
            "    ):",
            "        msg = \"{} does not have access to ensure grants for service {}\"",
            "        msg = msg.format(authnz.get_logged_in_user(), id)",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "    try:",
            "        _service = Service.get(id)",
            "        if _service.data_type != 'service':",
            "            msg = 'id provided is not a service.'",
            "            return jsonify({'error': msg}), 400",
            "    except DoesNotExist:",
            "        msg = 'id provided does not exist.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        keymanager.ensure_grants(id)",
            "    except keymanager.ServiceCreateGrantError:",
            "        msg = 'Failed to add grants for service.'",
            "        logger.error(msg)",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        grants = keymanager.grants_exist(id)",
            "    except keymanager.ServiceGetGrantError:",
            "        msg = 'Failed to get grants.'",
            "        return jsonify({'error': msg}), 500",
            "    return jsonify({",
            "        'id': id,",
            "        'grants': grants",
            "    })",
            "",
            "",
            "@blueprint.route('/v1/grants/<id>', methods=['GET'])",
            "@authnz.require_auth",
            "def get_grants(id):",
            "    \"\"\"",
            "    Get grants for the provided service ID.",
            "",
            "    .. :quickref: KMS Grants; Get grants for the provided service ID.",
            "",
            "    **Example request**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       GET /v1/grants/example-development",
            "",
            "    :param id: The service ID to ensure grants for.",
            "    :type id: str",
            "",
            "    **Example response**:",
            "",
            "    .. sourcecode:: http",
            "",
            "       HTTP/1.1 200 OK",
            "       Content-Type: application/json",
            "",
            "       {",
            "         \"id\": \"example-development\",",
            "         \"grants\": {",
            "           \"encrypt_grant\": true,",
            "           \"decrypt_grant\": true",
            "         }",
            "       }",
            "",
            "    :resheader Content-Type: application/json",
            "    :statuscode 200: Success",
            "    :statuscode 400: Invalid input. The service provided does not exist.",
            "    :statuscode 403: Client does not have permissions to get service metadata",
            "                     for the specified service ID.",
            "    \"\"\"",
            "    if not acl_module_check(",
            "          resource_type='service',",
            "          action='metadata',",
            "          resource_id=id,",
            "    ):",
            "        msg = \"{} does not have access to get grants for service {}\"",
            "        msg = msg.format(authnz.get_logged_in_user(), id)",
            "        error_msg = {'error': msg, 'reference': id}",
            "        return jsonify(error_msg), 403",
            "    try:",
            "        _service = Service.get(id)",
            "        if _service.data_type != 'service':",
            "            msg = 'id provided is not a service.'",
            "            return jsonify({'error': msg}), 400",
            "    except DoesNotExist:",
            "        msg = 'id provided does not exist.'",
            "        return jsonify({'error': msg}), 400",
            "    try:",
            "        grants = keymanager.grants_exist(id)",
            "    except keymanager.ServiceGetGrantError:",
            "        msg = 'Failed to get grants.'",
            "        return jsonify({'error': msg}), 500",
            "    return jsonify({",
            "        'id': id,",
            "        'grants': grants",
            "    })"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "src.pyload.core.database.user_database"
        ]
    },
    "confidant/utils/misc.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1,
                "PatchRowcode": "+from functools import wraps"
            },
            "1": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " import importlib"
            },
            "2": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import pytz"
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " from datetime import datetime"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 5,
                "PatchRowcode": "+from flask import make_response"
            },
            "5": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 8,
                "PatchRowcode": " def dict_deep_update(a, b):"
            },
            "8": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "     \"\"\""
            },
            "9": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 57,
                "PatchRowcode": "     now = datetime.utcnow()"
            },
            "10": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 58,
                "PatchRowcode": "     return now.replace(tzinfo=pytz.utc)"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+def prevent_xss_decorator(func):"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+    \"\"\""
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+    Prevents XSS attacks:"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+     1. Set content type to be application/json"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+     2. Set Content Security Policy (already specified at app level)"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+     3. Enable XSS Protection"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+     4. Prevent MIME Type Sniffing"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+     5. Limit Referrer Information"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+    \"\"\""
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+    @wraps(func)"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+    def wrapper(*args, **kwargs):"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+        # Call the original function to get the response"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+        pre_xss_response = func(*args, **kwargs)"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+        # Apply XSS prevention"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 76,
                "PatchRowcode": "+        response = make_response(pre_xss_response)"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+        response.headers['Content-Type'] = 'application/json'"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 78,
                "PatchRowcode": "+        response.headers['X-XSS-Protection'] = '1; mode=block'"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+        response.headers['X-Content-Type-Options'] = 'nosniff'"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 80,
                "PatchRowcode": "+        response.headers['Referrer-Policy'] = 'no-referrer'"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+        return response"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+    return wrapper"
            }
        },
        "frontPatchFile": [
            "import importlib",
            "import pytz",
            "from datetime import datetime",
            "",
            "",
            "def dict_deep_update(a, b):",
            "    \"\"\"",
            "    Deep merge in place of two dicts. For all keys in `b`, override matching",
            "    keys in `a`. If both `a` and `b` have a dict at a given key, recursively",
            "    update `a`.",
            "",
            "    :param a: Left hand side dict to update in place",
            "    :type a: dict",
            "",
            "    :param b: Right hand side with values to pull in",
            "    :type b: dict",
            "    \"\"\"",
            "    for key, val in b.items():",
            "        if isinstance(a.get(key), dict) and isinstance(val, dict):",
            "            dict_deep_update(a[key], val)",
            "        else:",
            "            a[key] = val",
            "",
            "",
            "def load_module(module_path):",
            "    \"\"\" Load's a python module.",
            "",
            "    ex: module_path = \"confidant.authnz.rbac:no_acl\"",
            "",
            "    Will load the module confidant.authnz.rbac and return the function no_acl",
            "    \"\"\"",
            "    module_name, function_name = module_path.split(':')",
            "    module = importlib.import_module(module_name)",
            "    function = getattr(module, function_name)",
            "",
            "    return function",
            "",
            "",
            "def get_boolean(val, default=False):",
            "    \"\"\"",
            "    Given a value, check if if corresponds to True or False.",
            "    Python's bool() does not behave as expected for strings so we",
            "    have a helper function here",
            "    \"\"\"",
            "    if val is None:",
            "        return default",
            "    return val in ['True', 'true', '1']",
            "",
            "",
            "def utcnow():",
            "    \"\"\"",
            "    Returns the current time with tzinfo='UTC'.",
            "    datetime.utcnow() currently does not populate tzinfo",
            "    \"\"\"",
            "    now = datetime.utcnow()",
            "    return now.replace(tzinfo=pytz.utc)"
        ],
        "afterPatchFile": [
            "from functools import wraps",
            "import importlib",
            "import pytz",
            "from datetime import datetime",
            "from flask import make_response",
            "",
            "",
            "def dict_deep_update(a, b):",
            "    \"\"\"",
            "    Deep merge in place of two dicts. For all keys in `b`, override matching",
            "    keys in `a`. If both `a` and `b` have a dict at a given key, recursively",
            "    update `a`.",
            "",
            "    :param a: Left hand side dict to update in place",
            "    :type a: dict",
            "",
            "    :param b: Right hand side with values to pull in",
            "    :type b: dict",
            "    \"\"\"",
            "    for key, val in b.items():",
            "        if isinstance(a.get(key), dict) and isinstance(val, dict):",
            "            dict_deep_update(a[key], val)",
            "        else:",
            "            a[key] = val",
            "",
            "",
            "def load_module(module_path):",
            "    \"\"\" Load's a python module.",
            "",
            "    ex: module_path = \"confidant.authnz.rbac:no_acl\"",
            "",
            "    Will load the module confidant.authnz.rbac and return the function no_acl",
            "    \"\"\"",
            "    module_name, function_name = module_path.split(':')",
            "    module = importlib.import_module(module_name)",
            "    function = getattr(module, function_name)",
            "",
            "    return function",
            "",
            "",
            "def get_boolean(val, default=False):",
            "    \"\"\"",
            "    Given a value, check if if corresponds to True or False.",
            "    Python's bool() does not behave as expected for strings so we",
            "    have a helper function here",
            "    \"\"\"",
            "    if val is None:",
            "        return default",
            "    return val in ['True', 'true', '1']",
            "",
            "",
            "def utcnow():",
            "    \"\"\"",
            "    Returns the current time with tzinfo='UTC'.",
            "    datetime.utcnow() currently does not populate tzinfo",
            "    \"\"\"",
            "    now = datetime.utcnow()",
            "    return now.replace(tzinfo=pytz.utc)",
            "",
            "",
            "def prevent_xss_decorator(func):",
            "    \"\"\"",
            "    Prevents XSS attacks:",
            "     1. Set content type to be application/json",
            "     2. Set Content Security Policy (already specified at app level)",
            "     3. Enable XSS Protection",
            "     4. Prevent MIME Type Sniffing",
            "     5. Limit Referrer Information",
            "    \"\"\"",
            "    @wraps(func)",
            "    def wrapper(*args, **kwargs):",
            "        # Call the original function to get the response",
            "        pre_xss_response = func(*args, **kwargs)",
            "",
            "        # Apply XSS prevention",
            "        response = make_response(pre_xss_response)",
            "        response.headers['Content-Type'] = 'application/json'",
            "        response.headers['X-XSS-Protection'] = '1; mode=block'",
            "        response.headers['X-Content-Type-Options'] = 'nosniff'",
            "        response.headers['Referrer-Policy'] = 'no-referrer'",
            "",
            "        return response",
            "    return wrapper"
        ],
        "action": [
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "src.pyload.core.database.user_database"
        ]
    }
}