{
    "rdiffweb/controller/page_admin.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 41,
                "PatchRowcode": " # Define the logger"
            },
            "1": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 42,
                "PatchRowcode": " logger = logging.getLogger(__name__)"
            },
            "2": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 43,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+# Maximum file path"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+MAX_PATH = 260"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+"
            },
            "6": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 47,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 48,
                "PatchRowcode": " def get_pyinfo():"
            },
            "8": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "     try:"
            },
            "9": {
                "beforePatchRowNumber": 166,
                "afterPatchRowNumber": 169,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 167,
                "afterPatchRowNumber": 170,
                "PatchRowcode": " class UserForm(CherryForm):"
            },
            "11": {
                "beforePatchRowNumber": 168,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "     userid = StringField(_('UserID'))"
            },
            "12": {
                "beforePatchRowNumber": 169,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    username = StringField(_('Username'), validators=[validators.data_required()])"
            },
            "13": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    email = EmailField(_('Email'), validators=[validators.optional()])"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 172,
                "PatchRowcode": "+    username = StringField("
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 173,
                "PatchRowcode": "+        _('Username'),"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 174,
                "PatchRowcode": "+        validators=["
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 175,
                "PatchRowcode": "+            validators.data_required(),"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 176,
                "PatchRowcode": "+            validators.length(max=256, message=_('Username too long.')),"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 177,
                "PatchRowcode": "+        ],"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 178,
                "PatchRowcode": "+    )"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 179,
                "PatchRowcode": "+    email = EmailField("
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 180,
                "PatchRowcode": "+        _('Email'),"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 181,
                "PatchRowcode": "+        validators=["
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 182,
                "PatchRowcode": "+            validators.optional(),"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 183,
                "PatchRowcode": "+            validators.length(max=256, message=_('Email too long.')),"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 184,
                "PatchRowcode": "+        ],"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 185,
                "PatchRowcode": "+    )"
            },
            "28": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": 186,
                "PatchRowcode": "     password = PasswordField(_('Password'), validators=[validators.optional()])"
            },
            "29": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 187,
                "PatchRowcode": "     user_root = StringField("
            },
            "30": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        _('Root directory'), description=_(\"Absolute path defining the location of the repositories for this user.\")"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 188,
                "PatchRowcode": "+        _('Root directory'),"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 189,
                "PatchRowcode": "+        description=_(\"Absolute path defining the location of the repositories for this user.\"),"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 190,
                "PatchRowcode": "+        validators=["
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 191,
                "PatchRowcode": "+            validators.length(max=MAX_PATH, message=_('Root directory too long.')),"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 192,
                "PatchRowcode": "+        ],"
            },
            "36": {
                "beforePatchRowNumber": 174,
                "afterPatchRowNumber": 193,
                "PatchRowcode": "     )"
            },
            "37": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 194,
                "PatchRowcode": "     role = SelectField("
            },
            "38": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 195,
                "PatchRowcode": "         _('User Role'),"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import grp",
            "import logging",
            "import os",
            "import platform",
            "import pwd",
            "import subprocess",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import humanfriendly",
            "import psutil",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.core.config import Option",
            "from rdiffweb.core.librdiff import rdiff_backup_version",
            "from rdiffweb.core.store import ADMIN_ROLE, MAINTAINER_ROLE, USER_ROLE",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "def get_pyinfo():",
            "    try:",
            "        import distro",
            "",
            "        yield _('OS Version'), '%s %s (%s %s)' % (",
            "            platform.system(),",
            "            platform.release(),",
            "            distro.name().capitalize(),",
            "            distro.version(),",
            "        )",
            "    except Exception:",
            "        yield _('OS Version'), '%s %s' % (platform.system(), platform.release())",
            "    if hasattr(os, 'path'):",
            "        yield _('OS Path'), os.environ['PATH']",
            "    if hasattr(sys, 'version'):",
            "        yield _('Python Version'), ''.join(sys.version)",
            "    if hasattr(sys, 'subversion'):",
            "        yield _('Python Subversion'), ', '.join(sys.subversion)",
            "    if hasattr(sys, 'prefix'):",
            "        yield _('Python Prefix'), sys.prefix",
            "    if hasattr(sys, 'executable'):",
            "        yield _('Python Executable'), sys.executable",
            "    if hasattr(sys, 'path'):",
            "        yield _('Python Path'), ', '.join(sys.path)",
            "",
            "",
            "def get_osinfo():",
            "    def gr_name(gid):",
            "        try:",
            "            return grp.getgrgid(gid).gr_name",
            "        except Exception:",
            "            return",
            "",
            "    def pw_name(uid):",
            "        try:",
            "            return pwd.getpwuid(os.getuid()).pw_name",
            "        except Exception:",
            "            return",
            "",
            "    if hasattr(sys, 'getfilesystemencoding'):",
            "        yield _('File System Encoding'), sys.getfilesystemencoding()",
            "    if hasattr(os, 'getcwd'):",
            "        yield _('Current Working Directory'), os.getcwd()",
            "    if hasattr(os, 'getegid'):",
            "        yield _('Effective Group'), '%s (%s)' % (os.getegid(), gr_name(os.getegid()))",
            "    if hasattr(os, 'geteuid'):",
            "        yield _('Effective User'), '%s (%s)' % (os.geteuid(), pw_name(os.geteuid))",
            "    if hasattr(os, 'getgid'):",
            "        yield _('Group'), '%s (%s)' % (os.getgid(), gr_name(os.getgid()))",
            "    if hasattr(os, 'getuid'):",
            "        yield _('User'), '%s (%s)' % (os.getuid(), gr_name(os.getuid()))",
            "    if hasattr(os, 'getgroups'):",
            "        yield _('Group Membership'), ', '.join(['%s (%s)' % (gid, gr_name(gid)) for gid in os.getgroups()])",
            "    try:",
            "        if hasattr(os, 'getpid') and hasattr(os, 'getppid'):",
            "            yield _('Process ID'), ('%s (parent: %s)' % (os.getpid(), os.getppid()))",
            "    except Exception:",
            "        pass",
            "",
            "",
            "def get_hwinfo():",
            "    if hasattr(os, 'getloadavg'):",
            "        yield _('Load Average'), ', '.join(map(str, map(lambda x: round(x, 2), os.getloadavg())))",
            "    yield _('CPU Count'), psutil.cpu_count()",
            "    meminfo = psutil.virtual_memory()",
            "    yield _('Memory usage'), '%s / %s' % (",
            "        humanfriendly.format_size(meminfo.used),",
            "        humanfriendly.format_size(meminfo.total),",
            "    )",
            "",
            "",
            "def get_pkginfo():",
            "    yield _('Rdiff-Backup Version'), '.'.join([str(i) for i in rdiff_backup_version()])",
            "    import jinja2",
            "",
            "    yield _('Jinja2 Version'), getattr(jinja2, '__version__')",
            "    yield _('CherryPy Version'), getattr(cherrypy, '__version__')",
            "    import sqlalchemy",
            "",
            "    yield _('SQLAlchemy Version'), getattr(sqlalchemy, '__version__')",
            "    try:",
            "        import ldap",
            "",
            "        yield _('LDAP Version'), getattr(ldap, '__version__')",
            "        yield _('LDAP SASL Support (Cyrus-SASL)'), ldap.SASL_AVAIL  # @UndefinedVariable",
            "        yield _('LDAP TLS Support (OpenSSL)'), ldap.TLS_AVAIL  # @UndefinedVariable",
            "    except Exception:",
            "        pass",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = StringField(_('UserID'))",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "    email = EmailField(_('Email'), validators=[validators.optional()])",
            "    password = PasswordField(_('Password'), validators=[validators.optional()])",
            "    user_root = StringField(",
            "        _('Root directory'), description=_(\"Absolute path defining the location of the repositories for this user.\")",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[(ADMIN_ROLE, _(\"Admin\")), (MAINTAINER_ROLE, _(\"Maintainer\")), (USER_ROLE, _(\"User\"))],",
            "        default=USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'), validators=[validators.optional()], description=_(\"Disk spaces (in bytes) used by this user.\")",
            "    )",
            "",
            "    def validate_password(self, field):",
            "        validator = validators.length(",
            "            min=self.app.cfg.password_min_length,",
            "            max=self.app.cfg.password_max_length,",
            "            message=_('Password must have between %(min)d and %(max)d characters.'),",
            "        )",
            "        validator(self, field)",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data, old_password=None)",
            "        userobj.role = self.role.data",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    logfile = Option('log_file')",
            "    logaccessfile = Option('log_access_file')",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = self.app.store.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    def _get_log_files(self):",
            "        \"\"\"",
            "        Return a list of log files to be shown in admin area.",
            "        \"\"\"",
            "        return [fn for fn in [self.logfile, self.logaccessfile] if fn]",
            "",
            "    def _get_log_data(self, fn, num=2000):",
            "        \"\"\"",
            "        Return a list of log files to be shown in admin area.",
            "        \"\"\"",
            "        try:",
            "            return subprocess.check_output(['tail', '-n', str(num), fn], stderr=subprocess.STDOUT).decode('utf-8')",
            "        except Exception:",
            "            logging.exception('fail to get log file content')",
            "            return \"Error getting file content\"",
            "",
            "    @cherrypy.expose",
            "    def default(self):",
            "        params = {\"user_count\": self.app.store.count_users(), \"repo_count\": self.app.store.count_repos()}",
            "",
            "        return self._compile_template(\"admin.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def logs(self, filename=u\"\"):",
            "        # get list of log file available.",
            "        data = \"\"",
            "        logfiles = OrderedDict([(os.path.basename(fn), fn) for fn in self._get_log_files()])",
            "        if logfiles:",
            "            filename = filename or list(logfiles.keys())[0]",
            "            if filename not in logfiles:",
            "                raise cherrypy.HTTPError(404, 'invalid log file: ' + filename)",
            "            data = self._get_log_data(logfiles.get(filename))",
            "",
            "        params = {",
            "            \"filename\": filename,",
            "            \"logfiles\": logfiles.keys(),",
            "            \"data\": data,",
            "        }",
            "        return self._compile_template(\"admin_logs.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def users(self, username=None, criteria=u\"\", search=u\"\", action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = self.app.store.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = self.app.store.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"criteria\": criteria,",
            "            \"search\": search,",
            "            \"users\": list(self.app.store.users(search=search, criteria=criteria)),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def repos(self, criteria=u\"\", search=u\"\"):",
            "        params = {",
            "            \"criteria\": criteria,",
            "            \"search\": search,",
            "            \"repos\": list(self.app.store.repos(search=search, criteria=criteria)),",
            "        }",
            "        return self._compile_template(\"admin_repos.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def sysinfo(self):",
            "",
            "        params = {",
            "            \"version\": self.app.version,",
            "            # Config",
            "            \"cfg\": {k: '********' if 'password' in k else v for k, v in vars(self.app.cfg).items()},",
            "            # System Info entries",
            "            \"pyinfo\": list(get_pyinfo()),",
            "            \"osinfo\": list(get_osinfo()),",
            "            \"hwinfo\": list(get_hwinfo()),",
            "            \"ldapinfo\": list(get_pkginfo()),",
            "        }",
            "",
            "        return self._compile_template(\"admin_sysinfo.html\", **params)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import grp",
            "import logging",
            "import os",
            "import platform",
            "import pwd",
            "import subprocess",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import humanfriendly",
            "import psutil",
            "from wtforms import validators, widgets",
            "from wtforms.fields import Field, PasswordField, SelectField, StringField",
            "from wtforms.fields.html5 import EmailField",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.core.config import Option",
            "from rdiffweb.core.librdiff import rdiff_backup_version",
            "from rdiffweb.core.store import ADMIN_ROLE, MAINTAINER_ROLE, USER_ROLE",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Maximum file path",
            "MAX_PATH = 260",
            "",
            "",
            "def get_pyinfo():",
            "    try:",
            "        import distro",
            "",
            "        yield _('OS Version'), '%s %s (%s %s)' % (",
            "            platform.system(),",
            "            platform.release(),",
            "            distro.name().capitalize(),",
            "            distro.version(),",
            "        )",
            "    except Exception:",
            "        yield _('OS Version'), '%s %s' % (platform.system(), platform.release())",
            "    if hasattr(os, 'path'):",
            "        yield _('OS Path'), os.environ['PATH']",
            "    if hasattr(sys, 'version'):",
            "        yield _('Python Version'), ''.join(sys.version)",
            "    if hasattr(sys, 'subversion'):",
            "        yield _('Python Subversion'), ', '.join(sys.subversion)",
            "    if hasattr(sys, 'prefix'):",
            "        yield _('Python Prefix'), sys.prefix",
            "    if hasattr(sys, 'executable'):",
            "        yield _('Python Executable'), sys.executable",
            "    if hasattr(sys, 'path'):",
            "        yield _('Python Path'), ', '.join(sys.path)",
            "",
            "",
            "def get_osinfo():",
            "    def gr_name(gid):",
            "        try:",
            "            return grp.getgrgid(gid).gr_name",
            "        except Exception:",
            "            return",
            "",
            "    def pw_name(uid):",
            "        try:",
            "            return pwd.getpwuid(os.getuid()).pw_name",
            "        except Exception:",
            "            return",
            "",
            "    if hasattr(sys, 'getfilesystemencoding'):",
            "        yield _('File System Encoding'), sys.getfilesystemencoding()",
            "    if hasattr(os, 'getcwd'):",
            "        yield _('Current Working Directory'), os.getcwd()",
            "    if hasattr(os, 'getegid'):",
            "        yield _('Effective Group'), '%s (%s)' % (os.getegid(), gr_name(os.getegid()))",
            "    if hasattr(os, 'geteuid'):",
            "        yield _('Effective User'), '%s (%s)' % (os.geteuid(), pw_name(os.geteuid))",
            "    if hasattr(os, 'getgid'):",
            "        yield _('Group'), '%s (%s)' % (os.getgid(), gr_name(os.getgid()))",
            "    if hasattr(os, 'getuid'):",
            "        yield _('User'), '%s (%s)' % (os.getuid(), gr_name(os.getuid()))",
            "    if hasattr(os, 'getgroups'):",
            "        yield _('Group Membership'), ', '.join(['%s (%s)' % (gid, gr_name(gid)) for gid in os.getgroups()])",
            "    try:",
            "        if hasattr(os, 'getpid') and hasattr(os, 'getppid'):",
            "            yield _('Process ID'), ('%s (parent: %s)' % (os.getpid(), os.getppid()))",
            "    except Exception:",
            "        pass",
            "",
            "",
            "def get_hwinfo():",
            "    if hasattr(os, 'getloadavg'):",
            "        yield _('Load Average'), ', '.join(map(str, map(lambda x: round(x, 2), os.getloadavg())))",
            "    yield _('CPU Count'), psutil.cpu_count()",
            "    meminfo = psutil.virtual_memory()",
            "    yield _('Memory usage'), '%s / %s' % (",
            "        humanfriendly.format_size(meminfo.used),",
            "        humanfriendly.format_size(meminfo.total),",
            "    )",
            "",
            "",
            "def get_pkginfo():",
            "    yield _('Rdiff-Backup Version'), '.'.join([str(i) for i in rdiff_backup_version()])",
            "    import jinja2",
            "",
            "    yield _('Jinja2 Version'), getattr(jinja2, '__version__')",
            "    yield _('CherryPy Version'), getattr(cherrypy, '__version__')",
            "    import sqlalchemy",
            "",
            "    yield _('SQLAlchemy Version'), getattr(sqlalchemy, '__version__')",
            "    try:",
            "        import ldap",
            "",
            "        yield _('LDAP Version'), getattr(ldap, '__version__')",
            "        yield _('LDAP SASL Support (Cyrus-SASL)'), ldap.SASL_AVAIL  # @UndefinedVariable",
            "        yield _('LDAP TLS Support (OpenSSL)'), ldap.TLS_AVAIL  # @UndefinedVariable",
            "    except Exception:",
            "        pass",
            "",
            "",
            "class SizeField(Field):",
            "    \"\"\"",
            "    A text field which stores a file size as GiB or GB format.",
            "    \"\"\"",
            "",
            "    widget = widgets.TextInput()",
            "",
            "    def __init__(self, label=None, validators=None, **kwargs):",
            "        super(SizeField, self).__init__(label, validators, **kwargs)",
            "",
            "    def _value(self):",
            "        if self.raw_data:",
            "            return ' '.join(self.raw_data)",
            "        else:",
            "            return self.data and humanfriendly.format_size(self.data, binary=True) or ''",
            "",
            "    def process_formdata(self, valuelist):",
            "        if valuelist:",
            "            value_str = ''.join(valuelist)",
            "            # parse_size doesn't handle locales.this mean we need to",
            "            # replace ',' by '.' to get parse and prefix number with 0",
            "            value_str = value_str.replace(',', '.').strip()",
            "            # a value must start with a number.",
            "            if value_str.startswith('.'):",
            "                value_str = '0' + value_str",
            "            try:",
            "                self.data = humanfriendly.parse_size(value_str)",
            "            except humanfriendly.InvalidSize:",
            "                self.data = None",
            "                raise ValueError(self.gettext('Not a valid file size value'))",
            "",
            "",
            "class UserForm(CherryForm):",
            "    userid = StringField(_('UserID'))",
            "    username = StringField(",
            "        _('Username'),",
            "        validators=[",
            "            validators.data_required(),",
            "            validators.length(max=256, message=_('Username too long.')),",
            "        ],",
            "    )",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            validators.optional(),",
            "            validators.length(max=256, message=_('Email too long.')),",
            "        ],",
            "    )",
            "    password = PasswordField(_('Password'), validators=[validators.optional()])",
            "    user_root = StringField(",
            "        _('Root directory'),",
            "        description=_(\"Absolute path defining the location of the repositories for this user.\"),",
            "        validators=[",
            "            validators.length(max=MAX_PATH, message=_('Root directory too long.')),",
            "        ],",
            "    )",
            "    role = SelectField(",
            "        _('User Role'),",
            "        coerce=int,",
            "        choices=[(ADMIN_ROLE, _(\"Admin\")), (MAINTAINER_ROLE, _(\"Maintainer\")), (USER_ROLE, _(\"User\"))],",
            "        default=USER_ROLE,",
            "        description=_(",
            "            \"Admin: may browse and delete everything. Maintainer: may browse and delete their own repo. User: may only browser their own repo.\"",
            "        ),",
            "    )",
            "    disk_quota = SizeField(",
            "        _('Disk space'),",
            "        validators=[validators.optional()],",
            "        description=_(\"Users disk spaces (in bytes). Set to 0 to remove quota (unlimited).\"),",
            "    )",
            "    disk_usage = SizeField(",
            "        _('Quota Used'), validators=[validators.optional()], description=_(\"Disk spaces (in bytes) used by this user.\")",
            "    )",
            "",
            "    def validate_password(self, field):",
            "        validator = validators.length(",
            "            min=self.app.cfg.password_min_length,",
            "            max=self.app.cfg.password_max_length,",
            "            message=_('Password must have between %(min)d and %(max)d characters.'),",
            "        )",
            "        validator(self, field)",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def validate_role(self, field):",
            "        # Don't allow the user to changes it's \"role\" state.",
            "        currentuser = cherrypy.request.currentuser",
            "        if self.username.data == currentuser.username and self.role.data != currentuser.role:",
            "            raise ValueError(_('Cannot edit your own role.'))",
            "",
            "    def populate_obj(self, userobj):",
            "        # Save password if defined",
            "        if self.password.data:",
            "            userobj.set_password(self.password.data, old_password=None)",
            "        userobj.role = self.role.data",
            "        userobj.email = self.email.data or ''",
            "        userobj.user_root = self.user_root.data",
            "        if not userobj.valid_user_root():",
            "            flash(_(\"User's root directory %s is not accessible!\") % userobj.user_root, level='error')",
            "            logger.warning(\"user's root directory %s is not accessible\" % userobj.user_root)",
            "        # Try to update disk quota if the human readable value changed.",
            "        # Report error using flash.",
            "        new_quota = self.disk_quota.data or 0",
            "        old_quota = humanfriendly.parse_size(humanfriendly.format_size(self.disk_quota.object_data or 0, binary=True))",
            "        if old_quota != new_quota:",
            "            userobj.disk_quota = new_quota",
            "            # Setting quota will silently fail. Check if quota was updated.",
            "            if userobj.disk_quota != new_quota:",
            "                flash(_(\"Setting user's quota is not supported\"), level='warning')",
            "",
            "",
            "class EditUserForm(UserForm):",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # Make username field read-only",
            "        self.username.render_kw = {'readonly': True}",
            "        self.username.populate_obj = lambda *args, **kwargs: None",
            "",
            "",
            "class DeleteUserForm(CherryForm):",
            "    username = StringField(_('Username'), validators=[validators.data_required()])",
            "",
            "",
            "@cherrypy.tools.is_admin()",
            "class AdminPage(Controller):",
            "    \"\"\"Administration pages. Allow to manage users database.\"\"\"",
            "",
            "    logfile = Option('log_file')",
            "    logaccessfile = Option('log_access_file')",
            "",
            "    def _delete_user(self, action, form):",
            "        assert action == 'delete'",
            "        assert form",
            "        # Validate form.",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        if form.username.data == self.app.currentuser.username:",
            "            flash(_(\"You cannot remove your own account!\"), level='error')",
            "        else:",
            "            try:",
            "                user = self.app.store.get_user(form.username.data)",
            "                if user:",
            "                    user.delete()",
            "                    flash(_(\"User account removed.\"))",
            "                else:",
            "                    flash(_(\"User doesn't exists!\"), level='warning')",
            "            except ValueError as e:",
            "                flash(e, level='error')",
            "",
            "    def _get_log_files(self):",
            "        \"\"\"",
            "        Return a list of log files to be shown in admin area.",
            "        \"\"\"",
            "        return [fn for fn in [self.logfile, self.logaccessfile] if fn]",
            "",
            "    def _get_log_data(self, fn, num=2000):",
            "        \"\"\"",
            "        Return a list of log files to be shown in admin area.",
            "        \"\"\"",
            "        try:",
            "            return subprocess.check_output(['tail', '-n', str(num), fn], stderr=subprocess.STDOUT).decode('utf-8')",
            "        except Exception:",
            "            logging.exception('fail to get log file content')",
            "            return \"Error getting file content\"",
            "",
            "    @cherrypy.expose",
            "    def default(self):",
            "        params = {\"user_count\": self.app.store.count_users(), \"repo_count\": self.app.store.count_repos()}",
            "",
            "        return self._compile_template(\"admin.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def logs(self, filename=u\"\"):",
            "        # get list of log file available.",
            "        data = \"\"",
            "        logfiles = OrderedDict([(os.path.basename(fn), fn) for fn in self._get_log_files()])",
            "        if logfiles:",
            "            filename = filename or list(logfiles.keys())[0]",
            "            if filename not in logfiles:",
            "                raise cherrypy.HTTPError(404, 'invalid log file: ' + filename)",
            "            data = self._get_log_data(logfiles.get(filename))",
            "",
            "        params = {",
            "            \"filename\": filename,",
            "            \"logfiles\": logfiles.keys(),",
            "            \"data\": data,",
            "        }",
            "        return self._compile_template(\"admin_logs.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def users(self, username=None, criteria=u\"\", search=u\"\", action=u\"\", **kwargs):",
            "",
            "        # If we're just showing the initial page, just do that",
            "        if action == \"add\":",
            "            form = UserForm()",
            "            if form.validate_on_submit():",
            "                try:",
            "                    user = self.app.store.add_user(username)",
            "                    form.populate_obj(user)",
            "                    flash(_(\"User added successfully.\"))",
            "                except Exception as e:",
            "                    flash(str(e), level='error')",
            "            else:",
            "                flash(form.error_message, level='error')",
            "        elif action == \"edit\":",
            "            user = self.app.store.get_user(username)",
            "            if user:",
            "                form = EditUserForm(obj=user)",
            "                if form.validate_on_submit():",
            "                    try:",
            "                        form.populate_obj(user)",
            "                        flash(_(\"User information modified successfully.\"))",
            "                    except Exception as e:",
            "                        flash(str(e), level='error')",
            "                else:",
            "                    flash(form.error_message, level='error')",
            "            else:",
            "                flash(_(\"Cannot edit user `%s`: user doesn't exists\") % username, level='error')",
            "        elif action == 'delete':",
            "            form = DeleteUserForm()",
            "            if form.validate_on_submit():",
            "                self._delete_user(action, form)",
            "",
            "        params = {",
            "            \"add_form\": UserForm(formdata=None),",
            "            \"edit_form\": EditUserForm(formdata=None),",
            "            \"criteria\": criteria,",
            "            \"search\": search,",
            "            \"users\": list(self.app.store.users(search=search, criteria=criteria)),",
            "        }",
            "",
            "        # Build users page",
            "        return self._compile_template(\"admin_users.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def repos(self, criteria=u\"\", search=u\"\"):",
            "        params = {",
            "            \"criteria\": criteria,",
            "            \"search\": search,",
            "            \"repos\": list(self.app.store.repos(search=search, criteria=criteria)),",
            "        }",
            "        return self._compile_template(\"admin_repos.html\", **params)",
            "",
            "    @cherrypy.expose",
            "    def sysinfo(self):",
            "",
            "        params = {",
            "            \"version\": self.app.version,",
            "            # Config",
            "            \"cfg\": {k: '********' if 'password' in k else v for k, v in vars(self.app.cfg).items()},",
            "            # System Info entries",
            "            \"pyinfo\": list(get_pyinfo()),",
            "            \"osinfo\": list(get_osinfo()),",
            "            \"hwinfo\": list(get_hwinfo()),",
            "            \"ldapinfo\": list(get_pkginfo()),",
            "        }",
            "",
            "        return self._compile_template(\"admin_sysinfo.html\", **params)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "169": [
                "UserForm"
            ],
            "170": [
                "UserForm"
            ],
            "173": [
                "UserForm"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/page_login.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 19,
                "PatchRowcode": " import cherrypy"
            },
            "1": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " from wtforms.fields import PasswordField, StringField"
            },
            "2": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from wtforms.fields.simple import HiddenField"
            },
            "3": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from wtforms.validators import InputRequired"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+from wtforms.validators import InputRequired, Length"
            },
            "5": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " from rdiffweb.controller import Controller, flash"
            },
            "7": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " from rdiffweb.controller.cherrypy_wtf import CherryForm"
            },
            "8": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " class LoginForm(CherryForm):"
            },
            "9": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "     login = StringField("
            },
            "10": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "         _('Username'),"
            },
            "11": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        validators=[InputRequired()],"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+        validators=[InputRequired(), Length(max=256, message=_('Username too long.'))],"
            },
            "13": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": "         render_kw={"
            },
            "14": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "             \"placeholder\": _('Username'),"
            },
            "15": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "             \"autocorrect\": \"off\","
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import PasswordField, StringField",
            "from wtforms.fields.simple import HiddenField",
            "from wtforms.validators import InputRequired",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.core.config import Option",
            "from rdiffweb.tools.auth_form import SESSION_KEY",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginForm(CherryForm):",
            "    login = StringField(",
            "        _('Username'),",
            "        validators=[InputRequired()],",
            "        render_kw={",
            "            \"placeholder\": _('Username'),",
            "            \"autocorrect\": \"off\",",
            "            \"autocapitalize\": \"none\",",
            "            \"autocomplete\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    password = PasswordField(_('Password'), validators=[InputRequired()], render_kw={\"placeholder\": _('Password')})",
            "    # Sanitize the redirect URL to avoid Open Redirect",
            "    redirect = HiddenField(default='/', filters=[lambda v: v if v.startswith('/') else '/'])",
            "",
            "",
            "class LoginPage(Controller):",
            "    \"\"\"",
            "    This page is used by the authentication to enter a user/pass.",
            "    \"\"\"",
            "",
            "    _welcome_msg = Option(\"welcome_msg\")",
            "",
            "    @cherrypy.expose()",
            "    @cherrypy.config(**{'tools.auth_form.on': False, 'tools.ratelimit.on': True})",
            "    def index(self, **kwargs):",
            "        form = LoginForm()",
            "        # Validate user's credentials",
            "        if form.validate_on_submit():",
            "            try:",
            "                userobj = self.app.store.login(form.login.data, form.password.data)",
            "            except Exception:",
            "                logger.exception('fail to validate credential')",
            "                flash(_(\"Fail to validate user credential.\"))",
            "            else:",
            "                if userobj:",
            "                    cherrypy.session[SESSION_KEY] = userobj.username",
            "                    cherrypy.session.regenerate()",
            "                    raise cherrypy.HTTPRedirect(form.redirect.data)",
            "                flash(_(\"Invalid username or password.\"))",
            "",
            "        params = {'form': form}",
            "",
            "        # Add welcome message to params. Try to load translated message.",
            "        if self._welcome_msg:",
            "            params[\"welcome_msg\"] = self._welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = self._welcome_msg.get(locale, params[\"welcome_msg\"])",
            "",
            "        return self._compile_template(\"login.html\", **params).encode(\"utf-8\")",
            "",
            "",
            "class LogoutPage(Controller):",
            "    @cherrypy.expose",
            "    @cherrypy.config(**{'tools.auth_form.on': False})",
            "    def default(self):",
            "        cherrypy.session[SESSION_KEY] = None",
            "        cherrypy.session.regenerate()",
            "        raise cherrypy.HTTPRedirect('/')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import logging",
            "",
            "import cherrypy",
            "from wtforms.fields import PasswordField, StringField",
            "from wtforms.fields.simple import HiddenField",
            "from wtforms.validators import InputRequired, Length",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.core.config import Option",
            "from rdiffweb.tools.auth_form import SESSION_KEY",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class LoginForm(CherryForm):",
            "    login = StringField(",
            "        _('Username'),",
            "        validators=[InputRequired(), Length(max=256, message=_('Username too long.'))],",
            "        render_kw={",
            "            \"placeholder\": _('Username'),",
            "            \"autocorrect\": \"off\",",
            "            \"autocapitalize\": \"none\",",
            "            \"autocomplete\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    password = PasswordField(_('Password'), validators=[InputRequired()], render_kw={\"placeholder\": _('Password')})",
            "    # Sanitize the redirect URL to avoid Open Redirect",
            "    redirect = HiddenField(default='/', filters=[lambda v: v if v.startswith('/') else '/'])",
            "",
            "",
            "class LoginPage(Controller):",
            "    \"\"\"",
            "    This page is used by the authentication to enter a user/pass.",
            "    \"\"\"",
            "",
            "    _welcome_msg = Option(\"welcome_msg\")",
            "",
            "    @cherrypy.expose()",
            "    @cherrypy.config(**{'tools.auth_form.on': False, 'tools.ratelimit.on': True})",
            "    def index(self, **kwargs):",
            "        form = LoginForm()",
            "        # Validate user's credentials",
            "        if form.validate_on_submit():",
            "            try:",
            "                userobj = self.app.store.login(form.login.data, form.password.data)",
            "            except Exception:",
            "                logger.exception('fail to validate credential')",
            "                flash(_(\"Fail to validate user credential.\"))",
            "            else:",
            "                if userobj:",
            "                    cherrypy.session[SESSION_KEY] = userobj.username",
            "                    cherrypy.session.regenerate()",
            "                    raise cherrypy.HTTPRedirect(form.redirect.data)",
            "                flash(_(\"Invalid username or password.\"))",
            "",
            "        params = {'form': form}",
            "",
            "        # Add welcome message to params. Try to load translated message.",
            "        if self._welcome_msg:",
            "            params[\"welcome_msg\"] = self._welcome_msg.get('')",
            "            if hasattr(cherrypy.response, 'i18n'):",
            "                locale = cherrypy.response.i18n.locale.language",
            "                params[\"welcome_msg\"] = self._welcome_msg.get(locale, params[\"welcome_msg\"])",
            "",
            "        return self._compile_template(\"login.html\", **params).encode(\"utf-8\")",
            "",
            "",
            "class LogoutPage(Controller):",
            "    @cherrypy.expose",
            "    @cherrypy.config(**{'tools.auth_form.on': False})",
            "    def default(self):",
            "        cherrypy.session[SESSION_KEY] = None",
            "        cherrypy.session.regenerate()",
            "        raise cherrypy.HTTPRedirect('/')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "22": [],
            "37": [
                "LoginForm"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/pref_general.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 39,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " class UserProfileForm(CherryForm):"
            },
            "3": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    email = EmailField(_('Email'), validators=[DataRequired(), Regexp(PATTERN_EMAIL, message=_(\"Invalid email.\"))])"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    email = EmailField("
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+        _('Email'),"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+        validators=["
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+            DataRequired(),"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+            Length(max=256, message=_(\"Invalid email.\")),"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+            Regexp(PATTERN_EMAIL, message=_(\"Invalid email.\")),"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+        ],"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 48,
                "PatchRowcode": "+    )"
            },
            "12": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 49,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 50,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 51,
                "PatchRowcode": " class UserPasswordForm(CherryForm):"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import logging",
            "import re",
            "",
            "import cherrypy",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.fields.simple import PasswordField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "_logger = logging.getLogger(__name__)",
            "",
            "PATTERN_EMAIL = re.compile(r'[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$')",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    email = EmailField(_('Email'), validators=[DataRequired(), Regexp(PATTERN_EMAIL, message=_(\"Invalid email.\"))])",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    current = PasswordField(_('Current password'), validators=[InputRequired(_(\"Current password is missing.\"))])",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "",
            "    def validate_new(self, field):",
            "        validator = Length(",
            "            min=self.app.cfg.password_min_length,",
            "            max=self.app.cfg.password_max_length,",
            "            message=_('Password must have between %(min)d and %(max)d characters.'),",
            "        )",
            "        validator(self, field)",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "",
            "class PrefsGeneralPanelProvider(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    panel_id = 'general'",
            "",
            "    panel_name = _('Profile')",
            "",
            "    def _handle_set_password(self, action, form):",
            "        \"\"\"",
            "        Called when changing user password.",
            "        \"\"\"",
            "        assert self.app.currentuser",
            "        assert action == 'set_password'",
            "        assert form",
            "        # Validate form",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        # Update user password",
            "        try:",
            "            self.app.currentuser.set_password(form.new.data, old_password=form.current.data)",
            "            flash(_(\"Password updated successfully.\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "    def _handle_set_profile_info(self, action, form):",
            "        \"\"\"",
            "        Called when changing user profile.",
            "        \"\"\"",
            "        assert self.app.currentuser",
            "        assert action == 'set_profile_info'",
            "        assert form",
            "        # Validate form",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        # Update the user's email",
            "        username = self.app.currentuser.username",
            "        _logger.info(\"updating user [%s] email [%s]\", username, form.email.data)",
            "        self.app.currentuser.email = form.email.data",
            "        # Report success",
            "        flash(_(\"Profile updated successfully.\"), level='success')",
            "",
            "    def render_prefs_panel(self, panelid, action=None, **kwargs):  # @UnusedVariable",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(email=self.app.currentuser.email)",
            "        password_form = UserPasswordForm()",
            "        if cherrypy.request.method == 'POST':",
            "            if action == \"set_profile_info\":",
            "                self._handle_set_profile_info(action, profile_form)",
            "            elif action == \"set_password\":",
            "                self._handle_set_password(action, password_form)",
            "            elif action == \"update_repos\":",
            "                self.app.currentuser.refresh_repos(delete=True)",
            "                flash(_(\"Repositories successfully updated\"), level='success')",
            "            elif action is None:",
            "                pass",
            "            else:",
            "                _logger.warning(\"unknown action: %s\", action)",
            "                raise cherrypy.NotFound(\"Unknown action\")",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "        }",
            "        return \"prefs_general.html\", params"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Default preference page to show general user information. It allows user",
            "to change password ans refresh it's repository view.",
            "\"\"\"",
            "",
            "import logging",
            "import re",
            "",
            "import cherrypy",
            "from wtforms.fields.html5 import EmailField",
            "from wtforms.fields.simple import PasswordField",
            "from wtforms.validators import DataRequired, EqualTo, InputRequired, Length, Regexp",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.cherrypy_wtf import CherryForm",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "# Define the logger",
            "_logger = logging.getLogger(__name__)",
            "",
            "PATTERN_EMAIL = re.compile(r'[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$')",
            "",
            "",
            "class UserProfileForm(CherryForm):",
            "    email = EmailField(",
            "        _('Email'),",
            "        validators=[",
            "            DataRequired(),",
            "            Length(max=256, message=_(\"Invalid email.\")),",
            "            Regexp(PATTERN_EMAIL, message=_(\"Invalid email.\")),",
            "        ],",
            "    )",
            "",
            "",
            "class UserPasswordForm(CherryForm):",
            "    current = PasswordField(_('Current password'), validators=[InputRequired(_(\"Current password is missing.\"))])",
            "    new = PasswordField(",
            "        _('New password'),",
            "        validators=[",
            "            InputRequired(_(\"New password is missing.\")),",
            "            EqualTo('confirm', message=_(\"The new password and its confirmation do not match.\")),",
            "        ],",
            "    )",
            "    confirm = PasswordField(",
            "        _('Confirm new password'), validators=[InputRequired(_(\"Confirmation password is missing.\"))]",
            "    )",
            "",
            "    def validate_new(self, field):",
            "        validator = Length(",
            "            min=self.app.cfg.password_min_length,",
            "            max=self.app.cfg.password_max_length,",
            "            message=_('Password must have between %(min)d and %(max)d characters.'),",
            "        )",
            "        validator(self, field)",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "",
            "class PrefsGeneralPanelProvider(Controller):",
            "    \"\"\"",
            "    Plugin to change user profile and password.",
            "    \"\"\"",
            "",
            "    panel_id = 'general'",
            "",
            "    panel_name = _('Profile')",
            "",
            "    def _handle_set_password(self, action, form):",
            "        \"\"\"",
            "        Called when changing user password.",
            "        \"\"\"",
            "        assert self.app.currentuser",
            "        assert action == 'set_password'",
            "        assert form",
            "        # Validate form",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        # Update user password",
            "        try:",
            "            self.app.currentuser.set_password(form.new.data, old_password=form.current.data)",
            "            flash(_(\"Password updated successfully.\"), level='success')",
            "        except ValueError as e:",
            "            flash(str(e), level='warning')",
            "",
            "    def _handle_set_profile_info(self, action, form):",
            "        \"\"\"",
            "        Called when changing user profile.",
            "        \"\"\"",
            "        assert self.app.currentuser",
            "        assert action == 'set_profile_info'",
            "        assert form",
            "        # Validate form",
            "        if not form.validate():",
            "            flash(form.error_message, level='error')",
            "            return",
            "        # Update the user's email",
            "        username = self.app.currentuser.username",
            "        _logger.info(\"updating user [%s] email [%s]\", username, form.email.data)",
            "        self.app.currentuser.email = form.email.data",
            "        # Report success",
            "        flash(_(\"Profile updated successfully.\"), level='success')",
            "",
            "    def render_prefs_panel(self, panelid, action=None, **kwargs):  # @UnusedVariable",
            "        # Process the parameters.",
            "        profile_form = UserProfileForm(email=self.app.currentuser.email)",
            "        password_form = UserPasswordForm()",
            "        if cherrypy.request.method == 'POST':",
            "            if action == \"set_profile_info\":",
            "                self._handle_set_profile_info(action, profile_form)",
            "            elif action == \"set_password\":",
            "                self._handle_set_password(action, password_form)",
            "            elif action == \"update_repos\":",
            "                self.app.currentuser.refresh_repos(delete=True)",
            "                flash(_(\"Repositories successfully updated\"), level='success')",
            "            elif action is None:",
            "                pass",
            "            else:",
            "                _logger.warning(\"unknown action: %s\", action)",
            "                raise cherrypy.NotFound(\"Unknown action\")",
            "        params = {",
            "            'profile_form': profile_form,",
            "            'password_form': password_form,",
            "        }",
            "        return \"prefs_general.html\", params"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "41": [
                "UserProfileForm"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/controller/tests/test_page_admin.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 239,
                "afterPatchRowNumber": 239,
                "PatchRowcode": "         user = self.app.store.get_user('test6')"
            },
            "1": {
                "beforePatchRowNumber": 240,
                "afterPatchRowNumber": 240,
                "PatchRowcode": "         self.assertEqual('', user.user_root)"
            },
            "2": {
                "beforePatchRowNumber": 241,
                "afterPatchRowNumber": 241,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 242,
                "PatchRowcode": "+    def test_add_with_username_too_long(self):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 243,
                "PatchRowcode": "+        # Given a too long username"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 244,
                "PatchRowcode": "+        username = \"test2\" * 52"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 245,
                "PatchRowcode": "+        # When trying to create the user"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 246,
                "PatchRowcode": "+        self._add_user(username, None, \"password\", \"/tmp/\", USER_ROLE)"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 247,
                "PatchRowcode": "+        # Then an error is raised"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 248,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 249,
                "PatchRowcode": "+        self.assertInBody(\"Username too long.\")"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 250,
                "PatchRowcode": "+"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 251,
                "PatchRowcode": "+    def test_add_with_email_too_long(self):"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 252,
                "PatchRowcode": "+        # Given a too long username"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 253,
                "PatchRowcode": "+        email = (\"test2\" * 50) + \"@test.com\""
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 254,
                "PatchRowcode": "+        # When trying to create the user"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 255,
                "PatchRowcode": "+        self._add_user(\"test2\", email, \"password\", \"/tmp/\", USER_ROLE)"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 256,
                "PatchRowcode": "+        # Then an error is raised"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 257,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 258,
                "PatchRowcode": "+        self.assertInBody(\"Email too long.\")"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 259,
                "PatchRowcode": "+"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 260,
                "PatchRowcode": "+    def test_add_with_user_root_too_long(self):"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 261,
                "PatchRowcode": "+        # Given a too long user root"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 262,
                "PatchRowcode": "+        user_root = \"/temp/\" * 50"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 263,
                "PatchRowcode": "+        # When trying to create the user"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 264,
                "PatchRowcode": "+        self._add_user(\"test2\", \"test@test,com\", \"password\", user_root, USER_ROLE)"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 265,
                "PatchRowcode": "+        # Then an error is raised"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 266,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 267,
                "PatchRowcode": "+        self.assertInBody(\"Root directory too long.\")"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 268,
                "PatchRowcode": "+"
            },
            "30": {
                "beforePatchRowNumber": 242,
                "afterPatchRowNumber": 269,
                "PatchRowcode": "     def test_delete_user_with_not_existing_username(self):"
            },
            "31": {
                "beforePatchRowNumber": 243,
                "afterPatchRowNumber": 270,
                "PatchRowcode": "         \"\"\""
            },
            "32": {
                "beforePatchRowNumber": 244,
                "afterPatchRowNumber": 271,
                "PatchRowcode": "         Verify failure to delete invalid username."
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 30, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "import os",
            "from unittest.mock import ANY, MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.store import ADMIN_ROLE, MAINTAINER_ROLE, USER_ROLE",
            "",
            "",
            "class AbstractAdminTest(rdiffweb.test.WebCase):",
            "    \"\"\"Class to regroup command method to test admin page.\"\"\"",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self._quota = {}",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        self.listener.get_disk_quota.side_effect = self._load_quota",
            "        cherrypy.engine.subscribe('get_disk_quota', self.listener.get_disk_quota, priority=40)",
            "        self.listener.get_disk_usage.return_value = 0",
            "        cherrypy.engine.subscribe('get_disk_usage', self.listener.get_disk_usage, priority=40)",
            "        self.listener.set_disk_quota.side_effect = self._store_quota",
            "        cherrypy.engine.subscribe('set_disk_quota', self.listener.set_disk_quota, priority=40)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        cherrypy.engine.unsubscribe('get_disk_quota', self.listener.get_disk_quota)",
            "        cherrypy.engine.unsubscribe('get_disk_usage', self.listener.get_disk_usage)",
            "        cherrypy.engine.unsubscribe('set_disk_quota', self.listener.set_disk_quota)",
            "        return super().tearDown()",
            "",
            "    def _store_quota(self, userobj, value):",
            "        self._quota[userobj.username] = value",
            "",
            "    def _load_quota(self, userobj):",
            "        return self._quota.get(userobj.username, 0)",
            "",
            "    def _add_user(self, username=None, email=None, password=None, user_root=None, role=None):",
            "        b = {}",
            "        b['action'] = 'add'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _edit_user(self, username=None, email=None, password=None, user_root=None, role=None, disk_quota=None):",
            "        b = {}",
            "        b['action'] = 'edit'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if disk_quota is not None:",
            "            b['disk_quota'] = disk_quota",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _delete_user(self, username='test1'):",
            "        b = {'action': 'delete', 'username': username}",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "",
            "class AdminUsersAsAdminTest(AbstractAdminTest):",
            "    \"\"\"Integration test for page_admin\"\"\"",
            "",
            "    login = True",
            "",
            "    def test_add_user_with_role_admin(self):",
            "        # When trying to create a new user with role admin",
            "        self._add_user(\"admin_role\", \"admin_role@test.com\", \"password\", \"/home/\", ADMIN_ROLE)",
            "        # Then page return success",
            "        self.assertStatus(200)",
            "        # Then database is updated",
            "        userobj = self.app.store.get_user('admin_role')",
            "        self.assertEqual(ADMIN_ROLE, userobj.role)",
            "        # Then notification was raised",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_with_role_maintainer(self):",
            "        self._add_user(\"maintainer_role\", \"maintainer_role@test.com\", \"password\", \"/home/\", MAINTAINER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(MAINTAINER_ROLE, self.app.store.get_user('maintainer_role').role)",
            "",
            "    def test_add_user_with_role_user(self):",
            "        self._add_user(\"user_role\", \"user_role@test.com\", \"password\", \"/home/\", USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(USER_ROLE, self.app.store.get_user('user_role').role)",
            "",
            "    def test_add_user_with_invalid_role(self):",
            "        # When trying to create a new user with an invalid role (admin instead of 0)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"test1234\", \"/home/\", 'admin')",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('role: Invalid Choice: could not coerce')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "        # When trying to create a new user with an invalid role (-1)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"test2\", \"/home/\", -1)",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('role: Not a valid choice')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_edit_delete(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", \"test2@test.com\", \"test1234\", \"/home/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"test2@test.com\")",
            "        self.listener.user_added.assert_called_once()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.listener.user_password_changed.reset_mock()",
            "        #  Update user",
            "        self._edit_user(\"test2\", \"chaned@test.com\", \"new-password\", \"/tmp/\", ADMIN_ROLE)",
            "        self.listener.user_attr_changed.assert_called()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"chaned@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "        #  Check with filters",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertInBody(\"test2\")",
            "",
            "        self._delete_user(\"test2\")",
            "        self.listener.user_deleted.assert_called()",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"test2\")",
            "",
            "    def test_add_edit_delete_user_with_encoding(self):",
            "        \"\"\"",
            "        Check creation of user with non-ascii char.",
            "        \"\"\"",
            "        self._add_user(\"\u00c9ric\", \"\u00e9ric@test.com\", \"password\", \"/home/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "        self.assertInBody(\"\u00e9ric@test.com\")",
            "        # Update user",
            "        self._edit_user(\"\u00c9ric\", \"eric.l\u00e9tourno@test.com\", \"\u00e9cureuil\", \"/tmp/\", ADMIN_ROLE)",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "        self.assertInBody(\"eric.l\u00e9tourno@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "        # Check with filter",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "",
            "        self._delete_user(\"\u00c9ric\")",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"\u00c9ric\")",
            "",
            "    def test_add_user_with_empty_username(self):",
            "        \"\"\"",
            "        Verify failure trying to create user without username.",
            "        \"\"\"",
            "        self._add_user(\"\", \"test1@test.com\", \"test1\", \"/tmp/\", USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"username: This field is required.\")",
            "",
            "    def test_add_user_with_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to add the same user.",
            "        \"\"\"",
            "        # Given a user named `test1`",
            "        self._add_user(\"test1\", \"test1@test.com\", \"password\", \"/tmp/\", USER_ROLE)",
            "        # When trying to create a new user with the same name",
            "        self._add_user(\"test1\", \"test1@test.com\", \"password\", \"/tmp/\", USER_ROLE)",
            "        # Then the user list is displayed with an error message.",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User test1 already exists.\")",
            "",
            "    def test_add_user_with_invalid_root_directory(self):",
            "        \"\"\"",
            "        Verify failure to add a user with invalid root directory.",
            "        \"\"\"",
            "        try:",
            "            self._delete_user(\"test5\")",
            "        except Exception:",
            "            pass",
            "        self._add_user(\"test5\", \"test1@test.com\", \"password\", \"/var/invalid/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_add_without_email(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", None, \"password\", \"/tmp/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "    def test_add_without_user_root(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test6\", None, \"password\", None, USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "        user = self.app.store.get_user('test6')",
            "        self.assertEqual('', user.user_root)",
            "",
            "    def test_delete_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure to delete invalid username.",
            "        \"\"\"",
            "        self._delete_user(\"test3\")",
            "        self.assertInBody(\"User doesn&#39;t exists!\")",
            "",
            "    def test_delete_our_self(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        self._delete_user(self.USERNAME)",
            "        self.assertInBody(\"You cannot remove your own account!\")",
            "",
            "    def test_delete_user_admin(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        # Create another admin user",
            "        self._add_user('admin2', '', 'password', '', ADMIN_ROLE)",
            "        self.getPage(\"/logout/\")",
            "        self._login('admin2', 'password')",
            "",
            "        # Try deleting admin user",
            "        self._delete_user(self.USERNAME)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"can&#39;t delete admin user\")",
            "",
            "    def test_delete_user_method_get(self):",
            "        # Given a user",
            "        self.app.store.add_user('newuser')",
            "        # When trying to delete this user using method GET",
            "        self.getPage(\"/admin/users/?action=delete&username=newuser\", method='GET')",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then user is not deleted",
            "        self.assertIsNotNone(self.app.store.get_user('newuser'))",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._edit_user(self.USERNAME, password='short')",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._edit_user(self.USERNAME, password=new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_admin_password(self):",
            "        # Given rdiffweb is configured with admin-password option",
            "        self.app.cfg.admin_password = 'hardcoded'",
            "        try:",
            "            # When trying to update admin password",
            "            self._edit_user('admin', password='new-password')",
            "            # Then the form is refused with 200 OK with an error message.",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"can&#39;t update admin-password defined in configuration file\")",
            "        finally:",
            "            self.app.cfg.admin_password = None",
            "",
            "    def test_edit_user_with_invalid_path(self):",
            "        \"\"\"",
            "        Verify failure trying to update user with invalid path.",
            "        \"\"\"",
            "        self.app.store.add_user('test1')",
            "        self._edit_user(\"test1\", \"test1@test.com\", \"password\", \"/var/invalid/\", USER_ROLE)",
            "        self.assertNotInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_list(self):",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertInBody(\"Users\")",
            "        self.assertInBody(\"User management\")",
            "        self.assertInBody(\"Add user\")",
            "",
            "    def test_edit_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to update invalid user.",
            "        \"\"\"",
            "        # Given an invalid username",
            "        username = 'invalid'",
            "        # When trying to edit the user",
            "        self._edit_user(username, \"test1@test.com\", \"test\", \"/var/invalid/\", USER_ROLE)",
            "        # Then the user list is displayed with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit user `invalid`: user doesn&#39;t exists\")",
            "",
            "    def test_criteria(self):",
            "        \"\"\"",
            "        Check if admin criteria is working.",
            "        \"\"\"",
            "        self.app.store.add_user('test1')",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertNotInBody(\"test1\")",
            "",
            "    def test_search(self):",
            "        \"\"\"",
            "        Check if user search is working.",
            "        \"\"\"",
            "        self.app.store.add_user('test1')",
            "        self.getPage(\"/admin/users?search=tes\")",
            "        self.assertInBody(\"test1\")",
            "        self.getPage(\"/admin/users?search=coucou\")",
            "        self.assertNotInBody(\"test1\")",
            "",
            "    def test_user_invalid_root(self):",
            "        # Delete all user's",
            "        for user in self.app.store.users():",
            "            if user.username != self.USERNAME:",
            "                user.delete()",
            "        # Change the user's root",
            "        user = self.app.store.get_user('admin')",
            "        user.user_root = \"/invalid\"",
            "        self.getPage(\"/admin/users\")",
            "        self.assertInBody(\"Root directory not accessible!\")",
            "",
            "        # Query the page by default",
            "        user = self.app.store.get_user('admin')",
            "        user.user_root = \"/tmp/\"",
            "        self.getPage(\"/admin/users\")",
            "        self.assertNotInBody(\"Root directory not accessible!\")",
            "",
            "    def test_get_quota(self):",
            "        # Mock a quota.",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 654321",
            "        # When querying the user list",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertStatus(200)",
            "        # Then get_disk_quota listenre is called",
            "        self.listener.get_disk_quota.assert_called()",
            "        # Then the quota value is displayed in human readable format",
            "        self.assertInBody(\"638.99 KiB\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota(self):",
            "        # When updating user quota.",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then listenr get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_gib(self):",
            "        # When updating user quota",
            "        self._edit_user(\"admin\", disk_quota='1GiB')",
            "        # Then listern get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1073741824)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_comma(self):",
            "        # When updating quota with comma value",
            "        self._edit_user(\"admin\", disk_quota='1,5 GiB')",
            "        # Then listner get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1610612736)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_leading_dot(self):",
            "        # When updating quota with leading dot",
            "        self._edit_user(\"admin\", disk_quota='.5 GiB')",
            "        # Then listener get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 536870912)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_empty(self):",
            "        # When quota is not defined",
            "        self._edit_user(\"admin\", disk_quota='')",
            "        # Then listener is not called.",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_same_value(self):",
            "        # Given an exiting quota",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 1234567890",
            "        # When setting the quota value to the same value",
            "        self._edit_user(\"admin\", disk_quota='1.15 GiB')",
            "        #  Then listener is not called",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_unsupported(self):",
            "        # Given setting quota is not supported",
            "        self.listener.set_disk_quota.side_effect = None",
            "        self.listener.set_disk_quota.return_value = None",
            "        # When updating the quota",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        self.assertInBody(\"Setting user&#39;s quota is not supported\")",
            "        self.assertStatus(200)",
            "",
            "",
            "class AdminUsersAsUserTest(AbstractAdminTest):",
            "    \"\"\"Integration test for page_admin\"\"\"",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        # Add test user",
            "        self.app.store.add_user('test', 'test123')",
            "        self._login('test', 'test123')",
            "",
            "    def test_add_user(self):",
            "        \"\"\"",
            "        Check if adding user is forbidden.",
            "        \"\"\"",
            "        self._add_user(\"test2\", \"test2@test.com\", \"test2\", \"/tmp/\", USER_ROLE)",
            "        self.assertStatus(403)",
            "",
            "    def test_delete_user(self):",
            "        \"\"\"",
            "        Check if deleting user is forbidden.",
            "        \"\"\"",
            "        self._delete_user(\"test\")",
            "        self.assertStatus(403)",
            "",
            "    def test_edit_user(self):",
            "        \"\"\"",
            "        Check if editing user is forbidden.",
            "        \"\"\"",
            "        self._edit_user(\"test\", \"test1@test.com\", \"test\", \"/var/invalid/\", USER_ROLE)",
            "        self.assertStatus(403)",
            "",
            "    def test_users(self):",
            "        \"\"\"",
            "        Check if listing user is forbidden.",
            "        \"\"\"",
            "        self.getPage(\"/admin/users\")",
            "        self.assertStatus(403)",
            "",
            "    def test_repos(self):",
            "        \"\"\"",
            "        Check if listing user is forbidden.",
            "        \"\"\"",
            "        self.getPage(\"/admin/repos\")",
            "        self.assertStatus(403)",
            "",
            "",
            "class AdminWithNoLogsTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_logs(self):",
            "        self.getPage(\"/admin/logs/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"No log files\")",
            "",
            "",
            "class AdminWithLogsTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "    default_config = {'logfile': '/tmp/rdiffweb.log', 'logaccessfile': '/tmp/rdiffweb-access.log'}",
            "",
            "    def test_logs(self):",
            "        with open('/tmp/rdiffweb.log', 'w') as f:",
            "            f.write(\"content of log file\")",
            "        with open('/tmp/rdiffweb-access.log', 'w') as f:",
            "            f.write(\"content of log file\")",
            "        try:",
            "            self.getPage(\"/admin/logs/\")",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"rdiffweb.log\")",
            "            self.assertInBody(\"content of log file\")",
            "            self.assertInBody(\"rdiffweb-access.log\")",
            "            self.assertNotInBody(\"Error getting file content\")",
            "        finally:",
            "            os.remove('/tmp/rdiffweb.log')",
            "            os.remove('/tmp/rdiffweb-access.log')",
            "",
            "",
            "class AdminWithLogMissingTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "    default_config = {'logfile': './rdiffweb.log', 'logaccessfile': './rdiffweb-access.log'}",
            "",
            "    def test_logs_with_no_file(self):",
            "        self.getPage(\"/admin/logs/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"rdiffweb.log\")",
            "        self.assertInBody(\"Error getting file content\")",
            "",
            "    def test_logs_with_invalid_file(self):",
            "        self.getPage(\"/admin/logs/invalid\")",
            "        self.assertStatus(404)",
            "",
            "",
            "class AdminReposTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_repos(self):",
            "        self.getPage(\"/admin/repos\")",
            "        self.assertStatus(200)",
            "",
            "    def test_repos_with_search(self):",
            "        # Search something that exists",
            "        self.getPage(\"/admin/repos?search=test\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.REPO)",
            "",
            "        # Search something that doesn't exists",
            "        self.getPage(\"/admin/repos?search=coucou\")",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(self.REPO)",
            "        self.assertInBody(\"No repository found\")",
            "",
            "    def test_repos_with_criteria(self):",
            "        # Search something that exists",
            "        self.getPage(\"/admin/repos?criteria=ok\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.REPO)",
            "",
            "        # Search something that exists",
            "        self.getPage(\"/admin/repos?criteria=failed\")",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(self.REPO)",
            "        self.assertInBody(\"No repository found\")",
            "",
            "",
            "class AdminSysinfoTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_sysinfo(self):",
            "        self.getPage(\"/admin/sysinfo\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Operating System Info\")",
            "        self.assertInBody(\"Python Info\")"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 30, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "import os",
            "from unittest.mock import ANY, MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.store import ADMIN_ROLE, MAINTAINER_ROLE, USER_ROLE",
            "",
            "",
            "class AbstractAdminTest(rdiffweb.test.WebCase):",
            "    \"\"\"Class to regroup command method to test admin page.\"\"\"",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        self._quota = {}",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_added', self.listener.user_added, priority=50)",
            "        cherrypy.engine.subscribe('user_attr_changed', self.listener.user_attr_changed, priority=50)",
            "        cherrypy.engine.subscribe('user_deleted', self.listener.user_deleted, priority=50)",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        self.listener.get_disk_quota.side_effect = self._load_quota",
            "        cherrypy.engine.subscribe('get_disk_quota', self.listener.get_disk_quota, priority=40)",
            "        self.listener.get_disk_usage.return_value = 0",
            "        cherrypy.engine.subscribe('get_disk_usage', self.listener.get_disk_usage, priority=40)",
            "        self.listener.set_disk_quota.side_effect = self._store_quota",
            "        cherrypy.engine.subscribe('set_disk_quota', self.listener.set_disk_quota, priority=40)",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_added', self.listener.user_added)",
            "        cherrypy.engine.unsubscribe('user_attr_changed', self.listener.user_attr_changed)",
            "        cherrypy.engine.unsubscribe('user_deleted', self.listener.user_deleted)",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        cherrypy.engine.unsubscribe('get_disk_quota', self.listener.get_disk_quota)",
            "        cherrypy.engine.unsubscribe('get_disk_usage', self.listener.get_disk_usage)",
            "        cherrypy.engine.unsubscribe('set_disk_quota', self.listener.set_disk_quota)",
            "        return super().tearDown()",
            "",
            "    def _store_quota(self, userobj, value):",
            "        self._quota[userobj.username] = value",
            "",
            "    def _load_quota(self, userobj):",
            "        return self._quota.get(userobj.username, 0)",
            "",
            "    def _add_user(self, username=None, email=None, password=None, user_root=None, role=None):",
            "        b = {}",
            "        b['action'] = 'add'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _edit_user(self, username=None, email=None, password=None, user_root=None, role=None, disk_quota=None):",
            "        b = {}",
            "        b['action'] = 'edit'",
            "        if username is not None:",
            "            b['username'] = username",
            "        if email is not None:",
            "            b['email'] = email",
            "        if password is not None:",
            "            b['password'] = password",
            "        if user_root is not None:",
            "            b['user_root'] = user_root",
            "        if role is not None:",
            "            b['role'] = str(role)",
            "        if disk_quota is not None:",
            "            b['disk_quota'] = disk_quota",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "    def _delete_user(self, username='test1'):",
            "        b = {'action': 'delete', 'username': username}",
            "        self.getPage(\"/admin/users/\", method='POST', body=b)",
            "",
            "",
            "class AdminUsersAsAdminTest(AbstractAdminTest):",
            "    \"\"\"Integration test for page_admin\"\"\"",
            "",
            "    login = True",
            "",
            "    def test_add_user_with_role_admin(self):",
            "        # When trying to create a new user with role admin",
            "        self._add_user(\"admin_role\", \"admin_role@test.com\", \"password\", \"/home/\", ADMIN_ROLE)",
            "        # Then page return success",
            "        self.assertStatus(200)",
            "        # Then database is updated",
            "        userobj = self.app.store.get_user('admin_role')",
            "        self.assertEqual(ADMIN_ROLE, userobj.role)",
            "        # Then notification was raised",
            "        self.listener.user_added.assert_called_once_with(userobj)",
            "",
            "    def test_add_user_with_role_maintainer(self):",
            "        self._add_user(\"maintainer_role\", \"maintainer_role@test.com\", \"password\", \"/home/\", MAINTAINER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(MAINTAINER_ROLE, self.app.store.get_user('maintainer_role').role)",
            "",
            "    def test_add_user_with_role_user(self):",
            "        self._add_user(\"user_role\", \"user_role@test.com\", \"password\", \"/home/\", USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertEqual(USER_ROLE, self.app.store.get_user('user_role').role)",
            "",
            "    def test_add_user_with_invalid_role(self):",
            "        # When trying to create a new user with an invalid role (admin instead of 0)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"test1234\", \"/home/\", 'admin')",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('role: Invalid Choice: could not coerce')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "        # When trying to create a new user with an invalid role (-1)",
            "        self._add_user(\"invalid\", \"invalid@test.com\", \"test2\", \"/home/\", -1)",
            "        # Then an error message is displayed to the user",
            "        self.assertStatus(200)",
            "        self.assertInBody('role: Not a valid choice')",
            "        # Then listener are not called",
            "        self.listener.user_added.assert_not_called()",
            "",
            "    def test_add_edit_delete(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", \"test2@test.com\", \"test1234\", \"/home/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"test2@test.com\")",
            "        self.listener.user_added.assert_called_once()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.listener.user_password_changed.reset_mock()",
            "        #  Update user",
            "        self._edit_user(\"test2\", \"chaned@test.com\", \"new-password\", \"/tmp/\", ADMIN_ROLE)",
            "        self.listener.user_attr_changed.assert_called()",
            "        self.listener.user_password_changed.assert_called_once()",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"test2\")",
            "        self.assertInBody(\"chaned@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "        #  Check with filters",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertInBody(\"test2\")",
            "",
            "        self._delete_user(\"test2\")",
            "        self.listener.user_deleted.assert_called()",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"test2\")",
            "",
            "    def test_add_edit_delete_user_with_encoding(self):",
            "        \"\"\"",
            "        Check creation of user with non-ascii char.",
            "        \"\"\"",
            "        self._add_user(\"\u00c9ric\", \"\u00e9ric@test.com\", \"password\", \"/home/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "        self.assertInBody(\"\u00e9ric@test.com\")",
            "        # Update user",
            "        self._edit_user(\"\u00c9ric\", \"eric.l\u00e9tourno@test.com\", \"\u00e9cureuil\", \"/tmp/\", ADMIN_ROLE)",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "        self.assertInBody(\"eric.l\u00e9tourno@test.com\")",
            "        self.assertNotInBody(\"/home/\")",
            "        self.assertInBody(\"/tmp/\")",
            "        # Check with filter",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertInBody(\"\u00c9ric\")",
            "",
            "        self._delete_user(\"\u00c9ric\")",
            "        self.assertInBody(\"User account removed.\")",
            "        self.assertNotInBody(\"\u00c9ric\")",
            "",
            "    def test_add_user_with_empty_username(self):",
            "        \"\"\"",
            "        Verify failure trying to create user without username.",
            "        \"\"\"",
            "        self._add_user(\"\", \"test1@test.com\", \"test1\", \"/tmp/\", USER_ROLE)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"username: This field is required.\")",
            "",
            "    def test_add_user_with_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to add the same user.",
            "        \"\"\"",
            "        # Given a user named `test1`",
            "        self._add_user(\"test1\", \"test1@test.com\", \"password\", \"/tmp/\", USER_ROLE)",
            "        # When trying to create a new user with the same name",
            "        self._add_user(\"test1\", \"test1@test.com\", \"password\", \"/tmp/\", USER_ROLE)",
            "        # Then the user list is displayed with an error message.",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"User test1 already exists.\")",
            "",
            "    def test_add_user_with_invalid_root_directory(self):",
            "        \"\"\"",
            "        Verify failure to add a user with invalid root directory.",
            "        \"\"\"",
            "        try:",
            "            self._delete_user(\"test5\")",
            "        except Exception:",
            "            pass",
            "        self._add_user(\"test5\", \"test1@test.com\", \"password\", \"/var/invalid/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_add_without_email(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test2\", None, \"password\", \"/tmp/\", USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "    def test_add_without_user_root(self):",
            "        #  Add user to be listed",
            "        self._add_user(\"test6\", None, \"password\", None, USER_ROLE)",
            "        self.assertInBody(\"User added successfully.\")",
            "",
            "        user = self.app.store.get_user('test6')",
            "        self.assertEqual('', user.user_root)",
            "",
            "    def test_add_with_username_too_long(self):",
            "        # Given a too long username",
            "        username = \"test2\" * 52",
            "        # When trying to create the user",
            "        self._add_user(username, None, \"password\", \"/tmp/\", USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Username too long.\")",
            "",
            "    def test_add_with_email_too_long(self):",
            "        # Given a too long username",
            "        email = (\"test2\" * 50) + \"@test.com\"",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", email, \"password\", \"/tmp/\", USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Email too long.\")",
            "",
            "    def test_add_with_user_root_too_long(self):",
            "        # Given a too long user root",
            "        user_root = \"/temp/\" * 50",
            "        # When trying to create the user",
            "        self._add_user(\"test2\", \"test@test,com\", \"password\", user_root, USER_ROLE)",
            "        # Then an error is raised",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Root directory too long.\")",
            "",
            "    def test_delete_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure to delete invalid username.",
            "        \"\"\"",
            "        self._delete_user(\"test3\")",
            "        self.assertInBody(\"User doesn&#39;t exists!\")",
            "",
            "    def test_delete_our_self(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        self._delete_user(self.USERNAME)",
            "        self.assertInBody(\"You cannot remove your own account!\")",
            "",
            "    def test_delete_user_admin(self):",
            "        \"\"\"",
            "        Verify failure to delete our self.",
            "        \"\"\"",
            "        # Create another admin user",
            "        self._add_user('admin2', '', 'password', '', ADMIN_ROLE)",
            "        self.getPage(\"/logout/\")",
            "        self._login('admin2', 'password')",
            "",
            "        # Try deleting admin user",
            "        self._delete_user(self.USERNAME)",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"can&#39;t delete admin user\")",
            "",
            "    def test_delete_user_method_get(self):",
            "        # Given a user",
            "        self.app.store.add_user('newuser')",
            "        # When trying to delete this user using method GET",
            "        self.getPage(\"/admin/users/?action=delete&username=newuser\", method='GET')",
            "        # Then page return without error",
            "        self.assertStatus(200)",
            "        # Then user is not deleted",
            "        self.assertIsNotNone(self.app.store.get_user('newuser'))",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._edit_user(self.USERNAME, password='short')",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._edit_user(self.USERNAME, password=new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_admin_password(self):",
            "        # Given rdiffweb is configured with admin-password option",
            "        self.app.cfg.admin_password = 'hardcoded'",
            "        try:",
            "            # When trying to update admin password",
            "            self._edit_user('admin', password='new-password')",
            "            # Then the form is refused with 200 OK with an error message.",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"can&#39;t update admin-password defined in configuration file\")",
            "        finally:",
            "            self.app.cfg.admin_password = None",
            "",
            "    def test_edit_user_with_invalid_path(self):",
            "        \"\"\"",
            "        Verify failure trying to update user with invalid path.",
            "        \"\"\"",
            "        self.app.store.add_user('test1')",
            "        self._edit_user(\"test1\", \"test1@test.com\", \"password\", \"/var/invalid/\", USER_ROLE)",
            "        self.assertNotInBody(\"User added successfully.\")",
            "        self.assertInBody(\"User&#39;s root directory /var/invalid/ is not accessible!\")",
            "",
            "    def test_list(self):",
            "        self.getPage(\"/admin/users/\")",
            "        self.assertInBody(\"Users\")",
            "        self.assertInBody(\"User management\")",
            "        self.assertInBody(\"Add user\")",
            "",
            "    def test_edit_user_with_not_existing_username(self):",
            "        \"\"\"",
            "        Verify failure trying to update invalid user.",
            "        \"\"\"",
            "        # Given an invalid username",
            "        username = 'invalid'",
            "        # When trying to edit the user",
            "        self._edit_user(username, \"test1@test.com\", \"test\", \"/var/invalid/\", USER_ROLE)",
            "        # Then the user list is displayed with an error message",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Cannot edit user `invalid`: user doesn&#39;t exists\")",
            "",
            "    def test_criteria(self):",
            "        \"\"\"",
            "        Check if admin criteria is working.",
            "        \"\"\"",
            "        self.app.store.add_user('test1')",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertNotInBody(\"test1\")",
            "",
            "    def test_search(self):",
            "        \"\"\"",
            "        Check if user search is working.",
            "        \"\"\"",
            "        self.app.store.add_user('test1')",
            "        self.getPage(\"/admin/users?search=tes\")",
            "        self.assertInBody(\"test1\")",
            "        self.getPage(\"/admin/users?search=coucou\")",
            "        self.assertNotInBody(\"test1\")",
            "",
            "    def test_user_invalid_root(self):",
            "        # Delete all user's",
            "        for user in self.app.store.users():",
            "            if user.username != self.USERNAME:",
            "                user.delete()",
            "        # Change the user's root",
            "        user = self.app.store.get_user('admin')",
            "        user.user_root = \"/invalid\"",
            "        self.getPage(\"/admin/users\")",
            "        self.assertInBody(\"Root directory not accessible!\")",
            "",
            "        # Query the page by default",
            "        user = self.app.store.get_user('admin')",
            "        user.user_root = \"/tmp/\"",
            "        self.getPage(\"/admin/users\")",
            "        self.assertNotInBody(\"Root directory not accessible!\")",
            "",
            "    def test_get_quota(self):",
            "        # Mock a quota.",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 654321",
            "        # When querying the user list",
            "        self.getPage(\"/admin/users/?criteria=admins\")",
            "        self.assertStatus(200)",
            "        # Then get_disk_quota listenre is called",
            "        self.listener.get_disk_quota.assert_called()",
            "        # Then the quota value is displayed in human readable format",
            "        self.assertInBody(\"638.99 KiB\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota(self):",
            "        # When updating user quota.",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then listenr get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_gib(self):",
            "        # When updating user quota",
            "        self._edit_user(\"admin\", disk_quota='1GiB')",
            "        # Then listern get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1073741824)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_comma(self):",
            "        # When updating quota with comma value",
            "        self._edit_user(\"admin\", disk_quota='1,5 GiB')",
            "        # Then listner get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 1610612736)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_as_with_leading_dot(self):",
            "        # When updating quota with leading dot",
            "        self._edit_user(\"admin\", disk_quota='.5 GiB')",
            "        # Then listener get called",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 536870912)",
            "        # Then a success message is displayed",
            "        self.assertInBody(\"User information modified successfully.\")",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_empty(self):",
            "        # When quota is not defined",
            "        self._edit_user(\"admin\", disk_quota='')",
            "        # Then listener is not called.",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_same_value(self):",
            "        # Given an exiting quota",
            "        self.listener.get_disk_quota.side_effect = None",
            "        self.listener.get_disk_quota.return_value = 1234567890",
            "        # When setting the quota value to the same value",
            "        self._edit_user(\"admin\", disk_quota='1.15 GiB')",
            "        #  Then listener is not called",
            "        self.listener.set_disk_quota.assert_not_called()",
            "        # Then message is not displayed",
            "        self.assertStatus(200)",
            "",
            "    def test_set_quota_unsupported(self):",
            "        # Given setting quota is not supported",
            "        self.listener.set_disk_quota.side_effect = None",
            "        self.listener.set_disk_quota.return_value = None",
            "        # When updating the quota",
            "        self._edit_user(\"admin\", disk_quota='8765432')",
            "        # Then",
            "        self.listener.set_disk_quota.assert_called_once_with(ANY, 8765432)",
            "        self.assertInBody(\"Setting user&#39;s quota is not supported\")",
            "        self.assertStatus(200)",
            "",
            "",
            "class AdminUsersAsUserTest(AbstractAdminTest):",
            "    \"\"\"Integration test for page_admin\"\"\"",
            "",
            "    def setUp(self):",
            "        super().setUp()",
            "        # Add test user",
            "        self.app.store.add_user('test', 'test123')",
            "        self._login('test', 'test123')",
            "",
            "    def test_add_user(self):",
            "        \"\"\"",
            "        Check if adding user is forbidden.",
            "        \"\"\"",
            "        self._add_user(\"test2\", \"test2@test.com\", \"test2\", \"/tmp/\", USER_ROLE)",
            "        self.assertStatus(403)",
            "",
            "    def test_delete_user(self):",
            "        \"\"\"",
            "        Check if deleting user is forbidden.",
            "        \"\"\"",
            "        self._delete_user(\"test\")",
            "        self.assertStatus(403)",
            "",
            "    def test_edit_user(self):",
            "        \"\"\"",
            "        Check if editing user is forbidden.",
            "        \"\"\"",
            "        self._edit_user(\"test\", \"test1@test.com\", \"test\", \"/var/invalid/\", USER_ROLE)",
            "        self.assertStatus(403)",
            "",
            "    def test_users(self):",
            "        \"\"\"",
            "        Check if listing user is forbidden.",
            "        \"\"\"",
            "        self.getPage(\"/admin/users\")",
            "        self.assertStatus(403)",
            "",
            "    def test_repos(self):",
            "        \"\"\"",
            "        Check if listing user is forbidden.",
            "        \"\"\"",
            "        self.getPage(\"/admin/repos\")",
            "        self.assertStatus(403)",
            "",
            "",
            "class AdminWithNoLogsTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_logs(self):",
            "        self.getPage(\"/admin/logs/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"No log files\")",
            "",
            "",
            "class AdminWithLogsTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "    default_config = {'logfile': '/tmp/rdiffweb.log', 'logaccessfile': '/tmp/rdiffweb-access.log'}",
            "",
            "    def test_logs(self):",
            "        with open('/tmp/rdiffweb.log', 'w') as f:",
            "            f.write(\"content of log file\")",
            "        with open('/tmp/rdiffweb-access.log', 'w') as f:",
            "            f.write(\"content of log file\")",
            "        try:",
            "            self.getPage(\"/admin/logs/\")",
            "            self.assertStatus(200)",
            "            self.assertInBody(\"rdiffweb.log\")",
            "            self.assertInBody(\"content of log file\")",
            "            self.assertInBody(\"rdiffweb-access.log\")",
            "            self.assertNotInBody(\"Error getting file content\")",
            "        finally:",
            "            os.remove('/tmp/rdiffweb.log')",
            "            os.remove('/tmp/rdiffweb-access.log')",
            "",
            "",
            "class AdminWithLogMissingTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "    default_config = {'logfile': './rdiffweb.log', 'logaccessfile': './rdiffweb-access.log'}",
            "",
            "    def test_logs_with_no_file(self):",
            "        self.getPage(\"/admin/logs/\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"rdiffweb.log\")",
            "        self.assertInBody(\"Error getting file content\")",
            "",
            "    def test_logs_with_invalid_file(self):",
            "        self.getPage(\"/admin/logs/invalid\")",
            "        self.assertStatus(404)",
            "",
            "",
            "class AdminReposTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_repos(self):",
            "        self.getPage(\"/admin/repos\")",
            "        self.assertStatus(200)",
            "",
            "    def test_repos_with_search(self):",
            "        # Search something that exists",
            "        self.getPage(\"/admin/repos?search=test\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.REPO)",
            "",
            "        # Search something that doesn't exists",
            "        self.getPage(\"/admin/repos?search=coucou\")",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(self.REPO)",
            "        self.assertInBody(\"No repository found\")",
            "",
            "    def test_repos_with_criteria(self):",
            "        # Search something that exists",
            "        self.getPage(\"/admin/repos?criteria=ok\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(self.REPO)",
            "",
            "        # Search something that exists",
            "        self.getPage(\"/admin/repos?criteria=failed\")",
            "        self.assertStatus(200)",
            "        self.assertNotInBody(self.REPO)",
            "        self.assertInBody(\"No repository found\")",
            "",
            "",
            "class AdminSysinfoTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_sysinfo(self):",
            "        self.getPage(\"/admin/sysinfo\")",
            "        self.assertStatus(200)",
            "        self.assertInBody(\"Operating System Info\")",
            "        self.assertInBody(\"Python Info\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.tests.test_page_admin.AbstractAdminTest.self",
            "rdiffweb.controller.tests.test_page_admin.AdminUsersAsAdminTest.self",
            "tensorflow.python.kernel_tests.quantization_ops.quantization_ops_test"
        ]
    },
    "rdiffweb/controller/tests/test_page_login.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 132,
                "afterPatchRowNumber": 132,
                "PatchRowcode": "         self.getPage('/login/', method='GET')"
            },
            "1": {
                "beforePatchRowNumber": 133,
                "afterPatchRowNumber": 133,
                "PatchRowcode": "         self.assertStatus('200 OK')"
            },
            "2": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 134,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+    def test_getpage_with_username_too_long(self):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+        b = {'login': 'admin' * 52, 'password': 'admin123'}"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+        self.getPage('/login/', method='POST', body=b)"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+        self.assertStatus('200 OK')"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+        self.assertInBody('Username too long.')"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+"
            },
            "9": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 141,
                "PatchRowcode": "     def test_getpage_with_empty_password(self):"
            },
            "10": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 142,
                "PatchRowcode": "         \"\"\""
            },
            "11": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 143,
                "PatchRowcode": "         Check if authentication is failing without a password."
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from base64 import b64encode",
            "",
            "import rdiffweb.test",
            "",
            "",
            "class LoginPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2F')",
            "",
            "    def test_cookie_http_only(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with HttpOnly",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('HttpOnly', cookie)",
            "",
            "    def test_getpage_with_plaintext(self):",
            "        \"\"\"",
            "        Requesting plain text without being authenticated should show the login form.",
            "        \"\"\"",
            "        self.getPage('/', headers=[(\"Accept\", \"text/plain\")])",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2F')",
            "",
            "    def test_getpage_with_redirect_get(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using GET method.",
            "        \"\"\"",
            "        #  Query the page without login-in",
            "        self.getPage('/browse/' + self.USERNAME + \"/\" + self.REPO + '/DIR%EF%BF%BD/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue(",
            "            'Location', self.baseurl + '/login/?redirect=%2Fbrowse%2Fadmin%2Ftestcases%2FDIR%C3%AF%C2%BF%C2%BD%2F'",
            "        )",
            "",
            "    def test_getpage_with_open_redirect(self):",
            "        # Given a user browsing a URL with open redirect",
            "        # When the user visit the login page",
            "        self.getPage('/login/?redirect=https://attacker.com')",
            "        # The URL is sanitize.",
            "        self.assertNotInBody('https://attacker.com')",
            "",
            "    def test_getpage_with_broken_encoding(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using GET method.",
            "        \"\"\"",
            "        #  Query the page without login-in",
            "        self.getPage(",
            "            '/restore/'",
            "            + self.USERNAME",
            "            + \"/\"",
            "            + self.REPO",
            "            + '/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt'",
            "        )",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue(",
            "            'Location',",
            "            self.baseurl",
            "            + '/login/?redirect=%2Frestore%2Fadmin%2Ftestcases%2FFichier+avec+non+asci+char+%C3%89velyne+M%C3%A8re.txt',",
            "        )",
            "",
            "    def test_getpage_with_redirect_post(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using POST method.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': 'invalid', 'redirect': '/browse/' + self.REPO + '/DIR%EF%BF%BD/'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('id=\"form-login\"')",
            "        self.assertInBody('/browse/' + self.REPO + '/DIR%EF%BF%BD/\"')",
            "",
            "    def test_getpage_with_querystring_redirect_get(self):",
            "        \"\"\"",
            "        Check if unauthenticated users are redirect properly to login page.",
            "        \"\"\"",
            "        self.getPage('/browse/' + self.REPO + '/?restore=T')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2Fbrowse%2Ftestcases%2F%3Frestore%3DT')",
            "",
            "    def test_getpage_with_multiple_querystring_redirect_get(self):",
            "        self.getPage('/restore/' + self.REPO + '?date=1414871387&kind=zip')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue(",
            "            'Location', self.baseurl + '/login/?redirect=%2Frestore%2Ftestcases%3Fdate%3D1414871387%26kind%3Dzip'",
            "        )",
            "",
            "    def test_getpage_with_redirection(self):",
            "        \"\"\"",
            "        Check if redirect url is properly rendered in HTML.",
            "        \"\"\"",
            "        b = {",
            "            'login': 'admin',",
            "            'password': 'admin123',",
            "            'redirect': '/restore/' + self.REPO + '?date=1414871387&kind=zip',",
            "        }",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/restore/' + self.REPO + '?date=1414871387&kind=zip')",
            "",
            "    def test_getpage_without_username(self):",
            "        \"\"\"",
            "        Check if error is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/login/', method='GET')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getpage_with_empty_password(self):",
            "        \"\"\"",
            "        Check if authentication is failing without a password.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': ''}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('This field is required.')",
            "",
            "    def test_getpage_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='GET')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_post_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='POST')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_getpage_admin(self):",
            "        \"\"\"",
            "        Access to admin area without session should redirect to login page.",
            "        \"\"\"",
            "        self.getPage('/admin/')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_getapi_without_authorization(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/')",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_without_username(self):",
            "        \"\"\"",
            "        Check if error 401 is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\":admin123\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_empty_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_invalid_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_authorization(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getapi_with_session(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        # Get api using the same session.",
            "        self.getPage('/api/')",
            "        self.assertStatus('200 OK')",
            "",
            "",
            "class LoginPageWithWelcomeMsgTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'welcomemsg': 'default message', 'welcomemsg[fr]': 'french message'}",
            "",
            "    def test_getpage_default(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"it\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('default message')",
            "",
            "    def test_getpage_french(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"fr\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('french message')",
            "",
            "",
            "class LoginPageWithSessionDirTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'session-dir': '/tmp',",
            "    }",
            "",
            "    def test_login(self):",
            "        # Query a page",
            "        self.getPage('/login/')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Enter your username and password to log in.')",
            "        # Login",
            "        self.getPage(\"/login/\", method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        self.assertStatus('303 See Other')",
            "        # Query page again",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        self.assertNotInBody('Enter your username and password to log in.')",
            "",
            "",
            "class LoginPageRateLimitTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/')",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitWithSessionDirTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'session-dir': '/tmp',",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/')",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTestWithXForwardedFor(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/', headers=[('X-Forwarded-For', '127.0.0.%s' % i)])",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTestWithXRealIP(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/', headers=[('X-Real-IP', '127.0.0.%s' % i)])",
            "        # Then a 200 is return.",
            "        self.assertStatus(200)",
            "",
            "",
            "class LogoutPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage_without_login(self):",
            "        # Accessing logout page directly will redirect to \"/\".",
            "        self.getPage('/logout/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "    def test_getpage_with_login(self):",
            "        # Login",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/\")",
            "        self.assertStatus('200 OK')",
            "        # Then logout",
            "        self.getPage('/logout/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/\")",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2Fprefs%2F')"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from base64 import b64encode",
            "",
            "import rdiffweb.test",
            "",
            "",
            "class LoginPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2F')",
            "",
            "    def test_cookie_http_only(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with HttpOnly",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('HttpOnly', cookie)",
            "",
            "    def test_getpage_with_plaintext(self):",
            "        \"\"\"",
            "        Requesting plain text without being authenticated should show the login form.",
            "        \"\"\"",
            "        self.getPage('/', headers=[(\"Accept\", \"text/plain\")])",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2F')",
            "",
            "    def test_getpage_with_redirect_get(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using GET method.",
            "        \"\"\"",
            "        #  Query the page without login-in",
            "        self.getPage('/browse/' + self.USERNAME + \"/\" + self.REPO + '/DIR%EF%BF%BD/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue(",
            "            'Location', self.baseurl + '/login/?redirect=%2Fbrowse%2Fadmin%2Ftestcases%2FDIR%C3%AF%C2%BF%C2%BD%2F'",
            "        )",
            "",
            "    def test_getpage_with_open_redirect(self):",
            "        # Given a user browsing a URL with open redirect",
            "        # When the user visit the login page",
            "        self.getPage('/login/?redirect=https://attacker.com')",
            "        # The URL is sanitize.",
            "        self.assertNotInBody('https://attacker.com')",
            "",
            "    def test_getpage_with_broken_encoding(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using GET method.",
            "        \"\"\"",
            "        #  Query the page without login-in",
            "        self.getPage(",
            "            '/restore/'",
            "            + self.USERNAME",
            "            + \"/\"",
            "            + self.REPO",
            "            + '/Fichier%20avec%20non%20asci%20char%20%C9velyne%20M%E8re.txt'",
            "        )",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue(",
            "            'Location',",
            "            self.baseurl",
            "            + '/login/?redirect=%2Frestore%2Fadmin%2Ftestcases%2FFichier+avec+non+asci+char+%C3%89velyne+M%C3%A8re.txt',",
            "        )",
            "",
            "    def test_getpage_with_redirect_post(self):",
            "        \"\"\"",
            "        Check encoding of redirect url when send using POST method.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': 'invalid', 'redirect': '/browse/' + self.REPO + '/DIR%EF%BF%BD/'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('id=\"form-login\"')",
            "        self.assertInBody('/browse/' + self.REPO + '/DIR%EF%BF%BD/\"')",
            "",
            "    def test_getpage_with_querystring_redirect_get(self):",
            "        \"\"\"",
            "        Check if unauthenticated users are redirect properly to login page.",
            "        \"\"\"",
            "        self.getPage('/browse/' + self.REPO + '/?restore=T')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2Fbrowse%2Ftestcases%2F%3Frestore%3DT')",
            "",
            "    def test_getpage_with_multiple_querystring_redirect_get(self):",
            "        self.getPage('/restore/' + self.REPO + '?date=1414871387&kind=zip')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue(",
            "            'Location', self.baseurl + '/login/?redirect=%2Frestore%2Ftestcases%3Fdate%3D1414871387%26kind%3Dzip'",
            "        )",
            "",
            "    def test_getpage_with_redirection(self):",
            "        \"\"\"",
            "        Check if redirect url is properly rendered in HTML.",
            "        \"\"\"",
            "        b = {",
            "            'login': 'admin',",
            "            'password': 'admin123',",
            "            'redirect': '/restore/' + self.REPO + '?date=1414871387&kind=zip',",
            "        }",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/restore/' + self.REPO + '?date=1414871387&kind=zip')",
            "",
            "    def test_getpage_without_username(self):",
            "        \"\"\"",
            "        Check if error is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/login/', method='GET')",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getpage_with_username_too_long(self):",
            "        b = {'login': 'admin' * 52, 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Username too long.')",
            "",
            "    def test_getpage_with_empty_password(self):",
            "        \"\"\"",
            "        Check if authentication is failing without a password.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': ''}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('This field is required.')",
            "",
            "    def test_getpage_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='GET')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_post_with_invalid_url(self):",
            "        self.getPage('/login/kefuxian.mvc', method='POST')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_getpage_admin(self):",
            "        \"\"\"",
            "        Access to admin area without session should redirect to login page.",
            "        \"\"\"",
            "        self.getPage('/admin/')",
            "        self.assertStatus('303 See Other')",
            "",
            "    def test_getapi_without_authorization(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/')",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_without_username(self):",
            "        \"\"\"",
            "        Check if error 401 is raised when requesting /login without a username.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\":admin123\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_empty_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_invalid_password(self):",
            "        \"\"\"",
            "        Check if 401 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:invalid\").decode('ascii'))])",
            "        self.assertStatus('401 Unauthorized')",
            "",
            "    def test_getapi_with_authorization(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        self.getPage('/api/', headers=[(\"Authorization\", \"Basic \" + b64encode(b\"admin:admin123\").decode('ascii'))])",
            "        self.assertStatus('200 OK')",
            "",
            "    def test_getapi_with_session(self):",
            "        \"\"\"",
            "        Check if 200 is return when authorization is not provided.",
            "        \"\"\"",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        # Get api using the same session.",
            "        self.getPage('/api/')",
            "        self.assertStatus('200 OK')",
            "",
            "",
            "class LoginPageWithWelcomeMsgTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {'welcomemsg': 'default message', 'welcomemsg[fr]': 'french message'}",
            "",
            "    def test_getpage_default(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"it\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('default message')",
            "",
            "    def test_getpage_french(self):",
            "        \"\"\"",
            "        Make sure the login page can be rendered without error.",
            "        \"\"\"",
            "        self.getPage('/login/', headers=[(\"Accept-Language\", \"fr\")])",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('french message')",
            "",
            "",
            "class LoginPageWithSessionDirTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'session-dir': '/tmp',",
            "    }",
            "",
            "    def test_login(self):",
            "        # Query a page",
            "        self.getPage('/login/')",
            "        self.assertStatus('200 OK')",
            "        self.assertInBody('Enter your username and password to log in.')",
            "        # Login",
            "        self.getPage(\"/login/\", method='POST', body={'login': self.USERNAME, 'password': self.PASSWORD})",
            "        self.assertStatus('303 See Other')",
            "        # Query page again",
            "        self.getPage('/')",
            "        self.assertStatus('200 OK')",
            "        self.assertNotInBody('Enter your username and password to log in.')",
            "",
            "",
            "class LoginPageRateLimitTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/')",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitWithSessionDirTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'session-dir': '/tmp',",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/')",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTestWithXForwardedFor(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/', headers=[('X-Forwarded-For', '127.0.0.%s' % i)])",
            "        # Then a 429 error (too many request) is return",
            "        self.assertStatus(429)",
            "",
            "",
            "class LoginPageRateLimitTestWithXRealIP(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'rate-limit': 5,",
            "    }",
            "",
            "    def test_login_ratelimit(self):",
            "        # Given an unauthenticate",
            "        # When requesting multple time the login page",
            "        for i in range(0, 6):",
            "            self.getPage('/login/', headers=[('X-Real-IP', '127.0.0.%s' % i)])",
            "        # Then a 200 is return.",
            "        self.assertStatus(200)",
            "",
            "",
            "class LogoutPageTest(rdiffweb.test.WebCase):",
            "    def test_getpage_without_login(self):",
            "        # Accessing logout page directly will redirect to \"/\".",
            "        self.getPage('/logout/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "",
            "    def test_getpage_with_login(self):",
            "        # Login",
            "        b = {'login': 'admin', 'password': 'admin123'}",
            "        self.getPage('/login/', method='POST', body=b)",
            "        self.assertStatus('303 See Other')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/\")",
            "        self.assertStatus('200 OK')",
            "        # Then logout",
            "        self.getPage('/logout/')",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/')",
            "        # Get content of a page.",
            "        self.getPage(\"/prefs/\")",
            "        self.assertStatus('303 See Other')",
            "        self.assertHeaderItemValue('Location', self.baseurl + '/login/?redirect=%2Fprefs%2F')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.tests.test_page_login.LoginPageTest.self"
        ]
    },
    "rdiffweb/controller/tests/test_page_prefs.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "         self._set_profile_info(\"test@test.com, test2@test.com\")"
            },
            "1": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 85,
                "PatchRowcode": "         self.assertInBody(\"Invalid email\")"
            },
            "2": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 86,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+    def test_change_email_with_too_long(self):"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+        self._set_profile_info((\"test1\" * 50) + \"@test.com\")"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+        self.assertInBody(\"Invalid email\")"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+"
            },
            "7": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "     def test_change_password(self):"
            },
            "8": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "         # When udating user's password"
            },
            "9": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 93,
                "PatchRowcode": "         self._set_password(self.PASSWORD, \"newpassword\", \"newpassword\")"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.store import _REPOS",
            "",
            "",
            "class PrefsTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_email_with_invalid_email(self):",
            "        self._set_profile_info(\"@test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test@te_st.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test@test.com, test2@test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "    def test_change_password(self):",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"newpassword\", \"newpassword\")",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "        # Change it back",
            "        self._set_password(\"newpassword\", self.PASSWORD, self.PASSWORD)",
            "        self.assertInBody(\"Password updated successfully.\")",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"newpassword\", \"newpassword\")",
            "        self.assertInBody(\"Wrong password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = self.app.store.get_user(self.USERNAME)",
            "        with self.app.store.engine.connect() as conn:",
            "            conn.execute(_REPOS.insert().values(userid=userobj._userid, repopath='invalid'))",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_update_notification(self):",
            "        self.getPage(\"/prefs/notification/\", method='POST', body={'action': 'set_notification_info', 'testcases': '7'})",
            "        self.assertStatus(200)",
            "        # Check database update",
            "        repo_obj = self.app.store.get_user(self.USERNAME).get_repo(self.REPO)",
            "        self.assertEqual(7, repo_obj.maxage)",
            "",
            "    def test_update_notification_method_get(self):",
            "        # Given a user with repositories",
            "        # When trying to update notification with GET method",
            "        self.getPage(\"/prefs/notification?action=set_notification_info&testcases=7\")",
            "        # Then page return with success",
            "        self.assertStatus(200)",
            "        # Then page doesn't update values",
            "        self.assertNotInBody('Notification settings updated successfully.')",
            "        # Then database is not updated",
            "        repo_obj = self.app.store.get_user(self.USERNAME).get_repo(self.REPO)",
            "        self.assertEqual(0, repo_obj.maxage)",
            "",
            "    def test_get_page(self):",
            "        self.getPage(\"/prefs/\", method='GET')",
            "        self.assertInBody(\"SSH\")",
            "",
            "",
            "class PrefsWithSSHKeyDisabled(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        \"disable_ssh_keys\": \"true\",",
            "    }",
            "",
            "    def test_get_page(self):",
            "        self.getPage(\"/prefs/\", method='GET')",
            "        self.assertNotInBody(\"SSH\")"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Dec 26, 2015",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.test",
            "from rdiffweb.core.store import _REPOS",
            "",
            "",
            "class PrefsTest(rdiffweb.test.WebCase):",
            "",
            "    PREFS = \"/prefs/\"",
            "",
            "    login = True",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('user_password_changed', self.listener.user_password_changed, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('user_password_changed', self.listener.user_password_changed)",
            "        return super().tearDown()",
            "",
            "    def _set_password(",
            "        self,",
            "        current,",
            "        new_password,",
            "        confirm,",
            "    ):",
            "        b = {",
            "            'action': 'set_password',",
            "            'current': current,",
            "            'new': new_password,",
            "            'confirm': confirm,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def _set_profile_info(self, email):",
            "        b = {",
            "            'action': 'set_profile_info',",
            "            'email': email,",
            "        }",
            "        return self.getPage(self.PREFS, method='POST', body=b)",
            "",
            "    def test_change_email(self):",
            "        self._set_profile_info(\"test@test.com\")",
            "        self.assertInBody(\"Profile updated successfully.\")",
            "",
            "    def test_change_email_with_invalid_email(self):",
            "        self._set_profile_info(\"@test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test@te_st.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "        self._set_profile_info(\"test@test.com, test2@test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "    def test_change_email_with_too_long(self):",
            "        self._set_profile_info((\"test1\" * 50) + \"@test.com\")",
            "        self.assertInBody(\"Invalid email\")",
            "",
            "    def test_change_password(self):",
            "        # When udating user's password",
            "        self._set_password(self.PASSWORD, \"newpassword\", \"newpassword\")",
            "        self.assertInBody(\"Password updated successfully.\")",
            "        # Then a notification is raised",
            "        self.listener.user_password_changed.assert_called_once()",
            "        # Change it back",
            "        self._set_password(\"newpassword\", self.PASSWORD, self.PASSWORD)",
            "        self.assertInBody(\"Password updated successfully.\")",
            "",
            "    def test_change_password_with_wrong_confirmation(self):",
            "        self._set_password(self.PASSWORD, \"t\", \"a\")",
            "        self.assertInBody(\"The new password and its confirmation do not match.\")",
            "",
            "    def test_change_password_with_wrong_password(self):",
            "        self._set_password(\"oups\", \"newpassword\", \"newpassword\")",
            "        self.assertInBody(\"Wrong password\")",
            "",
            "    def test_change_password_with_too_short(self):",
            "        self._set_password(self.PASSWORD, \"short\", \"short\")",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_change_password_with_too_long(self):",
            "        new_password = 'a' * 129",
            "        self._set_password(self.PASSWORD, new_password, new_password)",
            "        self.assertInBody(\"Password must have between 8 and 128 characters.\")",
            "",
            "    def test_invalid_pref(self):",
            "        \"\"\"",
            "        Check if invalid prefs url is 404 Not Found.",
            "        \"\"\"",
            "        self.getPage(\"/prefs/invalid/\")",
            "        self.assertStatus(404)",
            "",
            "    def test_update_repos(self):",
            "        # Given a user with invalid repositories",
            "        userobj = self.app.store.get_user(self.USERNAME)",
            "        with self.app.store.engine.connect() as conn:",
            "            conn.execute(_REPOS.insert().values(userid=userobj._userid, repopath='invalid'))",
            "        self.assertEqual(['broker-repo', 'invalid', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "        # When updating the repository list",
            "        self.getPage(self.PREFS, method='POST', body={'action': 'update_repos'})",
            "        self.assertStatus(200)",
            "        # Then a success message is displayed",
            "        self.assertInBody('Repositories successfully updated')",
            "        # Then the list is free of inexisting repos.",
            "        self.assertEqual(['broker-repo', 'testcases'], sorted([r.name for r in userobj.repo_objs]))",
            "",
            "    def test_update_notification(self):",
            "        self.getPage(\"/prefs/notification/\", method='POST', body={'action': 'set_notification_info', 'testcases': '7'})",
            "        self.assertStatus(200)",
            "        # Check database update",
            "        repo_obj = self.app.store.get_user(self.USERNAME).get_repo(self.REPO)",
            "        self.assertEqual(7, repo_obj.maxage)",
            "",
            "    def test_update_notification_method_get(self):",
            "        # Given a user with repositories",
            "        # When trying to update notification with GET method",
            "        self.getPage(\"/prefs/notification?action=set_notification_info&testcases=7\")",
            "        # Then page return with success",
            "        self.assertStatus(200)",
            "        # Then page doesn't update values",
            "        self.assertNotInBody('Notification settings updated successfully.')",
            "        # Then database is not updated",
            "        repo_obj = self.app.store.get_user(self.USERNAME).get_repo(self.REPO)",
            "        self.assertEqual(0, repo_obj.maxage)",
            "",
            "    def test_get_page(self):",
            "        self.getPage(\"/prefs/\", method='GET')",
            "        self.assertInBody(\"SSH\")",
            "",
            "",
            "class PrefsWithSSHKeyDisabled(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        \"disable_ssh_keys\": \"true\",",
            "    }",
            "",
            "    def test_get_page(self):",
            "        self.getPage(\"/prefs/\", method='GET')",
            "        self.assertNotInBody(\"SSH\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.tests.test_page_prefs.PrefsTest.self"
        ]
    }
}