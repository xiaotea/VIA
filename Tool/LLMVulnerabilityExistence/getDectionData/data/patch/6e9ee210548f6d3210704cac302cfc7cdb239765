{
    "rdiffweb/controller/page_pref_mfa.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": 107,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": 108,
                "PatchRowcode": " class PagePrefMfa(Controller):"
            },
            "2": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": 109,
                "PatchRowcode": "     @cherrypy.expose"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 110,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'])"
            },
            "4": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "     def default(self, action=None, **kwargs):"
            },
            "5": {
                "beforePatchRowNumber": 111,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "         form = MfaToggleForm(obj=self.app.currentuser)"
            },
            "6": {
                "beforePatchRowNumber": 112,
                "afterPatchRowNumber": 113,
                "PatchRowcode": "         if form.is_submitted():"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms.fields import SelectField, StringField, SubmitField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets import HiddenInput",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class AbstractMfaForm(CherryForm):",
            "    def __init__(self, obj, **kwargs):",
            "        assert obj",
            "        super().__init__(obj=obj, **kwargs)",
            "        # Keep only one of the enable or disable button",
            "        if obj.mfa:",
            "            self.enable_mfa.widget = HiddenInput()",
            "            self.enable_mfa.data = ''",
            "        else:",
            "            self.disable_mfa.widget = HiddenInput()",
            "            self.disable_mfa.data = ''",
            "",
            "",
            "class MfaStatusForm(AbstractMfaForm):",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA) Status'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        render_kw={'readonly': True, 'disabled': True, 'data-beta': '1'},",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "",
            "",
            "class MfaToggleForm(AbstractMfaForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        render_kw={",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link\"},",
            "    )",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def populate_obj(self, userobj):",
            "        # Enable or disable MFA only when a code is provided.",
            "        try:",
            "            if self.enable_mfa.data:",
            "                userobj.mfa = UserObject.ENABLED_MFA",
            "                userobj.commit()",
            "                flash(_(\"Two-Factor authentication enabled successfully.\"), level='success')",
            "            elif self.disable_mfa.data:",
            "                userobj.mfa = UserObject.DISABLED_MFA",
            "                userobj.commit()",
            "                flash(_(\"Two-Factor authentication disabled successfully.\"), level='success')",
            "        except Exception as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "",
            "    def validate_code(self, field):",
            "        # Code is required for enable_mfa and disable_mfa",
            "        if self.enable_mfa.data or self.disable_mfa.data:",
            "            if not self.code.data:",
            "                raise ValidationError(_(\"Enter the verification code to continue.\"))",
            "            # Validate code",
            "            if not cherrypy.tools.auth_mfa.verify_code(self.code.data, False):",
            "                raise ValidationError(_(\"Invalid verification code.\"))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.enable_mfa.data or self.disable_mfa.data or self.resend_code.data):",
            "            raise ValidationError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class PagePrefMfa(Controller):",
            "    @cherrypy.expose",
            "    def default(self, action=None, **kwargs):",
            "        form = MfaToggleForm(obj=self.app.currentuser)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.resend_code.data:",
            "                    self.send_code()",
            "                elif form.enable_mfa.data or form.disable_mfa.data:",
            "                    form.populate_obj(self.app.currentuser)",
            "                    form = MfaStatusForm(obj=self.app.currentuser)",
            "            # Send verification code if previous code expired.",
            "            elif cherrypy.tools.auth_mfa.is_code_expired():",
            "                self.send_code()",
            "        else:",
            "            form = MfaStatusForm(obj=self.app.currentuser)",
            "        params = {",
            "            'form': form,",
            "        }",
            "        return self._compile_template(\"prefs_mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        userobj = self.app.currentuser",
            "        if not userobj.email:",
            "            flash(_(\"To continue, you must set up an email address for your account.\"), level='warning')",
            "            return",
            "        code = cherrypy.tools.auth_mfa.generate_code()",
            "        body = self.app.templates.compile_template(",
            "            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "        )",
            "        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "        flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "import cherrypy",
            "from wtforms.fields import SelectField, StringField, SubmitField",
            "from wtforms.validators import ValidationError",
            "from wtforms.widgets import HiddenInput",
            "",
            "from rdiffweb.controller import Controller, flash",
            "from rdiffweb.controller.form import CherryForm",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import gettext_lazy as _",
            "",
            "",
            "class AbstractMfaForm(CherryForm):",
            "    def __init__(self, obj, **kwargs):",
            "        assert obj",
            "        super().__init__(obj=obj, **kwargs)",
            "        # Keep only one of the enable or disable button",
            "        if obj.mfa:",
            "            self.enable_mfa.widget = HiddenInput()",
            "            self.enable_mfa.data = ''",
            "        else:",
            "            self.disable_mfa.widget = HiddenInput()",
            "            self.disable_mfa.data = ''",
            "",
            "",
            "class MfaStatusForm(AbstractMfaForm):",
            "    mfa = SelectField(",
            "        _('Two-Factor Authentication (2FA) Status'),",
            "        coerce=int,",
            "        choices=[",
            "            (UserObject.DISABLED_MFA, _(\"Disabled\")),",
            "            (UserObject.ENABLED_MFA, _(\"Enabled\")),",
            "        ],",
            "        render_kw={'readonly': True, 'disabled': True, 'data-beta': '1'},",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "",
            "",
            "class MfaToggleForm(AbstractMfaForm):",
            "    code = StringField(",
            "        _('Verification code'),",
            "        render_kw={",
            "            \"placeholder\": _('Enter verification code here'),",
            "            \"autocomplete\": \"off\",",
            "            \"autocorrect\": \"off\",",
            "            \"autofocus\": \"autofocus\",",
            "        },",
            "    )",
            "    enable_mfa = SubmitField(_('Enable Two-Factor Authentication'), render_kw={\"class\": \"btn-success\"})",
            "    disable_mfa = SubmitField(_('Disable Two-Factor Authentication'), render_kw={\"class\": \"btn-warning\"})",
            "    resend_code = SubmitField(",
            "        _('Resend code to my email'),",
            "        render_kw={\"class\": \"btn-link\"},",
            "    )",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.request.app",
            "",
            "    def populate_obj(self, userobj):",
            "        # Enable or disable MFA only when a code is provided.",
            "        try:",
            "            if self.enable_mfa.data:",
            "                userobj.mfa = UserObject.ENABLED_MFA",
            "                userobj.commit()",
            "                flash(_(\"Two-Factor authentication enabled successfully.\"), level='success')",
            "            elif self.disable_mfa.data:",
            "                userobj.mfa = UserObject.DISABLED_MFA",
            "                userobj.commit()",
            "                flash(_(\"Two-Factor authentication disabled successfully.\"), level='success')",
            "        except Exception as e:",
            "            userobj.rollback()",
            "            flash(str(e), level='warning')",
            "",
            "    def validate_code(self, field):",
            "        # Code is required for enable_mfa and disable_mfa",
            "        if self.enable_mfa.data or self.disable_mfa.data:",
            "            if not self.code.data:",
            "                raise ValidationError(_(\"Enter the verification code to continue.\"))",
            "            # Validate code",
            "            if not cherrypy.tools.auth_mfa.verify_code(self.code.data, False):",
            "                raise ValidationError(_(\"Invalid verification code.\"))",
            "",
            "    def validate(self, extra_validators=None):",
            "        if not (self.enable_mfa.data or self.disable_mfa.data or self.resend_code.data):",
            "            raise ValidationError(_('Invalid operation'))",
            "        return super().validate()",
            "",
            "",
            "class PagePrefMfa(Controller):",
            "    @cherrypy.expose",
            "    @cherrypy.tools.ratelimit(methods=['POST'])",
            "    def default(self, action=None, **kwargs):",
            "        form = MfaToggleForm(obj=self.app.currentuser)",
            "        if form.is_submitted():",
            "            if form.validate():",
            "                if form.resend_code.data:",
            "                    self.send_code()",
            "                elif form.enable_mfa.data or form.disable_mfa.data:",
            "                    form.populate_obj(self.app.currentuser)",
            "                    form = MfaStatusForm(obj=self.app.currentuser)",
            "            # Send verification code if previous code expired.",
            "            elif cherrypy.tools.auth_mfa.is_code_expired():",
            "                self.send_code()",
            "        else:",
            "            form = MfaStatusForm(obj=self.app.currentuser)",
            "        params = {",
            "            'form': form,",
            "        }",
            "        return self._compile_template(\"prefs_mfa.html\", **params)",
            "",
            "    def send_code(self):",
            "        userobj = self.app.currentuser",
            "        if not userobj.email:",
            "            flash(_(\"To continue, you must set up an email address for your account.\"), level='warning')",
            "            return",
            "        code = cherrypy.tools.auth_mfa.generate_code()",
            "        body = self.app.templates.compile_template(",
            "            \"email_verification_code.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'code': code}",
            "        )",
            "        cherrypy.engine.publish('queue_mail', to=userobj.email, subject=_(\"Your verification code\"), message=body)",
            "        flash(_(\"A new verification code has been sent to your email.\"))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.page_pref_mfa.PagePrefMfa.self"
        ]
    },
    "rdiffweb/core/config.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 471,
                "afterPatchRowNumber": 471,
                "PatchRowcode": "         metavar='LIMIT',"
            },
            "1": {
                "beforePatchRowNumber": 472,
                "afterPatchRowNumber": 472,
                "PatchRowcode": "         type=int,"
            },
            "2": {
                "beforePatchRowNumber": 473,
                "afterPatchRowNumber": 473,
                "PatchRowcode": "         default=20,"
            },
            "3": {
                "beforePatchRowNumber": 474,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API.',"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 474,
                "PatchRowcode": "+        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API. default: 20 requests / hour',"
            },
            "5": {
                "beforePatchRowNumber": 475,
                "afterPatchRowNumber": 475,
                "PatchRowcode": "     )"
            },
            "6": {
                "beforePatchRowNumber": 476,
                "afterPatchRowNumber": 476,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 477,
                "afterPatchRowNumber": 477,
                "PatchRowcode": "     parser.add("
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import argparse",
            "import logging",
            "import re",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import configargparse",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Get rdiffweb version.",
            "try:",
            "    VERSION = pkg_resources.get_distribution(\"rdiffweb\").version",
            "except pkg_resources.DistributionNotFound:",
            "    VERSION = \"DEV\"",
            "",
            "",
            "def css_color(value):",
            "    if not re.match('^#?(?:[0-9a-fA-F]{3}){1,2}$', value):",
            "        raise argparse.ArgumentTypeError(\"invalid CSS Color\")",
            "    if value.startswith('#'):",
            "        return value",
            "    return '#' + value",
            "",
            "",
            "def css_font(value):",
            "    if not re.match('^[a-zA-Z0-9 ]+$', value):",
            "        raise argparse.ArgumentTypeError(\"invalid CSS Font name\")",
            "    return value",
            "",
            "",
            "def get_parser():",
            "    # Get global config argument parser",
            "    parser = configargparse.ArgumentParser(",
            "        prog='rdiffweb',",
            "        description='Web interface to browse and restore rdiff-backup repositories.',",
            "        default_config_files=['/etc/rdiffweb/rdw.conf', '/etc/rdiffweb/rdw.conf.d/*.conf'],",
            "        add_env_var_help=True,",
            "        auto_env_var_prefix='RDIFFWEB_',",
            "        config_file_parser_class=ConfigFileParser,",
            "        conflict_handler='resolve',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-f', '--config', is_config_file=True, metavar='FILE', help='location of Rdiffweb configuration file'",
            "    )",
            "",
            "    parser.add(",
            "        '--database-uri',",
            "        '--sqlitedb-file',",
            "        '--sqlitedbfile',",
            "        metavar='URI',",
            "        help=\"\"\"Location of the database used for persistence. SQLite and PostgreSQL",
            "            database are supported officially. To use a SQLite database you may",
            "            define the location using a file path or a URI.",
            "            e.g.: /srv/rdiffweb/file.db or sqlite:///srv/rdiffweb/file.db`.",
            "            To use PostgreSQL server you must provide",
            "            a URI similar to postgresql://user:pass@10.255.1.34/dbname and you",
            "            must install required dependencies.",
            "            By default, Rdiffweb uses a SQLite embedded database located at",
            "            /etc/rdiffweb/rdw.db.\"\"\",",
            "        default='/etc/rdiffweb/rdw.db',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-d',",
            "        '--debug',",
            "        action='store_true',",
            "        help='enable rdiffweb debug mode - change the log level to DEBUG, print exception stack trace to the web interface and show SQL query in logs',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-user',",
            "        '--adminuser',",
            "        metavar='USERNAME',",
            "        help='administrator username. The administrator user get created on startup if the database is empty.',",
            "        default='admin',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-password',",
            "        metavar='USERNAME',",
            "        help=\"\"\"administrator encrypted password as SSHA. Read online",
            "            documentation to know more about how to encrypt your password",
            "            into SSHA or use http://projects.marsching.org/weave4j/util/genpassword.php",
            "            When defined, administrator password cannot be updated using the web interface.",
            "            When undefined, default administrator password is `admin123` and",
            "            it can be updated using the web interface.\"\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--default-theme',",
            "        '--defaulttheme',",
            "        help='define the default theme. Either: default, blue, orange or custom. Define a default set of colors and font for the web interface. Also read more about link-color, navbar-cloor and font-family.',",
            "        choices=['default', 'blue', 'orange', 'custom'],",
            "        default='default',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--environment',",
            "        choices=['development', 'production'],",
            "        help='define the type of environment: development, production. This is used to limit the information shown to the user when an error occur.',",
            "        default='production',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-encryption',",
            "        '--emailencryption',",
            "        choices=['none', 'ssl', 'starttls'],",
            "        help='type of encryption to be used when establishing communication with SMTP server. Default: none',",
            "        default='none',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-host',",
            "        '--emailhost',",
            "        metavar='HOST',",
            "        help='SMTP server used to send email in the form <host>:<port>. If the port is not provided, default to standard port 25 or 465 is used. e.g.: smtp.gmail.com:587',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-sender',",
            "        '--emailsender',",
            "        metavar='EMAIL',",
            "        help='email addres used for the `from:` field when sending email.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-notification-time',",
            "        '--emailnotificationtime',",
            "        metavar='TIME',",
            "        help='time when the email notifcation should be sent for inactive backups. e.g.: 22:00 Default value: 23:00',",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-username',",
            "        '--emailusername',",
            "        metavar='USERNAME',",
            "        help='username used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-password',",
            "        '--emailpassword',",
            "        metavar='PASSWORD',",
            "        help='password used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-send-changed-notification',",
            "        '--emailsendchangednotification',",
            "        help='True to send notification when sensitive information get change in user profile.',",
            "        action='store_true',",
            "        default=True,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-favicon',",
            "        '--favicon',",
            "        dest='favicon',",
            "        help='location of an icon to be used as a favicon displayed in web browser.',",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-name',",
            "        '--footername',",
            "        help=argparse.SUPPRESS,",
            "        default='rdiffweb',",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-url',",
            "        '--footerurl',",
            "        help=argparse.SUPPRESS,",
            "        default='https://rdiffweb.org/',",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--brand-logo',",
            "        '--logo',",
            "        dest='logo',",
            "        help='location of an image (preferably a .svg) to be used as a replacement for the rdiffweb logo displayed in Login page.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-header-logo',",
            "        '--header-logo',",
            "        '--headerlogo',",
            "        dest='header_logo',",
            "        help='location of an image (preferably a .svg) to be used as a replacement for the rdiffweb header logo displayed in navigation bar.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-header-name',",
            "        '--header-name',",
            "        '--headername',",
            "        dest='header_name',",
            "        help='application name displayed in the title bar and header menu.',",
            "        default='Rdiffweb',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-link-color',",
            "        '--link-color',",
            "        type=css_color,",
            "        dest='link_color',",
            "        help='define a CSS color to be used for link. e.g.: ff0000',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-btn-bg-color',",
            "        '--btn-bg-color',",
            "        type=css_color,",
            "        dest='btn_bg_color',",
            "        help=\"define a CSS color to be used for button's background. Default to `link-color` if undefined\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-btn-fg-color',",
            "        '--btn-fg-color',",
            "        type=css_color,",
            "        dest='btn_fg_color',",
            "        help=\"define a CSS color to be used for button's text. Default to white if undefined\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-btn-rounded',",
            "        '--btn-rounded',",
            "        type=bool,",
            "        dest='btn_rounded',",
            "        help='define if the button should be rounded',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-navbar-color',",
            "        '--navbar-color',",
            "        type=css_color,",
            "        dest='navbar_color',",
            "        help='define a CSS color to be used for navigation bar background e.g.: 00ff00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-font-family',",
            "        '--font-family',",
            "        type=css_font,",
            "        dest='font_family',",
            "        help='define a CSS font to be used as main font. e.g.: Roboto',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-missing-user',",
            "        '--addmissinguser',",
            "        action='store_true',",
            "        help='enable creation of users from LDAP when the credential are valid.',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-role',",
            "        help='default role used when creating users from LDAP. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='user',",
            "        choices=['admin', 'maintainer', 'user'],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-userroot',",
            "        help='default user root directory used when creating users from LDAP. LDAP attributes may be used to define the default location. e.g.: `/backups/{uid[0]}/`. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-uri',",
            "        '--ldapuri',",
            "        help='URL to the LDAP server used to validate user credentials. e.g.: ldap://localhost:389',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-base-dn',",
            "        '--ldapbasedn',",
            "        metavar='DN',",
            "        help='DN of the branch of the directory where all searches should start from. e.g.: dc=my,dc=domain',",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-scope',",
            "        '--ldapscope',",
            "        help='scope of the search. Can be either base, onelevel or subtree',",
            "        choices=['base', 'onelevel', 'subtree'],",
            "        default=\"subtree\",",
            "    )",
            "",
            "    parser.add_argument('--ldap-tls', '--ldaptls', action='store_true', help='enable TLS')",
            "",
            "    parser.add_argument(",
            "        '--ldap-username-attribute',",
            "        '--ldapattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"The attribute to search username. If no attributes are provided, the default is to use `uid`. It's a good idea to choose an attribute that will be unique across all entries in the subtree you will be using.\",",
            "        default='uid',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-filter',",
            "        '--ldapfilter',",
            "        help=\"search filter to limit LDAP lookup. If not provided, defaults to (objectClass=*), which searches for all objects in the tree.\",",
            "        default='(objectClass=*)',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-required-group',",
            "        '--ldaprequiredgroup',",
            "        metavar='GROUPNAME',",
            "        help=\"name of the group of which the user must be a member to access rdiffweb. Should be used with ldap-group-attribute and ldap-group-attribute-is-dn.\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute',",
            "        '--ldapgroupattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"name of the attribute defining the groups of which the user is a member. Should be used with ldap-required-group and ldap-group-attribute-is-dn.\",",
            "        default='member',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute-is-dn',",
            "        '--ldapgroupattributeisdn',",
            "        help=\"True if the content of the attribute `ldap-group-attribute` is a DN.\",",
            "        action='store_true',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-dn',",
            "        '--ldapbinddn',",
            "        metavar='DN',",
            "        help=\"optional DN used to bind to the server when searching for entries. If not provided, will use an anonymous bind.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-password',",
            "        '--ldapbindpassword',",
            "        metavar='PASSWORD',",
            "        help=\"password to use in conjunction with LdapBindDn. Note that the bind password is probably sensitive data, and should be properly protected. You should only use the LdapBindDn and LdapBindPassword if you absolutely need them to search the directory.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-version',",
            "        '--ldapversion',",
            "        '--ldapprotocolversion',",
            "        help=\"version of LDAP in use either 2 or 3. Default to 3.\",",
            "        default=3,",
            "        type=int,",
            "        choices=[2, 3],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-network-timeout',",
            "        '--ldapnetworktimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP connection\",",
            "        default=100,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-timeout',",
            "        '--ldaptimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP request\",",
            "        default=300,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-encoding',",
            "        '--ldapencoding',",
            "        metavar='ENCODING',",
            "        help=\"encoding used by your LDAP server.\",",
            "        default=\"utf-8\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-access-file', '--logaccessfile', metavar='FILE', help='location of Rdiffweb log access file.'",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-file',",
            "        '--logfile',",
            "        metavar='FILE',",
            "        help='location of Rdiffweb log file. Print log to the console if not define in config file.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-level',",
            "        '--loglevel',",
            "        help='Define the log level.',",
            "        choices=['ERROR', 'WARN', 'INFO', 'DEBUG'],",
            "        default='INFO',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--max-depth',",
            "        '--maxdepth',",
            "        metavar='DEPTH',",
            "        help=\"define the maximum folder depthness to search into the user's root directory to find repositories. This is commonly used if you repositories are organised with multiple sub-folder.\",",
            "        type=int,",
            "        default=3,",
            "    )",
            "",
            "    parser.add('--quota-set-cmd', '--quotasetcmd', metavar='COMMAND', help=\"command line to set the user's quota.\")",
            "",
            "    parser.add('--quota-get-cmd', '--quotagetcmd', metavar='COMMAND', help=\"command line to get the user's quota.\")",
            "",
            "    parser.add(",
            "        '--quota-used-cmd', '--quotausedcmd', metavar='COMMAND', help=\"Command line to get user's quota disk usage.\"",
            "    )",
            "",
            "    parser.add(",
            "        '--remove-older-time',",
            "        '--removeoldertime',",
            "        metavar='TIME',",
            "        help=\"Time when to execute the remove older scheduled job. e.g.: 22:30\",",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add('--server-host', '--serverhost', metavar='IP', default='127.0.0.1', help='IP address to listen to')",
            "",
            "    parser.add(",
            "        '--server-port',",
            "        '--serverport',",
            "        metavar='PORT',",
            "        help='port to listen to for HTTP request',",
            "        default='8080',",
            "        type=int,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit-dir',",
            "        '--session-dir',",
            "        '--sessiondir',",
            "        metavar='FOLDER',",
            "        help='location where to store rate-limit information. When undefined, the data is kept in memory. `--session-dir` are deprecated and kept for backward compatibility.',",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit',",
            "        metavar='LIMIT',",
            "        type=int,",
            "        default=20,",
            "        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API.',",
            "    )",
            "",
            "    parser.add(",
            "        '--session-idle-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the amount of time a session will remain active in case there is no activity in the session. User Session will be revoke after this period of inactivity, unless the user selected \"remember me\". Default 5 minutes.',",
            "        default=5,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-absolute-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time a session can be active. After this period, user is forced to (re)authenticate, unless the user selected \"remember me\". Default 20 minutes.',",
            "        default=20,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-persistent-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time to remember and trust a user device. This timeout is used when user select \"remember me\". Default 30 days.',",
            "        default=43200,",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-certificate',",
            "        '--sslcertificate',",
            "        metavar='CERT',",
            "        help='location of the SSL Certification to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-private-key',",
            "        '--sslprivatekey',",
            "        metavar='KEY',",
            "        help='location of the SSL Private Key to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--tempdir',",
            "        metavar='FOLDER',",
            "        help='alternate temporary folder to be used when restoring files. Might be useful if the default location has limited disk space. Default to TEMPDIR environment or `/tmp`.',",
            "    )",
            "",
            "    parser.add(",
            "        '--disable-ssh-keys',",
            "        action='store_true',",
            "        help='used to hide SSH Key management to avoid users to add or remove SSH Key using the web application',",
            "        default=False,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-min-length',",
            "        type=int,",
            "        help=\"Minimum length of the user's password\",",
            "        default=8,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-max-length',",
            "        type=int,",
            "        help=\"Maximum length of the user's password\",",
            "        default=128,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-score',",
            "        type=lambda x: max(1, min(int(x), 4)),",
            "        help=\"Minimum zxcvbn's score for password. Value from 1 to 4. Default value 2. Read more about it here: https://github.com/dropbox/zxcvbn\",",
            "        default=2,",
            "    )",
            "",
            "    parser.add_argument('--version', action='version', version='%(prog)s ' + VERSION)",
            "",
            "    # Here we append a list of arguments for each locale.",
            "    flags = ['--welcome-msg'] + ['--welcome-msg-' + i for i in ['ca', 'en', 'es', 'fr', 'ru']] + ['--welcomemsg']",
            "    parser.add_argument(",
            "        *flags,",
            "        metavar='HTML',",
            "        help='replace the welcome message displayed in the login page for default locale or for a specific locale',",
            "        action=LocaleAction",
            "    )",
            "    return parser",
            "",
            "",
            "def parse_args(args=None, config_file_contents=None):",
            "    args = sys.argv[1:] if args is None else args",
            "    return get_parser().parse_args(args, config_file_contents=config_file_contents)",
            "",
            "",
            "class LocaleAction(argparse.Action):",
            "    \"\"\"",
            "    Custom Action to support defining arguments with locale.",
            "    \"\"\"",
            "",
            "    def __init__(self, option_strings, dest, nargs=None, **kwargs):",
            "        super(LocaleAction, self).__init__(option_strings, dest, **kwargs)",
            "",
            "    def __call__(self, parser, namespace, value, option_string=None):",
            "        if option_string[-3] == '-':",
            "            # When using arguments, we can extract the locale from the argument key",
            "            locale = option_string[-2:]",
            "        elif value[2] == ':':",
            "            # When using config file, the locale could be extract from the value e.g. fr:message",
            "            locale = value[0:2]",
            "            value = value[3:]",
            "        else:",
            "            locale = ''",
            "        # Create a dictionary with locale.",
            "        items = getattr(namespace, self.dest) or {}",
            "        items[locale] = value",
            "        setattr(namespace, self.dest, items)",
            "",
            "",
            "class ConfigFileParser(object):",
            "    \"\"\"",
            "    Custom config file parser to support rdiffweb config file format.",
            "    \"\"\"",
            "",
            "    def get_syntax_description(self):",
            "        msg = \"Configuration file syntax allows: key=value, flag=true.\"",
            "        return msg",
            "",
            "    def parse(self, stream):",
            "        \"\"\"",
            "        Used to read the rdiffweb config file as dict.",
            "        \"\"\"",
            "",
            "        result = OrderedDict()",
            "",
            "        for i, line in enumerate(stream):",
            "            line = re.compile(\"(.*?)#.*\").sub(r'\\1', line).strip()",
            "            if not line:",
            "                continue",
            "            if '=' not in line:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "            split_line = line.partition('=')",
            "            if len(split_line) != 3:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "",
            "            # Get key & value",
            "            key = split_line[0].lower().strip().replace('_', '-')",
            "            value = split_line[2].strip()",
            "",
            "            # Support welcome-msg locale for backward compatibility",
            "            m = re.match(\"welcome-?msg\\\\[(ca|en|es|fr|ru)\\\\]\", key.lower())",
            "            if m:",
            "                key = \"welcome-msg-\" + m.group(1)",
            "                value = m.group(1) + \":\" + value",
            "",
            "            result[key] = value",
            "",
            "        # This dictionary is read by cherrypy. So create appropriate structure.",
            "        return result",
            "",
            "",
            "class Option(object):",
            "    def __init__(self, key):",
            "        assert key",
            "        self.key = key",
            "",
            "    def __get__(self, instance, owner):",
            "        \"\"\"",
            "        Return a property to wrap the given option.",
            "        \"\"\"",
            "        return self.get(instance)",
            "",
            "    def get(self, instance=None):",
            "        \"\"\"",
            "        Return the value of this options.",
            "        \"\"\"",
            "        if isinstance(instance, Application):",
            "            app = instance",
            "        else:",
            "            app = cherrypy.request.app or getattr(instance, 'app', None)",
            "        assert app, \"Option() can't get reference to app\"",
            "        assert app.cfg, \"Option() can't get reference to app.cfg\"",
            "        return getattr(app.cfg, self.key)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import argparse",
            "import logging",
            "import re",
            "import sys",
            "from collections import OrderedDict",
            "",
            "import cherrypy",
            "import configargparse",
            "import pkg_resources",
            "from cherrypy import Application",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "# Get rdiffweb version.",
            "try:",
            "    VERSION = pkg_resources.get_distribution(\"rdiffweb\").version",
            "except pkg_resources.DistributionNotFound:",
            "    VERSION = \"DEV\"",
            "",
            "",
            "def css_color(value):",
            "    if not re.match('^#?(?:[0-9a-fA-F]{3}){1,2}$', value):",
            "        raise argparse.ArgumentTypeError(\"invalid CSS Color\")",
            "    if value.startswith('#'):",
            "        return value",
            "    return '#' + value",
            "",
            "",
            "def css_font(value):",
            "    if not re.match('^[a-zA-Z0-9 ]+$', value):",
            "        raise argparse.ArgumentTypeError(\"invalid CSS Font name\")",
            "    return value",
            "",
            "",
            "def get_parser():",
            "    # Get global config argument parser",
            "    parser = configargparse.ArgumentParser(",
            "        prog='rdiffweb',",
            "        description='Web interface to browse and restore rdiff-backup repositories.',",
            "        default_config_files=['/etc/rdiffweb/rdw.conf', '/etc/rdiffweb/rdw.conf.d/*.conf'],",
            "        add_env_var_help=True,",
            "        auto_env_var_prefix='RDIFFWEB_',",
            "        config_file_parser_class=ConfigFileParser,",
            "        conflict_handler='resolve',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-f', '--config', is_config_file=True, metavar='FILE', help='location of Rdiffweb configuration file'",
            "    )",
            "",
            "    parser.add(",
            "        '--database-uri',",
            "        '--sqlitedb-file',",
            "        '--sqlitedbfile',",
            "        metavar='URI',",
            "        help=\"\"\"Location of the database used for persistence. SQLite and PostgreSQL",
            "            database are supported officially. To use a SQLite database you may",
            "            define the location using a file path or a URI.",
            "            e.g.: /srv/rdiffweb/file.db or sqlite:///srv/rdiffweb/file.db`.",
            "            To use PostgreSQL server you must provide",
            "            a URI similar to postgresql://user:pass@10.255.1.34/dbname and you",
            "            must install required dependencies.",
            "            By default, Rdiffweb uses a SQLite embedded database located at",
            "            /etc/rdiffweb/rdw.db.\"\"\",",
            "        default='/etc/rdiffweb/rdw.db',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '-d',",
            "        '--debug',",
            "        action='store_true',",
            "        help='enable rdiffweb debug mode - change the log level to DEBUG, print exception stack trace to the web interface and show SQL query in logs',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-user',",
            "        '--adminuser',",
            "        metavar='USERNAME',",
            "        help='administrator username. The administrator user get created on startup if the database is empty.',",
            "        default='admin',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--admin-password',",
            "        metavar='USERNAME',",
            "        help=\"\"\"administrator encrypted password as SSHA. Read online",
            "            documentation to know more about how to encrypt your password",
            "            into SSHA or use http://projects.marsching.org/weave4j/util/genpassword.php",
            "            When defined, administrator password cannot be updated using the web interface.",
            "            When undefined, default administrator password is `admin123` and",
            "            it can be updated using the web interface.\"\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--default-theme',",
            "        '--defaulttheme',",
            "        help='define the default theme. Either: default, blue, orange or custom. Define a default set of colors and font for the web interface. Also read more about link-color, navbar-cloor and font-family.',",
            "        choices=['default', 'blue', 'orange', 'custom'],",
            "        default='default',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--environment',",
            "        choices=['development', 'production'],",
            "        help='define the type of environment: development, production. This is used to limit the information shown to the user when an error occur.',",
            "        default='production',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-encryption',",
            "        '--emailencryption',",
            "        choices=['none', 'ssl', 'starttls'],",
            "        help='type of encryption to be used when establishing communication with SMTP server. Default: none',",
            "        default='none',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-host',",
            "        '--emailhost',",
            "        metavar='HOST',",
            "        help='SMTP server used to send email in the form <host>:<port>. If the port is not provided, default to standard port 25 or 465 is used. e.g.: smtp.gmail.com:587',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-sender',",
            "        '--emailsender',",
            "        metavar='EMAIL',",
            "        help='email addres used for the `from:` field when sending email.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-notification-time',",
            "        '--emailnotificationtime',",
            "        metavar='TIME',",
            "        help='time when the email notifcation should be sent for inactive backups. e.g.: 22:00 Default value: 23:00',",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-username',",
            "        '--emailusername',",
            "        metavar='USERNAME',",
            "        help='username used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-password',",
            "        '--emailpassword',",
            "        metavar='PASSWORD',",
            "        help='password used for authentication with the SMTP server.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--email-send-changed-notification',",
            "        '--emailsendchangednotification',",
            "        help='True to send notification when sensitive information get change in user profile.',",
            "        action='store_true',",
            "        default=True,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-favicon',",
            "        '--favicon',",
            "        dest='favicon',",
            "        help='location of an icon to be used as a favicon displayed in web browser.',",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-name',",
            "        '--footername',",
            "        help=argparse.SUPPRESS,",
            "        default='rdiffweb',",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--footer-url',",
            "        '--footerurl',",
            "        help=argparse.SUPPRESS,",
            "        default='https://rdiffweb.org/',",
            "    )  # @UndefinedVariable",
            "",
            "    parser.add_argument(",
            "        '--brand-logo',",
            "        '--logo',",
            "        dest='logo',",
            "        help='location of an image (preferably a .svg) to be used as a replacement for the rdiffweb logo displayed in Login page.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-header-logo',",
            "        '--header-logo',",
            "        '--headerlogo',",
            "        dest='header_logo',",
            "        help='location of an image (preferably a .svg) to be used as a replacement for the rdiffweb header logo displayed in navigation bar.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-header-name',",
            "        '--header-name',",
            "        '--headername',",
            "        dest='header_name',",
            "        help='application name displayed in the title bar and header menu.',",
            "        default='Rdiffweb',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-link-color',",
            "        '--link-color',",
            "        type=css_color,",
            "        dest='link_color',",
            "        help='define a CSS color to be used for link. e.g.: ff0000',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-btn-bg-color',",
            "        '--btn-bg-color',",
            "        type=css_color,",
            "        dest='btn_bg_color',",
            "        help=\"define a CSS color to be used for button's background. Default to `link-color` if undefined\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-btn-fg-color',",
            "        '--btn-fg-color',",
            "        type=css_color,",
            "        dest='btn_fg_color',",
            "        help=\"define a CSS color to be used for button's text. Default to white if undefined\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-btn-rounded',",
            "        '--btn-rounded',",
            "        type=bool,",
            "        dest='btn_rounded',",
            "        help='define if the button should be rounded',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-navbar-color',",
            "        '--navbar-color',",
            "        type=css_color,",
            "        dest='navbar_color',",
            "        help='define a CSS color to be used for navigation bar background e.g.: 00ff00',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--brand-font-family',",
            "        '--font-family',",
            "        type=css_font,",
            "        dest='font_family',",
            "        help='define a CSS font to be used as main font. e.g.: Roboto',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-missing-user',",
            "        '--addmissinguser',",
            "        action='store_true',",
            "        help='enable creation of users from LDAP when the credential are valid.',",
            "        default=False,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-role',",
            "        help='default role used when creating users from LDAP. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='user',",
            "        choices=['admin', 'maintainer', 'user'],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-add-user-default-userroot',",
            "        help='default user root directory used when creating users from LDAP. LDAP attributes may be used to define the default location. e.g.: `/backups/{uid[0]}/`. This parameter is only useful when `--ldap-add-missing-user` is enabled.',",
            "        default='',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-uri',",
            "        '--ldapuri',",
            "        help='URL to the LDAP server used to validate user credentials. e.g.: ldap://localhost:389',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-base-dn',",
            "        '--ldapbasedn',",
            "        metavar='DN',",
            "        help='DN of the branch of the directory where all searches should start from. e.g.: dc=my,dc=domain',",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-scope',",
            "        '--ldapscope',",
            "        help='scope of the search. Can be either base, onelevel or subtree',",
            "        choices=['base', 'onelevel', 'subtree'],",
            "        default=\"subtree\",",
            "    )",
            "",
            "    parser.add_argument('--ldap-tls', '--ldaptls', action='store_true', help='enable TLS')",
            "",
            "    parser.add_argument(",
            "        '--ldap-username-attribute',",
            "        '--ldapattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"The attribute to search username. If no attributes are provided, the default is to use `uid`. It's a good idea to choose an attribute that will be unique across all entries in the subtree you will be using.\",",
            "        default='uid',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-filter',",
            "        '--ldapfilter',",
            "        help=\"search filter to limit LDAP lookup. If not provided, defaults to (objectClass=*), which searches for all objects in the tree.\",",
            "        default='(objectClass=*)',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-required-group',",
            "        '--ldaprequiredgroup',",
            "        metavar='GROUPNAME',",
            "        help=\"name of the group of which the user must be a member to access rdiffweb. Should be used with ldap-group-attribute and ldap-group-attribute-is-dn.\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute',",
            "        '--ldapgroupattribute',",
            "        metavar='ATTRIBUTE',",
            "        help=\"name of the attribute defining the groups of which the user is a member. Should be used with ldap-required-group and ldap-group-attribute-is-dn.\",",
            "        default='member',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-group-attribute-is-dn',",
            "        '--ldapgroupattributeisdn',",
            "        help=\"True if the content of the attribute `ldap-group-attribute` is a DN.\",",
            "        action='store_true',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-dn',",
            "        '--ldapbinddn',",
            "        metavar='DN',",
            "        help=\"optional DN used to bind to the server when searching for entries. If not provided, will use an anonymous bind.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-bind-password',",
            "        '--ldapbindpassword',",
            "        metavar='PASSWORD',",
            "        help=\"password to use in conjunction with LdapBindDn. Note that the bind password is probably sensitive data, and should be properly protected. You should only use the LdapBindDn and LdapBindPassword if you absolutely need them to search the directory.\",",
            "        default=\"\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-version',",
            "        '--ldapversion',",
            "        '--ldapprotocolversion',",
            "        help=\"version of LDAP in use either 2 or 3. Default to 3.\",",
            "        default=3,",
            "        type=int,",
            "        choices=[2, 3],",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-network-timeout',",
            "        '--ldapnetworktimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP connection\",",
            "        default=100,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-timeout',",
            "        '--ldaptimeout',",
            "        metavar='SECONDS',",
            "        help=\"timeout in seconds value used for LDAP request\",",
            "        default=300,",
            "        type=int,",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--ldap-encoding',",
            "        '--ldapencoding',",
            "        metavar='ENCODING',",
            "        help=\"encoding used by your LDAP server.\",",
            "        default=\"utf-8\",",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-access-file', '--logaccessfile', metavar='FILE', help='location of Rdiffweb log access file.'",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-file',",
            "        '--logfile',",
            "        metavar='FILE',",
            "        help='location of Rdiffweb log file. Print log to the console if not define in config file.',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--log-level',",
            "        '--loglevel',",
            "        help='Define the log level.',",
            "        choices=['ERROR', 'WARN', 'INFO', 'DEBUG'],",
            "        default='INFO',",
            "    )",
            "",
            "    parser.add_argument(",
            "        '--max-depth',",
            "        '--maxdepth',",
            "        metavar='DEPTH',",
            "        help=\"define the maximum folder depthness to search into the user's root directory to find repositories. This is commonly used if you repositories are organised with multiple sub-folder.\",",
            "        type=int,",
            "        default=3,",
            "    )",
            "",
            "    parser.add('--quota-set-cmd', '--quotasetcmd', metavar='COMMAND', help=\"command line to set the user's quota.\")",
            "",
            "    parser.add('--quota-get-cmd', '--quotagetcmd', metavar='COMMAND', help=\"command line to get the user's quota.\")",
            "",
            "    parser.add(",
            "        '--quota-used-cmd', '--quotausedcmd', metavar='COMMAND', help=\"Command line to get user's quota disk usage.\"",
            "    )",
            "",
            "    parser.add(",
            "        '--remove-older-time',",
            "        '--removeoldertime',",
            "        metavar='TIME',",
            "        help=\"Time when to execute the remove older scheduled job. e.g.: 22:30\",",
            "        default='23:00',",
            "    )",
            "",
            "    parser.add('--server-host', '--serverhost', metavar='IP', default='127.0.0.1', help='IP address to listen to')",
            "",
            "    parser.add(",
            "        '--server-port',",
            "        '--serverport',",
            "        metavar='PORT',",
            "        help='port to listen to for HTTP request',",
            "        default='8080',",
            "        type=int,",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit-dir',",
            "        '--session-dir',",
            "        '--sessiondir',",
            "        metavar='FOLDER',",
            "        help='location where to store rate-limit information. When undefined, the data is kept in memory. `--session-dir` are deprecated and kept for backward compatibility.',",
            "    )",
            "",
            "    parser.add(",
            "        '--rate-limit',",
            "        metavar='LIMIT',",
            "        type=int,",
            "        default=20,",
            "        help='maximum number of requests per hour that can be made on sensitive endpoints. When this limit is reached, an HTTP 429 message is returned to the user or the user is logged out. This security measure is used to limit brute force attacks on the login page and the RESTful API. default: 20 requests / hour',",
            "    )",
            "",
            "    parser.add(",
            "        '--session-idle-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the amount of time a session will remain active in case there is no activity in the session. User Session will be revoke after this period of inactivity, unless the user selected \"remember me\". Default 5 minutes.',",
            "        default=5,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-absolute-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time a session can be active. After this period, user is forced to (re)authenticate, unless the user selected \"remember me\". Default 20 minutes.',",
            "        default=20,",
            "    )",
            "",
            "    parser.add(",
            "        '--session-persistent-timeout',",
            "        metavar='MINUTES',",
            "        help='This timeout defines the maximum amount of time to remember and trust a user device. This timeout is used when user select \"remember me\". Default 30 days.',",
            "        default=43200,",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-certificate',",
            "        '--sslcertificate',",
            "        metavar='CERT',",
            "        help='location of the SSL Certification to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--ssl-private-key',",
            "        '--sslprivatekey',",
            "        metavar='KEY',",
            "        help='location of the SSL Private Key to enable HTTPS (not recommended)',",
            "    )",
            "",
            "    parser.add(",
            "        '--tempdir',",
            "        metavar='FOLDER',",
            "        help='alternate temporary folder to be used when restoring files. Might be useful if the default location has limited disk space. Default to TEMPDIR environment or `/tmp`.',",
            "    )",
            "",
            "    parser.add(",
            "        '--disable-ssh-keys',",
            "        action='store_true',",
            "        help='used to hide SSH Key management to avoid users to add or remove SSH Key using the web application',",
            "        default=False,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-min-length',",
            "        type=int,",
            "        help=\"Minimum length of the user's password\",",
            "        default=8,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-max-length',",
            "        type=int,",
            "        help=\"Maximum length of the user's password\",",
            "        default=128,",
            "    )",
            "",
            "    parser.add(",
            "        '--password-score',",
            "        type=lambda x: max(1, min(int(x), 4)),",
            "        help=\"Minimum zxcvbn's score for password. Value from 1 to 4. Default value 2. Read more about it here: https://github.com/dropbox/zxcvbn\",",
            "        default=2,",
            "    )",
            "",
            "    parser.add_argument('--version', action='version', version='%(prog)s ' + VERSION)",
            "",
            "    # Here we append a list of arguments for each locale.",
            "    flags = ['--welcome-msg'] + ['--welcome-msg-' + i for i in ['ca', 'en', 'es', 'fr', 'ru']] + ['--welcomemsg']",
            "    parser.add_argument(",
            "        *flags,",
            "        metavar='HTML',",
            "        help='replace the welcome message displayed in the login page for default locale or for a specific locale',",
            "        action=LocaleAction",
            "    )",
            "    return parser",
            "",
            "",
            "def parse_args(args=None, config_file_contents=None):",
            "    args = sys.argv[1:] if args is None else args",
            "    return get_parser().parse_args(args, config_file_contents=config_file_contents)",
            "",
            "",
            "class LocaleAction(argparse.Action):",
            "    \"\"\"",
            "    Custom Action to support defining arguments with locale.",
            "    \"\"\"",
            "",
            "    def __init__(self, option_strings, dest, nargs=None, **kwargs):",
            "        super(LocaleAction, self).__init__(option_strings, dest, **kwargs)",
            "",
            "    def __call__(self, parser, namespace, value, option_string=None):",
            "        if option_string[-3] == '-':",
            "            # When using arguments, we can extract the locale from the argument key",
            "            locale = option_string[-2:]",
            "        elif value[2] == ':':",
            "            # When using config file, the locale could be extract from the value e.g. fr:message",
            "            locale = value[0:2]",
            "            value = value[3:]",
            "        else:",
            "            locale = ''",
            "        # Create a dictionary with locale.",
            "        items = getattr(namespace, self.dest) or {}",
            "        items[locale] = value",
            "        setattr(namespace, self.dest, items)",
            "",
            "",
            "class ConfigFileParser(object):",
            "    \"\"\"",
            "    Custom config file parser to support rdiffweb config file format.",
            "    \"\"\"",
            "",
            "    def get_syntax_description(self):",
            "        msg = \"Configuration file syntax allows: key=value, flag=true.\"",
            "        return msg",
            "",
            "    def parse(self, stream):",
            "        \"\"\"",
            "        Used to read the rdiffweb config file as dict.",
            "        \"\"\"",
            "",
            "        result = OrderedDict()",
            "",
            "        for i, line in enumerate(stream):",
            "            line = re.compile(\"(.*?)#.*\").sub(r'\\1', line).strip()",
            "            if not line:",
            "                continue",
            "            if '=' not in line:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "            split_line = line.partition('=')",
            "            if len(split_line) != 3:",
            "                raise configargparse.ConfigFileParserException(",
            "                    \"Unexpected line {} in {}: {}\".format(i, getattr(stream, 'name', 'stream'), line)",
            "                )",
            "",
            "            # Get key & value",
            "            key = split_line[0].lower().strip().replace('_', '-')",
            "            value = split_line[2].strip()",
            "",
            "            # Support welcome-msg locale for backward compatibility",
            "            m = re.match(\"welcome-?msg\\\\[(ca|en|es|fr|ru)\\\\]\", key.lower())",
            "            if m:",
            "                key = \"welcome-msg-\" + m.group(1)",
            "                value = m.group(1) + \":\" + value",
            "",
            "            result[key] = value",
            "",
            "        # This dictionary is read by cherrypy. So create appropriate structure.",
            "        return result",
            "",
            "",
            "class Option(object):",
            "    def __init__(self, key):",
            "        assert key",
            "        self.key = key",
            "",
            "    def __get__(self, instance, owner):",
            "        \"\"\"",
            "        Return a property to wrap the given option.",
            "        \"\"\"",
            "        return self.get(instance)",
            "",
            "    def get(self, instance=None):",
            "        \"\"\"",
            "        Return the value of this options.",
            "        \"\"\"",
            "        if isinstance(instance, Application):",
            "            app = instance",
            "        else:",
            "            app = cherrypy.request.app or getattr(instance, 'app', None)",
            "        assert app, \"Option() can't get reference to app\"",
            "        assert app.cfg, \"Option() can't get reference to app.cfg\"",
            "        return getattr(app.cfg, self.key)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "474": [
                "get_parser"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/tools/ratelimit.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 150,
                "PatchRowcode": "         cherrypy.request.app._ratelimit_datastore = datastore"
            },
            "1": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 151,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 152,
                "afterPatchRowNumber": 152,
                "PatchRowcode": "     # If user is authenticated, use the username else use the ip address"
            },
            "3": {
                "beforePatchRowNumber": 153,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    token = (request.login or request.remote.ip) + '.' + (scope or request.path_info)"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+    identifier = request.remote.ip"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+    if hasattr(cherrypy.serving, 'session') and cherrypy.serving.session.get('_cp_username', None):"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+        identifier = cherrypy.serving.session.get('_cp_username', None)"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+    token = identifier + '.' + (scope or request.path_info)"
            },
            "8": {
                "beforePatchRowNumber": 154,
                "afterPatchRowNumber": 157,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 155,
                "afterPatchRowNumber": 158,
                "PatchRowcode": "     # Get hits count using datastore."
            },
            "10": {
                "beforePatchRowNumber": 156,
                "afterPatchRowNumber": 159,
                "PatchRowcode": "     hits = datastore.get_and_increment(token, delay, hit)"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# udb, A web interface to manage IT network",
            "# Copyright (C) 2022 IKUS Software inc.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import os",
            "import pickle",
            "import threading",
            "import time",
            "from collections import namedtuple",
            "",
            "import cherrypy",
            "",
            "Tracker = namedtuple('Tracker', ['token', 'hits', 'timeout'])",
            "",
            "",
            "class _DataStore:",
            "    \"\"\"",
            "    Base class for rate limit data store",
            "    \"\"\"",
            "",
            "    def __init__(self, **kwargs):",
            "        self._locks = {}",
            "",
            "    def get_and_increment(self, token, delay, hit=1):",
            "        lock = self._locks.setdefault(token, threading.RLock())",
            "        with lock:",
            "            tracker = self._load(token)",
            "            if tracker is None or tracker.timeout < time.time():",
            "                tracker = Tracker(token=token, hits=0, timeout=int(time.time() + delay))",
            "            tracker = tracker._replace(hits=tracker.hits + hit)",
            "            self._save(tracker)",
            "        return tracker.hits",
            "",
            "    def _save(self, tracker):",
            "        raise NotImplementedError",
            "",
            "    def _load(self, token):",
            "        raise NotImplementedError",
            "",
            "",
            "class RamRateLimit(_DataStore):",
            "    \"\"\"",
            "    Store rate limit information in memory.",
            "    \"\"\"",
            "",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        self._data = {}",
            "",
            "    def _load(self, token):",
            "        return self._data.get(token, None)",
            "",
            "    def _save(self, tracker):",
            "        self._data[tracker.token] = tracker",
            "",
            "",
            "class FileRateLimit(_DataStore):",
            "    \"\"\"",
            "    Store rate limit information in files.",
            "    \"\"\"",
            "",
            "    PREFIX = 'ratelimit-'",
            "    pickle_protocol = pickle.HIGHEST_PROTOCOL",
            "",
            "    def __init__(self, storage_path, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # The 'storage_path' arg is required for file-based datastore.",
            "        assert (",
            "            storage_path",
            "        ), 'FileRateLimit required a storage_path `tools.ratelimit.storage_path = \"/home/site/ratelimit\"`'",
            "        self.storage_path = os.path.abspath(storage_path)",
            "",
            "    def _path(self, token):",
            "        assert token",
            "        f = os.path.join(self.storage_path, self.PREFIX + token.strip('/').replace('/', '-'))",
            "        if not os.path.abspath(f).startswith(self.storage_path):",
            "            raise ValueError('invalid token')",
            "        return f",
            "",
            "    def _load(self, token):",
            "        path = self._path(token)",
            "        try:",
            "            f = open(path, 'rb')",
            "            try:",
            "                return pickle.load(f)",
            "            finally:",
            "                f.close()",
            "        except Exception:",
            "            # Drop session data if invalid",
            "            pass",
            "        return None",
            "",
            "    def _save(self, tracker):",
            "        path = self._path(tracker.token)",
            "        f = open(path, 'wb')",
            "        try:",
            "            pickle.dump(tracker, f, self.pickle_protocol)",
            "        finally:",
            "            f.close()",
            "",
            "",
            "def check_ratelimit(",
            "    delay=3600, limit=25, return_status=429, logout=False, scope=None, methods=None, debug=False, hit=1, **conf",
            "):",
            "    \"\"\"",
            "    Verify the ratelimit. By default return a 429 HTTP error code (Too Many Request). After 25 request within the same hour.",
            "",
            "    Arguments:",
            "        delay:         Time window for analysis in seconds. Default per hour (3600 seconds)",
            "        limit:         Number of request allowed for an entry point. Default 25",
            "        return_status: HTTP Error code to return.",
            "        logout:        True to logout user when limit is reached",
            "        scope:         if specify, define the scope of rate limit. Default to path_info.",
            "        methods:       if specify, only the methods in the list will be rate limited.",
            "    \"\"\"",
            "    assert delay > 0, 'invalid delay'",
            "",
            "    # Check if limit is enabled",
            "    if limit <= 0:",
            "        return",
            "",
            "    # Check if this 'method' should be rate limited",
            "    request = cherrypy.request",
            "    if methods is not None and request.method not in methods:",
            "        if debug:",
            "            cherrypy.log(",
            "                'skip rate limit for HTTP method %s' % (request.method,),",
            "                'TOOLS.RATELIMIT',",
            "            )",
            "        return",
            "",
            "    # If datastore is not pass as configuration, create it for the first time.",
            "    datastore = getattr(cherrypy.request.app, '_ratelimit_datastore', None)",
            "    if datastore is None:",
            "        # Create storage using storage class",
            "        storage_class = conf.get('storage_class', RamRateLimit)",
            "        datastore = storage_class(**conf)",
            "        cherrypy.request.app._ratelimit_datastore = datastore",
            "",
            "    # If user is authenticated, use the username else use the ip address",
            "    token = (request.login or request.remote.ip) + '.' + (scope or request.path_info)",
            "",
            "    # Get hits count using datastore.",
            "    hits = datastore.get_and_increment(token, delay, hit)",
            "    if debug:",
            "        cherrypy.log(",
            "            'check and increase rate limit for scope %s, limit %s, hits %s' % (token, limit, hits), 'TOOLS.RATELIMIT'",
            "        )",
            "",
            "    # Verify user has not exceeded rate limit",
            "    if limit <= hits:",
            "        if logout:",
            "            if hasattr(cherrypy.serving, 'session'):",
            "                cherrypy.serving.session.clear()",
            "            raise cherrypy.HTTPRedirect(\"/\")",
            "",
            "        raise cherrypy.HTTPError(return_status)",
            "",
            "",
            "def hit(hit=1):",
            "    \"\"\"",
            "    May be called directly by handlers to add a hit for the given request.",
            "    \"\"\"",
            "    conf = cherrypy.tools.ratelimit._merged_args()",
            "    conf['hit'] = hit",
            "    cherrypy.tools.ratelimit.callable(**conf)",
            "",
            "",
            "cherrypy.tools.ratelimit = cherrypy.Tool('before_handler', check_ratelimit, priority=60)",
            "",
            "",
            "cherrypy.tools.ratelimit.hit = hit"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# udb, A web interface to manage IT network",
            "# Copyright (C) 2022 IKUS Software inc.",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "import os",
            "import pickle",
            "import threading",
            "import time",
            "from collections import namedtuple",
            "",
            "import cherrypy",
            "",
            "Tracker = namedtuple('Tracker', ['token', 'hits', 'timeout'])",
            "",
            "",
            "class _DataStore:",
            "    \"\"\"",
            "    Base class for rate limit data store",
            "    \"\"\"",
            "",
            "    def __init__(self, **kwargs):",
            "        self._locks = {}",
            "",
            "    def get_and_increment(self, token, delay, hit=1):",
            "        lock = self._locks.setdefault(token, threading.RLock())",
            "        with lock:",
            "            tracker = self._load(token)",
            "            if tracker is None or tracker.timeout < time.time():",
            "                tracker = Tracker(token=token, hits=0, timeout=int(time.time() + delay))",
            "            tracker = tracker._replace(hits=tracker.hits + hit)",
            "            self._save(tracker)",
            "        return tracker.hits",
            "",
            "    def _save(self, tracker):",
            "        raise NotImplementedError",
            "",
            "    def _load(self, token):",
            "        raise NotImplementedError",
            "",
            "",
            "class RamRateLimit(_DataStore):",
            "    \"\"\"",
            "    Store rate limit information in memory.",
            "    \"\"\"",
            "",
            "    def __init__(self, **kwargs):",
            "        super().__init__(**kwargs)",
            "        self._data = {}",
            "",
            "    def _load(self, token):",
            "        return self._data.get(token, None)",
            "",
            "    def _save(self, tracker):",
            "        self._data[tracker.token] = tracker",
            "",
            "",
            "class FileRateLimit(_DataStore):",
            "    \"\"\"",
            "    Store rate limit information in files.",
            "    \"\"\"",
            "",
            "    PREFIX = 'ratelimit-'",
            "    pickle_protocol = pickle.HIGHEST_PROTOCOL",
            "",
            "    def __init__(self, storage_path, **kwargs):",
            "        super().__init__(**kwargs)",
            "        # The 'storage_path' arg is required for file-based datastore.",
            "        assert (",
            "            storage_path",
            "        ), 'FileRateLimit required a storage_path `tools.ratelimit.storage_path = \"/home/site/ratelimit\"`'",
            "        self.storage_path = os.path.abspath(storage_path)",
            "",
            "    def _path(self, token):",
            "        assert token",
            "        f = os.path.join(self.storage_path, self.PREFIX + token.strip('/').replace('/', '-'))",
            "        if not os.path.abspath(f).startswith(self.storage_path):",
            "            raise ValueError('invalid token')",
            "        return f",
            "",
            "    def _load(self, token):",
            "        path = self._path(token)",
            "        try:",
            "            f = open(path, 'rb')",
            "            try:",
            "                return pickle.load(f)",
            "            finally:",
            "                f.close()",
            "        except Exception:",
            "            # Drop session data if invalid",
            "            pass",
            "        return None",
            "",
            "    def _save(self, tracker):",
            "        path = self._path(tracker.token)",
            "        f = open(path, 'wb')",
            "        try:",
            "            pickle.dump(tracker, f, self.pickle_protocol)",
            "        finally:",
            "            f.close()",
            "",
            "",
            "def check_ratelimit(",
            "    delay=3600, limit=25, return_status=429, logout=False, scope=None, methods=None, debug=False, hit=1, **conf",
            "):",
            "    \"\"\"",
            "    Verify the ratelimit. By default return a 429 HTTP error code (Too Many Request). After 25 request within the same hour.",
            "",
            "    Arguments:",
            "        delay:         Time window for analysis in seconds. Default per hour (3600 seconds)",
            "        limit:         Number of request allowed for an entry point. Default 25",
            "        return_status: HTTP Error code to return.",
            "        logout:        True to logout user when limit is reached",
            "        scope:         if specify, define the scope of rate limit. Default to path_info.",
            "        methods:       if specify, only the methods in the list will be rate limited.",
            "    \"\"\"",
            "    assert delay > 0, 'invalid delay'",
            "",
            "    # Check if limit is enabled",
            "    if limit <= 0:",
            "        return",
            "",
            "    # Check if this 'method' should be rate limited",
            "    request = cherrypy.request",
            "    if methods is not None and request.method not in methods:",
            "        if debug:",
            "            cherrypy.log(",
            "                'skip rate limit for HTTP method %s' % (request.method,),",
            "                'TOOLS.RATELIMIT',",
            "            )",
            "        return",
            "",
            "    # If datastore is not pass as configuration, create it for the first time.",
            "    datastore = getattr(cherrypy.request.app, '_ratelimit_datastore', None)",
            "    if datastore is None:",
            "        # Create storage using storage class",
            "        storage_class = conf.get('storage_class', RamRateLimit)",
            "        datastore = storage_class(**conf)",
            "        cherrypy.request.app._ratelimit_datastore = datastore",
            "",
            "    # If user is authenticated, use the username else use the ip address",
            "    identifier = request.remote.ip",
            "    if hasattr(cherrypy.serving, 'session') and cherrypy.serving.session.get('_cp_username', None):",
            "        identifier = cherrypy.serving.session.get('_cp_username', None)",
            "    token = identifier + '.' + (scope or request.path_info)",
            "",
            "    # Get hits count using datastore.",
            "    hits = datastore.get_and_increment(token, delay, hit)",
            "    if debug:",
            "        cherrypy.log(",
            "            'check and increase rate limit for scope %s, limit %s, hits %s' % (token, limit, hits), 'TOOLS.RATELIMIT'",
            "        )",
            "",
            "    # Verify user has not exceeded rate limit",
            "    if limit <= hits:",
            "        if logout:",
            "            if hasattr(cherrypy.serving, 'session'):",
            "                cherrypy.serving.session.clear()",
            "            raise cherrypy.HTTPRedirect(\"/\")",
            "",
            "        raise cherrypy.HTTPError(return_status)",
            "",
            "",
            "def hit(hit=1):",
            "    \"\"\"",
            "    May be called directly by handlers to add a hit for the given request.",
            "    \"\"\"",
            "    conf = cherrypy.tools.ratelimit._merged_args()",
            "    conf['hit'] = hit",
            "    cherrypy.tools.ratelimit.callable(**conf)",
            "",
            "",
            "cherrypy.tools.ratelimit = cherrypy.Tool('before_handler', check_ratelimit, priority=60)",
            "",
            "",
            "cherrypy.tools.ratelimit.hit = hit"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "153": [
                "check_ratelimit"
            ]
        },
        "addLocation": []
    }
}