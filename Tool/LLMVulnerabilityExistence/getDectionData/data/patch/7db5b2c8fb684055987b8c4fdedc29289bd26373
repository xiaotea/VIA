{
    "Products/CMFPlone/URLTool.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1,
                "PatchRowcode": "+from HTMLParser import HTMLParser"
            },
            "1": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " from Products.CMFCore.URLTool import URLTool as BaseTool"
            },
            "2": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " from Products.CMFCore.utils import getToolByName"
            },
            "3": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " from AccessControl import ClassSecurityInfo"
            },
            "4": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " import re"
            },
            "5": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 13,
                "PatchRowcode": "+hp = HTMLParser()"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+# These schemas are allowed in full urls to consider them in the portal:"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+# A mailto schema is an obvious sign of a url that is not in the portal."
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 16,
                "PatchRowcode": "+# This is a whitelist."
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 17,
                "PatchRowcode": "+ALLOWED_SCHEMAS = ["
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 18,
                "PatchRowcode": "+    'https',"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+    'http',"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 20,
                "PatchRowcode": "+]"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 21,
                "PatchRowcode": "+# These bad parts are not allowed in urls that are in the portal:"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 22,
                "PatchRowcode": "+# This is a blacklist."
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 23,
                "PatchRowcode": "+BAD_URL_PARTS = ["
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+    '\\\\\\\\',"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+    '<script',"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 26,
                "PatchRowcode": "+    '%3cscript',"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 27,
                "PatchRowcode": "+    'javascript:',"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 28,
                "PatchRowcode": "+    'javascript%3a',"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+]"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 32,
                "PatchRowcode": " class URLTool(PloneBaseTool, BaseTool):"
            },
            "27": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 33,
                "PatchRowcode": " "
            },
            "28": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "     meta_type = 'Plone URL Tool'"
            },
            "29": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         # sanitize url"
            },
            "30": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 52,
                "PatchRowcode": "         url = re.sub('^[\\x00-\\x20]+', '', url).strip()"
            },
            "31": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "         cmp_url = url.lower()"
            },
            "32": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if ('\\\\\\\\' in cmp_url or"
            },
            "33": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                '<script' in cmp_url or"
            },
            "34": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                '%3cscript' in cmp_url or"
            },
            "35": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                'javascript:' in cmp_url or"
            },
            "36": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                'javascript%3a' in cmp_url):"
            },
            "37": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            return False"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+        for bad in BAD_URL_PARTS:"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 55,
                "PatchRowcode": "+            if bad in cmp_url:"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 56,
                "PatchRowcode": "+                return False"
            },
            "41": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 57,
                "PatchRowcode": " "
            },
            "42": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 58,
                "PatchRowcode": "         p_url = self()"
            },
            "43": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 59,
                "PatchRowcode": " "
            },
            "44": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        _, u_host, u_path, _, _, _ = urlparse(url)"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+        schema, u_host, u_path, _, _, _ = urlparse(url)"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 61,
                "PatchRowcode": "+        if schema and schema not in ALLOWED_SCHEMAS:"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 62,
                "PatchRowcode": "+            # Redirecting to 'data:' may be harmful,"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 63,
                "PatchRowcode": "+            # and redirecting to 'mailto:' or 'ftp:' is silly."
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+            return False"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 65,
                "PatchRowcode": "+"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 66,
                "PatchRowcode": "+        # Someone may be doing tricks with escaped html code."
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+        unescaped_url = hp.unescape(url)"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+        if unescaped_url != url:"
            },
            "54": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 69,
                "PatchRowcode": "+            if not self.isURLInPortal(unescaped_url):"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+                return False"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+"
            },
            "57": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "         if not u_host and not u_path.startswith('/'):"
            },
            "58": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "             if context is None:"
            },
            "59": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "                 return True  # old behavior"
            }
        },
        "frontPatchFile": [
            "from Products.CMFCore.URLTool import URLTool as BaseTool",
            "from Products.CMFCore.utils import getToolByName",
            "from AccessControl import ClassSecurityInfo",
            "from App.class_init import InitializeClass",
            "from Products.CMFPlone.PloneBaseTool import PloneBaseTool",
            "",
            "from posixpath import normpath",
            "from urlparse import urlparse, urljoin",
            "import re",
            "",
            "",
            "class URLTool(PloneBaseTool, BaseTool):",
            "",
            "    meta_type = 'Plone URL Tool'",
            "    security = ClassSecurityInfo()",
            "    toolicon = 'skins/plone_images/link_icon.png'",
            "",
            "    security.declarePublic('isURLInPortal')",
            "    def isURLInPortal(self, url, context=None):",
            "        # Check if a given url is on the same host and contains the portal",
            "        # path.  Used to ensure that login forms can determine relevant",
            "        # referrers (i.e. in portal).  Also return true for some relative",
            "        # urls if context is passed in to allow for url parsing. When context",
            "        # is not provided, assume that relative urls are in the portal. It is",
            "        # assumed that http://portal is the same portal as https://portal.",
            "",
            "        # External sites listed in 'allow_external_login_sites' of",
            "        # site_properties are also considered within the portal to allow for",
            "        # single sign on.",
            "",
            "        # sanitize url",
            "        url = re.sub('^[\\x00-\\x20]+', '', url).strip()",
            "        cmp_url = url.lower()",
            "        if ('\\\\\\\\' in cmp_url or",
            "                '<script' in cmp_url or",
            "                '%3cscript' in cmp_url or",
            "                'javascript:' in cmp_url or",
            "                'javascript%3a' in cmp_url):",
            "            return False",
            "",
            "        p_url = self()",
            "",
            "        _, u_host, u_path, _, _, _ = urlparse(url)",
            "        if not u_host and not u_path.startswith('/'):",
            "            if context is None:",
            "                return True  # old behavior",
            "            if not context.isPrincipiaFolderish:",
            "                useurl = context.aq_parent.absolute_url()",
            "            else:",
            "                useurl = context.absolute_url()",
            "        else:",
            "            useurl = p_url  # when u_path.startswith('/')",
            "        if not useurl.endswith('/'):",
            "            useurl += '/'",
            "",
            "        # urljoin to current url to get an absolute path",
            "        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))",
            "",
            "        # normalise to end with a '/' so /foobar is not considered within /foo",
            "        if not u_path:",
            "            u_path = '/'",
            "        else:",
            "            u_path = normpath(u_path)",
            "            if not u_path.endswith('/'):",
            "                u_path += '/'",
            "        _, host, path, _, _, _ = urlparse(p_url)",
            "        if not path.endswith('/'):",
            "            path += '/'",
            "        if host == u_host and u_path.startswith(path):",
            "            return True",
            "",
            "        props = getToolByName(self, 'portal_properties').site_properties",
            "        for external_site in props.getProperty('allow_external_login_sites', []):",
            "            _, host, path, _, _, _ = urlparse(external_site)",
            "            if not path.endswith('/'):",
            "                path += '/'",
            "            if host == u_host and u_path.startswith(path):",
            "                return True",
            "        return False",
            "",
            "",
            "URLTool.__doc__ = BaseTool.__doc__",
            "",
            "InitializeClass(URLTool)"
        ],
        "afterPatchFile": [
            "from HTMLParser import HTMLParser",
            "from Products.CMFCore.URLTool import URLTool as BaseTool",
            "from Products.CMFCore.utils import getToolByName",
            "from AccessControl import ClassSecurityInfo",
            "from App.class_init import InitializeClass",
            "from Products.CMFPlone.PloneBaseTool import PloneBaseTool",
            "",
            "from posixpath import normpath",
            "from urlparse import urlparse, urljoin",
            "import re",
            "",
            "",
            "hp = HTMLParser()",
            "# These schemas are allowed in full urls to consider them in the portal:",
            "# A mailto schema is an obvious sign of a url that is not in the portal.",
            "# This is a whitelist.",
            "ALLOWED_SCHEMAS = [",
            "    'https',",
            "    'http',",
            "]",
            "# These bad parts are not allowed in urls that are in the portal:",
            "# This is a blacklist.",
            "BAD_URL_PARTS = [",
            "    '\\\\\\\\',",
            "    '<script',",
            "    '%3cscript',",
            "    'javascript:',",
            "    'javascript%3a',",
            "]",
            "",
            "",
            "class URLTool(PloneBaseTool, BaseTool):",
            "",
            "    meta_type = 'Plone URL Tool'",
            "    security = ClassSecurityInfo()",
            "    toolicon = 'skins/plone_images/link_icon.png'",
            "",
            "    security.declarePublic('isURLInPortal')",
            "    def isURLInPortal(self, url, context=None):",
            "        # Check if a given url is on the same host and contains the portal",
            "        # path.  Used to ensure that login forms can determine relevant",
            "        # referrers (i.e. in portal).  Also return true for some relative",
            "        # urls if context is passed in to allow for url parsing. When context",
            "        # is not provided, assume that relative urls are in the portal. It is",
            "        # assumed that http://portal is the same portal as https://portal.",
            "",
            "        # External sites listed in 'allow_external_login_sites' of",
            "        # site_properties are also considered within the portal to allow for",
            "        # single sign on.",
            "",
            "        # sanitize url",
            "        url = re.sub('^[\\x00-\\x20]+', '', url).strip()",
            "        cmp_url = url.lower()",
            "        for bad in BAD_URL_PARTS:",
            "            if bad in cmp_url:",
            "                return False",
            "",
            "        p_url = self()",
            "",
            "        schema, u_host, u_path, _, _, _ = urlparse(url)",
            "        if schema and schema not in ALLOWED_SCHEMAS:",
            "            # Redirecting to 'data:' may be harmful,",
            "            # and redirecting to 'mailto:' or 'ftp:' is silly.",
            "            return False",
            "",
            "        # Someone may be doing tricks with escaped html code.",
            "        unescaped_url = hp.unescape(url)",
            "        if unescaped_url != url:",
            "            if not self.isURLInPortal(unescaped_url):",
            "                return False",
            "",
            "        if not u_host and not u_path.startswith('/'):",
            "            if context is None:",
            "                return True  # old behavior",
            "            if not context.isPrincipiaFolderish:",
            "                useurl = context.aq_parent.absolute_url()",
            "            else:",
            "                useurl = context.absolute_url()",
            "        else:",
            "            useurl = p_url  # when u_path.startswith('/')",
            "        if not useurl.endswith('/'):",
            "            useurl += '/'",
            "",
            "        # urljoin to current url to get an absolute path",
            "        _, u_host, u_path, _, _, _ = urlparse(urljoin(useurl, url))",
            "",
            "        # normalise to end with a '/' so /foobar is not considered within /foo",
            "        if not u_path:",
            "            u_path = '/'",
            "        else:",
            "            u_path = normpath(u_path)",
            "            if not u_path.endswith('/'):",
            "                u_path += '/'",
            "        _, host, path, _, _, _ = urlparse(p_url)",
            "        if not path.endswith('/'):",
            "            path += '/'",
            "        if host == u_host and u_path.startswith(path):",
            "            return True",
            "",
            "        props = getToolByName(self, 'portal_properties').site_properties",
            "        for external_site in props.getProperty('allow_external_login_sites', []):",
            "            _, host, path, _, _, _ = urlparse(external_site)",
            "            if not path.endswith('/'):",
            "                path += '/'",
            "            if host == u_host and u_path.startswith(path):",
            "                return True",
            "        return False",
            "",
            "",
            "URLTool.__doc__ = BaseTool.__doc__",
            "",
            "InitializeClass(URLTool)"
        ],
        "action": [
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "34": [
                "URLTool",
                "isURLInPortal"
            ],
            "35": [
                "URLTool",
                "isURLInPortal"
            ],
            "36": [
                "URLTool",
                "isURLInPortal"
            ],
            "37": [
                "URLTool",
                "isURLInPortal"
            ],
            "38": [
                "URLTool",
                "isURLInPortal"
            ],
            "39": [
                "URLTool",
                "isURLInPortal"
            ],
            "43": [
                "URLTool",
                "isURLInPortal"
            ]
        },
        "addLocation": []
    },
    "Products/CMFPlone/tests/testURLTool.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 124,
                "PatchRowcode": "         url_tool = self._makeOne()"
            },
            "1": {
                "beforePatchRowNumber": 125,
                "afterPatchRowNumber": 125,
                "PatchRowcode": "         iURLiP = url_tool.isURLInPortal"
            },
            "2": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 126,
                "PatchRowcode": "         self.assertFalse(iURLiP('\\\\\\\\www.example.com'))"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 127,
                "PatchRowcode": "+"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 128,
                "PatchRowcode": "+    def test_regression_absolute_url_in_portal(self):"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 129,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 130,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 131,
                "PatchRowcode": "+        self.assertTrue(iURLiP(url_tool()))"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 132,
                "PatchRowcode": "+        self.assertTrue(iURLiP(url_tool() + '/shrubbery?knights=ni#ekki-ekki'))"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 133,
                "PatchRowcode": "+"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 134,
                "PatchRowcode": "+    def test_mailto_simple_not_in_portal(self):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 135,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+            'mailto:someone@example.org')"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 139,
                "PatchRowcode": "+        )"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 140,
                "PatchRowcode": "+"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 141,
                "PatchRowcode": "+    def test_mailto_complex_not_in_portal(self):"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 142,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 143,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+            'mailto&#58;192&#46;168&#46;163&#46;154&#58;8080&#47;Plone&apos;'"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 146,
                "PatchRowcode": "+            '&quot;&gt;&lt;html&gt;&lt;svg&#32;onload&#61;alert&#40;document'"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 147,
                "PatchRowcode": "+            '&#46;domain&#41;&gt;&lt;&#47;html&gt;')"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 148,
                "PatchRowcode": "+        )"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 149,
                "PatchRowcode": "+"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 150,
                "PatchRowcode": "+    def test_data_not_in_portal(self):"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 151,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 152,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 153,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 154,
                "PatchRowcode": "+            'data:text/html%3bbase64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K')"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 155,
                "PatchRowcode": "+        )"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 156,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 157,
                "PatchRowcode": "+    def test_double_slash(self):"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 158,
                "PatchRowcode": "+        # I wondered if this might be a problem after reading"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 159,
                "PatchRowcode": "+        # https://bugs.python.org/issue23505"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 160,
                "PatchRowcode": "+        # Apparently not, but let's test it."
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 161,
                "PatchRowcode": "+        url_tool = self._makeOne()"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 162,
                "PatchRowcode": "+        iURLiP = url_tool.isURLInPortal"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 163,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+            '//www.google.com'))"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+        self.assertFalse(iURLiP("
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 166,
                "PatchRowcode": "+            '////www.google.com'))"
            }
        },
        "frontPatchFile": [
            "import unittest",
            "",
            "from Products.CMFCore.tests.base.dummy import DummySite",
            "from Products.CMFCore.tests.base.dummy import DummyFolder",
            "from Products.CMFCore.tests.base.dummy import DummyContent",
            "",
            "from Acquisition import aq_parent",
            "",
            "",
            "class DummyFolder(DummyFolder):",
            "    def absolute_url(self):",
            "        return '/'.join([aq_parent(self).absolute_url(), self.getId()])",
            "",
            "",
            "class DummyProperties(DummyContent):",
            "",
            "    _allow_external_login_sites = [",
            "        'http://external1',",
            "        'http://external2/',",
            "        'http://external3/site',",
            "        'http://external4/site/'",
            "        ]",
            "",
            "    def getProperty(self, name, default=None):",
            "        if name == 'allow_external_login_sites':",
            "            return self._allow_external_login_sites",
            "        return default",
            "",
            "",
            "class TestURLTool(unittest.TestCase):",
            "",
            "    def setUp(self):",
            "        self.site = DummySite(id='foo')",
            "        self.site._setObject('foo', DummyFolder(id='foo'))",
            "        self.site.foo._setObject('doc1', DummyContent(id='doc1'))",
            "        self.site.portal_properties = DummyProperties(id='portal_properties')",
            "        self.site.portal_properties.site_properties = \\",
            "            DummyProperties(id='site_properties')",
            "",
            "    def _makeOne(self, *args, **kw):",
            "        from Products.CMFPlone.URLTool import URLTool",
            "        url_tool = URLTool(*args, **kw)",
            "        return url_tool.__of__(self.site)",
            "",
            "    def test_isURLInPortal(self):",
            "        # First test what the absolute url of the site is, otherwise these",
            "        # tests look really weird.  Apparently our domain is www.foobar.com.",
            "        self.assertEqual(self.site.absolute_url(),",
            "                         'http://www.foobar.com/bar/foo')",
            "",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))",
            "        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar'))",
            "        self.assertFalse(iURLiP('/images'))",
            "        self.assertTrue(iURLiP('/bar/foo/foo'))",
            "",
            "    def test_isURLInPortalRelative(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "",
            "        #non-root relative urls will need a current context to be passed in",
            "        self.assertTrue(iURLiP('images/img1.jpg'))",
            "        self.assertTrue(iURLiP('./images/img1.jpg'))",
            "",
            "        # /bar/foo/something",
            "        self.assertTrue(iURLiP('../something', self.site.foo.doc1))",
            "        # /bar/afolder",
            "        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))",
            "        # /afolder",
            "        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))",
            "",
            "        # /../afolder? How do we have more ../'s than there are parts in",
            "        # the URL?",
            "        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))",
            "",
            "        # /bar/foo/afolder",
            "        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))",
            "",
            "    def test_isURLInPortalExternal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://external1'))",
            "        self.assertTrue(iURLiP('http://external1/'))",
            "        self.assertTrue(iURLiP('http://external1/something'))",
            "        self.assertTrue(iURLiP('http://external2'))",
            "        self.assertTrue(iURLiP('http://external2/'))",
            "        self.assertTrue(iURLiP('http://external2/something'))",
            "        self.assertTrue(iURLiP('http://external3/site'))",
            "        self.assertTrue(iURLiP('http://external3/site/'))",
            "        self.assertTrue(iURLiP('http://external3/site/something'))",
            "        self.assertTrue(iURLiP('http://external4/site'))",
            "        self.assertTrue(iURLiP('http://external4/site/'))",
            "        self.assertTrue(iURLiP('http://external4/site/something'))",
            "",
            "        self.assertFalse(iURLiP('http://external3/other'))",
            "        self.assertFalse(iURLiP('http://external4/other'))",
            "        self.assertFalse(iURLiP('http://external5'))",
            "        self.assertFalse(iURLiP('http://external11'))",
            "",
            "    def test_script_tag_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('<script>alert(\"hi\");</script>'))",
            "        self.assertFalse(iURLiP('<sCript>alert(\"hi\");</script>'))",
            "        self.assertFalse(",
            "            iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "        self.assertFalse(",
            "            iURLiP('%3CsCript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "",
            "    def test_inline_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('javascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('javascript:alert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript:alert(3)'))",
            "",
            "    def test_double_back_slash(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('\\\\\\\\www.example.com'))"
        ],
        "afterPatchFile": [
            "import unittest",
            "",
            "from Products.CMFCore.tests.base.dummy import DummySite",
            "from Products.CMFCore.tests.base.dummy import DummyFolder",
            "from Products.CMFCore.tests.base.dummy import DummyContent",
            "",
            "from Acquisition import aq_parent",
            "",
            "",
            "class DummyFolder(DummyFolder):",
            "    def absolute_url(self):",
            "        return '/'.join([aq_parent(self).absolute_url(), self.getId()])",
            "",
            "",
            "class DummyProperties(DummyContent):",
            "",
            "    _allow_external_login_sites = [",
            "        'http://external1',",
            "        'http://external2/',",
            "        'http://external3/site',",
            "        'http://external4/site/'",
            "        ]",
            "",
            "    def getProperty(self, name, default=None):",
            "        if name == 'allow_external_login_sites':",
            "            return self._allow_external_login_sites",
            "        return default",
            "",
            "",
            "class TestURLTool(unittest.TestCase):",
            "",
            "    def setUp(self):",
            "        self.site = DummySite(id='foo')",
            "        self.site._setObject('foo', DummyFolder(id='foo'))",
            "        self.site.foo._setObject('doc1', DummyContent(id='doc1'))",
            "        self.site.portal_properties = DummyProperties(id='portal_properties')",
            "        self.site.portal_properties.site_properties = \\",
            "            DummyProperties(id='site_properties')",
            "",
            "    def _makeOne(self, *args, **kw):",
            "        from Products.CMFPlone.URLTool import URLTool",
            "        url_tool = URLTool(*args, **kw)",
            "        return url_tool.__of__(self.site)",
            "",
            "    def test_isURLInPortal(self):",
            "        # First test what the absolute url of the site is, otherwise these",
            "        # tests look really weird.  Apparently our domain is www.foobar.com.",
            "        self.assertEqual(self.site.absolute_url(),",
            "                         'http://www.foobar.com/bar/foo')",
            "",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))",
            "        self.assertTrue(iURLiP('http://www.foobar.com/bar/foo'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar2/foo'))",
            "        self.assertTrue(iURLiP('https://www.foobar.com/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com:8080/bar/foo/folder'))",
            "        self.assertFalse(iURLiP('http://www.foobar.com/bar'))",
            "        self.assertFalse(iURLiP('/images'))",
            "        self.assertTrue(iURLiP('/bar/foo/foo'))",
            "",
            "    def test_isURLInPortalRelative(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "",
            "        #non-root relative urls will need a current context to be passed in",
            "        self.assertTrue(iURLiP('images/img1.jpg'))",
            "        self.assertTrue(iURLiP('./images/img1.jpg'))",
            "",
            "        # /bar/foo/something",
            "        self.assertTrue(iURLiP('../something', self.site.foo.doc1))",
            "        # /bar/afolder",
            "        self.assertFalse(iURLiP('../../afolder', self.site.foo.doc1))",
            "        # /afolder",
            "        self.assertFalse(iURLiP('../../../afolder', self.site.foo.doc1))",
            "",
            "        # /../afolder? How do we have more ../'s than there are parts in",
            "        # the URL?",
            "        self.assertFalse(iURLiP('../../../../afolder', self.site.foo.doc1))",
            "",
            "        # /bar/foo/afolder",
            "        self.assertTrue(iURLiP('../../foo/afolder', self.site.foo.doc1))",
            "",
            "    def test_isURLInPortalExternal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP('http://external1'))",
            "        self.assertTrue(iURLiP('http://external1/'))",
            "        self.assertTrue(iURLiP('http://external1/something'))",
            "        self.assertTrue(iURLiP('http://external2'))",
            "        self.assertTrue(iURLiP('http://external2/'))",
            "        self.assertTrue(iURLiP('http://external2/something'))",
            "        self.assertTrue(iURLiP('http://external3/site'))",
            "        self.assertTrue(iURLiP('http://external3/site/'))",
            "        self.assertTrue(iURLiP('http://external3/site/something'))",
            "        self.assertTrue(iURLiP('http://external4/site'))",
            "        self.assertTrue(iURLiP('http://external4/site/'))",
            "        self.assertTrue(iURLiP('http://external4/site/something'))",
            "",
            "        self.assertFalse(iURLiP('http://external3/other'))",
            "        self.assertFalse(iURLiP('http://external4/other'))",
            "        self.assertFalse(iURLiP('http://external5'))",
            "        self.assertFalse(iURLiP('http://external11'))",
            "",
            "    def test_script_tag_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('<script>alert(\"hi\");</script>'))",
            "        self.assertFalse(iURLiP('<sCript>alert(\"hi\");</script>'))",
            "        self.assertFalse(",
            "            iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "        self.assertFalse(",
            "            iURLiP('%3CsCript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))",
            "",
            "    def test_inline_url_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('javascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript%3Aalert(3)'))",
            "        self.assertFalse(iURLiP('javascript:alert(3)'))",
            "        self.assertFalse(iURLiP('jaVascript:alert(3)'))",
            "",
            "    def test_double_back_slash(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP('\\\\\\\\www.example.com'))",
            "",
            "    def test_regression_absolute_url_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertTrue(iURLiP(url_tool()))",
            "        self.assertTrue(iURLiP(url_tool() + '/shrubbery?knights=ni#ekki-ekki'))",
            "",
            "    def test_mailto_simple_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            'mailto:someone@example.org')",
            "        )",
            "",
            "    def test_mailto_complex_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            'mailto&#58;192&#46;168&#46;163&#46;154&#58;8080&#47;Plone&apos;'",
            "            '&quot;&gt;&lt;html&gt;&lt;svg&#32;onload&#61;alert&#40;document'",
            "            '&#46;domain&#41;&gt;&lt;&#47;html&gt;')",
            "        )",
            "",
            "    def test_data_not_in_portal(self):",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            'data:text/html%3bbase64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K')",
            "        )",
            "",
            "    def test_double_slash(self):",
            "        # I wondered if this might be a problem after reading",
            "        # https://bugs.python.org/issue23505",
            "        # Apparently not, but let's test it.",
            "        url_tool = self._makeOne()",
            "        iURLiP = url_tool.isURLInPortal",
            "        self.assertFalse(iURLiP(",
            "            '//www.google.com'))",
            "        self.assertFalse(iURLiP(",
            "            '////www.google.com'))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "Products.CMFPlone.tests.testURLTool.TestURLTool.self",
            "bikeshed.cli.handleRefs"
        ]
    }
}