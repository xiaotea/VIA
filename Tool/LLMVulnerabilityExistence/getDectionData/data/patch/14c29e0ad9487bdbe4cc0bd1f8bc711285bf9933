{
    "modoboa_dmarc/lib.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 1,
                "afterPatchRowNumber": 1,
                "PatchRowcode": " \"\"\"Internal library.\"\"\""
            },
            "1": {
                "beforePatchRowNumber": 2,
                "afterPatchRowNumber": 2,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 3,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from __future__ import print_function"
            },
            "3": {
                "beforePatchRowNumber": 4,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "4": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 3,
                "PatchRowcode": " import datetime"
            },
            "5": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 4,
                "PatchRowcode": " import email"
            },
            "6": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import fileinput"
            },
            "7": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " import gzip"
            },
            "8": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " import sys"
            },
            "9": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 11,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from lxml import objectify"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 12,
                "PatchRowcode": "+from defusedxml.ElementTree import fromstring"
            },
            "12": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " import pytz.exceptions"
            },
            "13": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 14,
                "PatchRowcode": " import six"
            },
            "14": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 15,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 34,
                "PatchRowcode": " def import_record(xml_node, report):"
            },
            "16": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "     \"\"\"Import a record.\"\"\""
            },
            "17": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "     record = models.Record(report=report)"
            },
            "18": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    record.source_ip = xml_node.row.source_ip"
            },
            "19": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    record.count = int(xml_node.row.count)"
            },
            "20": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "21": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    record.disposition = xml_node.row.policy_evaluated.disposition"
            },
            "22": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    record.dkim_result = xml_node.row.policy_evaluated.dkim"
            },
            "23": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    record.spf_result = xml_node.row.policy_evaluated.spf"
            },
            "24": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if hasattr(xml_node.row.policy_evaluated, \"reason\"):"
            },
            "25": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        record.reason_type = smart_text("
            },
            "26": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            xml_node.row.policy_evaluated.reason.type)[:14]"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+    row = xml_node.find(\"row\")"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+    record.source_ip = row.find(\"source_ip\").text"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+    record.count = int(row.find(\"count\").text)"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    policy_evaluated = row.find(\"policy_evaluated\")"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+    record.disposition = policy_evaluated.find(\"disposition\").text"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+    record.dkim_result = policy_evaluated.find(\"dkim\").text"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+    record.spf_result = policy_evaluated.find(\"spf\").text"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+    reason = policy_evaluated.find(\"reason\")"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+    if reason:"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 47,
                "PatchRowcode": "+        record.reason_type = smart_text(reason.find(\"type\").text)[:14]"
            },
            "38": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "         if record.reason_type not in constants.ALLOWED_REASON_TYPES:"
            },
            "39": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "             record.reason_type = \"other\""
            },
            "40": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        record.reason_comment = xml_node.row.policy_evaluated.reason.comment"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 50,
                "PatchRowcode": "+        comment = reason.find(\"comment\").text or \"\""
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 51,
                "PatchRowcode": "+        record.reason_comment = comment"
            },
            "43": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 52,
                "PatchRowcode": " "
            },
            "44": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    header_from = xml_node.identifiers.header_from.text.split(\".\")"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 53,
                "PatchRowcode": "+    identifiers = xml_node.find(\"identifiers\")"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+    header_from = identifiers.find(\"header_from\").text.split(\".\")"
            },
            "47": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "     domain = None"
            },
            "48": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "     while len(header_from) >= 2:"
            },
            "49": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 57,
                "PatchRowcode": "         domain = admin_models.Domain.objects.filter("
            },
            "50": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "         return None"
            },
            "51": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 66,
                "PatchRowcode": " "
            },
            "52": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 67,
                "PatchRowcode": "     record.save()"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 68,
                "PatchRowcode": "+    auth_results = xml_node.find(\"auth_results\")"
            },
            "54": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "     for rtype in [\"spf\", \"dkim\"]:"
            },
            "55": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if not hasattr(xml_node.auth_results, rtype):"
            },
            "56": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 70,
                "PatchRowcode": "+        rnode = auth_results.find(rtype)"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 71,
                "PatchRowcode": "+        if not rnode:"
            },
            "58": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "             continue"
            },
            "59": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        rnode = getattr(xml_node.auth_results, rtype)"
            },
            "60": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "         models.Result.objects.create("
            },
            "61": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            record=record, type=rtype, domain=rnode.domain,"
            },
            "62": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            result=rnode.result)"
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+            record=record, type=rtype, domain=rnode.find(\"domain\").text,"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+            result=rnode.find(\"result\").text)"
            },
            "65": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 76,
                "PatchRowcode": " "
            },
            "66": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 77,
                "PatchRowcode": " "
            },
            "67": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 78,
                "PatchRowcode": " @transaction.atomic"
            },
            "68": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": 79,
                "PatchRowcode": " def import_report(content):"
            },
            "69": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "     \"\"\"Import an aggregated report.\"\"\""
            },
            "70": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    feedback = objectify.fromstring(content)"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+    root = fromstring(content, forbid_dtd=True)"
            },
            "72": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+    metadata = root.find(\"report_metadata\")"
            },
            "73": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 83,
                "PatchRowcode": "     print("
            },
            "74": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 84,
                "PatchRowcode": "         \"Importing report {} received from {}\".format("
            },
            "75": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            feedback.report_metadata.report_id,"
            },
            "76": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            feedback.report_metadata.org_name)"
            },
            "77": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+            metadata.find(\"report_id\").text,"
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+            metadata.find(\"org_name\").text)"
            },
            "79": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "     )"
            },
            "80": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "     reporter, created = models.Reporter.objects.get_or_create("
            },
            "81": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        email=feedback.report_metadata.email,"
            },
            "82": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        defaults={\"org_name\": feedback.report_metadata.org_name}"
            },
            "83": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+        email=metadata.find(\"email\").text,"
            },
            "84": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+        defaults={\"org_name\": metadata.find(\"org_name\").text}"
            },
            "85": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "     )"
            },
            "86": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "     qs = models.Report.objects.filter("
            },
            "87": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        reporter=reporter, report_id=feedback.report_metadata.report_id)"
            },
            "88": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        reporter=reporter, report_id=metadata.find(\"report_id\").text)"
            },
            "89": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 94,
                "PatchRowcode": "     if qs.exists():"
            },
            "90": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 95,
                "PatchRowcode": "         print(\"Report already imported.\")"
            },
            "91": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "         return"
            },
            "92": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "     report = models.Report(reporter=reporter)"
            },
            "93": {
                "beforePatchRowNumber": 94,
                "afterPatchRowNumber": 98,
                "PatchRowcode": " "
            },
            "94": {
                "beforePatchRowNumber": 95,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    report.report_id = feedback.report_metadata.report_id"
            },
            "95": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 99,
                "PatchRowcode": "+    report.report_id = metadata.find(\"report_id\").text"
            },
            "96": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 100,
                "PatchRowcode": "+    date_range = metadata.find(\"date_range\")"
            },
            "97": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "     report.start_date = timezone.make_aware("
            },
            "98": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        datetime.datetime.fromtimestamp("
            },
            "99": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            feedback.report_metadata.date_range.begin))"
            },
            "100": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+        datetime.datetime.fromtimestamp(int(date_range.find(\"begin\").text))"
            },
            "101": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 103,
                "PatchRowcode": "+    )"
            },
            "102": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 104,
                "PatchRowcode": "     report.end_date = timezone.make_aware("
            },
            "103": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        datetime.datetime.fromtimestamp("
            },
            "104": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            feedback.report_metadata.date_range.end))"
            },
            "105": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+        datetime.datetime.fromtimestamp(int(date_range.find(\"end\").text))"
            },
            "106": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 106,
                "PatchRowcode": "+    )"
            },
            "107": {
                "beforePatchRowNumber": 102,
                "afterPatchRowNumber": 107,
                "PatchRowcode": " "
            },
            "108": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 108,
                "PatchRowcode": "+    policy_published = root.find(\"policy_published\")"
            },
            "109": {
                "beforePatchRowNumber": 103,
                "afterPatchRowNumber": 109,
                "PatchRowcode": "     for attr in [\"domain\", \"adkim\", \"aspf\", \"p\", \"sp\", \"pct\"]:"
            },
            "110": {
                "beforePatchRowNumber": 104,
                "afterPatchRowNumber": 110,
                "PatchRowcode": "         try:"
            },
            "111": {
                "beforePatchRowNumber": 105,
                "afterPatchRowNumber": 111,
                "PatchRowcode": "             setattr("
            },
            "112": {
                "beforePatchRowNumber": 106,
                "afterPatchRowNumber": 112,
                "PatchRowcode": "                 report, \"policy_{}\".format(attr),"
            },
            "113": {
                "beforePatchRowNumber": 107,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                getattr(feedback.policy_published, attr)"
            },
            "114": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 113,
                "PatchRowcode": "+                policy_published.find(attr).text"
            },
            "115": {
                "beforePatchRowNumber": 108,
                "afterPatchRowNumber": 114,
                "PatchRowcode": "             )"
            },
            "116": {
                "beforePatchRowNumber": 109,
                "afterPatchRowNumber": 115,
                "PatchRowcode": "         except AttributeError:"
            },
            "117": {
                "beforePatchRowNumber": 110,
                "afterPatchRowNumber": 116,
                "PatchRowcode": "             pass"
            },
            "118": {
                "beforePatchRowNumber": 113,
                "afterPatchRowNumber": 119,
                "PatchRowcode": "     except (pytz.exceptions.AmbiguousTimeError):"
            },
            "119": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 120,
                "PatchRowcode": "         print(\"Report skipped because of invalid date.\")"
            },
            "120": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 121,
                "PatchRowcode": "         return"
            },
            "121": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    for record in feedback.record:"
            },
            "122": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 122,
                "PatchRowcode": "+    for record in root.findall(\"record\"):"
            },
            "123": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "         import_record(record, report)"
            },
            "124": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 124,
                "PatchRowcode": " "
            },
            "125": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 125,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "\"\"\"Internal library.\"\"\"",
            "",
            "from __future__ import print_function",
            "",
            "import datetime",
            "import email",
            "import fileinput",
            "import getpass",
            "import imaplib",
            "import zipfile",
            "import gzip",
            "import sys",
            "",
            "from lxml import objectify",
            "import pytz.exceptions",
            "import six",
            "",
            "from django.db import transaction",
            "from django.utils.encoding import smart_text",
            "from django.utils import timezone",
            "",
            "from modoboa.admin import models as admin_models",
            "",
            "from . import constants",
            "from . import models",
            "",
            "ZIP_CONTENT_TYPES = [",
            "    \"application/x-zip-compressed\",",
            "    \"application/x-zip\",",
            "    \"application/zip\",",
            "    \"application/gzip\",",
            "    \"text/xml\",",
            "]",
            "",
            "",
            "def import_record(xml_node, report):",
            "    \"\"\"Import a record.\"\"\"",
            "    record = models.Record(report=report)",
            "    record.source_ip = xml_node.row.source_ip",
            "    record.count = int(xml_node.row.count)",
            "",
            "    record.disposition = xml_node.row.policy_evaluated.disposition",
            "    record.dkim_result = xml_node.row.policy_evaluated.dkim",
            "    record.spf_result = xml_node.row.policy_evaluated.spf",
            "    if hasattr(xml_node.row.policy_evaluated, \"reason\"):",
            "        record.reason_type = smart_text(",
            "            xml_node.row.policy_evaluated.reason.type)[:14]",
            "        if record.reason_type not in constants.ALLOWED_REASON_TYPES:",
            "            record.reason_type = \"other\"",
            "        record.reason_comment = xml_node.row.policy_evaluated.reason.comment",
            "",
            "    header_from = xml_node.identifiers.header_from.text.split(\".\")",
            "    domain = None",
            "    while len(header_from) >= 2:",
            "        domain = admin_models.Domain.objects.filter(",
            "            name=\".\".join(header_from)).first()",
            "        if domain is not None:",
            "            record.header_from = domain",
            "            break",
            "        header_from = header_from[1:]",
            "    if domain is None:",
            "        print(\"Invalid record found (domain not local)\")",
            "        return None",
            "",
            "    record.save()",
            "    for rtype in [\"spf\", \"dkim\"]:",
            "        if not hasattr(xml_node.auth_results, rtype):",
            "            continue",
            "        rnode = getattr(xml_node.auth_results, rtype)",
            "        models.Result.objects.create(",
            "            record=record, type=rtype, domain=rnode.domain,",
            "            result=rnode.result)",
            "",
            "",
            "@transaction.atomic",
            "def import_report(content):",
            "    \"\"\"Import an aggregated report.\"\"\"",
            "    feedback = objectify.fromstring(content)",
            "    print(",
            "        \"Importing report {} received from {}\".format(",
            "            feedback.report_metadata.report_id,",
            "            feedback.report_metadata.org_name)",
            "    )",
            "    reporter, created = models.Reporter.objects.get_or_create(",
            "        email=feedback.report_metadata.email,",
            "        defaults={\"org_name\": feedback.report_metadata.org_name}",
            "    )",
            "    qs = models.Report.objects.filter(",
            "        reporter=reporter, report_id=feedback.report_metadata.report_id)",
            "    if qs.exists():",
            "        print(\"Report already imported.\")",
            "        return",
            "    report = models.Report(reporter=reporter)",
            "",
            "    report.report_id = feedback.report_metadata.report_id",
            "    report.start_date = timezone.make_aware(",
            "        datetime.datetime.fromtimestamp(",
            "            feedback.report_metadata.date_range.begin))",
            "    report.end_date = timezone.make_aware(",
            "        datetime.datetime.fromtimestamp(",
            "            feedback.report_metadata.date_range.end))",
            "",
            "    for attr in [\"domain\", \"adkim\", \"aspf\", \"p\", \"sp\", \"pct\"]:",
            "        try:",
            "            setattr(",
            "                report, \"policy_{}\".format(attr),",
            "                getattr(feedback.policy_published, attr)",
            "            )",
            "        except AttributeError:",
            "            pass",
            "    try:",
            "        report.save()",
            "    except (pytz.exceptions.AmbiguousTimeError):",
            "        print(\"Report skipped because of invalid date.\")",
            "        return",
            "    for record in feedback.record:",
            "        import_record(record, report)",
            "",
            "",
            "def import_archive(archive, content_type=None):",
            "    \"\"\"Import reports contained inside (file pointer)",
            "    - a zip archive,",
            "    - a gzip file,",
            "    - a xml file.",
            "    \"\"\"",
            "    if content_type == \"text/xml\":",
            "        import_report(archive.read())",
            "    elif content_type == \"application/gzip\":",
            "        with gzip.GzipFile(mode=\"r\", fileobj=archive) as zfile:",
            "            import_report(zfile.read())",
            "    else:",
            "        with zipfile.ZipFile(archive, \"r\") as zfile:",
            "            for fname in zfile.namelist():",
            "                import_report(zfile.read(fname))",
            "",
            "",
            "def import_report_from_email(content):",
            "    \"\"\"Import a report from an email.\"\"\"",
            "    if isinstance(content, six.string_types):",
            "        msg = email.message_from_string(content)",
            "    else:",
            "        msg = email.message_from_file(content)",
            "    err = False",
            "    for part in msg.walk():",
            "        if part.get_content_type() not in ZIP_CONTENT_TYPES:",
            "            continue",
            "        try:",
            "            fpo = six.BytesIO(part.get_payload(decode=True))",
            "            import_archive(fpo, content_type=part.get_content_type())",
            "        except (OSError, IOError):",
            "            print('Error: the attachment does not match the mimetype')",
            "            err = True",
            "        else:",
            "            fpo.close()",
            "    if err:",
            "        # Return EX_DATAERR code <data format error> available",
            "        # at sysexits.h file",
            "        # (see http://www.postfix.org/pipe.8.html)",
            "        sys.exit(65)",
            "",
            "",
            "def import_report_from_stdin():",
            "    \"\"\"Parse a report from stdin.\"\"\"",
            "    content = six.StringIO()",
            "    for line in fileinput.input([]):",
            "        content.write(line)",
            "    content.seek(0)",
            "",
            "    if not content:",
            "        return",
            "    import_report_from_email(content)",
            "",
            "",
            "def import_from_imap(options):",
            "    \"\"\"Import reports from an IMAP mailbox.\"\"\"",
            "    obj = imaplib.IMAP4_SSL if options[\"ssl\"] else imaplib.IMAP4",
            "    conn = obj(options[\"host\"])",
            "    username = raw_input(\"Username: \")",
            "    password = getpass.getpass(prompt=\"Password: \")",
            "    conn.login(username, password)",
            "    conn.select(options[\"mailbox\"])",
            "    type, msg_ids = conn.search(None, \"ALL\")",
            "    for msg_id in msg_ids[0].split():",
            "        typ, content = conn.fetch(msg_id, \"(RFC822)\")",
            "        for response_part in content:",
            "            if isinstance(response_part, tuple):",
            "                import_report_from_email(response_part[1])",
            "    conn.close()"
        ],
        "afterPatchFile": [
            "\"\"\"Internal library.\"\"\"",
            "",
            "import datetime",
            "import email",
            "import fileinput",
            "import getpass",
            "import imaplib",
            "import zipfile",
            "import gzip",
            "import sys",
            "",
            "from defusedxml.ElementTree import fromstring",
            "import pytz.exceptions",
            "import six",
            "",
            "from django.db import transaction",
            "from django.utils.encoding import smart_text",
            "from django.utils import timezone",
            "",
            "from modoboa.admin import models as admin_models",
            "",
            "from . import constants",
            "from . import models",
            "",
            "ZIP_CONTENT_TYPES = [",
            "    \"application/x-zip-compressed\",",
            "    \"application/x-zip\",",
            "    \"application/zip\",",
            "    \"application/gzip\",",
            "    \"text/xml\",",
            "]",
            "",
            "",
            "def import_record(xml_node, report):",
            "    \"\"\"Import a record.\"\"\"",
            "    record = models.Record(report=report)",
            "    row = xml_node.find(\"row\")",
            "    record.source_ip = row.find(\"source_ip\").text",
            "    record.count = int(row.find(\"count\").text)",
            "",
            "    policy_evaluated = row.find(\"policy_evaluated\")",
            "    record.disposition = policy_evaluated.find(\"disposition\").text",
            "    record.dkim_result = policy_evaluated.find(\"dkim\").text",
            "    record.spf_result = policy_evaluated.find(\"spf\").text",
            "    reason = policy_evaluated.find(\"reason\")",
            "    if reason:",
            "        record.reason_type = smart_text(reason.find(\"type\").text)[:14]",
            "        if record.reason_type not in constants.ALLOWED_REASON_TYPES:",
            "            record.reason_type = \"other\"",
            "        comment = reason.find(\"comment\").text or \"\"",
            "        record.reason_comment = comment",
            "",
            "    identifiers = xml_node.find(\"identifiers\")",
            "    header_from = identifiers.find(\"header_from\").text.split(\".\")",
            "    domain = None",
            "    while len(header_from) >= 2:",
            "        domain = admin_models.Domain.objects.filter(",
            "            name=\".\".join(header_from)).first()",
            "        if domain is not None:",
            "            record.header_from = domain",
            "            break",
            "        header_from = header_from[1:]",
            "    if domain is None:",
            "        print(\"Invalid record found (domain not local)\")",
            "        return None",
            "",
            "    record.save()",
            "    auth_results = xml_node.find(\"auth_results\")",
            "    for rtype in [\"spf\", \"dkim\"]:",
            "        rnode = auth_results.find(rtype)",
            "        if not rnode:",
            "            continue",
            "        models.Result.objects.create(",
            "            record=record, type=rtype, domain=rnode.find(\"domain\").text,",
            "            result=rnode.find(\"result\").text)",
            "",
            "",
            "@transaction.atomic",
            "def import_report(content):",
            "    \"\"\"Import an aggregated report.\"\"\"",
            "    root = fromstring(content, forbid_dtd=True)",
            "    metadata = root.find(\"report_metadata\")",
            "    print(",
            "        \"Importing report {} received from {}\".format(",
            "            metadata.find(\"report_id\").text,",
            "            metadata.find(\"org_name\").text)",
            "    )",
            "    reporter, created = models.Reporter.objects.get_or_create(",
            "        email=metadata.find(\"email\").text,",
            "        defaults={\"org_name\": metadata.find(\"org_name\").text}",
            "    )",
            "    qs = models.Report.objects.filter(",
            "        reporter=reporter, report_id=metadata.find(\"report_id\").text)",
            "    if qs.exists():",
            "        print(\"Report already imported.\")",
            "        return",
            "    report = models.Report(reporter=reporter)",
            "",
            "    report.report_id = metadata.find(\"report_id\").text",
            "    date_range = metadata.find(\"date_range\")",
            "    report.start_date = timezone.make_aware(",
            "        datetime.datetime.fromtimestamp(int(date_range.find(\"begin\").text))",
            "    )",
            "    report.end_date = timezone.make_aware(",
            "        datetime.datetime.fromtimestamp(int(date_range.find(\"end\").text))",
            "    )",
            "",
            "    policy_published = root.find(\"policy_published\")",
            "    for attr in [\"domain\", \"adkim\", \"aspf\", \"p\", \"sp\", \"pct\"]:",
            "        try:",
            "            setattr(",
            "                report, \"policy_{}\".format(attr),",
            "                policy_published.find(attr).text",
            "            )",
            "        except AttributeError:",
            "            pass",
            "    try:",
            "        report.save()",
            "    except (pytz.exceptions.AmbiguousTimeError):",
            "        print(\"Report skipped because of invalid date.\")",
            "        return",
            "    for record in root.findall(\"record\"):",
            "        import_record(record, report)",
            "",
            "",
            "def import_archive(archive, content_type=None):",
            "    \"\"\"Import reports contained inside (file pointer)",
            "    - a zip archive,",
            "    - a gzip file,",
            "    - a xml file.",
            "    \"\"\"",
            "    if content_type == \"text/xml\":",
            "        import_report(archive.read())",
            "    elif content_type == \"application/gzip\":",
            "        with gzip.GzipFile(mode=\"r\", fileobj=archive) as zfile:",
            "            import_report(zfile.read())",
            "    else:",
            "        with zipfile.ZipFile(archive, \"r\") as zfile:",
            "            for fname in zfile.namelist():",
            "                import_report(zfile.read(fname))",
            "",
            "",
            "def import_report_from_email(content):",
            "    \"\"\"Import a report from an email.\"\"\"",
            "    if isinstance(content, six.string_types):",
            "        msg = email.message_from_string(content)",
            "    else:",
            "        msg = email.message_from_file(content)",
            "    err = False",
            "    for part in msg.walk():",
            "        if part.get_content_type() not in ZIP_CONTENT_TYPES:",
            "            continue",
            "        try:",
            "            fpo = six.BytesIO(part.get_payload(decode=True))",
            "            import_archive(fpo, content_type=part.get_content_type())",
            "        except (OSError, IOError):",
            "            print('Error: the attachment does not match the mimetype')",
            "            err = True",
            "        else:",
            "            fpo.close()",
            "    if err:",
            "        # Return EX_DATAERR code <data format error> available",
            "        # at sysexits.h file",
            "        # (see http://www.postfix.org/pipe.8.html)",
            "        sys.exit(65)",
            "",
            "",
            "def import_report_from_stdin():",
            "    \"\"\"Parse a report from stdin.\"\"\"",
            "    content = six.StringIO()",
            "    for line in fileinput.input([]):",
            "        content.write(line)",
            "    content.seek(0)",
            "",
            "    if not content:",
            "        return",
            "    import_report_from_email(content)",
            "",
            "",
            "def import_from_imap(options):",
            "    \"\"\"Import reports from an IMAP mailbox.\"\"\"",
            "    obj = imaplib.IMAP4_SSL if options[\"ssl\"] else imaplib.IMAP4",
            "    conn = obj(options[\"host\"])",
            "    username = raw_input(\"Username: \")",
            "    password = getpass.getpass(prompt=\"Password: \")",
            "    conn.login(username, password)",
            "    conn.select(options[\"mailbox\"])",
            "    type, msg_ids = conn.search(None, \"ALL\")",
            "    for msg_id in msg_ids[0].split():",
            "        typ, content = conn.fetch(msg_id, \"(RFC822)\")",
            "        for response_part in content:",
            "            if isinstance(response_part, tuple):",
            "                import_report_from_email(response_part[1])",
            "    conn.close()"
        ],
        "action": [
            "0",
            "0",
            "1",
            "1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "3": [],
            "4": [],
            "14": [],
            "39": [
                "import_record"
            ],
            "40": [
                "import_record"
            ],
            "41": [
                "import_record"
            ],
            "42": [
                "import_record"
            ],
            "43": [
                "import_record"
            ],
            "44": [
                "import_record"
            ],
            "45": [
                "import_record"
            ],
            "46": [
                "import_record"
            ],
            "47": [
                "import_record"
            ],
            "50": [
                "import_record"
            ],
            "52": [
                "import_record"
            ],
            "67": [
                "import_record"
            ],
            "69": [
                "import_record"
            ],
            "71": [
                "import_record"
            ],
            "72": [
                "import_record"
            ],
            "78": [
                "import_report"
            ],
            "81": [
                "import_report"
            ],
            "82": [
                "import_report"
            ],
            "85": [
                "import_report"
            ],
            "86": [
                "import_report"
            ],
            "89": [
                "import_report"
            ],
            "95": [
                "import_report"
            ],
            "97": [
                "import_report"
            ],
            "98": [
                "import_report"
            ],
            "100": [
                "import_report"
            ],
            "101": [
                "import_report"
            ],
            "107": [
                "import_report"
            ],
            "116": [
                "import_report"
            ]
        },
        "addLocation": []
    }
}