{
    "modoboa/admin/api/v1/viewsets.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from modoboa.core import sms_backends"
            },
            "1": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from modoboa.lib import renderers as lib_renderers"
            },
            "2": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from modoboa.lib import viewsets as lib_viewsets"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+from modoboa.lib.throttle import GetThrottleViewsetMixin, PasswordResetRequestThrottle"
            },
            "4": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from ... import lib, models"
            },
            "6": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " from . import serializers"
            },
            "7": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "         summary=\"Create a new domain\""
            },
            "8": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "     )"
            },
            "9": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " )"
            },
            "10": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class DomainViewSet(lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+class DomainViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):"
            },
            "12": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 40,
                "PatchRowcode": "     \"\"\"Domain viewset.\"\"\""
            },
            "13": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 41,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 42,
                "PatchRowcode": "     permission_classes = [IsAuthenticated, DjangoModelPermissions, ]"
            },
            "15": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "         fields = [\"domain\"]"
            },
            "16": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 62,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": 62,
                "afterPatchRowNumber": 63,
                "PatchRowcode": " "
            },
            "18": {
                "beforePatchRowNumber": 63,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class DomainAliasViewSet(lib_viewsets.RevisionModelMixin,"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+class DomainAliasViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin,"
            },
            "20": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "                          viewsets.ModelViewSet):"
            },
            "21": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "     \"\"\"ViewSet for DomainAlias.\"\"\""
            },
            "22": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 67,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "         return context"
            },
            "24": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 82,
                "PatchRowcode": " "
            },
            "25": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 83,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class AccountViewSet(lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+class AccountViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):"
            },
            "28": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 85,
                "PatchRowcode": "     \"\"\"ViewSet for User/Mailbox.\"\"\""
            },
            "29": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 86,
                "PatchRowcode": " "
            },
            "30": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "     filter_backends = (filters.SearchFilter, )"
            },
            "31": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "     permission_classes = [IsAuthenticated, DjangoModelPermissions, ]"
            },
            "32": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "     search_fields = (\"^first_name\", \"^last_name\", \"^email\")"
            },
            "33": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 90,
                "PatchRowcode": " "
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+    def get_throttles(self):"
            },
            "35": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+        throttles = super().get_throttles()"
            },
            "37": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+        if self.action == \"reset_password\":"
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+            throttles.append(PasswordResetRequestThrottle())"
            },
            "39": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+        "
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 97,
                "PatchRowcode": "+        return throttles"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 98,
                "PatchRowcode": "+"
            },
            "42": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "     def get_serializer_class(self):"
            },
            "43": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         \"\"\"Return a serializer.\"\"\""
            },
            "44": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "         action_dict = {"
            },
            "45": {
                "beforePatchRowNumber": 175,
                "afterPatchRowNumber": 184,
                "PatchRowcode": "         return Response(body)"
            },
            "46": {
                "beforePatchRowNumber": 176,
                "afterPatchRowNumber": 185,
                "PatchRowcode": " "
            },
            "47": {
                "beforePatchRowNumber": 177,
                "afterPatchRowNumber": 186,
                "PatchRowcode": " "
            },
            "48": {
                "beforePatchRowNumber": 178,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class AliasViewSet(lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 187,
                "PatchRowcode": "+class AliasViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):"
            },
            "50": {
                "beforePatchRowNumber": 179,
                "afterPatchRowNumber": 188,
                "PatchRowcode": "     \"\"\""
            },
            "51": {
                "beforePatchRowNumber": 180,
                "afterPatchRowNumber": 189,
                "PatchRowcode": "     create:"
            },
            "52": {
                "beforePatchRowNumber": 181,
                "afterPatchRowNumber": 190,
                "PatchRowcode": "     Create a new alias instance."
            },
            "53": {
                "beforePatchRowNumber": 207,
                "afterPatchRowNumber": 216,
                "PatchRowcode": "         fields = [\"mailbox\"]"
            },
            "54": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": 217,
                "PatchRowcode": " "
            },
            "55": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": 218,
                "PatchRowcode": " "
            },
            "56": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class SenderAddressViewSet(lib_viewsets.RevisionModelMixin,"
            },
            "57": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 219,
                "PatchRowcode": "+class SenderAddressViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin,"
            },
            "58": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": 220,
                "PatchRowcode": "                            viewsets.ModelViewSet):"
            },
            "59": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": 221,
                "PatchRowcode": "     \"\"\"View set for SenderAddress model.\"\"\""
            },
            "60": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": 222,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "\"\"\"Admin API.\"\"\"",
            "",
            "from django import http",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.utils.translation import ugettext as _",
            "",
            "from django_filters import rest_framework as dj_filters",
            "from drf_spectacular.utils import extend_schema, extend_schema_view",
            "from rest_framework import filters, renderers, status, viewsets",
            "from rest_framework.decorators import action",
            "from rest_framework.exceptions import ParseError",
            "from rest_framework.permissions import DjangoModelPermissions, IsAuthenticated",
            "from rest_framework.response import Response",
            "",
            "from modoboa.core import models as core_models",
            "from modoboa.core import sms_backends",
            "from modoboa.lib import renderers as lib_renderers",
            "from modoboa.lib import viewsets as lib_viewsets",
            "",
            "from ... import lib, models",
            "from . import serializers",
            "",
            "",
            "@extend_schema_view(",
            "    retrieve=extend_schema(",
            "        description=\"Retrieve a particular domain\",",
            "        summary=\"Retrieve a particular domain\"",
            "    ),",
            "    list=extend_schema(",
            "        description=\"Retrieve a list of domains\",",
            "        summary=\"Retrieve a list of domains\"",
            "    ),",
            "    create=extend_schema(",
            "        description=\"Create a new domain\",",
            "        summary=\"Create a new domain\"",
            "    )",
            ")",
            "class DomainViewSet(lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):",
            "    \"\"\"Domain viewset.\"\"\"",
            "",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    serializer_class = serializers.DomainSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        return models.Domain.objects.get_for_admin(self.request.user)",
            "",
            "    def perform_destroy(self, instance):",
            "        \"\"\"Add custom args to delete call.\"\"\"",
            "        instance.delete(self.request.user)",
            "",
            "",
            "class DomainAliasFilterSet(dj_filters.FilterSet):",
            "    \"\"\"Custom FilterSet for DomainAlias.\"\"\"",
            "",
            "    domain = dj_filters.CharFilter(field_name=\"target__name\")",
            "",
            "    class Meta:",
            "        model = models.DomainAlias",
            "        fields = [\"domain\"]",
            "",
            "",
            "class DomainAliasViewSet(lib_viewsets.RevisionModelMixin,",
            "                         viewsets.ModelViewSet):",
            "    \"\"\"ViewSet for DomainAlias.\"\"\"",
            "",
            "    filter_backends = (dj_filters.DjangoFilterBackend, )",
            "    filterset_class = DomainAliasFilterSet",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    renderer_classes = (renderers.JSONRenderer, lib_renderers.CSVRenderer)",
            "    serializer_class = serializers.DomainAliasSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        return models.DomainAlias.objects.get_for_admin(self.request.user)",
            "",
            "    def get_renderer_context(self):",
            "        context = super().get_renderer_context()",
            "        context[\"headers\"] = [\"name\", \"target__name\", \"enabled\"]",
            "        return context",
            "",
            "",
            "class AccountViewSet(lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):",
            "    \"\"\"ViewSet for User/Mailbox.\"\"\"",
            "",
            "    filter_backends = (filters.SearchFilter, )",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    search_fields = (\"^first_name\", \"^last_name\", \"^email\")",
            "",
            "    def get_serializer_class(self):",
            "        \"\"\"Return a serializer.\"\"\"",
            "        action_dict = {",
            "            \"list\": serializers.AccountSerializer,",
            "            \"retrieve\": serializers.AccountSerializer,",
            "            \"password\": serializers.AccountPasswordSerializer,",
            "            \"reset_password\": serializers.ResetPasswordSerializer,",
            "        }",
            "        return action_dict.get(",
            "            self.action, serializers.WritableAccountSerializer)",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        ids = user.objectaccess_set \\",
            "            .filter(content_type=ContentType.objects.get_for_model(user)) \\",
            "            .values_list(\"object_id\", flat=True)",
            "        queryset = core_models.User.objects.filter(pk__in=ids)",
            "        domain = self.request.query_params.get(\"domain\")",
            "        if domain:",
            "            queryset = queryset.filter(mailbox__domain__name=domain)",
            "        return queryset",
            "",
            "    @action(methods=[\"put\"], detail=True)",
            "    def password(self, request, pk=None):",
            "        \"\"\"Change account password.\"\"\"",
            "        try:",
            "            user = core_models.User.objects.get(pk=pk)",
            "        except core_models.User.DoesNotExist:",
            "            raise http.Http404",
            "        serializer = self.get_serializer(user, data=request.data)",
            "        if serializer.is_valid():",
            "            serializer.save()",
            "            return Response()",
            "        return Response(",
            "            serializer.errors, status=status.HTTP_400_BAD_REQUEST)",
            "",
            "    @action(detail=False)",
            "    def exists(self, request):",
            "        \"\"\"Check if account exists.",
            "",
            "        Requires a valid email address as argument. Example:",
            "",
            "        GET /exists/?email=user@test.com",
            "",
            "        \"\"\"",
            "        email = request.GET.get(\"email\")",
            "        if not email:",
            "            raise ParseError(\"email not provided\")",
            "        if not core_models.User.objects.filter(email=email).exists():",
            "            data = {\"exists\": False}",
            "        else:",
            "            data = {\"exists\": True}",
            "        serializer = serializers.AccountExistsSerializer(data)",
            "        return Response(serializer.data)",
            "",
            "    @action(methods=[\"post\"], detail=False)",
            "    def reset_password(self, request):",
            "        \"\"\"Reset account password and send a new one by SMS.\"\"\"",
            "        sms_password_recovery = (",
            "            request.localconfig.parameters",
            "            .get_value(\"sms_password_recovery\", app=\"core\")",
            "        )",
            "        if not sms_password_recovery:",
            "            return Response(status=404)",
            "        serializer = self.get_serializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        user = core_models.User.objects.filter(",
            "            email=serializer.validated_data[\"email\"]).first()",
            "        if not user or not user.phone_number:",
            "            return Response(status=404)",
            "        backend = sms_backends.get_active_backend(",
            "            request.localconfig.parameters)",
            "        if not backend:",
            "            return Response(status=404)",
            "        password = lib.make_password()",
            "        content = _(\"Here is your new Modoboa password: {}\").format(",
            "            password)",
            "        if not backend.send(content, [str(user.phone_number)]):",
            "            body = {\"status\": \"ko\"}",
            "        else:",
            "            # SMS was sent, now we can set the new password.",
            "            body = {\"status\": \"ok\"}",
            "            user.set_password(password)",
            "            user.save(update_fields=[\"password\"])",
            "        return Response(body)",
            "",
            "",
            "class AliasViewSet(lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):",
            "    \"\"\"",
            "    create:",
            "    Create a new alias instance.",
            "    \"\"\"",
            "",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    serializer_class = serializers.AliasSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        ids = (",
            "            user.objectaccess_set.filter(",
            "                content_type=ContentType.objects.get_for_model(models.Alias))",
            "            .values_list(\"object_id\", flat=True)",
            "        )",
            "        queryset = models.Alias.objects.filter(pk__in=ids)",
            "        domain = self.request.query_params.get(\"domain\")",
            "        if domain:",
            "            queryset = queryset.filter(domain__name=domain)",
            "        return queryset",
            "",
            "",
            "class SenderAddressFilterSet(dj_filters.FilterSet):",
            "    \"\"\"Custom FilterSet for SenderAddress.\"\"\"",
            "",
            "    class Meta:",
            "        model = models.SenderAddress",
            "        fields = [\"mailbox\"]",
            "",
            "",
            "class SenderAddressViewSet(lib_viewsets.RevisionModelMixin,",
            "                           viewsets.ModelViewSet):",
            "    \"\"\"View set for SenderAddress model.\"\"\"",
            "",
            "    filter_backends = (dj_filters.DjangoFilterBackend, )",
            "    filterset_class = SenderAddressFilterSet",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    serializer_class = serializers.SenderAddressSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        mb_ids = (",
            "            user.objectaccess_set.filter(",
            "                content_type=ContentType.objects.get_for_model(models.Mailbox))",
            "            .values_list(\"object_id\", flat=True)",
            "        )",
            "        return models.SenderAddress.objects.filter(mailbox__pk__in=mb_ids)"
        ],
        "afterPatchFile": [
            "\"\"\"Admin API.\"\"\"",
            "",
            "from django import http",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.utils.translation import ugettext as _",
            "",
            "from django_filters import rest_framework as dj_filters",
            "from drf_spectacular.utils import extend_schema, extend_schema_view",
            "from rest_framework import filters, renderers, status, viewsets",
            "from rest_framework.decorators import action",
            "from rest_framework.exceptions import ParseError",
            "from rest_framework.permissions import DjangoModelPermissions, IsAuthenticated",
            "from rest_framework.response import Response",
            "",
            "from modoboa.core import models as core_models",
            "from modoboa.core import sms_backends",
            "from modoboa.lib import renderers as lib_renderers",
            "from modoboa.lib import viewsets as lib_viewsets",
            "from modoboa.lib.throttle import GetThrottleViewsetMixin, PasswordResetRequestThrottle",
            "",
            "from ... import lib, models",
            "from . import serializers",
            "",
            "",
            "@extend_schema_view(",
            "    retrieve=extend_schema(",
            "        description=\"Retrieve a particular domain\",",
            "        summary=\"Retrieve a particular domain\"",
            "    ),",
            "    list=extend_schema(",
            "        description=\"Retrieve a list of domains\",",
            "        summary=\"Retrieve a list of domains\"",
            "    ),",
            "    create=extend_schema(",
            "        description=\"Create a new domain\",",
            "        summary=\"Create a new domain\"",
            "    )",
            ")",
            "class DomainViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):",
            "    \"\"\"Domain viewset.\"\"\"",
            "",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    serializer_class = serializers.DomainSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        return models.Domain.objects.get_for_admin(self.request.user)",
            "",
            "    def perform_destroy(self, instance):",
            "        \"\"\"Add custom args to delete call.\"\"\"",
            "        instance.delete(self.request.user)",
            "",
            "",
            "class DomainAliasFilterSet(dj_filters.FilterSet):",
            "    \"\"\"Custom FilterSet for DomainAlias.\"\"\"",
            "",
            "    domain = dj_filters.CharFilter(field_name=\"target__name\")",
            "",
            "    class Meta:",
            "        model = models.DomainAlias",
            "        fields = [\"domain\"]",
            "",
            "",
            "class DomainAliasViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin,",
            "                         viewsets.ModelViewSet):",
            "    \"\"\"ViewSet for DomainAlias.\"\"\"",
            "",
            "    filter_backends = (dj_filters.DjangoFilterBackend, )",
            "    filterset_class = DomainAliasFilterSet",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    renderer_classes = (renderers.JSONRenderer, lib_renderers.CSVRenderer)",
            "    serializer_class = serializers.DomainAliasSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        return models.DomainAlias.objects.get_for_admin(self.request.user)",
            "",
            "    def get_renderer_context(self):",
            "        context = super().get_renderer_context()",
            "        context[\"headers\"] = [\"name\", \"target__name\", \"enabled\"]",
            "        return context",
            "",
            "",
            "class AccountViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):",
            "    \"\"\"ViewSet for User/Mailbox.\"\"\"",
            "",
            "    filter_backends = (filters.SearchFilter, )",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    search_fields = (\"^first_name\", \"^last_name\", \"^email\")",
            "",
            "    def get_throttles(self):",
            "",
            "        throttles = super().get_throttles()",
            "        if self.action == \"reset_password\":",
            "            throttles.append(PasswordResetRequestThrottle())",
            "        ",
            "        return throttles",
            "",
            "    def get_serializer_class(self):",
            "        \"\"\"Return a serializer.\"\"\"",
            "        action_dict = {",
            "            \"list\": serializers.AccountSerializer,",
            "            \"retrieve\": serializers.AccountSerializer,",
            "            \"password\": serializers.AccountPasswordSerializer,",
            "            \"reset_password\": serializers.ResetPasswordSerializer,",
            "        }",
            "        return action_dict.get(",
            "            self.action, serializers.WritableAccountSerializer)",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        ids = user.objectaccess_set \\",
            "            .filter(content_type=ContentType.objects.get_for_model(user)) \\",
            "            .values_list(\"object_id\", flat=True)",
            "        queryset = core_models.User.objects.filter(pk__in=ids)",
            "        domain = self.request.query_params.get(\"domain\")",
            "        if domain:",
            "            queryset = queryset.filter(mailbox__domain__name=domain)",
            "        return queryset",
            "",
            "    @action(methods=[\"put\"], detail=True)",
            "    def password(self, request, pk=None):",
            "        \"\"\"Change account password.\"\"\"",
            "        try:",
            "            user = core_models.User.objects.get(pk=pk)",
            "        except core_models.User.DoesNotExist:",
            "            raise http.Http404",
            "        serializer = self.get_serializer(user, data=request.data)",
            "        if serializer.is_valid():",
            "            serializer.save()",
            "            return Response()",
            "        return Response(",
            "            serializer.errors, status=status.HTTP_400_BAD_REQUEST)",
            "",
            "    @action(detail=False)",
            "    def exists(self, request):",
            "        \"\"\"Check if account exists.",
            "",
            "        Requires a valid email address as argument. Example:",
            "",
            "        GET /exists/?email=user@test.com",
            "",
            "        \"\"\"",
            "        email = request.GET.get(\"email\")",
            "        if not email:",
            "            raise ParseError(\"email not provided\")",
            "        if not core_models.User.objects.filter(email=email).exists():",
            "            data = {\"exists\": False}",
            "        else:",
            "            data = {\"exists\": True}",
            "        serializer = serializers.AccountExistsSerializer(data)",
            "        return Response(serializer.data)",
            "",
            "    @action(methods=[\"post\"], detail=False)",
            "    def reset_password(self, request):",
            "        \"\"\"Reset account password and send a new one by SMS.\"\"\"",
            "        sms_password_recovery = (",
            "            request.localconfig.parameters",
            "            .get_value(\"sms_password_recovery\", app=\"core\")",
            "        )",
            "        if not sms_password_recovery:",
            "            return Response(status=404)",
            "        serializer = self.get_serializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        user = core_models.User.objects.filter(",
            "            email=serializer.validated_data[\"email\"]).first()",
            "        if not user or not user.phone_number:",
            "            return Response(status=404)",
            "        backend = sms_backends.get_active_backend(",
            "            request.localconfig.parameters)",
            "        if not backend:",
            "            return Response(status=404)",
            "        password = lib.make_password()",
            "        content = _(\"Here is your new Modoboa password: {}\").format(",
            "            password)",
            "        if not backend.send(content, [str(user.phone_number)]):",
            "            body = {\"status\": \"ko\"}",
            "        else:",
            "            # SMS was sent, now we can set the new password.",
            "            body = {\"status\": \"ok\"}",
            "            user.set_password(password)",
            "            user.save(update_fields=[\"password\"])",
            "        return Response(body)",
            "",
            "",
            "class AliasViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin, viewsets.ModelViewSet):",
            "    \"\"\"",
            "    create:",
            "    Create a new alias instance.",
            "    \"\"\"",
            "",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    serializer_class = serializers.AliasSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        ids = (",
            "            user.objectaccess_set.filter(",
            "                content_type=ContentType.objects.get_for_model(models.Alias))",
            "            .values_list(\"object_id\", flat=True)",
            "        )",
            "        queryset = models.Alias.objects.filter(pk__in=ids)",
            "        domain = self.request.query_params.get(\"domain\")",
            "        if domain:",
            "            queryset = queryset.filter(domain__name=domain)",
            "        return queryset",
            "",
            "",
            "class SenderAddressFilterSet(dj_filters.FilterSet):",
            "    \"\"\"Custom FilterSet for SenderAddress.\"\"\"",
            "",
            "    class Meta:",
            "        model = models.SenderAddress",
            "        fields = [\"mailbox\"]",
            "",
            "",
            "class SenderAddressViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin,",
            "                           viewsets.ModelViewSet):",
            "    \"\"\"View set for SenderAddress model.\"\"\"",
            "",
            "    filter_backends = (dj_filters.DjangoFilterBackend, )",
            "    filterset_class = SenderAddressFilterSet",
            "    permission_classes = [IsAuthenticated, DjangoModelPermissions, ]",
            "    serializer_class = serializers.SenderAddressSerializer",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        mb_ids = (",
            "            user.objectaccess_set.filter(",
            "                content_type=ContentType.objects.get_for_model(models.Mailbox))",
            "            .values_list(\"object_id\", flat=True)",
            "        )",
            "        return models.SenderAddress.objects.filter(mailbox__pk__in=mb_ids)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "38": [
                "DomainViewSet"
            ],
            "63": [
                "DomainAliasViewSet"
            ],
            "83": [
                "AccountViewSet"
            ],
            "178": [
                "AliasViewSet"
            ],
            "210": [
                "SenderAddressViewSet"
            ]
        },
        "addLocation": []
    },
    "modoboa/admin/api/v2/tests.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 224,
                "afterPatchRowNumber": 224,
                "PatchRowcode": "         self.assertIn(\"password\", resp.json())"
            },
            "1": {
                "beforePatchRowNumber": 225,
                "afterPatchRowNumber": 225,
                "PatchRowcode": " "
            },
            "2": {
                "beforePatchRowNumber": 226,
                "afterPatchRowNumber": 226,
                "PatchRowcode": "     def test_validate(self):"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 227,
                "PatchRowcode": "+        \"\"\"Test validate and throttling.\"\"\""
            },
            "4": {
                "beforePatchRowNumber": 227,
                "afterPatchRowNumber": 228,
                "PatchRowcode": "         data = {\"username\": \"toto@test.com\"}"
            },
            "5": {
                "beforePatchRowNumber": 228,
                "afterPatchRowNumber": 229,
                "PatchRowcode": "         url = reverse(\"v2:account-validate\")"
            },
            "6": {
                "beforePatchRowNumber": 229,
                "afterPatchRowNumber": 230,
                "PatchRowcode": "         resp = self.client.post(url, data, format=\"json\")"
            }
        },
        "frontPatchFile": [
            "\"\"\"API v2 tests.\"\"\"",
            "",
            "from django.core.files.base import ContentFile",
            "from django.urls import reverse",
            "from django.utils.encoding import force_text",
            "",
            "from rest_framework.authtoken.models import Token",
            "",
            "from modoboa.admin import factories, models",
            "from modoboa.core import models as core_models",
            "from modoboa.lib.tests import ModoAPITestCase",
            "",
            "",
            "class DomainViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "        cls.da_token = Token.objects.create(",
            "            user=core_models.User.objects.get(username=\"admin@test.com\"))",
            "",
            "    def test_create(self):",
            "        url = reverse(\"v2:domain-list\")",
            "        data = {",
            "            \"name\": \"domain.tld\",",
            "            \"domain_admin\": {",
            "                \"username\": \"admin\",",
            "                \"with_mailbox\": True,",
            "                \"with_aliases\": True",
            "            }",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 201)",
            "",
            "        dom = models.Domain.objects.get(pk=resp.json()[\"pk\"])",
            "        self.assertEqual(len(dom.admins), 1)",
            "        admin = dom.admins.first()",
            "        self.assertTrue(hasattr(admin, \"mailbox\"))",
            "        self.assertTrue(",
            "            models.Alias.objects.filter(",
            "                address=\"postmaster@domain.tld\").exists()",
            "        )",
            "",
            "    def test_update(self):",
            "        domain = models.Domain.objects.get(name=\"test2.com\")",
            "        data = {",
            "            \"name\": \"test2.com\",",
            "            \"type\": \"relaydomain\",",
            "            \"transport\": {",
            "                \"service\": \"relay\",",
            "                \"settings\": {",
            "                    \"relay_target_port\": 25,",
            "                    \"relay_target_host\": \"localhost\"",
            "                }",
            "            }",
            "        }",
            "        url = reverse(\"v2:domain-detail\", args=[domain.pk])",
            "        resp = self.client.put(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        domain.refresh_from_db()",
            "        self.assertEqual(domain.transport.service, data[\"transport\"][\"service\"])",
            "        self.assertEqual(",
            "            domain.transport._settings[\"relay_target_host\"],",
            "            data[\"transport\"][\"settings\"][\"relay_target_host\"]",
            "        )",
            "",
            "        data[\"transport\"][\"relay_verify_recipients\"] = True",
            "        resp = self.client.put(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_update_resources(self):",
            "        self.set_global_parameter(\"enable_domain_limits\", True, app=\"limits\")",
            "        domain = models.Domain.objects.get(name=\"test2.com\")",
            "        data = {",
            "            \"name\": \"test2.com\",",
            "            \"resources\": [",
            "                {\"name\": \"domain_aliases\", \"max_value\": 20}",
            "            ]",
            "        }",
            "        url = reverse(\"v2:domain-detail\", args=[domain.pk])",
            "        resp = self.client.put(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(",
            "            domain.domainobjectlimit_set.get(name=\"domain_aliases\").max_value, 20",
            "        )",
            "",
            "    def test_delete(self):",
            "        self.client.credentials(",
            "            HTTP_AUTHORIZATION=\"Token \" + self.da_token.key)",
            "",
            "        domain = models.Domain.objects.get(name=\"test2.com\")",
            "        url = reverse(\"v2:domain-delete\", args=[domain.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 403)",
            "",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-delete\", args=[domain.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 403)",
            "",
            "        self.client.credentials(HTTP_AUTHORIZATION=\"Token \" + self.token.key)",
            "        url = reverse(\"v2:domain-delete\", args=[domain.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 204)",
            "",
            "    def test_administrators(self):",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-administrators\", args=[domain.pk])",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()), 1)",
            "",
            "    def test_administrator(self):",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-add-administrator\", args=[domain.pk])",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        data = {\"account\": account.pk}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_remove_adminstrator(self):",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-remove-administrator\", args=[domain.pk])",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        data = {\"account\": account.pk}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_domains_import(self):",
            "        f = ContentFile(b\"\"\"domain; domain1.com; 1000; 100; True",
            "domain; domain2.com; 1000; 200; False",
            "domainalias; domalias1.com; domain1.com; True",
            "\"\"\", name=\"domains.csv\")",
            "        self.client.post(",
            "            reverse(\"v2:domain-import-from-csv\"), {",
            "                \"sourcefile\": f",
            "            }",
            "        )",
            "        admin = core_models.User.objects.get(username=\"admin\")",
            "        dom = models.Domain.objects.get(name=\"domain1.com\")",
            "        self.assertEqual(dom.quota, 1000)",
            "        self.assertEqual(dom.default_mailbox_quota, 100)",
            "        self.assertTrue(dom.enabled)",
            "        self.assertTrue(admin.is_owner(dom))",
            "        domalias = models.DomainAlias.objects.get(name=\"domalias1.com\")",
            "        self.assertEqual(domalias.target, dom)",
            "        self.assertTrue(dom.enabled)",
            "        self.assertTrue(admin.is_owner(domalias))",
            "        dom = models.Domain.objects.get(name=\"domain2.com\")",
            "        self.assertEqual(dom.default_mailbox_quota, 200)",
            "        self.assertFalse(dom.enabled)",
            "        self.assertTrue(admin.is_owner(dom))",
            "",
            "    def test_export_domains(self):",
            "        \"\"\"Check domain export.\"\"\"",
            "        dom = models.Domain.objects.get(name=\"test.com\")",
            "        factories.DomainAliasFactory(name=\"alias.test\", target=dom)",
            "        response = self.client.get(reverse(\"v2:domain-export\"))",
            "        expected_response = [",
            "            \"domain,test.com,50,10,True\",",
            "            \"domainalias,alias.test,test.com,True\",",
            "            \"domain,test2.com,0,0,True\",",
            "        ]",
            "        self.assertCountEqual(",
            "            expected_response,",
            "            force_text(response.content.strip()).split(\"\\r\\n\")",
            "        )",
            "",
            "",
            "class AccountViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "",
            "    def test_create(self):",
            "        url = reverse(\"v2:account-list\")",
            "        data = {",
            "            \"username\": \"toto@test.com\",",
            "            \"role\": \"SimpleUsers\",",
            "            \"mailbox\": {",
            "                \"use_domain_quota\": True",
            "            },",
            "            \"password\": \"Toto12345\",",
            "            \"language\": \"fr\",",
            "            \"aliases\": [\"alias3@test.com\"]",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 201)",
            "        self.assertTrue(",
            "            models.Alias.objects.filter(",
            "                address=\"alias3@test.com\").exists()",
            "        )",
            "",
            "    def test_create_admin(self):",
            "        url = reverse(\"v2:account-list\")",
            "        data = {",
            "            \"username\": \"superadmin\",",
            "            \"role\": \"SuperAdmins\",",
            "            \"password\": \"Toto12345\",",
            "            \"language\": \"fr\",",
            "            \"aliases\": [\"alias3@test.com\"]",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "",
            "    def test_create_with_bad_password(self):",
            "        url = reverse(\"v2:account-list\")",
            "        data = {",
            "            \"username\": \"superadmin\",",
            "            \"role\": \"SuperAdmins\",",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "        self.assertIn(\"password\", resp.json())",
            "",
            "        data[\"password\"] = \"Toto\"",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "        self.assertIn(\"password\", resp.json())",
            "",
            "    def test_validate(self):",
            "        data = {\"username\": \"toto@test.com\"}",
            "        url = reverse(\"v2:account-validate\")",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 204)",
            "",
            "    def test_random_password(self):",
            "        url = reverse(\"v2:account-random-password\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertIn(\"password\", resp.json())",
            "",
            "    def test_delete(self):",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        url = reverse(\"v2:account-delete\", args=[account.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 204)",
            "        with self.assertRaises(core_models.User.DoesNotExist):",
            "            account.refresh_from_db()",
            "",
            "    def test_update(self):",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        data = {",
            "            \"username\": \"user@test.com\",",
            "            \"role\": \"SimpleUsers\",",
            "            \"password\": \"Toto12345\",",
            "            \"mailbox\": {",
            "                \"quota\": 10",
            "            }",
            "        }",
            "        resp = self.client.patch(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_update_admin(self):",
            "        account = core_models.User.objects.get(username=\"admin\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        data = {",
            "            \"username\": \"superadmin@test.com\",",
            "            \"role\": \"SuperAdmins\",",
            "            \"password\": \"Toto12345\",",
            "            \"mailbox\": {",
            "                \"quota\": 10",
            "            }",
            "        }",
            "        resp = self.client.patch(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "        account.refresh_from_db()",
            "        self.assertEqual(account.email, data[\"username\"])",
            "        self.assertEqual(account.mailbox.full_address, data[\"username\"])",
            "",
            "    def test_update_resources(self):",
            "        account = core_models.User.objects.get(username=\"admin@test.com\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        data = {",
            "            \"resources\": [",
            "                {\"name\": \"mailboxes\", \"max_value\": 10},",
            "                {\"name\": \"mailbox_aliases\", \"max_value\": 10}",
            "            ]",
            "        }",
            "        resp = self.client.patch(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        limit = account.userobjectlimit_set.get(name=\"mailboxes\")",
            "        self.assertEqual(limit.max_value, 10)",
            "",
            "    def test_get_with_resources(self):",
            "        account = core_models.User.objects.get(username=\"admin@test.com\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        resp = self.client.get(url, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()[\"resources\"]), 2)",
            "",
            "",
            "class IdentityViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "",
            "    def test_list(self):",
            "        url = reverse(\"v2:identities-list\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()), 8)",
            "",
            "    def test_import(self):",
            "        f = ContentFile(\"\"\"",
            "account; user1@test.com; toto; User; One; True; SimpleUsers; user1@test.com; 0",
            "account; Truc@test.com; toto; Ren\u00e9; Truc; True; DomainAdmins; truc@test.com; 5; test.com",
            "alias; alias1@test.com; True; user1@test.com",
            "forward; alias2@test.com; True; user1+ext@test.com",
            "forward; fwd1@test.com; True; user@extdomain.com",
            "dlist; dlist@test.com; True; user1@test.com; user@extdomain.com",
            "\"\"\", name=\"identities.csv\")  # NOQA:E501",
            "        self.client.post(",
            "            reverse(\"v2:identities-import-from-csv\"),",
            "            {\"sourcefile\": f, \"crypt_password\": True}",
            "        )",
            "        admin = core_models.User.objects.get(username=\"admin\")",
            "        u1 = core_models.User.objects.get(username=\"user1@test.com\")",
            "        mb1 = u1.mailbox",
            "        self.assertTrue(admin.is_owner(u1))",
            "        self.assertEqual(u1.email, \"user1@test.com\")",
            "        self.assertEqual(u1.first_name, \"User\")",
            "        self.assertEqual(u1.last_name, \"One\")",
            "        self.assertTrue(u1.is_active)",
            "        self.assertEqual(u1.role, \"SimpleUsers\")",
            "        self.assertTrue(mb1.use_domain_quota)",
            "        self.assertEqual(mb1.quota, 0)",
            "        self.assertTrue(admin.is_owner(mb1))",
            "        self.assertEqual(mb1.full_address, \"user1@test.com\")",
            "        self.assertTrue(",
            "            self.client.login(username=\"user1@test.com\", password=\"toto\")",
            "        )",
            "",
            "        da = core_models.User.objects.get(username=\"truc@test.com\")",
            "        damb = da.mailbox",
            "        self.assertEqual(da.first_name, u\"Ren\u00e9\")",
            "        self.assertEqual(da.role, \"DomainAdmins\")",
            "        self.assertEqual(damb.quota, 5)",
            "        self.assertFalse(damb.use_domain_quota)",
            "        self.assertEqual(damb.full_address, \"truc@test.com\")",
            "        dom = models.Domain.objects.get(name=\"test.com\")",
            "        self.assertIn(da, dom.admins)",
            "        u = core_models.User.objects.get(username=\"user@test.com\")",
            "        self.assertTrue(da.can_access(u))",
            "",
            "        al = models.Alias.objects.get(address=\"alias1@test.com\")",
            "        self.assertTrue(",
            "            al.aliasrecipient_set",
            "            .filter(r_mailbox=u1.mailbox).exists()",
            "        )",
            "        self.assertTrue(admin.is_owner(al))",
            "",
            "        fwd = models.Alias.objects.get(address=\"fwd1@test.com\")",
            "        self.assertTrue(",
            "            fwd.aliasrecipient_set",
            "            .filter(",
            "                address=\"user@extdomain.com\", r_mailbox__isnull=True,",
            "                r_alias__isnull=True)",
            "            .exists()",
            "        )",
            "        self.assertTrue(admin.is_owner(fwd))",
            "",
            "        dlist = models.Alias.objects.get(address=\"dlist@test.com\")",
            "        self.assertTrue(",
            "            dlist.aliasrecipient_set",
            "            .filter(r_mailbox=u1.mailbox).exists()",
            "        )",
            "        self.assertTrue(",
            "            dlist.aliasrecipient_set.filter(address=\"user@extdomain.com\")",
            "            .exists()",
            "        )",
            "        self.assertTrue(admin.is_owner(dlist))",
            "",
            "    def test_export(self):",
            "        response = self.client.get(reverse(\"v2:identities-export\"))",
            "        expected_response = \"account,admin,,,,True,SuperAdmins,,\\r\\naccount,admin@test.com,{PLAIN}toto,,,True,DomainAdmins,admin@test.com,10,test.com\\r\\naccount,admin@test2.com,{PLAIN}toto,,,True,DomainAdmins,admin@test2.com,10,test2.com\\r\\naccount,user@test.com,{PLAIN}toto,,,True,SimpleUsers,user@test.com,10\\r\\naccount,user@test2.com,{PLAIN}toto,,,True,SimpleUsers,user@test2.com,10\\r\\nalias,alias@test.com,True,user@test.com\\r\\nalias,forward@test.com,True,user@external.com\\r\\nalias,postmaster@test.com,True,test@truc.fr,toto@titi.com\\r\\n\"  # NOQA:E501",
            "        received_content = force_text(response.content.strip()).split(\"\\r\\n\")",
            "        # Empty admin password because it is hashed using SHA512-CRYPT",
            "        admin_row = received_content[0].split(\",\")",
            "        admin_row[2] = \"\"",
            "        received_content[0] = \",\".join(admin_row)",
            "        self.assertCountEqual(",
            "            expected_response.strip().split(\"\\r\\n\"),",
            "            received_content",
            "        )",
            "",
            "",
            "class AliasViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "",
            "    def test_validate(self):",
            "        url = reverse(\"v2:alias-validate\")",
            "        data = {\"address\": \"alias@unknown.com\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "",
            "        data = {\"address\": \"alias@test.com\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "",
            "        data = {\"address\": \"alias2@test.com\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 204)",
            "",
            "    def test_random_address(self):",
            "        url = reverse(\"v2:alias-random-address\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertIn(\"address\", resp.json())",
            "",
            "",
            "class UserAccountViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "        cls.da = core_models.User.objects.get(username=\"admin@test.com\")",
            "        cls.da_token = Token.objects.create(user=cls.da)",
            "",
            "    def test_forward(self):",
            "        self.client.credentials(",
            "            HTTP_AUTHORIZATION=\"Token \" + self.da_token.key)",
            "        url = reverse(\"v2:account-forward\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertNotIn(\"recipients\", resp.json())",
            "",
            "        data = {\"recipients\": \"user@domain.ext\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(self.da.mailbox.aliasrecipient_set.count(), 1)",
            "",
            "        data = {\"recipients\": \"user@domain.ext\", \"keepcopies\": True}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "        self.assertEqual(",
            "            models.Alias.objects.filter(address=self.da.username).count(),",
            "            2",
            "        )",
            "",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertTrue(resp.json()[\"keepcopies\"])",
            "",
            "        data = {\"keepcopies\": False}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(",
            "            models.Alias.objects.filter(address=self.da.username).count(),",
            "            1",
            "        )",
            "",
            "",
            "class AlarmViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "        factories.AlarmFactory(",
            "            domain__name=\"test.com\", mailbox=None, title=\"Test alarm\")",
            "",
            "    def test_list(self):",
            "        url = reverse(\"v2:alarm-list\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()), 1)"
        ],
        "afterPatchFile": [
            "\"\"\"API v2 tests.\"\"\"",
            "",
            "from django.core.files.base import ContentFile",
            "from django.urls import reverse",
            "from django.utils.encoding import force_text",
            "",
            "from rest_framework.authtoken.models import Token",
            "",
            "from modoboa.admin import factories, models",
            "from modoboa.core import models as core_models",
            "from modoboa.lib.tests import ModoAPITestCase",
            "",
            "",
            "class DomainViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "        cls.da_token = Token.objects.create(",
            "            user=core_models.User.objects.get(username=\"admin@test.com\"))",
            "",
            "    def test_create(self):",
            "        url = reverse(\"v2:domain-list\")",
            "        data = {",
            "            \"name\": \"domain.tld\",",
            "            \"domain_admin\": {",
            "                \"username\": \"admin\",",
            "                \"with_mailbox\": True,",
            "                \"with_aliases\": True",
            "            }",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 201)",
            "",
            "        dom = models.Domain.objects.get(pk=resp.json()[\"pk\"])",
            "        self.assertEqual(len(dom.admins), 1)",
            "        admin = dom.admins.first()",
            "        self.assertTrue(hasattr(admin, \"mailbox\"))",
            "        self.assertTrue(",
            "            models.Alias.objects.filter(",
            "                address=\"postmaster@domain.tld\").exists()",
            "        )",
            "",
            "    def test_update(self):",
            "        domain = models.Domain.objects.get(name=\"test2.com\")",
            "        data = {",
            "            \"name\": \"test2.com\",",
            "            \"type\": \"relaydomain\",",
            "            \"transport\": {",
            "                \"service\": \"relay\",",
            "                \"settings\": {",
            "                    \"relay_target_port\": 25,",
            "                    \"relay_target_host\": \"localhost\"",
            "                }",
            "            }",
            "        }",
            "        url = reverse(\"v2:domain-detail\", args=[domain.pk])",
            "        resp = self.client.put(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        domain.refresh_from_db()",
            "        self.assertEqual(domain.transport.service, data[\"transport\"][\"service\"])",
            "        self.assertEqual(",
            "            domain.transport._settings[\"relay_target_host\"],",
            "            data[\"transport\"][\"settings\"][\"relay_target_host\"]",
            "        )",
            "",
            "        data[\"transport\"][\"relay_verify_recipients\"] = True",
            "        resp = self.client.put(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_update_resources(self):",
            "        self.set_global_parameter(\"enable_domain_limits\", True, app=\"limits\")",
            "        domain = models.Domain.objects.get(name=\"test2.com\")",
            "        data = {",
            "            \"name\": \"test2.com\",",
            "            \"resources\": [",
            "                {\"name\": \"domain_aliases\", \"max_value\": 20}",
            "            ]",
            "        }",
            "        url = reverse(\"v2:domain-detail\", args=[domain.pk])",
            "        resp = self.client.put(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(",
            "            domain.domainobjectlimit_set.get(name=\"domain_aliases\").max_value, 20",
            "        )",
            "",
            "    def test_delete(self):",
            "        self.client.credentials(",
            "            HTTP_AUTHORIZATION=\"Token \" + self.da_token.key)",
            "",
            "        domain = models.Domain.objects.get(name=\"test2.com\")",
            "        url = reverse(\"v2:domain-delete\", args=[domain.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 403)",
            "",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-delete\", args=[domain.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 403)",
            "",
            "        self.client.credentials(HTTP_AUTHORIZATION=\"Token \" + self.token.key)",
            "        url = reverse(\"v2:domain-delete\", args=[domain.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 204)",
            "",
            "    def test_administrators(self):",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-administrators\", args=[domain.pk])",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()), 1)",
            "",
            "    def test_administrator(self):",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-add-administrator\", args=[domain.pk])",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        data = {\"account\": account.pk}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_remove_adminstrator(self):",
            "        domain = models.Domain.objects.get(name=\"test.com\")",
            "        url = reverse(\"v2:domain-remove-administrator\", args=[domain.pk])",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        data = {\"account\": account.pk}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_domains_import(self):",
            "        f = ContentFile(b\"\"\"domain; domain1.com; 1000; 100; True",
            "domain; domain2.com; 1000; 200; False",
            "domainalias; domalias1.com; domain1.com; True",
            "\"\"\", name=\"domains.csv\")",
            "        self.client.post(",
            "            reverse(\"v2:domain-import-from-csv\"), {",
            "                \"sourcefile\": f",
            "            }",
            "        )",
            "        admin = core_models.User.objects.get(username=\"admin\")",
            "        dom = models.Domain.objects.get(name=\"domain1.com\")",
            "        self.assertEqual(dom.quota, 1000)",
            "        self.assertEqual(dom.default_mailbox_quota, 100)",
            "        self.assertTrue(dom.enabled)",
            "        self.assertTrue(admin.is_owner(dom))",
            "        domalias = models.DomainAlias.objects.get(name=\"domalias1.com\")",
            "        self.assertEqual(domalias.target, dom)",
            "        self.assertTrue(dom.enabled)",
            "        self.assertTrue(admin.is_owner(domalias))",
            "        dom = models.Domain.objects.get(name=\"domain2.com\")",
            "        self.assertEqual(dom.default_mailbox_quota, 200)",
            "        self.assertFalse(dom.enabled)",
            "        self.assertTrue(admin.is_owner(dom))",
            "",
            "    def test_export_domains(self):",
            "        \"\"\"Check domain export.\"\"\"",
            "        dom = models.Domain.objects.get(name=\"test.com\")",
            "        factories.DomainAliasFactory(name=\"alias.test\", target=dom)",
            "        response = self.client.get(reverse(\"v2:domain-export\"))",
            "        expected_response = [",
            "            \"domain,test.com,50,10,True\",",
            "            \"domainalias,alias.test,test.com,True\",",
            "            \"domain,test2.com,0,0,True\",",
            "        ]",
            "        self.assertCountEqual(",
            "            expected_response,",
            "            force_text(response.content.strip()).split(\"\\r\\n\")",
            "        )",
            "",
            "",
            "class AccountViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "",
            "    def test_create(self):",
            "        url = reverse(\"v2:account-list\")",
            "        data = {",
            "            \"username\": \"toto@test.com\",",
            "            \"role\": \"SimpleUsers\",",
            "            \"mailbox\": {",
            "                \"use_domain_quota\": True",
            "            },",
            "            \"password\": \"Toto12345\",",
            "            \"language\": \"fr\",",
            "            \"aliases\": [\"alias3@test.com\"]",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 201)",
            "        self.assertTrue(",
            "            models.Alias.objects.filter(",
            "                address=\"alias3@test.com\").exists()",
            "        )",
            "",
            "    def test_create_admin(self):",
            "        url = reverse(\"v2:account-list\")",
            "        data = {",
            "            \"username\": \"superadmin\",",
            "            \"role\": \"SuperAdmins\",",
            "            \"password\": \"Toto12345\",",
            "            \"language\": \"fr\",",
            "            \"aliases\": [\"alias3@test.com\"]",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "",
            "    def test_create_with_bad_password(self):",
            "        url = reverse(\"v2:account-list\")",
            "        data = {",
            "            \"username\": \"superadmin\",",
            "            \"role\": \"SuperAdmins\",",
            "        }",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "        self.assertIn(\"password\", resp.json())",
            "",
            "        data[\"password\"] = \"Toto\"",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "        self.assertIn(\"password\", resp.json())",
            "",
            "    def test_validate(self):",
            "        \"\"\"Test validate and throttling.\"\"\"",
            "        data = {\"username\": \"toto@test.com\"}",
            "        url = reverse(\"v2:account-validate\")",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 204)",
            "",
            "    def test_random_password(self):",
            "        url = reverse(\"v2:account-random-password\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertIn(\"password\", resp.json())",
            "",
            "    def test_delete(self):",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        url = reverse(\"v2:account-delete\", args=[account.pk])",
            "        resp = self.client.post(url)",
            "        self.assertEqual(resp.status_code, 204)",
            "        with self.assertRaises(core_models.User.DoesNotExist):",
            "            account.refresh_from_db()",
            "",
            "    def test_update(self):",
            "        account = core_models.User.objects.get(username=\"user@test.com\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        data = {",
            "            \"username\": \"user@test.com\",",
            "            \"role\": \"SimpleUsers\",",
            "            \"password\": \"Toto12345\",",
            "            \"mailbox\": {",
            "                \"quota\": 10",
            "            }",
            "        }",
            "        resp = self.client.patch(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_update_admin(self):",
            "        account = core_models.User.objects.get(username=\"admin\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        data = {",
            "            \"username\": \"superadmin@test.com\",",
            "            \"role\": \"SuperAdmins\",",
            "            \"password\": \"Toto12345\",",
            "            \"mailbox\": {",
            "                \"quota\": 10",
            "            }",
            "        }",
            "        resp = self.client.patch(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "        account.refresh_from_db()",
            "        self.assertEqual(account.email, data[\"username\"])",
            "        self.assertEqual(account.mailbox.full_address, data[\"username\"])",
            "",
            "    def test_update_resources(self):",
            "        account = core_models.User.objects.get(username=\"admin@test.com\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        data = {",
            "            \"resources\": [",
            "                {\"name\": \"mailboxes\", \"max_value\": 10},",
            "                {\"name\": \"mailbox_aliases\", \"max_value\": 10}",
            "            ]",
            "        }",
            "        resp = self.client.patch(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        limit = account.userobjectlimit_set.get(name=\"mailboxes\")",
            "        self.assertEqual(limit.max_value, 10)",
            "",
            "    def test_get_with_resources(self):",
            "        account = core_models.User.objects.get(username=\"admin@test.com\")",
            "        url = reverse(\"v2:account-detail\", args=[account.pk])",
            "        resp = self.client.get(url, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()[\"resources\"]), 2)",
            "",
            "",
            "class IdentityViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "",
            "    def test_list(self):",
            "        url = reverse(\"v2:identities-list\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()), 8)",
            "",
            "    def test_import(self):",
            "        f = ContentFile(\"\"\"",
            "account; user1@test.com; toto; User; One; True; SimpleUsers; user1@test.com; 0",
            "account; Truc@test.com; toto; Ren\u00e9; Truc; True; DomainAdmins; truc@test.com; 5; test.com",
            "alias; alias1@test.com; True; user1@test.com",
            "forward; alias2@test.com; True; user1+ext@test.com",
            "forward; fwd1@test.com; True; user@extdomain.com",
            "dlist; dlist@test.com; True; user1@test.com; user@extdomain.com",
            "\"\"\", name=\"identities.csv\")  # NOQA:E501",
            "        self.client.post(",
            "            reverse(\"v2:identities-import-from-csv\"),",
            "            {\"sourcefile\": f, \"crypt_password\": True}",
            "        )",
            "        admin = core_models.User.objects.get(username=\"admin\")",
            "        u1 = core_models.User.objects.get(username=\"user1@test.com\")",
            "        mb1 = u1.mailbox",
            "        self.assertTrue(admin.is_owner(u1))",
            "        self.assertEqual(u1.email, \"user1@test.com\")",
            "        self.assertEqual(u1.first_name, \"User\")",
            "        self.assertEqual(u1.last_name, \"One\")",
            "        self.assertTrue(u1.is_active)",
            "        self.assertEqual(u1.role, \"SimpleUsers\")",
            "        self.assertTrue(mb1.use_domain_quota)",
            "        self.assertEqual(mb1.quota, 0)",
            "        self.assertTrue(admin.is_owner(mb1))",
            "        self.assertEqual(mb1.full_address, \"user1@test.com\")",
            "        self.assertTrue(",
            "            self.client.login(username=\"user1@test.com\", password=\"toto\")",
            "        )",
            "",
            "        da = core_models.User.objects.get(username=\"truc@test.com\")",
            "        damb = da.mailbox",
            "        self.assertEqual(da.first_name, u\"Ren\u00e9\")",
            "        self.assertEqual(da.role, \"DomainAdmins\")",
            "        self.assertEqual(damb.quota, 5)",
            "        self.assertFalse(damb.use_domain_quota)",
            "        self.assertEqual(damb.full_address, \"truc@test.com\")",
            "        dom = models.Domain.objects.get(name=\"test.com\")",
            "        self.assertIn(da, dom.admins)",
            "        u = core_models.User.objects.get(username=\"user@test.com\")",
            "        self.assertTrue(da.can_access(u))",
            "",
            "        al = models.Alias.objects.get(address=\"alias1@test.com\")",
            "        self.assertTrue(",
            "            al.aliasrecipient_set",
            "            .filter(r_mailbox=u1.mailbox).exists()",
            "        )",
            "        self.assertTrue(admin.is_owner(al))",
            "",
            "        fwd = models.Alias.objects.get(address=\"fwd1@test.com\")",
            "        self.assertTrue(",
            "            fwd.aliasrecipient_set",
            "            .filter(",
            "                address=\"user@extdomain.com\", r_mailbox__isnull=True,",
            "                r_alias__isnull=True)",
            "            .exists()",
            "        )",
            "        self.assertTrue(admin.is_owner(fwd))",
            "",
            "        dlist = models.Alias.objects.get(address=\"dlist@test.com\")",
            "        self.assertTrue(",
            "            dlist.aliasrecipient_set",
            "            .filter(r_mailbox=u1.mailbox).exists()",
            "        )",
            "        self.assertTrue(",
            "            dlist.aliasrecipient_set.filter(address=\"user@extdomain.com\")",
            "            .exists()",
            "        )",
            "        self.assertTrue(admin.is_owner(dlist))",
            "",
            "    def test_export(self):",
            "        response = self.client.get(reverse(\"v2:identities-export\"))",
            "        expected_response = \"account,admin,,,,True,SuperAdmins,,\\r\\naccount,admin@test.com,{PLAIN}toto,,,True,DomainAdmins,admin@test.com,10,test.com\\r\\naccount,admin@test2.com,{PLAIN}toto,,,True,DomainAdmins,admin@test2.com,10,test2.com\\r\\naccount,user@test.com,{PLAIN}toto,,,True,SimpleUsers,user@test.com,10\\r\\naccount,user@test2.com,{PLAIN}toto,,,True,SimpleUsers,user@test2.com,10\\r\\nalias,alias@test.com,True,user@test.com\\r\\nalias,forward@test.com,True,user@external.com\\r\\nalias,postmaster@test.com,True,test@truc.fr,toto@titi.com\\r\\n\"  # NOQA:E501",
            "        received_content = force_text(response.content.strip()).split(\"\\r\\n\")",
            "        # Empty admin password because it is hashed using SHA512-CRYPT",
            "        admin_row = received_content[0].split(\",\")",
            "        admin_row[2] = \"\"",
            "        received_content[0] = \",\".join(admin_row)",
            "        self.assertCountEqual(",
            "            expected_response.strip().split(\"\\r\\n\"),",
            "            received_content",
            "        )",
            "",
            "",
            "class AliasViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "",
            "    def test_validate(self):",
            "        url = reverse(\"v2:alias-validate\")",
            "        data = {\"address\": \"alias@unknown.com\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "",
            "        data = {\"address\": \"alias@test.com\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 400)",
            "",
            "        data = {\"address\": \"alias2@test.com\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 204)",
            "",
            "    def test_random_address(self):",
            "        url = reverse(\"v2:alias-random-address\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertIn(\"address\", resp.json())",
            "",
            "",
            "class UserAccountViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "        cls.da = core_models.User.objects.get(username=\"admin@test.com\")",
            "        cls.da_token = Token.objects.create(user=cls.da)",
            "",
            "    def test_forward(self):",
            "        self.client.credentials(",
            "            HTTP_AUTHORIZATION=\"Token \" + self.da_token.key)",
            "        url = reverse(\"v2:account-forward\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertNotIn(\"recipients\", resp.json())",
            "",
            "        data = {\"recipients\": \"user@domain.ext\"}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(self.da.mailbox.aliasrecipient_set.count(), 1)",
            "",
            "        data = {\"recipients\": \"user@domain.ext\", \"keepcopies\": True}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "",
            "        self.assertEqual(",
            "            models.Alias.objects.filter(address=self.da.username).count(),",
            "            2",
            "        )",
            "",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertTrue(resp.json()[\"keepcopies\"])",
            "",
            "        data = {\"keepcopies\": False}",
            "        resp = self.client.post(url, data, format=\"json\")",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(",
            "            models.Alias.objects.filter(address=self.da.username).count(),",
            "            1",
            "        )",
            "",
            "",
            "class AlarmViewSetTestCase(ModoAPITestCase):",
            "",
            "    @classmethod",
            "    def setUpTestData(cls):  # NOQA:N802",
            "        \"\"\"Create test data.\"\"\"",
            "        super().setUpTestData()",
            "        factories.populate_database()",
            "        factories.AlarmFactory(",
            "            domain__name=\"test.com\", mailbox=None, title=\"Test alarm\")",
            "",
            "    def test_list(self):",
            "        url = reverse(\"v2:alarm-list\")",
            "        resp = self.client.get(url)",
            "        self.assertEqual(resp.status_code, 200)",
            "        self.assertEqual(len(resp.json()), 1)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "django.contrib.auth.forms.AdminPasswordChangeForm",
            "modoboa.admin.api.v2.tests.AccountViewSetTestCase.test_validate.data"
        ]
    },
    "modoboa/admin/api/v2/viewsets.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from modoboa.core import models as core_models"
            },
            "1": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from modoboa.lib import renderers as lib_renderers"
            },
            "2": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from modoboa.lib import viewsets as lib_viewsets"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+from modoboa.lib.throttle import GetThrottleViewsetMixin"
            },
            "4": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "5": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " from ... import lib"
            },
            "6": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " from ... import models"
            },
            "7": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": 41,
                "PatchRowcode": "         summary=\"Delete a particular domain\""
            },
            "8": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 42,
                "PatchRowcode": "     ),"
            },
            "9": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 43,
                "PatchRowcode": " )"
            },
            "10": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class DomainViewSet(lib_viewsets.RevisionModelMixin,"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+class DomainViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin,"
            },
            "12": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "                     mixins.ListModelMixin,"
            },
            "13": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "                     mixins.RetrieveModelMixin,"
            },
            "14": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 47,
                "PatchRowcode": "                     mixins.CreateModelMixin,"
            },
            "15": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 161,
                "PatchRowcode": "     filter_backends = (filters.SearchFilter, dj_filters.DjangoFilterBackend)"
            },
            "16": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 162,
                "PatchRowcode": "     filterset_class = AccountFilterSet"
            },
            "17": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": 163,
                "PatchRowcode": " "
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 164,
                "PatchRowcode": "+"
            },
            "19": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": 165,
                "PatchRowcode": "     def get_serializer_class(self):"
            },
            "20": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "         if self.action in [\"create\", \"validate\", \"update\", \"partial_update\"]:"
            },
            "21": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "             return serializers.WritableAccountSerializer"
            },
            "22": {
                "beforePatchRowNumber": 208,
                "afterPatchRowNumber": 210,
                "PatchRowcode": "         return response.Response(status=status.HTTP_204_NO_CONTENT)"
            },
            "23": {
                "beforePatchRowNumber": 209,
                "afterPatchRowNumber": 211,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": 210,
                "afterPatchRowNumber": 212,
                "PatchRowcode": " "
            },
            "25": {
                "beforePatchRowNumber": 211,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class IdentityViewSet(viewsets.ViewSet):"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 213,
                "PatchRowcode": "+class IdentityViewSet(GetThrottleViewsetMixin, viewsets.ViewSet):"
            },
            "27": {
                "beforePatchRowNumber": 212,
                "afterPatchRowNumber": 214,
                "PatchRowcode": "     \"\"\"Viewset for identities.\"\"\""
            },
            "28": {
                "beforePatchRowNumber": 213,
                "afterPatchRowNumber": 215,
                "PatchRowcode": " "
            },
            "29": {
                "beforePatchRowNumber": 214,
                "afterPatchRowNumber": 216,
                "PatchRowcode": "     permission_classes = (permissions.IsAuthenticated, )"
            },
            "30": {
                "beforePatchRowNumber": 270,
                "afterPatchRowNumber": 272,
                "PatchRowcode": "         })"
            },
            "31": {
                "beforePatchRowNumber": 271,
                "afterPatchRowNumber": 273,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 272,
                "afterPatchRowNumber": 274,
                "PatchRowcode": " "
            },
            "33": {
                "beforePatchRowNumber": 273,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class UserAccountViewSet(viewsets.ViewSet):"
            },
            "34": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 275,
                "PatchRowcode": "+class UserAccountViewSet(GetThrottleViewsetMixin, viewsets.ViewSet):"
            },
            "35": {
                "beforePatchRowNumber": 274,
                "afterPatchRowNumber": 276,
                "PatchRowcode": "     \"\"\"Viewset for current user operations.\"\"\""
            },
            "36": {
                "beforePatchRowNumber": 275,
                "afterPatchRowNumber": 277,
                "PatchRowcode": " "
            },
            "37": {
                "beforePatchRowNumber": 276,
                "afterPatchRowNumber": 278,
                "PatchRowcode": "     @action(methods=[\"get\", \"post\"], detail=False)"
            },
            "38": {
                "beforePatchRowNumber": 323,
                "afterPatchRowNumber": 325,
                "PatchRowcode": "         return response.Response(serializer.validated_data)"
            },
            "39": {
                "beforePatchRowNumber": 324,
                "afterPatchRowNumber": 326,
                "PatchRowcode": " "
            },
            "40": {
                "beforePatchRowNumber": 325,
                "afterPatchRowNumber": 327,
                "PatchRowcode": " "
            },
            "41": {
                "beforePatchRowNumber": 326,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class AlarmViewSet(viewsets.ReadOnlyModelViewSet):"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 328,
                "PatchRowcode": "+class AlarmViewSet(GetThrottleViewsetMixin, viewsets.ReadOnlyModelViewSet):"
            },
            "43": {
                "beforePatchRowNumber": 327,
                "afterPatchRowNumber": 329,
                "PatchRowcode": "     \"\"\"Viewset for Alarm.\"\"\""
            },
            "44": {
                "beforePatchRowNumber": 328,
                "afterPatchRowNumber": 330,
                "PatchRowcode": " "
            },
            "45": {
                "beforePatchRowNumber": 329,
                "afterPatchRowNumber": 331,
                "PatchRowcode": "     filter_backends = (filters.OrderingFilter, filters.SearchFilter, )"
            }
        },
        "frontPatchFile": [
            "\"\"\"Admin API v2 viewsets.\"\"\"",
            "",
            "from django.utils.translation import ugettext as _",
            "",
            "from django.contrib.contenttypes.models import ContentType",
            "",
            "from django_filters import rest_framework as dj_filters",
            "from drf_spectacular.utils import extend_schema, extend_schema_view",
            "from rest_framework import (",
            "    filters, mixins, parsers, pagination, permissions, response, status, viewsets",
            ")",
            "from rest_framework.decorators import action",
            "from rest_framework.exceptions import PermissionDenied",
            "",
            "from modoboa.admin.api.v1 import viewsets as v1_viewsets",
            "from modoboa.core import models as core_models",
            "from modoboa.lib import renderers as lib_renderers",
            "from modoboa.lib import viewsets as lib_viewsets",
            "",
            "from ... import lib",
            "from ... import models",
            "from . import serializers",
            "",
            "",
            "@extend_schema_view(",
            "    retrieve=extend_schema(",
            "        description=\"Retrieve a particular domain\",",
            "        summary=\"Retrieve a particular domain\"",
            "    ),",
            "    list=extend_schema(",
            "        description=\"Retrieve a list of domains\",",
            "        summary=\"Retrieve a list of domains\"",
            "    ),",
            "    create=extend_schema(",
            "        description=\"Create a new domain\",",
            "        summary=\"Create a new domain\"",
            "    ),",
            "    delete=extend_schema(",
            "        description=\"Delete a particular domain\",",
            "        summary=\"Delete a particular domain\"",
            "    ),",
            ")",
            "class DomainViewSet(lib_viewsets.RevisionModelMixin,",
            "                    mixins.ListModelMixin,",
            "                    mixins.RetrieveModelMixin,",
            "                    mixins.CreateModelMixin,",
            "                    mixins.UpdateModelMixin,",
            "                    viewsets.GenericViewSet):",
            "    \"\"\"V2 viewset.\"\"\"",
            "",
            "    permission_classes = (",
            "        permissions.IsAuthenticated, permissions.DjangoModelPermissions,",
            "    )",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        return models.Domain.objects.get_for_admin(self.request.user)",
            "",
            "    def get_serializer_class(self, *args, **kwargs):",
            "        if self.action == \"delete\":",
            "            return serializers.DeleteDomainSerializer",
            "        if self.action == \"administrators\":",
            "            return serializers.DomainAdminSerializer",
            "        if self.action in [\"add_administrator\", \"remove_administrator\"]:",
            "            return serializers.SimpleDomainAdminSerializer",
            "        return serializers.DomainSerializer",
            "",
            "    @action(methods=[\"post\"], detail=True)",
            "    def delete(self, request, **kwargs):",
            "        \"\"\"Custom delete method that accepts body arguments.\"\"\"",
            "        domain = self.get_object()",
            "        if not request.user.can_access(domain):",
            "            raise PermissionDenied(_(\"You don't have access to this domain\"))",
            "        mb = getattr(request.user, \"mailbox\", None)",
            "        if mb and mb.domain == domain:",
            "            raise PermissionDenied(_(\"You can't delete your own domain\"))",
            "        serializer = self.get_serializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        domain.delete(request.user, serializer.validated_data[\"keep_folder\"])",
            "        return response.Response(status=status.HTTP_204_NO_CONTENT)",
            "",
            "    @action(methods=[\"get\"], detail=True)",
            "    def administrators(self, request, **kwargs):",
            "        \"\"\"Retrieve all administrators of a domain.\"\"\"",
            "        domain = self.get_object()",
            "        serializer = self.get_serializer(domain.admins, many=True)",
            "        return response.Response(serializer.data)",
            "",
            "    @action(methods=[\"post\"], detail=True, url_path=\"administrators/add\")",
            "    def add_administrator(self, request, **kwargs):",
            "        \"\"\"Add an administrator to a domain.\"\"\"",
            "        domain = self.get_object()",
            "        context = self.get_serializer_context()",
            "        context[\"domain\"] = domain",
            "        serializer = self.get_serializer(data=request.data, context=context)",
            "        serializer.is_valid(raise_exception=True)",
            "        domain.add_admin(serializer.validated_data[\"account\"])",
            "        return response.Response()",
            "",
            "    @action(methods=[\"post\"], detail=True, url_path=\"administrators/remove\")",
            "    def remove_administrator(self, request, **kwargs):",
            "        \"\"\"Remove an administrator from a domain.\"\"\"",
            "        domain = self.get_object()",
            "        context = self.get_serializer_context()",
            "        context[\"domain\"] = domain",
            "        serializer = self.get_serializer(data=request.data, context=context)",
            "        serializer.is_valid(raise_exception=True)",
            "        domain.remove_admin(serializer.validated_data[\"account\"])",
            "        return response.Response()",
            "",
            "    @action(methods=[\"get\"], detail=False,",
            "            renderer_classes=(lib_renderers.CSVRenderer,))",
            "    def export(self, request, **kwargs):",
            "        \"\"\"Export domains and aliases to CSV.\"\"\"",
            "        result = []",
            "        for domain in self.get_queryset():",
            "            result += domain.to_csv_rows()",
            "        return response.Response(result)",
            "",
            "    @extend_schema(",
            "        request=serializers.CSVImportSerializer",
            "    )",
            "    @action(methods=[\"post\"],",
            "            detail=False,",
            "            parser_classes=(parsers.MultiPartParser, parsers.FormParser),",
            "            url_path=\"import\")",
            "    def import_from_csv(self, request, **kwargs):",
            "        \"\"\"Import domains and aliases from CSV file.\"\"\"",
            "        serializer = serializers.CSVImportSerializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        status, msg = lib.import_data(",
            "            request.user,",
            "            request.FILES[\"sourcefile\"],",
            "            serializer.validated_data",
            "        )",
            "        return response.Response({\"status\": status, \"message\": msg})",
            "",
            "",
            "class AccountFilterSet(dj_filters.FilterSet):",
            "    \"\"\"Custom FilterSet for Account.\"\"\"",
            "",
            "    domain = dj_filters.ModelChoiceFilter(",
            "        queryset=lambda request: models.Domain.objects.get_for_admin(",
            "            request.user),",
            "        field_name=\"mailbox__domain\"",
            "    )",
            "    role = dj_filters.CharFilter(method=\"filter_role\")",
            "",
            "    class Meta:",
            "        model = core_models.User",
            "        fields = [\"domain\", \"role\"]",
            "",
            "    def filter_role(self, queryset, name, value):",
            "        return queryset.filter(groups__name=value)",
            "",
            "",
            "class AccountViewSet(v1_viewsets.AccountViewSet):",
            "    \"\"\"ViewSet for User/Mailbox.\"\"\"",
            "",
            "    filter_backends = (filters.SearchFilter, dj_filters.DjangoFilterBackend)",
            "    filterset_class = AccountFilterSet",
            "",
            "    def get_serializer_class(self):",
            "        if self.action in [\"create\", \"validate\", \"update\", \"partial_update\"]:",
            "            return serializers.WritableAccountSerializer",
            "        if self.action == \"delete\":",
            "            return serializers.DeleteAccountSerializer",
            "        if self.action in [\"list\", \"retrieve\"]:",
            "            return serializers.AccountSerializer",
            "        return super().get_serializer_class()",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        ids = (",
            "            user.objectaccess_set",
            "            .filter(content_type=ContentType.objects.get_for_model(user))",
            "            .values_list(\"object_id\", flat=True)",
            "        )",
            "        return (",
            "            core_models.User.objects.filter(pk__in=ids)",
            "            .prefetch_related(\"userobjectlimit_set\")",
            "        )",
            "",
            "    @action(methods=[\"post\"], detail=False)",
            "    def validate(self, request, **kwargs):",
            "        \"\"\"Validate given account without creating it.\"\"\"",
            "        serializer = self.get_serializer(",
            "            data=request.data,",
            "            context=self.get_serializer_context(),",
            "            partial=True)",
            "        serializer.is_valid(raise_exception=True)",
            "        return response.Response(status=204)",
            "",
            "    @action(methods=[\"get\"], detail=False)",
            "    def random_password(self, request, **kwargs):",
            "        \"\"\"Generate a random password.\"\"\"",
            "        password = lib.make_password()",
            "        return response.Response({\"password\": password})",
            "",
            "    @action(methods=[\"post\"], detail=True)",
            "    def delete(self, request, **kwargs):",
            "        \"\"\"Custom delete method that accepts body arguments.\"\"\"",
            "        account = self.get_object()",
            "        serializer = self.get_serializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        account.delete()",
            "        return response.Response(status=status.HTTP_204_NO_CONTENT)",
            "",
            "",
            "class IdentityViewSet(viewsets.ViewSet):",
            "    \"\"\"Viewset for identities.\"\"\"",
            "",
            "    permission_classes = (permissions.IsAuthenticated, )",
            "    serializer_class = None",
            "",
            "    def list(self, request, **kwargs):",
            "        \"\"\"Return all identities.\"\"\"",
            "        serializer = serializers.IdentitySerializer(",
            "            lib.get_identities(request.user), many=True)",
            "        return response.Response(serializer.data)",
            "",
            "    @action(methods=[\"get\"], detail=False,",
            "            renderer_classes=(lib_renderers.CSVRenderer,))",
            "    def export(self, request, **kwargs):",
            "        \"\"\"Export accounts and aliases to CSV.\"\"\"",
            "        result = []",
            "        for idt in lib.get_identities(request.user):",
            "            result.append(idt.to_csv_row())",
            "        return response.Response(result)",
            "",
            "    @extend_schema(",
            "        request=serializers.CSVIdentityImportSerializer",
            "    )",
            "    @action(methods=[\"post\"],",
            "            detail=False,",
            "            parser_classes=(parsers.MultiPartParser, parsers.FormParser),",
            "            url_path=\"import\")",
            "    def import_from_csv(self, request, **kwargs):",
            "        \"\"\"Import accounts and aliases from CSV file.\"\"\"",
            "        serializer = serializers.CSVIdentityImportSerializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        status, msg = lib.import_data(",
            "            request.user,",
            "            request.FILES[\"sourcefile\"],",
            "            serializer.validated_data",
            "        )",
            "        return response.Response({\"status\": status, \"message\": msg})",
            "",
            "",
            "class AliasViewSet(v1_viewsets.AliasViewSet):",
            "    \"\"\"Viewset for Alias.\"\"\"",
            "",
            "    serializer_class = serializers.AliasSerializer",
            "",
            "    @action(methods=[\"post\"], detail=False)",
            "    def validate(self, request, **kwargs):",
            "        \"\"\"Validate given alias without creating it.\"\"\"",
            "        serializer = self.get_serializer(",
            "            data=request.data,",
            "            context=self.get_serializer_context(),",
            "            partial=True)",
            "        serializer.is_valid(raise_exception=True)",
            "        return response.Response(status=204)",
            "",
            "    @action(methods=[\"get\"], detail=False)",
            "    def random_address(self, request, **kwargs):",
            "        return response.Response({",
            "            \"address\": models.Alias.generate_random_address()",
            "        })",
            "",
            "",
            "class UserAccountViewSet(viewsets.ViewSet):",
            "    \"\"\"Viewset for current user operations.\"\"\"",
            "",
            "    @action(methods=[\"get\", \"post\"], detail=False)",
            "    def forward(self, request, **kwargs):",
            "        \"\"\"Get or define user forward.\"\"\"",
            "        mb = request.user.mailbox",
            "        alias = models.Alias.objects.filter(",
            "            address=mb.full_address, internal=False).first()",
            "        data = {}",
            "        if request.method == \"GET\":",
            "            if alias is not None and alias.recipients:",
            "                recipients = list(alias.recipients)",
            "                if alias.aliasrecipient_set.filter(r_mailbox=mb).exists():",
            "                    data[\"keepcopies\"] = True",
            "                    recipients.remove(mb.full_address)",
            "                data[\"recipients\"] = \"\\n\".join(recipients)",
            "            serializer = serializers.UserForwardSerializer(data)",
            "            return response.Response(serializer.data)",
            "        serializer = serializers.UserForwardSerializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        recipients = serializer.validated_data.get(\"recipients\")",
            "        if not recipients:",
            "            models.Alias.objects.filter(",
            "                address=mb.full_address, internal=False).delete()",
            "            # Make sure internal self-alias is enabled",
            "            models.Alias.objects.filter(",
            "                address=mb.full_address, internal=True",
            "            ).update(enabled=True)",
            "        else:",
            "            if alias is None:",
            "                alias = models.Alias.objects.create(",
            "                    address=mb.full_address,",
            "                    domain=mb.domain,",
            "                    enabled=mb.user.is_active",
            "                )",
            "                alias.post_create(request.user)",
            "            if serializer.validated_data[\"keepcopies\"]:",
            "                # Make sure internal self-alias is enabled",
            "                models.Alias.objects.filter(",
            "                    address=mb.full_address, internal=True",
            "                ).update(enabled=True)",
            "                recipients.append(mb.full_address)",
            "            else:",
            "                # Deactivate internal self-alias to avoid storing",
            "                # local copies...",
            "                models.Alias.objects.filter(",
            "                    address=mb.full_address, internal=True",
            "                ).update(enabled=False)",
            "            alias.set_recipients(recipients)",
            "        return response.Response(serializer.validated_data)",
            "",
            "",
            "class AlarmViewSet(viewsets.ReadOnlyModelViewSet):",
            "    \"\"\"Viewset for Alarm.\"\"\"",
            "",
            "    filter_backends = (filters.OrderingFilter, filters.SearchFilter, )",
            "    ordering_fields = [\"created\", \"status\", \"title\"]",
            "    pagination_class = pagination.PageNumberPagination",
            "    permission_classes = (",
            "        permissions.IsAuthenticated,",
            "    )",
            "    search_fields = [\"domain__name\", \"title\"]",
            "    serializer_class = serializers.AlarmSerializer",
            "",
            "    def get_queryset(self):",
            "        return models.Alarm.objects.select_related(\"domain\").filter(",
            "            domain__in=models.Domain.objects.get_for_admin(",
            "                self.request.user)",
            "        ).order_by(\"-created\")"
        ],
        "afterPatchFile": [
            "\"\"\"Admin API v2 viewsets.\"\"\"",
            "",
            "from django.utils.translation import ugettext as _",
            "",
            "from django.contrib.contenttypes.models import ContentType",
            "",
            "from django_filters import rest_framework as dj_filters",
            "from drf_spectacular.utils import extend_schema, extend_schema_view",
            "from rest_framework import (",
            "    filters, mixins, parsers, pagination, permissions, response, status, viewsets",
            ")",
            "from rest_framework.decorators import action",
            "from rest_framework.exceptions import PermissionDenied",
            "",
            "from modoboa.admin.api.v1 import viewsets as v1_viewsets",
            "from modoboa.core import models as core_models",
            "from modoboa.lib import renderers as lib_renderers",
            "from modoboa.lib import viewsets as lib_viewsets",
            "from modoboa.lib.throttle import GetThrottleViewsetMixin",
            "",
            "from ... import lib",
            "from ... import models",
            "from . import serializers",
            "",
            "",
            "@extend_schema_view(",
            "    retrieve=extend_schema(",
            "        description=\"Retrieve a particular domain\",",
            "        summary=\"Retrieve a particular domain\"",
            "    ),",
            "    list=extend_schema(",
            "        description=\"Retrieve a list of domains\",",
            "        summary=\"Retrieve a list of domains\"",
            "    ),",
            "    create=extend_schema(",
            "        description=\"Create a new domain\",",
            "        summary=\"Create a new domain\"",
            "    ),",
            "    delete=extend_schema(",
            "        description=\"Delete a particular domain\",",
            "        summary=\"Delete a particular domain\"",
            "    ),",
            ")",
            "class DomainViewSet(GetThrottleViewsetMixin, lib_viewsets.RevisionModelMixin,",
            "                    mixins.ListModelMixin,",
            "                    mixins.RetrieveModelMixin,",
            "                    mixins.CreateModelMixin,",
            "                    mixins.UpdateModelMixin,",
            "                    viewsets.GenericViewSet):",
            "    \"\"\"V2 viewset.\"\"\"",
            "",
            "    permission_classes = (",
            "        permissions.IsAuthenticated, permissions.DjangoModelPermissions,",
            "    )",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        return models.Domain.objects.get_for_admin(self.request.user)",
            "",
            "    def get_serializer_class(self, *args, **kwargs):",
            "        if self.action == \"delete\":",
            "            return serializers.DeleteDomainSerializer",
            "        if self.action == \"administrators\":",
            "            return serializers.DomainAdminSerializer",
            "        if self.action in [\"add_administrator\", \"remove_administrator\"]:",
            "            return serializers.SimpleDomainAdminSerializer",
            "        return serializers.DomainSerializer",
            "",
            "    @action(methods=[\"post\"], detail=True)",
            "    def delete(self, request, **kwargs):",
            "        \"\"\"Custom delete method that accepts body arguments.\"\"\"",
            "        domain = self.get_object()",
            "        if not request.user.can_access(domain):",
            "            raise PermissionDenied(_(\"You don't have access to this domain\"))",
            "        mb = getattr(request.user, \"mailbox\", None)",
            "        if mb and mb.domain == domain:",
            "            raise PermissionDenied(_(\"You can't delete your own domain\"))",
            "        serializer = self.get_serializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        domain.delete(request.user, serializer.validated_data[\"keep_folder\"])",
            "        return response.Response(status=status.HTTP_204_NO_CONTENT)",
            "",
            "    @action(methods=[\"get\"], detail=True)",
            "    def administrators(self, request, **kwargs):",
            "        \"\"\"Retrieve all administrators of a domain.\"\"\"",
            "        domain = self.get_object()",
            "        serializer = self.get_serializer(domain.admins, many=True)",
            "        return response.Response(serializer.data)",
            "",
            "    @action(methods=[\"post\"], detail=True, url_path=\"administrators/add\")",
            "    def add_administrator(self, request, **kwargs):",
            "        \"\"\"Add an administrator to a domain.\"\"\"",
            "        domain = self.get_object()",
            "        context = self.get_serializer_context()",
            "        context[\"domain\"] = domain",
            "        serializer = self.get_serializer(data=request.data, context=context)",
            "        serializer.is_valid(raise_exception=True)",
            "        domain.add_admin(serializer.validated_data[\"account\"])",
            "        return response.Response()",
            "",
            "    @action(methods=[\"post\"], detail=True, url_path=\"administrators/remove\")",
            "    def remove_administrator(self, request, **kwargs):",
            "        \"\"\"Remove an administrator from a domain.\"\"\"",
            "        domain = self.get_object()",
            "        context = self.get_serializer_context()",
            "        context[\"domain\"] = domain",
            "        serializer = self.get_serializer(data=request.data, context=context)",
            "        serializer.is_valid(raise_exception=True)",
            "        domain.remove_admin(serializer.validated_data[\"account\"])",
            "        return response.Response()",
            "",
            "    @action(methods=[\"get\"], detail=False,",
            "            renderer_classes=(lib_renderers.CSVRenderer,))",
            "    def export(self, request, **kwargs):",
            "        \"\"\"Export domains and aliases to CSV.\"\"\"",
            "        result = []",
            "        for domain in self.get_queryset():",
            "            result += domain.to_csv_rows()",
            "        return response.Response(result)",
            "",
            "    @extend_schema(",
            "        request=serializers.CSVImportSerializer",
            "    )",
            "    @action(methods=[\"post\"],",
            "            detail=False,",
            "            parser_classes=(parsers.MultiPartParser, parsers.FormParser),",
            "            url_path=\"import\")",
            "    def import_from_csv(self, request, **kwargs):",
            "        \"\"\"Import domains and aliases from CSV file.\"\"\"",
            "        serializer = serializers.CSVImportSerializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        status, msg = lib.import_data(",
            "            request.user,",
            "            request.FILES[\"sourcefile\"],",
            "            serializer.validated_data",
            "        )",
            "        return response.Response({\"status\": status, \"message\": msg})",
            "",
            "",
            "class AccountFilterSet(dj_filters.FilterSet):",
            "    \"\"\"Custom FilterSet for Account.\"\"\"",
            "",
            "    domain = dj_filters.ModelChoiceFilter(",
            "        queryset=lambda request: models.Domain.objects.get_for_admin(",
            "            request.user),",
            "        field_name=\"mailbox__domain\"",
            "    )",
            "    role = dj_filters.CharFilter(method=\"filter_role\")",
            "",
            "    class Meta:",
            "        model = core_models.User",
            "        fields = [\"domain\", \"role\"]",
            "",
            "    def filter_role(self, queryset, name, value):",
            "        return queryset.filter(groups__name=value)",
            "",
            "",
            "class AccountViewSet(v1_viewsets.AccountViewSet):",
            "    \"\"\"ViewSet for User/Mailbox.\"\"\"",
            "",
            "    filter_backends = (filters.SearchFilter, dj_filters.DjangoFilterBackend)",
            "    filterset_class = AccountFilterSet",
            "",
            "",
            "    def get_serializer_class(self):",
            "        if self.action in [\"create\", \"validate\", \"update\", \"partial_update\"]:",
            "            return serializers.WritableAccountSerializer",
            "        if self.action == \"delete\":",
            "            return serializers.DeleteAccountSerializer",
            "        if self.action in [\"list\", \"retrieve\"]:",
            "            return serializers.AccountSerializer",
            "        return super().get_serializer_class()",
            "",
            "    def get_queryset(self):",
            "        \"\"\"Filter queryset based on current user.\"\"\"",
            "        user = self.request.user",
            "        ids = (",
            "            user.objectaccess_set",
            "            .filter(content_type=ContentType.objects.get_for_model(user))",
            "            .values_list(\"object_id\", flat=True)",
            "        )",
            "        return (",
            "            core_models.User.objects.filter(pk__in=ids)",
            "            .prefetch_related(\"userobjectlimit_set\")",
            "        )",
            "",
            "    @action(methods=[\"post\"], detail=False)",
            "    def validate(self, request, **kwargs):",
            "        \"\"\"Validate given account without creating it.\"\"\"",
            "        serializer = self.get_serializer(",
            "            data=request.data,",
            "            context=self.get_serializer_context(),",
            "            partial=True)",
            "        serializer.is_valid(raise_exception=True)",
            "        return response.Response(status=204)",
            "",
            "    @action(methods=[\"get\"], detail=False)",
            "    def random_password(self, request, **kwargs):",
            "        \"\"\"Generate a random password.\"\"\"",
            "        password = lib.make_password()",
            "        return response.Response({\"password\": password})",
            "",
            "    @action(methods=[\"post\"], detail=True)",
            "    def delete(self, request, **kwargs):",
            "        \"\"\"Custom delete method that accepts body arguments.\"\"\"",
            "        account = self.get_object()",
            "        serializer = self.get_serializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        account.delete()",
            "        return response.Response(status=status.HTTP_204_NO_CONTENT)",
            "",
            "",
            "class IdentityViewSet(GetThrottleViewsetMixin, viewsets.ViewSet):",
            "    \"\"\"Viewset for identities.\"\"\"",
            "",
            "    permission_classes = (permissions.IsAuthenticated, )",
            "    serializer_class = None",
            "",
            "    def list(self, request, **kwargs):",
            "        \"\"\"Return all identities.\"\"\"",
            "        serializer = serializers.IdentitySerializer(",
            "            lib.get_identities(request.user), many=True)",
            "        return response.Response(serializer.data)",
            "",
            "    @action(methods=[\"get\"], detail=False,",
            "            renderer_classes=(lib_renderers.CSVRenderer,))",
            "    def export(self, request, **kwargs):",
            "        \"\"\"Export accounts and aliases to CSV.\"\"\"",
            "        result = []",
            "        for idt in lib.get_identities(request.user):",
            "            result.append(idt.to_csv_row())",
            "        return response.Response(result)",
            "",
            "    @extend_schema(",
            "        request=serializers.CSVIdentityImportSerializer",
            "    )",
            "    @action(methods=[\"post\"],",
            "            detail=False,",
            "            parser_classes=(parsers.MultiPartParser, parsers.FormParser),",
            "            url_path=\"import\")",
            "    def import_from_csv(self, request, **kwargs):",
            "        \"\"\"Import accounts and aliases from CSV file.\"\"\"",
            "        serializer = serializers.CSVIdentityImportSerializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        status, msg = lib.import_data(",
            "            request.user,",
            "            request.FILES[\"sourcefile\"],",
            "            serializer.validated_data",
            "        )",
            "        return response.Response({\"status\": status, \"message\": msg})",
            "",
            "",
            "class AliasViewSet(v1_viewsets.AliasViewSet):",
            "    \"\"\"Viewset for Alias.\"\"\"",
            "",
            "    serializer_class = serializers.AliasSerializer",
            "",
            "    @action(methods=[\"post\"], detail=False)",
            "    def validate(self, request, **kwargs):",
            "        \"\"\"Validate given alias without creating it.\"\"\"",
            "        serializer = self.get_serializer(",
            "            data=request.data,",
            "            context=self.get_serializer_context(),",
            "            partial=True)",
            "        serializer.is_valid(raise_exception=True)",
            "        return response.Response(status=204)",
            "",
            "    @action(methods=[\"get\"], detail=False)",
            "    def random_address(self, request, **kwargs):",
            "        return response.Response({",
            "            \"address\": models.Alias.generate_random_address()",
            "        })",
            "",
            "",
            "class UserAccountViewSet(GetThrottleViewsetMixin, viewsets.ViewSet):",
            "    \"\"\"Viewset for current user operations.\"\"\"",
            "",
            "    @action(methods=[\"get\", \"post\"], detail=False)",
            "    def forward(self, request, **kwargs):",
            "        \"\"\"Get or define user forward.\"\"\"",
            "        mb = request.user.mailbox",
            "        alias = models.Alias.objects.filter(",
            "            address=mb.full_address, internal=False).first()",
            "        data = {}",
            "        if request.method == \"GET\":",
            "            if alias is not None and alias.recipients:",
            "                recipients = list(alias.recipients)",
            "                if alias.aliasrecipient_set.filter(r_mailbox=mb).exists():",
            "                    data[\"keepcopies\"] = True",
            "                    recipients.remove(mb.full_address)",
            "                data[\"recipients\"] = \"\\n\".join(recipients)",
            "            serializer = serializers.UserForwardSerializer(data)",
            "            return response.Response(serializer.data)",
            "        serializer = serializers.UserForwardSerializer(data=request.data)",
            "        serializer.is_valid(raise_exception=True)",
            "        recipients = serializer.validated_data.get(\"recipients\")",
            "        if not recipients:",
            "            models.Alias.objects.filter(",
            "                address=mb.full_address, internal=False).delete()",
            "            # Make sure internal self-alias is enabled",
            "            models.Alias.objects.filter(",
            "                address=mb.full_address, internal=True",
            "            ).update(enabled=True)",
            "        else:",
            "            if alias is None:",
            "                alias = models.Alias.objects.create(",
            "                    address=mb.full_address,",
            "                    domain=mb.domain,",
            "                    enabled=mb.user.is_active",
            "                )",
            "                alias.post_create(request.user)",
            "            if serializer.validated_data[\"keepcopies\"]:",
            "                # Make sure internal self-alias is enabled",
            "                models.Alias.objects.filter(",
            "                    address=mb.full_address, internal=True",
            "                ).update(enabled=True)",
            "                recipients.append(mb.full_address)",
            "            else:",
            "                # Deactivate internal self-alias to avoid storing",
            "                # local copies...",
            "                models.Alias.objects.filter(",
            "                    address=mb.full_address, internal=True",
            "                ).update(enabled=False)",
            "            alias.set_recipients(recipients)",
            "        return response.Response(serializer.validated_data)",
            "",
            "",
            "class AlarmViewSet(GetThrottleViewsetMixin, viewsets.ReadOnlyModelViewSet):",
            "    \"\"\"Viewset for Alarm.\"\"\"",
            "",
            "    filter_backends = (filters.OrderingFilter, filters.SearchFilter, )",
            "    ordering_fields = [\"created\", \"status\", \"title\"]",
            "    pagination_class = pagination.PageNumberPagination",
            "    permission_classes = (",
            "        permissions.IsAuthenticated,",
            "    )",
            "    search_fields = [\"domain__name\", \"title\"]",
            "    serializer_class = serializers.AlarmSerializer",
            "",
            "    def get_queryset(self):",
            "        return models.Alarm.objects.select_related(\"domain\").filter(",
            "            domain__in=models.Domain.objects.get_for_admin(",
            "                self.request.user)",
            "        ).order_by(\"-created\")"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "43": [
                "DomainViewSet"
            ],
            "211": [
                "IdentityViewSet"
            ],
            "273": [
                "UserAccountViewSet"
            ],
            "326": [
                "AlarmViewSet"
            ]
        },
        "addLocation": []
    },
    "modoboa/core/api/v1/viewsets.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 5,
                "afterPatchRowNumber": 5,
                "PatchRowcode": " import django_otp"
            },
            "1": {
                "beforePatchRowNumber": 6,
                "afterPatchRowNumber": 6,
                "PatchRowcode": " from django_otp.plugins.otp_static.models import StaticDevice, StaticToken"
            },
            "2": {
                "beforePatchRowNumber": 7,
                "afterPatchRowNumber": 7,
                "PatchRowcode": " from django_otp.plugins.otp_totp.models import TOTPDevice"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 8,
                "PatchRowcode": "+"
            },
            "4": {
                "beforePatchRowNumber": 8,
                "afterPatchRowNumber": 9,
                "PatchRowcode": " from rest_framework import permissions, response, viewsets"
            },
            "5": {
                "beforePatchRowNumber": 9,
                "afterPatchRowNumber": 10,
                "PatchRowcode": " from rest_framework.decorators import action"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 11,
                "PatchRowcode": "+"
            },
            "7": {
                "beforePatchRowNumber": 10,
                "afterPatchRowNumber": 12,
                "PatchRowcode": " from drf_spectacular.utils import extend_schema"
            },
            "8": {
                "beforePatchRowNumber": 11,
                "afterPatchRowNumber": 13,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 14,
                "PatchRowcode": "+from modoboa.lib.throttle import GetThrottleViewsetMixin"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 15,
                "PatchRowcode": "+"
            },
            "11": {
                "beforePatchRowNumber": 12,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " from . import serializers"
            },
            "12": {
                "beforePatchRowNumber": 13,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " "
            },
            "13": {
                "beforePatchRowNumber": 14,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " "
            },
            "14": {
                "beforePatchRowNumber": 15,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-class AccountViewSet(viewsets.ViewSet):"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+class AccountViewSet(GetThrottleViewsetMixin, viewsets.ViewSet):"
            },
            "16": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 20,
                "PatchRowcode": "     \"\"\"Account viewset."
            },
            "17": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " "
            },
            "18": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 22,
                "PatchRowcode": "     Contains endpoints used to manipulate current user's account."
            }
        },
        "frontPatchFile": [
            "\"\"\"Core API viewsets.\"\"\"",
            "",
            "from django.utils.translation import ugettext as _",
            "",
            "import django_otp",
            "from django_otp.plugins.otp_static.models import StaticDevice, StaticToken",
            "from django_otp.plugins.otp_totp.models import TOTPDevice",
            "from rest_framework import permissions, response, viewsets",
            "from rest_framework.decorators import action",
            "from drf_spectacular.utils import extend_schema",
            "",
            "from . import serializers",
            "",
            "",
            "class AccountViewSet(viewsets.ViewSet):",
            "    \"\"\"Account viewset.",
            "",
            "    Contains endpoints used to manipulate current user's account.",
            "    \"\"\"",
            "",
            "    permission_classes = (permissions.IsAuthenticated, )",
            "    serializer_class = None",
            "",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/setup\")",
            "    def tfa_setup(self, request):",
            "        \"\"\"Initiate TFA setup.\"\"\"",
            "        instance, created = TOTPDevice.objects.get_or_create(",
            "            user=request.user,",
            "            defaults={\"name\": \"{} TOTP device\".format(request.user)}",
            "        )",
            "        return response.Response()",
            "",
            "    @extend_schema(",
            "        request=serializers.CheckTFASetupSerializer",
            "    )",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/setup/check\")",
            "    def tfa_setup_check(self, request):",
            "        \"\"\"Check TFA setup.\"\"\"",
            "        serializer = serializers.CheckTFASetupSerializer(",
            "            data=request.data, context={\"user\": request.user})",
            "        serializer.is_valid(raise_exception=True)",
            "        # create static device for recovery purposes",
            "        device = StaticDevice.objects.create(",
            "            user=request.user,",
            "            name=\"{} static device\".format(request.user)",
            "        )",
            "        for cpt in range(10):",
            "            token = StaticToken.random_token()",
            "            device.token_set.create(token=token)",
            "        django_otp.login(self.request, request.user.totpdevice_set.first())",
            "        return response.Response()",
            "",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/disable\")",
            "    def tfa_disable(self, request):",
            "        \"\"\"Disable TFA.\"\"\"",
            "        if not request.user.tfa_enabled:",
            "            return response.Response({\"error\": _(\"2FA is not enabled\")},",
            "                                     status=400)",
            "        request.user.totpdevice_set.all().delete()",
            "        request.user.staticdevice_set.all().delete()",
            "        request.user.tfa_enabled = False",
            "        request.user.save()",
            "        return response.Response()",
            "",
            "    @extend_schema(tags=['account'])",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/reset_codes\")",
            "    def tfa_reset_codes(self, request, *args, **kwargs):",
            "        \"\"\"Reset recovery codes.\"\"\"",
            "        device = request.user.staticdevice_set.first()",
            "        if device is None:",
            "            return response.Response(status=403)",
            "        device.token_set.all().delete()",
            "        for cpt in range(10):",
            "            token = StaticToken.random_token()",
            "            device.token_set.create(token=token)",
            "        return response.Response({",
            "            \"tokens\": device.token_set.all().values_list(\"token\", flat=True)",
            "        })"
        ],
        "afterPatchFile": [
            "\"\"\"Core API viewsets.\"\"\"",
            "",
            "from django.utils.translation import ugettext as _",
            "",
            "import django_otp",
            "from django_otp.plugins.otp_static.models import StaticDevice, StaticToken",
            "from django_otp.plugins.otp_totp.models import TOTPDevice",
            "",
            "from rest_framework import permissions, response, viewsets",
            "from rest_framework.decorators import action",
            "",
            "from drf_spectacular.utils import extend_schema",
            "",
            "from modoboa.lib.throttle import GetThrottleViewsetMixin",
            "",
            "from . import serializers",
            "",
            "",
            "class AccountViewSet(GetThrottleViewsetMixin, viewsets.ViewSet):",
            "    \"\"\"Account viewset.",
            "",
            "    Contains endpoints used to manipulate current user's account.",
            "    \"\"\"",
            "",
            "    permission_classes = (permissions.IsAuthenticated, )",
            "    serializer_class = None",
            "",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/setup\")",
            "    def tfa_setup(self, request):",
            "        \"\"\"Initiate TFA setup.\"\"\"",
            "        instance, created = TOTPDevice.objects.get_or_create(",
            "            user=request.user,",
            "            defaults={\"name\": \"{} TOTP device\".format(request.user)}",
            "        )",
            "        return response.Response()",
            "",
            "    @extend_schema(",
            "        request=serializers.CheckTFASetupSerializer",
            "    )",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/setup/check\")",
            "    def tfa_setup_check(self, request):",
            "        \"\"\"Check TFA setup.\"\"\"",
            "        serializer = serializers.CheckTFASetupSerializer(",
            "            data=request.data, context={\"user\": request.user})",
            "        serializer.is_valid(raise_exception=True)",
            "        # create static device for recovery purposes",
            "        device = StaticDevice.objects.create(",
            "            user=request.user,",
            "            name=\"{} static device\".format(request.user)",
            "        )",
            "        for cpt in range(10):",
            "            token = StaticToken.random_token()",
            "            device.token_set.create(token=token)",
            "        django_otp.login(self.request, request.user.totpdevice_set.first())",
            "        return response.Response()",
            "",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/disable\")",
            "    def tfa_disable(self, request):",
            "        \"\"\"Disable TFA.\"\"\"",
            "        if not request.user.tfa_enabled:",
            "            return response.Response({\"error\": _(\"2FA is not enabled\")},",
            "                                     status=400)",
            "        request.user.totpdevice_set.all().delete()",
            "        request.user.staticdevice_set.all().delete()",
            "        request.user.tfa_enabled = False",
            "        request.user.save()",
            "        return response.Response()",
            "",
            "    @extend_schema(tags=['account'])",
            "    @action(methods=[\"post\"], detail=False, url_path=\"tfa/reset_codes\")",
            "    def tfa_reset_codes(self, request, *args, **kwargs):",
            "        \"\"\"Reset recovery codes.\"\"\"",
            "        device = request.user.staticdevice_set.first()",
            "        if device is None:",
            "            return response.Response(status=403)",
            "        device.token_set.all().delete()",
            "        for cpt in range(10):",
            "            token = StaticToken.random_token()",
            "            device.token_set.create(token=token)",
            "        return response.Response({",
            "            \"tokens\": device.token_set.all().values_list(\"token\", flat=True)",
            "        })"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "15": [
                "AccountViewSet"
            ]
        },
        "addLocation": []
    },
    "modoboa/core/api/v2/views.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 16,
                "afterPatchRowNumber": 16,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 17,
                "afterPatchRowNumber": 17,
                "PatchRowcode": " from modoboa.core.password_hashers import get_password_hasher"
            },
            "2": {
                "beforePatchRowNumber": 18,
                "afterPatchRowNumber": 18,
                "PatchRowcode": " from modoboa.core.utils import check_for_updates"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 19,
                "PatchRowcode": "+from modoboa.lib.throttle import UserLesserDdosUser, LoginThrottle, PasswordResetApplyThrottle, PasswordResetRequestThrottle, PasswordResetTotpThrottle"
            },
            "4": {
                "beforePatchRowNumber": 19,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " from modoboa.parameters import tools as param_tools"
            },
            "5": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " "
            },
            "6": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " from smtplib import SMTPException"
            },
            "7": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " logger = logging.getLogger(\"modoboa.auth\")"
            },
            "8": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 28,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 29,
                "PatchRowcode": "+def delete_cache_key(class_target, throttles, request):"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 30,
                "PatchRowcode": "+    \"\"\"Attempt to delete cache key from throttling on login/password reset success.\"\"\""
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 31,
                "PatchRowcode": "+    "
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 32,
                "PatchRowcode": "+    for throttle in throttles:"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 33,
                "PatchRowcode": "+        if type(throttle) == class_target:"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 34,
                "PatchRowcode": "+            throttle.reset_cache(request)"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 35,
                "PatchRowcode": "+            return"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 36,
                "PatchRowcode": "+"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+"
            },
            "19": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " class TokenObtainPairView(jwt_views.TokenObtainPairView):"
            },
            "20": {
                "beforePatchRowNumber": 29,
                "afterPatchRowNumber": 39,
                "PatchRowcode": "     \"\"\"We overwrite this view to deal with password scheme update.\"\"\""
            },
            "21": {
                "beforePatchRowNumber": 30,
                "afterPatchRowNumber": 40,
                "PatchRowcode": " "
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    throttle_classes = [LoginThrottle]"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+"
            },
            "24": {
                "beforePatchRowNumber": 31,
                "afterPatchRowNumber": 43,
                "PatchRowcode": "     def post(self, request, *args, **kwargs):"
            },
            "25": {
                "beforePatchRowNumber": 32,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "         serializer = self.get_serializer(data=request.data)"
            },
            "26": {
                "beforePatchRowNumber": 33,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "         try:"
            },
            "27": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": 54,
                "PatchRowcode": " "
            },
            "28": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "         user = serializer.user"
            },
            "29": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 56,
                "PatchRowcode": "         login(request, user)"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+        # Reset login throttle"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+        delete_cache_key(LoginThrottle, self.get_throttles(), request)"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+"
            },
            "34": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "         logger.info("
            },
            "35": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "             _(\"User '%s' successfully logged in\"), user.username"
            },
            "36": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "         )"
            },
            "37": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 101,
                "PatchRowcode": "     An Api View which provides a method to request a password reset token based on an e-mail address."
            },
            "38": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 102,
                "PatchRowcode": "     \"\"\""
            },
            "39": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 103,
                "PatchRowcode": " "
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 104,
                "PatchRowcode": "+    throttle_classes = [PasswordResetRequestThrottle]"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 105,
                "PatchRowcode": "+"
            },
            "42": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 106,
                "PatchRowcode": "     def post(self, request, *args, **kwargs):"
            },
            "43": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 107,
                "PatchRowcode": "         serializer = serializers.PasswordRecoveryEmailSerializer("
            },
            "44": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 108,
                "PatchRowcode": "             data=request.data, context={'request': request})"
            },
            "45": {
                "beforePatchRowNumber": 96,
                "afterPatchRowNumber": 114,
                "PatchRowcode": "                 \"type\": \"email\","
            },
            "46": {
                "beforePatchRowNumber": 97,
                "afterPatchRowNumber": 115,
                "PatchRowcode": "                 \"reason\": \"Error while sending the email. Please contact an administrator.\""
            },
            "47": {
                "beforePatchRowNumber": 98,
                "afterPatchRowNumber": 116,
                "PatchRowcode": "             }, 503)"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 117,
                "PatchRowcode": "+"
            },
            "49": {
                "beforePatchRowNumber": 99,
                "afterPatchRowNumber": 118,
                "PatchRowcode": "         # Email response"
            },
            "50": {
                "beforePatchRowNumber": 100,
                "afterPatchRowNumber": 119,
                "PatchRowcode": "         return response.Response({\"type\": \"email\"}, 200)"
            },
            "51": {
                "beforePatchRowNumber": 101,
                "afterPatchRowNumber": 120,
                "PatchRowcode": " "
            },
            "52": {
                "beforePatchRowNumber": 114,
                "afterPatchRowNumber": 133,
                "PatchRowcode": "             serializer.is_valid(raise_exception=True)"
            },
            "53": {
                "beforePatchRowNumber": 115,
                "afterPatchRowNumber": 134,
                "PatchRowcode": "         except serializers.NoSMSAvailable:"
            },
            "54": {
                "beforePatchRowNumber": 116,
                "afterPatchRowNumber": 135,
                "PatchRowcode": "             return super().post(request, *args, **kwargs)"
            },
            "55": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 136,
                "PatchRowcode": "+        "
            },
            "56": {
                "beforePatchRowNumber": 117,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "         # SMS response"
            },
            "57": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 138,
                "PatchRowcode": "         return response.Response({\"type\": \"sms\"}, 200)"
            },
            "58": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 139,
                "PatchRowcode": " "
            },
            "59": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 140,
                "PatchRowcode": " "
            },
            "60": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": 141,
                "PatchRowcode": " class PasswordResetSmsTOTP(APIView):"
            },
            "61": {
                "beforePatchRowNumber": 122,
                "afterPatchRowNumber": 142,
                "PatchRowcode": "     \"\"\" Check SMS Totp code. \"\"\""
            },
            "62": {
                "beforePatchRowNumber": 123,
                "afterPatchRowNumber": 143,
                "PatchRowcode": " "
            },
            "63": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 144,
                "PatchRowcode": "+    throttle_classes = [PasswordResetTotpThrottle]"
            },
            "64": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 145,
                "PatchRowcode": "+"
            },
            "65": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 146,
                "PatchRowcode": "     def post(self, request, *args, **kwargs):"
            },
            "66": {
                "beforePatchRowNumber": 125,
                "afterPatchRowNumber": 147,
                "PatchRowcode": "         try:"
            },
            "67": {
                "beforePatchRowNumber": 126,
                "afterPatchRowNumber": 148,
                "PatchRowcode": "             if request.data[\"type\"] == \"confirm\":"
            },
            "68": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": 162,
                "PatchRowcode": "                 \"id\": serializer_response[1],"
            },
            "69": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": 163,
                "PatchRowcode": "                 \"type\": \"confirm\""
            },
            "70": {
                "beforePatchRowNumber": 142,
                "afterPatchRowNumber": 164,
                "PatchRowcode": "             })"
            },
            "71": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 165,
                "PatchRowcode": "+        delete_cache_key(PasswordResetTotpThrottle, self.get_throttles(), request)"
            },
            "72": {
                "beforePatchRowNumber": 143,
                "afterPatchRowNumber": 166,
                "PatchRowcode": "         return response.Response(payload, 200)"
            },
            "73": {
                "beforePatchRowNumber": 144,
                "afterPatchRowNumber": 167,
                "PatchRowcode": " "
            },
            "74": {
                "beforePatchRowNumber": 145,
                "afterPatchRowNumber": 168,
                "PatchRowcode": " "
            },
            "75": {
                "beforePatchRowNumber": 146,
                "afterPatchRowNumber": 169,
                "PatchRowcode": " class PasswordResetConfirmView(APIView):"
            },
            "76": {
                "beforePatchRowNumber": 147,
                "afterPatchRowNumber": 170,
                "PatchRowcode": "     \"\"\" Get and set new user password. \"\"\""
            },
            "77": {
                "beforePatchRowNumber": 148,
                "afterPatchRowNumber": 171,
                "PatchRowcode": " "
            },
            "78": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 172,
                "PatchRowcode": "+    throttle_classes = [PasswordResetApplyThrottle]"
            },
            "79": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 173,
                "PatchRowcode": "+"
            },
            "80": {
                "beforePatchRowNumber": 149,
                "afterPatchRowNumber": 174,
                "PatchRowcode": "     def post(self, request, *args, **kwargs):"
            },
            "81": {
                "beforePatchRowNumber": 150,
                "afterPatchRowNumber": 175,
                "PatchRowcode": "         serializer = serializers.PasswordRecoveryConfirmSerializer("
            },
            "82": {
                "beforePatchRowNumber": 151,
                "afterPatchRowNumber": 176,
                "PatchRowcode": "             data=request.data)"
            },
            "83": {
                "beforePatchRowNumber": 159,
                "afterPatchRowNumber": 184,
                "PatchRowcode": "             data.update({\"errors\": errors})"
            },
            "84": {
                "beforePatchRowNumber": 160,
                "afterPatchRowNumber": 185,
                "PatchRowcode": "             return response.Response(data, 400)"
            },
            "85": {
                "beforePatchRowNumber": 161,
                "afterPatchRowNumber": 186,
                "PatchRowcode": "         serializer.save()"
            },
            "86": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 187,
                "PatchRowcode": "+        delete_cache_key(PasswordResetApplyThrottle, self.get_throttles(), request)"
            },
            "87": {
                "beforePatchRowNumber": 162,
                "afterPatchRowNumber": 188,
                "PatchRowcode": "         return response.Response(status=200)"
            },
            "88": {
                "beforePatchRowNumber": 163,
                "afterPatchRowNumber": 189,
                "PatchRowcode": " "
            },
            "89": {
                "beforePatchRowNumber": 164,
                "afterPatchRowNumber": 190,
                "PatchRowcode": " "
            },
            "90": {
                "beforePatchRowNumber": 165,
                "afterPatchRowNumber": 191,
                "PatchRowcode": " class ComponentsInformationAPIView(APIView):"
            },
            "91": {
                "beforePatchRowNumber": 166,
                "afterPatchRowNumber": 192,
                "PatchRowcode": "     \"\"\"Retrieve information about installed components.\"\"\""
            },
            "92": {
                "beforePatchRowNumber": 167,
                "afterPatchRowNumber": 193,
                "PatchRowcode": " "
            },
            "93": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 194,
                "PatchRowcode": "+    throttle_classes = [UserLesserDdosUser]"
            },
            "94": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 195,
                "PatchRowcode": "+"
            },
            "95": {
                "beforePatchRowNumber": 168,
                "afterPatchRowNumber": 196,
                "PatchRowcode": "     @extend_schema(responses=serializers.ModoboaComponentSerializer(many=True))"
            },
            "96": {
                "beforePatchRowNumber": 169,
                "afterPatchRowNumber": 197,
                "PatchRowcode": "     def get(self, request, *args, **kwargs):"
            },
            "97": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": 198,
                "PatchRowcode": "         status, extensions = check_for_updates()"
            }
        },
        "frontPatchFile": [
            "\"\"\"Core API v2 views.\"\"\"",
            "",
            "import logging",
            "",
            "from django.utils.html import escape",
            "from django.utils.translation import ugettext as _",
            "from django.utils.datastructures import MultiValueDictKeyError",
            "",
            "from django.contrib.auth import login",
            "",
            "from drf_spectacular.utils import extend_schema",
            "from rest_framework import response, status",
            "from rest_framework_simplejwt import views as jwt_views",
            "from rest_framework_simplejwt.exceptions import InvalidToken, TokenError",
            "from rest_framework.views import APIView",
            "",
            "from modoboa.core.password_hashers import get_password_hasher",
            "from modoboa.core.utils import check_for_updates",
            "from modoboa.parameters import tools as param_tools",
            "",
            "from smtplib import SMTPException",
            "",
            "from . import serializers",
            "",
            "logger = logging.getLogger(\"modoboa.auth\")",
            "",
            "",
            "class TokenObtainPairView(jwt_views.TokenObtainPairView):",
            "    \"\"\"We overwrite this view to deal with password scheme update.\"\"\"",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        serializer = self.get_serializer(data=request.data)",
            "        try:",
            "            serializer.is_valid(raise_exception=True)",
            "        except TokenError as e:",
            "            logger.warning(",
            "                _(\"Failed connection attempt from '%s' as user '%s'\"),",
            "                request.META[\"REMOTE_ADDR\"],",
            "                escape(serializer.data[\"username\"])",
            "            )",
            "            raise InvalidToken(e.args[0])",
            "",
            "        user = serializer.user",
            "        login(request, user)",
            "        logger.info(",
            "            _(\"User '%s' successfully logged in\"), user.username",
            "        )",
            "        if user and user.is_active:",
            "            condition = (",
            "                user.is_local and",
            "                param_tools.get_global_parameter(",
            "                    \"update_scheme\", raise_exception=False)",
            "            )",
            "            if condition:",
            "                # check if password scheme is correct",
            "                scheme = param_tools.get_global_parameter(",
            "                    \"password_scheme\", raise_exception=False)",
            "                # use SHA512CRYPT as default fallback",
            "                if scheme is None:",
            "                    pwhash = get_password_hasher(\"sha512crypt\")()",
            "                else:",
            "                    pwhash = get_password_hasher(scheme)()",
            "                if not user.password.startswith(pwhash.scheme):",
            "                    logger.info(",
            "                        _(\"Password scheme mismatch. Updating %s password\"),",
            "                        user.username",
            "                    )",
            "                    user.set_password(request.data[\"password\"])",
            "                    user.save()",
            "                if pwhash.needs_rehash(user.password):",
            "                    logger.info(",
            "                        _(\"Password hash parameter missmatch. \"",
            "                          \"Updating %s password\"),",
            "                        user.username",
            "                    )",
            "                    user.set_password(serializer.data[\"password\"])",
            "                    user.save()",
            "",
            "        return response.Response(",
            "            serializer.validated_data, status=status.HTTP_200_OK)",
            "",
            "",
            "class EmailPasswordResetView(APIView):",
            "    \"\"\"",
            "    An Api View which provides a method to request a password reset token based on an e-mail address.",
            "    \"\"\"",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        serializer = serializers.PasswordRecoveryEmailSerializer(",
            "            data=request.data, context={'request': request})",
            "        serializer.is_valid(raise_exception=True)",
            "        try:",
            "            serializer.save()",
            "        except SMTPException:",
            "            return response.Response({",
            "                \"type\": \"email\",",
            "                \"reason\": \"Error while sending the email. Please contact an administrator.\"",
            "            }, 503)",
            "        # Email response",
            "        return response.Response({\"type\": \"email\"}, 200)",
            "",
            "",
            "class DefaultPasswordResetView(EmailPasswordResetView):",
            "    \"\"\"",
            "    Works with PasswordRecoveryForm.vue.",
            "    First checks if SMS recovery is available, else switch to super (Email recovery [with secondary email]).",
            "    \"\"\"",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        \"\"\"Recover password.\"\"\"",
            "        serializer = serializers.PasswordRecoverySmsSerializer(",
            "            data=request.data, context={'request': request})",
            "        try:",
            "            serializer.is_valid(raise_exception=True)",
            "        except serializers.NoSMSAvailable:",
            "            return super().post(request, *args, **kwargs)",
            "        # SMS response",
            "        return response.Response({\"type\": \"sms\"}, 200)",
            "",
            "",
            "class PasswordResetSmsTOTP(APIView):",
            "    \"\"\" Check SMS Totp code. \"\"\"",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        try:",
            "            if request.data[\"type\"] == \"confirm\":",
            "                klass = serializers.PasswordRecoverySmsConfirmSerializer",
            "            elif request.data[\"type\"] == \"resend\":",
            "                klass = serializers.PasswordRecoverySmsResendSerializer",
            "            serializer = klass(data=request.data, context={'request': request})",
            "        except (MultiValueDictKeyError, KeyError):",
            "            return response.Response({\"reason\": \"No type provided.\"}, 400)",
            "        serializer.is_valid(raise_exception=True)",
            "        serializer.save()",
            "        payload = {\"type\": \"resend\"}",
            "        if request.data[\"type\"] == \"confirm\":",
            "            serializer_response = serializer.context[\"response\"]",
            "            payload.update({",
            "                \"token\": serializer_response[0],",
            "                \"id\": serializer_response[1],",
            "                \"type\": \"confirm\"",
            "            })",
            "        return response.Response(payload, 200)",
            "",
            "",
            "class PasswordResetConfirmView(APIView):",
            "    \"\"\" Get and set new user password. \"\"\"",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        serializer = serializers.PasswordRecoveryConfirmSerializer(",
            "            data=request.data)",
            "        try:",
            "            serializer.is_valid(raise_exception=True)",
            "        except serializers.PasswordRequirementsFailure as e:",
            "            data = {\"type\": \"password_requirement\"}",
            "            errors = []",
            "            for element in e.message_list:",
            "                errors.append(element)",
            "            data.update({\"errors\": errors})",
            "            return response.Response(data, 400)",
            "        serializer.save()",
            "        return response.Response(status=200)",
            "",
            "",
            "class ComponentsInformationAPIView(APIView):",
            "    \"\"\"Retrieve information about installed components.\"\"\"",
            "",
            "    @extend_schema(responses=serializers.ModoboaComponentSerializer(many=True))",
            "    def get(self, request, *args, **kwargs):",
            "        status, extensions = check_for_updates()",
            "        serializer = serializers.ModoboaComponentSerializer(",
            "            extensions, many=True",
            "        )",
            "        return response.Response(serializer.data)"
        ],
        "afterPatchFile": [
            "\"\"\"Core API v2 views.\"\"\"",
            "",
            "import logging",
            "",
            "from django.utils.html import escape",
            "from django.utils.translation import ugettext as _",
            "from django.utils.datastructures import MultiValueDictKeyError",
            "",
            "from django.contrib.auth import login",
            "",
            "from drf_spectacular.utils import extend_schema",
            "from rest_framework import response, status",
            "from rest_framework_simplejwt import views as jwt_views",
            "from rest_framework_simplejwt.exceptions import InvalidToken, TokenError",
            "from rest_framework.views import APIView",
            "",
            "from modoboa.core.password_hashers import get_password_hasher",
            "from modoboa.core.utils import check_for_updates",
            "from modoboa.lib.throttle import UserLesserDdosUser, LoginThrottle, PasswordResetApplyThrottle, PasswordResetRequestThrottle, PasswordResetTotpThrottle",
            "from modoboa.parameters import tools as param_tools",
            "",
            "from smtplib import SMTPException",
            "",
            "from . import serializers",
            "",
            "logger = logging.getLogger(\"modoboa.auth\")",
            "",
            "",
            "def delete_cache_key(class_target, throttles, request):",
            "    \"\"\"Attempt to delete cache key from throttling on login/password reset success.\"\"\"",
            "    ",
            "    for throttle in throttles:",
            "        if type(throttle) == class_target:",
            "            throttle.reset_cache(request)",
            "            return",
            "",
            "",
            "class TokenObtainPairView(jwt_views.TokenObtainPairView):",
            "    \"\"\"We overwrite this view to deal with password scheme update.\"\"\"",
            "",
            "    throttle_classes = [LoginThrottle]",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        serializer = self.get_serializer(data=request.data)",
            "        try:",
            "            serializer.is_valid(raise_exception=True)",
            "        except TokenError as e:",
            "            logger.warning(",
            "                _(\"Failed connection attempt from '%s' as user '%s'\"),",
            "                request.META[\"REMOTE_ADDR\"],",
            "                escape(serializer.data[\"username\"])",
            "            )",
            "            raise InvalidToken(e.args[0])",
            "",
            "        user = serializer.user",
            "        login(request, user)",
            "",
            "        # Reset login throttle",
            "        delete_cache_key(LoginThrottle, self.get_throttles(), request)",
            "",
            "        logger.info(",
            "            _(\"User '%s' successfully logged in\"), user.username",
            "        )",
            "        if user and user.is_active:",
            "            condition = (",
            "                user.is_local and",
            "                param_tools.get_global_parameter(",
            "                    \"update_scheme\", raise_exception=False)",
            "            )",
            "            if condition:",
            "                # check if password scheme is correct",
            "                scheme = param_tools.get_global_parameter(",
            "                    \"password_scheme\", raise_exception=False)",
            "                # use SHA512CRYPT as default fallback",
            "                if scheme is None:",
            "                    pwhash = get_password_hasher(\"sha512crypt\")()",
            "                else:",
            "                    pwhash = get_password_hasher(scheme)()",
            "                if not user.password.startswith(pwhash.scheme):",
            "                    logger.info(",
            "                        _(\"Password scheme mismatch. Updating %s password\"),",
            "                        user.username",
            "                    )",
            "                    user.set_password(request.data[\"password\"])",
            "                    user.save()",
            "                if pwhash.needs_rehash(user.password):",
            "                    logger.info(",
            "                        _(\"Password hash parameter missmatch. \"",
            "                          \"Updating %s password\"),",
            "                        user.username",
            "                    )",
            "                    user.set_password(serializer.data[\"password\"])",
            "                    user.save()",
            "",
            "        return response.Response(",
            "            serializer.validated_data, status=status.HTTP_200_OK)",
            "",
            "",
            "class EmailPasswordResetView(APIView):",
            "    \"\"\"",
            "    An Api View which provides a method to request a password reset token based on an e-mail address.",
            "    \"\"\"",
            "",
            "    throttle_classes = [PasswordResetRequestThrottle]",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        serializer = serializers.PasswordRecoveryEmailSerializer(",
            "            data=request.data, context={'request': request})",
            "        serializer.is_valid(raise_exception=True)",
            "        try:",
            "            serializer.save()",
            "        except SMTPException:",
            "            return response.Response({",
            "                \"type\": \"email\",",
            "                \"reason\": \"Error while sending the email. Please contact an administrator.\"",
            "            }, 503)",
            "",
            "        # Email response",
            "        return response.Response({\"type\": \"email\"}, 200)",
            "",
            "",
            "class DefaultPasswordResetView(EmailPasswordResetView):",
            "    \"\"\"",
            "    Works with PasswordRecoveryForm.vue.",
            "    First checks if SMS recovery is available, else switch to super (Email recovery [with secondary email]).",
            "    \"\"\"",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        \"\"\"Recover password.\"\"\"",
            "        serializer = serializers.PasswordRecoverySmsSerializer(",
            "            data=request.data, context={'request': request})",
            "        try:",
            "            serializer.is_valid(raise_exception=True)",
            "        except serializers.NoSMSAvailable:",
            "            return super().post(request, *args, **kwargs)",
            "        ",
            "        # SMS response",
            "        return response.Response({\"type\": \"sms\"}, 200)",
            "",
            "",
            "class PasswordResetSmsTOTP(APIView):",
            "    \"\"\" Check SMS Totp code. \"\"\"",
            "",
            "    throttle_classes = [PasswordResetTotpThrottle]",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        try:",
            "            if request.data[\"type\"] == \"confirm\":",
            "                klass = serializers.PasswordRecoverySmsConfirmSerializer",
            "            elif request.data[\"type\"] == \"resend\":",
            "                klass = serializers.PasswordRecoverySmsResendSerializer",
            "            serializer = klass(data=request.data, context={'request': request})",
            "        except (MultiValueDictKeyError, KeyError):",
            "            return response.Response({\"reason\": \"No type provided.\"}, 400)",
            "        serializer.is_valid(raise_exception=True)",
            "        serializer.save()",
            "        payload = {\"type\": \"resend\"}",
            "        if request.data[\"type\"] == \"confirm\":",
            "            serializer_response = serializer.context[\"response\"]",
            "            payload.update({",
            "                \"token\": serializer_response[0],",
            "                \"id\": serializer_response[1],",
            "                \"type\": \"confirm\"",
            "            })",
            "        delete_cache_key(PasswordResetTotpThrottle, self.get_throttles(), request)",
            "        return response.Response(payload, 200)",
            "",
            "",
            "class PasswordResetConfirmView(APIView):",
            "    \"\"\" Get and set new user password. \"\"\"",
            "",
            "    throttle_classes = [PasswordResetApplyThrottle]",
            "",
            "    def post(self, request, *args, **kwargs):",
            "        serializer = serializers.PasswordRecoveryConfirmSerializer(",
            "            data=request.data)",
            "        try:",
            "            serializer.is_valid(raise_exception=True)",
            "        except serializers.PasswordRequirementsFailure as e:",
            "            data = {\"type\": \"password_requirement\"}",
            "            errors = []",
            "            for element in e.message_list:",
            "                errors.append(element)",
            "            data.update({\"errors\": errors})",
            "            return response.Response(data, 400)",
            "        serializer.save()",
            "        delete_cache_key(PasswordResetApplyThrottle, self.get_throttles(), request)",
            "        return response.Response(status=200)",
            "",
            "",
            "class ComponentsInformationAPIView(APIView):",
            "    \"\"\"Retrieve information about installed components.\"\"\"",
            "",
            "    throttle_classes = [UserLesserDdosUser]",
            "",
            "    @extend_schema(responses=serializers.ModoboaComponentSerializer(many=True))",
            "    def get(self, request, *args, **kwargs):",
            "        status, extensions = check_for_updates()",
            "        serializer = serializers.ModoboaComponentSerializer(",
            "            extensions, many=True",
            "        )",
            "        return response.Response(serializer.data)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "modoboa.core.api.v2.views.ComponentsInformationAPIView.self",
            "modoboa.core.api.v2.views",
            "modoboa.core.api.v2.views.PasswordResetConfirmView.post",
            "modoboa.core.api.v2.views.TokenObtainPairView.post",
            "modoboa.core.api.v2.views.PasswordResetSmsTOTP.self",
            "modoboa.core.api.v2.views.PasswordResetSmsTOTP.post",
            "modoboa.core.api.v2.views.PasswordResetConfirmView.post.errors",
            "modoboa.core.api.v2.views.EmailPasswordResetView.self",
            "modoboa.core.api.v2.views.PasswordResetSmsTOTP.post.payload",
            "django.contrib.auth.forms.AdminPasswordChangeForm",
            "modoboa.core.api.v2.views.PasswordResetConfirmView.self",
            "modoboa.core.api.v2.views.PasswordResetConfirmView.post.data",
            "modoboa.core.api.v2.views.TokenObtainPairView.self"
        ]
    }
}