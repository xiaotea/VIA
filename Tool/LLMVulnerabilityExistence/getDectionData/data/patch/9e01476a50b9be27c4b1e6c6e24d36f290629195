{
    "airflow/configuration.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " from __future__ import print_function"
            },
            "1": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " from __future__ import unicode_literals"
            },
            "2": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 24,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 25,
                "PatchRowcode": "+from base64 import b64encode"
            },
            "4": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " from builtins import str"
            },
            "5": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " from collections import OrderedDict"
            },
            "6": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 28,
                "PatchRowcode": " import copy"
            },
            "7": {
                "beforePatchRowNumber": 478,
                "afterPatchRowNumber": 479,
                "PatchRowcode": " else:"
            },
            "8": {
                "beforePatchRowNumber": 479,
                "afterPatchRowNumber": 480,
                "PatchRowcode": "     FERNET_KEY = ''"
            },
            "9": {
                "beforePatchRowNumber": 480,
                "afterPatchRowNumber": 481,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 482,
                "PatchRowcode": "+SECRET_KEY = b64encode(os.urandom(16)).decode('utf-8')"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 483,
                "PatchRowcode": "+"
            },
            "12": {
                "beforePatchRowNumber": 481,
                "afterPatchRowNumber": 484,
                "PatchRowcode": " TEMPLATE_START = ("
            },
            "13": {
                "beforePatchRowNumber": 482,
                "afterPatchRowNumber": 485,
                "PatchRowcode": "     '# ----------------------- TEMPLATE BEGINS HERE -----------------------')"
            },
            "14": {
                "beforePatchRowNumber": 483,
                "afterPatchRowNumber": 486,
                "PatchRowcode": " if not os.path.isfile(TEST_CONFIG_FILE):"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "#",
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "#",
            "from __future__ import absolute_import",
            "from __future__ import division",
            "from __future__ import print_function",
            "from __future__ import unicode_literals",
            "",
            "from builtins import str",
            "from collections import OrderedDict",
            "import copy",
            "import errno",
            "from future import standard_library",
            "import os",
            "import shlex",
            "import six",
            "from six import iteritems",
            "import subprocess",
            "import sys",
            "import warnings",
            "",
            "from backports.configparser import ConfigParser",
            "from zope.deprecation import deprecated",
            "",
            "from airflow.exceptions import AirflowConfigException",
            "from airflow.utils.log.logging_mixin import LoggingMixin",
            "",
            "standard_library.install_aliases()",
            "",
            "log = LoggingMixin().log",
            "",
            "# show Airflow's deprecation warnings",
            "warnings.filterwarnings(",
            "    action='default', category=DeprecationWarning, module='airflow')",
            "warnings.filterwarnings(",
            "    action='default', category=PendingDeprecationWarning, module='airflow')",
            "",
            "",
            "def generate_fernet_key():",
            "    try:",
            "        from cryptography.fernet import Fernet",
            "    except ImportError:",
            "        pass",
            "    try:",
            "        key = Fernet.generate_key().decode()",
            "    except NameError:",
            "        key = \"cryptography_not_found_storing_passwords_in_plain_text\"",
            "    return key",
            "",
            "",
            "def expand_env_var(env_var):",
            "    \"\"\"",
            "    Expands (potentially nested) env vars by repeatedly applying",
            "    `expandvars` and `expanduser` until interpolation stops having",
            "    any effect.",
            "    \"\"\"",
            "    if not env_var:",
            "        return env_var",
            "    while True:",
            "        interpolated = os.path.expanduser(os.path.expandvars(str(env_var)))",
            "        if interpolated == env_var:",
            "            return interpolated",
            "        else:",
            "            env_var = interpolated",
            "",
            "",
            "def run_command(command):",
            "    \"\"\"",
            "    Runs command and returns stdout",
            "    \"\"\"",
            "    process = subprocess.Popen(",
            "        shlex.split(command),",
            "        stdout=subprocess.PIPE,",
            "        stderr=subprocess.PIPE,",
            "        close_fds=True)",
            "    output, stderr = [stream.decode(sys.getdefaultencoding(), 'ignore')",
            "                      for stream in process.communicate()]",
            "",
            "    if process.returncode != 0:",
            "        raise AirflowConfigException(",
            "            \"Cannot execute {}. Error code is: {}. Output: {}, Stderr: {}\"",
            "            .format(command, process.returncode, output, stderr)",
            "        )",
            "",
            "    return output",
            "",
            "",
            "def _read_default_config_file(file_name):",
            "    templates_dir = os.path.join(os.path.dirname(__file__), 'config_templates')",
            "    file_path = os.path.join(templates_dir, file_name)",
            "    if six.PY2:",
            "        with open(file_path) as f:",
            "            config = f.read()",
            "            return config.decode('utf-8')",
            "    else:",
            "        with open(file_path, encoding='utf-8') as f:",
            "            return f.read()",
            "",
            "",
            "DEFAULT_CONFIG = _read_default_config_file('default_airflow.cfg')",
            "TEST_CONFIG = _read_default_config_file('default_test.cfg')",
            "",
            "",
            "class AirflowConfigParser(ConfigParser):",
            "",
            "    # These configuration elements can be fetched as the stdout of commands",
            "    # following the \"{section}__{name}__cmd\" pattern, the idea behind this",
            "    # is to not store password on boxes in text files.",
            "    as_command_stdout = {",
            "        ('core', 'sql_alchemy_conn'),",
            "        ('core', 'fernet_key'),",
            "        ('celery', 'broker_url'),",
            "        ('celery', 'result_backend'),",
            "        # Todo: remove this in Airflow 1.11",
            "        ('celery', 'celery_result_backend'),",
            "    }",
            "",
            "    # A two-level mapping of (section -> new_name -> old_name). When reading",
            "    # new_name, the old_name will be checked to see if it exists. If it does a",
            "    # DeprecationWarning will be issued and the old name will be used instead",
            "    deprecated_options = {",
            "        'celery': {",
            "            # Remove these keys in Airflow 1.11",
            "            'worker_concurrency': 'celeryd_concurrency',",
            "            'broker_url': 'celery_broker_url',",
            "            'ssl_active': 'celery_ssl_active',",
            "            'ssl_cert': 'celery_ssl_cert',",
            "            'ssl_key': 'celery_ssl_key',",
            "        }",
            "    }",
            "    deprecation_format_string = (",
            "        'The {old} option in [{section}] has been renamed to {new} - the old '",
            "        'setting has been used, but please update your config.'",
            "    )",
            "",
            "    def __init__(self, default_config=None, *args, **kwargs):",
            "        super(AirflowConfigParser, self).__init__(*args, **kwargs)",
            "",
            "        self.defaults = ConfigParser(*args, **kwargs)",
            "        if default_config is not None:",
            "            self.defaults.read_string(default_config)",
            "",
            "        self.is_validated = False",
            "",
            "    def _validate(self):",
            "        if (",
            "                self.get(\"core\", \"executor\") != 'SequentialExecutor' and",
            "                \"sqlite\" in self.get('core', 'sql_alchemy_conn')):",
            "            raise AirflowConfigException(",
            "                \"error: cannot use sqlite with the {}\".format(",
            "                    self.get('core', 'executor')))",
            "",
            "        elif (",
            "            self.getboolean(\"webserver\", \"authenticate\") and",
            "            self.get(\"webserver\", \"owner_mode\") not in ['user', 'ldapgroup']",
            "        ):",
            "            raise AirflowConfigException(",
            "                \"error: owner_mode option should be either \"",
            "                \"'user' or 'ldapgroup' when filtering by owner is set\")",
            "",
            "        elif (",
            "            self.getboolean(\"webserver\", \"authenticate\") and",
            "            self.get(\"webserver\", \"owner_mode\").lower() == 'ldapgroup' and",
            "            self.get(\"webserver\", \"auth_backend\") != (",
            "                'airflow.contrib.auth.backends.ldap_auth')",
            "        ):",
            "            raise AirflowConfigException(",
            "                \"error: attempt at using ldapgroup \"",
            "                \"filtering without using the Ldap backend\")",
            "",
            "        self.is_validated = True",
            "",
            "    def _get_env_var_option(self, section, key):",
            "        # must have format AIRFLOW__{SECTION}__{KEY} (note double underscore)",
            "        env_var = 'AIRFLOW__{S}__{K}'.format(S=section.upper(), K=key.upper())",
            "        if env_var in os.environ:",
            "            return expand_env_var(os.environ[env_var])",
            "",
            "    def _get_cmd_option(self, section, key):",
            "        fallback_key = key + '_cmd'",
            "        # if this is a valid command key...",
            "        if (section, key) in self.as_command_stdout:",
            "            if super(AirflowConfigParser, self) \\",
            "                    .has_option(section, fallback_key):",
            "                command = super(AirflowConfigParser, self) \\",
            "                    .get(section, fallback_key)",
            "                return run_command(command)",
            "",
            "    def get(self, section, key, **kwargs):",
            "        section = str(section).lower()",
            "        key = str(key).lower()",
            "",
            "        deprecated_name = self.deprecated_options.get(section, {}).get(key, None)",
            "",
            "        # first check environment variables",
            "        option = self._get_env_var_option(section, key)",
            "        if option is not None:",
            "            return option",
            "        if deprecated_name:",
            "            option = self._get_env_var_option(section, deprecated_name)",
            "            if option is not None:",
            "                self._warn_deprecate(section, key, deprecated_name)",
            "                return option",
            "",
            "        # ...then the config file",
            "        if super(AirflowConfigParser, self).has_option(section, key):",
            "            # Use the parent's methods to get the actual config here to be able to",
            "            # separate the config from default config.",
            "            return expand_env_var(",
            "                super(AirflowConfigParser, self).get(section, key, **kwargs))",
            "        if deprecated_name:",
            "            if super(AirflowConfigParser, self).has_option(section, deprecated_name):",
            "                self._warn_deprecate(section, key, deprecated_name)",
            "                return expand_env_var(super(AirflowConfigParser, self).get(",
            "                    section,",
            "                    deprecated_name,",
            "                    **kwargs",
            "                ))",
            "",
            "        # ...then commands",
            "        option = self._get_cmd_option(section, key)",
            "        if option:",
            "            return option",
            "        if deprecated_name:",
            "            option = self._get_cmd_option(section, deprecated_name)",
            "            if option:",
            "                self._warn_deprecate(section, key, deprecated_name)",
            "                return option",
            "",
            "        # ...then the default config",
            "        if self.defaults.has_option(section, key):",
            "            return expand_env_var(",
            "                self.defaults.get(section, key, **kwargs))",
            "",
            "        else:",
            "            log.warning(",
            "                \"section/key [{section}/{key}] not found in config\".format(**locals())",
            "            )",
            "",
            "            raise AirflowConfigException(",
            "                \"section/key [{section}/{key}] not found \"",
            "                \"in config\".format(**locals()))",
            "",
            "    def getboolean(self, section, key):",
            "        val = str(self.get(section, key)).lower().strip()",
            "        if '#' in val:",
            "            val = val.split('#')[0].strip()",
            "        if val.lower() in ('t', 'true', '1'):",
            "            return True",
            "        elif val.lower() in ('f', 'false', '0'):",
            "            return False",
            "        else:",
            "            raise AirflowConfigException(",
            "                'The value for configuration option \"{}:{}\" is not a '",
            "                'boolean (received \"{}\").'.format(section, key, val))",
            "",
            "    def getint(self, section, key):",
            "        return int(self.get(section, key))",
            "",
            "    def getfloat(self, section, key):",
            "        return float(self.get(section, key))",
            "",
            "    def read(self, filenames):",
            "        super(AirflowConfigParser, self).read(filenames)",
            "        self._validate()",
            "",
            "    def has_option(self, section, option):",
            "        try:",
            "            # Using self.get() to avoid reimplementing the priority order",
            "            # of config variables (env, config, cmd, defaults)",
            "            self.get(section, option)",
            "            return True",
            "        except AirflowConfigException:",
            "            return False",
            "",
            "    def remove_option(self, section, option, remove_default=True):",
            "        \"\"\"",
            "        Remove an option if it exists in config from a file or",
            "        default config. If both of config have the same option, this removes",
            "        the option in both configs unless remove_default=False.",
            "        \"\"\"",
            "        if super(AirflowConfigParser, self).has_option(section, option):",
            "            super(AirflowConfigParser, self).remove_option(section, option)",
            "",
            "        if self.defaults.has_option(section, option) and remove_default:",
            "            self.defaults.remove_option(section, option)",
            "",
            "    def getsection(self, section):",
            "        \"\"\"",
            "        Returns the section as a dict. Values are converted to int, float, bool",
            "        as required.",
            "        :param section: section from the config",
            "        :return: dict",
            "        \"\"\"",
            "        if section not in self._sections and section not in self.defaults._sections:",
            "            return None",
            "",
            "        _section = copy.deepcopy(self.defaults._sections[section])",
            "",
            "        if section in self._sections:",
            "            _section.update(copy.deepcopy(self._sections[section]))",
            "",
            "        for key, val in iteritems(_section):",
            "            try:",
            "                val = int(val)",
            "            except ValueError:",
            "                try:",
            "                    val = float(val)",
            "                except ValueError:",
            "                    if val.lower() in ('t', 'true'):",
            "                        val = True",
            "                    elif val.lower() in ('f', 'false'):",
            "                        val = False",
            "            _section[key] = val",
            "        return _section",
            "",
            "    def as_dict(self, display_source=False, display_sensitive=False):",
            "        \"\"\"",
            "        Returns the current configuration as an OrderedDict of OrderedDicts.",
            "        :param display_source: If False, the option value is returned. If True,",
            "            a tuple of (option_value, source) is returned. Source is either",
            "            'airflow.cfg' or 'default'.",
            "        :type display_source: bool",
            "        :param display_sensitive: If True, the values of options set by env",
            "            vars and bash commands will be displayed. If False, those options",
            "            are shown as '< hidden >'",
            "        :type display_sensitive: bool",
            "        \"\"\"",
            "        cfg = copy.deepcopy(self.defaults._sections)",
            "        cfg.update(copy.deepcopy(self._sections))",
            "",
            "        # remove __name__ (affects Python 2 only)",
            "        for options in cfg.values():",
            "            options.pop('__name__', None)",
            "",
            "        # add source",
            "        if display_source:",
            "            for section in cfg:",
            "                for k, v in cfg[section].items():",
            "                    cfg[section][k] = (v, 'airflow config')",
            "",
            "        # add env vars and overwrite because they have priority",
            "        for ev in [ev for ev in os.environ if ev.startswith('AIRFLOW__')]:",
            "            try:",
            "                _, section, key = ev.split('__')",
            "                opt = self._get_env_var_option(section, key)",
            "            except ValueError:",
            "                opt = None",
            "            if opt:",
            "                if (",
            "                    not display_sensitive and",
            "                        ev != 'AIRFLOW__CORE__UNIT_TEST_MODE'):",
            "                    opt = '< hidden >'",
            "                if display_source:",
            "                    opt = (opt, 'env var')",
            "                cfg.setdefault(section.lower(), OrderedDict()).update(",
            "                    {key.lower(): opt})",
            "",
            "        # add bash commands",
            "        for (section, key) in self.as_command_stdout:",
            "            opt = self._get_cmd_option(section, key)",
            "            if opt:",
            "                if not display_sensitive:",
            "                    opt = '< hidden >'",
            "                if display_source:",
            "                    opt = (opt, 'bash cmd')",
            "                cfg.setdefault(section, OrderedDict()).update({key: opt})",
            "",
            "        return cfg",
            "",
            "    def load_test_config(self):",
            "        \"\"\"",
            "        Load the unit test configuration.",
            "",
            "        Note: this is not reversible.",
            "        \"\"\"",
            "        # override any custom settings with defaults",
            "        self.read_string(parameterized_config(DEFAULT_CONFIG))",
            "        # then read test config",
            "        self.read_string(parameterized_config(TEST_CONFIG))",
            "        # then read any \"custom\" test settings",
            "        self.read(TEST_CONFIG_FILE)",
            "",
            "    def _warn_deprecate(self, section, key, deprecated_name):",
            "        warnings.warn(",
            "            self.deprecation_format_string.format(",
            "                old=deprecated_name,",
            "                new=key,",
            "                section=section,",
            "            ),",
            "            DeprecationWarning,",
            "            stacklevel=3,",
            "        )",
            "",
            "",
            "def mkdir_p(path):",
            "    try:",
            "        os.makedirs(path)",
            "    except OSError as exc:  # Python >2.5",
            "        if exc.errno == errno.EEXIST and os.path.isdir(path):",
            "            pass",
            "        else:",
            "            raise AirflowConfigException(",
            "                'Error creating {}: {}'.format(path, exc.strerror))",
            "",
            "",
            "# Setting AIRFLOW_HOME and AIRFLOW_CONFIG from environment variables, using",
            "# \"~/airflow\" and \"~/airflow/airflow.cfg\" respectively as defaults.",
            "",
            "if 'AIRFLOW_HOME' not in os.environ:",
            "    AIRFLOW_HOME = expand_env_var('~/airflow')",
            "else:",
            "    AIRFLOW_HOME = expand_env_var(os.environ['AIRFLOW_HOME'])",
            "",
            "mkdir_p(AIRFLOW_HOME)",
            "",
            "if 'AIRFLOW_CONFIG' not in os.environ:",
            "    if os.path.isfile(expand_env_var('~/airflow.cfg')):",
            "        AIRFLOW_CONFIG = expand_env_var('~/airflow.cfg')",
            "    else:",
            "        AIRFLOW_CONFIG = AIRFLOW_HOME + '/airflow.cfg'",
            "else:",
            "    AIRFLOW_CONFIG = expand_env_var(os.environ['AIRFLOW_CONFIG'])",
            "",
            "# Set up dags folder for unit tests",
            "# this directory won't exist if users install via pip",
            "_TEST_DAGS_FOLDER = os.path.join(",
            "    os.path.dirname(os.path.dirname(os.path.realpath(__file__))),",
            "    'tests',",
            "    'dags')",
            "if os.path.exists(_TEST_DAGS_FOLDER):",
            "    TEST_DAGS_FOLDER = _TEST_DAGS_FOLDER",
            "else:",
            "    TEST_DAGS_FOLDER = os.path.join(AIRFLOW_HOME, 'dags')",
            "",
            "# Set up plugins folder for unit tests",
            "_TEST_PLUGINS_FOLDER = os.path.join(",
            "    os.path.dirname(os.path.dirname(os.path.realpath(__file__))),",
            "    'tests',",
            "    'plugins')",
            "if os.path.exists(_TEST_PLUGINS_FOLDER):",
            "    TEST_PLUGINS_FOLDER = _TEST_PLUGINS_FOLDER",
            "else:",
            "    TEST_PLUGINS_FOLDER = os.path.join(AIRFLOW_HOME, 'plugins')",
            "",
            "",
            "def parameterized_config(template):",
            "    \"\"\"",
            "    Generates a configuration from the provided template + variables defined in",
            "    current scope",
            "    :param template: a config content templated with {{variables}}",
            "    \"\"\"",
            "    all_vars = {k: v for d in [globals(), locals()] for k, v in d.items()}",
            "    return template.format(**all_vars)",
            "",
            "",
            "TEST_CONFIG_FILE = AIRFLOW_HOME + '/unittests.cfg'",
            "",
            "# only generate a Fernet key if we need to create a new config file",
            "if not os.path.isfile(TEST_CONFIG_FILE) or not os.path.isfile(AIRFLOW_CONFIG):",
            "    FERNET_KEY = generate_fernet_key()",
            "else:",
            "    FERNET_KEY = ''",
            "",
            "TEMPLATE_START = (",
            "    '# ----------------------- TEMPLATE BEGINS HERE -----------------------')",
            "if not os.path.isfile(TEST_CONFIG_FILE):",
            "    log.info(",
            "        'Creating new Airflow config file for unit tests in: %s', TEST_CONFIG_FILE",
            "    )",
            "    with open(TEST_CONFIG_FILE, 'w') as f:",
            "        cfg = parameterized_config(TEST_CONFIG)",
            "        f.write(cfg.split(TEMPLATE_START)[-1].strip())",
            "if not os.path.isfile(AIRFLOW_CONFIG):",
            "    log.info(",
            "        'Creating new Airflow config file in: %s',",
            "        AIRFLOW_CONFIG",
            "    )",
            "    with open(AIRFLOW_CONFIG, 'w') as f:",
            "        cfg = parameterized_config(DEFAULT_CONFIG)",
            "        cfg = cfg.split(TEMPLATE_START)[-1].strip()",
            "        if six.PY2:",
            "            cfg = cfg.encode('utf8')",
            "        f.write(cfg)",
            "",
            "log.info(\"Reading the config from %s\", AIRFLOW_CONFIG)",
            "",
            "conf = AirflowConfigParser(default_config=parameterized_config(DEFAULT_CONFIG))",
            "",
            "conf.read(AIRFLOW_CONFIG)",
            "",
            "",
            "if conf.getboolean('webserver', 'rbac'):",
            "    DEFAULT_WEBSERVER_CONFIG = _read_default_config_file('default_webserver_config.py')",
            "",
            "    WEBSERVER_CONFIG = AIRFLOW_HOME + '/webserver_config.py'",
            "",
            "    if not os.path.isfile(WEBSERVER_CONFIG):",
            "        log.info('Creating new FAB webserver config file in: %s', WEBSERVER_CONFIG)",
            "        with open(WEBSERVER_CONFIG, 'w') as f:",
            "            f.write(DEFAULT_WEBSERVER_CONFIG)",
            "",
            "if conf.getboolean('core', 'unit_test_mode'):",
            "    conf.load_test_config()",
            "",
            "# Historical convenience functions to access config entries",
            "",
            "load_test_config = conf.load_test_config",
            "get = conf.get",
            "getboolean = conf.getboolean",
            "getfloat = conf.getfloat",
            "getint = conf.getint",
            "getsection = conf.getsection",
            "has_option = conf.has_option",
            "remove_option = conf.remove_option",
            "as_dict = conf.as_dict",
            "set = conf.set # noqa",
            "",
            "for func in [load_test_config, get, getboolean, getfloat, getint, has_option,",
            "             remove_option, as_dict, set]:",
            "    deprecated(",
            "        func,",
            "        \"Accessing configuration method '{f.__name__}' directly from \"",
            "        \"the configuration module is deprecated. Please access the \"",
            "        \"configuration from the 'configuration.conf' object via \"",
            "        \"'conf.{f.__name__}'\".format(f=func))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "#",
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "#",
            "from __future__ import absolute_import",
            "from __future__ import division",
            "from __future__ import print_function",
            "from __future__ import unicode_literals",
            "",
            "from base64 import b64encode",
            "from builtins import str",
            "from collections import OrderedDict",
            "import copy",
            "import errno",
            "from future import standard_library",
            "import os",
            "import shlex",
            "import six",
            "from six import iteritems",
            "import subprocess",
            "import sys",
            "import warnings",
            "",
            "from backports.configparser import ConfigParser",
            "from zope.deprecation import deprecated",
            "",
            "from airflow.exceptions import AirflowConfigException",
            "from airflow.utils.log.logging_mixin import LoggingMixin",
            "",
            "standard_library.install_aliases()",
            "",
            "log = LoggingMixin().log",
            "",
            "# show Airflow's deprecation warnings",
            "warnings.filterwarnings(",
            "    action='default', category=DeprecationWarning, module='airflow')",
            "warnings.filterwarnings(",
            "    action='default', category=PendingDeprecationWarning, module='airflow')",
            "",
            "",
            "def generate_fernet_key():",
            "    try:",
            "        from cryptography.fernet import Fernet",
            "    except ImportError:",
            "        pass",
            "    try:",
            "        key = Fernet.generate_key().decode()",
            "    except NameError:",
            "        key = \"cryptography_not_found_storing_passwords_in_plain_text\"",
            "    return key",
            "",
            "",
            "def expand_env_var(env_var):",
            "    \"\"\"",
            "    Expands (potentially nested) env vars by repeatedly applying",
            "    `expandvars` and `expanduser` until interpolation stops having",
            "    any effect.",
            "    \"\"\"",
            "    if not env_var:",
            "        return env_var",
            "    while True:",
            "        interpolated = os.path.expanduser(os.path.expandvars(str(env_var)))",
            "        if interpolated == env_var:",
            "            return interpolated",
            "        else:",
            "            env_var = interpolated",
            "",
            "",
            "def run_command(command):",
            "    \"\"\"",
            "    Runs command and returns stdout",
            "    \"\"\"",
            "    process = subprocess.Popen(",
            "        shlex.split(command),",
            "        stdout=subprocess.PIPE,",
            "        stderr=subprocess.PIPE,",
            "        close_fds=True)",
            "    output, stderr = [stream.decode(sys.getdefaultencoding(), 'ignore')",
            "                      for stream in process.communicate()]",
            "",
            "    if process.returncode != 0:",
            "        raise AirflowConfigException(",
            "            \"Cannot execute {}. Error code is: {}. Output: {}, Stderr: {}\"",
            "            .format(command, process.returncode, output, stderr)",
            "        )",
            "",
            "    return output",
            "",
            "",
            "def _read_default_config_file(file_name):",
            "    templates_dir = os.path.join(os.path.dirname(__file__), 'config_templates')",
            "    file_path = os.path.join(templates_dir, file_name)",
            "    if six.PY2:",
            "        with open(file_path) as f:",
            "            config = f.read()",
            "            return config.decode('utf-8')",
            "    else:",
            "        with open(file_path, encoding='utf-8') as f:",
            "            return f.read()",
            "",
            "",
            "DEFAULT_CONFIG = _read_default_config_file('default_airflow.cfg')",
            "TEST_CONFIG = _read_default_config_file('default_test.cfg')",
            "",
            "",
            "class AirflowConfigParser(ConfigParser):",
            "",
            "    # These configuration elements can be fetched as the stdout of commands",
            "    # following the \"{section}__{name}__cmd\" pattern, the idea behind this",
            "    # is to not store password on boxes in text files.",
            "    as_command_stdout = {",
            "        ('core', 'sql_alchemy_conn'),",
            "        ('core', 'fernet_key'),",
            "        ('celery', 'broker_url'),",
            "        ('celery', 'result_backend'),",
            "        # Todo: remove this in Airflow 1.11",
            "        ('celery', 'celery_result_backend'),",
            "    }",
            "",
            "    # A two-level mapping of (section -> new_name -> old_name). When reading",
            "    # new_name, the old_name will be checked to see if it exists. If it does a",
            "    # DeprecationWarning will be issued and the old name will be used instead",
            "    deprecated_options = {",
            "        'celery': {",
            "            # Remove these keys in Airflow 1.11",
            "            'worker_concurrency': 'celeryd_concurrency',",
            "            'broker_url': 'celery_broker_url',",
            "            'ssl_active': 'celery_ssl_active',",
            "            'ssl_cert': 'celery_ssl_cert',",
            "            'ssl_key': 'celery_ssl_key',",
            "        }",
            "    }",
            "    deprecation_format_string = (",
            "        'The {old} option in [{section}] has been renamed to {new} - the old '",
            "        'setting has been used, but please update your config.'",
            "    )",
            "",
            "    def __init__(self, default_config=None, *args, **kwargs):",
            "        super(AirflowConfigParser, self).__init__(*args, **kwargs)",
            "",
            "        self.defaults = ConfigParser(*args, **kwargs)",
            "        if default_config is not None:",
            "            self.defaults.read_string(default_config)",
            "",
            "        self.is_validated = False",
            "",
            "    def _validate(self):",
            "        if (",
            "                self.get(\"core\", \"executor\") != 'SequentialExecutor' and",
            "                \"sqlite\" in self.get('core', 'sql_alchemy_conn')):",
            "            raise AirflowConfigException(",
            "                \"error: cannot use sqlite with the {}\".format(",
            "                    self.get('core', 'executor')))",
            "",
            "        elif (",
            "            self.getboolean(\"webserver\", \"authenticate\") and",
            "            self.get(\"webserver\", \"owner_mode\") not in ['user', 'ldapgroup']",
            "        ):",
            "            raise AirflowConfigException(",
            "                \"error: owner_mode option should be either \"",
            "                \"'user' or 'ldapgroup' when filtering by owner is set\")",
            "",
            "        elif (",
            "            self.getboolean(\"webserver\", \"authenticate\") and",
            "            self.get(\"webserver\", \"owner_mode\").lower() == 'ldapgroup' and",
            "            self.get(\"webserver\", \"auth_backend\") != (",
            "                'airflow.contrib.auth.backends.ldap_auth')",
            "        ):",
            "            raise AirflowConfigException(",
            "                \"error: attempt at using ldapgroup \"",
            "                \"filtering without using the Ldap backend\")",
            "",
            "        self.is_validated = True",
            "",
            "    def _get_env_var_option(self, section, key):",
            "        # must have format AIRFLOW__{SECTION}__{KEY} (note double underscore)",
            "        env_var = 'AIRFLOW__{S}__{K}'.format(S=section.upper(), K=key.upper())",
            "        if env_var in os.environ:",
            "            return expand_env_var(os.environ[env_var])",
            "",
            "    def _get_cmd_option(self, section, key):",
            "        fallback_key = key + '_cmd'",
            "        # if this is a valid command key...",
            "        if (section, key) in self.as_command_stdout:",
            "            if super(AirflowConfigParser, self) \\",
            "                    .has_option(section, fallback_key):",
            "                command = super(AirflowConfigParser, self) \\",
            "                    .get(section, fallback_key)",
            "                return run_command(command)",
            "",
            "    def get(self, section, key, **kwargs):",
            "        section = str(section).lower()",
            "        key = str(key).lower()",
            "",
            "        deprecated_name = self.deprecated_options.get(section, {}).get(key, None)",
            "",
            "        # first check environment variables",
            "        option = self._get_env_var_option(section, key)",
            "        if option is not None:",
            "            return option",
            "        if deprecated_name:",
            "            option = self._get_env_var_option(section, deprecated_name)",
            "            if option is not None:",
            "                self._warn_deprecate(section, key, deprecated_name)",
            "                return option",
            "",
            "        # ...then the config file",
            "        if super(AirflowConfigParser, self).has_option(section, key):",
            "            # Use the parent's methods to get the actual config here to be able to",
            "            # separate the config from default config.",
            "            return expand_env_var(",
            "                super(AirflowConfigParser, self).get(section, key, **kwargs))",
            "        if deprecated_name:",
            "            if super(AirflowConfigParser, self).has_option(section, deprecated_name):",
            "                self._warn_deprecate(section, key, deprecated_name)",
            "                return expand_env_var(super(AirflowConfigParser, self).get(",
            "                    section,",
            "                    deprecated_name,",
            "                    **kwargs",
            "                ))",
            "",
            "        # ...then commands",
            "        option = self._get_cmd_option(section, key)",
            "        if option:",
            "            return option",
            "        if deprecated_name:",
            "            option = self._get_cmd_option(section, deprecated_name)",
            "            if option:",
            "                self._warn_deprecate(section, key, deprecated_name)",
            "                return option",
            "",
            "        # ...then the default config",
            "        if self.defaults.has_option(section, key):",
            "            return expand_env_var(",
            "                self.defaults.get(section, key, **kwargs))",
            "",
            "        else:",
            "            log.warning(",
            "                \"section/key [{section}/{key}] not found in config\".format(**locals())",
            "            )",
            "",
            "            raise AirflowConfigException(",
            "                \"section/key [{section}/{key}] not found \"",
            "                \"in config\".format(**locals()))",
            "",
            "    def getboolean(self, section, key):",
            "        val = str(self.get(section, key)).lower().strip()",
            "        if '#' in val:",
            "            val = val.split('#')[0].strip()",
            "        if val.lower() in ('t', 'true', '1'):",
            "            return True",
            "        elif val.lower() in ('f', 'false', '0'):",
            "            return False",
            "        else:",
            "            raise AirflowConfigException(",
            "                'The value for configuration option \"{}:{}\" is not a '",
            "                'boolean (received \"{}\").'.format(section, key, val))",
            "",
            "    def getint(self, section, key):",
            "        return int(self.get(section, key))",
            "",
            "    def getfloat(self, section, key):",
            "        return float(self.get(section, key))",
            "",
            "    def read(self, filenames):",
            "        super(AirflowConfigParser, self).read(filenames)",
            "        self._validate()",
            "",
            "    def has_option(self, section, option):",
            "        try:",
            "            # Using self.get() to avoid reimplementing the priority order",
            "            # of config variables (env, config, cmd, defaults)",
            "            self.get(section, option)",
            "            return True",
            "        except AirflowConfigException:",
            "            return False",
            "",
            "    def remove_option(self, section, option, remove_default=True):",
            "        \"\"\"",
            "        Remove an option if it exists in config from a file or",
            "        default config. If both of config have the same option, this removes",
            "        the option in both configs unless remove_default=False.",
            "        \"\"\"",
            "        if super(AirflowConfigParser, self).has_option(section, option):",
            "            super(AirflowConfigParser, self).remove_option(section, option)",
            "",
            "        if self.defaults.has_option(section, option) and remove_default:",
            "            self.defaults.remove_option(section, option)",
            "",
            "    def getsection(self, section):",
            "        \"\"\"",
            "        Returns the section as a dict. Values are converted to int, float, bool",
            "        as required.",
            "        :param section: section from the config",
            "        :return: dict",
            "        \"\"\"",
            "        if section not in self._sections and section not in self.defaults._sections:",
            "            return None",
            "",
            "        _section = copy.deepcopy(self.defaults._sections[section])",
            "",
            "        if section in self._sections:",
            "            _section.update(copy.deepcopy(self._sections[section]))",
            "",
            "        for key, val in iteritems(_section):",
            "            try:",
            "                val = int(val)",
            "            except ValueError:",
            "                try:",
            "                    val = float(val)",
            "                except ValueError:",
            "                    if val.lower() in ('t', 'true'):",
            "                        val = True",
            "                    elif val.lower() in ('f', 'false'):",
            "                        val = False",
            "            _section[key] = val",
            "        return _section",
            "",
            "    def as_dict(self, display_source=False, display_sensitive=False):",
            "        \"\"\"",
            "        Returns the current configuration as an OrderedDict of OrderedDicts.",
            "        :param display_source: If False, the option value is returned. If True,",
            "            a tuple of (option_value, source) is returned. Source is either",
            "            'airflow.cfg' or 'default'.",
            "        :type display_source: bool",
            "        :param display_sensitive: If True, the values of options set by env",
            "            vars and bash commands will be displayed. If False, those options",
            "            are shown as '< hidden >'",
            "        :type display_sensitive: bool",
            "        \"\"\"",
            "        cfg = copy.deepcopy(self.defaults._sections)",
            "        cfg.update(copy.deepcopy(self._sections))",
            "",
            "        # remove __name__ (affects Python 2 only)",
            "        for options in cfg.values():",
            "            options.pop('__name__', None)",
            "",
            "        # add source",
            "        if display_source:",
            "            for section in cfg:",
            "                for k, v in cfg[section].items():",
            "                    cfg[section][k] = (v, 'airflow config')",
            "",
            "        # add env vars and overwrite because they have priority",
            "        for ev in [ev for ev in os.environ if ev.startswith('AIRFLOW__')]:",
            "            try:",
            "                _, section, key = ev.split('__')",
            "                opt = self._get_env_var_option(section, key)",
            "            except ValueError:",
            "                opt = None",
            "            if opt:",
            "                if (",
            "                    not display_sensitive and",
            "                        ev != 'AIRFLOW__CORE__UNIT_TEST_MODE'):",
            "                    opt = '< hidden >'",
            "                if display_source:",
            "                    opt = (opt, 'env var')",
            "                cfg.setdefault(section.lower(), OrderedDict()).update(",
            "                    {key.lower(): opt})",
            "",
            "        # add bash commands",
            "        for (section, key) in self.as_command_stdout:",
            "            opt = self._get_cmd_option(section, key)",
            "            if opt:",
            "                if not display_sensitive:",
            "                    opt = '< hidden >'",
            "                if display_source:",
            "                    opt = (opt, 'bash cmd')",
            "                cfg.setdefault(section, OrderedDict()).update({key: opt})",
            "",
            "        return cfg",
            "",
            "    def load_test_config(self):",
            "        \"\"\"",
            "        Load the unit test configuration.",
            "",
            "        Note: this is not reversible.",
            "        \"\"\"",
            "        # override any custom settings with defaults",
            "        self.read_string(parameterized_config(DEFAULT_CONFIG))",
            "        # then read test config",
            "        self.read_string(parameterized_config(TEST_CONFIG))",
            "        # then read any \"custom\" test settings",
            "        self.read(TEST_CONFIG_FILE)",
            "",
            "    def _warn_deprecate(self, section, key, deprecated_name):",
            "        warnings.warn(",
            "            self.deprecation_format_string.format(",
            "                old=deprecated_name,",
            "                new=key,",
            "                section=section,",
            "            ),",
            "            DeprecationWarning,",
            "            stacklevel=3,",
            "        )",
            "",
            "",
            "def mkdir_p(path):",
            "    try:",
            "        os.makedirs(path)",
            "    except OSError as exc:  # Python >2.5",
            "        if exc.errno == errno.EEXIST and os.path.isdir(path):",
            "            pass",
            "        else:",
            "            raise AirflowConfigException(",
            "                'Error creating {}: {}'.format(path, exc.strerror))",
            "",
            "",
            "# Setting AIRFLOW_HOME and AIRFLOW_CONFIG from environment variables, using",
            "# \"~/airflow\" and \"~/airflow/airflow.cfg\" respectively as defaults.",
            "",
            "if 'AIRFLOW_HOME' not in os.environ:",
            "    AIRFLOW_HOME = expand_env_var('~/airflow')",
            "else:",
            "    AIRFLOW_HOME = expand_env_var(os.environ['AIRFLOW_HOME'])",
            "",
            "mkdir_p(AIRFLOW_HOME)",
            "",
            "if 'AIRFLOW_CONFIG' not in os.environ:",
            "    if os.path.isfile(expand_env_var('~/airflow.cfg')):",
            "        AIRFLOW_CONFIG = expand_env_var('~/airflow.cfg')",
            "    else:",
            "        AIRFLOW_CONFIG = AIRFLOW_HOME + '/airflow.cfg'",
            "else:",
            "    AIRFLOW_CONFIG = expand_env_var(os.environ['AIRFLOW_CONFIG'])",
            "",
            "# Set up dags folder for unit tests",
            "# this directory won't exist if users install via pip",
            "_TEST_DAGS_FOLDER = os.path.join(",
            "    os.path.dirname(os.path.dirname(os.path.realpath(__file__))),",
            "    'tests',",
            "    'dags')",
            "if os.path.exists(_TEST_DAGS_FOLDER):",
            "    TEST_DAGS_FOLDER = _TEST_DAGS_FOLDER",
            "else:",
            "    TEST_DAGS_FOLDER = os.path.join(AIRFLOW_HOME, 'dags')",
            "",
            "# Set up plugins folder for unit tests",
            "_TEST_PLUGINS_FOLDER = os.path.join(",
            "    os.path.dirname(os.path.dirname(os.path.realpath(__file__))),",
            "    'tests',",
            "    'plugins')",
            "if os.path.exists(_TEST_PLUGINS_FOLDER):",
            "    TEST_PLUGINS_FOLDER = _TEST_PLUGINS_FOLDER",
            "else:",
            "    TEST_PLUGINS_FOLDER = os.path.join(AIRFLOW_HOME, 'plugins')",
            "",
            "",
            "def parameterized_config(template):",
            "    \"\"\"",
            "    Generates a configuration from the provided template + variables defined in",
            "    current scope",
            "    :param template: a config content templated with {{variables}}",
            "    \"\"\"",
            "    all_vars = {k: v for d in [globals(), locals()] for k, v in d.items()}",
            "    return template.format(**all_vars)",
            "",
            "",
            "TEST_CONFIG_FILE = AIRFLOW_HOME + '/unittests.cfg'",
            "",
            "# only generate a Fernet key if we need to create a new config file",
            "if not os.path.isfile(TEST_CONFIG_FILE) or not os.path.isfile(AIRFLOW_CONFIG):",
            "    FERNET_KEY = generate_fernet_key()",
            "else:",
            "    FERNET_KEY = ''",
            "",
            "SECRET_KEY = b64encode(os.urandom(16)).decode('utf-8')",
            "",
            "TEMPLATE_START = (",
            "    '# ----------------------- TEMPLATE BEGINS HERE -----------------------')",
            "if not os.path.isfile(TEST_CONFIG_FILE):",
            "    log.info(",
            "        'Creating new Airflow config file for unit tests in: %s', TEST_CONFIG_FILE",
            "    )",
            "    with open(TEST_CONFIG_FILE, 'w') as f:",
            "        cfg = parameterized_config(TEST_CONFIG)",
            "        f.write(cfg.split(TEMPLATE_START)[-1].strip())",
            "if not os.path.isfile(AIRFLOW_CONFIG):",
            "    log.info(",
            "        'Creating new Airflow config file in: %s',",
            "        AIRFLOW_CONFIG",
            "    )",
            "    with open(AIRFLOW_CONFIG, 'w') as f:",
            "        cfg = parameterized_config(DEFAULT_CONFIG)",
            "        cfg = cfg.split(TEMPLATE_START)[-1].strip()",
            "        if six.PY2:",
            "            cfg = cfg.encode('utf8')",
            "        f.write(cfg)",
            "",
            "log.info(\"Reading the config from %s\", AIRFLOW_CONFIG)",
            "",
            "conf = AirflowConfigParser(default_config=parameterized_config(DEFAULT_CONFIG))",
            "",
            "conf.read(AIRFLOW_CONFIG)",
            "",
            "",
            "if conf.getboolean('webserver', 'rbac'):",
            "    DEFAULT_WEBSERVER_CONFIG = _read_default_config_file('default_webserver_config.py')",
            "",
            "    WEBSERVER_CONFIG = AIRFLOW_HOME + '/webserver_config.py'",
            "",
            "    if not os.path.isfile(WEBSERVER_CONFIG):",
            "        log.info('Creating new FAB webserver config file in: %s', WEBSERVER_CONFIG)",
            "        with open(WEBSERVER_CONFIG, 'w') as f:",
            "            f.write(DEFAULT_WEBSERVER_CONFIG)",
            "",
            "if conf.getboolean('core', 'unit_test_mode'):",
            "    conf.load_test_config()",
            "",
            "# Historical convenience functions to access config entries",
            "",
            "load_test_config = conf.load_test_config",
            "get = conf.get",
            "getboolean = conf.getboolean",
            "getfloat = conf.getfloat",
            "getint = conf.getint",
            "getsection = conf.getsection",
            "has_option = conf.has_option",
            "remove_option = conf.remove_option",
            "as_dict = conf.as_dict",
            "set = conf.set # noqa",
            "",
            "for func in [load_test_config, get, getboolean, getfloat, getint, has_option,",
            "             remove_option, as_dict, set]:",
            "    deprecated(",
            "        func,",
            "        \"Accessing configuration method '{f.__name__}' directly from \"",
            "        \"the configuration module is deprecated. Please access the \"",
            "        \"configuration from the 'configuration.conf' object via \"",
            "        \"'conf.{f.__name__}'\".format(f=func))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": []
    },
    "airflow/www/app.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 49,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 50,
                "PatchRowcode": "     app = Flask(__name__)"
            },
            "2": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "     app.wsgi_app = ProxyFix(app.wsgi_app)"
            },
            "3": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "4": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if configuration.conf.get('webserver', 'SECRET_KEY') == \"temporary_key\":"
            },
            "5": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        log.info(\"SECRET_KEY for Flask App is not specified. Using a random one.\")"
            },
            "6": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        app.secret_key = os.urandom(16)"
            },
            "7": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    else:"
            },
            "8": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        app.secret_key = configuration.conf.get('webserver', 'SECRET_KEY')"
            },
            "9": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 52,
                "PatchRowcode": "+    app.secret_key = configuration.conf.get('webserver', 'SECRET_KEY')"
            },
            "11": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "     app.config['LOGIN_DISABLED'] = not configuration.conf.getboolean("
            },
            "12": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 54,
                "PatchRowcode": "         'webserver', 'AUTHENTICATE')"
            },
            "13": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 55,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "#",
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "#",
            "import six",
            "import os",
            "",
            "from flask import Flask",
            "from flask_admin import Admin, base",
            "from flask_caching import Cache",
            "from flask_wtf.csrf import CSRFProtect",
            "from six.moves.urllib.parse import urlparse",
            "from werkzeug.wsgi import DispatcherMiddleware",
            "from werkzeug.contrib.fixers import ProxyFix",
            "",
            "import airflow",
            "from airflow import configuration as conf",
            "from airflow import models, LoggingMixin",
            "from airflow.settings import Session",
            "",
            "from airflow.www.blueprints import routes",
            "from airflow.logging_config import configure_logging",
            "from airflow import jobs",
            "from airflow import settings",
            "from airflow import configuration",
            "from airflow.utils.net import get_hostname",
            "",
            "csrf = CSRFProtect()",
            "",
            "",
            "def create_app(config=None, testing=False):",
            "",
            "    log = LoggingMixin().log",
            "",
            "    app = Flask(__name__)",
            "    app.wsgi_app = ProxyFix(app.wsgi_app)",
            "",
            "    if configuration.conf.get('webserver', 'SECRET_KEY') == \"temporary_key\":",
            "        log.info(\"SECRET_KEY for Flask App is not specified. Using a random one.\")",
            "        app.secret_key = os.urandom(16)",
            "    else:",
            "        app.secret_key = configuration.conf.get('webserver', 'SECRET_KEY')",
            "",
            "    app.config['LOGIN_DISABLED'] = not configuration.conf.getboolean(",
            "        'webserver', 'AUTHENTICATE')",
            "",
            "    csrf.init_app(app)",
            "",
            "    app.config['TESTING'] = testing",
            "",
            "    airflow.load_login()",
            "    airflow.login.login_manager.init_app(app)",
            "",
            "    from airflow import api",
            "    api.load_auth()",
            "    api.api_auth.init_app(app)",
            "",
            "    cache = Cache(",
            "        app=app, config={'CACHE_TYPE': 'filesystem', 'CACHE_DIR': '/tmp'})",
            "",
            "    app.register_blueprint(routes)",
            "",
            "    configure_logging()",
            "",
            "    with app.app_context():",
            "        from airflow.www import views",
            "",
            "        admin = Admin(",
            "            app, name='Airflow',",
            "            static_url_path='/admin',",
            "            index_view=views.HomeView(endpoint='', url='/admin', name=\"DAGs\"),",
            "            template_mode='bootstrap3',",
            "        )",
            "        av = admin.add_view",
            "        vs = views",
            "        av(vs.Airflow(name='DAGs', category='DAGs'))",
            "",
            "        if not conf.getboolean('core', 'secure_mode'):",
            "            av(vs.QueryView(name='Ad Hoc Query', category=\"Data Profiling\"))",
            "            av(vs.ChartModelView(",
            "                models.Chart, Session, name=\"Charts\", category=\"Data Profiling\"))",
            "        av(vs.KnownEventView(",
            "            models.KnownEvent,",
            "            Session, name=\"Known Events\", category=\"Data Profiling\"))",
            "        av(vs.SlaMissModelView(",
            "            models.SlaMiss,",
            "            Session, name=\"SLA Misses\", category=\"Browse\"))",
            "        av(vs.TaskInstanceModelView(models.TaskInstance,",
            "            Session, name=\"Task Instances\", category=\"Browse\"))",
            "        av(vs.LogModelView(",
            "            models.Log, Session, name=\"Logs\", category=\"Browse\"))",
            "        av(vs.JobModelView(",
            "            jobs.BaseJob, Session, name=\"Jobs\", category=\"Browse\"))",
            "        av(vs.PoolModelView(",
            "            models.Pool, Session, name=\"Pools\", category=\"Admin\"))",
            "        av(vs.ConfigurationView(",
            "            name='Configuration', category=\"Admin\"))",
            "        av(vs.UserModelView(",
            "            models.User, Session, name=\"Users\", category=\"Admin\"))",
            "        av(vs.ConnectionModelView(",
            "            models.Connection, Session, name=\"Connections\", category=\"Admin\"))",
            "        av(vs.VariableView(",
            "            models.Variable, Session, name=\"Variables\", category=\"Admin\"))",
            "        av(vs.XComView(",
            "            models.XCom, Session, name=\"XComs\", category=\"Admin\"))",
            "",
            "        admin.add_link(base.MenuLink(",
            "            category='Docs', name='Documentation',",
            "            url='https://airflow.incubator.apache.org/'))",
            "        admin.add_link(",
            "            base.MenuLink(category='Docs',",
            "                          name='Github',",
            "                          url='https://github.com/apache/incubator-airflow'))",
            "",
            "        av(vs.VersionView(name='Version', category=\"About\"))",
            "",
            "        av(vs.DagRunModelView(",
            "            models.DagRun, Session, name=\"DAG Runs\", category=\"Browse\"))",
            "        av(vs.DagModelView(models.DagModel, Session, name=None))",
            "        # Hack to not add this view to the menu",
            "        admin._menu = admin._menu[:-1]",
            "",
            "        def integrate_plugins():",
            "            \"\"\"Integrate plugins to the context\"\"\"",
            "            from airflow.plugins_manager import (",
            "                admin_views, flask_blueprints, menu_links)",
            "            for v in admin_views:",
            "                log.debug('Adding view %s', v.name)",
            "                admin.add_view(v)",
            "            for bp in flask_blueprints:",
            "                log.debug('Adding blueprint %s', bp.name)",
            "                app.register_blueprint(bp)",
            "            for ml in sorted(menu_links, key=lambda x: x.name):",
            "                log.debug('Adding menu link %s', ml.name)",
            "                admin.add_link(ml)",
            "",
            "        integrate_plugins()",
            "",
            "        import airflow.www.api.experimental.endpoints as e",
            "        # required for testing purposes otherwise the module retains",
            "        # a link to the default_auth",
            "        if app.config['TESTING']:",
            "            if six.PY2:",
            "                reload(e)",
            "            else:",
            "                import importlib",
            "                importlib.reload(e)",
            "",
            "        app.register_blueprint(e.api_experimental, url_prefix='/api/experimental')",
            "",
            "        @app.context_processor",
            "        def jinja_globals():",
            "            return {",
            "                'hostname': get_hostname(),",
            "                'navbar_color': configuration.get('webserver', 'NAVBAR_COLOR'),",
            "            }",
            "",
            "        @app.teardown_appcontext",
            "        def shutdown_session(exception=None):",
            "            settings.Session.remove()",
            "",
            "        return app",
            "",
            "",
            "app = None",
            "",
            "",
            "def root_app(env, resp):",
            "    resp(b'404 Not Found', [(b'Content-Type', b'text/plain')])",
            "    return [b'Apache Airflow is not at this location']",
            "",
            "",
            "def cached_app(config=None, testing=False):",
            "    global app",
            "    if not app:",
            "        base_url = urlparse(configuration.conf.get('webserver', 'base_url'))[2]",
            "        if not base_url or base_url == '/':",
            "            base_url = \"\"",
            "",
            "        app = create_app(config, testing)",
            "        app = DispatcherMiddleware(root_app, {base_url: app})",
            "    return app"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "#",
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "#",
            "import six",
            "import os",
            "",
            "from flask import Flask",
            "from flask_admin import Admin, base",
            "from flask_caching import Cache",
            "from flask_wtf.csrf import CSRFProtect",
            "from six.moves.urllib.parse import urlparse",
            "from werkzeug.wsgi import DispatcherMiddleware",
            "from werkzeug.contrib.fixers import ProxyFix",
            "",
            "import airflow",
            "from airflow import configuration as conf",
            "from airflow import models, LoggingMixin",
            "from airflow.settings import Session",
            "",
            "from airflow.www.blueprints import routes",
            "from airflow.logging_config import configure_logging",
            "from airflow import jobs",
            "from airflow import settings",
            "from airflow import configuration",
            "from airflow.utils.net import get_hostname",
            "",
            "csrf = CSRFProtect()",
            "",
            "",
            "def create_app(config=None, testing=False):",
            "",
            "    log = LoggingMixin().log",
            "",
            "    app = Flask(__name__)",
            "    app.wsgi_app = ProxyFix(app.wsgi_app)",
            "    app.secret_key = configuration.conf.get('webserver', 'SECRET_KEY')",
            "    app.config['LOGIN_DISABLED'] = not configuration.conf.getboolean(",
            "        'webserver', 'AUTHENTICATE')",
            "",
            "    csrf.init_app(app)",
            "",
            "    app.config['TESTING'] = testing",
            "",
            "    airflow.load_login()",
            "    airflow.login.login_manager.init_app(app)",
            "",
            "    from airflow import api",
            "    api.load_auth()",
            "    api.api_auth.init_app(app)",
            "",
            "    cache = Cache(",
            "        app=app, config={'CACHE_TYPE': 'filesystem', 'CACHE_DIR': '/tmp'})",
            "",
            "    app.register_blueprint(routes)",
            "",
            "    configure_logging()",
            "",
            "    with app.app_context():",
            "        from airflow.www import views",
            "",
            "        admin = Admin(",
            "            app, name='Airflow',",
            "            static_url_path='/admin',",
            "            index_view=views.HomeView(endpoint='', url='/admin', name=\"DAGs\"),",
            "            template_mode='bootstrap3',",
            "        )",
            "        av = admin.add_view",
            "        vs = views",
            "        av(vs.Airflow(name='DAGs', category='DAGs'))",
            "",
            "        if not conf.getboolean('core', 'secure_mode'):",
            "            av(vs.QueryView(name='Ad Hoc Query', category=\"Data Profiling\"))",
            "            av(vs.ChartModelView(",
            "                models.Chart, Session, name=\"Charts\", category=\"Data Profiling\"))",
            "        av(vs.KnownEventView(",
            "            models.KnownEvent,",
            "            Session, name=\"Known Events\", category=\"Data Profiling\"))",
            "        av(vs.SlaMissModelView(",
            "            models.SlaMiss,",
            "            Session, name=\"SLA Misses\", category=\"Browse\"))",
            "        av(vs.TaskInstanceModelView(models.TaskInstance,",
            "            Session, name=\"Task Instances\", category=\"Browse\"))",
            "        av(vs.LogModelView(",
            "            models.Log, Session, name=\"Logs\", category=\"Browse\"))",
            "        av(vs.JobModelView(",
            "            jobs.BaseJob, Session, name=\"Jobs\", category=\"Browse\"))",
            "        av(vs.PoolModelView(",
            "            models.Pool, Session, name=\"Pools\", category=\"Admin\"))",
            "        av(vs.ConfigurationView(",
            "            name='Configuration', category=\"Admin\"))",
            "        av(vs.UserModelView(",
            "            models.User, Session, name=\"Users\", category=\"Admin\"))",
            "        av(vs.ConnectionModelView(",
            "            models.Connection, Session, name=\"Connections\", category=\"Admin\"))",
            "        av(vs.VariableView(",
            "            models.Variable, Session, name=\"Variables\", category=\"Admin\"))",
            "        av(vs.XComView(",
            "            models.XCom, Session, name=\"XComs\", category=\"Admin\"))",
            "",
            "        admin.add_link(base.MenuLink(",
            "            category='Docs', name='Documentation',",
            "            url='https://airflow.incubator.apache.org/'))",
            "        admin.add_link(",
            "            base.MenuLink(category='Docs',",
            "                          name='Github',",
            "                          url='https://github.com/apache/incubator-airflow'))",
            "",
            "        av(vs.VersionView(name='Version', category=\"About\"))",
            "",
            "        av(vs.DagRunModelView(",
            "            models.DagRun, Session, name=\"DAG Runs\", category=\"Browse\"))",
            "        av(vs.DagModelView(models.DagModel, Session, name=None))",
            "        # Hack to not add this view to the menu",
            "        admin._menu = admin._menu[:-1]",
            "",
            "        def integrate_plugins():",
            "            \"\"\"Integrate plugins to the context\"\"\"",
            "            from airflow.plugins_manager import (",
            "                admin_views, flask_blueprints, menu_links)",
            "            for v in admin_views:",
            "                log.debug('Adding view %s', v.name)",
            "                admin.add_view(v)",
            "            for bp in flask_blueprints:",
            "                log.debug('Adding blueprint %s', bp.name)",
            "                app.register_blueprint(bp)",
            "            for ml in sorted(menu_links, key=lambda x: x.name):",
            "                log.debug('Adding menu link %s', ml.name)",
            "                admin.add_link(ml)",
            "",
            "        integrate_plugins()",
            "",
            "        import airflow.www.api.experimental.endpoints as e",
            "        # required for testing purposes otherwise the module retains",
            "        # a link to the default_auth",
            "        if app.config['TESTING']:",
            "            if six.PY2:",
            "                reload(e)",
            "            else:",
            "                import importlib",
            "                importlib.reload(e)",
            "",
            "        app.register_blueprint(e.api_experimental, url_prefix='/api/experimental')",
            "",
            "        @app.context_processor",
            "        def jinja_globals():",
            "            return {",
            "                'hostname': get_hostname(),",
            "                'navbar_color': configuration.get('webserver', 'NAVBAR_COLOR'),",
            "            }",
            "",
            "        @app.teardown_appcontext",
            "        def shutdown_session(exception=None):",
            "            settings.Session.remove()",
            "",
            "        return app",
            "",
            "",
            "app = None",
            "",
            "",
            "def root_app(env, resp):",
            "    resp(b'404 Not Found', [(b'Content-Type', b'text/plain')])",
            "    return [b'Apache Airflow is not at this location']",
            "",
            "",
            "def cached_app(config=None, testing=False):",
            "    global app",
            "    if not app:",
            "        base_url = urlparse(configuration.conf.get('webserver', 'base_url'))[2]",
            "        if not base_url or base_url == '/':",
            "            base_url = \"\"",
            "",
            "        app = create_app(config, testing)",
            "        app = DispatcherMiddleware(root_app, {base_url: app})",
            "    return app"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "52": [
                "create_app"
            ],
            "53": [
                "create_app"
            ],
            "54": [
                "create_app"
            ],
            "55": [
                "create_app"
            ],
            "56": [
                "create_app"
            ],
            "57": [
                "create_app"
            ],
            "58": [
                "create_app"
            ]
        },
        "addLocation": []
    },
    "airflow/www_rbac/app.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 43,
                "PatchRowcode": "     global app, appbuilder"
            },
            "1": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 44,
                "PatchRowcode": "     app = Flask(__name__)"
            },
            "2": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 45,
                "PatchRowcode": "     app.wsgi_app = ProxyFix(app.wsgi_app)"
            },
            "3": {
                "beforePatchRowNumber": 46,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    if conf.get('webserver', 'SECRET_KEY') == \"temporary_key\":"
            },
            "4": {
                "beforePatchRowNumber": 47,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        app.secret_key = os.urandom(16)"
            },
            "5": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    else:"
            },
            "6": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        app.secret_key = conf.get('webserver', 'SECRET_KEY')"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 46,
                "PatchRowcode": "+    app.secret_key = conf.get('webserver', 'SECRET_KEY')"
            },
            "8": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 47,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "     airflow_home_path = conf.get('core', 'AIRFLOW_HOME')"
            },
            "10": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 49,
                "PatchRowcode": "     webserver_config_path = airflow_home_path + '/webserver_config.py'"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "#",
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "#",
            "import socket",
            "import six",
            "import os",
            "",
            "from flask import Flask",
            "from flask_appbuilder import AppBuilder, SQLA",
            "from flask_caching import Cache",
            "from flask_wtf.csrf import CSRFProtect",
            "from six.moves.urllib.parse import urlparse",
            "from werkzeug.wsgi import DispatcherMiddleware",
            "from werkzeug.contrib.fixers import ProxyFix",
            "",
            "from airflow import settings",
            "from airflow import configuration as conf",
            "from airflow.logging_config import configure_logging",
            "from airflow.www_rbac.static_config import configure_manifest_files",
            "",
            "app = None",
            "appbuilder = None",
            "csrf = CSRFProtect()",
            "",
            "",
            "def create_app(config=None, session=None, testing=False, app_name=\"Airflow\"):",
            "    global app, appbuilder",
            "    app = Flask(__name__)",
            "    app.wsgi_app = ProxyFix(app.wsgi_app)",
            "    if conf.get('webserver', 'SECRET_KEY') == \"temporary_key\":",
            "        app.secret_key = os.urandom(16)",
            "    else:",
            "        app.secret_key = conf.get('webserver', 'SECRET_KEY')",
            "",
            "    airflow_home_path = conf.get('core', 'AIRFLOW_HOME')",
            "    webserver_config_path = airflow_home_path + '/webserver_config.py'",
            "    app.config.from_pyfile(webserver_config_path, silent=True)",
            "    app.config['APP_NAME'] = app_name",
            "    app.config['TESTING'] = testing",
            "",
            "    csrf.init_app(app)",
            "",
            "    db = SQLA(app)",
            "",
            "    from airflow import api",
            "    api.load_auth()",
            "    api.api_auth.init_app(app)",
            "",
            "    cache = Cache(app=app, config={'CACHE_TYPE': 'filesystem', 'CACHE_DIR': '/tmp'})  # noqa",
            "",
            "    from airflow.www_rbac.blueprints import routes",
            "    app.register_blueprint(routes)",
            "",
            "    configure_logging()",
            "    configure_manifest_files(app)",
            "",
            "    with app.app_context():",
            "",
            "        from airflow.www_rbac.security import AirflowSecurityManager",
            "        security_manager_class = app.config.get('SECURITY_MANAGER_CLASS') or \\",
            "            AirflowSecurityManager",
            "",
            "        if not issubclass(security_manager_class, AirflowSecurityManager):",
            "            raise Exception(",
            "                \"\"\"Your CUSTOM_SECURITY_MANAGER must now extend AirflowSecurityManager,",
            "                 not FAB's security manager.\"\"\")",
            "",
            "        appbuilder = AppBuilder(",
            "            app,",
            "            db.session if not session else session,",
            "            security_manager_class=security_manager_class,",
            "            base_template='appbuilder/baselayout.html')",
            "",
            "        def init_views(appbuilder):",
            "            from airflow.www_rbac import views",
            "            appbuilder.add_view_no_menu(views.Airflow())",
            "            appbuilder.add_view_no_menu(views.DagModelView())",
            "            appbuilder.add_view_no_menu(views.ConfigurationView())",
            "            appbuilder.add_view_no_menu(views.VersionView())",
            "            appbuilder.add_view(views.DagRunModelView,",
            "                                \"DAG Runs\",",
            "                                category=\"Browse\",",
            "                                category_icon=\"fa-globe\")",
            "            appbuilder.add_view(views.JobModelView,",
            "                                \"Jobs\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_view(views.LogModelView,",
            "                                \"Logs\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_view(views.SlaMissModelView,",
            "                                \"SLA Misses\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_view(views.TaskInstanceModelView,",
            "                                \"Task Instances\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_link(\"Configurations\",",
            "                                href='/configuration',",
            "                                category=\"Admin\",",
            "                                category_icon=\"fa-user\")",
            "            appbuilder.add_view(views.ConnectionModelView,",
            "                                \"Connections\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_view(views.PoolModelView,",
            "                                \"Pools\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_view(views.VariableModelView,",
            "                                \"Variables\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_view(views.XComModelView,",
            "                                \"XComs\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_link(\"Documentation\",",
            "                                href='https://airflow.apache.org/',",
            "                                category=\"Docs\",",
            "                                category_icon=\"fa-cube\")",
            "            appbuilder.add_link(\"Github\",",
            "                                href='https://github.com/apache/incubator-airflow',",
            "                                category=\"Docs\")",
            "            appbuilder.add_link('Version',",
            "                                href='/version',",
            "                                category='About',",
            "                                category_icon='fa-th')",
            "",
            "            # Garbage collect old permissions/views after they have been modified.",
            "            # Otherwise, when the name of a view or menu is changed, the framework",
            "            # will add the new Views and Menus names to the backend, but will not",
            "            # delete the old ones.",
            "",
            "        init_views(appbuilder)",
            "",
            "        security_manager = appbuilder.sm",
            "        security_manager.sync_roles()",
            "",
            "        from airflow.www_rbac.api.experimental import endpoints as e",
            "        # required for testing purposes otherwise the module retains",
            "        # a link to the default_auth",
            "        if app.config['TESTING']:",
            "            if six.PY2:",
            "                reload(e) # noqa",
            "            else:",
            "                import importlib",
            "                importlib.reload(e)",
            "",
            "        app.register_blueprint(e.api_experimental, url_prefix='/api/experimental')",
            "",
            "        @app.context_processor",
            "        def jinja_globals():",
            "            return {",
            "                'hostname': socket.getfqdn(),",
            "                'navbar_color': conf.get('webserver', 'NAVBAR_COLOR'),",
            "            }",
            "",
            "        @app.teardown_appcontext",
            "        def shutdown_session(exception=None):",
            "            settings.Session.remove()",
            "",
            "    return app, appbuilder",
            "",
            "",
            "def root_app(env, resp):",
            "    resp(b'404 Not Found', [(b'Content-Type', b'text/plain')])",
            "    return [b'Apache Airflow is not at this location']",
            "",
            "",
            "def cached_app(config=None, session=None, testing=False):",
            "    global app, appbuilder",
            "    if not app or not appbuilder:",
            "        base_url = urlparse(conf.get('webserver', 'base_url'))[2]",
            "        if not base_url or base_url == '/':",
            "            base_url = \"\"",
            "",
            "        app, _ = create_app(config, session, testing)",
            "        app = DispatcherMiddleware(root_app, {base_url: app})",
            "    return app",
            "",
            "",
            "def cached_appbuilder(config=None, testing=False):",
            "    global appbuilder",
            "    cached_app(config, testing)",
            "    return appbuilder"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "#",
            "# Licensed to the Apache Software Foundation (ASF) under one",
            "# or more contributor license agreements.  See the NOTICE file",
            "# distributed with this work for additional information",
            "# regarding copyright ownership.  The ASF licenses this file",
            "# to you under the Apache License, Version 2.0 (the",
            "# \"License\"); you may not use this file except in compliance",
            "# with the License.  You may obtain a copy of the License at",
            "#",
            "#   http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing,",
            "# software distributed under the License is distributed on an",
            "# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY",
            "# KIND, either express or implied.  See the License for the",
            "# specific language governing permissions and limitations",
            "# under the License.",
            "#",
            "import socket",
            "import six",
            "import os",
            "",
            "from flask import Flask",
            "from flask_appbuilder import AppBuilder, SQLA",
            "from flask_caching import Cache",
            "from flask_wtf.csrf import CSRFProtect",
            "from six.moves.urllib.parse import urlparse",
            "from werkzeug.wsgi import DispatcherMiddleware",
            "from werkzeug.contrib.fixers import ProxyFix",
            "",
            "from airflow import settings",
            "from airflow import configuration as conf",
            "from airflow.logging_config import configure_logging",
            "from airflow.www_rbac.static_config import configure_manifest_files",
            "",
            "app = None",
            "appbuilder = None",
            "csrf = CSRFProtect()",
            "",
            "",
            "def create_app(config=None, session=None, testing=False, app_name=\"Airflow\"):",
            "    global app, appbuilder",
            "    app = Flask(__name__)",
            "    app.wsgi_app = ProxyFix(app.wsgi_app)",
            "    app.secret_key = conf.get('webserver', 'SECRET_KEY')",
            "",
            "    airflow_home_path = conf.get('core', 'AIRFLOW_HOME')",
            "    webserver_config_path = airflow_home_path + '/webserver_config.py'",
            "    app.config.from_pyfile(webserver_config_path, silent=True)",
            "    app.config['APP_NAME'] = app_name",
            "    app.config['TESTING'] = testing",
            "",
            "    csrf.init_app(app)",
            "",
            "    db = SQLA(app)",
            "",
            "    from airflow import api",
            "    api.load_auth()",
            "    api.api_auth.init_app(app)",
            "",
            "    cache = Cache(app=app, config={'CACHE_TYPE': 'filesystem', 'CACHE_DIR': '/tmp'})  # noqa",
            "",
            "    from airflow.www_rbac.blueprints import routes",
            "    app.register_blueprint(routes)",
            "",
            "    configure_logging()",
            "    configure_manifest_files(app)",
            "",
            "    with app.app_context():",
            "",
            "        from airflow.www_rbac.security import AirflowSecurityManager",
            "        security_manager_class = app.config.get('SECURITY_MANAGER_CLASS') or \\",
            "            AirflowSecurityManager",
            "",
            "        if not issubclass(security_manager_class, AirflowSecurityManager):",
            "            raise Exception(",
            "                \"\"\"Your CUSTOM_SECURITY_MANAGER must now extend AirflowSecurityManager,",
            "                 not FAB's security manager.\"\"\")",
            "",
            "        appbuilder = AppBuilder(",
            "            app,",
            "            db.session if not session else session,",
            "            security_manager_class=security_manager_class,",
            "            base_template='appbuilder/baselayout.html')",
            "",
            "        def init_views(appbuilder):",
            "            from airflow.www_rbac import views",
            "            appbuilder.add_view_no_menu(views.Airflow())",
            "            appbuilder.add_view_no_menu(views.DagModelView())",
            "            appbuilder.add_view_no_menu(views.ConfigurationView())",
            "            appbuilder.add_view_no_menu(views.VersionView())",
            "            appbuilder.add_view(views.DagRunModelView,",
            "                                \"DAG Runs\",",
            "                                category=\"Browse\",",
            "                                category_icon=\"fa-globe\")",
            "            appbuilder.add_view(views.JobModelView,",
            "                                \"Jobs\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_view(views.LogModelView,",
            "                                \"Logs\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_view(views.SlaMissModelView,",
            "                                \"SLA Misses\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_view(views.TaskInstanceModelView,",
            "                                \"Task Instances\",",
            "                                category=\"Browse\")",
            "            appbuilder.add_link(\"Configurations\",",
            "                                href='/configuration',",
            "                                category=\"Admin\",",
            "                                category_icon=\"fa-user\")",
            "            appbuilder.add_view(views.ConnectionModelView,",
            "                                \"Connections\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_view(views.PoolModelView,",
            "                                \"Pools\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_view(views.VariableModelView,",
            "                                \"Variables\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_view(views.XComModelView,",
            "                                \"XComs\",",
            "                                category=\"Admin\")",
            "            appbuilder.add_link(\"Documentation\",",
            "                                href='https://airflow.apache.org/',",
            "                                category=\"Docs\",",
            "                                category_icon=\"fa-cube\")",
            "            appbuilder.add_link(\"Github\",",
            "                                href='https://github.com/apache/incubator-airflow',",
            "                                category=\"Docs\")",
            "            appbuilder.add_link('Version',",
            "                                href='/version',",
            "                                category='About',",
            "                                category_icon='fa-th')",
            "",
            "            # Garbage collect old permissions/views after they have been modified.",
            "            # Otherwise, when the name of a view or menu is changed, the framework",
            "            # will add the new Views and Menus names to the backend, but will not",
            "            # delete the old ones.",
            "",
            "        init_views(appbuilder)",
            "",
            "        security_manager = appbuilder.sm",
            "        security_manager.sync_roles()",
            "",
            "        from airflow.www_rbac.api.experimental import endpoints as e",
            "        # required for testing purposes otherwise the module retains",
            "        # a link to the default_auth",
            "        if app.config['TESTING']:",
            "            if six.PY2:",
            "                reload(e) # noqa",
            "            else:",
            "                import importlib",
            "                importlib.reload(e)",
            "",
            "        app.register_blueprint(e.api_experimental, url_prefix='/api/experimental')",
            "",
            "        @app.context_processor",
            "        def jinja_globals():",
            "            return {",
            "                'hostname': socket.getfqdn(),",
            "                'navbar_color': conf.get('webserver', 'NAVBAR_COLOR'),",
            "            }",
            "",
            "        @app.teardown_appcontext",
            "        def shutdown_session(exception=None):",
            "            settings.Session.remove()",
            "",
            "    return app, appbuilder",
            "",
            "",
            "def root_app(env, resp):",
            "    resp(b'404 Not Found', [(b'Content-Type', b'text/plain')])",
            "    return [b'Apache Airflow is not at this location']",
            "",
            "",
            "def cached_app(config=None, session=None, testing=False):",
            "    global app, appbuilder",
            "    if not app or not appbuilder:",
            "        base_url = urlparse(conf.get('webserver', 'base_url'))[2]",
            "        if not base_url or base_url == '/':",
            "            base_url = \"\"",
            "",
            "        app, _ = create_app(config, session, testing)",
            "        app = DispatcherMiddleware(root_app, {base_url: app})",
            "    return app",
            "",
            "",
            "def cached_appbuilder(config=None, testing=False):",
            "    global appbuilder",
            "    cached_app(config, testing)",
            "    return appbuilder"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "46": [
                "create_app"
            ],
            "47": [
                "create_app"
            ],
            "48": [
                "create_app"
            ],
            "49": [
                "create_app"
            ]
        },
        "addLocation": []
    }
}