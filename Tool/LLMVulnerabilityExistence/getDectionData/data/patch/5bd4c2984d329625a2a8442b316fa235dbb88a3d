{
    "keystone/middleware/ec2_token.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 20,
                "afterPatchRowNumber": 20,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 21,
                "afterPatchRowNumber": 21,
                "PatchRowcode": " \"\"\""
            },
            "2": {
                "beforePatchRowNumber": 22,
                "afterPatchRowNumber": 22,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 23,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from eventlet.green import httplib"
            },
            "4": {
                "beforePatchRowNumber": 24,
                "afterPatchRowNumber": 23,
                "PatchRowcode": " from oslo.config import cfg"
            },
            "5": {
                "beforePatchRowNumber": 25,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-from six.moves import urllib"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 24,
                "PatchRowcode": "+import requests"
            },
            "7": {
                "beforePatchRowNumber": 26,
                "afterPatchRowNumber": 25,
                "PatchRowcode": " import webob.dec"
            },
            "8": {
                "beforePatchRowNumber": 27,
                "afterPatchRowNumber": 26,
                "PatchRowcode": " import webob.exc"
            },
            "9": {
                "beforePatchRowNumber": 28,
                "afterPatchRowNumber": 27,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 34,
                "afterPatchRowNumber": 33,
                "PatchRowcode": "     cfg.StrOpt('keystone_ec2_url',"
            },
            "11": {
                "beforePatchRowNumber": 35,
                "afterPatchRowNumber": 34,
                "PatchRowcode": "                default='http://localhost:5000/v2.0/ec2tokens',"
            },
            "12": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 35,
                "PatchRowcode": "                help='URL to get token from ec2 request.'),"
            },
            "13": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 36,
                "PatchRowcode": "+    cfg.StrOpt('keystone_ec2_keyfile', help='Required if EC2 server requires '"
            },
            "14": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 37,
                "PatchRowcode": "+               'client certificate.'),"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 38,
                "PatchRowcode": "+    cfg.StrOpt('keystone_ec2_certfile', help='Client certificate key '"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+               'filename. Required if EC2 server requires client '"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+               'certificate.'),"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    cfg.StrOpt('keystone_ec2_cafile', help='A PEM encoded certificate '"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 42,
                "PatchRowcode": "+               'authority to use when verifying HTTPS connections. Defaults '"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+               'to the system CAs.'),"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+    cfg.BoolOpt('keystone_ec2_insecure', default=False, help='Disable SSL '"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+                'certificate verification.'),"
            },
            "23": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 46,
                "PatchRowcode": " ]"
            },
            "24": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 47,
                "PatchRowcode": " "
            },
            "25": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": 48,
                "PatchRowcode": " CONF = config.CONF"
            },
            "26": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 80,
                "PatchRowcode": "         creds_json = jsonutils.dumps(creds)"
            },
            "27": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 81,
                "PatchRowcode": "         headers = {'Content-Type': 'application/json'}"
            },
            "28": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 82,
                "PatchRowcode": " "
            },
            "29": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Disable 'has no x member' pylint error"
            },
            "30": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # for httplib and urlparse"
            },
            "31": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # pylint: disable-msg=E1101"
            },
            "32": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        o = urllib.parse.urlparse(CONF.keystone_ec2_url)"
            },
            "33": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        if o.scheme == 'http':"
            },
            "34": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            conn = httplib.HTTPConnection(o.netloc)"
            },
            "35": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        else:"
            },
            "36": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            conn = httplib.HTTPSConnection(o.netloc)"
            },
            "37": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        conn.request('POST', o.path, body=creds_json, headers=headers)"
            },
            "38": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        response = conn.getresponse().read()"
            },
            "39": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        conn.close()"
            },
            "40": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+        verify = True"
            },
            "41": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        if CONF.keystone_ec2_insecure:"
            },
            "42": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+            verify = False"
            },
            "43": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+        elif CONF.keystone_ec2_cafile:"
            },
            "44": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 87,
                "PatchRowcode": "+            verify = CONF.keystone_ec2_cafile"
            },
            "45": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+"
            },
            "46": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 89,
                "PatchRowcode": "+        cert = None"
            },
            "47": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 90,
                "PatchRowcode": "+        if CONF.keystone_ec2_certfile and CONF.keystone_ec2_keyfile:"
            },
            "48": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 91,
                "PatchRowcode": "+            cert = (CONF.keystone_ec2_certfile, CONF.keystone_ec2_keyfile)"
            },
            "49": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 92,
                "PatchRowcode": "+        elif CONF.keystone_ec2_certfile:"
            },
            "50": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+            cert = CONF.keystone_ec2_certfile"
            },
            "51": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+"
            },
            "52": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 95,
                "PatchRowcode": "+        response = requests.post(CONF.keystone_ec2_url, data=creds_json,"
            },
            "53": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 96,
                "PatchRowcode": "+                                 headers=headers, verify=verify, cert=cert)"
            },
            "54": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 97,
                "PatchRowcode": " "
            },
            "55": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 98,
                "PatchRowcode": "         # NOTE(vish): We could save a call to keystone by"
            },
            "56": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 99,
                "PatchRowcode": "         #             having keystone return token, tenant,"
            },
            "57": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 100,
                "PatchRowcode": "         #             user, and roles from this call."
            },
            "58": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 101,
                "PatchRowcode": " "
            },
            "59": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        result = jsonutils.loads(response)"
            },
            "60": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 102,
                "PatchRowcode": "+        result = response.json()"
            },
            "61": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 103,
                "PatchRowcode": "         try:"
            },
            "62": {
                "beforePatchRowNumber": 92,
                "afterPatchRowNumber": 104,
                "PatchRowcode": "             token_id = result['access']['token']['id']"
            },
            "63": {
                "beforePatchRowNumber": 93,
                "afterPatchRowNumber": 105,
                "PatchRowcode": "         except (AttributeError, KeyError):"
            }
        },
        "frontPatchFile": [
            "# Copyright 2012 OpenStack Foundation",
            "# Copyright 2010 United States Government as represented by the",
            "# Administrator of the National Aeronautics and Space Administration.",
            "# All Rights Reserved.",
            "#",
            "# Licensed under the Apache License, Version 2.0 (the \"License\"); you may",
            "# not use this file except in compliance with the License. You may obtain",
            "# a copy of the License at",
            "#",
            "#      http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing, software",
            "# distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT",
            "# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations",
            "# under the License.",
            "",
            "\"\"\"",
            "Starting point for routing EC2 requests.",
            "",
            "\"\"\"",
            "",
            "from eventlet.green import httplib",
            "from oslo.config import cfg",
            "from six.moves import urllib",
            "import webob.dec",
            "import webob.exc",
            "",
            "from keystone.common import config",
            "from keystone.common import wsgi",
            "from keystone.openstack.common import jsonutils",
            "",
            "keystone_ec2_opts = [",
            "    cfg.StrOpt('keystone_ec2_url',",
            "               default='http://localhost:5000/v2.0/ec2tokens',",
            "               help='URL to get token from ec2 request.'),",
            "]",
            "",
            "CONF = config.CONF",
            "CONF.register_opts(keystone_ec2_opts)",
            "",
            "",
            "class EC2Token(wsgi.Middleware):",
            "    \"\"\"Authenticate an EC2 request with keystone and convert to token.\"\"\"",
            "",
            "    @webob.dec.wsgify()",
            "    def __call__(self, req):",
            "        # Read request signature and access id.",
            "        try:",
            "            signature = req.params['Signature']",
            "            access = req.params['AWSAccessKeyId']",
            "        except KeyError:",
            "            raise webob.exc.HTTPBadRequest()",
            "",
            "        # Make a copy of args for authentication and signature verification.",
            "        auth_params = dict(req.params)",
            "        # Not part of authentication args",
            "        auth_params.pop('Signature')",
            "",
            "        # Authenticate the request.",
            "        creds = {",
            "            'ec2Credentials': {",
            "                'access': access,",
            "                'signature': signature,",
            "                'host': req.host,",
            "                'verb': req.method,",
            "                'path': req.path,",
            "                'params': auth_params,",
            "            }",
            "        }",
            "        creds_json = jsonutils.dumps(creds)",
            "        headers = {'Content-Type': 'application/json'}",
            "",
            "        # Disable 'has no x member' pylint error",
            "        # for httplib and urlparse",
            "        # pylint: disable-msg=E1101",
            "        o = urllib.parse.urlparse(CONF.keystone_ec2_url)",
            "        if o.scheme == 'http':",
            "            conn = httplib.HTTPConnection(o.netloc)",
            "        else:",
            "            conn = httplib.HTTPSConnection(o.netloc)",
            "        conn.request('POST', o.path, body=creds_json, headers=headers)",
            "        response = conn.getresponse().read()",
            "        conn.close()",
            "",
            "        # NOTE(vish): We could save a call to keystone by",
            "        #             having keystone return token, tenant,",
            "        #             user, and roles from this call.",
            "",
            "        result = jsonutils.loads(response)",
            "        try:",
            "            token_id = result['access']['token']['id']",
            "        except (AttributeError, KeyError):",
            "            raise webob.exc.HTTPBadRequest()",
            "",
            "        # Authenticated!",
            "        req.headers['X-Auth-Token'] = token_id",
            "        return self.application"
        ],
        "afterPatchFile": [
            "# Copyright 2012 OpenStack Foundation",
            "# Copyright 2010 United States Government as represented by the",
            "# Administrator of the National Aeronautics and Space Administration.",
            "# All Rights Reserved.",
            "#",
            "# Licensed under the Apache License, Version 2.0 (the \"License\"); you may",
            "# not use this file except in compliance with the License. You may obtain",
            "# a copy of the License at",
            "#",
            "#      http://www.apache.org/licenses/LICENSE-2.0",
            "#",
            "# Unless required by applicable law or agreed to in writing, software",
            "# distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT",
            "# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the",
            "# License for the specific language governing permissions and limitations",
            "# under the License.",
            "",
            "\"\"\"",
            "Starting point for routing EC2 requests.",
            "",
            "\"\"\"",
            "",
            "from oslo.config import cfg",
            "import requests",
            "import webob.dec",
            "import webob.exc",
            "",
            "from keystone.common import config",
            "from keystone.common import wsgi",
            "from keystone.openstack.common import jsonutils",
            "",
            "keystone_ec2_opts = [",
            "    cfg.StrOpt('keystone_ec2_url',",
            "               default='http://localhost:5000/v2.0/ec2tokens',",
            "               help='URL to get token from ec2 request.'),",
            "    cfg.StrOpt('keystone_ec2_keyfile', help='Required if EC2 server requires '",
            "               'client certificate.'),",
            "    cfg.StrOpt('keystone_ec2_certfile', help='Client certificate key '",
            "               'filename. Required if EC2 server requires client '",
            "               'certificate.'),",
            "    cfg.StrOpt('keystone_ec2_cafile', help='A PEM encoded certificate '",
            "               'authority to use when verifying HTTPS connections. Defaults '",
            "               'to the system CAs.'),",
            "    cfg.BoolOpt('keystone_ec2_insecure', default=False, help='Disable SSL '",
            "                'certificate verification.'),",
            "]",
            "",
            "CONF = config.CONF",
            "CONF.register_opts(keystone_ec2_opts)",
            "",
            "",
            "class EC2Token(wsgi.Middleware):",
            "    \"\"\"Authenticate an EC2 request with keystone and convert to token.\"\"\"",
            "",
            "    @webob.dec.wsgify()",
            "    def __call__(self, req):",
            "        # Read request signature and access id.",
            "        try:",
            "            signature = req.params['Signature']",
            "            access = req.params['AWSAccessKeyId']",
            "        except KeyError:",
            "            raise webob.exc.HTTPBadRequest()",
            "",
            "        # Make a copy of args for authentication and signature verification.",
            "        auth_params = dict(req.params)",
            "        # Not part of authentication args",
            "        auth_params.pop('Signature')",
            "",
            "        # Authenticate the request.",
            "        creds = {",
            "            'ec2Credentials': {",
            "                'access': access,",
            "                'signature': signature,",
            "                'host': req.host,",
            "                'verb': req.method,",
            "                'path': req.path,",
            "                'params': auth_params,",
            "            }",
            "        }",
            "        creds_json = jsonutils.dumps(creds)",
            "        headers = {'Content-Type': 'application/json'}",
            "",
            "        verify = True",
            "        if CONF.keystone_ec2_insecure:",
            "            verify = False",
            "        elif CONF.keystone_ec2_cafile:",
            "            verify = CONF.keystone_ec2_cafile",
            "",
            "        cert = None",
            "        if CONF.keystone_ec2_certfile and CONF.keystone_ec2_keyfile:",
            "            cert = (CONF.keystone_ec2_certfile, CONF.keystone_ec2_keyfile)",
            "        elif CONF.keystone_ec2_certfile:",
            "            cert = CONF.keystone_ec2_certfile",
            "",
            "        response = requests.post(CONF.keystone_ec2_url, data=creds_json,",
            "                                 headers=headers, verify=verify, cert=cert)",
            "",
            "        # NOTE(vish): We could save a call to keystone by",
            "        #             having keystone return token, tenant,",
            "        #             user, and roles from this call.",
            "",
            "        result = response.json()",
            "        try:",
            "            token_id = result['access']['token']['id']",
            "        except (AttributeError, KeyError):",
            "            raise webob.exc.HTTPBadRequest()",
            "",
            "        # Authenticated!",
            "        req.headers['X-Auth-Token'] = token_id",
            "        return self.application"
        ],
        "action": [
            "0",
            "0",
            "0",
            "1",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "23": [],
            "25": [],
            "74": [
                "EC2Token",
                "__call__"
            ],
            "75": [
                "EC2Token",
                "__call__"
            ],
            "76": [
                "EC2Token",
                "__call__"
            ],
            "77": [
                "EC2Token",
                "__call__"
            ],
            "78": [
                "EC2Token",
                "__call__"
            ],
            "79": [
                "EC2Token",
                "__call__"
            ],
            "80": [
                "EC2Token",
                "__call__"
            ],
            "81": [
                "EC2Token",
                "__call__"
            ],
            "82": [
                "EC2Token",
                "__call__"
            ],
            "83": [
                "EC2Token",
                "__call__"
            ],
            "84": [
                "EC2Token",
                "__call__"
            ],
            "90": [
                "EC2Token",
                "__call__"
            ]
        },
        "addLocation": []
    }
}