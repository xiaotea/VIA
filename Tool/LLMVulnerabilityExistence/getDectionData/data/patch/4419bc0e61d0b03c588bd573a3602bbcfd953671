{
    "changedetectionio/tests/test_security.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 69,
                "PatchRowcode": "     wait_for_all_checks(client)"
            },
            "1": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "     res = client.get(url_for(\"index\"))"
            },
            "2": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 71,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 72,
                "PatchRowcode": "+    substrings = [b\"URLs with hostname components are not permitted\", b\"No connection adapters were found for\"]"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 73,
                "PatchRowcode": "+"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+"
            },
            "6": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "     # If it is enabled at test time"
            },
            "7": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 76,
                "PatchRowcode": "     if strtobool(os.getenv('ALLOW_FILE_URI', 'false')):"
            },
            "8": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # So it should permit it, but it should fall back to the 'requests' library giving an error"
            },
            "9": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # (but means it gets passed to playwright etc)"
            },
            "10": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        assert b\"URLs with hostname components are not permitted\" in res.data"
            },
            "11": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        assert b\"_runner_test_various_file_slash\" in res.data # Can read this file OK"
            },
            "12": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    else:"
            },
            "13": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        # Default should be here"
            },
            "14": {
                "beforePatchRowNumber": 80,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        assert b'file:// type access is denied for security reasons.' in res.data"
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+        if file_uri.startswith('file:///'):"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 78,
                "PatchRowcode": "+            # This one should be the full qualified path to the file and should get the contents of this file"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+            res = client.get("
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 80,
                "PatchRowcode": "+                url_for(\"preview_page\", uuid=\"first\"),"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+                follow_redirects=True"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 82,
                "PatchRowcode": "+            )"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 83,
                "PatchRowcode": "+            assert b'_runner_test_various_file_slash' in res.data"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 84,
                "PatchRowcode": "+        else:"
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 85,
                "PatchRowcode": "+            # This will give some error from requests or if it went to chrome, will give some other error :-)"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 86,
                "PatchRowcode": "+            assert any(s in res.data for s in substrings)"
            },
            "25": {
                "beforePatchRowNumber": 81,
                "afterPatchRowNumber": 87,
                "PatchRowcode": " "
            },
            "26": {
                "beforePatchRowNumber": 82,
                "afterPatchRowNumber": 88,
                "PatchRowcode": "     res = client.get(url_for(\"form_delete\", uuid=\"all\"), follow_redirects=True)"
            },
            "27": {
                "beforePatchRowNumber": 83,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "     assert b'Deleted' in res.data"
            },
            "28": {
                "beforePatchRowNumber": 84,
                "afterPatchRowNumber": 90,
                "PatchRowcode": " "
            },
            "29": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 91,
                "PatchRowcode": " def test_file_slash_access(client, live_server, measure_memory_usage):"
            },
            "30": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 92,
                "PatchRowcode": "     #live_server_setup(live_server)"
            },
            "31": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    # file: is permitted by default, but it will be caught by ALLOW_FILE_URI"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 93,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 94,
                "PatchRowcode": "+    # file: is NOT permitted by default, so it will be caught by ALLOW_FILE_URI check"
            },
            "34": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": 95,
                "PatchRowcode": " "
            },
            "35": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 96,
                "PatchRowcode": "     test_file_path = os.path.abspath(__file__)"
            },
            "36": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 97,
                "PatchRowcode": "     _runner_test_various_file_slash(client, file_uri=f\"file://{test_file_path}\")"
            }
        },
        "frontPatchFile": [
            "import os",
            "",
            "from flask import url_for",
            "from .util import live_server_setup, wait_for_all_checks",
            "from .. import strtobool",
            "",
            "",
            "def test_setup(client, live_server, measure_memory_usage):",
            "    live_server_setup(live_server)",
            "",
            "def test_bad_access(client, live_server, measure_memory_usage):",
            "    #live_server_setup(live_server)",
            "    res = client.post(",
            "        url_for(\"import_page\"),",
            "        data={\"urls\": 'https://localhost'},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b\"1 Imported\" in res.data",
            "    wait_for_all_checks(client)",
            "",
            "    # Attempt to add a body with a GET method",
            "    res = client.post(",
            "        url_for(\"edit_page\", uuid=\"first\"),",
            "        data={",
            "              \"url\": 'javascript:alert(document.domain)',",
            "              \"tags\": \"\",",
            "              \"method\": \"GET\",",
            "              \"fetch_backend\": \"html_requests\",",
            "              \"body\": \"\"},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "    res = client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": '            javascript:alert(123)', \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "    res = client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": '%20%20%20javascript:alert(123)%20%20', \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "",
            "    res = client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": ' source:javascript:alert(document.domain)', \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "",
            "def _runner_test_various_file_slash(client, file_uri):",
            "",
            "    client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": file_uri, \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "    wait_for_all_checks(client)",
            "    res = client.get(url_for(\"index\"))",
            "",
            "    # If it is enabled at test time",
            "    if strtobool(os.getenv('ALLOW_FILE_URI', 'false')):",
            "        # So it should permit it, but it should fall back to the 'requests' library giving an error",
            "        # (but means it gets passed to playwright etc)",
            "        assert b\"URLs with hostname components are not permitted\" in res.data",
            "        assert b\"_runner_test_various_file_slash\" in res.data # Can read this file OK",
            "    else:",
            "        # Default should be here",
            "        assert b'file:// type access is denied for security reasons.' in res.data",
            "",
            "    res = client.get(url_for(\"form_delete\", uuid=\"all\"), follow_redirects=True)",
            "    assert b'Deleted' in res.data",
            "",
            "def test_file_slash_access(client, live_server, measure_memory_usage):",
            "    #live_server_setup(live_server)",
            "    # file: is permitted by default, but it will be caught by ALLOW_FILE_URI",
            "",
            "    test_file_path = os.path.abspath(__file__)",
            "    _runner_test_various_file_slash(client, file_uri=f\"file://{test_file_path}\")",
            "    _runner_test_various_file_slash(client, file_uri=f\"file:/{test_file_path}\")",
            "    _runner_test_various_file_slash(client, file_uri=f\"file:{test_file_path}\") # CVE-2024-56509",
            "",
            "def test_xss(client, live_server, measure_memory_usage):",
            "    #live_server_setup(live_server)",
            "    from changedetectionio.notification import (",
            "        default_notification_format",
            "    )",
            "    # the template helpers were named .jinja which meant they were not having jinja2 autoescape enabled.",
            "    res = client.post(",
            "        url_for(\"settings_page\"),",
            "        data={\"application-notification_urls\": '\"><img src=x onerror=alert(document.domain)>',",
            "              \"application-notification_title\": '\"><img src=x onerror=alert(document.domain)>',",
            "              \"application-notification_body\": '\"><img src=x onerror=alert(document.domain)>',",
            "              \"application-notification_format\": default_notification_format,",
            "              \"requests-time_between_check-minutes\": 180,",
            "              'application-fetch_backend': \"html_requests\"},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b\"<img src=x onerror=alert(\" not in res.data",
            "    assert b\"&lt;img\" in res.data"
        ],
        "afterPatchFile": [
            "import os",
            "",
            "from flask import url_for",
            "from .util import live_server_setup, wait_for_all_checks",
            "from .. import strtobool",
            "",
            "",
            "def test_setup(client, live_server, measure_memory_usage):",
            "    live_server_setup(live_server)",
            "",
            "def test_bad_access(client, live_server, measure_memory_usage):",
            "    #live_server_setup(live_server)",
            "    res = client.post(",
            "        url_for(\"import_page\"),",
            "        data={\"urls\": 'https://localhost'},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b\"1 Imported\" in res.data",
            "    wait_for_all_checks(client)",
            "",
            "    # Attempt to add a body with a GET method",
            "    res = client.post(",
            "        url_for(\"edit_page\", uuid=\"first\"),",
            "        data={",
            "              \"url\": 'javascript:alert(document.domain)',",
            "              \"tags\": \"\",",
            "              \"method\": \"GET\",",
            "              \"fetch_backend\": \"html_requests\",",
            "              \"body\": \"\"},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "    res = client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": '            javascript:alert(123)', \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "    res = client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": '%20%20%20javascript:alert(123)%20%20', \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "",
            "    res = client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": ' source:javascript:alert(document.domain)', \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b'Watch protocol is not permitted by SAFE_PROTOCOL_REGEX' in res.data",
            "",
            "",
            "def _runner_test_various_file_slash(client, file_uri):",
            "",
            "    client.post(",
            "        url_for(\"form_quick_watch_add\"),",
            "        data={\"url\": file_uri, \"tags\": ''},",
            "        follow_redirects=True",
            "    )",
            "    wait_for_all_checks(client)",
            "    res = client.get(url_for(\"index\"))",
            "",
            "    substrings = [b\"URLs with hostname components are not permitted\", b\"No connection adapters were found for\"]",
            "",
            "",
            "    # If it is enabled at test time",
            "    if strtobool(os.getenv('ALLOW_FILE_URI', 'false')):",
            "        if file_uri.startswith('file:///'):",
            "            # This one should be the full qualified path to the file and should get the contents of this file",
            "            res = client.get(",
            "                url_for(\"preview_page\", uuid=\"first\"),",
            "                follow_redirects=True",
            "            )",
            "            assert b'_runner_test_various_file_slash' in res.data",
            "        else:",
            "            # This will give some error from requests or if it went to chrome, will give some other error :-)",
            "            assert any(s in res.data for s in substrings)",
            "",
            "    res = client.get(url_for(\"form_delete\", uuid=\"all\"), follow_redirects=True)",
            "    assert b'Deleted' in res.data",
            "",
            "def test_file_slash_access(client, live_server, measure_memory_usage):",
            "    #live_server_setup(live_server)",
            "",
            "    # file: is NOT permitted by default, so it will be caught by ALLOW_FILE_URI check",
            "",
            "    test_file_path = os.path.abspath(__file__)",
            "    _runner_test_various_file_slash(client, file_uri=f\"file://{test_file_path}\")",
            "    _runner_test_various_file_slash(client, file_uri=f\"file:/{test_file_path}\")",
            "    _runner_test_various_file_slash(client, file_uri=f\"file:{test_file_path}\") # CVE-2024-56509",
            "",
            "def test_xss(client, live_server, measure_memory_usage):",
            "    #live_server_setup(live_server)",
            "    from changedetectionio.notification import (",
            "        default_notification_format",
            "    )",
            "    # the template helpers were named .jinja which meant they were not having jinja2 autoescape enabled.",
            "    res = client.post(",
            "        url_for(\"settings_page\"),",
            "        data={\"application-notification_urls\": '\"><img src=x onerror=alert(document.domain)>',",
            "              \"application-notification_title\": '\"><img src=x onerror=alert(document.domain)>',",
            "              \"application-notification_body\": '\"><img src=x onerror=alert(document.domain)>',",
            "              \"application-notification_format\": default_notification_format,",
            "              \"requests-time_between_check-minutes\": 180,",
            "              'application-fetch_backend': \"html_requests\"},",
            "        follow_redirects=True",
            "    )",
            "",
            "    assert b\"<img src=x onerror=alert(\" not in res.data",
            "    assert b\"&lt;img\" in res.data"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "74": [
                "_runner_test_various_file_slash"
            ],
            "75": [
                "_runner_test_various_file_slash"
            ],
            "76": [
                "_runner_test_various_file_slash"
            ],
            "77": [
                "_runner_test_various_file_slash"
            ],
            "78": [
                "_runner_test_various_file_slash"
            ],
            "79": [
                "_runner_test_various_file_slash"
            ],
            "80": [
                "_runner_test_various_file_slash"
            ],
            "87": [
                "test_file_slash_access"
            ]
        },
        "addLocation": [
            "changedetectionio.tests.test_security.test_file_slash_access",
            "src.werkzeug.middleware.shared_data"
        ]
    }
}