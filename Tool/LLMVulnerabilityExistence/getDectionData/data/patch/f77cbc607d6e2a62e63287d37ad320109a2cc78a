{
    "cms/admin/pageadmin.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 928,
                "afterPatchRowNumber": 928,
                "PatchRowcode": "             helpers.make_revision_with_plugins(page, request.user, message)"
            },
            "1": {
                "beforePatchRowNumber": 929,
                "afterPatchRowNumber": 929,
                "PatchRowcode": "         return HttpResponse(force_unicode(_(\"The template was successfully changed\")))"
            },
            "2": {
                "beforePatchRowNumber": 930,
                "afterPatchRowNumber": 930,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 931,
                "PatchRowcode": "+    @require_POST"
            },
            "4": {
                "beforePatchRowNumber": 931,
                "afterPatchRowNumber": 932,
                "PatchRowcode": "     @wrap_transaction"
            },
            "5": {
                "beforePatchRowNumber": 932,
                "afterPatchRowNumber": 933,
                "PatchRowcode": "     def move_page(self, request, page_id, extra_context=None):"
            },
            "6": {
                "beforePatchRowNumber": 933,
                "afterPatchRowNumber": 934,
                "PatchRowcode": "         \"\"\""
            },
            "7": {
                "beforePatchRowNumber": 1013,
                "afterPatchRowNumber": 1014,
                "PatchRowcode": "                 helpers.make_revision_with_plugins(page, request.user, message)"
            },
            "8": {
                "beforePatchRowNumber": 1014,
                "afterPatchRowNumber": 1015,
                "PatchRowcode": "             return HttpResponse(\"ok\")"
            },
            "9": {
                "beforePatchRowNumber": 1015,
                "afterPatchRowNumber": 1016,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1017,
                "PatchRowcode": "+    @require_POST"
            },
            "11": {
                "beforePatchRowNumber": 1016,
                "afterPatchRowNumber": 1018,
                "PatchRowcode": "     @wrap_transaction"
            },
            "12": {
                "beforePatchRowNumber": 1017,
                "afterPatchRowNumber": 1019,
                "PatchRowcode": "     def copy_page(self, request, page_id, extra_context=None):"
            },
            "13": {
                "beforePatchRowNumber": 1018,
                "afterPatchRowNumber": 1020,
                "PatchRowcode": "         \"\"\""
            },
            "14": {
                "beforePatchRowNumber": 1046,
                "afterPatchRowNumber": 1048,
                "PatchRowcode": "         context.update(extra_context or {})"
            },
            "15": {
                "beforePatchRowNumber": 1047,
                "afterPatchRowNumber": 1049,
                "PatchRowcode": "         return HttpResponseRedirect('../../')"
            },
            "16": {
                "beforePatchRowNumber": 1048,
                "afterPatchRowNumber": 1050,
                "PatchRowcode": " "
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1051,
                "PatchRowcode": "+    @require_POST"
            },
            "18": {
                "beforePatchRowNumber": 1049,
                "afterPatchRowNumber": 1052,
                "PatchRowcode": "     @wrap_transaction"
            },
            "19": {
                "beforePatchRowNumber": 1050,
                "afterPatchRowNumber": 1053,
                "PatchRowcode": "     @create_revision()"
            },
            "20": {
                "beforePatchRowNumber": 1051,
                "afterPatchRowNumber": 1054,
                "PatchRowcode": "     def publish_page(self, request, page_id, language):"
            },
            "21": {
                "beforePatchRowNumber": 1146,
                "afterPatchRowNumber": 1149,
                "PatchRowcode": "                         revision.delete()"
            },
            "22": {
                "beforePatchRowNumber": 1147,
                "afterPatchRowNumber": 1150,
                "PatchRowcode": "                         deleted.append(revision.pk)"
            },
            "23": {
                "beforePatchRowNumber": 1148,
                "afterPatchRowNumber": 1151,
                "PatchRowcode": " "
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1152,
                "PatchRowcode": "+    @require_POST"
            },
            "25": {
                "beforePatchRowNumber": 1149,
                "afterPatchRowNumber": 1153,
                "PatchRowcode": "     @wrap_transaction"
            },
            "26": {
                "beforePatchRowNumber": 1150,
                "afterPatchRowNumber": 1154,
                "PatchRowcode": "     def unpublish(self, request, page_id, language):"
            },
            "27": {
                "beforePatchRowNumber": 1151,
                "afterPatchRowNumber": 1155,
                "PatchRowcode": "         \"\"\""
            },
            "28": {
                "beforePatchRowNumber": 1181,
                "afterPatchRowNumber": 1185,
                "PatchRowcode": "             path = \"%s?language=%s&page_id=%s\" % (path, request.GET.get('redirect_language'), request.GET.get('redirect_page_id'))"
            },
            "29": {
                "beforePatchRowNumber": 1182,
                "afterPatchRowNumber": 1186,
                "PatchRowcode": "         return HttpResponseRedirect(path)"
            },
            "30": {
                "beforePatchRowNumber": 1183,
                "afterPatchRowNumber": 1187,
                "PatchRowcode": " "
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1188,
                "PatchRowcode": "+    @require_POST"
            },
            "32": {
                "beforePatchRowNumber": 1184,
                "afterPatchRowNumber": 1189,
                "PatchRowcode": "     @wrap_transaction"
            },
            "33": {
                "beforePatchRowNumber": 1185,
                "afterPatchRowNumber": 1190,
                "PatchRowcode": "     def revert_page(self, request, page_id, language):"
            },
            "34": {
                "beforePatchRowNumber": 1186,
                "afterPatchRowNumber": 1191,
                "PatchRowcode": "         page = get_object_or_404(Page, id=page_id)"
            },
            "35": {
                "beforePatchRowNumber": 1316,
                "afterPatchRowNumber": 1321,
                "PatchRowcode": "             page.site.domain, url)"
            },
            "36": {
                "beforePatchRowNumber": 1317,
                "afterPatchRowNumber": 1322,
                "PatchRowcode": "         return HttpResponseRedirect(url)"
            },
            "37": {
                "beforePatchRowNumber": 1318,
                "afterPatchRowNumber": 1323,
                "PatchRowcode": " "
            },
            "38": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 1324,
                "PatchRowcode": "+    @require_POST"
            },
            "39": {
                "beforePatchRowNumber": 1319,
                "afterPatchRowNumber": 1325,
                "PatchRowcode": "     def change_innavigation(self, request, page_id):"
            },
            "40": {
                "beforePatchRowNumber": 1320,
                "afterPatchRowNumber": 1326,
                "PatchRowcode": "         \"\"\""
            },
            "41": {
                "beforePatchRowNumber": 1321,
                "afterPatchRowNumber": 1327,
                "PatchRowcode": "         Switch the in_navigation of a page"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import copy",
            "from functools import wraps",
            "import json",
            "import sys",
            "",
            "import django",
            "from django.contrib.admin.helpers import AdminForm",
            "from django.conf import settings",
            "from django.contrib import admin, messages",
            "from django.contrib.admin.models import LogEntry, CHANGE",
            "from django.contrib.admin.options import IncorrectLookupParameters",
            "from django.contrib.admin.util import get_deleted_objects",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.contrib.sites.models import Site, get_current_site",
            "from django.core.exceptions import PermissionDenied, ObjectDoesNotExist, ValidationError",
            "from django.db import router",
            "from django.db.models import Q",
            "from django.http import HttpResponseRedirect, HttpResponse, Http404, HttpResponseBadRequest, HttpResponseForbidden",
            "from django.shortcuts import render_to_response, get_object_or_404",
            "from django.template.context import RequestContext",
            "from django.template.defaultfilters import escape",
            "from django.utils.translation import ugettext_lazy as _, get_language",
            "from django.utils.decorators import method_decorator",
            "from django.views.decorators.http import require_POST",
            "",
            "from cms.admin.change_list import CMSChangeList",
            "from cms.admin.dialog.views import get_copy_dialog",
            "from cms.admin.forms import (PageForm, AdvancedSettingsForm, PagePermissionForm,",
            "                             PublicationDatesForm)",
            "from cms.admin.permissionadmin import (PERMISSION_ADMIN_INLINES, PagePermissionInlineAdmin, ViewRestrictionInlineAdmin)",
            "from cms.admin.placeholderadmin import PlaceholderAdminMixin",
            "from cms.admin.views import revert_plugins",
            "from cms.constants import PAGE_TYPES_ID, PUBLISHER_STATE_PENDING",
            "from cms.models import Page, Title, CMSPlugin, PagePermission, GlobalPagePermission, StaticPlaceholder",
            "from cms.models.managers import PagePermissionsPermissionManager",
            "from cms.plugin_pool import plugin_pool",
            "from cms.toolbar_pool import toolbar_pool",
            "from cms.utils import helpers, permissions, get_language_from_request, admin as admin_utils, copy_plugins",
            "from cms.utils.i18n import get_language_list, get_language_tuple, get_language_object, force_language",
            "from cms.utils.admin import jsonify_request",
            "from cms.utils.compat import DJANGO_1_4",
            "from cms.utils.compat.dj import force_unicode, is_installed",
            "from cms.utils.compat.urls import unquote",
            "from cms.utils.conf import get_cms_setting",
            "from cms.utils.helpers import find_placeholder_relation",
            "from cms.utils.permissions import has_global_page_permission, has_generic_permission",
            "from cms.utils.plugins import current_site",
            "from cms.utils.transaction import wrap_transaction",
            "from cms.utils.urlutils import add_url_parameters, admin_reverse",
            "",
            "require_POST = method_decorator(require_POST)",
            "",
            "if is_installed('reversion'):",
            "    from reversion.admin import VersionAdmin as ModelAdmin",
            "    from reversion import create_revision",
            "else:  # pragma: no cover",
            "    from django.contrib.admin import ModelAdmin",
            "",
            "    class ReversionContext(object):",
            "        def __enter__(self):",
            "            yield",
            "",
            "        def __exit__(self, exc_type, exc_val, exc_tb):",
            "            pass",
            "",
            "        def __call__(self, func):",
            "            \"\"\"Allows this revision context to be used as a decorator.\"\"\"",
            "",
            "            @wraps(func)",
            "            def do_revision_context(*args, **kwargs):",
            "                self.__enter__()",
            "                exception = False",
            "                try:",
            "                    try:",
            "                        return func(*args, **kwargs)",
            "                    except:",
            "                        exception = True",
            "                        if not self.__exit__(*sys.exc_info()):",
            "                            raise",
            "                finally:",
            "                    if not exception:",
            "                        self.__exit__(None, None, None)",
            "",
            "            return do_revision_context",
            "",
            "    def create_revision():",
            "        return ReversionContext()",
            "",
            "PUBLISH_COMMENT = \"Publish\"",
            "INITIAL_COMMENT = \"Initial version.\"",
            "",
            "",
            "class PageAdmin(PlaceholderAdminMixin, ModelAdmin):",
            "    form = PageForm",
            "    search_fields = ('=id', 'title_set__slug', 'title_set__title', 'reverse_id')",
            "    revision_form_template = \"admin/cms/page/history/revision_header.html\"",
            "    recover_form_template = \"admin/cms/page/history/recover_header.html\"",
            "    add_general_fields = ['title', 'slug', 'language', 'template']",
            "    change_list_template = \"admin/cms/page/tree/base.html\"",
            "    list_filter = ['in_navigation', 'template', 'changed_by', 'soft_root']",
            "    title_frontend_editable_fields = ['title', 'menu_title', 'page_title']",
            "",
            "    inlines = PERMISSION_ADMIN_INLINES",
            "",
            "    def get_urls(self):",
            "        \"\"\"Get the admin urls",
            "        \"\"\"",
            "        from django.conf.urls import patterns, url",
            "",
            "        info = \"%s_%s\" % (self.model._meta.app_label, self.model._meta.module_name)",
            "        pat = lambda regex, fn: url(regex, self.admin_site.admin_view(fn), name='%s_%s' % (info, fn.__name__))",
            "",
            "        url_patterns = patterns(",
            "            '',",
            "",
            "            pat(r'^([0-9]+)/advanced-settings/$', self.advanced),",
            "            pat(r'^([0-9]+)/dates/$', self.dates),",
            "            pat(r'^([0-9]+)/permission-settings/$', self.permissions),",
            "            pat(r'^([0-9]+)/delete-translation/$', self.delete_translation),",
            "            pat(r'^([0-9]+)/move-page/$', self.move_page),",
            "            pat(r'^([0-9]+)/copy-page/$', self.copy_page),",
            "            pat(r'^([0-9]+)/copy-language/$', self.copy_language),",
            "            pat(r'^([0-9]+)/dialog/copy/$', get_copy_dialog),  # copy dialog",
            "            pat(r'^([0-9]+)/change-navigation/$', self.change_innavigation),",
            "            pat(r'^([0-9]+)/jsi18n/$', self.redirect_jsi18n),",
            "            pat(r'^([0-9]+)/permissions/$', self.get_permissions),",
            "            pat(r'^([0-9]+)/undo/$', self.undo),",
            "            pat(r'^([0-9]+)/redo/$', self.redo),",
            "            pat(r'^([0-9]+)/change_template/$', self.change_template),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/descendants/$', self.descendants),  # menu html for page descendants",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/edit-field/$', self.edit_title_fields),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/publish/$', self.publish_page),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/unpublish/$', self.unpublish),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/revert/$', self.revert_page),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/preview/$', self.preview_page),",
            "            pat(r'^add-page-type/$', self.add_page_type),",
            "            pat(r'^published-pages/$', self.get_published_pagelist),",
            "            url(r'^resolve/$', self.resolve, name=\"cms_page_resolve\"),",
            "        )",
            "",
            "        if plugin_pool.get_all_plugins():",
            "            url_patterns += plugin_pool.get_patterns()",
            "",
            "        url_patterns += super(PageAdmin, self).get_urls()",
            "        return url_patterns",
            "",
            "    def redirect_jsi18n(self, request):",
            "        return HttpResponseRedirect(admin_reverse('jsi18n'))",
            "",
            "    def get_revision_instances(self, request, object):",
            "        \"\"\"Returns all the instances to be used in the object's revision.\"\"\"",
            "        if isinstance(object, Title):",
            "            object = object.page",
            "        if isinstance(object, Page) and not object.publisher_is_draft:",
            "            object = object.publisher_public",
            "        placeholder_relation = find_placeholder_relation(object)",
            "        data = [object]",
            "        filters = {'placeholder__%s' % placeholder_relation: object}",
            "        for plugin in CMSPlugin.objects.filter(**filters):",
            "            data.append(plugin)",
            "            plugin_instance, admin = plugin.get_plugin_instance()",
            "            if plugin_instance:",
            "                data.append(plugin_instance)",
            "        if isinstance(object, Page):",
            "            titles = object.title_set.all()",
            "            for title in titles:",
            "                title.publisher_public = None",
            "                data.append(title)",
            "        return data",
            "",
            "    def save_model(self, request, obj, form, change):",
            "        \"\"\"",
            "        Move the page in the tree if necessary and save every placeholder",
            "        Content object.",
            "        \"\"\"",
            "        target = request.GET.get('target', None)",
            "        position = request.GET.get('position', None)",
            "",
            "        if 'recover' in request.path_info:",
            "            pk = obj.pk",
            "            if obj.parent_id:",
            "                parent = Page.objects.get(pk=obj.parent_id)",
            "            else:",
            "                parent = None",
            "            obj.lft = 0",
            "            obj.rght = 0",
            "            obj.tree_id = 0",
            "            obj.level = 0",
            "            obj.pk = None",
            "            obj.insert_at(parent, save=False)",
            "            obj.pk = pk",
            "            obj.save(no_signals=True)",
            "",
            "        else:",
            "            if 'history' in request.path_info:",
            "                old_obj = Page.objects.get(pk=obj.pk)",
            "                obj.level = old_obj.level",
            "                obj.parent_id = old_obj.parent_id",
            "                obj.rght = old_obj.rght",
            "                obj.lft = old_obj.lft",
            "                obj.tree_id = old_obj.tree_id",
            "        new = False",
            "        if not obj.pk:",
            "            new = True",
            "        obj.save()",
            "",
            "        if 'recover' in request.path_info or 'history' in request.path_info:",
            "            revert_plugins(request, obj.version.pk, obj)",
            "",
            "        if target is not None and position is not None:",
            "            try:",
            "                target = self.model.objects.get(pk=target)",
            "            except self.model.DoesNotExist:",
            "                pass",
            "            else:",
            "                obj.move_to(target, position)",
            "        page_type_id = form.cleaned_data.get('page_type')",
            "        copy_target_id = request.GET.get('copy_target')",
            "        if copy_target_id or page_type_id:",
            "            if page_type_id:",
            "                copy_target_id = page_type_id",
            "            copy_target = Page.objects.get(pk=copy_target_id)",
            "            if not copy_target.has_view_permission(request):",
            "                raise PermissionDenied()",
            "            obj = Page.objects.get(pk=obj.pk) #mptt reload",
            "            copy_target._copy_attributes(obj, clean=True)",
            "            obj.save()",
            "            for lang in copy_target.languages.split(','):",
            "                copy_target._copy_contents(obj, lang)",
            "        if not 'permission' in request.path_info:",
            "            language = form.cleaned_data['language']",
            "            Title.objects.set_or_create(",
            "                request,",
            "                obj,",
            "                form,",
            "                language,",
            "            )",
            "        # is it home? publish it right away",
            "        if new and Page.objects.filter(site_id=obj.site_id).count() == 1:",
            "            obj.publish(language)",
            "",
            "    def get_fieldsets(self, request, obj=None):",
            "        form = self.get_form(request, obj, fields=None)",
            "        if getattr(form, 'fieldsets', None) is None:",
            "            fields = list(form.base_fields) + list(self.get_readonly_fields(request, obj))",
            "            return [(None, {'fields': fields})]",
            "        else:",
            "            return form.fieldsets",
            "",
            "    def get_inline_classes(self, request, obj=None, **kwargs):",
            "        if obj and 'permission' in request.path_info:",
            "            return PERMISSION_ADMIN_INLINES",
            "        return []",
            "",
            "    def get_form_class(self, request, obj=None, **kwargs):",
            "        if 'advanced' in request.path_info:",
            "            return AdvancedSettingsForm",
            "        elif 'permission' in request.path_info:",
            "            return PagePermissionForm",
            "        elif 'dates' in request.path_info:",
            "            return PublicationDatesForm",
            "        return self.form",
            "",
            "    def get_form(self, request, obj=None, **kwargs):",
            "        \"\"\"",
            "        Get PageForm for the Page model and modify its fields depending on",
            "        the request.",
            "        \"\"\"",
            "        language = get_language_from_request(request, obj)",
            "        form_cls = self.get_form_class(request, obj)",
            "        form = super(PageAdmin, self).get_form(request, obj, form=form_cls, **kwargs)",
            "        # get_form method operates by overriding initial fields value which",
            "        # may persist across invocation. Code below deepcopies fields definition",
            "        # to avoid leaks",
            "        for field in form.base_fields.keys():",
            "            form.base_fields[field] = copy.deepcopy(form.base_fields[field])",
            "",
            "        if 'language' in form.base_fields:",
            "            form.base_fields['language'].initial = language",
            "",
            "        if 'page_type' in form.base_fields:",
            "            if 'copy_target' in request.GET or 'add_page_type' in request.GET or obj:",
            "                del form.base_fields['page_type']",
            "            elif not Title.objects.filter(page__parent__reverse_id=PAGE_TYPES_ID, language=language).exists():",
            "                del form.base_fields['page_type']",
            "",
            "        if 'add_page_type' in request.GET:",
            "            del form.base_fields['menu_title']",
            "            del form.base_fields['meta_description']",
            "            del form.base_fields['page_title']",
            "",
            "        self.inlines = self.get_inline_classes(request, obj, **kwargs)",
            "",
            "        if obj:",
            "            if 'history' in request.path_info or 'recover' in request.path_info:",
            "                version_id = request.path_info.split('/')[-2]",
            "            else:",
            "                version_id = None",
            "",
            "            title_obj = obj.get_title_obj(language=language, fallback=False, version_id=version_id, force_reload=True)",
            "",
            "            if 'site' in form.base_fields and form.base_fields['site'].initial is None:",
            "                form.base_fields['site'].initial = obj.site",
            "",
            "            for name in ('slug', 'title', 'meta_description', 'menu_title', 'page_title', 'redirect'):",
            "                if name in form.base_fields:",
            "                    form.base_fields[name].initial = getattr(title_obj, name)",
            "",
            "            if 'overwrite_url' in form.base_fields:",
            "                if title_obj.has_url_overwrite:",
            "                    form.base_fields['overwrite_url'].initial = title_obj.path",
            "                else:",
            "                    form.base_fields['overwrite_url'].initial = ''",
            "",
            "        else:",
            "            for name in ('slug', 'title'):",
            "                form.base_fields[name].initial = u''",
            "",
            "            if 'target' in request.GET or 'copy_target' in request.GET:",
            "                target = request.GET.get('copy_target') or request.GET.get('target')",
            "                if 'position' in request.GET:",
            "                    position = request.GET['position']",
            "                    if position == 'last-child' or position == 'first-child':",
            "                        form.base_fields['parent'].initial = request.GET.get('target', None)",
            "                    else:",
            "                        sibling = Page.objects.get(pk=target)",
            "                        form.base_fields['parent'].initial = sibling.parent_id",
            "                else:",
            "                    form.base_fields['parent'].initial = request.GET.get('target', None)",
            "",
            "            form.base_fields['site'].initial = request.session.get('cms_admin_site', None)",
            "",
            "        return form",
            "",
            "    def advanced(self, request, object_id):",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        if not page.has_advanced_settings_permission(request):",
            "            raise PermissionDenied(\"No permission for editing advanced settings\")",
            "        return self.change_view(request, object_id, extra_context={'advanced_settings': True, 'title': _(\"Advanced Settings\")})",
            "",
            "    def dates(self, request, object_id):",
            "        return self.change_view(request, object_id, extra_context={'publishing_dates': True, 'title': _(\"Publishing dates\")})",
            "",
            "    def permissions(self, request, object_id):",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        if not page.has_change_permissions_permission(request):",
            "            raise PermissionDenied(\"No permission for editing advanced settings\")",
            "        return self.change_view(request, object_id, extra_context={'show_permissions': True, 'title': _(\"Change Permissions\")})",
            "",
            "    def get_inline_instances(self, request, obj=None):",
            "        if DJANGO_1_4:",
            "            inlines = super(PageAdmin, self).get_inline_instances(request)",
            "            if hasattr(self, '_current_page'):",
            "                obj = self._current_page",
            "        else:",
            "            inlines = super(PageAdmin, self).get_inline_instances(request, obj)",
            "        if get_cms_setting('PERMISSION') and obj:",
            "            filtered_inlines = []",
            "            for inline in inlines:",
            "                if (isinstance(inline, PagePermissionInlineAdmin)",
            "                and not isinstance(inline, ViewRestrictionInlineAdmin)):",
            "                    if \"recover\" in request.path or \"history\" in request.path:",
            "                        # do not display permissions in recover mode",
            "                        continue",
            "                    if not obj.has_change_permissions_permission(request):",
            "                        continue",
            "                filtered_inlines.append(inline)",
            "            inlines = filtered_inlines",
            "        return inlines",
            "",
            "    def get_unihandecode_context(self, language):",
            "        if language[:2] in get_cms_setting('UNIHANDECODE_DECODERS'):",
            "            uhd_lang = language[:2]",
            "        else:",
            "            uhd_lang = get_cms_setting('UNIHANDECODE_DEFAULT_DECODER')",
            "        uhd_host = get_cms_setting('UNIHANDECODE_HOST')",
            "        uhd_version = get_cms_setting('UNIHANDECODE_VERSION')",
            "        if uhd_lang and uhd_host and uhd_version:",
            "            uhd_urls = [",
            "                '%sunihandecode-%s.core.min.js' % (uhd_host, uhd_version),",
            "                '%sunihandecode-%s.%s.min.js' % (uhd_host, uhd_version, uhd_lang),",
            "            ]",
            "        else:",
            "            uhd_urls = []",
            "        return {'unihandecode_lang': uhd_lang, 'unihandecode_urls': uhd_urls}",
            "",
            "    def add_view(self, request, form_url='', extra_context=None):",
            "        extra_context = extra_context or {}",
            "        language = get_language_from_request(request)",
            "        extra_context.update({",
            "            'language': language,",
            "        })",
            "        if not request.GET.get('add_page_type') is None:",
            "            extra_context.update({",
            "                'add_page_type': True,",
            "                'title':  _(\"Add Page Type\"),",
            "            })",
            "        elif 'copy_target' in request.GET:",
            "            extra_context.update({",
            "                'title':  _(\"Add Page Copy\"),",
            "            })",
            "        else:",
            "            extra_context = self.update_language_tab_context(request, context=extra_context)",
            "        extra_context.update(self.get_unihandecode_context(language))",
            "        return super(PageAdmin, self).add_view(request, form_url, extra_context=extra_context)",
            "",
            "    def change_view(self, request, object_id, form_url='', extra_context=None):",
            "        \"\"\"",
            "        The 'change' admin view for the Page model.",
            "        \"\"\"",
            "        if extra_context is None:",
            "            extra_context = {'basic_info': True}",
            "        try:",
            "            obj = self.model.objects.get(pk=object_id)",
            "        except self.model.DoesNotExist:",
            "            # Don't raise Http404 just yet, because we haven't checked",
            "            # permissions yet. We don't want an unauthenticated user to be able",
            "            # to determine whether a given object exists.",
            "            obj = None",
            "        else:",
            "            #activate(user_lang_set)",
            "            context = {",
            "                'page': obj,",
            "                'CMS_PERMISSION': get_cms_setting('PERMISSION'),",
            "                'ADMIN_MEDIA_URL': settings.STATIC_URL,",
            "                'can_change': obj.has_change_permission(request),",
            "                'can_change_permissions': obj.has_change_permissions_permission(request),",
            "                'current_site_id': settings.SITE_ID,",
            "            }",
            "            context.update(extra_context or {})",
            "            extra_context = self.update_language_tab_context(request, obj, context)",
            "",
            "        tab_language = get_language_from_request(request)",
            "",
            "        extra_context.update(self.get_unihandecode_context(tab_language))",
            "",
            "        # get_inline_instances will need access to 'obj' so that it can",
            "        # determine if current user has enough rights to see PagePermissionInlineAdmin",
            "        # because in django versions <1.5 get_inline_instances doesn't receive 'obj'",
            "        # as a parameter, the workaround is to set it as an attribute...",
            "        if DJANGO_1_4:",
            "            self._current_page = obj",
            "        response = super(PageAdmin, self).change_view(",
            "            request, object_id, form_url=form_url, extra_context=extra_context)",
            "        if tab_language and response.status_code == 302 and response._headers['location'][1] == request.path_info:",
            "            location = response._headers['location']",
            "            response._headers['location'] = (location[0], \"%s?language=%s\" % (location[1], tab_language))",
            "        return response",
            "",
            "    def render_change_form(self, request, context, add=False, change=False, form_url='', obj=None):",
            "        # add context variables",
            "        filled_languages = []",
            "        if obj:",
            "            filled_languages = [t[0] for t in obj.title_set.filter(title__isnull=False).values_list('language')]",
            "        allowed_languages = [lang[0] for lang in self._get_site_languages(obj)]",
            "        context.update({",
            "            'filled_languages': [lang for lang in filled_languages if lang in allowed_languages],",
            "        })",
            "        return super(PageAdmin, self).render_change_form(request, context, add, change, form_url, obj)",
            "",
            "    def _get_site_languages(self, obj=None):",
            "        site_id = None",
            "        if obj:",
            "            site_id = obj.site_id",
            "        else:",
            "            site_id = Site.objects.get_current().pk",
            "        return get_language_tuple(site_id)",
            "",
            "    def update_language_tab_context(self, request, obj=None, context=None):",
            "        if not context:",
            "            context = {}",
            "        language = get_language_from_request(request, obj)",
            "        languages = self._get_site_languages(obj)",
            "        context.update({",
            "            'language': language,",
            "            'language_tabs': languages,",
            "            # Dates are not language dependent, thus we hide the language",
            "            # selection bar: the language is forced through the form class",
            "            'show_language_tabs': len(list(languages)) > 1 and not context.get('publishing_dates', False),",
            "        })",
            "        return context",
            "",
            "    def response_change(self, request, obj):",
            "        \"\"\"Called always when page gets changed, call save on page, there may be",
            "        some new stuff, which should be published after all other objects on page",
            "        are collected.",
            "        \"\"\"",
            "        # save the object again, so all the related changes to page model",
            "        # can be published if required",
            "        obj.save()",
            "        return super(PageAdmin, self).response_change(request, obj)",
            "",
            "    def has_add_permission(self, request):",
            "        \"\"\"",
            "        Return true if the current user has permission to add a new page.",
            "        \"\"\"",
            "        if get_cms_setting('PERMISSION'):",
            "            return permissions.has_page_add_permission(request)",
            "        return super(PageAdmin, self).has_add_permission(request)",
            "",
            "    def has_change_permission(self, request, obj=None):",
            "        \"\"\"",
            "        Return true if the current user has permission on the page.",
            "        Return the string 'All' if the user has all rights.",
            "        \"\"\"",
            "        if get_cms_setting('PERMISSION'):",
            "            if obj:",
            "                return obj.has_change_permission(request)",
            "            else:",
            "                return permissions.has_page_change_permission(request)",
            "        return super(PageAdmin, self).has_change_permission(request, obj)",
            "",
            "    def has_delete_permission(self, request, obj=None):",
            "        \"\"\"",
            "        Returns True if the given request has permission to change the given",
            "        Django model instance. If CMS_PERMISSION are in use also takes look to",
            "        object permissions.",
            "        \"\"\"",
            "        if get_cms_setting('PERMISSION') and obj is not None:",
            "            return obj.has_delete_permission(request)",
            "        return super(PageAdmin, self).has_delete_permission(request, obj)",
            "",
            "    def has_recover_permission(self, request):",
            "        \"\"\"",
            "        Returns True if the use has the right to recover pages",
            "        \"\"\"",
            "        if not is_installed('reversion'):",
            "            return False",
            "        user = request.user",
            "        if user.is_superuser:",
            "            return True",
            "        try:",
            "            if has_global_page_permission(request, can_recover_page=True):",
            "                return True",
            "        except:",
            "            pass",
            "        return False",
            "",
            "    def has_add_plugin_permission(self, request, placeholder, plugin_type):",
            "        if not permissions.has_plugin_permission(request.user, plugin_type, \"add\"):",
            "            return False",
            "        page = placeholder.page",
            "        if page and not page.has_change_permission(request):",
            "            return False",
            "        if page and not page.publisher_is_draft:",
            "            return False",
            "        return True",
            "",
            "    def has_copy_plugin_permission(self, request, source_placeholder, target_placeholder, plugins):",
            "        source_page = source_placeholder.page",
            "        if source_page and not source_page.has_change_permission(request):",
            "            return False",
            "        target_page = target_placeholder.page",
            "        if target_page and not target_page.has_change_permission(request):",
            "            return False",
            "        if target_page and not target_page.publisher_is_draft:",
            "            return False",
            "        for plugin in plugins:",
            "            if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"add\"):",
            "                return False",
            "        return True",
            "",
            "    def has_change_plugin_permission(self, request, plugin):",
            "        page = plugin.placeholder.page if plugin.placeholder else None",
            "        if page and not page.has_change_permission(request):",
            "            return False",
            "        if page and not page.publisher_is_draft:",
            "            return False",
            "        if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"change\"):",
            "            return False",
            "        return True",
            "",
            "    def has_move_plugin_permission(self, request, plugin, target_placeholder):",
            "        if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"change\"):",
            "            return False",
            "        page = plugin.placeholder.page",
            "        if page and not page.has_change_permission(request):",
            "            return False",
            "        if page and not page.publisher_is_draft:",
            "            return False",
            "        return True",
            "",
            "    def has_delete_plugin_permission(self, request, plugin):",
            "        if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"delete\"):",
            "            return False",
            "        page = plugin.placeholder.page",
            "        if page:",
            "            if not page.publisher_is_draft:",
            "                return False",
            "            if not page.has_change_permission(request):",
            "                return False",
            "        return True",
            "",
            "    def has_clear_placeholder_permission(self, request, placeholder):",
            "        page = placeholder.page if placeholder else None",
            "        if page:",
            "            if not page.publisher_is_draft:",
            "                return False",
            "            if not page.has_change_permission(request):",
            "                return False",
            "        return True",
            "",
            "    def post_add_plugin(self, request, placeholder, plugin):",
            "        if is_installed('reversion') and placeholder.page:",
            "            plugin_name = force_unicode(plugin_pool.get_plugin(plugin.plugin_type).name)",
            "            message = _(u\"%(plugin_name)s plugin added to %(placeholder)s\") % {",
            "                'plugin_name': plugin_name, 'placeholder': placeholder}",
            "            self.cleanup_history(placeholder.page)",
            "            helpers.make_revision_with_plugins(placeholder.page, request.user, message)",
            "",
            "    def post_copy_plugins(self, request, source_placeholder, target_placeholder, plugins):",
            "        page = target_placeholder.page",
            "        if page and is_installed('reversion'):",
            "            message = _(u\"Copied plugins to %(placeholder)s\") % {'placeholder': target_placeholder}",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, message)",
            "",
            "    def post_edit_plugin(self, request, plugin):",
            "        page = plugin.placeholder.page",
            "        if page:",
            "            # if reversion is installed, save version of the page plugins",
            "            if is_installed('reversion') and page:",
            "                plugin_name = force_unicode(plugin_pool.get_plugin(plugin.plugin_type).name)",
            "                message = _(",
            "                    u\"%(plugin_name)s plugin edited at position %(position)s in %(placeholder)s\") % {",
            "                        'plugin_name': plugin_name,",
            "                        'position': plugin.position,",
            "                        'placeholder': plugin.placeholder.slot",
            "                    }",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, message)",
            "",
            "    def post_move_plugin(self, request, source_placeholder, target_placeholder, plugin):",
            "        page = target_placeholder.page",
            "        if page and is_installed('reversion'):",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, _(u\"Plugins were moved\"))",
            "",
            "    def post_delete_plugin(self, request, plugin):",
            "        plugin_name = force_unicode(plugin_pool.get_plugin(plugin.plugin_type).name)",
            "        page = plugin.placeholder.page",
            "        if page:",
            "            page.save()",
            "            comment = _(\"%(plugin_name)s plugin at position %(position)s in %(placeholder)s was deleted.\") % {",
            "                'plugin_name': plugin_name,",
            "                'position': plugin.position,",
            "                'placeholder': plugin.placeholder,",
            "            }",
            "            if is_installed('reversion'):",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, comment)",
            "",
            "    def post_clear_placeholder(self, request, placeholder):",
            "        page = placeholder.page",
            "        if page:",
            "            page.save()",
            "            comment = _('All plugins in the placeholder \"%(name)s\" were deleted.') % {",
            "                'name': force_unicode(placeholder)",
            "            }",
            "            if is_installed('reversion'):",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, comment)",
            "",
            "    def get_placeholder_template(self, request, placeholder):",
            "        page = placeholder.page",
            "        if page:",
            "            return page.get_template()",
            "",
            "    def changelist_view(self, request, extra_context=None):",
            "        \"The 'change list' admin view for this model.\"",
            "        from django.contrib.admin.views.main import ERROR_FLAG",
            "",
            "        opts = self.model._meta",
            "        app_label = opts.app_label",
            "        if not self.has_change_permission(request, None):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change pages.\")))",
            "        try:",
            "            cl = CMSChangeList(request, self.model, self.list_display, self.list_display_links, self.list_filter,",
            "                               self.date_hierarchy, self.search_fields, self.list_select_related, self.list_per_page,",
            "                               self.list_max_show_all, self.list_editable, self)",
            "        except IncorrectLookupParameters:",
            "            # Wacky lookup parameters were given, so redirect to the main",
            "            # changelist page, without parameters, and pass an 'invalid=1'",
            "            # parameter via the query string. If wacky parameters were given and",
            "            # the 'invalid=1' parameter was already in the query string, something",
            "            # is screwed up with the database, so display an error page.",
            "            if ERROR_FLAG in request.GET.keys():",
            "                return render_to_response('admin/invalid_setup.html', {'title': _('Database error')})",
            "            return HttpResponseRedirect(request.path_info + '?' + ERROR_FLAG + '=1')",
            "        cl.set_items(request)",
            "",
            "        site_id = request.GET.get('site__exact', None)",
            "        if site_id is None:",
            "            site_id = current_site(request).pk",
            "        site_id = int(site_id)",
            "",
            "        # languages",
            "        languages = get_language_list(site_id)",
            "",
            "        # parse the cookie that saves which page trees have",
            "        # been opened already and extracts the page ID",
            "        djangocms_nodes_open = request.COOKIES.get('djangocms_nodes_open', '')",
            "        raw_nodes = unquote(djangocms_nodes_open).split(',')",
            "        try:",
            "            open_menu_trees = [int(c.split('page_', 1)[1]) for c in raw_nodes]",
            "        except IndexError:",
            "            open_menu_trees = []",
            "        # Language may be present in the GET dictionary but empty",
            "        language = request.GET.get('language', get_language())",
            "        if not language:",
            "            language = get_language()",
            "        context = {",
            "            'title': cl.title,",
            "            'is_popup': cl.is_popup,",
            "            'cl': cl,",
            "            'opts': opts,",
            "            'has_add_permission': self.has_add_permission(request),",
            "            'root_path': admin_reverse('index'),",
            "            'app_label': app_label,",
            "            'preview_language': language,",
            "            'CMS_MEDIA_URL': get_cms_setting('MEDIA_URL'),",
            "            'CMS_PERMISSION': get_cms_setting('PERMISSION'),",
            "            'DEBUG': settings.DEBUG,",
            "            'site_languages': languages,",
            "            'open_menu_trees': open_menu_trees,",
            "        }",
            "        if is_installed('reversion'):",
            "            context['has_recover_permission'] = self.has_recover_permission(request)",
            "            context['has_change_permission'] = self.has_change_permission(request)",
            "        context.update(extra_context or {})",
            "        return render_to_response(self.change_list_template or [",
            "            'admin/%s/%s/change_list.html' % (app_label, opts.object_name.lower()),",
            "            'admin/%s/change_list.html' % app_label,",
            "            'admin/change_list.html'",
            "        ], context, context_instance=RequestContext(request))",
            "",
            "    def recoverlist_view(self, request, extra_context=None):",
            "        if not self.has_recover_permission(request):",
            "            raise PermissionDenied",
            "        return super(PageAdmin, self).recoverlist_view(request, extra_context)",
            "",
            "    def recover_view(self, request, version_id, extra_context=None):",
            "        if not self.has_recover_permission(request):",
            "            raise PermissionDenied",
            "        extra_context = self.update_language_tab_context(request, None, extra_context)",
            "        return super(PageAdmin, self).recover_view(request, version_id, extra_context)",
            "",
            "    def revision_view(self, request, object_id, version_id, extra_context=None):",
            "        if not self.has_change_permission(request, Page.objects.get(pk=object_id)):",
            "            raise PermissionDenied",
            "        extra_context = self.update_language_tab_context(request, None, extra_context)",
            "        response = super(PageAdmin, self).revision_view(request, object_id, version_id, extra_context)",
            "        return response",
            "",
            "    def history_view(self, request, object_id, extra_context=None):",
            "        if not self.has_change_permission(request, Page.objects.get(pk=object_id)):",
            "            raise PermissionDenied",
            "        extra_context = self.update_language_tab_context(request, None, extra_context)",
            "        return super(PageAdmin, self).history_view(request, object_id, extra_context)",
            "",
            "    def render_revision_form(self, request, obj, version, context, revert=False, recover=False):",
            "        # reset parent to null if parent is not found",
            "        if version.field_dict['parent']:",
            "            try:",
            "                Page.objects.get(pk=version.field_dict['parent'])",
            "            except:",
            "                if revert and obj.parent_id != int(version.field_dict['parent']):",
            "                    version.field_dict['parent'] = obj.parent_id",
            "                if recover:",
            "                    obj.parent = None",
            "                    obj.parent_id = None",
            "                    version.field_dict['parent'] = None",
            "",
            "        obj.version = version",
            "",
            "        return super(PageAdmin, self).render_revision_form(request, obj, version, context, revert, recover)",
            "",
            "    @require_POST",
            "    def undo(self, request, object_id):",
            "        if not is_installed('reversion'):",
            "            return HttpResponseBadRequest('django reversion not installed')",
            "        from reversion.models import Revision",
            "        from cms.utils.page_resolver import is_valid_url",
            "        import reversion",
            "",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        old_titles = list(page.title_set.all())",
            "        if not page.publisher_is_draft:",
            "            page = page.publisher_draft",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "        versions = reversion.get_for_object(page)",
            "        if page.revision_id:",
            "            current_revision = Revision.objects.get(pk=page.revision_id)",
            "        else:",
            "            try:",
            "                current_version = versions[0]",
            "            except IndexError:",
            "                return HttpResponseBadRequest(\"no current revision found\")",
            "            current_revision = current_version.revision",
            "        try:",
            "            previous_version = versions.filter(revision__pk__lt=current_revision.pk)[0]",
            "        except IndexError:",
            "            return HttpResponseBadRequest(\"no previous revision found\")",
            "        previous_revision = previous_version.revision",
            "        # clear all plugins",
            "        placeholders = page.placeholders.all()",
            "        placeholder_ids = []",
            "        for placeholder in placeholders:",
            "            placeholder_ids.append(placeholder.pk)",
            "        plugins = CMSPlugin.objects.filter(placeholder__in=placeholder_ids).order_by('-level')",
            "        for plugin in plugins:",
            "            plugin._no_reorder = True",
            "            plugin.delete()",
            "        # TODO: delete placeholders instead of finding duplicates for 3.1",
            "        #page.placeholders.all().delete()",
            "",
            "        previous_revision.revert(True)",
            "        rev_page = get_object_or_404(Page, pk=page.pk)",
            "        rev_page.revision_id = previous_revision.pk",
            "        rev_page.publisher_public_id = page.publisher_public_id",
            "        rev_page.save()",
            "        new_placeholders = rev_page.placeholders.all()",
            "        slots = {}",
            "        for new_ph in new_placeholders:",
            "            if not new_ph.slot in slots:",
            "                slots[new_ph.slot] = new_ph",
            "            else:",
            "                if new_ph in placeholder_ids:",
            "                    new_ph.delete()",
            "                elif slots[new_ph.slot] in placeholder_ids:",
            "                    slots[new_ph.slot].delete()",
            "        new_titles = rev_page.title_set.all()",
            "        for title in new_titles:",
            "            try:",
            "                is_valid_url(title.path, rev_page)",
            "            except ValidationError:",
            "                for old_title in old_titles:",
            "                    if old_title.language == title.language:",
            "                        title.slug = old_title.slug",
            "                        title.save()",
            "                        messages.error(request, _(\"Page reverted but slug stays the same because of url collisions.\"))",
            "        return HttpResponse(\"ok\")",
            "",
            "    @require_POST",
            "    def redo(self, request, object_id):",
            "        if not is_installed('reversion'):",
            "            return HttpResponseBadRequest('django reversion not installed')",
            "        from reversion.models import Revision",
            "        import reversion",
            "        from cms.utils.page_resolver import is_valid_url",
            "",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        old_titles = list(page.title_set.all())",
            "        if not page.publisher_is_draft:",
            "            page = page.publisher_draft",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "        versions = reversion.get_for_object(page)",
            "        if page.revision_id:",
            "            current_revision = Revision.objects.get(pk=page.revision_id)",
            "        else:",
            "            try:",
            "                current_version = versions[0]",
            "            except IndexError:",
            "                return HttpResponseBadRequest(\"no current revision found\")",
            "            current_revision = current_version.revision",
            "        try:",
            "            previous_version = versions.filter(revision__pk__gt=current_revision.pk).order_by('pk')[0]",
            "        except IndexError:",
            "            return HttpResponseBadRequest(\"no next revision found\")",
            "        next_revision = previous_version.revision",
            "        # clear all plugins",
            "        placeholders = page.placeholders.all()",
            "        placeholder_ids = []",
            "        for placeholder in placeholders:",
            "            placeholder_ids.append(placeholder.pk)",
            "        plugins = CMSPlugin.objects.filter(placeholder__in=placeholder_ids).order_by('-level')",
            "        for plugin in plugins:",
            "            plugin._no_reorder = True",
            "            plugin.delete()",
            "        # TODO: 3.1 remove the placeholder matching from below and just delete them",
            "        #page.placeholders.all().delete()",
            "        next_revision.revert(True)",
            "        rev_page = get_object_or_404(Page, pk=page.pk)",
            "        rev_page.revision_id = next_revision.pk",
            "        rev_page.publisher_public_id = page.publisher_public_id",
            "        rev_page.save()",
            "        new_placeholders = rev_page.placeholders.all()",
            "        slots = {}",
            "        for new_ph in new_placeholders:",
            "            if not new_ph.slot in slots:",
            "                slots[new_ph.slot] = new_ph",
            "            else:",
            "                if new_ph in placeholder_ids:",
            "                    new_ph.delete()",
            "                elif slots[new_ph.slot] in placeholder_ids:",
            "                    slots[new_ph.slot].delete()",
            "        new_titles = rev_page.title_set.all()",
            "        for title in new_titles:",
            "            try:",
            "                is_valid_url(title.path, rev_page)",
            "            except ValidationError:",
            "                for old_title in old_titles:",
            "                    if old_title.language == title.language:",
            "                        title.slug = old_title.slug",
            "                        title.save()",
            "                        messages.error(request, _(\"Page reverted but slug stays the same because of url collisions.\"))",
            "        return HttpResponse(\"ok\")",
            "",
            "    @require_POST",
            "    @create_revision()",
            "    def change_template(self, request, object_id):",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change the template\")))",
            "",
            "        to_template = request.POST.get(\"template\", None)",
            "        if to_template not in dict(get_cms_setting('TEMPLATES')):",
            "            return HttpResponseBadRequest(force_unicode(_(\"Template not valid\")))",
            "",
            "        page.template = to_template",
            "        page.save()",
            "        if is_installed('reversion'):",
            "            message = _(\"Template changed to %s\") % dict(get_cms_setting('TEMPLATES'))[to_template]",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, message)",
            "        return HttpResponse(force_unicode(_(\"The template was successfully changed\")))",
            "",
            "    @wrap_transaction",
            "    def move_page(self, request, page_id, extra_context=None):",
            "        \"\"\"",
            "        Move the page to the requested target, at the given position",
            "        \"\"\"",
            "        target = request.POST.get('target', None)",
            "        position = request.POST.get('position', None)",
            "        if target is None or position is None:",
            "            return HttpResponseRedirect('../../')",
            "",
            "        try:",
            "            page = self.model.objects.get(pk=page_id)",
            "            target = self.model.objects.get(pk=target)",
            "        except self.model.DoesNotExist:",
            "            return jsonify_request(HttpResponseBadRequest(\"error\"))",
            "",
            "        # does he haves permissions to do this...?",
            "        if not page.has_move_page_permission(request) or \\",
            "                not target.has_add_permission(request):",
            "            return jsonify_request(",
            "                HttpResponseForbidden(force_unicode(_(\"Error! You don't have permissions to move this page. Please reload the page\"))))",
            "            # move page",
            "        page.move_page(target, position)",
            "        if is_installed('reversion'):",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, _(\"Page moved\"))",
            "",
            "        return jsonify_request(HttpResponse(admin_utils.render_admin_menu_item(request, page).content))",
            "",
            "    def get_permissions(self, request, page_id):",
            "        page = get_object_or_404(Page, id=page_id)",
            "",
            "        can_change_list = Page.permissions.get_change_id_list(request.user, page.site_id)",
            "",
            "        global_page_permissions = GlobalPagePermission.objects.filter(sites__in=[page.site_id])",
            "        page_permissions = PagePermission.objects.for_page(page)",
            "        all_permissions = list(global_page_permissions) + list(page_permissions)",
            "",
            "        # does he can change global permissions ?",
            "        has_global = permissions.has_global_change_permissions_permission(request)",
            "",
            "        permission_set = []",
            "        for permission in all_permissions:",
            "            if isinstance(permission, GlobalPagePermission):",
            "                if has_global:",
            "                    permission_set.append([(True, True), permission])",
            "                else:",
            "                    permission_set.append([(True, False), permission])",
            "            else:",
            "                if can_change_list == PagePermissionsPermissionManager.GRANT_ALL:",
            "                    can_change = True",
            "                else:",
            "                    can_change = permission.page_id in can_change_list",
            "                permission_set.append([(False, can_change), permission])",
            "",
            "        context = {",
            "            'page': page,",
            "            'permission_set': permission_set,",
            "        }",
            "        return render_to_response('admin/cms/page/permissions.html', context)",
            "",
            "    @require_POST",
            "    @wrap_transaction",
            "    def copy_language(self, request, page_id):",
            "        with create_revision():",
            "            source_language = request.POST.get('source_language')",
            "            target_language = request.POST.get('target_language')",
            "            page = Page.objects.get(pk=page_id)",
            "            placeholders = page.placeholders.all()",
            "",
            "            if not target_language or not target_language in get_language_list():",
            "                return HttpResponseBadRequest(force_unicode(_(\"Language must be set to a supported language!\")))",
            "            for placeholder in placeholders:",
            "                plugins = list(",
            "                    placeholder.cmsplugin_set.filter(language=source_language).order_by('tree_id', 'level', 'position'))",
            "                if not self.has_copy_plugin_permission(request, placeholder, placeholder, plugins):",
            "                    return HttpResponseForbidden(force_unicode(_('You do not have permission to copy these plugins.')))",
            "                copy_plugins.copy_plugins_to(plugins, placeholder, target_language)",
            "            if page and is_installed('reversion'):",
            "                message = _(u\"Copied plugins from %(source_language)s to %(target_language)s\") % {",
            "                    'source_language': source_language, 'target_language': target_language}",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, message)",
            "            return HttpResponse(\"ok\")",
            "",
            "    @wrap_transaction",
            "    def copy_page(self, request, page_id, extra_context=None):",
            "        \"\"\"",
            "        Copy the page and all its plugins and descendants to the requested target, at the given position",
            "        \"\"\"",
            "        context = {}",
            "        page = Page.objects.get(pk=page_id)",
            "",
            "        target = request.POST.get('target', None)",
            "        position = request.POST.get('position', None)",
            "        site = request.POST.get('site', None)",
            "        if target is not None and position is not None and site is not None:",
            "            try:",
            "                target = self.model.objects.get(pk=target)",
            "                # does he have permissions to copy this page under target?",
            "                assert target.has_add_permission(request)",
            "                site = Site.objects.get(pk=site)",
            "            except (ObjectDoesNotExist, AssertionError):",
            "                return HttpResponse(\"error\")",
            "                #context.update({'error': _('Page could not been moved.')})",
            "            else:",
            "                try:",
            "                    kwargs = {",
            "                        'copy_permissions': request.REQUEST.get('copy_permissions', False),",
            "                    }",
            "                    page.copy_page(target, site, position, **kwargs)",
            "                    return jsonify_request(HttpResponse(\"ok\"))",
            "                except ValidationError:",
            "                    exc = sys.exc_info()[1]",
            "                    return jsonify_request(HttpResponseBadRequest(exc.messages))",
            "        context.update(extra_context or {})",
            "        return HttpResponseRedirect('../../')",
            "",
            "    @wrap_transaction",
            "    @create_revision()",
            "    def publish_page(self, request, page_id, language):",
            "        try:",
            "            page = Page.objects.get(id=page_id, publisher_is_draft=True)",
            "        except Page.DoesNotExist:",
            "            page = None",
            "        # ensure user has permissions to publish this page",
            "        all_published = True",
            "        if page:",
            "            if not page.has_publish_permission(request):",
            "                return HttpResponseForbidden(force_unicode(_(\"You do not have permission to publish this page\")))",
            "            published = page.publish(language)",
            "            if not published:",
            "                all_published = False",
            "        statics = request.GET.get('statics', '')",
            "        if not statics and not page:",
            "            return Http404(\"No page or stack found for publishing.\")",
            "        if statics:",
            "            static_ids = statics .split(',')",
            "            for pk in static_ids:",
            "                static_placeholder = StaticPlaceholder.objects.get(pk=pk)",
            "                published = static_placeholder.publish(request, language)",
            "                if not published:",
            "                    all_published = False",
            "        if page:",
            "            if all_published:",
            "                if page.get_publisher_state(language) == PUBLISHER_STATE_PENDING:",
            "                    messages.warning(request, _(\"Page not published! A parent page is not published yet.\"))",
            "                else:",
            "                    messages.info(request, _('The content was successfully published.'))",
            "                LogEntry.objects.log_action(",
            "                    user_id=request.user.id,",
            "                    content_type_id=ContentType.objects.get_for_model(Page).pk,",
            "                    object_id=page_id,",
            "                    object_repr=page.get_title(language),",
            "                    action_flag=CHANGE,",
            "                )",
            "            else:",
            "                if page.get_publisher_state(language) == PUBLISHER_STATE_PENDING:",
            "                    messages.warning(request, _(\"Page not published! A parent page is not published yet.\"))",
            "                else:",
            "                    messages.warning(request, _(\"There was a problem publishing your content\"))",
            "        if is_installed('reversion') and page:",
            "            self.cleanup_history(page, publish=True)",
            "            helpers.make_revision_with_plugins(page, request.user, PUBLISH_COMMENT)",
            "            # create a new publish reversion",
            "        if 'node' in request.REQUEST:",
            "            # if request comes from tree..",
            "            return admin_utils.render_admin_menu_item(request, page)",
            "",
            "        if 'redirect' in request.GET:",
            "            return HttpResponseRedirect(request.GET['redirect'])",
            "        referrer = request.META.get('HTTP_REFERER', '')",
            "",
            "        path = admin_reverse(\"cms_page_changelist\")",
            "        if request.GET.get('redirect_language'):",
            "            path = \"%s?language=%s&page_id=%s\" % (path, request.GET.get('redirect_language'), request.GET.get('redirect_page_id'))",
            "        if admin_reverse('index') not in referrer:",
            "            if all_published:",
            "                if page:",
            "                    if page.get_publisher_state(language) == PUBLISHER_STATE_PENDING:",
            "                        path = page.get_absolute_url(language, fallback=True)",
            "                    else:",
            "                        public_page = Page.objects.get(publisher_public=page.pk)",
            "                        path = '%s?%s' % (public_page.get_absolute_url(language, fallback=True), get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "                else:",
            "                    path = '%s?%s' % (referrer, get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "            else:",
            "                path = '/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF')",
            "",
            "        return HttpResponseRedirect(path)",
            "",
            "    def cleanup_history(self, page, publish=False):",
            "        if is_installed('reversion') and page:",
            "            # delete revisions that are not publish revisions",
            "            from reversion.models import Version",
            "",
            "            content_type = ContentType.objects.get_for_model(Page)",
            "            # reversion 1.8+ removes type field, revision filtering must be based on comments",
            "            versions_qs = Version.objects.filter(content_type=content_type, object_id_int=page.pk)",
            "            history_limit = get_cms_setting(\"MAX_PAGE_HISTORY_REVERSIONS\")",
            "            deleted = []",
            "            for version in versions_qs.exclude(revision__comment__in=(INITIAL_COMMENT,  PUBLISH_COMMENT)).order_by(",
            "                        '-revision__pk')[history_limit - 1:]:",
            "                if not version.revision_id in deleted:",
            "                    revision = version.revision",
            "                    revision.delete()",
            "                    deleted.append(revision.pk)",
            "                    # delete all publish revisions that are more then MAX_PAGE_PUBLISH_REVERSIONS",
            "            publish_limit = get_cms_setting(\"MAX_PAGE_PUBLISH_REVERSIONS\")",
            "            if publish_limit and publish:",
            "                deleted = []",
            "                for version in versions_qs.filter(revision__comment__exact=PUBLISH_COMMENT).order_by(",
            "                        '-revision__pk')[publish_limit - 1:]:",
            "                    if not version.revision_id in deleted:",
            "                        revision = version.revision",
            "                        revision.delete()",
            "                        deleted.append(revision.pk)",
            "",
            "    @wrap_transaction",
            "    def unpublish(self, request, page_id, language):",
            "        \"\"\"",
            "        Publish or unpublish a language of a page",
            "        \"\"\"",
            "        site = Site.objects.get_current()",
            "        page = get_object_or_404(Page, pk=page_id)",
            "        if not page.has_publish_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to unpublish this page\")))",
            "        if not page.publisher_public_id:",
            "            return HttpResponseForbidden(force_unicode(_(\"This page was never published\")))",
            "        try:",
            "            page.unpublish(language)",
            "            message = _('The %(language)s page \"%(page)s\" was successfully unpublished') % {",
            "                'language': get_language_object(language, site)['name'], 'page': page}",
            "            messages.info(request, message)",
            "            LogEntry.objects.log_action(",
            "                user_id=request.user.id,",
            "                content_type_id=ContentType.objects.get_for_model(Page).pk,",
            "                object_id=page_id,",
            "                object_repr=page.get_title(),",
            "                action_flag=CHANGE,",
            "                change_message=message,",
            "            )",
            "        except RuntimeError:",
            "            exc = sys.exc_info()[1]",
            "            messages.error(request, exc.message)",
            "        except ValidationError:",
            "            exc = sys.exc_info()[1]",
            "            messages.error(request, exc.message)",
            "        path = admin_reverse(\"cms_page_changelist\")",
            "        if request.GET.get('redirect_language'):",
            "            path = \"%s?language=%s&page_id=%s\" % (path, request.GET.get('redirect_language'), request.GET.get('redirect_page_id'))",
            "        return HttpResponseRedirect(path)",
            "",
            "    @wrap_transaction",
            "    def revert_page(self, request, page_id, language):",
            "        page = get_object_or_404(Page, id=page_id)",
            "        # ensure user has permissions to publish this page",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "",
            "        page.revert(language)",
            "",
            "        messages.info(request, _('The page \"%s\" was successfully reverted.') % page)",
            "",
            "        if 'node' in request.REQUEST:",
            "            # if request comes from tree..",
            "            return admin_utils.render_admin_menu_item(request, page)",
            "",
            "        referer = request.META.get('HTTP_REFERER', '')",
            "        path = '../../'",
            "        if admin_reverse('index') not in referer:",
            "            path = '%s?%s' % (referer.split('?')[0], get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "        return HttpResponseRedirect(path)",
            "",
            "    @create_revision()",
            "    def delete_translation(self, request, object_id, extra_context=None):",
            "        if 'language' in request.GET:",
            "            language = request.GET['language']",
            "        else:",
            "            language = get_language_from_request(request)",
            "",
            "        opts = Page._meta",
            "        titleopts = Title._meta",
            "        app_label = titleopts.app_label",
            "        pluginopts = CMSPlugin._meta",
            "",
            "        try:",
            "            obj = self.queryset(request).get(pk=unquote(object_id))",
            "        except self.model.DoesNotExist:",
            "            # Don't raise Http404 just yet, because we haven't checked",
            "            # permissions yet. We don't want an unauthenticated user to be able",
            "            # to determine whether a given object exists.",
            "            obj = None",
            "",
            "        if not self.has_delete_permission(request, obj):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "",
            "        if obj is None:",
            "            raise Http404(",
            "                _('%(name)s object with primary key %(key)r does not exist.') % {",
            "                    'name': force_unicode(opts.verbose_name),",
            "                    'key': escape(object_id)",
            "                })",
            "",
            "        if not len(list(obj.get_languages())) > 1:",
            "            raise Http404(_('There only exists one translation for this page'))",
            "",
            "        titleobj = get_object_or_404(Title, page__id=object_id, language=language)",
            "        saved_plugins = CMSPlugin.objects.filter(placeholder__page__id=object_id, language=language)",
            "",
            "        using = router.db_for_read(self.model)",
            "        kwargs = {",
            "            'admin_site': self.admin_site,",
            "            'user': request.user,",
            "            'using': using",
            "        }",
            "        deleted_objects, perms_needed = get_deleted_objects(",
            "            [titleobj],",
            "            titleopts,",
            "            **kwargs",
            "        )[:2]",
            "        to_delete_plugins, perms_needed_plugins = get_deleted_objects(",
            "            saved_plugins,",
            "            pluginopts,",
            "            **kwargs",
            "        )[:2]",
            "",
            "        deleted_objects.append(to_delete_plugins)",
            "        perms_needed = set(list(perms_needed) + list(perms_needed_plugins))",
            "",
            "        if request.method == 'POST':",
            "            if perms_needed:",
            "                raise PermissionDenied",
            "",
            "            message = _('Title and plugins with language %(language)s was deleted') % {",
            "                'language': force_unicode(get_language_object(language)['name'])",
            "            }",
            "            self.log_change(request, titleobj, message)",
            "            messages.info(request, message)",
            "",
            "            titleobj.delete()",
            "            for p in saved_plugins:",
            "                p.delete()",
            "",
            "            public = obj.publisher_public",
            "            if public:",
            "                public.save()",
            "",
            "            if is_installed('reversion'):",
            "                self.cleanup_history(obj)",
            "                helpers.make_revision_with_plugins(obj, request.user, message)",
            "",
            "            if not self.has_change_permission(request, None):",
            "                return HttpResponseRedirect(\"../../../../\")",
            "            return HttpResponseRedirect(\"../../\")",
            "",
            "        context = {",
            "            \"title\": _(\"Are you sure?\"),",
            "            \"object_name\": force_unicode(titleopts.verbose_name),",
            "            \"object\": titleobj,",
            "            \"deleted_objects\": deleted_objects,",
            "            \"perms_lacking\": perms_needed,",
            "            \"opts\": opts,",
            "            \"root_path\": admin_reverse('index'),",
            "            \"app_label\": app_label,",
            "        }",
            "        context.update(extra_context or {})",
            "        context_instance = RequestContext(request, current_app=self.admin_site.name)",
            "        return render_to_response(self.delete_confirmation_template or [",
            "            \"admin/%s/%s/delete_confirmation.html\" % (app_label, titleopts.object_name.lower()),",
            "            \"admin/%s/delete_confirmation.html\" % app_label,",
            "            \"admin/delete_confirmation.html\"",
            "        ], context, context_instance=context_instance)",
            "",
            "    def preview_page(self, request, object_id, language):",
            "        \"\"\"Redirecting preview function based on draft_id",
            "        \"\"\"",
            "        page = get_object_or_404(Page, id=object_id)",
            "        attrs = \"?%s\" % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')",
            "        attrs += \"&language=\" + language",
            "        with force_language(language):",
            "            url = page.get_absolute_url(language) + attrs",
            "        site = get_current_site(request)",
            "        if not site == page.site:",
            "            url = \"http%s://%s%s\" % ('s' if request.is_secure() else '',",
            "            page.site.domain, url)",
            "        return HttpResponseRedirect(url)",
            "",
            "    def change_innavigation(self, request, page_id):",
            "        \"\"\"",
            "        Switch the in_navigation of a page",
            "        \"\"\"",
            "        page = get_object_or_404(Page, pk=page_id)",
            "        if page.has_change_permission(request):",
            "            page.toggle_in_navigation()",
            "            language = request.GET.get('language') or get_language_from_request(request)",
            "            return admin_utils.render_admin_menu_item(request, page, language=language)",
            "        return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page's in_navigation status\")))",
            "",
            "    def descendants(self, request, page_id, language):",
            "        \"\"\"",
            "        Get html for descendants of given page",
            "        Used for lazy loading pages in cms.changelist.js",
            "",
            "        Permission checks is done in admin_utils.get_admin_menu_item_context",
            "        which is called by admin_utils.render_admin_menu_item.",
            "        \"\"\"",
            "        page = get_object_or_404(Page, pk=page_id)",
            "        return admin_utils.render_admin_menu_item(request, page,",
            "                                                  template=\"admin/cms/page/tree/lazy_menu.html\", language=language)",
            "",
            "    def add_page_type(self, request):",
            "        site = Site.objects.get_current()",
            "        language = request.GET.get('language') or get_language()",
            "        target = request.GET.get('copy_target')",
            "",
            "        type_root, created = Page.objects.get_or_create(reverse_id=PAGE_TYPES_ID, publisher_is_draft=True, site=site,",
            "                                                        defaults={'in_navigation': False})",
            "        type_title, created = Title.objects.get_or_create(page=type_root, language=language, slug=PAGE_TYPES_ID,",
            "                                                          defaults={'title': _('Page Types')})",
            "",
            "        url = add_url_parameters(admin_reverse('cms_page_add'), target=type_root.pk, position='first-child',",
            "                                 add_page_type=1, copy_target=target, language=language)",
            "",
            "        return HttpResponseRedirect(url)",
            "",
            "    def resolve(self, request):",
            "        if not request.user.is_staff:",
            "            if DJANGO_1_4:",
            "                return HttpResponse('/', mimetype='text/plain')",
            "            else:",
            "                return HttpResponse('/', content_type='text/plain')",
            "        obj = False",
            "        url = False",
            "        if request.session.get('cms_log_latest', False):",
            "            log = LogEntry.objects.get(pk=request.session['cms_log_latest'])",
            "            try:",
            "                obj = log.get_edited_object()",
            "            except (ObjectDoesNotExist, ValueError):",
            "                obj = None",
            "            del request.session['cms_log_latest']",
            "            if obj and obj.__class__ in toolbar_pool.get_watch_models() and hasattr(obj, 'get_absolute_url'):",
            "                # This is a test if the object url can be retrieved",
            "                # In case it can't, object it's not taken into account",
            "                try:",
            "                    force_unicode(obj.get_absolute_url())",
            "                except:",
            "                    obj = None",
            "            else:",
            "                obj = None",
            "        if not obj:",
            "            pk = request.REQUEST.get('pk')",
            "            full_model = request.REQUEST.get('model')",
            "            if pk and full_model:",
            "                app_label, model = full_model.split('.')",
            "                if pk and app_label:",
            "                    ctype = ContentType.objects.get(app_label=app_label, model=model)",
            "                    try:",
            "                        obj = ctype.get_object_for_this_type(pk=pk)",
            "                    except ctype.model_class().DoesNotExist:",
            "                        obj = None",
            "                    try:",
            "                        force_unicode(obj.get_absolute_url())",
            "                    except:",
            "                        obj = None",
            "        if obj:",
            "            if not request.toolbar or not request.toolbar.edit_mode:",
            "                if isinstance(obj, Page):",
            "                    if obj.get_public_object():",
            "                        url = obj.get_public_object().get_absolute_url()",
            "                    else:",
            "                        url = '%s?%s' % (",
            "                            obj.get_draft_object().get_absolute_url(),",
            "                            get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')",
            "                        )",
            "                else:",
            "                    url = obj.get_absolute_url()",
            "            else:",
            "                url = obj.get_absolute_url()",
            "        if url:",
            "            return HttpResponse(force_unicode(url), content_type='text/plain')",
            "        return HttpResponse('', content_type='text/plain')",
            "",
            "    def lookup_allowed(self, key, *args, **kwargs):",
            "        if key == 'site__exact':",
            "            return True",
            "        return super(PageAdmin, self).lookup_allowed(key, *args, **kwargs)",
            "",
            "    def edit_title_fields(self, request, page_id, language):",
            "        title = Title.objects.get(page_id=page_id, language=language)",
            "        saved_successfully = False",
            "        raw_fields = request.GET.get(\"edit_fields\", 'title')",
            "        edit_fields = [field for field in raw_fields.split(\",\") if field in self.title_frontend_editable_fields]",
            "        cancel_clicked = request.POST.get(\"_cancel\", False)",
            "        opts = Title._meta",
            "",
            "        if not edit_fields:",
            "            # Defaults to title",
            "            edit_fields = ('title',)",
            "",
            "        if not has_generic_permission(title.page.pk, request.user, \"change\",",
            "                                      title.page.site.pk):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to edit this page\")))",
            "",
            "        class PageTitleForm(django.forms.ModelForm):",
            "            \"\"\"",
            "            Dynamic form showing only the fields to be edited",
            "            \"\"\"",
            "            class Meta:",
            "                model = Title",
            "                fields = edit_fields",
            "",
            "        if not cancel_clicked and request.method == 'POST':",
            "            form = PageTitleForm(instance=title, data=request.POST)",
            "            if form.is_valid():",
            "                form.save()",
            "                saved_successfully = True",
            "        else:",
            "            form = PageTitleForm(instance=title)",
            "        admin_form = AdminForm(form, fieldsets=[(None, {'fields': edit_fields})], prepopulated_fields={},",
            "                               model_admin=self)",
            "        media = self.media + admin_form.media",
            "        context = {",
            "            'CMS_MEDIA_URL': get_cms_setting('MEDIA_URL'),",
            "            'title': 'Title',",
            "            'plugin': title.page,",
            "            'plugin_id': title.page.id,",
            "            'adminform': admin_form,",
            "            'add': False,",
            "            'is_popup': True,",
            "            'media': media,",
            "            'opts': opts,",
            "            'change': True,",
            "            'save_as': False,",
            "            'has_add_permission': False,",
            "            'window_close_timeout': 10,",
            "        }",
            "        if cancel_clicked:",
            "            # cancel button was clicked",
            "            context.update({",
            "                'cancel': True,",
            "            })",
            "            return render_to_response('admin/cms/page/plugin/confirm_form.html', context, RequestContext(request))",
            "        if not cancel_clicked and request.method == 'POST' and saved_successfully:",
            "            return render_to_response('admin/cms/page/plugin/confirm_form.html', context, RequestContext(request))",
            "        return render_to_response('admin/cms/page/plugin/change_form.html', context, RequestContext(request))",
            "",
            "    def get_published_pagelist(self, *args, **kwargs):",
            "        \"\"\"",
            "         This view is used by the PageSmartLinkWidget as the user type to feed the autocomplete drop-down.",
            "        \"\"\"",
            "        request = args[0]",
            "",
            "        if request.is_ajax():",
            "            query_term = request.GET.get('q','').strip('/')",
            "",
            "            language_code = request.GET.get('language_code', settings.LANGUAGE_CODE)",
            "            matching_published_pages = Page.objects.published().public().filter(",
            "                Q(title_set__title__icontains=query_term, title_set__language=language_code)",
            "                | Q(title_set__path__icontains=query_term, title_set__language=language_code)",
            "                | Q(title_set__menu_title__icontains=query_term, title_set__language=language_code)",
            "                | Q(title_set__page_title__icontains=query_term, title_set__language=language_code)",
            "            ).distinct()",
            "",
            "            results = []",
            "            for page in matching_published_pages:",
            "                results.append(",
            "                    {",
            "                        'path': page.get_path(language=language_code),",
            "                        'title': page.get_title(language=language_code),",
            "                        'redirect_url': page.get_absolute_url(language=language_code)",
            "                    }",
            "                )",
            "",
            "            if DJANGO_1_4:",
            "                return HttpResponse(json.dumps(results), mimetype='application/json')",
            "            else:",
            "                return HttpResponse(json.dumps(results), content_type='application/json')",
            "",
            "        else:",
            "            return HttpResponseForbidden()",
            "",
            "    def add_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).add_plugin(*args, **kwargs)",
            "",
            "    def copy_plugins(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).copy_plugins(*args, **kwargs)",
            "",
            "    def edit_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).edit_plugin(*args, **kwargs)",
            "",
            "    def move_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).move_plugin(*args, **kwargs)",
            "",
            "    def delete_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).delete_plugin(*args, **kwargs)",
            "",
            "    def clear_placeholder(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).clear_placeholder(*args, **kwargs)",
            "",
            "",
            "",
            "admin.site.register(Page, PageAdmin)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import copy",
            "from functools import wraps",
            "import json",
            "import sys",
            "",
            "import django",
            "from django.contrib.admin.helpers import AdminForm",
            "from django.conf import settings",
            "from django.contrib import admin, messages",
            "from django.contrib.admin.models import LogEntry, CHANGE",
            "from django.contrib.admin.options import IncorrectLookupParameters",
            "from django.contrib.admin.util import get_deleted_objects",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.contrib.sites.models import Site, get_current_site",
            "from django.core.exceptions import PermissionDenied, ObjectDoesNotExist, ValidationError",
            "from django.db import router",
            "from django.db.models import Q",
            "from django.http import HttpResponseRedirect, HttpResponse, Http404, HttpResponseBadRequest, HttpResponseForbidden",
            "from django.shortcuts import render_to_response, get_object_or_404",
            "from django.template.context import RequestContext",
            "from django.template.defaultfilters import escape",
            "from django.utils.translation import ugettext_lazy as _, get_language",
            "from django.utils.decorators import method_decorator",
            "from django.views.decorators.http import require_POST",
            "",
            "from cms.admin.change_list import CMSChangeList",
            "from cms.admin.dialog.views import get_copy_dialog",
            "from cms.admin.forms import (PageForm, AdvancedSettingsForm, PagePermissionForm,",
            "                             PublicationDatesForm)",
            "from cms.admin.permissionadmin import (PERMISSION_ADMIN_INLINES, PagePermissionInlineAdmin, ViewRestrictionInlineAdmin)",
            "from cms.admin.placeholderadmin import PlaceholderAdminMixin",
            "from cms.admin.views import revert_plugins",
            "from cms.constants import PAGE_TYPES_ID, PUBLISHER_STATE_PENDING",
            "from cms.models import Page, Title, CMSPlugin, PagePermission, GlobalPagePermission, StaticPlaceholder",
            "from cms.models.managers import PagePermissionsPermissionManager",
            "from cms.plugin_pool import plugin_pool",
            "from cms.toolbar_pool import toolbar_pool",
            "from cms.utils import helpers, permissions, get_language_from_request, admin as admin_utils, copy_plugins",
            "from cms.utils.i18n import get_language_list, get_language_tuple, get_language_object, force_language",
            "from cms.utils.admin import jsonify_request",
            "from cms.utils.compat import DJANGO_1_4",
            "from cms.utils.compat.dj import force_unicode, is_installed",
            "from cms.utils.compat.urls import unquote",
            "from cms.utils.conf import get_cms_setting",
            "from cms.utils.helpers import find_placeholder_relation",
            "from cms.utils.permissions import has_global_page_permission, has_generic_permission",
            "from cms.utils.plugins import current_site",
            "from cms.utils.transaction import wrap_transaction",
            "from cms.utils.urlutils import add_url_parameters, admin_reverse",
            "",
            "require_POST = method_decorator(require_POST)",
            "",
            "if is_installed('reversion'):",
            "    from reversion.admin import VersionAdmin as ModelAdmin",
            "    from reversion import create_revision",
            "else:  # pragma: no cover",
            "    from django.contrib.admin import ModelAdmin",
            "",
            "    class ReversionContext(object):",
            "        def __enter__(self):",
            "            yield",
            "",
            "        def __exit__(self, exc_type, exc_val, exc_tb):",
            "            pass",
            "",
            "        def __call__(self, func):",
            "            \"\"\"Allows this revision context to be used as a decorator.\"\"\"",
            "",
            "            @wraps(func)",
            "            def do_revision_context(*args, **kwargs):",
            "                self.__enter__()",
            "                exception = False",
            "                try:",
            "                    try:",
            "                        return func(*args, **kwargs)",
            "                    except:",
            "                        exception = True",
            "                        if not self.__exit__(*sys.exc_info()):",
            "                            raise",
            "                finally:",
            "                    if not exception:",
            "                        self.__exit__(None, None, None)",
            "",
            "            return do_revision_context",
            "",
            "    def create_revision():",
            "        return ReversionContext()",
            "",
            "PUBLISH_COMMENT = \"Publish\"",
            "INITIAL_COMMENT = \"Initial version.\"",
            "",
            "",
            "class PageAdmin(PlaceholderAdminMixin, ModelAdmin):",
            "    form = PageForm",
            "    search_fields = ('=id', 'title_set__slug', 'title_set__title', 'reverse_id')",
            "    revision_form_template = \"admin/cms/page/history/revision_header.html\"",
            "    recover_form_template = \"admin/cms/page/history/recover_header.html\"",
            "    add_general_fields = ['title', 'slug', 'language', 'template']",
            "    change_list_template = \"admin/cms/page/tree/base.html\"",
            "    list_filter = ['in_navigation', 'template', 'changed_by', 'soft_root']",
            "    title_frontend_editable_fields = ['title', 'menu_title', 'page_title']",
            "",
            "    inlines = PERMISSION_ADMIN_INLINES",
            "",
            "    def get_urls(self):",
            "        \"\"\"Get the admin urls",
            "        \"\"\"",
            "        from django.conf.urls import patterns, url",
            "",
            "        info = \"%s_%s\" % (self.model._meta.app_label, self.model._meta.module_name)",
            "        pat = lambda regex, fn: url(regex, self.admin_site.admin_view(fn), name='%s_%s' % (info, fn.__name__))",
            "",
            "        url_patterns = patterns(",
            "            '',",
            "",
            "            pat(r'^([0-9]+)/advanced-settings/$', self.advanced),",
            "            pat(r'^([0-9]+)/dates/$', self.dates),",
            "            pat(r'^([0-9]+)/permission-settings/$', self.permissions),",
            "            pat(r'^([0-9]+)/delete-translation/$', self.delete_translation),",
            "            pat(r'^([0-9]+)/move-page/$', self.move_page),",
            "            pat(r'^([0-9]+)/copy-page/$', self.copy_page),",
            "            pat(r'^([0-9]+)/copy-language/$', self.copy_language),",
            "            pat(r'^([0-9]+)/dialog/copy/$', get_copy_dialog),  # copy dialog",
            "            pat(r'^([0-9]+)/change-navigation/$', self.change_innavigation),",
            "            pat(r'^([0-9]+)/jsi18n/$', self.redirect_jsi18n),",
            "            pat(r'^([0-9]+)/permissions/$', self.get_permissions),",
            "            pat(r'^([0-9]+)/undo/$', self.undo),",
            "            pat(r'^([0-9]+)/redo/$', self.redo),",
            "            pat(r'^([0-9]+)/change_template/$', self.change_template),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/descendants/$', self.descendants),  # menu html for page descendants",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/edit-field/$', self.edit_title_fields),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/publish/$', self.publish_page),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/unpublish/$', self.unpublish),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/revert/$', self.revert_page),",
            "            pat(r'^([0-9]+)/([a-z\\-]+)/preview/$', self.preview_page),",
            "            pat(r'^add-page-type/$', self.add_page_type),",
            "            pat(r'^published-pages/$', self.get_published_pagelist),",
            "            url(r'^resolve/$', self.resolve, name=\"cms_page_resolve\"),",
            "        )",
            "",
            "        if plugin_pool.get_all_plugins():",
            "            url_patterns += plugin_pool.get_patterns()",
            "",
            "        url_patterns += super(PageAdmin, self).get_urls()",
            "        return url_patterns",
            "",
            "    def redirect_jsi18n(self, request):",
            "        return HttpResponseRedirect(admin_reverse('jsi18n'))",
            "",
            "    def get_revision_instances(self, request, object):",
            "        \"\"\"Returns all the instances to be used in the object's revision.\"\"\"",
            "        if isinstance(object, Title):",
            "            object = object.page",
            "        if isinstance(object, Page) and not object.publisher_is_draft:",
            "            object = object.publisher_public",
            "        placeholder_relation = find_placeholder_relation(object)",
            "        data = [object]",
            "        filters = {'placeholder__%s' % placeholder_relation: object}",
            "        for plugin in CMSPlugin.objects.filter(**filters):",
            "            data.append(plugin)",
            "            plugin_instance, admin = plugin.get_plugin_instance()",
            "            if plugin_instance:",
            "                data.append(plugin_instance)",
            "        if isinstance(object, Page):",
            "            titles = object.title_set.all()",
            "            for title in titles:",
            "                title.publisher_public = None",
            "                data.append(title)",
            "        return data",
            "",
            "    def save_model(self, request, obj, form, change):",
            "        \"\"\"",
            "        Move the page in the tree if necessary and save every placeholder",
            "        Content object.",
            "        \"\"\"",
            "        target = request.GET.get('target', None)",
            "        position = request.GET.get('position', None)",
            "",
            "        if 'recover' in request.path_info:",
            "            pk = obj.pk",
            "            if obj.parent_id:",
            "                parent = Page.objects.get(pk=obj.parent_id)",
            "            else:",
            "                parent = None",
            "            obj.lft = 0",
            "            obj.rght = 0",
            "            obj.tree_id = 0",
            "            obj.level = 0",
            "            obj.pk = None",
            "            obj.insert_at(parent, save=False)",
            "            obj.pk = pk",
            "            obj.save(no_signals=True)",
            "",
            "        else:",
            "            if 'history' in request.path_info:",
            "                old_obj = Page.objects.get(pk=obj.pk)",
            "                obj.level = old_obj.level",
            "                obj.parent_id = old_obj.parent_id",
            "                obj.rght = old_obj.rght",
            "                obj.lft = old_obj.lft",
            "                obj.tree_id = old_obj.tree_id",
            "        new = False",
            "        if not obj.pk:",
            "            new = True",
            "        obj.save()",
            "",
            "        if 'recover' in request.path_info or 'history' in request.path_info:",
            "            revert_plugins(request, obj.version.pk, obj)",
            "",
            "        if target is not None and position is not None:",
            "            try:",
            "                target = self.model.objects.get(pk=target)",
            "            except self.model.DoesNotExist:",
            "                pass",
            "            else:",
            "                obj.move_to(target, position)",
            "        page_type_id = form.cleaned_data.get('page_type')",
            "        copy_target_id = request.GET.get('copy_target')",
            "        if copy_target_id or page_type_id:",
            "            if page_type_id:",
            "                copy_target_id = page_type_id",
            "            copy_target = Page.objects.get(pk=copy_target_id)",
            "            if not copy_target.has_view_permission(request):",
            "                raise PermissionDenied()",
            "            obj = Page.objects.get(pk=obj.pk) #mptt reload",
            "            copy_target._copy_attributes(obj, clean=True)",
            "            obj.save()",
            "            for lang in copy_target.languages.split(','):",
            "                copy_target._copy_contents(obj, lang)",
            "        if not 'permission' in request.path_info:",
            "            language = form.cleaned_data['language']",
            "            Title.objects.set_or_create(",
            "                request,",
            "                obj,",
            "                form,",
            "                language,",
            "            )",
            "        # is it home? publish it right away",
            "        if new and Page.objects.filter(site_id=obj.site_id).count() == 1:",
            "            obj.publish(language)",
            "",
            "    def get_fieldsets(self, request, obj=None):",
            "        form = self.get_form(request, obj, fields=None)",
            "        if getattr(form, 'fieldsets', None) is None:",
            "            fields = list(form.base_fields) + list(self.get_readonly_fields(request, obj))",
            "            return [(None, {'fields': fields})]",
            "        else:",
            "            return form.fieldsets",
            "",
            "    def get_inline_classes(self, request, obj=None, **kwargs):",
            "        if obj and 'permission' in request.path_info:",
            "            return PERMISSION_ADMIN_INLINES",
            "        return []",
            "",
            "    def get_form_class(self, request, obj=None, **kwargs):",
            "        if 'advanced' in request.path_info:",
            "            return AdvancedSettingsForm",
            "        elif 'permission' in request.path_info:",
            "            return PagePermissionForm",
            "        elif 'dates' in request.path_info:",
            "            return PublicationDatesForm",
            "        return self.form",
            "",
            "    def get_form(self, request, obj=None, **kwargs):",
            "        \"\"\"",
            "        Get PageForm for the Page model and modify its fields depending on",
            "        the request.",
            "        \"\"\"",
            "        language = get_language_from_request(request, obj)",
            "        form_cls = self.get_form_class(request, obj)",
            "        form = super(PageAdmin, self).get_form(request, obj, form=form_cls, **kwargs)",
            "        # get_form method operates by overriding initial fields value which",
            "        # may persist across invocation. Code below deepcopies fields definition",
            "        # to avoid leaks",
            "        for field in form.base_fields.keys():",
            "            form.base_fields[field] = copy.deepcopy(form.base_fields[field])",
            "",
            "        if 'language' in form.base_fields:",
            "            form.base_fields['language'].initial = language",
            "",
            "        if 'page_type' in form.base_fields:",
            "            if 'copy_target' in request.GET or 'add_page_type' in request.GET or obj:",
            "                del form.base_fields['page_type']",
            "            elif not Title.objects.filter(page__parent__reverse_id=PAGE_TYPES_ID, language=language).exists():",
            "                del form.base_fields['page_type']",
            "",
            "        if 'add_page_type' in request.GET:",
            "            del form.base_fields['menu_title']",
            "            del form.base_fields['meta_description']",
            "            del form.base_fields['page_title']",
            "",
            "        self.inlines = self.get_inline_classes(request, obj, **kwargs)",
            "",
            "        if obj:",
            "            if 'history' in request.path_info or 'recover' in request.path_info:",
            "                version_id = request.path_info.split('/')[-2]",
            "            else:",
            "                version_id = None",
            "",
            "            title_obj = obj.get_title_obj(language=language, fallback=False, version_id=version_id, force_reload=True)",
            "",
            "            if 'site' in form.base_fields and form.base_fields['site'].initial is None:",
            "                form.base_fields['site'].initial = obj.site",
            "",
            "            for name in ('slug', 'title', 'meta_description', 'menu_title', 'page_title', 'redirect'):",
            "                if name in form.base_fields:",
            "                    form.base_fields[name].initial = getattr(title_obj, name)",
            "",
            "            if 'overwrite_url' in form.base_fields:",
            "                if title_obj.has_url_overwrite:",
            "                    form.base_fields['overwrite_url'].initial = title_obj.path",
            "                else:",
            "                    form.base_fields['overwrite_url'].initial = ''",
            "",
            "        else:",
            "            for name in ('slug', 'title'):",
            "                form.base_fields[name].initial = u''",
            "",
            "            if 'target' in request.GET or 'copy_target' in request.GET:",
            "                target = request.GET.get('copy_target') or request.GET.get('target')",
            "                if 'position' in request.GET:",
            "                    position = request.GET['position']",
            "                    if position == 'last-child' or position == 'first-child':",
            "                        form.base_fields['parent'].initial = request.GET.get('target', None)",
            "                    else:",
            "                        sibling = Page.objects.get(pk=target)",
            "                        form.base_fields['parent'].initial = sibling.parent_id",
            "                else:",
            "                    form.base_fields['parent'].initial = request.GET.get('target', None)",
            "",
            "            form.base_fields['site'].initial = request.session.get('cms_admin_site', None)",
            "",
            "        return form",
            "",
            "    def advanced(self, request, object_id):",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        if not page.has_advanced_settings_permission(request):",
            "            raise PermissionDenied(\"No permission for editing advanced settings\")",
            "        return self.change_view(request, object_id, extra_context={'advanced_settings': True, 'title': _(\"Advanced Settings\")})",
            "",
            "    def dates(self, request, object_id):",
            "        return self.change_view(request, object_id, extra_context={'publishing_dates': True, 'title': _(\"Publishing dates\")})",
            "",
            "    def permissions(self, request, object_id):",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        if not page.has_change_permissions_permission(request):",
            "            raise PermissionDenied(\"No permission for editing advanced settings\")",
            "        return self.change_view(request, object_id, extra_context={'show_permissions': True, 'title': _(\"Change Permissions\")})",
            "",
            "    def get_inline_instances(self, request, obj=None):",
            "        if DJANGO_1_4:",
            "            inlines = super(PageAdmin, self).get_inline_instances(request)",
            "            if hasattr(self, '_current_page'):",
            "                obj = self._current_page",
            "        else:",
            "            inlines = super(PageAdmin, self).get_inline_instances(request, obj)",
            "        if get_cms_setting('PERMISSION') and obj:",
            "            filtered_inlines = []",
            "            for inline in inlines:",
            "                if (isinstance(inline, PagePermissionInlineAdmin)",
            "                and not isinstance(inline, ViewRestrictionInlineAdmin)):",
            "                    if \"recover\" in request.path or \"history\" in request.path:",
            "                        # do not display permissions in recover mode",
            "                        continue",
            "                    if not obj.has_change_permissions_permission(request):",
            "                        continue",
            "                filtered_inlines.append(inline)",
            "            inlines = filtered_inlines",
            "        return inlines",
            "",
            "    def get_unihandecode_context(self, language):",
            "        if language[:2] in get_cms_setting('UNIHANDECODE_DECODERS'):",
            "            uhd_lang = language[:2]",
            "        else:",
            "            uhd_lang = get_cms_setting('UNIHANDECODE_DEFAULT_DECODER')",
            "        uhd_host = get_cms_setting('UNIHANDECODE_HOST')",
            "        uhd_version = get_cms_setting('UNIHANDECODE_VERSION')",
            "        if uhd_lang and uhd_host and uhd_version:",
            "            uhd_urls = [",
            "                '%sunihandecode-%s.core.min.js' % (uhd_host, uhd_version),",
            "                '%sunihandecode-%s.%s.min.js' % (uhd_host, uhd_version, uhd_lang),",
            "            ]",
            "        else:",
            "            uhd_urls = []",
            "        return {'unihandecode_lang': uhd_lang, 'unihandecode_urls': uhd_urls}",
            "",
            "    def add_view(self, request, form_url='', extra_context=None):",
            "        extra_context = extra_context or {}",
            "        language = get_language_from_request(request)",
            "        extra_context.update({",
            "            'language': language,",
            "        })",
            "        if not request.GET.get('add_page_type') is None:",
            "            extra_context.update({",
            "                'add_page_type': True,",
            "                'title':  _(\"Add Page Type\"),",
            "            })",
            "        elif 'copy_target' in request.GET:",
            "            extra_context.update({",
            "                'title':  _(\"Add Page Copy\"),",
            "            })",
            "        else:",
            "            extra_context = self.update_language_tab_context(request, context=extra_context)",
            "        extra_context.update(self.get_unihandecode_context(language))",
            "        return super(PageAdmin, self).add_view(request, form_url, extra_context=extra_context)",
            "",
            "    def change_view(self, request, object_id, form_url='', extra_context=None):",
            "        \"\"\"",
            "        The 'change' admin view for the Page model.",
            "        \"\"\"",
            "        if extra_context is None:",
            "            extra_context = {'basic_info': True}",
            "        try:",
            "            obj = self.model.objects.get(pk=object_id)",
            "        except self.model.DoesNotExist:",
            "            # Don't raise Http404 just yet, because we haven't checked",
            "            # permissions yet. We don't want an unauthenticated user to be able",
            "            # to determine whether a given object exists.",
            "            obj = None",
            "        else:",
            "            #activate(user_lang_set)",
            "            context = {",
            "                'page': obj,",
            "                'CMS_PERMISSION': get_cms_setting('PERMISSION'),",
            "                'ADMIN_MEDIA_URL': settings.STATIC_URL,",
            "                'can_change': obj.has_change_permission(request),",
            "                'can_change_permissions': obj.has_change_permissions_permission(request),",
            "                'current_site_id': settings.SITE_ID,",
            "            }",
            "            context.update(extra_context or {})",
            "            extra_context = self.update_language_tab_context(request, obj, context)",
            "",
            "        tab_language = get_language_from_request(request)",
            "",
            "        extra_context.update(self.get_unihandecode_context(tab_language))",
            "",
            "        # get_inline_instances will need access to 'obj' so that it can",
            "        # determine if current user has enough rights to see PagePermissionInlineAdmin",
            "        # because in django versions <1.5 get_inline_instances doesn't receive 'obj'",
            "        # as a parameter, the workaround is to set it as an attribute...",
            "        if DJANGO_1_4:",
            "            self._current_page = obj",
            "        response = super(PageAdmin, self).change_view(",
            "            request, object_id, form_url=form_url, extra_context=extra_context)",
            "        if tab_language and response.status_code == 302 and response._headers['location'][1] == request.path_info:",
            "            location = response._headers['location']",
            "            response._headers['location'] = (location[0], \"%s?language=%s\" % (location[1], tab_language))",
            "        return response",
            "",
            "    def render_change_form(self, request, context, add=False, change=False, form_url='', obj=None):",
            "        # add context variables",
            "        filled_languages = []",
            "        if obj:",
            "            filled_languages = [t[0] for t in obj.title_set.filter(title__isnull=False).values_list('language')]",
            "        allowed_languages = [lang[0] for lang in self._get_site_languages(obj)]",
            "        context.update({",
            "            'filled_languages': [lang for lang in filled_languages if lang in allowed_languages],",
            "        })",
            "        return super(PageAdmin, self).render_change_form(request, context, add, change, form_url, obj)",
            "",
            "    def _get_site_languages(self, obj=None):",
            "        site_id = None",
            "        if obj:",
            "            site_id = obj.site_id",
            "        else:",
            "            site_id = Site.objects.get_current().pk",
            "        return get_language_tuple(site_id)",
            "",
            "    def update_language_tab_context(self, request, obj=None, context=None):",
            "        if not context:",
            "            context = {}",
            "        language = get_language_from_request(request, obj)",
            "        languages = self._get_site_languages(obj)",
            "        context.update({",
            "            'language': language,",
            "            'language_tabs': languages,",
            "            # Dates are not language dependent, thus we hide the language",
            "            # selection bar: the language is forced through the form class",
            "            'show_language_tabs': len(list(languages)) > 1 and not context.get('publishing_dates', False),",
            "        })",
            "        return context",
            "",
            "    def response_change(self, request, obj):",
            "        \"\"\"Called always when page gets changed, call save on page, there may be",
            "        some new stuff, which should be published after all other objects on page",
            "        are collected.",
            "        \"\"\"",
            "        # save the object again, so all the related changes to page model",
            "        # can be published if required",
            "        obj.save()",
            "        return super(PageAdmin, self).response_change(request, obj)",
            "",
            "    def has_add_permission(self, request):",
            "        \"\"\"",
            "        Return true if the current user has permission to add a new page.",
            "        \"\"\"",
            "        if get_cms_setting('PERMISSION'):",
            "            return permissions.has_page_add_permission(request)",
            "        return super(PageAdmin, self).has_add_permission(request)",
            "",
            "    def has_change_permission(self, request, obj=None):",
            "        \"\"\"",
            "        Return true if the current user has permission on the page.",
            "        Return the string 'All' if the user has all rights.",
            "        \"\"\"",
            "        if get_cms_setting('PERMISSION'):",
            "            if obj:",
            "                return obj.has_change_permission(request)",
            "            else:",
            "                return permissions.has_page_change_permission(request)",
            "        return super(PageAdmin, self).has_change_permission(request, obj)",
            "",
            "    def has_delete_permission(self, request, obj=None):",
            "        \"\"\"",
            "        Returns True if the given request has permission to change the given",
            "        Django model instance. If CMS_PERMISSION are in use also takes look to",
            "        object permissions.",
            "        \"\"\"",
            "        if get_cms_setting('PERMISSION') and obj is not None:",
            "            return obj.has_delete_permission(request)",
            "        return super(PageAdmin, self).has_delete_permission(request, obj)",
            "",
            "    def has_recover_permission(self, request):",
            "        \"\"\"",
            "        Returns True if the use has the right to recover pages",
            "        \"\"\"",
            "        if not is_installed('reversion'):",
            "            return False",
            "        user = request.user",
            "        if user.is_superuser:",
            "            return True",
            "        try:",
            "            if has_global_page_permission(request, can_recover_page=True):",
            "                return True",
            "        except:",
            "            pass",
            "        return False",
            "",
            "    def has_add_plugin_permission(self, request, placeholder, plugin_type):",
            "        if not permissions.has_plugin_permission(request.user, plugin_type, \"add\"):",
            "            return False",
            "        page = placeholder.page",
            "        if page and not page.has_change_permission(request):",
            "            return False",
            "        if page and not page.publisher_is_draft:",
            "            return False",
            "        return True",
            "",
            "    def has_copy_plugin_permission(self, request, source_placeholder, target_placeholder, plugins):",
            "        source_page = source_placeholder.page",
            "        if source_page and not source_page.has_change_permission(request):",
            "            return False",
            "        target_page = target_placeholder.page",
            "        if target_page and not target_page.has_change_permission(request):",
            "            return False",
            "        if target_page and not target_page.publisher_is_draft:",
            "            return False",
            "        for plugin in plugins:",
            "            if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"add\"):",
            "                return False",
            "        return True",
            "",
            "    def has_change_plugin_permission(self, request, plugin):",
            "        page = plugin.placeholder.page if plugin.placeholder else None",
            "        if page and not page.has_change_permission(request):",
            "            return False",
            "        if page and not page.publisher_is_draft:",
            "            return False",
            "        if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"change\"):",
            "            return False",
            "        return True",
            "",
            "    def has_move_plugin_permission(self, request, plugin, target_placeholder):",
            "        if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"change\"):",
            "            return False",
            "        page = plugin.placeholder.page",
            "        if page and not page.has_change_permission(request):",
            "            return False",
            "        if page and not page.publisher_is_draft:",
            "            return False",
            "        return True",
            "",
            "    def has_delete_plugin_permission(self, request, plugin):",
            "        if not permissions.has_plugin_permission(request.user, plugin.plugin_type, \"delete\"):",
            "            return False",
            "        page = plugin.placeholder.page",
            "        if page:",
            "            if not page.publisher_is_draft:",
            "                return False",
            "            if not page.has_change_permission(request):",
            "                return False",
            "        return True",
            "",
            "    def has_clear_placeholder_permission(self, request, placeholder):",
            "        page = placeholder.page if placeholder else None",
            "        if page:",
            "            if not page.publisher_is_draft:",
            "                return False",
            "            if not page.has_change_permission(request):",
            "                return False",
            "        return True",
            "",
            "    def post_add_plugin(self, request, placeholder, plugin):",
            "        if is_installed('reversion') and placeholder.page:",
            "            plugin_name = force_unicode(plugin_pool.get_plugin(plugin.plugin_type).name)",
            "            message = _(u\"%(plugin_name)s plugin added to %(placeholder)s\") % {",
            "                'plugin_name': plugin_name, 'placeholder': placeholder}",
            "            self.cleanup_history(placeholder.page)",
            "            helpers.make_revision_with_plugins(placeholder.page, request.user, message)",
            "",
            "    def post_copy_plugins(self, request, source_placeholder, target_placeholder, plugins):",
            "        page = target_placeholder.page",
            "        if page and is_installed('reversion'):",
            "            message = _(u\"Copied plugins to %(placeholder)s\") % {'placeholder': target_placeholder}",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, message)",
            "",
            "    def post_edit_plugin(self, request, plugin):",
            "        page = plugin.placeholder.page",
            "        if page:",
            "            # if reversion is installed, save version of the page plugins",
            "            if is_installed('reversion') and page:",
            "                plugin_name = force_unicode(plugin_pool.get_plugin(plugin.plugin_type).name)",
            "                message = _(",
            "                    u\"%(plugin_name)s plugin edited at position %(position)s in %(placeholder)s\") % {",
            "                        'plugin_name': plugin_name,",
            "                        'position': plugin.position,",
            "                        'placeholder': plugin.placeholder.slot",
            "                    }",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, message)",
            "",
            "    def post_move_plugin(self, request, source_placeholder, target_placeholder, plugin):",
            "        page = target_placeholder.page",
            "        if page and is_installed('reversion'):",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, _(u\"Plugins were moved\"))",
            "",
            "    def post_delete_plugin(self, request, plugin):",
            "        plugin_name = force_unicode(plugin_pool.get_plugin(plugin.plugin_type).name)",
            "        page = plugin.placeholder.page",
            "        if page:",
            "            page.save()",
            "            comment = _(\"%(plugin_name)s plugin at position %(position)s in %(placeholder)s was deleted.\") % {",
            "                'plugin_name': plugin_name,",
            "                'position': plugin.position,",
            "                'placeholder': plugin.placeholder,",
            "            }",
            "            if is_installed('reversion'):",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, comment)",
            "",
            "    def post_clear_placeholder(self, request, placeholder):",
            "        page = placeholder.page",
            "        if page:",
            "            page.save()",
            "            comment = _('All plugins in the placeholder \"%(name)s\" were deleted.') % {",
            "                'name': force_unicode(placeholder)",
            "            }",
            "            if is_installed('reversion'):",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, comment)",
            "",
            "    def get_placeholder_template(self, request, placeholder):",
            "        page = placeholder.page",
            "        if page:",
            "            return page.get_template()",
            "",
            "    def changelist_view(self, request, extra_context=None):",
            "        \"The 'change list' admin view for this model.\"",
            "        from django.contrib.admin.views.main import ERROR_FLAG",
            "",
            "        opts = self.model._meta",
            "        app_label = opts.app_label",
            "        if not self.has_change_permission(request, None):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change pages.\")))",
            "        try:",
            "            cl = CMSChangeList(request, self.model, self.list_display, self.list_display_links, self.list_filter,",
            "                               self.date_hierarchy, self.search_fields, self.list_select_related, self.list_per_page,",
            "                               self.list_max_show_all, self.list_editable, self)",
            "        except IncorrectLookupParameters:",
            "            # Wacky lookup parameters were given, so redirect to the main",
            "            # changelist page, without parameters, and pass an 'invalid=1'",
            "            # parameter via the query string. If wacky parameters were given and",
            "            # the 'invalid=1' parameter was already in the query string, something",
            "            # is screwed up with the database, so display an error page.",
            "            if ERROR_FLAG in request.GET.keys():",
            "                return render_to_response('admin/invalid_setup.html', {'title': _('Database error')})",
            "            return HttpResponseRedirect(request.path_info + '?' + ERROR_FLAG + '=1')",
            "        cl.set_items(request)",
            "",
            "        site_id = request.GET.get('site__exact', None)",
            "        if site_id is None:",
            "            site_id = current_site(request).pk",
            "        site_id = int(site_id)",
            "",
            "        # languages",
            "        languages = get_language_list(site_id)",
            "",
            "        # parse the cookie that saves which page trees have",
            "        # been opened already and extracts the page ID",
            "        djangocms_nodes_open = request.COOKIES.get('djangocms_nodes_open', '')",
            "        raw_nodes = unquote(djangocms_nodes_open).split(',')",
            "        try:",
            "            open_menu_trees = [int(c.split('page_', 1)[1]) for c in raw_nodes]",
            "        except IndexError:",
            "            open_menu_trees = []",
            "        # Language may be present in the GET dictionary but empty",
            "        language = request.GET.get('language', get_language())",
            "        if not language:",
            "            language = get_language()",
            "        context = {",
            "            'title': cl.title,",
            "            'is_popup': cl.is_popup,",
            "            'cl': cl,",
            "            'opts': opts,",
            "            'has_add_permission': self.has_add_permission(request),",
            "            'root_path': admin_reverse('index'),",
            "            'app_label': app_label,",
            "            'preview_language': language,",
            "            'CMS_MEDIA_URL': get_cms_setting('MEDIA_URL'),",
            "            'CMS_PERMISSION': get_cms_setting('PERMISSION'),",
            "            'DEBUG': settings.DEBUG,",
            "            'site_languages': languages,",
            "            'open_menu_trees': open_menu_trees,",
            "        }",
            "        if is_installed('reversion'):",
            "            context['has_recover_permission'] = self.has_recover_permission(request)",
            "            context['has_change_permission'] = self.has_change_permission(request)",
            "        context.update(extra_context or {})",
            "        return render_to_response(self.change_list_template or [",
            "            'admin/%s/%s/change_list.html' % (app_label, opts.object_name.lower()),",
            "            'admin/%s/change_list.html' % app_label,",
            "            'admin/change_list.html'",
            "        ], context, context_instance=RequestContext(request))",
            "",
            "    def recoverlist_view(self, request, extra_context=None):",
            "        if not self.has_recover_permission(request):",
            "            raise PermissionDenied",
            "        return super(PageAdmin, self).recoverlist_view(request, extra_context)",
            "",
            "    def recover_view(self, request, version_id, extra_context=None):",
            "        if not self.has_recover_permission(request):",
            "            raise PermissionDenied",
            "        extra_context = self.update_language_tab_context(request, None, extra_context)",
            "        return super(PageAdmin, self).recover_view(request, version_id, extra_context)",
            "",
            "    def revision_view(self, request, object_id, version_id, extra_context=None):",
            "        if not self.has_change_permission(request, Page.objects.get(pk=object_id)):",
            "            raise PermissionDenied",
            "        extra_context = self.update_language_tab_context(request, None, extra_context)",
            "        response = super(PageAdmin, self).revision_view(request, object_id, version_id, extra_context)",
            "        return response",
            "",
            "    def history_view(self, request, object_id, extra_context=None):",
            "        if not self.has_change_permission(request, Page.objects.get(pk=object_id)):",
            "            raise PermissionDenied",
            "        extra_context = self.update_language_tab_context(request, None, extra_context)",
            "        return super(PageAdmin, self).history_view(request, object_id, extra_context)",
            "",
            "    def render_revision_form(self, request, obj, version, context, revert=False, recover=False):",
            "        # reset parent to null if parent is not found",
            "        if version.field_dict['parent']:",
            "            try:",
            "                Page.objects.get(pk=version.field_dict['parent'])",
            "            except:",
            "                if revert and obj.parent_id != int(version.field_dict['parent']):",
            "                    version.field_dict['parent'] = obj.parent_id",
            "                if recover:",
            "                    obj.parent = None",
            "                    obj.parent_id = None",
            "                    version.field_dict['parent'] = None",
            "",
            "        obj.version = version",
            "",
            "        return super(PageAdmin, self).render_revision_form(request, obj, version, context, revert, recover)",
            "",
            "    @require_POST",
            "    def undo(self, request, object_id):",
            "        if not is_installed('reversion'):",
            "            return HttpResponseBadRequest('django reversion not installed')",
            "        from reversion.models import Revision",
            "        from cms.utils.page_resolver import is_valid_url",
            "        import reversion",
            "",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        old_titles = list(page.title_set.all())",
            "        if not page.publisher_is_draft:",
            "            page = page.publisher_draft",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "        versions = reversion.get_for_object(page)",
            "        if page.revision_id:",
            "            current_revision = Revision.objects.get(pk=page.revision_id)",
            "        else:",
            "            try:",
            "                current_version = versions[0]",
            "            except IndexError:",
            "                return HttpResponseBadRequest(\"no current revision found\")",
            "            current_revision = current_version.revision",
            "        try:",
            "            previous_version = versions.filter(revision__pk__lt=current_revision.pk)[0]",
            "        except IndexError:",
            "            return HttpResponseBadRequest(\"no previous revision found\")",
            "        previous_revision = previous_version.revision",
            "        # clear all plugins",
            "        placeholders = page.placeholders.all()",
            "        placeholder_ids = []",
            "        for placeholder in placeholders:",
            "            placeholder_ids.append(placeholder.pk)",
            "        plugins = CMSPlugin.objects.filter(placeholder__in=placeholder_ids).order_by('-level')",
            "        for plugin in plugins:",
            "            plugin._no_reorder = True",
            "            plugin.delete()",
            "        # TODO: delete placeholders instead of finding duplicates for 3.1",
            "        #page.placeholders.all().delete()",
            "",
            "        previous_revision.revert(True)",
            "        rev_page = get_object_or_404(Page, pk=page.pk)",
            "        rev_page.revision_id = previous_revision.pk",
            "        rev_page.publisher_public_id = page.publisher_public_id",
            "        rev_page.save()",
            "        new_placeholders = rev_page.placeholders.all()",
            "        slots = {}",
            "        for new_ph in new_placeholders:",
            "            if not new_ph.slot in slots:",
            "                slots[new_ph.slot] = new_ph",
            "            else:",
            "                if new_ph in placeholder_ids:",
            "                    new_ph.delete()",
            "                elif slots[new_ph.slot] in placeholder_ids:",
            "                    slots[new_ph.slot].delete()",
            "        new_titles = rev_page.title_set.all()",
            "        for title in new_titles:",
            "            try:",
            "                is_valid_url(title.path, rev_page)",
            "            except ValidationError:",
            "                for old_title in old_titles:",
            "                    if old_title.language == title.language:",
            "                        title.slug = old_title.slug",
            "                        title.save()",
            "                        messages.error(request, _(\"Page reverted but slug stays the same because of url collisions.\"))",
            "        return HttpResponse(\"ok\")",
            "",
            "    @require_POST",
            "    def redo(self, request, object_id):",
            "        if not is_installed('reversion'):",
            "            return HttpResponseBadRequest('django reversion not installed')",
            "        from reversion.models import Revision",
            "        import reversion",
            "        from cms.utils.page_resolver import is_valid_url",
            "",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        old_titles = list(page.title_set.all())",
            "        if not page.publisher_is_draft:",
            "            page = page.publisher_draft",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "        versions = reversion.get_for_object(page)",
            "        if page.revision_id:",
            "            current_revision = Revision.objects.get(pk=page.revision_id)",
            "        else:",
            "            try:",
            "                current_version = versions[0]",
            "            except IndexError:",
            "                return HttpResponseBadRequest(\"no current revision found\")",
            "            current_revision = current_version.revision",
            "        try:",
            "            previous_version = versions.filter(revision__pk__gt=current_revision.pk).order_by('pk')[0]",
            "        except IndexError:",
            "            return HttpResponseBadRequest(\"no next revision found\")",
            "        next_revision = previous_version.revision",
            "        # clear all plugins",
            "        placeholders = page.placeholders.all()",
            "        placeholder_ids = []",
            "        for placeholder in placeholders:",
            "            placeholder_ids.append(placeholder.pk)",
            "        plugins = CMSPlugin.objects.filter(placeholder__in=placeholder_ids).order_by('-level')",
            "        for plugin in plugins:",
            "            plugin._no_reorder = True",
            "            plugin.delete()",
            "        # TODO: 3.1 remove the placeholder matching from below and just delete them",
            "        #page.placeholders.all().delete()",
            "        next_revision.revert(True)",
            "        rev_page = get_object_or_404(Page, pk=page.pk)",
            "        rev_page.revision_id = next_revision.pk",
            "        rev_page.publisher_public_id = page.publisher_public_id",
            "        rev_page.save()",
            "        new_placeholders = rev_page.placeholders.all()",
            "        slots = {}",
            "        for new_ph in new_placeholders:",
            "            if not new_ph.slot in slots:",
            "                slots[new_ph.slot] = new_ph",
            "            else:",
            "                if new_ph in placeholder_ids:",
            "                    new_ph.delete()",
            "                elif slots[new_ph.slot] in placeholder_ids:",
            "                    slots[new_ph.slot].delete()",
            "        new_titles = rev_page.title_set.all()",
            "        for title in new_titles:",
            "            try:",
            "                is_valid_url(title.path, rev_page)",
            "            except ValidationError:",
            "                for old_title in old_titles:",
            "                    if old_title.language == title.language:",
            "                        title.slug = old_title.slug",
            "                        title.save()",
            "                        messages.error(request, _(\"Page reverted but slug stays the same because of url collisions.\"))",
            "        return HttpResponse(\"ok\")",
            "",
            "    @require_POST",
            "    @create_revision()",
            "    def change_template(self, request, object_id):",
            "        page = get_object_or_404(Page, pk=object_id)",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change the template\")))",
            "",
            "        to_template = request.POST.get(\"template\", None)",
            "        if to_template not in dict(get_cms_setting('TEMPLATES')):",
            "            return HttpResponseBadRequest(force_unicode(_(\"Template not valid\")))",
            "",
            "        page.template = to_template",
            "        page.save()",
            "        if is_installed('reversion'):",
            "            message = _(\"Template changed to %s\") % dict(get_cms_setting('TEMPLATES'))[to_template]",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, message)",
            "        return HttpResponse(force_unicode(_(\"The template was successfully changed\")))",
            "",
            "    @require_POST",
            "    @wrap_transaction",
            "    def move_page(self, request, page_id, extra_context=None):",
            "        \"\"\"",
            "        Move the page to the requested target, at the given position",
            "        \"\"\"",
            "        target = request.POST.get('target', None)",
            "        position = request.POST.get('position', None)",
            "        if target is None or position is None:",
            "            return HttpResponseRedirect('../../')",
            "",
            "        try:",
            "            page = self.model.objects.get(pk=page_id)",
            "            target = self.model.objects.get(pk=target)",
            "        except self.model.DoesNotExist:",
            "            return jsonify_request(HttpResponseBadRequest(\"error\"))",
            "",
            "        # does he haves permissions to do this...?",
            "        if not page.has_move_page_permission(request) or \\",
            "                not target.has_add_permission(request):",
            "            return jsonify_request(",
            "                HttpResponseForbidden(force_unicode(_(\"Error! You don't have permissions to move this page. Please reload the page\"))))",
            "            # move page",
            "        page.move_page(target, position)",
            "        if is_installed('reversion'):",
            "            self.cleanup_history(page)",
            "            helpers.make_revision_with_plugins(page, request.user, _(\"Page moved\"))",
            "",
            "        return jsonify_request(HttpResponse(admin_utils.render_admin_menu_item(request, page).content))",
            "",
            "    def get_permissions(self, request, page_id):",
            "        page = get_object_or_404(Page, id=page_id)",
            "",
            "        can_change_list = Page.permissions.get_change_id_list(request.user, page.site_id)",
            "",
            "        global_page_permissions = GlobalPagePermission.objects.filter(sites__in=[page.site_id])",
            "        page_permissions = PagePermission.objects.for_page(page)",
            "        all_permissions = list(global_page_permissions) + list(page_permissions)",
            "",
            "        # does he can change global permissions ?",
            "        has_global = permissions.has_global_change_permissions_permission(request)",
            "",
            "        permission_set = []",
            "        for permission in all_permissions:",
            "            if isinstance(permission, GlobalPagePermission):",
            "                if has_global:",
            "                    permission_set.append([(True, True), permission])",
            "                else:",
            "                    permission_set.append([(True, False), permission])",
            "            else:",
            "                if can_change_list == PagePermissionsPermissionManager.GRANT_ALL:",
            "                    can_change = True",
            "                else:",
            "                    can_change = permission.page_id in can_change_list",
            "                permission_set.append([(False, can_change), permission])",
            "",
            "        context = {",
            "            'page': page,",
            "            'permission_set': permission_set,",
            "        }",
            "        return render_to_response('admin/cms/page/permissions.html', context)",
            "",
            "    @require_POST",
            "    @wrap_transaction",
            "    def copy_language(self, request, page_id):",
            "        with create_revision():",
            "            source_language = request.POST.get('source_language')",
            "            target_language = request.POST.get('target_language')",
            "            page = Page.objects.get(pk=page_id)",
            "            placeholders = page.placeholders.all()",
            "",
            "            if not target_language or not target_language in get_language_list():",
            "                return HttpResponseBadRequest(force_unicode(_(\"Language must be set to a supported language!\")))",
            "            for placeholder in placeholders:",
            "                plugins = list(",
            "                    placeholder.cmsplugin_set.filter(language=source_language).order_by('tree_id', 'level', 'position'))",
            "                if not self.has_copy_plugin_permission(request, placeholder, placeholder, plugins):",
            "                    return HttpResponseForbidden(force_unicode(_('You do not have permission to copy these plugins.')))",
            "                copy_plugins.copy_plugins_to(plugins, placeholder, target_language)",
            "            if page and is_installed('reversion'):",
            "                message = _(u\"Copied plugins from %(source_language)s to %(target_language)s\") % {",
            "                    'source_language': source_language, 'target_language': target_language}",
            "                self.cleanup_history(page)",
            "                helpers.make_revision_with_plugins(page, request.user, message)",
            "            return HttpResponse(\"ok\")",
            "",
            "    @require_POST",
            "    @wrap_transaction",
            "    def copy_page(self, request, page_id, extra_context=None):",
            "        \"\"\"",
            "        Copy the page and all its plugins and descendants to the requested target, at the given position",
            "        \"\"\"",
            "        context = {}",
            "        page = Page.objects.get(pk=page_id)",
            "",
            "        target = request.POST.get('target', None)",
            "        position = request.POST.get('position', None)",
            "        site = request.POST.get('site', None)",
            "        if target is not None and position is not None and site is not None:",
            "            try:",
            "                target = self.model.objects.get(pk=target)",
            "                # does he have permissions to copy this page under target?",
            "                assert target.has_add_permission(request)",
            "                site = Site.objects.get(pk=site)",
            "            except (ObjectDoesNotExist, AssertionError):",
            "                return HttpResponse(\"error\")",
            "                #context.update({'error': _('Page could not been moved.')})",
            "            else:",
            "                try:",
            "                    kwargs = {",
            "                        'copy_permissions': request.REQUEST.get('copy_permissions', False),",
            "                    }",
            "                    page.copy_page(target, site, position, **kwargs)",
            "                    return jsonify_request(HttpResponse(\"ok\"))",
            "                except ValidationError:",
            "                    exc = sys.exc_info()[1]",
            "                    return jsonify_request(HttpResponseBadRequest(exc.messages))",
            "        context.update(extra_context or {})",
            "        return HttpResponseRedirect('../../')",
            "",
            "    @require_POST",
            "    @wrap_transaction",
            "    @create_revision()",
            "    def publish_page(self, request, page_id, language):",
            "        try:",
            "            page = Page.objects.get(id=page_id, publisher_is_draft=True)",
            "        except Page.DoesNotExist:",
            "            page = None",
            "        # ensure user has permissions to publish this page",
            "        all_published = True",
            "        if page:",
            "            if not page.has_publish_permission(request):",
            "                return HttpResponseForbidden(force_unicode(_(\"You do not have permission to publish this page\")))",
            "            published = page.publish(language)",
            "            if not published:",
            "                all_published = False",
            "        statics = request.GET.get('statics', '')",
            "        if not statics and not page:",
            "            return Http404(\"No page or stack found for publishing.\")",
            "        if statics:",
            "            static_ids = statics .split(',')",
            "            for pk in static_ids:",
            "                static_placeholder = StaticPlaceholder.objects.get(pk=pk)",
            "                published = static_placeholder.publish(request, language)",
            "                if not published:",
            "                    all_published = False",
            "        if page:",
            "            if all_published:",
            "                if page.get_publisher_state(language) == PUBLISHER_STATE_PENDING:",
            "                    messages.warning(request, _(\"Page not published! A parent page is not published yet.\"))",
            "                else:",
            "                    messages.info(request, _('The content was successfully published.'))",
            "                LogEntry.objects.log_action(",
            "                    user_id=request.user.id,",
            "                    content_type_id=ContentType.objects.get_for_model(Page).pk,",
            "                    object_id=page_id,",
            "                    object_repr=page.get_title(language),",
            "                    action_flag=CHANGE,",
            "                )",
            "            else:",
            "                if page.get_publisher_state(language) == PUBLISHER_STATE_PENDING:",
            "                    messages.warning(request, _(\"Page not published! A parent page is not published yet.\"))",
            "                else:",
            "                    messages.warning(request, _(\"There was a problem publishing your content\"))",
            "        if is_installed('reversion') and page:",
            "            self.cleanup_history(page, publish=True)",
            "            helpers.make_revision_with_plugins(page, request.user, PUBLISH_COMMENT)",
            "            # create a new publish reversion",
            "        if 'node' in request.REQUEST:",
            "            # if request comes from tree..",
            "            return admin_utils.render_admin_menu_item(request, page)",
            "",
            "        if 'redirect' in request.GET:",
            "            return HttpResponseRedirect(request.GET['redirect'])",
            "        referrer = request.META.get('HTTP_REFERER', '')",
            "",
            "        path = admin_reverse(\"cms_page_changelist\")",
            "        if request.GET.get('redirect_language'):",
            "            path = \"%s?language=%s&page_id=%s\" % (path, request.GET.get('redirect_language'), request.GET.get('redirect_page_id'))",
            "        if admin_reverse('index') not in referrer:",
            "            if all_published:",
            "                if page:",
            "                    if page.get_publisher_state(language) == PUBLISHER_STATE_PENDING:",
            "                        path = page.get_absolute_url(language, fallback=True)",
            "                    else:",
            "                        public_page = Page.objects.get(publisher_public=page.pk)",
            "                        path = '%s?%s' % (public_page.get_absolute_url(language, fallback=True), get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "                else:",
            "                    path = '%s?%s' % (referrer, get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "            else:",
            "                path = '/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF')",
            "",
            "        return HttpResponseRedirect(path)",
            "",
            "    def cleanup_history(self, page, publish=False):",
            "        if is_installed('reversion') and page:",
            "            # delete revisions that are not publish revisions",
            "            from reversion.models import Version",
            "",
            "            content_type = ContentType.objects.get_for_model(Page)",
            "            # reversion 1.8+ removes type field, revision filtering must be based on comments",
            "            versions_qs = Version.objects.filter(content_type=content_type, object_id_int=page.pk)",
            "            history_limit = get_cms_setting(\"MAX_PAGE_HISTORY_REVERSIONS\")",
            "            deleted = []",
            "            for version in versions_qs.exclude(revision__comment__in=(INITIAL_COMMENT,  PUBLISH_COMMENT)).order_by(",
            "                        '-revision__pk')[history_limit - 1:]:",
            "                if not version.revision_id in deleted:",
            "                    revision = version.revision",
            "                    revision.delete()",
            "                    deleted.append(revision.pk)",
            "                    # delete all publish revisions that are more then MAX_PAGE_PUBLISH_REVERSIONS",
            "            publish_limit = get_cms_setting(\"MAX_PAGE_PUBLISH_REVERSIONS\")",
            "            if publish_limit and publish:",
            "                deleted = []",
            "                for version in versions_qs.filter(revision__comment__exact=PUBLISH_COMMENT).order_by(",
            "                        '-revision__pk')[publish_limit - 1:]:",
            "                    if not version.revision_id in deleted:",
            "                        revision = version.revision",
            "                        revision.delete()",
            "                        deleted.append(revision.pk)",
            "",
            "    @require_POST",
            "    @wrap_transaction",
            "    def unpublish(self, request, page_id, language):",
            "        \"\"\"",
            "        Publish or unpublish a language of a page",
            "        \"\"\"",
            "        site = Site.objects.get_current()",
            "        page = get_object_or_404(Page, pk=page_id)",
            "        if not page.has_publish_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to unpublish this page\")))",
            "        if not page.publisher_public_id:",
            "            return HttpResponseForbidden(force_unicode(_(\"This page was never published\")))",
            "        try:",
            "            page.unpublish(language)",
            "            message = _('The %(language)s page \"%(page)s\" was successfully unpublished') % {",
            "                'language': get_language_object(language, site)['name'], 'page': page}",
            "            messages.info(request, message)",
            "            LogEntry.objects.log_action(",
            "                user_id=request.user.id,",
            "                content_type_id=ContentType.objects.get_for_model(Page).pk,",
            "                object_id=page_id,",
            "                object_repr=page.get_title(),",
            "                action_flag=CHANGE,",
            "                change_message=message,",
            "            )",
            "        except RuntimeError:",
            "            exc = sys.exc_info()[1]",
            "            messages.error(request, exc.message)",
            "        except ValidationError:",
            "            exc = sys.exc_info()[1]",
            "            messages.error(request, exc.message)",
            "        path = admin_reverse(\"cms_page_changelist\")",
            "        if request.GET.get('redirect_language'):",
            "            path = \"%s?language=%s&page_id=%s\" % (path, request.GET.get('redirect_language'), request.GET.get('redirect_page_id'))",
            "        return HttpResponseRedirect(path)",
            "",
            "    @require_POST",
            "    @wrap_transaction",
            "    def revert_page(self, request, page_id, language):",
            "        page = get_object_or_404(Page, id=page_id)",
            "        # ensure user has permissions to publish this page",
            "        if not page.has_change_permission(request):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "",
            "        page.revert(language)",
            "",
            "        messages.info(request, _('The page \"%s\" was successfully reverted.') % page)",
            "",
            "        if 'node' in request.REQUEST:",
            "            # if request comes from tree..",
            "            return admin_utils.render_admin_menu_item(request, page)",
            "",
            "        referer = request.META.get('HTTP_REFERER', '')",
            "        path = '../../'",
            "        if admin_reverse('index') not in referer:",
            "            path = '%s?%s' % (referer.split('?')[0], get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "        return HttpResponseRedirect(path)",
            "",
            "    @create_revision()",
            "    def delete_translation(self, request, object_id, extra_context=None):",
            "        if 'language' in request.GET:",
            "            language = request.GET['language']",
            "        else:",
            "            language = get_language_from_request(request)",
            "",
            "        opts = Page._meta",
            "        titleopts = Title._meta",
            "        app_label = titleopts.app_label",
            "        pluginopts = CMSPlugin._meta",
            "",
            "        try:",
            "            obj = self.queryset(request).get(pk=unquote(object_id))",
            "        except self.model.DoesNotExist:",
            "            # Don't raise Http404 just yet, because we haven't checked",
            "            # permissions yet. We don't want an unauthenticated user to be able",
            "            # to determine whether a given object exists.",
            "            obj = None",
            "",
            "        if not self.has_delete_permission(request, obj):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page\")))",
            "",
            "        if obj is None:",
            "            raise Http404(",
            "                _('%(name)s object with primary key %(key)r does not exist.') % {",
            "                    'name': force_unicode(opts.verbose_name),",
            "                    'key': escape(object_id)",
            "                })",
            "",
            "        if not len(list(obj.get_languages())) > 1:",
            "            raise Http404(_('There only exists one translation for this page'))",
            "",
            "        titleobj = get_object_or_404(Title, page__id=object_id, language=language)",
            "        saved_plugins = CMSPlugin.objects.filter(placeholder__page__id=object_id, language=language)",
            "",
            "        using = router.db_for_read(self.model)",
            "        kwargs = {",
            "            'admin_site': self.admin_site,",
            "            'user': request.user,",
            "            'using': using",
            "        }",
            "        deleted_objects, perms_needed = get_deleted_objects(",
            "            [titleobj],",
            "            titleopts,",
            "            **kwargs",
            "        )[:2]",
            "        to_delete_plugins, perms_needed_plugins = get_deleted_objects(",
            "            saved_plugins,",
            "            pluginopts,",
            "            **kwargs",
            "        )[:2]",
            "",
            "        deleted_objects.append(to_delete_plugins)",
            "        perms_needed = set(list(perms_needed) + list(perms_needed_plugins))",
            "",
            "        if request.method == 'POST':",
            "            if perms_needed:",
            "                raise PermissionDenied",
            "",
            "            message = _('Title and plugins with language %(language)s was deleted') % {",
            "                'language': force_unicode(get_language_object(language)['name'])",
            "            }",
            "            self.log_change(request, titleobj, message)",
            "            messages.info(request, message)",
            "",
            "            titleobj.delete()",
            "            for p in saved_plugins:",
            "                p.delete()",
            "",
            "            public = obj.publisher_public",
            "            if public:",
            "                public.save()",
            "",
            "            if is_installed('reversion'):",
            "                self.cleanup_history(obj)",
            "                helpers.make_revision_with_plugins(obj, request.user, message)",
            "",
            "            if not self.has_change_permission(request, None):",
            "                return HttpResponseRedirect(\"../../../../\")",
            "            return HttpResponseRedirect(\"../../\")",
            "",
            "        context = {",
            "            \"title\": _(\"Are you sure?\"),",
            "            \"object_name\": force_unicode(titleopts.verbose_name),",
            "            \"object\": titleobj,",
            "            \"deleted_objects\": deleted_objects,",
            "            \"perms_lacking\": perms_needed,",
            "            \"opts\": opts,",
            "            \"root_path\": admin_reverse('index'),",
            "            \"app_label\": app_label,",
            "        }",
            "        context.update(extra_context or {})",
            "        context_instance = RequestContext(request, current_app=self.admin_site.name)",
            "        return render_to_response(self.delete_confirmation_template or [",
            "            \"admin/%s/%s/delete_confirmation.html\" % (app_label, titleopts.object_name.lower()),",
            "            \"admin/%s/delete_confirmation.html\" % app_label,",
            "            \"admin/delete_confirmation.html\"",
            "        ], context, context_instance=context_instance)",
            "",
            "    def preview_page(self, request, object_id, language):",
            "        \"\"\"Redirecting preview function based on draft_id",
            "        \"\"\"",
            "        page = get_object_or_404(Page, id=object_id)",
            "        attrs = \"?%s\" % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')",
            "        attrs += \"&language=\" + language",
            "        with force_language(language):",
            "            url = page.get_absolute_url(language) + attrs",
            "        site = get_current_site(request)",
            "        if not site == page.site:",
            "            url = \"http%s://%s%s\" % ('s' if request.is_secure() else '',",
            "            page.site.domain, url)",
            "        return HttpResponseRedirect(url)",
            "",
            "    @require_POST",
            "    def change_innavigation(self, request, page_id):",
            "        \"\"\"",
            "        Switch the in_navigation of a page",
            "        \"\"\"",
            "        page = get_object_or_404(Page, pk=page_id)",
            "        if page.has_change_permission(request):",
            "            page.toggle_in_navigation()",
            "            language = request.GET.get('language') or get_language_from_request(request)",
            "            return admin_utils.render_admin_menu_item(request, page, language=language)",
            "        return HttpResponseForbidden(force_unicode(_(\"You do not have permission to change this page's in_navigation status\")))",
            "",
            "    def descendants(self, request, page_id, language):",
            "        \"\"\"",
            "        Get html for descendants of given page",
            "        Used for lazy loading pages in cms.changelist.js",
            "",
            "        Permission checks is done in admin_utils.get_admin_menu_item_context",
            "        which is called by admin_utils.render_admin_menu_item.",
            "        \"\"\"",
            "        page = get_object_or_404(Page, pk=page_id)",
            "        return admin_utils.render_admin_menu_item(request, page,",
            "                                                  template=\"admin/cms/page/tree/lazy_menu.html\", language=language)",
            "",
            "    def add_page_type(self, request):",
            "        site = Site.objects.get_current()",
            "        language = request.GET.get('language') or get_language()",
            "        target = request.GET.get('copy_target')",
            "",
            "        type_root, created = Page.objects.get_or_create(reverse_id=PAGE_TYPES_ID, publisher_is_draft=True, site=site,",
            "                                                        defaults={'in_navigation': False})",
            "        type_title, created = Title.objects.get_or_create(page=type_root, language=language, slug=PAGE_TYPES_ID,",
            "                                                          defaults={'title': _('Page Types')})",
            "",
            "        url = add_url_parameters(admin_reverse('cms_page_add'), target=type_root.pk, position='first-child',",
            "                                 add_page_type=1, copy_target=target, language=language)",
            "",
            "        return HttpResponseRedirect(url)",
            "",
            "    def resolve(self, request):",
            "        if not request.user.is_staff:",
            "            if DJANGO_1_4:",
            "                return HttpResponse('/', mimetype='text/plain')",
            "            else:",
            "                return HttpResponse('/', content_type='text/plain')",
            "        obj = False",
            "        url = False",
            "        if request.session.get('cms_log_latest', False):",
            "            log = LogEntry.objects.get(pk=request.session['cms_log_latest'])",
            "            try:",
            "                obj = log.get_edited_object()",
            "            except (ObjectDoesNotExist, ValueError):",
            "                obj = None",
            "            del request.session['cms_log_latest']",
            "            if obj and obj.__class__ in toolbar_pool.get_watch_models() and hasattr(obj, 'get_absolute_url'):",
            "                # This is a test if the object url can be retrieved",
            "                # In case it can't, object it's not taken into account",
            "                try:",
            "                    force_unicode(obj.get_absolute_url())",
            "                except:",
            "                    obj = None",
            "            else:",
            "                obj = None",
            "        if not obj:",
            "            pk = request.REQUEST.get('pk')",
            "            full_model = request.REQUEST.get('model')",
            "            if pk and full_model:",
            "                app_label, model = full_model.split('.')",
            "                if pk and app_label:",
            "                    ctype = ContentType.objects.get(app_label=app_label, model=model)",
            "                    try:",
            "                        obj = ctype.get_object_for_this_type(pk=pk)",
            "                    except ctype.model_class().DoesNotExist:",
            "                        obj = None",
            "                    try:",
            "                        force_unicode(obj.get_absolute_url())",
            "                    except:",
            "                        obj = None",
            "        if obj:",
            "            if not request.toolbar or not request.toolbar.edit_mode:",
            "                if isinstance(obj, Page):",
            "                    if obj.get_public_object():",
            "                        url = obj.get_public_object().get_absolute_url()",
            "                    else:",
            "                        url = '%s?%s' % (",
            "                            obj.get_draft_object().get_absolute_url(),",
            "                            get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')",
            "                        )",
            "                else:",
            "                    url = obj.get_absolute_url()",
            "            else:",
            "                url = obj.get_absolute_url()",
            "        if url:",
            "            return HttpResponse(force_unicode(url), content_type='text/plain')",
            "        return HttpResponse('', content_type='text/plain')",
            "",
            "    def lookup_allowed(self, key, *args, **kwargs):",
            "        if key == 'site__exact':",
            "            return True",
            "        return super(PageAdmin, self).lookup_allowed(key, *args, **kwargs)",
            "",
            "    def edit_title_fields(self, request, page_id, language):",
            "        title = Title.objects.get(page_id=page_id, language=language)",
            "        saved_successfully = False",
            "        raw_fields = request.GET.get(\"edit_fields\", 'title')",
            "        edit_fields = [field for field in raw_fields.split(\",\") if field in self.title_frontend_editable_fields]",
            "        cancel_clicked = request.POST.get(\"_cancel\", False)",
            "        opts = Title._meta",
            "",
            "        if not edit_fields:",
            "            # Defaults to title",
            "            edit_fields = ('title',)",
            "",
            "        if not has_generic_permission(title.page.pk, request.user, \"change\",",
            "                                      title.page.site.pk):",
            "            return HttpResponseForbidden(force_unicode(_(\"You do not have permission to edit this page\")))",
            "",
            "        class PageTitleForm(django.forms.ModelForm):",
            "            \"\"\"",
            "            Dynamic form showing only the fields to be edited",
            "            \"\"\"",
            "            class Meta:",
            "                model = Title",
            "                fields = edit_fields",
            "",
            "        if not cancel_clicked and request.method == 'POST':",
            "            form = PageTitleForm(instance=title, data=request.POST)",
            "            if form.is_valid():",
            "                form.save()",
            "                saved_successfully = True",
            "        else:",
            "            form = PageTitleForm(instance=title)",
            "        admin_form = AdminForm(form, fieldsets=[(None, {'fields': edit_fields})], prepopulated_fields={},",
            "                               model_admin=self)",
            "        media = self.media + admin_form.media",
            "        context = {",
            "            'CMS_MEDIA_URL': get_cms_setting('MEDIA_URL'),",
            "            'title': 'Title',",
            "            'plugin': title.page,",
            "            'plugin_id': title.page.id,",
            "            'adminform': admin_form,",
            "            'add': False,",
            "            'is_popup': True,",
            "            'media': media,",
            "            'opts': opts,",
            "            'change': True,",
            "            'save_as': False,",
            "            'has_add_permission': False,",
            "            'window_close_timeout': 10,",
            "        }",
            "        if cancel_clicked:",
            "            # cancel button was clicked",
            "            context.update({",
            "                'cancel': True,",
            "            })",
            "            return render_to_response('admin/cms/page/plugin/confirm_form.html', context, RequestContext(request))",
            "        if not cancel_clicked and request.method == 'POST' and saved_successfully:",
            "            return render_to_response('admin/cms/page/plugin/confirm_form.html', context, RequestContext(request))",
            "        return render_to_response('admin/cms/page/plugin/change_form.html', context, RequestContext(request))",
            "",
            "    def get_published_pagelist(self, *args, **kwargs):",
            "        \"\"\"",
            "         This view is used by the PageSmartLinkWidget as the user type to feed the autocomplete drop-down.",
            "        \"\"\"",
            "        request = args[0]",
            "",
            "        if request.is_ajax():",
            "            query_term = request.GET.get('q','').strip('/')",
            "",
            "            language_code = request.GET.get('language_code', settings.LANGUAGE_CODE)",
            "            matching_published_pages = Page.objects.published().public().filter(",
            "                Q(title_set__title__icontains=query_term, title_set__language=language_code)",
            "                | Q(title_set__path__icontains=query_term, title_set__language=language_code)",
            "                | Q(title_set__menu_title__icontains=query_term, title_set__language=language_code)",
            "                | Q(title_set__page_title__icontains=query_term, title_set__language=language_code)",
            "            ).distinct()",
            "",
            "            results = []",
            "            for page in matching_published_pages:",
            "                results.append(",
            "                    {",
            "                        'path': page.get_path(language=language_code),",
            "                        'title': page.get_title(language=language_code),",
            "                        'redirect_url': page.get_absolute_url(language=language_code)",
            "                    }",
            "                )",
            "",
            "            if DJANGO_1_4:",
            "                return HttpResponse(json.dumps(results), mimetype='application/json')",
            "            else:",
            "                return HttpResponse(json.dumps(results), content_type='application/json')",
            "",
            "        else:",
            "            return HttpResponseForbidden()",
            "",
            "    def add_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).add_plugin(*args, **kwargs)",
            "",
            "    def copy_plugins(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).copy_plugins(*args, **kwargs)",
            "",
            "    def edit_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).edit_plugin(*args, **kwargs)",
            "",
            "    def move_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).move_plugin(*args, **kwargs)",
            "",
            "    def delete_plugin(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).delete_plugin(*args, **kwargs)",
            "",
            "    def clear_placeholder(self, *args, **kwargs):",
            "        with create_revision():",
            "            return super(PageAdmin, self).clear_placeholder(*args, **kwargs)",
            "",
            "",
            "",
            "admin.site.register(Page, PageAdmin)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "cms.admin.pageadmin.PageAdmin.add_general_fields",
            "cms.admin.pageadmin.PageAdmin.list_filter",
            "cms.admin.pageadmin.PageAdmin.self",
            "cms.admin.pageadmin.PageAdmin.title_frontend_editable_fields"
        ]
    },
    "cms/tests/admin.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 704,
                "afterPatchRowNumber": 704,
                "PatchRowcode": "         with self.login_user_context(permless):"
            },
            "1": {
                "beforePatchRowNumber": 705,
                "afterPatchRowNumber": 705,
                "PatchRowcode": "             request = self.get_request()"
            },
            "2": {
                "beforePatchRowNumber": 706,
                "afterPatchRowNumber": 706,
                "PatchRowcode": "             response = self.admin_class.publish_page(request, page.pk, \"en\")"
            },
            "3": {
                "beforePatchRowNumber": 707,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            self.assertEqual(response.status_code, 403)"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 707,
                "PatchRowcode": "+            self.assertEqual(response.status_code, 405)"
            },
            "5": {
                "beforePatchRowNumber": 708,
                "afterPatchRowNumber": 708,
                "PatchRowcode": "             page = self.reload(page)"
            },
            "6": {
                "beforePatchRowNumber": 709,
                "afterPatchRowNumber": 709,
                "PatchRowcode": "             self.assertFalse(page.is_published('en'))"
            },
            "7": {
                "beforePatchRowNumber": 710,
                "afterPatchRowNumber": 710,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 711,
                "afterPatchRowNumber": 711,
                "PatchRowcode": "             request = self.get_request(post_data={'no': 'data'})"
            },
            "9": {
                "beforePatchRowNumber": 712,
                "afterPatchRowNumber": 712,
                "PatchRowcode": "             response = self.admin_class.publish_page(request, page.pk, \"en\")"
            },
            "10": {
                "beforePatchRowNumber": 713,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            # Forbidden"
            },
            "11": {
                "beforePatchRowNumber": 714,
                "afterPatchRowNumber": 713,
                "PatchRowcode": "             self.assertEqual(response.status_code, 403)"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 714,
                "PatchRowcode": "+            page = self.reload(page)"
            },
            "13": {
                "beforePatchRowNumber": 715,
                "afterPatchRowNumber": 715,
                "PatchRowcode": "             self.assertFalse(page.is_published('en'))"
            },
            "14": {
                "beforePatchRowNumber": 716,
                "afterPatchRowNumber": 716,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 717,
                "afterPatchRowNumber": 717,
                "PatchRowcode": "         admin_user = self.get_admin()"
            },
            "16": {
                "beforePatchRowNumber": 747,
                "afterPatchRowNumber": 747,
                "PatchRowcode": "         with self.login_user_context(permless):"
            },
            "17": {
                "beforePatchRowNumber": 748,
                "afterPatchRowNumber": 748,
                "PatchRowcode": "             request = self.get_request()"
            },
            "18": {
                "beforePatchRowNumber": 749,
                "afterPatchRowNumber": 749,
                "PatchRowcode": "             response = self.admin_class.change_innavigation(request, page.pk)"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 750,
                "PatchRowcode": "+            self.assertEqual(response.status_code, 405)"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 751,
                "PatchRowcode": "+        with self.login_user_context(permless):"
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 752,
                "PatchRowcode": "+            request = self.get_request(post_data={'no': 'data'})"
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 753,
                "PatchRowcode": "+            response = self.admin_class.change_innavigation(request, page.pk)"
            },
            "23": {
                "beforePatchRowNumber": 750,
                "afterPatchRowNumber": 754,
                "PatchRowcode": "             self.assertEqual(response.status_code, 403)"
            },
            "24": {
                "beforePatchRowNumber": 751,
                "afterPatchRowNumber": 755,
                "PatchRowcode": "         with self.login_user_context(permless):"
            },
            "25": {
                "beforePatchRowNumber": 752,
                "afterPatchRowNumber": 756,
                "PatchRowcode": "             request = self.get_request(post_data={'no': 'data'})"
            },
            "26": {
                "beforePatchRowNumber": 806,
                "afterPatchRowNumber": 810,
                "PatchRowcode": "         admin_user = self.get_admin()"
            },
            "27": {
                "beforePatchRowNumber": 807,
                "afterPatchRowNumber": 811,
                "PatchRowcode": "         self.page.publish(\"en\")  # Ensure public copy exists before reverting"
            },
            "28": {
                "beforePatchRowNumber": 808,
                "afterPatchRowNumber": 812,
                "PatchRowcode": "         with self.login_user_context(admin_user):"
            },
            "29": {
                "beforePatchRowNumber": 809,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            response = self.client.get(admin_reverse('cms_page_revert_page', args=(self.page.pk, 'en')))"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 813,
                "PatchRowcode": "+            response = self.client.post(admin_reverse('cms_page_revert_page', args=(self.page.pk, 'en')))"
            },
            "31": {
                "beforePatchRowNumber": 810,
                "afterPatchRowNumber": 814,
                "PatchRowcode": "             self.assertEqual(response.status_code, 302)"
            },
            "32": {
                "beforePatchRowNumber": 811,
                "afterPatchRowNumber": 815,
                "PatchRowcode": "             url = response['Location']"
            },
            "33": {
                "beforePatchRowNumber": 812,
                "afterPatchRowNumber": 816,
                "PatchRowcode": "             self.assertTrue(url.endswith('?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF')))"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from __future__ import with_statement",
            "import json",
            "import datetime",
            "from cms.utils.urlutils import admin_reverse",
            "",
            "from djangocms_text_ckeditor.cms_plugins import TextPlugin",
            "from djangocms_text_ckeditor.models import Text",
            "from django.contrib import admin",
            "from django.contrib.admin.models import LogEntry",
            "from django.contrib.admin.sites import site",
            "from django.contrib.auth.models import Permission, AnonymousUser",
            "from django.contrib.sites.models import Site",
            "from django.core.urlresolvers import reverse",
            "from django.http import (Http404, HttpResponseBadRequest, HttpResponseForbidden, HttpResponse,",
            "                         QueryDict, HttpResponseNotFound)",
            "from django.utils.datastructures import MultiValueDictKeyError",
            "from django.utils.encoding import smart_str",
            "from django.utils import timezone",
            "from django.utils.six.moves.urllib.parse import urlparse",
            "",
            "from cms.admin.change_list import CMSChangeList",
            "from cms.admin.forms import PageForm, AdvancedSettingsForm",
            "from cms.admin.pageadmin import PageAdmin",
            "from cms.admin.permissionadmin import PagePermissionInlineAdmin",
            "from cms.api import create_page, create_title, add_plugin, assign_user_to_page, publish_page",
            "from cms.constants import PLUGIN_MOVE_ACTION",
            "from cms.models import UserSettings, StaticPlaceholder",
            "from cms.models.pagemodel import Page",
            "from cms.models.permissionmodels import GlobalPagePermission, PagePermission",
            "from cms.models.placeholdermodel import Placeholder",
            "from cms.models.pluginmodel import CMSPlugin",
            "from cms.models.titlemodels import Title",
            "from cms.test_utils import testcases as base",
            "from cms.test_utils.testcases import CMSTestCase, URL_CMS_PAGE_DELETE, URL_CMS_PAGE, URL_CMS_TRANSLATION_DELETE",
            "from cms.test_utils.util.context_managers import SettingsOverride",
            "from cms.test_utils.util.fuzzy_int import FuzzyInt",
            "from cms.utils import get_cms_setting",
            "from cms.utils.compat import DJANGO_1_4, DJANGO_1_6",
            "from cms.utils.compat.dj import get_user_model, force_unicode",
            "",
            "",
            "class AdminTestsBase(CMSTestCase):",
            "    @property",
            "    def admin_class(self):",
            "        return site._registry[Page]",
            "",
            "    def _get_guys(self, admin_only=False, use_global_permissions=True):",
            "        admiN_user = self.get_superuser()",
            "        if admin_only:",
            "            return admiN_user",
            "        USERNAME = 'test'",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            normal_guy = get_user_model().objects.create_user(USERNAME, 'test@test.com', 'test@test.com')",
            "        else:",
            "            normal_guy = get_user_model().objects.create_user(USERNAME, 'test@test.com', USERNAME)",
            "",
            "        normal_guy.is_staff = True",
            "        normal_guy.is_active = True",
            "        normal_guy.save()",
            "        normal_guy.user_permissions = Permission.objects.filter(",
            "            codename__in=['change_page', 'change_title', 'add_page', 'add_title', 'delete_page', 'delete_title']",
            "        )",
            "        if use_global_permissions:",
            "            gpp = GlobalPagePermission.objects.create(",
            "                user=normal_guy,",
            "                can_change=True,",
            "                can_delete=True,",
            "                can_change_advanced_settings=False,",
            "                can_publish=True,",
            "                can_change_permissions=False,",
            "                can_move_page=True,",
            "            )",
            "            gpp.sites = Site.objects.all()",
            "        return admiN_user, normal_guy",
            "",
            "",
            "class AdminTestCase(AdminTestsBase):",
            "",
            "    def test_extension_not_in_admin(self):",
            "        admin_user, staff = self._get_guys()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request('/admin/cms/page/1/', 'en',)",
            "            response = site.index(request)",
            "            self.assertNotContains(response, '/mytitleextension/')",
            "            self.assertNotContains(response, '/mypageextension/')",
            "",
            "    def test_permissioned_page_list(self):",
            "        \"\"\"",
            "        Makes sure that a user with restricted page permissions can view",
            "        the page list.",
            "        \"\"\"",
            "        admin_user, normal_guy = self._get_guys(use_global_permissions=False)",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "        page = create_page(\"Test page\", \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "",
            "        PagePermission.objects.create(page=page, user=normal_guy)",
            "",
            "        with self.login_user_context(normal_guy):",
            "            resp = self.client.get(URL_CMS_PAGE)",
            "            self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_edit_does_not_reset_page_adv_fields(self):",
            "        \"\"\"",
            "        Makes sure that if a non-superuser with no rights to edit advanced page",
            "        fields edits a page, those advanced fields are not touched.",
            "        \"\"\"",
            "        OLD_PAGE_NAME = 'Test Page'",
            "        NEW_PAGE_NAME = 'Test page 2'",
            "        REVERSE_ID = 'Test'",
            "        OVERRIDE_URL = 'my/override/url'",
            "",
            "        admin_user, normal_guy = self._get_guys()",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "",
            "        # The admin creates the page",
            "        page = create_page(OLD_PAGE_NAME, \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "        page.reverse_id = REVERSE_ID",
            "        page.save()",
            "        title = page.get_title_obj()",
            "        title.has_url_overwrite = True",
            "        title.path = OVERRIDE_URL",
            "        title.save()",
            "",
            "        self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "        self.assertEqual(page.reverse_id, REVERSE_ID)",
            "        self.assertEqual(title.overwrite_url, OVERRIDE_URL)",
            "",
            "        # The user edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': NEW_PAGE_NAME,",
            "            'slug': page.get_slug(),",
            "            'language': title.language,",
            "            'site': page.site.pk,",
            "            'template': page.template,",
            "            'pagepermission_set-TOTAL_FORMS': 0,",
            "            'pagepermission_set-INITIAL_FORMS': 0,",
            "            'pagepermission_set-MAX_NUM_FORMS': 0,",
            "            'pagepermission_set-2-TOTAL_FORMS': 0,",
            "            'pagepermission_set-2-INITIAL_FORMS': 0,",
            "            'pagepermission_set-2-MAX_NUM_FORMS': 0",
            "        }",
            "        # required only if user haves can_change_permission",
            "        with self.login_user_context(normal_guy):",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "",
            "            self.assertEqual(page.get_title(), NEW_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            title = page.get_title_obj()",
            "            self.assertEqual(title.overwrite_url, OVERRIDE_URL)",
            "",
            "        # The admin edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': OLD_PAGE_NAME,",
            "            'slug': page.get_slug(),",
            "            'language': title.language,",
            "            'site': page.site.pk,",
            "            'template': page.template,",
            "            'reverse_id': page.reverse_id,",
            "            'pagepermission_set-TOTAL_FORMS': 0,  # required only if user haves can_change_permission",
            "            'pagepermission_set-INITIAL_FORMS': 0,",
            "            'pagepermission_set-MAX_NUM_FORMS': 0,",
            "            'pagepermission_set-2-TOTAL_FORMS': 0,",
            "            'pagepermission_set-2-INITIAL_FORMS': 0,",
            "            'pagepermission_set-2-MAX_NUM_FORMS': 0",
            "        }",
            "        with self.login_user_context(admin_user):",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "",
            "            self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            title = page.get_title_obj()",
            "            self.assertEqual(title.overwrite_url, OVERRIDE_URL)",
            "",
            "    def test_edit_does_not_reset_apphook(self):",
            "        \"\"\"",
            "        Makes sure that if a non-superuser with no rights to edit advanced page",
            "        fields edits a page, those advanced fields are not touched.",
            "        \"\"\"",
            "        OLD_PAGE_NAME = 'Test Page'",
            "        NEW_PAGE_NAME = 'Test page 2'",
            "        REVERSE_ID = 'Test'",
            "        APPLICATION_URLS = 'project.sampleapp.urls'",
            "",
            "        admin_user, normal_guy = self._get_guys()",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "",
            "        # The admin creates the page",
            "        page = create_page(OLD_PAGE_NAME, \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "        page.reverse_id = REVERSE_ID",
            "        page.save()",
            "        title = page.get_title_obj()",
            "        title.has_url_overwrite = True",
            "",
            "        title.save()",
            "        page.application_urls = APPLICATION_URLS",
            "        page.save()",
            "        self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "        self.assertEqual(page.reverse_id, REVERSE_ID)",
            "        self.assertEqual(page.application_urls, APPLICATION_URLS)",
            "",
            "        # The user edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': NEW_PAGE_NAME,",
            "            'slug': page.get_slug(),",
            "            'language': title.language,",
            "            'site': page.site.pk,",
            "            'template': page.template,",
            "            'pagepermission_set-TOTAL_FORMS': 0,",
            "            'pagepermission_set-INITIAL_FORMS': 0,",
            "            'pagepermission_set-MAX_NUM_FORMS': 0,",
            "            'pagepermission_set-2-TOTAL_FORMS': 0,",
            "            'pagepermission_set-2-INITIAL_FORMS': 0,",
            "            'pagepermission_set-2-MAX_NUM_FORMS': 0,",
            "        }",
            "",
            "        with self.login_user_context(normal_guy):",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "            self.assertEqual(page.get_title(), NEW_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            self.assertEqual(page.application_urls, APPLICATION_URLS)",
            "            title = page.get_title_obj()",
            "            # The admin edits the page (change the page name for ex.)",
            "            page_data = {",
            "                'title': OLD_PAGE_NAME,",
            "                'slug': page.get_slug(),",
            "                'language': title.language,",
            "                'site': page.site.pk,",
            "                'template': page.template,",
            "                'reverse_id': page.reverse_id,",
            "            }",
            "",
            "        with self.login_user_context(admin_user):",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "",
            "            self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            self.assertEqual(page.application_urls, '')",
            "",
            "    def test_2apphooks_with_same_namespace(self):",
            "        PAGE1 = 'Test Page'",
            "        PAGE2 = 'Test page 2'",
            "        APPLICATION_URLS = 'project.sampleapp.urls'",
            "",
            "        admin_user, normal_guy = self._get_guys()",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "",
            "        # The admin creates the page",
            "        page = create_page(PAGE1, \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "        page2 = create_page(PAGE2, \"nav_playground.html\", \"en\",",
            "                            site=current_site, created_by=admin_user)",
            "",
            "        page.application_urls = APPLICATION_URLS",
            "        page.application_namespace = \"space1\"",
            "        page.save()",
            "        page2.application_urls = APPLICATION_URLS",
            "        page2.save()",
            "",
            "        # The admin edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': PAGE2,",
            "            'slug': page2.get_slug(),",
            "            'language': 'en',",
            "            'site': page.site.pk,",
            "            'template': page2.template,",
            "            'application_urls': 'SampleApp',",
            "            'application_namespace': 'space1',",
            "        }",
            "",
            "        with self.login_user_context(admin_user):",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page.pk, page_data)",
            "            self.assertEqual(resp.status_code, 302)",
            "            self.assertEqual(Page.objects.filter(application_namespace=\"space1\").count(), 1)",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page2.pk, page_data)",
            "            self.assertEqual(resp.status_code, 200)",
            "            page_data['application_namespace'] = 'space2'",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page2.pk, page_data)",
            "            self.assertEqual(resp.status_code, 302)",
            "",
            "    def test_delete(self):",
            "        admin_user = self.get_superuser()",
            "        create_page(\"home\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        page = create_page(\"delete-page\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        create_page('child-page', \"nav_playground.html\", \"en\",",
            "                    created_by=admin_user, published=True, parent=page)",
            "        body = page.placeholders.get(slot='body')",
            "        add_plugin(body, 'TextPlugin', 'en', body='text')",
            "        page.publish('en')",
            "        with self.login_user_context(admin_user):",
            "            data = {'post': 'yes'}",
            "            with self.assertNumQueries(FuzzyInt(300, 407)):",
            "                response = self.client.post(URL_CMS_PAGE_DELETE % page.pk, data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "    def test_delete_diff_language(self):",
            "        admin_user = self.get_superuser()",
            "        create_page(\"home\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        page = create_page(\"delete-page\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        create_page('child-page', \"nav_playground.html\", \"de\",",
            "                    created_by=admin_user, published=True, parent=page)",
            "        body = page.placeholders.get(slot='body')",
            "        add_plugin(body, 'TextPlugin', 'en', body='text')",
            "        page.publish('en')",
            "        with self.login_user_context(admin_user):",
            "            data = {'post': 'yes'}",
            "            with self.assertNumQueries(FuzzyInt(300, 394)):",
            "                response = self.client.post(URL_CMS_PAGE_DELETE % page.pk, data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "    def test_search_fields(self):",
            "        superuser = self.get_superuser()",
            "        from django.contrib.admin import site",
            "",
            "        with self.login_user_context(superuser):",
            "            for model, admin_instance in site._registry.items():",
            "                if model._meta.app_label != 'cms':",
            "                    continue",
            "                if not admin_instance.search_fields:",
            "                    continue",
            "                url = admin_reverse('cms_%s_changelist' % model._meta.module_name)",
            "                response = self.client.get('%s?q=1' % url)",
            "                errmsg = response.content",
            "                self.assertEqual(response.status_code, 200, errmsg)",
            "",
            "    def test_delete_translation(self):",
            "        admin_user = self.get_superuser()",
            "        page = create_page(\"delete-page-translation\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        create_title(\"de\", \"delete-page-translation-2\", page, slug=\"delete-page-translation-2\")",
            "        create_title(\"es-mx\", \"delete-page-translation-es\", page, slug=\"delete-page-translation-es\")",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.get(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'de'})",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'de'})",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "            response = self.client.get(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'es-mx'})",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'es-mx'})",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "    def test_change_dates(self):",
            "        admin_user, staff = self._get_guys()",
            "        page = create_page('test-page', 'nav_playground.html', 'en')",
            "        page.publish('en')",
            "        draft = page.get_draft_object()",
            "",
            "        with self.settings(USE_TZ=False):",
            "            original_date = draft.publication_date",
            "            original_end_date = draft.publication_end_date",
            "            new_date = timezone.now() - datetime.timedelta(days=1)",
            "            new_end_date = timezone.now() + datetime.timedelta(days=1)",
            "            url = admin_reverse('cms_page_dates', args=(draft.pk,))",
            "            with self.login_user_context(admin_user):",
            "                response = self.client.post(url, {",
            "                    'language': 'en',",
            "                    'site': draft.site.pk,",
            "                    'publication_date_0': new_date.date(),",
            "                    'publication_date_1': new_date.strftime(\"%H:%M:%S\"),",
            "                    'publication_end_date_0': new_end_date.date(),",
            "                    'publication_end_date_1': new_end_date.strftime(\"%H:%M:%S\"),",
            "                })",
            "                self.assertEqual(response.status_code, 302)",
            "                draft = Page.objects.get(pk=draft.pk)",
            "                self.assertNotEqual(draft.publication_date.timetuple(), original_date.timetuple())",
            "                self.assertEqual(draft.publication_date.timetuple(), new_date.timetuple())",
            "                self.assertEqual(draft.publication_end_date.timetuple(), new_end_date.timetuple())",
            "                if original_end_date:",
            "                    self.assertNotEqual(draft.publication_end_date.timetuple(), original_end_date.timetuple())",
            "",
            "        with self.settings(USE_TZ=True):",
            "            original_date = draft.publication_date",
            "            original_end_date = draft.publication_end_date",
            "            new_date = timezone.localtime(timezone.now()) - datetime.timedelta(days=1)",
            "            new_end_date = timezone.localtime(timezone.now()) + datetime.timedelta(days=1)",
            "            url = admin_reverse('cms_page_dates', args=(draft.pk,))",
            "            with self.login_user_context(admin_user):",
            "                response = self.client.post(url, {",
            "                    'language': 'en',",
            "                    'site': draft.site.pk,",
            "                    'publication_date_0': new_date.date(),",
            "                    'publication_date_1': new_date.strftime(\"%H:%M:%S\"),",
            "                    'publication_end_date_0': new_end_date.date(),",
            "                    'publication_end_date_1': new_end_date.strftime(\"%H:%M:%S\"),",
            "                })",
            "                self.assertEqual(response.status_code, 302)",
            "                draft = Page.objects.get(pk=draft.pk)",
            "                self.assertNotEqual(draft.publication_date.timetuple(), original_date.timetuple())",
            "                self.assertEqual(timezone.localtime(draft.publication_date).timetuple(), new_date.timetuple())",
            "                self.assertEqual(timezone.localtime(draft.publication_end_date).timetuple(), new_end_date.timetuple())",
            "                if original_end_date:",
            "                    self.assertNotEqual(draft.publication_end_date.timetuple(), original_end_date.timetuple())",
            "",
            "    def test_change_template(self):",
            "        admin_user, staff = self._get_guys()",
            "        request = self.get_request('/admin/cms/page/1/', 'en')",
            "        request.method = \"POST\"",
            "        pageadmin = site._registry[Page]",
            "        with self.login_user_context(staff):",
            "            self.assertRaises(Http404, pageadmin.change_template, request, 1)",
            "            page = create_page('test-page', 'nav_playground.html', 'en')",
            "            response = pageadmin.change_template(request, page.pk)",
            "            self.assertEqual(response.status_code, 403)",
            "        url = admin_reverse('cms_page_change_template', args=(page.pk,))",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.post(url, {'template': 'doesntexist'})",
            "            self.assertEqual(response.status_code, 400)",
            "            response = self.client.post(url, {'template': get_cms_setting('TEMPLATES')[0][0]})",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "    def test_get_permissions(self):",
            "        page = create_page('test-page', 'nav_playground.html', 'en')",
            "        url = admin_reverse('cms_page_get_permissions', args=(page.pk,))",
            "        response = self.client.get(url)",
            "        if DJANGO_1_6:",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertTemplateUsed(response, 'admin/login.html')",
            "        else:",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertRedirects(response, '/en/admin/login/?next=/en/admin/cms/page/%s/permissions/' % page.pk)",
            "        admin_user = self.get_superuser()",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.get(url)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertTemplateNotUsed(response, 'admin/login.html')",
            "",
            "    def test_changelist_items(self):",
            "        admin_user = self.get_superuser()",
            "        first_level_page = create_page('level1', 'nav_playground.html', 'en')",
            "        second_level_page_top = create_page('level21', \"nav_playground.html\", \"en\",",
            "                                            created_by=admin_user, published=True, parent=first_level_page)",
            "        second_level_page_bottom = create_page('level22', \"nav_playground.html\", \"en\",",
            "                                               created_by=admin_user, published=True,",
            "                                               parent=self.reload(first_level_page))",
            "        third_level_page = create_page('level3', \"nav_playground.html\", \"en\",",
            "                                       created_by=admin_user, published=True, parent=second_level_page_top)",
            "        self.assertEqual(Page.objects.all().count(), 4)",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "        request = self.get_request(url)",
            "",
            "        request.session = {}",
            "        request.user = admin_user",
            "",
            "        page_admin = site._registry[Page]",
            "",
            "        cl_params = [request, page_admin.model, page_admin.list_display,",
            "            page_admin.list_display_links, page_admin.list_filter,",
            "            page_admin.date_hierarchy, page_admin.search_fields,",
            "            page_admin.list_select_related, page_admin.list_per_page]",
            "        if hasattr(page_admin, 'list_max_show_all'):  # django 1.4",
            "            cl_params.append(page_admin.list_max_show_all)",
            "        cl_params.extend([page_admin.list_editable, page_admin])",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "",
            "        cl.set_items(request)",
            "",
            "        root_page = cl.get_items()[0]",
            "",
            "        self.assertEqual(root_page, first_level_page)",
            "        self.assertEqual(root_page.get_children()[0], second_level_page_top)",
            "        self.assertEqual(root_page.get_children()[1], second_level_page_bottom)",
            "        self.assertEqual(root_page.get_children()[0].get_children()[0], third_level_page)",
            "",
            "    def test_changelist_get_results(self):",
            "        admin_user = self.get_superuser()",
            "        first_level_page = create_page('level1', 'nav_playground.html', 'en', published=True)",
            "        second_level_page_top = create_page('level21', \"nav_playground.html\", \"en\",",
            "                                            created_by=admin_user, published=True,",
            "                                            parent=first_level_page)",
            "        second_level_page_bottom = create_page('level22', \"nav_playground.html\", \"en\", # nopyflakes",
            "                                               created_by=admin_user, published=True,",
            "                                               parent=self.reload(first_level_page))",
            "        third_level_page = create_page('level3', \"nav_playground.html\", \"en\", # nopyflakes",
            "                                       created_by=admin_user, published=True,",
            "                                       parent=second_level_page_top)",
            "        fourth_level_page = create_page('level23', \"nav_playground.html\", \"en\", # nopyflakes",
            "                                        created_by=admin_user,",
            "                                        parent=self.reload(first_level_page))",
            "        self.assertEqual(Page.objects.all().count(), 9)",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "",
            "        request = self.get_request(url)",
            "        request.session = {}",
            "        request.user = admin_user",
            "",
            "        page_admin = site._registry[Page]",
            "",
            "        # full blown page list. only draft pages are taken into account",
            "        cl_params = [request, page_admin.model, page_admin.list_display,",
            "            page_admin.list_display_links, page_admin.list_filter,",
            "            page_admin.date_hierarchy, page_admin.search_fields,",
            "            page_admin.list_select_related, page_admin.list_per_page]",
            "        if hasattr(page_admin, 'list_max_show_all'):  # django 1.4",
            "            cl_params.append(page_admin.list_max_show_all)",
            "        cl_params.extend([page_admin.list_editable, page_admin])",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "        cl.get_results(request)",
            "        self.assertEqual(cl.full_result_count, 5)",
            "        self.assertEqual(cl.result_count, 5)",
            "",
            "        # only one unpublished page is returned",
            "        request = self.get_request(url+'?q=level23')",
            "        request.session = {}",
            "        request.user = admin_user",
            "        cl_params[0] = request",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "        cl.get_results(request)",
            "        self.assertEqual(cl.full_result_count, 5)",
            "        self.assertEqual(cl.result_count, 1)",
            "",
            "        # a number of pages matches the query",
            "        request = self.get_request(url+'?q=level2')",
            "        request.session = {}",
            "        request.user = admin_user",
            "        cl_params[0] = request",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "        cl.get_results(request)",
            "        self.assertEqual(cl.full_result_count, 5)",
            "        self.assertEqual(cl.result_count, 3)",
            "",
            "    def test_changelist_tree(self):",
            "        \"\"\" This test checks for proper jstree cookie unquoting.",
            "",
            "        It should be converted to a selenium test to actually test the jstree behaviour.",
            "        Cookie set below is just a forged example (from live session)",
            "        \"\"\"",
            "        admin_user = self.get_superuser()",
            "        first_level_page = create_page('level1', 'nav_playground.html', 'en')",
            "        second_level_page_top = create_page('level21', \"nav_playground.html\", \"en\",",
            "                                            created_by=admin_user, published=True, parent=first_level_page)",
            "        second_level_page_bottom = create_page('level22', \"nav_playground.html\", \"en\",",
            "                                               created_by=admin_user, published=True,",
            "                                               parent=self.reload(first_level_page))",
            "        third_level_page = create_page('level3', \"nav_playground.html\", \"en\",",
            "                                       created_by=admin_user, published=True, parent=second_level_page_top)",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin@django-cms.org')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        self.client.cookies['djangocms_nodes_open'] = 'page_1%2Cpage_2'",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.context[\"open_menu_trees\"], [1, 2])",
            "        # tests descendants method for the lazy load ajax call",
            "        url = \"%s%d/en/descendants/\" % (url, first_level_page.pk)",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        # should include both direct descendant pages",
            "        self.assertContains(response, 'id=\"page_%s\"' % second_level_page_top.pk)",
            "        self.assertContains(response, 'id=\"page_%s\"' % second_level_page_bottom.pk)",
            "        # but not any further down the tree",
            "        self.assertNotContains(response, 'id=\"page_%s\"' % third_level_page.pk)",
            "        self.assertNotContains(response, 'None')",
            "",
            "    def test_unihandecode_doesnt_break_404_in_admin(self):",
            "        self.get_superuser()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin@django-cms.org')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        response = self.client.get('/en/admin/cms/page/1/?language=en')",
            "        self.assertEqual(response.status_code, 404)",
            "",
            "    def test_tree_displays_in_correct_language(self):",
            "        '''",
            "        Test to prove and protect that the page titles in the tree are",
            "        displayed in the currently set language.",
            "        '''",
            "        admin_guy, normal_guy = self._get_guys(use_global_permissions=False)",
            "        site = Site.objects.get(pk=1)",
            "",
            "        en_title = \"EN Page\"",
            "        es_title = \"ES Pagina\"",
            "",
            "        # Create a page in en",
            "        page = create_page(en_title, \"nav_playground.html\", \"en\", site=site, created_by=admin)",
            "        # Add a es-mx translation for this page",
            "        create_title(\"es-mx\", es_title, page, slug=\"es_pagina\")",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "        url_pat = '<a href=\"{0}/{1}/preview/\"[^>]*>{2}</a>'",
            "",
            "        with self.login_user_context(admin_guy):",
            "            # Check the EN version of the tree...",
            "            response = self.client.get(url, {'language': 'en'})",
            "            self.assertRegexpMatches(str(response.content), url_pat.format(page.pk, 'en', en_title, ))",
            "",
            "            # Check the ES version of the tree...",
            "            response = self.client.get(url, {'language': 'es-mx'})",
            "            self.assertRegexpMatches(str(response.content), url_pat.format(page.pk, 'es-mx', es_title, ))",
            "",
            "    def test_empty_placeholder_in_correct_language(self):",
            "        \"\"\"",
            "        Test that Cleaning a placeholder only affect current language contents",
            "        \"\"\"",
            "        # create some objects",
            "        page_en = create_page(\"EmptyPlaceholderTestPage (EN)\", \"nav_playground.html\", \"en\")",
            "        ph = page_en.placeholders.get(slot=\"body\")",
            "",
            "        # add the text plugin to the en version of the page",
            "        add_plugin(ph, \"TextPlugin\", \"en\", body=\"Hello World EN 1\")",
            "        add_plugin(ph, \"TextPlugin\", \"en\", body=\"Hello World EN 2\")",
            "",
            "        # creating a de title of the page and adding plugins to it",
            "        create_title(\"de\", page_en.get_title(), page_en, slug=page_en.get_slug())",
            "        add_plugin(ph, \"TextPlugin\", \"de\", body=\"Hello World DE\")",
            "        add_plugin(ph, \"TextPlugin\", \"de\", body=\"Hello World DE 2\")",
            "        add_plugin(ph, \"TextPlugin\", \"de\", body=\"Hello World DE 3\")",
            "",
            "        # before cleaning the de placeholder",
            "        self.assertEqual(ph.get_plugins('en').count(), 2)",
            "        self.assertEqual(ph.get_plugins('de').count(), 3)",
            "",
            "        admin_user, staff = self._get_guys()",
            "        with self.login_user_context(admin_user):",
            "            url = '%s?language=de' % admin_reverse('cms_page_clear_placeholder', args=[ph.pk])",
            "            response = self.client.post(url, {'test': 0})",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        # After cleaning the de placeholder, en placeholder must still have all the plugins",
            "        self.assertEqual(ph.get_plugins('en').count(), 2)",
            "        self.assertEqual(ph.get_plugins('de').count(), 0)",
            "",
            "",
            "class AdminTests(AdminTestsBase):",
            "    # TODO: needs tests for actual permissions, not only superuser/normaluser",
            "",
            "    def setUp(self):",
            "        self.page = create_page(\"testpage\", \"nav_playground.html\", \"en\")",
            "",
            "    def get_admin(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email=\"admin@django-cms.org\", is_staff=True, is_superuser=True)",
            "",
            "        if (User.USERNAME_FIELD != 'email'):",
            "            fields[User.USERNAME_FIELD] = \"admin\"",
            "",
            "        usr = User(**fields)",
            "        usr.set_password(getattr(usr, User.USERNAME_FIELD))",
            "        usr.save()",
            "        return usr",
            "",
            "    def get_permless(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email=\"permless@django-cms.org\", is_staff=True)",
            "",
            "        if (User.USERNAME_FIELD != 'email'):",
            "            fields[User.USERNAME_FIELD] = \"permless\"",
            "",
            "        usr = User(**fields)",
            "        usr.set_password(getattr(usr, User.USERNAME_FIELD))",
            "        usr.save()",
            "        return usr",
            "",
            "    def get_page(self):",
            "        return self.page",
            "",
            "    def test_change_publish_unpublish(self):",
            "        page = self.get_page()",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 403)",
            "            page = self.reload(page)",
            "            self.assertFalse(page.is_published('en'))",
            "",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            # Forbidden",
            "            self.assertEqual(response.status_code, 403)",
            "            self.assertFalse(page.is_published('en'))",
            "",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "",
            "            page = self.reload(page)",
            "            self.assertTrue(page.is_published('en'))",
            "",
            "            response = self.admin_class.unpublish(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "",
            "            page = self.reload(page)",
            "            self.assertFalse(page.is_published('en'))",
            "",
            "    def test_change_status_adds_log_entry(self):",
            "        page = self.get_page()",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            self.assertFalse(LogEntry.objects.count())",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(1, LogEntry.objects.count())",
            "            self.assertEqual(page.pk, int(LogEntry.objects.all()[0].object_id))",
            "",
            "    def test_change_innavigation(self):",
            "        page = self.get_page()",
            "        permless = self.get_permless()",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            response = self.admin_class.change_innavigation(request, page.pk)",
            "            self.assertEqual(response.status_code, 403)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            self.assertRaises(Http404, self.admin_class.change_innavigation,",
            "                              request, page.pk + 100)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            response = self.admin_class.change_innavigation(request, page.pk)",
            "            self.assertEqual(response.status_code, 403)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            old = page.in_navigation",
            "            response = self.admin_class.change_innavigation(request, page.pk)",
            "            # These asserts are for #3589",
            "            self.assertContains(response, 'lang=\"en\"')",
            "            self.assertContains(response, './%s/en/preview/' % page.pk)",
            "            self.assertEqual(response.status_code, 200)",
            "            page = self.reload(page)",
            "            self.assertEqual(old, not page.in_navigation)",
            "",
            "    def test_publish_page_requires_perms(self):",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            request.method = \"POST\"",
            "            response = self.admin_class.publish_page(request, Page.objects.all()[0].pk, \"en\")",
            "            self.assertEqual(response.status_code, 403)",
            "",
            "    def test_revert_page(self):",
            "        self.page.publish('en')",
            "        title = self.page.title_set.get(language='en')",
            "        title.title = 'new'",
            "        title.save()",
            "        self.assertEqual(Title.objects.all().count(), 2)",
            "        self.assertEqual(Page.objects.all().count(), 2)",
            "        with self.login_user_context(self.get_superuser()):",
            "            request = self.get_request()",
            "            request.method = \"POST\"",
            "            response = self.admin_class.revert_page(request, Page.objects.all()[0].pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "        self.assertEqual(Title.objects.all().count(), 2)",
            "        self.assertEqual(Page.objects.all().count(), 2)",
            "        new_title = Title.objects.get(pk=title.pk)",
            "        self.assertNotEqual(title.title, new_title.title)",
            "        self.assertTrue(title.publisher_is_draft)",
            "        self.assertTrue(new_title.publisher_is_draft)",
            "",
            "    def test_revert_page_requires_perms(self):",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            request.method = \"POST\"",
            "            response = self.admin_class.revert_page(request, Page.objects.all()[0].pk, 'en')",
            "            self.assertEqual(response.status_code, 403)",
            "",
            "    def test_revert_page_redirects(self):",
            "        admin_user = self.get_admin()",
            "        self.page.publish(\"en\")  # Ensure public copy exists before reverting",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.get(admin_reverse('cms_page_revert_page', args=(self.page.pk, 'en')))",
            "            self.assertEqual(response.status_code, 302)",
            "            url = response['Location']",
            "            self.assertTrue(url.endswith('?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF')))",
            "",
            "    def test_remove_plugin_requires_post(self):",
            "        ph = Placeholder.objects.create(slot='test')",
            "        plugin = add_plugin(ph, 'TextPlugin', 'en', body='test')",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request()",
            "            response = self.admin_class.delete_plugin(request, plugin.pk)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "    def test_move_plugin(self):",
            "        ph = Placeholder.objects.create(slot='test')",
            "        plugin = add_plugin(ph, 'TextPlugin', 'en', body='test')",
            "        page = self.get_page()",
            "        source, target = list(page.placeholders.all())[:2]",
            "        pageplugin = add_plugin(source, 'TextPlugin', 'en', body='test')",
            "        plugin_class = pageplugin.get_plugin_class_instance()",
            "        expected = {'reload': plugin_class.requires_reload(PLUGIN_MOVE_ACTION)}",
            "        placeholder = Placeholder.objects.all()[0]",
            "        permless = self.get_permless()",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 405)",
            "            request = self.get_request(post_data={'not_usable': '1'})",
            "            self.assertRaises(MultiValueDictKeyError, self.admin_class.move_plugin, request)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'ids': plugin.pk})",
            "            self.assertRaises(MultiValueDictKeyError, self.admin_class.move_plugin, request)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': 'invalid-placeholder', 'plugin_language': 'en'})",
            "            self.assertRaises(ValueError, self.admin_class.move_plugin, request)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.pk, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            self.assertEqual(self.admin_class.move_plugin(request).status_code, HttpResponseForbidden.status_code)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.pk, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(json.loads(response.content.decode('utf8')), expected)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.id, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            self.assertEqual(self.admin_class.move_plugin(request).status_code, HttpResponseForbidden.status_code)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.id, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(json.loads(response.content.decode('utf8')), expected)",
            "",
            "    def test_move_language(self):",
            "        page = self.get_page()",
            "        source, target = list(page.placeholders.all())[:2]",
            "        col = add_plugin(source, 'MultiColumnPlugin', 'en')",
            "        sub_col = add_plugin(source, 'ColumnPlugin', 'en', target=col)",
            "        col2 = add_plugin(source, 'MultiColumnPlugin', 'de')",
            "",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': sub_col.pk,",
            "                'placeholder_id': source.id, 'plugin_parent': col2.pk, 'plugin_language': 'de'})",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 200)",
            "        sub_col = CMSPlugin.objects.get(pk=sub_col.pk)",
            "        self.assertEqual(sub_col.language, \"de\")",
            "        self.assertEqual(sub_col.parent_id, col2.pk)",
            "",
            "    def test_preview_page(self):",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            self.assertRaises(Http404, self.admin_class.preview_page, request, 404, \"en\")",
            "        page = self.get_page()",
            "        page.publish(\"en\")",
            "        base_url = page.get_absolute_url()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request('/?public=true')",
            "            response = self.admin_class.preview_page(request, page.pk, 'en')",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'], '%s?%s&language=en' % (base_url, get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')))",
            "            request = self.get_request()",
            "            response = self.admin_class.preview_page(request, page.pk, 'en')",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'], '%s?%s&language=en' % (base_url, get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')))",
            "            current_site = Site.objects.create(domain='django-cms.org', name='django-cms')",
            "            page.site = current_site",
            "            page.save()",
            "            page.publish(\"en\")",
            "            self.assertTrue(page.is_home)",
            "            response = self.admin_class.preview_page(request, page.pk, 'en')",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'],",
            "                             'http://django-cms.org%s?%s&language=en' % (base_url, get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')))",
            "",
            "    def test_too_many_plugins_global(self):",
            "        conf = {",
            "            'body': {",
            "                'limits': {",
            "                    'global': 1,",
            "                },",
            "            },",
            "        }",
            "        admin_user = self.get_admin()",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        with SettingsOverride(CMS_PERMISSION=False,",
            "                              CMS_PLACEHOLDER_CONF=conf):",
            "            page = create_page('somepage', 'nav_playground.html', 'en')",
            "            body = page.placeholders.get(slot='body')",
            "            add_plugin(body, 'TextPlugin', 'en', body='text')",
            "            with self.login_user_context(admin_user):",
            "                data = {",
            "                    'plugin_type': 'TextPlugin',",
            "                    'placeholder_id': body.pk,",
            "                    'plugin_language': 'en',",
            "                }",
            "                response = self.client.post(url, data)",
            "                self.assertEqual(response.status_code, HttpResponseBadRequest.status_code)",
            "",
            "    def test_too_many_plugins_type(self):",
            "        conf = {",
            "            'body': {",
            "                'limits': {",
            "                    'TextPlugin': 1,",
            "                },",
            "            },",
            "        }",
            "        admin_user = self.get_admin()",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        with SettingsOverride(CMS_PERMISSION=False,",
            "                              CMS_PLACEHOLDER_CONF=conf):",
            "            page = create_page('somepage', 'nav_playground.html', 'en')",
            "            body = page.placeholders.get(slot='body')",
            "            add_plugin(body, 'TextPlugin', 'en', body='text')",
            "            with self.login_user_context(admin_user):",
            "                data = {",
            "                    'plugin_type': 'TextPlugin',",
            "                    'placeholder_id': body.pk,",
            "                    'plugin_language': 'en',",
            "                    'plugin_parent': '',",
            "                }",
            "                response = self.client.post(url, data)",
            "                self.assertEqual(response.status_code, HttpResponseBadRequest.status_code)",
            "",
            "    def test_edit_title_dirty_bit(self):",
            "        language = \"en\"",
            "        admin_user = self.get_admin()",
            "        page = create_page('A', 'nav_playground.html', language)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        page.publish(\"en\")",
            "        draft_page = page.get_draft_object()",
            "        admin_url = reverse(\"admin:cms_page_edit_title_fields\", args=(",
            "            draft_page.pk, language",
            "        ))",
            "",
            "        post_data = {",
            "            'title': \"A Title\"",
            "        }",
            "        with self.login_user_context(admin_user):",
            "            self.client.post(admin_url, post_data)",
            "            draft_page = Page.objects.get(pk=page.pk).get_draft_object()",
            "            self.assertTrue(draft_page.is_dirty('en'))",
            "",
            "    def test_edit_title_languages(self):",
            "        language = \"en\"",
            "        admin_user = self.get_admin()",
            "        page = create_page('A', 'nav_playground.html', language)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        page.publish(\"en\")",
            "        draft_page = page.get_draft_object()",
            "        admin_url = reverse(\"admin:cms_page_edit_title_fields\", args=(",
            "            draft_page.pk, language",
            "        ))",
            "",
            "        post_data = {",
            "            'title': \"A Title\"",
            "        }",
            "        with self.login_user_context(admin_user):",
            "            self.client.post(admin_url, post_data)",
            "            draft_page = Page.objects.get(pk=page.pk).get_draft_object()",
            "            self.assertTrue(draft_page.is_dirty('en'))",
            "",
            "    def test_page_form_leak(self):",
            "        language = \"en\"",
            "        admin_user = self.get_admin()",
            "        request = self.get_request('/', 'en')",
            "        request.user = admin_user",
            "        page = create_page('A', 'nav_playground.html', language, menu_title='menu title')",
            "        page_admin = PageAdmin(Page, site)",
            "        page_admin._current_page = page",
            "",
            "        edit_form = page_admin.get_form(request, page)",
            "        add_form = page_admin.get_form(request, None)",
            "",
            "        self.assertEqual(edit_form.base_fields['menu_title'].initial, 'menu title')",
            "        self.assertEqual(add_form.base_fields['menu_title'].initial, None)",
            "",
            "",
            "class NoDBAdminTests(CMSTestCase):",
            "    @property",
            "    def admin_class(self):",
            "        return site._registry[Page]",
            "",
            "    def test_lookup_allowed_site__exact(self):",
            "        self.assertTrue(self.admin_class.lookup_allowed('site__exact', '1'))",
            "",
            "    def test_lookup_allowed_published(self):",
            "        self.assertTrue(self.admin_class.lookup_allowed('published', value='1'))",
            "",
            "",
            "class PluginPermissionTests(AdminTestsBase):",
            "    def setUp(self):",
            "        self._page = create_page('test page', 'nav_playground.html', 'en')",
            "        self._placeholder = self._page.placeholders.all()[0]",
            "",
            "    def _get_admin(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email=\"admin@django-cms.org\", is_staff=True, is_active=True)",
            "",
            "        if (User.USERNAME_FIELD != 'email'):",
            "            fields[User.USERNAME_FIELD] = \"admin\"",
            "",
            "        admin_user = User(**fields)",
            "",
            "        admin_user.set_password('admin')",
            "        admin_user.save()",
            "        return admin_user",
            "",
            "    def _get_page_admin(self):",
            "        return admin.site._registry[Page]",
            "",
            "    def _give_permission(self, user, model, permission_type, save=True):",
            "        codename = '%s_%s' % (permission_type, model._meta.object_name.lower())",
            "        user.user_permissions.add(Permission.objects.get(codename=codename))",
            "",
            "    def _give_page_permission_rights(self, user):",
            "        self._give_permission(user, PagePermission, 'add')",
            "        self._give_permission(user, PagePermission, 'change')",
            "        self._give_permission(user, PagePermission, 'delete')",
            "",
            "    def _get_change_page_request(self, user, page):",
            "        return type('Request', (object,), {",
            "            'user': user,",
            "            'path': base.URL_CMS_PAGE_CHANGE % page.pk",
            "        })",
            "",
            "    def _give_cms_permissions(self, user, save=True):",
            "        for perm_type in ['add', 'change', 'delete']:",
            "            for model in [Page, Title]:",
            "                self._give_permission(user, model, perm_type, False)",
            "        gpp = GlobalPagePermission.objects.create(",
            "            user=user,",
            "            can_change=True,",
            "            can_delete=True,",
            "            can_change_advanced_settings=False,",
            "            can_publish=True,",
            "            can_change_permissions=False,",
            "            can_move_page=True,",
            "        )",
            "        gpp.sites = Site.objects.all()",
            "        if save:",
            "            user.save()",
            "",
            "    def _create_plugin(self):",
            "        plugin = add_plugin(self._placeholder, 'TextPlugin', 'en')",
            "        return plugin",
            "",
            "    def test_plugin_add_requires_permissions(self):",
            "        \"\"\"User tries to add a plugin but has no permissions. He can add the plugin after he got the permissions\"\"\"",
            "        admin = self._get_admin()",
            "        self._give_cms_permissions(admin)",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        data = {",
            "            'plugin_type': 'TextPlugin',",
            "            'placeholder_id': self._placeholder.pk,",
            "            'plugin_language': 'en',",
            "            'plugin_parent': '',",
            "        }",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        self._give_permission(admin, Text, 'add')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugin_edit_requires_permissions(self):",
            "        \"\"\"User tries to edit a plugin but has no permissions. He can edit the plugin after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_edit_plugin', args=[plugin.id])",
            "        response = self.client.post(url, dict())",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'change')",
            "        response = self.client.post(url, dict())",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugin_edit_wrong_url(self):",
            "        \"\"\"User tries to edit a plugin using a random url. 404 response returned\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        self._give_permission(normal_guy, Text, 'change')",
            "        url = '%s/edit-plugin/%s/' % (admin_reverse('cms_page_edit_plugin', args=[plugin.id]), plugin.id)",
            "        response = self.client.post(url, dict())",
            "        self.assertEqual(response.status_code, HttpResponseNotFound.status_code)",
            "        self.assertTrue(\"Plugin not found\" in force_unicode(response.content))",
            "",
            "    def test_plugin_remove_requires_permissions(self):",
            "        \"\"\"User tries to remove a plugin but has no permissions. He can remove the plugin after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_delete_plugin', args=[plugin.pk])",
            "        data = dict(plugin_id=plugin.id)",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'delete')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_plugin_move_requires_permissions(self):",
            "        \"\"\"User tries to move a plugin but has no permissions. He can move the plugin after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_move_plugin')",
            "        data = dict(plugin_id=plugin.id,",
            "                    placeholder_id=self._placeholder.pk,",
            "                    plugin_parent='',",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'change')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugins_copy_requires_permissions(self):",
            "        \"\"\"User tries to copy plugin but has no permissions. He can copy plugins after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_copy_plugins')",
            "        data = dict(source_plugin_id=plugin.id,",
            "                    source_placeholder_id=self._placeholder.pk,",
            "                    source_language='en',",
            "                    target_language='fr',",
            "                    target_placeholder_id=self._placeholder.pk,",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'add')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugins_copy_placeholder_ref(self):",
            "        \"\"\"User copies a placeholder into a clipboard. A PlaceholderReferencePlugin is created. Afterwards he copies this",
            "         into a placeholder and the PlaceholderReferencePlugin unpacks its content. After that he clear the clipboard\"\"\"",
            "        self.assertEqual(Placeholder.objects.count(), 2)",
            "        self._create_plugin()",
            "        self._create_plugin()",
            "        admin_user = self.get_superuser()",
            "        clipboard = Placeholder()",
            "        clipboard.save()",
            "        self.assertEqual(CMSPlugin.objects.count(), 2)",
            "        settings = UserSettings(language=\"fr\", clipboard=clipboard, user=admin_user)",
            "        settings.save()",
            "        self.assertEqual(Placeholder.objects.count(), 3)",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin@django-cms.org')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        url = admin_reverse('cms_page_copy_plugins')",
            "        data = dict(source_plugin_id='',",
            "                    source_placeholder_id=self._placeholder.pk,",
            "                    source_language='en',",
            "                    target_language='en',",
            "                    target_placeholder_id=clipboard.pk,",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        clipboard_plugins = clipboard.get_plugins()",
            "        self.assertEqual(CMSPlugin.objects.count(), 5)",
            "        self.assertEqual(clipboard_plugins.count(), 1)",
            "        self.assertEqual(clipboard_plugins[0].plugin_type, \"PlaceholderPlugin\")",
            "        placeholder_plugin, _ = clipboard_plugins[0].get_plugin_instance()",
            "        ref_placeholder = placeholder_plugin.placeholder_ref",
            "        copied_plugins = ref_placeholder.get_plugins()",
            "        self.assertEqual(copied_plugins.count(), 2)",
            "        data = dict(source_plugin_id=placeholder_plugin.pk,",
            "                    source_placeholder_id=clipboard.pk,",
            "                    source_language='en',",
            "                    target_language='fr',",
            "                    target_placeholder_id=self._placeholder.pk,",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        plugins = self._placeholder.get_plugins()",
            "        self.assertEqual(plugins.count(), 4)",
            "        self.assertEqual(CMSPlugin.objects.count(), 7)",
            "        self.assertEqual(Placeholder.objects.count(), 4)",
            "        url = admin_reverse('cms_page_clear_placeholder', args=[clipboard.pk])",
            "        with self.assertNumQueries(FuzzyInt(70, 80)):",
            "            response = self.client.post(url, {'test': 0})",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertEqual(CMSPlugin.objects.count(), 4)",
            "        self.assertEqual(Placeholder.objects.count(), 3)",
            "",
            "    def test_plugins_copy_language(self):",
            "        \"\"\"User tries to copy plugin but has no permissions. He can copy plugins after he got the permissions\"\"\"",
            "        self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD != 'email':",
            "            self.client.login(username='test', password='test')",
            "        else:",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "",
            "        self.assertEqual(1, CMSPlugin.objects.all().count())",
            "        url = admin_reverse('cms_page_copy_language', args=[self._page.pk])",
            "        data = dict(",
            "            source_language='en',",
            "            target_language='fr',",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'add')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        self.assertEqual(2, CMSPlugin.objects.all().count())",
            "",
            "    def test_page_permission_inline_visibility(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email='user@domain.com', password='user', is_staff=True)",
            "",
            "        if get_user_model().USERNAME_FIELD != 'email':",
            "            fields[get_user_model().USERNAME_FIELD] = 'user'",
            "",
            "        user = User(**fields)",
            "        user.save()",
            "        self._give_page_permission_rights(user)",
            "        page = create_page('A', 'nav_playground.html', 'en')",
            "        page_permission = PagePermission.objects.create(",
            "            can_change_permissions=True, user=user, page=page)",
            "        request = self._get_change_page_request(user, page)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        # user has can_change_permission",
            "        # => must see the PagePermissionInline",
            "        self.assertTrue(",
            "            any(type(inline) is PagePermissionInlineAdmin",
            "                for inline in page_admin.get_inline_instances(request,",
            "                                                              page if not DJANGO_1_4 else None)))",
            "",
            "        page = Page.objects.get(pk=page.pk)",
            "        # remove can_change_permission",
            "        page_permission.can_change_permissions = False",
            "        page_permission.save()",
            "        request = self._get_change_page_request(user, page)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        # => PagePermissionInline is no longer visible",
            "        self.assertFalse(",
            "            any(type(inline) is PagePermissionInlineAdmin",
            "                for inline in page_admin.get_inline_instances(request, page if not DJANGO_1_4 else None)))",
            "",
            "    def test_edit_title_is_allowed_for_staff_user(self):",
            "        \"\"\"",
            "        We check here both the permission on a single page, and the global permissions",
            "        \"\"\"",
            "        user = self._create_user('user', is_staff=True)",
            "        another_user = self._create_user('another_user', is_staff=True)",
            "",
            "        page = create_page('A', 'nav_playground.html', 'en')",
            "        admin_url = reverse(\"admin:cms_page_edit_title_fields\", args=(",
            "            page.pk, 'en'",
            "        ))",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "",
            "        username = getattr(user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password=username)",
            "        response = self.client.get(admin_url)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "",
            "        assign_user_to_page(page, user, grant_all=True)",
            "        username = getattr(user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password=username)",
            "        response = self.client.get(admin_url)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "        self._give_cms_permissions(another_user)",
            "        username = getattr(another_user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password=username)",
            "        response = self.client.get(admin_url)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugin_add_returns_valid_pk_for_plugin(self):",
            "        admin_user = self._get_admin()",
            "        self._give_cms_permissions(admin_user)",
            "        self._give_permission(admin_user, Text, 'add')",
            "",
            "        username = getattr(admin_user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password='admin')",
            "",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        data = {",
            "            'plugin_type': 'TextPlugin',",
            "            'placeholder_id': self._placeholder.pk,",
            "            'plugin_language': 'en',",
            "            'plugin_parent': '',",
            "        }",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        self.assertEqual(response['content-type'], 'application/json')",
            "        pk = response.content.decode('utf8').split(\"edit-plugin/\")[1].split(\"/\")[0]",
            "        self.assertTrue(CMSPlugin.objects.filter(pk=int(pk)).exists())",
            "",
            "",
            "class AdminFormsTests(AdminTestsBase):",
            "    def test_clean_overwrite_url(self):",
            "        user = AnonymousUser()",
            "        user.is_superuser = True",
            "        user.pk = 1",
            "        request = type('Request', (object,), {'user': user})",
            "        with SettingsOverride():",
            "            data = {",
            "                'title': 'TestPage',",
            "                'slug': 'test-page',",
            "                'language': 'en',",
            "                'overwrite_url': '/overwrite/url/',",
            "                'site': Site.objects.get_current().pk,",
            "                'template': get_cms_setting('TEMPLATES')[0][0],",
            "                'published': True",
            "            }",
            "",
            "            form = PageForm(data)",
            "            self.assertTrue(form.is_valid(), form.errors.as_text())",
            "            # WTF? WHY DOES form.save() not handle this stuff???",
            "            instance = form.save()",
            "            instance.permission_user_cache = user",
            "            instance.permission_advanced_settings_cache = True",
            "            Title.objects.set_or_create(request, instance, form, 'en')",
            "            form = PageForm(data, instance=instance)",
            "            self.assertTrue(form.is_valid(), form.errors.as_text())",
            "",
            "    def test_missmatching_site_parent_dotsite(self):",
            "        site0 = Site.objects.create(domain='foo.com', name='foo.com')",
            "        site1 = Site.objects.create(domain='foo.com', name='foo.com')",
            "        parent_page = Page.objects.create(",
            "            template='nav_playground.html',",
            "            site=site0)",
            "        new_page_data = {",
            "            'title': 'Title',",
            "            'slug': 'slug',",
            "            'language': 'en',",
            "            'site': site1.pk,",
            "            'template': get_cms_setting('TEMPLATES')[0][0],",
            "            'reverse_id': '',",
            "            'parent': parent_page.pk,",
            "        }",
            "        form = PageForm(data=new_page_data, files=None)",
            "        self.assertFalse(form.is_valid())",
            "        self.assertIn(u\"Site doesn't match the parent's page site\",",
            "                      form.errors['__all__'])",
            "",
            "    def test_reverse_id_error_location(self):",
            "        ''' Test moving the reverse_id validation error to a field specific one '''",
            "",
            "        # this is the Reverse ID we'll re-use to break things.",
            "        dupe_id = 'p1'",
            "        curren_site = Site.objects.get_current()",
            "        create_page('Page 1', 'nav_playground.html', 'en', reverse_id=dupe_id)",
            "        page2 = create_page('Page 2', 'nav_playground.html', 'en')",
            "        # Assemble a bunch of data to test the page form",
            "        page2_data = {",
            "            'language': 'en',",
            "            'site': curren_site.pk,",
            "            'reverse_id': dupe_id,",
            "            'template': 'col_two.html',",
            "        }",
            "        form = AdvancedSettingsForm(data=page2_data, files=None)",
            "        self.assertFalse(form.is_valid())",
            "",
            "        # reverse_id is the only item that is in __all__ as every other field",
            "        # has it's own clean method. Moving it to be a field error means",
            "        # __all__ is now not available.",
            "        self.assertNotIn('__all__', form.errors)",
            "        # In moving it to it's own field, it should be in form.errors, and",
            "        # the values contained therein should match these.",
            "        self.assertIn('reverse_id', form.errors)",
            "        self.assertEqual(1, len(form.errors['reverse_id']))",
            "        self.assertEqual([u'A page with this reverse URL id exists already.'],",
            "                         form.errors['reverse_id'])",
            "        page2_data['reverse_id'] = \"\"",
            "",
            "        form = AdvancedSettingsForm(data=page2_data, files=None)",
            "        self.assertTrue(form.is_valid())",
            "        admin_user = self._get_guys(admin_only=True)",
            "        # reset some of page2_data so we can use cms.api.create_page",
            "        page2 = page2.reload()",
            "        page2.site = curren_site",
            "        page2.save()",
            "        with self.login_user_context(admin_user):",
            "            # re-reset the page2_data for the admin form instance.",
            "            page2_data['reverse_id'] = dupe_id",
            "            page2_data['site'] = curren_site.pk",
            "",
            "            # post to the admin change form for page 2, and test that the",
            "            # reverse_id form row has an errors class. Django's admin avoids",
            "            # collapsing these, so that the error is visible.",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page2.pk, page2_data)",
            "            self.assertContains(resp, '<div class=\"form-row errors reverse_id\">')",
            "",
            "    def test_create_page_type(self):",
            "        page = create_page('Test', 'static.html', 'en', published=True, reverse_id=\"home\")",
            "        for placeholder in Placeholder.objects.all():",
            "            add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "        page.publish('en')",
            "        self.assertEqual(Page.objects.count(), 2)",
            "        self.assertEqual(CMSPlugin.objects.count(), 4)",
            "        superuser = self.get_superuser()",
            "        with self.login_user_context(superuser):",
            "            response = self.client.get(",
            "                \"%s?copy_target=%s&language=%s\" % (admin_reverse(\"cms_page_add_page_type\"), page.pk, 'en'))",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(Page.objects.count(), 3)",
            "            self.assertEqual(Page.objects.filter(reverse_id=\"page_types\").count(), 1)",
            "            page_types = Page.objects.get(reverse_id='page_types')",
            "            url = response.url if hasattr(response, 'url') else response['Location']",
            "            expected_url_params = QueryDict(",
            "                'target=%s&position=first-child&add_page_type=1&copy_target=%s&language=en' % (page_types.pk, page.pk))",
            "            response_url_params = QueryDict(urlparse(url).query)",
            "            self.assertDictEqual(expected_url_params, response_url_params)",
            "            response = self.client.get(\"%s?copy_target=%s&language=%s\" % (",
            "                admin_reverse(\"cms_page_add_page_type\"), page.pk, 'en'), follow=True)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "            # test no page types if no page types there",
            "            response = self.client.get(admin_reverse('cms_page_add'))",
            "            self.assertNotContains(response, \"page_type\")",
            "            # create out first page type",
            "            page_data = {",
            "                'title': 'type1', 'slug': 'type1', '_save': 1, 'template': 'static.html', 'site': 1,",
            "                'language': 'en'",
            "            }",
            "            response = self.client.post(",
            "                \"/en/admin/cms/page/add/?target=%s&position=first-child&add_page_type=1&copy_target=%s&language=en\" % (",
            "                    page_types.pk, page.pk), data=page_data)",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(Page.objects.count(), 4)",
            "            self.assertEqual(CMSPlugin.objects.count(), 6)",
            "            response = self.client.get(admin_reverse('cms_page_add'))",
            "            self.assertContains(response, \"page_type\")",
            "            # no page types available if you use the copy_target",
            "            response = self.client.get(\"%s?copy_target=%s&language=en\" % (admin_reverse('cms_page_add'), page.pk))",
            "            self.assertNotContains(response, \"page_type\")",
            "",
            "    def test_render_edit_mode(self):",
            "        from django.core.cache import cache",
            "",
            "        cache.clear()",
            "        create_page('Test', 'static.html', 'en', published=True)",
            "        for placeholder in Placeholder.objects.all():",
            "            add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "",
            "        user = self.get_superuser()",
            "        self.assertEqual(Placeholder.objects.all().count(), 4)",
            "        with self.login_user_context(user):",
            "            with self.assertNumQueries(FuzzyInt(40, 66)):",
            "                output = force_unicode(self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')).content)",
            "            self.assertIn('<b>Test</b>', output)",
            "            self.assertEqual(Placeholder.objects.all().count(), 9)",
            "            self.assertEqual(StaticPlaceholder.objects.count(), 2)",
            "            for placeholder in Placeholder.objects.all():",
            "                add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "            with self.assertNumQueries(FuzzyInt(40, 60)):",
            "                output = force_unicode(self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')).content)",
            "            self.assertIn('<b>Test</b>', output)",
            "        with self.assertNumQueries(FuzzyInt(18, 48)):",
            "            force_unicode(self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')).content)",
            "        with self.assertNumQueries(FuzzyInt(12, 30)):",
            "            force_unicode(self.client.get('/en/').content)",
            "",
            "    def test_tree_view_queries(self):",
            "        from django.core.cache import cache",
            "",
            "        cache.clear()",
            "        for i in range(10):",
            "            create_page('Test%s' % i, 'col_two.html', 'en', published=True)",
            "        for placeholder in Placeholder.objects.all():",
            "            add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "",
            "        user = self.get_superuser()",
            "        with self.login_user_context(user):",
            "            with self.assertNumQueries(FuzzyInt(18, 33)):",
            "                force_unicode(self.client.get('/en/admin/cms/page/'))",
            "",
            "    def test_smart_link_published_pages(self):",
            "        admin, staff_guy = self._get_guys()",
            "        page_url = '/en/admin/cms/page/published-pages/' # Not sure how to achieve this with reverse...",
            "",
            "        with self.login_user_context(staff_guy):",
            "            multi_title_page = create_page('main_title', 'col_two.html', 'en', published=True,",
            "                                           overwrite_url='overwritten_url',",
            "                                           menu_title='menu_title')",
            "",
            "            title = multi_title_page.get_title_obj()",
            "            title.page_title = 'page_title'",
            "            title.save()",
            "",
            "            multi_title_page.save()",
            "            publish_page(multi_title_page, admin, 'en')",
            "",
            "            # Non ajax call should return a 403 as this page shouldn't be accessed by anything else but ajax queries",
            "            self.assertEqual(403, self.client.get(page_url).status_code)",
            "",
            "            self.assertEqual(200,",
            "                             self.client.get(page_url, HTTP_X_REQUESTED_WITH='XMLHttpRequest').status_code",
            "            )",
            "",
            "            # Test that the query param is working as expected.",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'main_title'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'menu_title'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'overwritten_url'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'page_title'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "",
            "class AdminPageEditContentSizeTests(AdminTestsBase):",
            "    \"\"\"",
            "    System user count influences the size of the page edit page,",
            "    but the users are only 2 times present on the page",
            "",
            "    The test relates to extra=0",
            "    at PagePermissionInlineAdminForm and ViewRestrictionInlineAdmin",
            "    \"\"\"",
            "",
            "    def test_editpage_contentsize(self):",
            "        \"\"\"",
            "        Expected a username only 2 times in the content, but a relationship",
            "        between usercount and pagesize",
            "        \"\"\"",
            "        with SettingsOverride(CMS_PERMISSION=True):",
            "            admin_user = self.get_superuser()",
            "            PAGE_NAME = 'TestPage'",
            "            USER_NAME = 'test_size_user_0'",
            "            current_site = Site.objects.get(pk=1)",
            "            page = create_page(PAGE_NAME, \"nav_playground.html\", \"en\", site=current_site, created_by=admin_user)",
            "            page.save()",
            "            self._page = page",
            "            with self.login_user_context(admin_user):",
            "                url = base.URL_CMS_PAGE_PERMISSION_CHANGE % self._page.pk",
            "                response = self.client.get(url)",
            "                self.assertEqual(response.status_code, 200)",
            "                old_response_size = len(response.content)",
            "                old_user_count = get_user_model().objects.count()",
            "                # create additionals user and reload the page",
            "                get_user_model().objects.create_user(username=USER_NAME, email=USER_NAME + '@django-cms.org',",
            "                                                     password=USER_NAME)",
            "                user_count = get_user_model().objects.count()",
            "                more_users_in_db = old_user_count < user_count",
            "                # we have more users",
            "                self.assertTrue(more_users_in_db, \"New users got NOT created\")",
            "                response = self.client.get(url)",
            "                new_response_size = len(response.content)",
            "                page_size_grown = old_response_size < new_response_size",
            "                # expect that the pagesize gets influenced by the useramount of the system",
            "                self.assertTrue(page_size_grown, \"Page size has not grown after user creation\")",
            "                # usernames are only 2 times in content",
            "                text = smart_str(response.content, response._charset)",
            "",
            "                foundcount = text.count(USER_NAME)",
            "                # 2 forms contain usernames as options",
            "                self.assertEqual(foundcount, 2,",
            "                                 \"Username %s appeared %s times in response.content, expected 2 times\" % (",
            "                                     USER_NAME, foundcount))"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from __future__ import with_statement",
            "import json",
            "import datetime",
            "from cms.utils.urlutils import admin_reverse",
            "",
            "from djangocms_text_ckeditor.cms_plugins import TextPlugin",
            "from djangocms_text_ckeditor.models import Text",
            "from django.contrib import admin",
            "from django.contrib.admin.models import LogEntry",
            "from django.contrib.admin.sites import site",
            "from django.contrib.auth.models import Permission, AnonymousUser",
            "from django.contrib.sites.models import Site",
            "from django.core.urlresolvers import reverse",
            "from django.http import (Http404, HttpResponseBadRequest, HttpResponseForbidden, HttpResponse,",
            "                         QueryDict, HttpResponseNotFound)",
            "from django.utils.datastructures import MultiValueDictKeyError",
            "from django.utils.encoding import smart_str",
            "from django.utils import timezone",
            "from django.utils.six.moves.urllib.parse import urlparse",
            "",
            "from cms.admin.change_list import CMSChangeList",
            "from cms.admin.forms import PageForm, AdvancedSettingsForm",
            "from cms.admin.pageadmin import PageAdmin",
            "from cms.admin.permissionadmin import PagePermissionInlineAdmin",
            "from cms.api import create_page, create_title, add_plugin, assign_user_to_page, publish_page",
            "from cms.constants import PLUGIN_MOVE_ACTION",
            "from cms.models import UserSettings, StaticPlaceholder",
            "from cms.models.pagemodel import Page",
            "from cms.models.permissionmodels import GlobalPagePermission, PagePermission",
            "from cms.models.placeholdermodel import Placeholder",
            "from cms.models.pluginmodel import CMSPlugin",
            "from cms.models.titlemodels import Title",
            "from cms.test_utils import testcases as base",
            "from cms.test_utils.testcases import CMSTestCase, URL_CMS_PAGE_DELETE, URL_CMS_PAGE, URL_CMS_TRANSLATION_DELETE",
            "from cms.test_utils.util.context_managers import SettingsOverride",
            "from cms.test_utils.util.fuzzy_int import FuzzyInt",
            "from cms.utils import get_cms_setting",
            "from cms.utils.compat import DJANGO_1_4, DJANGO_1_6",
            "from cms.utils.compat.dj import get_user_model, force_unicode",
            "",
            "",
            "class AdminTestsBase(CMSTestCase):",
            "    @property",
            "    def admin_class(self):",
            "        return site._registry[Page]",
            "",
            "    def _get_guys(self, admin_only=False, use_global_permissions=True):",
            "        admiN_user = self.get_superuser()",
            "        if admin_only:",
            "            return admiN_user",
            "        USERNAME = 'test'",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            normal_guy = get_user_model().objects.create_user(USERNAME, 'test@test.com', 'test@test.com')",
            "        else:",
            "            normal_guy = get_user_model().objects.create_user(USERNAME, 'test@test.com', USERNAME)",
            "",
            "        normal_guy.is_staff = True",
            "        normal_guy.is_active = True",
            "        normal_guy.save()",
            "        normal_guy.user_permissions = Permission.objects.filter(",
            "            codename__in=['change_page', 'change_title', 'add_page', 'add_title', 'delete_page', 'delete_title']",
            "        )",
            "        if use_global_permissions:",
            "            gpp = GlobalPagePermission.objects.create(",
            "                user=normal_guy,",
            "                can_change=True,",
            "                can_delete=True,",
            "                can_change_advanced_settings=False,",
            "                can_publish=True,",
            "                can_change_permissions=False,",
            "                can_move_page=True,",
            "            )",
            "            gpp.sites = Site.objects.all()",
            "        return admiN_user, normal_guy",
            "",
            "",
            "class AdminTestCase(AdminTestsBase):",
            "",
            "    def test_extension_not_in_admin(self):",
            "        admin_user, staff = self._get_guys()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request('/admin/cms/page/1/', 'en',)",
            "            response = site.index(request)",
            "            self.assertNotContains(response, '/mytitleextension/')",
            "            self.assertNotContains(response, '/mypageextension/')",
            "",
            "    def test_permissioned_page_list(self):",
            "        \"\"\"",
            "        Makes sure that a user with restricted page permissions can view",
            "        the page list.",
            "        \"\"\"",
            "        admin_user, normal_guy = self._get_guys(use_global_permissions=False)",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "        page = create_page(\"Test page\", \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "",
            "        PagePermission.objects.create(page=page, user=normal_guy)",
            "",
            "        with self.login_user_context(normal_guy):",
            "            resp = self.client.get(URL_CMS_PAGE)",
            "            self.assertEqual(resp.status_code, 200)",
            "",
            "    def test_edit_does_not_reset_page_adv_fields(self):",
            "        \"\"\"",
            "        Makes sure that if a non-superuser with no rights to edit advanced page",
            "        fields edits a page, those advanced fields are not touched.",
            "        \"\"\"",
            "        OLD_PAGE_NAME = 'Test Page'",
            "        NEW_PAGE_NAME = 'Test page 2'",
            "        REVERSE_ID = 'Test'",
            "        OVERRIDE_URL = 'my/override/url'",
            "",
            "        admin_user, normal_guy = self._get_guys()",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "",
            "        # The admin creates the page",
            "        page = create_page(OLD_PAGE_NAME, \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "        page.reverse_id = REVERSE_ID",
            "        page.save()",
            "        title = page.get_title_obj()",
            "        title.has_url_overwrite = True",
            "        title.path = OVERRIDE_URL",
            "        title.save()",
            "",
            "        self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "        self.assertEqual(page.reverse_id, REVERSE_ID)",
            "        self.assertEqual(title.overwrite_url, OVERRIDE_URL)",
            "",
            "        # The user edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': NEW_PAGE_NAME,",
            "            'slug': page.get_slug(),",
            "            'language': title.language,",
            "            'site': page.site.pk,",
            "            'template': page.template,",
            "            'pagepermission_set-TOTAL_FORMS': 0,",
            "            'pagepermission_set-INITIAL_FORMS': 0,",
            "            'pagepermission_set-MAX_NUM_FORMS': 0,",
            "            'pagepermission_set-2-TOTAL_FORMS': 0,",
            "            'pagepermission_set-2-INITIAL_FORMS': 0,",
            "            'pagepermission_set-2-MAX_NUM_FORMS': 0",
            "        }",
            "        # required only if user haves can_change_permission",
            "        with self.login_user_context(normal_guy):",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "",
            "            self.assertEqual(page.get_title(), NEW_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            title = page.get_title_obj()",
            "            self.assertEqual(title.overwrite_url, OVERRIDE_URL)",
            "",
            "        # The admin edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': OLD_PAGE_NAME,",
            "            'slug': page.get_slug(),",
            "            'language': title.language,",
            "            'site': page.site.pk,",
            "            'template': page.template,",
            "            'reverse_id': page.reverse_id,",
            "            'pagepermission_set-TOTAL_FORMS': 0,  # required only if user haves can_change_permission",
            "            'pagepermission_set-INITIAL_FORMS': 0,",
            "            'pagepermission_set-MAX_NUM_FORMS': 0,",
            "            'pagepermission_set-2-TOTAL_FORMS': 0,",
            "            'pagepermission_set-2-INITIAL_FORMS': 0,",
            "            'pagepermission_set-2-MAX_NUM_FORMS': 0",
            "        }",
            "        with self.login_user_context(admin_user):",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "",
            "            self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            title = page.get_title_obj()",
            "            self.assertEqual(title.overwrite_url, OVERRIDE_URL)",
            "",
            "    def test_edit_does_not_reset_apphook(self):",
            "        \"\"\"",
            "        Makes sure that if a non-superuser with no rights to edit advanced page",
            "        fields edits a page, those advanced fields are not touched.",
            "        \"\"\"",
            "        OLD_PAGE_NAME = 'Test Page'",
            "        NEW_PAGE_NAME = 'Test page 2'",
            "        REVERSE_ID = 'Test'",
            "        APPLICATION_URLS = 'project.sampleapp.urls'",
            "",
            "        admin_user, normal_guy = self._get_guys()",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "",
            "        # The admin creates the page",
            "        page = create_page(OLD_PAGE_NAME, \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "        page.reverse_id = REVERSE_ID",
            "        page.save()",
            "        title = page.get_title_obj()",
            "        title.has_url_overwrite = True",
            "",
            "        title.save()",
            "        page.application_urls = APPLICATION_URLS",
            "        page.save()",
            "        self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "        self.assertEqual(page.reverse_id, REVERSE_ID)",
            "        self.assertEqual(page.application_urls, APPLICATION_URLS)",
            "",
            "        # The user edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': NEW_PAGE_NAME,",
            "            'slug': page.get_slug(),",
            "            'language': title.language,",
            "            'site': page.site.pk,",
            "            'template': page.template,",
            "            'pagepermission_set-TOTAL_FORMS': 0,",
            "            'pagepermission_set-INITIAL_FORMS': 0,",
            "            'pagepermission_set-MAX_NUM_FORMS': 0,",
            "            'pagepermission_set-2-TOTAL_FORMS': 0,",
            "            'pagepermission_set-2-INITIAL_FORMS': 0,",
            "            'pagepermission_set-2-MAX_NUM_FORMS': 0,",
            "        }",
            "",
            "        with self.login_user_context(normal_guy):",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "            self.assertEqual(page.get_title(), NEW_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            self.assertEqual(page.application_urls, APPLICATION_URLS)",
            "            title = page.get_title_obj()",
            "            # The admin edits the page (change the page name for ex.)",
            "            page_data = {",
            "                'title': OLD_PAGE_NAME,",
            "                'slug': page.get_slug(),",
            "                'language': title.language,",
            "                'site': page.site.pk,",
            "                'template': page.template,",
            "                'reverse_id': page.reverse_id,",
            "            }",
            "",
            "        with self.login_user_context(admin_user):",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            resp = self.client.post(base.URL_CMS_PAGE_CHANGE % page.pk, page_data,",
            "                                    follow=True)",
            "            self.assertEqual(resp.status_code, 200)",
            "            self.assertTemplateNotUsed(resp, 'admin/login.html')",
            "            page = Page.objects.get(pk=page.pk)",
            "",
            "            self.assertEqual(page.get_title(), OLD_PAGE_NAME)",
            "            self.assertEqual(page.reverse_id, REVERSE_ID)",
            "            self.assertEqual(page.application_urls, '')",
            "",
            "    def test_2apphooks_with_same_namespace(self):",
            "        PAGE1 = 'Test Page'",
            "        PAGE2 = 'Test page 2'",
            "        APPLICATION_URLS = 'project.sampleapp.urls'",
            "",
            "        admin_user, normal_guy = self._get_guys()",
            "",
            "        current_site = Site.objects.get(pk=1)",
            "",
            "        # The admin creates the page",
            "        page = create_page(PAGE1, \"nav_playground.html\", \"en\",",
            "                           site=current_site, created_by=admin_user)",
            "        page2 = create_page(PAGE2, \"nav_playground.html\", \"en\",",
            "                            site=current_site, created_by=admin_user)",
            "",
            "        page.application_urls = APPLICATION_URLS",
            "        page.application_namespace = \"space1\"",
            "        page.save()",
            "        page2.application_urls = APPLICATION_URLS",
            "        page2.save()",
            "",
            "        # The admin edits the page (change the page name for ex.)",
            "        page_data = {",
            "            'title': PAGE2,",
            "            'slug': page2.get_slug(),",
            "            'language': 'en',",
            "            'site': page.site.pk,",
            "            'template': page2.template,",
            "            'application_urls': 'SampleApp',",
            "            'application_namespace': 'space1',",
            "        }",
            "",
            "        with self.login_user_context(admin_user):",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page.pk, page_data)",
            "            self.assertEqual(resp.status_code, 302)",
            "            self.assertEqual(Page.objects.filter(application_namespace=\"space1\").count(), 1)",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page2.pk, page_data)",
            "            self.assertEqual(resp.status_code, 200)",
            "            page_data['application_namespace'] = 'space2'",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page2.pk, page_data)",
            "            self.assertEqual(resp.status_code, 302)",
            "",
            "    def test_delete(self):",
            "        admin_user = self.get_superuser()",
            "        create_page(\"home\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        page = create_page(\"delete-page\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        create_page('child-page', \"nav_playground.html\", \"en\",",
            "                    created_by=admin_user, published=True, parent=page)",
            "        body = page.placeholders.get(slot='body')",
            "        add_plugin(body, 'TextPlugin', 'en', body='text')",
            "        page.publish('en')",
            "        with self.login_user_context(admin_user):",
            "            data = {'post': 'yes'}",
            "            with self.assertNumQueries(FuzzyInt(300, 407)):",
            "                response = self.client.post(URL_CMS_PAGE_DELETE % page.pk, data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "    def test_delete_diff_language(self):",
            "        admin_user = self.get_superuser()",
            "        create_page(\"home\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        page = create_page(\"delete-page\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        create_page('child-page', \"nav_playground.html\", \"de\",",
            "                    created_by=admin_user, published=True, parent=page)",
            "        body = page.placeholders.get(slot='body')",
            "        add_plugin(body, 'TextPlugin', 'en', body='text')",
            "        page.publish('en')",
            "        with self.login_user_context(admin_user):",
            "            data = {'post': 'yes'}",
            "            with self.assertNumQueries(FuzzyInt(300, 394)):",
            "                response = self.client.post(URL_CMS_PAGE_DELETE % page.pk, data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "    def test_search_fields(self):",
            "        superuser = self.get_superuser()",
            "        from django.contrib.admin import site",
            "",
            "        with self.login_user_context(superuser):",
            "            for model, admin_instance in site._registry.items():",
            "                if model._meta.app_label != 'cms':",
            "                    continue",
            "                if not admin_instance.search_fields:",
            "                    continue",
            "                url = admin_reverse('cms_%s_changelist' % model._meta.module_name)",
            "                response = self.client.get('%s?q=1' % url)",
            "                errmsg = response.content",
            "                self.assertEqual(response.status_code, 200, errmsg)",
            "",
            "    def test_delete_translation(self):",
            "        admin_user = self.get_superuser()",
            "        page = create_page(\"delete-page-translation\", \"nav_playground.html\", \"en\",",
            "                           created_by=admin_user, published=True)",
            "        create_title(\"de\", \"delete-page-translation-2\", page, slug=\"delete-page-translation-2\")",
            "        create_title(\"es-mx\", \"delete-page-translation-es\", page, slug=\"delete-page-translation-es\")",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.get(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'de'})",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'de'})",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "            response = self.client.get(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'es-mx'})",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(URL_CMS_TRANSLATION_DELETE % page.pk, {'language': 'es-mx'})",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "    def test_change_dates(self):",
            "        admin_user, staff = self._get_guys()",
            "        page = create_page('test-page', 'nav_playground.html', 'en')",
            "        page.publish('en')",
            "        draft = page.get_draft_object()",
            "",
            "        with self.settings(USE_TZ=False):",
            "            original_date = draft.publication_date",
            "            original_end_date = draft.publication_end_date",
            "            new_date = timezone.now() - datetime.timedelta(days=1)",
            "            new_end_date = timezone.now() + datetime.timedelta(days=1)",
            "            url = admin_reverse('cms_page_dates', args=(draft.pk,))",
            "            with self.login_user_context(admin_user):",
            "                response = self.client.post(url, {",
            "                    'language': 'en',",
            "                    'site': draft.site.pk,",
            "                    'publication_date_0': new_date.date(),",
            "                    'publication_date_1': new_date.strftime(\"%H:%M:%S\"),",
            "                    'publication_end_date_0': new_end_date.date(),",
            "                    'publication_end_date_1': new_end_date.strftime(\"%H:%M:%S\"),",
            "                })",
            "                self.assertEqual(response.status_code, 302)",
            "                draft = Page.objects.get(pk=draft.pk)",
            "                self.assertNotEqual(draft.publication_date.timetuple(), original_date.timetuple())",
            "                self.assertEqual(draft.publication_date.timetuple(), new_date.timetuple())",
            "                self.assertEqual(draft.publication_end_date.timetuple(), new_end_date.timetuple())",
            "                if original_end_date:",
            "                    self.assertNotEqual(draft.publication_end_date.timetuple(), original_end_date.timetuple())",
            "",
            "        with self.settings(USE_TZ=True):",
            "            original_date = draft.publication_date",
            "            original_end_date = draft.publication_end_date",
            "            new_date = timezone.localtime(timezone.now()) - datetime.timedelta(days=1)",
            "            new_end_date = timezone.localtime(timezone.now()) + datetime.timedelta(days=1)",
            "            url = admin_reverse('cms_page_dates', args=(draft.pk,))",
            "            with self.login_user_context(admin_user):",
            "                response = self.client.post(url, {",
            "                    'language': 'en',",
            "                    'site': draft.site.pk,",
            "                    'publication_date_0': new_date.date(),",
            "                    'publication_date_1': new_date.strftime(\"%H:%M:%S\"),",
            "                    'publication_end_date_0': new_end_date.date(),",
            "                    'publication_end_date_1': new_end_date.strftime(\"%H:%M:%S\"),",
            "                })",
            "                self.assertEqual(response.status_code, 302)",
            "                draft = Page.objects.get(pk=draft.pk)",
            "                self.assertNotEqual(draft.publication_date.timetuple(), original_date.timetuple())",
            "                self.assertEqual(timezone.localtime(draft.publication_date).timetuple(), new_date.timetuple())",
            "                self.assertEqual(timezone.localtime(draft.publication_end_date).timetuple(), new_end_date.timetuple())",
            "                if original_end_date:",
            "                    self.assertNotEqual(draft.publication_end_date.timetuple(), original_end_date.timetuple())",
            "",
            "    def test_change_template(self):",
            "        admin_user, staff = self._get_guys()",
            "        request = self.get_request('/admin/cms/page/1/', 'en')",
            "        request.method = \"POST\"",
            "        pageadmin = site._registry[Page]",
            "        with self.login_user_context(staff):",
            "            self.assertRaises(Http404, pageadmin.change_template, request, 1)",
            "            page = create_page('test-page', 'nav_playground.html', 'en')",
            "            response = pageadmin.change_template(request, page.pk)",
            "            self.assertEqual(response.status_code, 403)",
            "        url = admin_reverse('cms_page_change_template', args=(page.pk,))",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.post(url, {'template': 'doesntexist'})",
            "            self.assertEqual(response.status_code, 400)",
            "            response = self.client.post(url, {'template': get_cms_setting('TEMPLATES')[0][0]})",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "    def test_get_permissions(self):",
            "        page = create_page('test-page', 'nav_playground.html', 'en')",
            "        url = admin_reverse('cms_page_get_permissions', args=(page.pk,))",
            "        response = self.client.get(url)",
            "        if DJANGO_1_6:",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertTemplateUsed(response, 'admin/login.html')",
            "        else:",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertRedirects(response, '/en/admin/login/?next=/en/admin/cms/page/%s/permissions/' % page.pk)",
            "        admin_user = self.get_superuser()",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.get(url)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertTemplateNotUsed(response, 'admin/login.html')",
            "",
            "    def test_changelist_items(self):",
            "        admin_user = self.get_superuser()",
            "        first_level_page = create_page('level1', 'nav_playground.html', 'en')",
            "        second_level_page_top = create_page('level21', \"nav_playground.html\", \"en\",",
            "                                            created_by=admin_user, published=True, parent=first_level_page)",
            "        second_level_page_bottom = create_page('level22', \"nav_playground.html\", \"en\",",
            "                                               created_by=admin_user, published=True,",
            "                                               parent=self.reload(first_level_page))",
            "        third_level_page = create_page('level3', \"nav_playground.html\", \"en\",",
            "                                       created_by=admin_user, published=True, parent=second_level_page_top)",
            "        self.assertEqual(Page.objects.all().count(), 4)",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "        request = self.get_request(url)",
            "",
            "        request.session = {}",
            "        request.user = admin_user",
            "",
            "        page_admin = site._registry[Page]",
            "",
            "        cl_params = [request, page_admin.model, page_admin.list_display,",
            "            page_admin.list_display_links, page_admin.list_filter,",
            "            page_admin.date_hierarchy, page_admin.search_fields,",
            "            page_admin.list_select_related, page_admin.list_per_page]",
            "        if hasattr(page_admin, 'list_max_show_all'):  # django 1.4",
            "            cl_params.append(page_admin.list_max_show_all)",
            "        cl_params.extend([page_admin.list_editable, page_admin])",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "",
            "        cl.set_items(request)",
            "",
            "        root_page = cl.get_items()[0]",
            "",
            "        self.assertEqual(root_page, first_level_page)",
            "        self.assertEqual(root_page.get_children()[0], second_level_page_top)",
            "        self.assertEqual(root_page.get_children()[1], second_level_page_bottom)",
            "        self.assertEqual(root_page.get_children()[0].get_children()[0], third_level_page)",
            "",
            "    def test_changelist_get_results(self):",
            "        admin_user = self.get_superuser()",
            "        first_level_page = create_page('level1', 'nav_playground.html', 'en', published=True)",
            "        second_level_page_top = create_page('level21', \"nav_playground.html\", \"en\",",
            "                                            created_by=admin_user, published=True,",
            "                                            parent=first_level_page)",
            "        second_level_page_bottom = create_page('level22', \"nav_playground.html\", \"en\", # nopyflakes",
            "                                               created_by=admin_user, published=True,",
            "                                               parent=self.reload(first_level_page))",
            "        third_level_page = create_page('level3', \"nav_playground.html\", \"en\", # nopyflakes",
            "                                       created_by=admin_user, published=True,",
            "                                       parent=second_level_page_top)",
            "        fourth_level_page = create_page('level23', \"nav_playground.html\", \"en\", # nopyflakes",
            "                                        created_by=admin_user,",
            "                                        parent=self.reload(first_level_page))",
            "        self.assertEqual(Page.objects.all().count(), 9)",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "",
            "        request = self.get_request(url)",
            "        request.session = {}",
            "        request.user = admin_user",
            "",
            "        page_admin = site._registry[Page]",
            "",
            "        # full blown page list. only draft pages are taken into account",
            "        cl_params = [request, page_admin.model, page_admin.list_display,",
            "            page_admin.list_display_links, page_admin.list_filter,",
            "            page_admin.date_hierarchy, page_admin.search_fields,",
            "            page_admin.list_select_related, page_admin.list_per_page]",
            "        if hasattr(page_admin, 'list_max_show_all'):  # django 1.4",
            "            cl_params.append(page_admin.list_max_show_all)",
            "        cl_params.extend([page_admin.list_editable, page_admin])",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "        cl.get_results(request)",
            "        self.assertEqual(cl.full_result_count, 5)",
            "        self.assertEqual(cl.result_count, 5)",
            "",
            "        # only one unpublished page is returned",
            "        request = self.get_request(url+'?q=level23')",
            "        request.session = {}",
            "        request.user = admin_user",
            "        cl_params[0] = request",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "        cl.get_results(request)",
            "        self.assertEqual(cl.full_result_count, 5)",
            "        self.assertEqual(cl.result_count, 1)",
            "",
            "        # a number of pages matches the query",
            "        request = self.get_request(url+'?q=level2')",
            "        request.session = {}",
            "        request.user = admin_user",
            "        cl_params[0] = request",
            "        cl = CMSChangeList(*tuple(cl_params))",
            "        cl.get_results(request)",
            "        self.assertEqual(cl.full_result_count, 5)",
            "        self.assertEqual(cl.result_count, 3)",
            "",
            "    def test_changelist_tree(self):",
            "        \"\"\" This test checks for proper jstree cookie unquoting.",
            "",
            "        It should be converted to a selenium test to actually test the jstree behaviour.",
            "        Cookie set below is just a forged example (from live session)",
            "        \"\"\"",
            "        admin_user = self.get_superuser()",
            "        first_level_page = create_page('level1', 'nav_playground.html', 'en')",
            "        second_level_page_top = create_page('level21', \"nav_playground.html\", \"en\",",
            "                                            created_by=admin_user, published=True, parent=first_level_page)",
            "        second_level_page_bottom = create_page('level22', \"nav_playground.html\", \"en\",",
            "                                               created_by=admin_user, published=True,",
            "                                               parent=self.reload(first_level_page))",
            "        third_level_page = create_page('level3', \"nav_playground.html\", \"en\",",
            "                                       created_by=admin_user, published=True, parent=second_level_page_top)",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin@django-cms.org')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        self.client.cookies['djangocms_nodes_open'] = 'page_1%2Cpage_2'",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        self.assertEqual(response.context[\"open_menu_trees\"], [1, 2])",
            "        # tests descendants method for the lazy load ajax call",
            "        url = \"%s%d/en/descendants/\" % (url, first_level_page.pk)",
            "        response = self.client.get(url)",
            "        self.assertEqual(response.status_code, 200)",
            "        # should include both direct descendant pages",
            "        self.assertContains(response, 'id=\"page_%s\"' % second_level_page_top.pk)",
            "        self.assertContains(response, 'id=\"page_%s\"' % second_level_page_bottom.pk)",
            "        # but not any further down the tree",
            "        self.assertNotContains(response, 'id=\"page_%s\"' % third_level_page.pk)",
            "        self.assertNotContains(response, 'None')",
            "",
            "    def test_unihandecode_doesnt_break_404_in_admin(self):",
            "        self.get_superuser()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin@django-cms.org')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        response = self.client.get('/en/admin/cms/page/1/?language=en')",
            "        self.assertEqual(response.status_code, 404)",
            "",
            "    def test_tree_displays_in_correct_language(self):",
            "        '''",
            "        Test to prove and protect that the page titles in the tree are",
            "        displayed in the currently set language.",
            "        '''",
            "        admin_guy, normal_guy = self._get_guys(use_global_permissions=False)",
            "        site = Site.objects.get(pk=1)",
            "",
            "        en_title = \"EN Page\"",
            "        es_title = \"ES Pagina\"",
            "",
            "        # Create a page in en",
            "        page = create_page(en_title, \"nav_playground.html\", \"en\", site=site, created_by=admin)",
            "        # Add a es-mx translation for this page",
            "        create_title(\"es-mx\", es_title, page, slug=\"es_pagina\")",
            "",
            "        url = admin_reverse('cms_%s_changelist' % Page._meta.module_name)",
            "        url_pat = '<a href=\"{0}/{1}/preview/\"[^>]*>{2}</a>'",
            "",
            "        with self.login_user_context(admin_guy):",
            "            # Check the EN version of the tree...",
            "            response = self.client.get(url, {'language': 'en'})",
            "            self.assertRegexpMatches(str(response.content), url_pat.format(page.pk, 'en', en_title, ))",
            "",
            "            # Check the ES version of the tree...",
            "            response = self.client.get(url, {'language': 'es-mx'})",
            "            self.assertRegexpMatches(str(response.content), url_pat.format(page.pk, 'es-mx', es_title, ))",
            "",
            "    def test_empty_placeholder_in_correct_language(self):",
            "        \"\"\"",
            "        Test that Cleaning a placeholder only affect current language contents",
            "        \"\"\"",
            "        # create some objects",
            "        page_en = create_page(\"EmptyPlaceholderTestPage (EN)\", \"nav_playground.html\", \"en\")",
            "        ph = page_en.placeholders.get(slot=\"body\")",
            "",
            "        # add the text plugin to the en version of the page",
            "        add_plugin(ph, \"TextPlugin\", \"en\", body=\"Hello World EN 1\")",
            "        add_plugin(ph, \"TextPlugin\", \"en\", body=\"Hello World EN 2\")",
            "",
            "        # creating a de title of the page and adding plugins to it",
            "        create_title(\"de\", page_en.get_title(), page_en, slug=page_en.get_slug())",
            "        add_plugin(ph, \"TextPlugin\", \"de\", body=\"Hello World DE\")",
            "        add_plugin(ph, \"TextPlugin\", \"de\", body=\"Hello World DE 2\")",
            "        add_plugin(ph, \"TextPlugin\", \"de\", body=\"Hello World DE 3\")",
            "",
            "        # before cleaning the de placeholder",
            "        self.assertEqual(ph.get_plugins('en').count(), 2)",
            "        self.assertEqual(ph.get_plugins('de').count(), 3)",
            "",
            "        admin_user, staff = self._get_guys()",
            "        with self.login_user_context(admin_user):",
            "            url = '%s?language=de' % admin_reverse('cms_page_clear_placeholder', args=[ph.pk])",
            "            response = self.client.post(url, {'test': 0})",
            "",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "        # After cleaning the de placeholder, en placeholder must still have all the plugins",
            "        self.assertEqual(ph.get_plugins('en').count(), 2)",
            "        self.assertEqual(ph.get_plugins('de').count(), 0)",
            "",
            "",
            "class AdminTests(AdminTestsBase):",
            "    # TODO: needs tests for actual permissions, not only superuser/normaluser",
            "",
            "    def setUp(self):",
            "        self.page = create_page(\"testpage\", \"nav_playground.html\", \"en\")",
            "",
            "    def get_admin(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email=\"admin@django-cms.org\", is_staff=True, is_superuser=True)",
            "",
            "        if (User.USERNAME_FIELD != 'email'):",
            "            fields[User.USERNAME_FIELD] = \"admin\"",
            "",
            "        usr = User(**fields)",
            "        usr.set_password(getattr(usr, User.USERNAME_FIELD))",
            "        usr.save()",
            "        return usr",
            "",
            "    def get_permless(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email=\"permless@django-cms.org\", is_staff=True)",
            "",
            "        if (User.USERNAME_FIELD != 'email'):",
            "            fields[User.USERNAME_FIELD] = \"permless\"",
            "",
            "        usr = User(**fields)",
            "        usr.set_password(getattr(usr, User.USERNAME_FIELD))",
            "        usr.save()",
            "        return usr",
            "",
            "    def get_page(self):",
            "        return self.page",
            "",
            "    def test_change_publish_unpublish(self):",
            "        page = self.get_page()",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 405)",
            "            page = self.reload(page)",
            "            self.assertFalse(page.is_published('en'))",
            "",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 403)",
            "            page = self.reload(page)",
            "            self.assertFalse(page.is_published('en'))",
            "",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "",
            "            page = self.reload(page)",
            "            self.assertTrue(page.is_published('en'))",
            "",
            "            response = self.admin_class.unpublish(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "",
            "            page = self.reload(page)",
            "            self.assertFalse(page.is_published('en'))",
            "",
            "    def test_change_status_adds_log_entry(self):",
            "        page = self.get_page()",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            self.assertFalse(LogEntry.objects.count())",
            "            response = self.admin_class.publish_page(request, page.pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(1, LogEntry.objects.count())",
            "            self.assertEqual(page.pk, int(LogEntry.objects.all()[0].object_id))",
            "",
            "    def test_change_innavigation(self):",
            "        page = self.get_page()",
            "        permless = self.get_permless()",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            response = self.admin_class.change_innavigation(request, page.pk)",
            "            self.assertEqual(response.status_code, 405)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            response = self.admin_class.change_innavigation(request, page.pk)",
            "            self.assertEqual(response.status_code, 403)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            self.assertRaises(Http404, self.admin_class.change_innavigation,",
            "                              request, page.pk + 100)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            response = self.admin_class.change_innavigation(request, page.pk)",
            "            self.assertEqual(response.status_code, 403)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'no': 'data'})",
            "            old = page.in_navigation",
            "            response = self.admin_class.change_innavigation(request, page.pk)",
            "            # These asserts are for #3589",
            "            self.assertContains(response, 'lang=\"en\"')",
            "            self.assertContains(response, './%s/en/preview/' % page.pk)",
            "            self.assertEqual(response.status_code, 200)",
            "            page = self.reload(page)",
            "            self.assertEqual(old, not page.in_navigation)",
            "",
            "    def test_publish_page_requires_perms(self):",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            request.method = \"POST\"",
            "            response = self.admin_class.publish_page(request, Page.objects.all()[0].pk, \"en\")",
            "            self.assertEqual(response.status_code, 403)",
            "",
            "    def test_revert_page(self):",
            "        self.page.publish('en')",
            "        title = self.page.title_set.get(language='en')",
            "        title.title = 'new'",
            "        title.save()",
            "        self.assertEqual(Title.objects.all().count(), 2)",
            "        self.assertEqual(Page.objects.all().count(), 2)",
            "        with self.login_user_context(self.get_superuser()):",
            "            request = self.get_request()",
            "            request.method = \"POST\"",
            "            response = self.admin_class.revert_page(request, Page.objects.all()[0].pk, \"en\")",
            "            self.assertEqual(response.status_code, 302)",
            "        self.assertEqual(Title.objects.all().count(), 2)",
            "        self.assertEqual(Page.objects.all().count(), 2)",
            "        new_title = Title.objects.get(pk=title.pk)",
            "        self.assertNotEqual(title.title, new_title.title)",
            "        self.assertTrue(title.publisher_is_draft)",
            "        self.assertTrue(new_title.publisher_is_draft)",
            "",
            "    def test_revert_page_requires_perms(self):",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            request.method = \"POST\"",
            "            response = self.admin_class.revert_page(request, Page.objects.all()[0].pk, 'en')",
            "            self.assertEqual(response.status_code, 403)",
            "",
            "    def test_revert_page_redirects(self):",
            "        admin_user = self.get_admin()",
            "        self.page.publish(\"en\")  # Ensure public copy exists before reverting",
            "        with self.login_user_context(admin_user):",
            "            response = self.client.post(admin_reverse('cms_page_revert_page', args=(self.page.pk, 'en')))",
            "            self.assertEqual(response.status_code, 302)",
            "            url = response['Location']",
            "            self.assertTrue(url.endswith('?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF')))",
            "",
            "    def test_remove_plugin_requires_post(self):",
            "        ph = Placeholder.objects.create(slot='test')",
            "        plugin = add_plugin(ph, 'TextPlugin', 'en', body='test')",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request()",
            "            response = self.admin_class.delete_plugin(request, plugin.pk)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "    def test_move_plugin(self):",
            "        ph = Placeholder.objects.create(slot='test')",
            "        plugin = add_plugin(ph, 'TextPlugin', 'en', body='test')",
            "        page = self.get_page()",
            "        source, target = list(page.placeholders.all())[:2]",
            "        pageplugin = add_plugin(source, 'TextPlugin', 'en', body='test')",
            "        plugin_class = pageplugin.get_plugin_class_instance()",
            "        expected = {'reload': plugin_class.requires_reload(PLUGIN_MOVE_ACTION)}",
            "        placeholder = Placeholder.objects.all()[0]",
            "        permless = self.get_permless()",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 405)",
            "            request = self.get_request(post_data={'not_usable': '1'})",
            "            self.assertRaises(MultiValueDictKeyError, self.admin_class.move_plugin, request)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'ids': plugin.pk})",
            "            self.assertRaises(MultiValueDictKeyError, self.admin_class.move_plugin, request)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': 'invalid-placeholder', 'plugin_language': 'en'})",
            "            self.assertRaises(ValueError, self.admin_class.move_plugin, request)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.pk, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            self.assertEqual(self.admin_class.move_plugin(request).status_code, HttpResponseForbidden.status_code)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.pk, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(json.loads(response.content.decode('utf8')), expected)",
            "        with self.login_user_context(permless):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.id, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            self.assertEqual(self.admin_class.move_plugin(request).status_code, HttpResponseForbidden.status_code)",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': pageplugin.pk,",
            "                'placeholder_id': placeholder.id, 'plugin_parent': '', 'plugin_language': 'en'})",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(json.loads(response.content.decode('utf8')), expected)",
            "",
            "    def test_move_language(self):",
            "        page = self.get_page()",
            "        source, target = list(page.placeholders.all())[:2]",
            "        col = add_plugin(source, 'MultiColumnPlugin', 'en')",
            "        sub_col = add_plugin(source, 'ColumnPlugin', 'en', target=col)",
            "        col2 = add_plugin(source, 'MultiColumnPlugin', 'de')",
            "",
            "        admin_user = self.get_admin()",
            "        with self.login_user_context(admin_user):",
            "            request = self.get_request(post_data={'plugin_id': sub_col.pk,",
            "                'placeholder_id': source.id, 'plugin_parent': col2.pk, 'plugin_language': 'de'})",
            "            response = self.admin_class.move_plugin(request)",
            "            self.assertEqual(response.status_code, 200)",
            "        sub_col = CMSPlugin.objects.get(pk=sub_col.pk)",
            "        self.assertEqual(sub_col.language, \"de\")",
            "        self.assertEqual(sub_col.parent_id, col2.pk)",
            "",
            "    def test_preview_page(self):",
            "        permless = self.get_permless()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request()",
            "            self.assertRaises(Http404, self.admin_class.preview_page, request, 404, \"en\")",
            "        page = self.get_page()",
            "        page.publish(\"en\")",
            "        base_url = page.get_absolute_url()",
            "        with self.login_user_context(permless):",
            "            request = self.get_request('/?public=true')",
            "            response = self.admin_class.preview_page(request, page.pk, 'en')",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'], '%s?%s&language=en' % (base_url, get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')))",
            "            request = self.get_request()",
            "            response = self.admin_class.preview_page(request, page.pk, 'en')",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'], '%s?%s&language=en' % (base_url, get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')))",
            "            current_site = Site.objects.create(domain='django-cms.org', name='django-cms')",
            "            page.site = current_site",
            "            page.save()",
            "            page.publish(\"en\")",
            "            self.assertTrue(page.is_home)",
            "            response = self.admin_class.preview_page(request, page.pk, 'en')",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'],",
            "                             'http://django-cms.org%s?%s&language=en' % (base_url, get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')))",
            "",
            "    def test_too_many_plugins_global(self):",
            "        conf = {",
            "            'body': {",
            "                'limits': {",
            "                    'global': 1,",
            "                },",
            "            },",
            "        }",
            "        admin_user = self.get_admin()",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        with SettingsOverride(CMS_PERMISSION=False,",
            "                              CMS_PLACEHOLDER_CONF=conf):",
            "            page = create_page('somepage', 'nav_playground.html', 'en')",
            "            body = page.placeholders.get(slot='body')",
            "            add_plugin(body, 'TextPlugin', 'en', body='text')",
            "            with self.login_user_context(admin_user):",
            "                data = {",
            "                    'plugin_type': 'TextPlugin',",
            "                    'placeholder_id': body.pk,",
            "                    'plugin_language': 'en',",
            "                }",
            "                response = self.client.post(url, data)",
            "                self.assertEqual(response.status_code, HttpResponseBadRequest.status_code)",
            "",
            "    def test_too_many_plugins_type(self):",
            "        conf = {",
            "            'body': {",
            "                'limits': {",
            "                    'TextPlugin': 1,",
            "                },",
            "            },",
            "        }",
            "        admin_user = self.get_admin()",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        with SettingsOverride(CMS_PERMISSION=False,",
            "                              CMS_PLACEHOLDER_CONF=conf):",
            "            page = create_page('somepage', 'nav_playground.html', 'en')",
            "            body = page.placeholders.get(slot='body')",
            "            add_plugin(body, 'TextPlugin', 'en', body='text')",
            "            with self.login_user_context(admin_user):",
            "                data = {",
            "                    'plugin_type': 'TextPlugin',",
            "                    'placeholder_id': body.pk,",
            "                    'plugin_language': 'en',",
            "                    'plugin_parent': '',",
            "                }",
            "                response = self.client.post(url, data)",
            "                self.assertEqual(response.status_code, HttpResponseBadRequest.status_code)",
            "",
            "    def test_edit_title_dirty_bit(self):",
            "        language = \"en\"",
            "        admin_user = self.get_admin()",
            "        page = create_page('A', 'nav_playground.html', language)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        page.publish(\"en\")",
            "        draft_page = page.get_draft_object()",
            "        admin_url = reverse(\"admin:cms_page_edit_title_fields\", args=(",
            "            draft_page.pk, language",
            "        ))",
            "",
            "        post_data = {",
            "            'title': \"A Title\"",
            "        }",
            "        with self.login_user_context(admin_user):",
            "            self.client.post(admin_url, post_data)",
            "            draft_page = Page.objects.get(pk=page.pk).get_draft_object()",
            "            self.assertTrue(draft_page.is_dirty('en'))",
            "",
            "    def test_edit_title_languages(self):",
            "        language = \"en\"",
            "        admin_user = self.get_admin()",
            "        page = create_page('A', 'nav_playground.html', language)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        page.publish(\"en\")",
            "        draft_page = page.get_draft_object()",
            "        admin_url = reverse(\"admin:cms_page_edit_title_fields\", args=(",
            "            draft_page.pk, language",
            "        ))",
            "",
            "        post_data = {",
            "            'title': \"A Title\"",
            "        }",
            "        with self.login_user_context(admin_user):",
            "            self.client.post(admin_url, post_data)",
            "            draft_page = Page.objects.get(pk=page.pk).get_draft_object()",
            "            self.assertTrue(draft_page.is_dirty('en'))",
            "",
            "    def test_page_form_leak(self):",
            "        language = \"en\"",
            "        admin_user = self.get_admin()",
            "        request = self.get_request('/', 'en')",
            "        request.user = admin_user",
            "        page = create_page('A', 'nav_playground.html', language, menu_title='menu title')",
            "        page_admin = PageAdmin(Page, site)",
            "        page_admin._current_page = page",
            "",
            "        edit_form = page_admin.get_form(request, page)",
            "        add_form = page_admin.get_form(request, None)",
            "",
            "        self.assertEqual(edit_form.base_fields['menu_title'].initial, 'menu title')",
            "        self.assertEqual(add_form.base_fields['menu_title'].initial, None)",
            "",
            "",
            "class NoDBAdminTests(CMSTestCase):",
            "    @property",
            "    def admin_class(self):",
            "        return site._registry[Page]",
            "",
            "    def test_lookup_allowed_site__exact(self):",
            "        self.assertTrue(self.admin_class.lookup_allowed('site__exact', '1'))",
            "",
            "    def test_lookup_allowed_published(self):",
            "        self.assertTrue(self.admin_class.lookup_allowed('published', value='1'))",
            "",
            "",
            "class PluginPermissionTests(AdminTestsBase):",
            "    def setUp(self):",
            "        self._page = create_page('test page', 'nav_playground.html', 'en')",
            "        self._placeholder = self._page.placeholders.all()[0]",
            "",
            "    def _get_admin(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email=\"admin@django-cms.org\", is_staff=True, is_active=True)",
            "",
            "        if (User.USERNAME_FIELD != 'email'):",
            "            fields[User.USERNAME_FIELD] = \"admin\"",
            "",
            "        admin_user = User(**fields)",
            "",
            "        admin_user.set_password('admin')",
            "        admin_user.save()",
            "        return admin_user",
            "",
            "    def _get_page_admin(self):",
            "        return admin.site._registry[Page]",
            "",
            "    def _give_permission(self, user, model, permission_type, save=True):",
            "        codename = '%s_%s' % (permission_type, model._meta.object_name.lower())",
            "        user.user_permissions.add(Permission.objects.get(codename=codename))",
            "",
            "    def _give_page_permission_rights(self, user):",
            "        self._give_permission(user, PagePermission, 'add')",
            "        self._give_permission(user, PagePermission, 'change')",
            "        self._give_permission(user, PagePermission, 'delete')",
            "",
            "    def _get_change_page_request(self, user, page):",
            "        return type('Request', (object,), {",
            "            'user': user,",
            "            'path': base.URL_CMS_PAGE_CHANGE % page.pk",
            "        })",
            "",
            "    def _give_cms_permissions(self, user, save=True):",
            "        for perm_type in ['add', 'change', 'delete']:",
            "            for model in [Page, Title]:",
            "                self._give_permission(user, model, perm_type, False)",
            "        gpp = GlobalPagePermission.objects.create(",
            "            user=user,",
            "            can_change=True,",
            "            can_delete=True,",
            "            can_change_advanced_settings=False,",
            "            can_publish=True,",
            "            can_change_permissions=False,",
            "            can_move_page=True,",
            "        )",
            "        gpp.sites = Site.objects.all()",
            "        if save:",
            "            user.save()",
            "",
            "    def _create_plugin(self):",
            "        plugin = add_plugin(self._placeholder, 'TextPlugin', 'en')",
            "        return plugin",
            "",
            "    def test_plugin_add_requires_permissions(self):",
            "        \"\"\"User tries to add a plugin but has no permissions. He can add the plugin after he got the permissions\"\"\"",
            "        admin = self._get_admin()",
            "        self._give_cms_permissions(admin)",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        data = {",
            "            'plugin_type': 'TextPlugin',",
            "            'placeholder_id': self._placeholder.pk,",
            "            'plugin_language': 'en',",
            "            'plugin_parent': '',",
            "        }",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        self._give_permission(admin, Text, 'add')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugin_edit_requires_permissions(self):",
            "        \"\"\"User tries to edit a plugin but has no permissions. He can edit the plugin after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_edit_plugin', args=[plugin.id])",
            "        response = self.client.post(url, dict())",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'change')",
            "        response = self.client.post(url, dict())",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugin_edit_wrong_url(self):",
            "        \"\"\"User tries to edit a plugin using a random url. 404 response returned\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        self._give_permission(normal_guy, Text, 'change')",
            "        url = '%s/edit-plugin/%s/' % (admin_reverse('cms_page_edit_plugin', args=[plugin.id]), plugin.id)",
            "        response = self.client.post(url, dict())",
            "        self.assertEqual(response.status_code, HttpResponseNotFound.status_code)",
            "        self.assertTrue(\"Plugin not found\" in force_unicode(response.content))",
            "",
            "    def test_plugin_remove_requires_permissions(self):",
            "        \"\"\"User tries to remove a plugin but has no permissions. He can remove the plugin after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_delete_plugin', args=[plugin.pk])",
            "        data = dict(plugin_id=plugin.id)",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'delete')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, 302)",
            "",
            "    def test_plugin_move_requires_permissions(self):",
            "        \"\"\"User tries to move a plugin but has no permissions. He can move the plugin after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_move_plugin')",
            "        data = dict(plugin_id=plugin.id,",
            "                    placeholder_id=self._placeholder.pk,",
            "                    plugin_parent='',",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'change')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugins_copy_requires_permissions(self):",
            "        \"\"\"User tries to copy plugin but has no permissions. He can copy plugins after he got the permissions\"\"\"",
            "        plugin = self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "        else:",
            "            self.client.login(username='test', password='test')",
            "",
            "        url = admin_reverse('cms_page_copy_plugins')",
            "        data = dict(source_plugin_id=plugin.id,",
            "                    source_placeholder_id=self._placeholder.pk,",
            "                    source_language='en',",
            "                    target_language='fr',",
            "                    target_placeholder_id=self._placeholder.pk,",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'add')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugins_copy_placeholder_ref(self):",
            "        \"\"\"User copies a placeholder into a clipboard. A PlaceholderReferencePlugin is created. Afterwards he copies this",
            "         into a placeholder and the PlaceholderReferencePlugin unpacks its content. After that he clear the clipboard\"\"\"",
            "        self.assertEqual(Placeholder.objects.count(), 2)",
            "        self._create_plugin()",
            "        self._create_plugin()",
            "        admin_user = self.get_superuser()",
            "        clipboard = Placeholder()",
            "        clipboard.save()",
            "        self.assertEqual(CMSPlugin.objects.count(), 2)",
            "        settings = UserSettings(language=\"fr\", clipboard=clipboard, user=admin_user)",
            "        settings.save()",
            "        self.assertEqual(Placeholder.objects.count(), 3)",
            "",
            "        if get_user_model().USERNAME_FIELD == 'email':",
            "            self.client.login(username='admin@django-cms.org', password='admin@django-cms.org')",
            "        else:",
            "            self.client.login(username='admin', password='admin')",
            "",
            "        url = admin_reverse('cms_page_copy_plugins')",
            "        data = dict(source_plugin_id='',",
            "                    source_placeholder_id=self._placeholder.pk,",
            "                    source_language='en',",
            "                    target_language='en',",
            "                    target_placeholder_id=clipboard.pk,",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        clipboard_plugins = clipboard.get_plugins()",
            "        self.assertEqual(CMSPlugin.objects.count(), 5)",
            "        self.assertEqual(clipboard_plugins.count(), 1)",
            "        self.assertEqual(clipboard_plugins[0].plugin_type, \"PlaceholderPlugin\")",
            "        placeholder_plugin, _ = clipboard_plugins[0].get_plugin_instance()",
            "        ref_placeholder = placeholder_plugin.placeholder_ref",
            "        copied_plugins = ref_placeholder.get_plugins()",
            "        self.assertEqual(copied_plugins.count(), 2)",
            "        data = dict(source_plugin_id=placeholder_plugin.pk,",
            "                    source_placeholder_id=clipboard.pk,",
            "                    source_language='en',",
            "                    target_language='fr',",
            "                    target_placeholder_id=self._placeholder.pk,",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        plugins = self._placeholder.get_plugins()",
            "        self.assertEqual(plugins.count(), 4)",
            "        self.assertEqual(CMSPlugin.objects.count(), 7)",
            "        self.assertEqual(Placeholder.objects.count(), 4)",
            "        url = admin_reverse('cms_page_clear_placeholder', args=[clipboard.pk])",
            "        with self.assertNumQueries(FuzzyInt(70, 80)):",
            "            response = self.client.post(url, {'test': 0})",
            "        self.assertEqual(response.status_code, 302)",
            "        self.assertEqual(CMSPlugin.objects.count(), 4)",
            "        self.assertEqual(Placeholder.objects.count(), 3)",
            "",
            "    def test_plugins_copy_language(self):",
            "        \"\"\"User tries to copy plugin but has no permissions. He can copy plugins after he got the permissions\"\"\"",
            "        self._create_plugin()",
            "        _, normal_guy = self._get_guys()",
            "",
            "        if get_user_model().USERNAME_FIELD != 'email':",
            "            self.client.login(username='test', password='test')",
            "        else:",
            "            self.client.login(username='test@test.com', password='test@test.com')",
            "",
            "        self.assertEqual(1, CMSPlugin.objects.all().count())",
            "        url = admin_reverse('cms_page_copy_language', args=[self._page.pk])",
            "        data = dict(",
            "            source_language='en',",
            "            target_language='fr',",
            "        )",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "        # After he got the permissions, he can edit the plugin",
            "        self._give_permission(normal_guy, Text, 'add')",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        self.assertEqual(2, CMSPlugin.objects.all().count())",
            "",
            "    def test_page_permission_inline_visibility(self):",
            "        User = get_user_model()",
            "",
            "        fields = dict(email='user@domain.com', password='user', is_staff=True)",
            "",
            "        if get_user_model().USERNAME_FIELD != 'email':",
            "            fields[get_user_model().USERNAME_FIELD] = 'user'",
            "",
            "        user = User(**fields)",
            "        user.save()",
            "        self._give_page_permission_rights(user)",
            "        page = create_page('A', 'nav_playground.html', 'en')",
            "        page_permission = PagePermission.objects.create(",
            "            can_change_permissions=True, user=user, page=page)",
            "        request = self._get_change_page_request(user, page)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        # user has can_change_permission",
            "        # => must see the PagePermissionInline",
            "        self.assertTrue(",
            "            any(type(inline) is PagePermissionInlineAdmin",
            "                for inline in page_admin.get_inline_instances(request,",
            "                                                              page if not DJANGO_1_4 else None)))",
            "",
            "        page = Page.objects.get(pk=page.pk)",
            "        # remove can_change_permission",
            "        page_permission.can_change_permissions = False",
            "        page_permission.save()",
            "        request = self._get_change_page_request(user, page)",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "        # => PagePermissionInline is no longer visible",
            "        self.assertFalse(",
            "            any(type(inline) is PagePermissionInlineAdmin",
            "                for inline in page_admin.get_inline_instances(request, page if not DJANGO_1_4 else None)))",
            "",
            "    def test_edit_title_is_allowed_for_staff_user(self):",
            "        \"\"\"",
            "        We check here both the permission on a single page, and the global permissions",
            "        \"\"\"",
            "        user = self._create_user('user', is_staff=True)",
            "        another_user = self._create_user('another_user', is_staff=True)",
            "",
            "        page = create_page('A', 'nav_playground.html', 'en')",
            "        admin_url = reverse(\"admin:cms_page_edit_title_fields\", args=(",
            "            page.pk, 'en'",
            "        ))",
            "        page_admin = PageAdmin(Page, None)",
            "        page_admin._current_page = page",
            "",
            "        username = getattr(user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password=username)",
            "        response = self.client.get(admin_url)",
            "        self.assertEqual(response.status_code, HttpResponseForbidden.status_code)",
            "",
            "        assign_user_to_page(page, user, grant_all=True)",
            "        username = getattr(user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password=username)",
            "        response = self.client.get(admin_url)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "        self._give_cms_permissions(another_user)",
            "        username = getattr(another_user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password=username)",
            "        response = self.client.get(admin_url)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "",
            "    def test_plugin_add_returns_valid_pk_for_plugin(self):",
            "        admin_user = self._get_admin()",
            "        self._give_cms_permissions(admin_user)",
            "        self._give_permission(admin_user, Text, 'add')",
            "",
            "        username = getattr(admin_user, get_user_model().USERNAME_FIELD)",
            "        self.client.login(username=username, password='admin')",
            "",
            "        url = admin_reverse('cms_page_add_plugin')",
            "        data = {",
            "            'plugin_type': 'TextPlugin',",
            "            'placeholder_id': self._placeholder.pk,",
            "            'plugin_language': 'en',",
            "            'plugin_parent': '',",
            "        }",
            "        response = self.client.post(url, data)",
            "        self.assertEqual(response.status_code, HttpResponse.status_code)",
            "        self.assertEqual(response['content-type'], 'application/json')",
            "        pk = response.content.decode('utf8').split(\"edit-plugin/\")[1].split(\"/\")[0]",
            "        self.assertTrue(CMSPlugin.objects.filter(pk=int(pk)).exists())",
            "",
            "",
            "class AdminFormsTests(AdminTestsBase):",
            "    def test_clean_overwrite_url(self):",
            "        user = AnonymousUser()",
            "        user.is_superuser = True",
            "        user.pk = 1",
            "        request = type('Request', (object,), {'user': user})",
            "        with SettingsOverride():",
            "            data = {",
            "                'title': 'TestPage',",
            "                'slug': 'test-page',",
            "                'language': 'en',",
            "                'overwrite_url': '/overwrite/url/',",
            "                'site': Site.objects.get_current().pk,",
            "                'template': get_cms_setting('TEMPLATES')[0][0],",
            "                'published': True",
            "            }",
            "",
            "            form = PageForm(data)",
            "            self.assertTrue(form.is_valid(), form.errors.as_text())",
            "            # WTF? WHY DOES form.save() not handle this stuff???",
            "            instance = form.save()",
            "            instance.permission_user_cache = user",
            "            instance.permission_advanced_settings_cache = True",
            "            Title.objects.set_or_create(request, instance, form, 'en')",
            "            form = PageForm(data, instance=instance)",
            "            self.assertTrue(form.is_valid(), form.errors.as_text())",
            "",
            "    def test_missmatching_site_parent_dotsite(self):",
            "        site0 = Site.objects.create(domain='foo.com', name='foo.com')",
            "        site1 = Site.objects.create(domain='foo.com', name='foo.com')",
            "        parent_page = Page.objects.create(",
            "            template='nav_playground.html',",
            "            site=site0)",
            "        new_page_data = {",
            "            'title': 'Title',",
            "            'slug': 'slug',",
            "            'language': 'en',",
            "            'site': site1.pk,",
            "            'template': get_cms_setting('TEMPLATES')[0][0],",
            "            'reverse_id': '',",
            "            'parent': parent_page.pk,",
            "        }",
            "        form = PageForm(data=new_page_data, files=None)",
            "        self.assertFalse(form.is_valid())",
            "        self.assertIn(u\"Site doesn't match the parent's page site\",",
            "                      form.errors['__all__'])",
            "",
            "    def test_reverse_id_error_location(self):",
            "        ''' Test moving the reverse_id validation error to a field specific one '''",
            "",
            "        # this is the Reverse ID we'll re-use to break things.",
            "        dupe_id = 'p1'",
            "        curren_site = Site.objects.get_current()",
            "        create_page('Page 1', 'nav_playground.html', 'en', reverse_id=dupe_id)",
            "        page2 = create_page('Page 2', 'nav_playground.html', 'en')",
            "        # Assemble a bunch of data to test the page form",
            "        page2_data = {",
            "            'language': 'en',",
            "            'site': curren_site.pk,",
            "            'reverse_id': dupe_id,",
            "            'template': 'col_two.html',",
            "        }",
            "        form = AdvancedSettingsForm(data=page2_data, files=None)",
            "        self.assertFalse(form.is_valid())",
            "",
            "        # reverse_id is the only item that is in __all__ as every other field",
            "        # has it's own clean method. Moving it to be a field error means",
            "        # __all__ is now not available.",
            "        self.assertNotIn('__all__', form.errors)",
            "        # In moving it to it's own field, it should be in form.errors, and",
            "        # the values contained therein should match these.",
            "        self.assertIn('reverse_id', form.errors)",
            "        self.assertEqual(1, len(form.errors['reverse_id']))",
            "        self.assertEqual([u'A page with this reverse URL id exists already.'],",
            "                         form.errors['reverse_id'])",
            "        page2_data['reverse_id'] = \"\"",
            "",
            "        form = AdvancedSettingsForm(data=page2_data, files=None)",
            "        self.assertTrue(form.is_valid())",
            "        admin_user = self._get_guys(admin_only=True)",
            "        # reset some of page2_data so we can use cms.api.create_page",
            "        page2 = page2.reload()",
            "        page2.site = curren_site",
            "        page2.save()",
            "        with self.login_user_context(admin_user):",
            "            # re-reset the page2_data for the admin form instance.",
            "            page2_data['reverse_id'] = dupe_id",
            "            page2_data['site'] = curren_site.pk",
            "",
            "            # post to the admin change form for page 2, and test that the",
            "            # reverse_id form row has an errors class. Django's admin avoids",
            "            # collapsing these, so that the error is visible.",
            "            resp = self.client.post(base.URL_CMS_PAGE_ADVANCED_CHANGE % page2.pk, page2_data)",
            "            self.assertContains(resp, '<div class=\"form-row errors reverse_id\">')",
            "",
            "    def test_create_page_type(self):",
            "        page = create_page('Test', 'static.html', 'en', published=True, reverse_id=\"home\")",
            "        for placeholder in Placeholder.objects.all():",
            "            add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "        page.publish('en')",
            "        self.assertEqual(Page.objects.count(), 2)",
            "        self.assertEqual(CMSPlugin.objects.count(), 4)",
            "        superuser = self.get_superuser()",
            "        with self.login_user_context(superuser):",
            "            response = self.client.get(",
            "                \"%s?copy_target=%s&language=%s\" % (admin_reverse(\"cms_page_add_page_type\"), page.pk, 'en'))",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(Page.objects.count(), 3)",
            "            self.assertEqual(Page.objects.filter(reverse_id=\"page_types\").count(), 1)",
            "            page_types = Page.objects.get(reverse_id='page_types')",
            "            url = response.url if hasattr(response, 'url') else response['Location']",
            "            expected_url_params = QueryDict(",
            "                'target=%s&position=first-child&add_page_type=1&copy_target=%s&language=en' % (page_types.pk, page.pk))",
            "            response_url_params = QueryDict(urlparse(url).query)",
            "            self.assertDictEqual(expected_url_params, response_url_params)",
            "            response = self.client.get(\"%s?copy_target=%s&language=%s\" % (",
            "                admin_reverse(\"cms_page_add_page_type\"), page.pk, 'en'), follow=True)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "            # test no page types if no page types there",
            "            response = self.client.get(admin_reverse('cms_page_add'))",
            "            self.assertNotContains(response, \"page_type\")",
            "            # create out first page type",
            "            page_data = {",
            "                'title': 'type1', 'slug': 'type1', '_save': 1, 'template': 'static.html', 'site': 1,",
            "                'language': 'en'",
            "            }",
            "            response = self.client.post(",
            "                \"/en/admin/cms/page/add/?target=%s&position=first-child&add_page_type=1&copy_target=%s&language=en\" % (",
            "                    page_types.pk, page.pk), data=page_data)",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(Page.objects.count(), 4)",
            "            self.assertEqual(CMSPlugin.objects.count(), 6)",
            "            response = self.client.get(admin_reverse('cms_page_add'))",
            "            self.assertContains(response, \"page_type\")",
            "            # no page types available if you use the copy_target",
            "            response = self.client.get(\"%s?copy_target=%s&language=en\" % (admin_reverse('cms_page_add'), page.pk))",
            "            self.assertNotContains(response, \"page_type\")",
            "",
            "    def test_render_edit_mode(self):",
            "        from django.core.cache import cache",
            "",
            "        cache.clear()",
            "        create_page('Test', 'static.html', 'en', published=True)",
            "        for placeholder in Placeholder.objects.all():",
            "            add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "",
            "        user = self.get_superuser()",
            "        self.assertEqual(Placeholder.objects.all().count(), 4)",
            "        with self.login_user_context(user):",
            "            with self.assertNumQueries(FuzzyInt(40, 66)):",
            "                output = force_unicode(self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')).content)",
            "            self.assertIn('<b>Test</b>', output)",
            "            self.assertEqual(Placeholder.objects.all().count(), 9)",
            "            self.assertEqual(StaticPlaceholder.objects.count(), 2)",
            "            for placeholder in Placeholder.objects.all():",
            "                add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "            with self.assertNumQueries(FuzzyInt(40, 60)):",
            "                output = force_unicode(self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')).content)",
            "            self.assertIn('<b>Test</b>', output)",
            "        with self.assertNumQueries(FuzzyInt(18, 48)):",
            "            force_unicode(self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON')).content)",
            "        with self.assertNumQueries(FuzzyInt(12, 30)):",
            "            force_unicode(self.client.get('/en/').content)",
            "",
            "    def test_tree_view_queries(self):",
            "        from django.core.cache import cache",
            "",
            "        cache.clear()",
            "        for i in range(10):",
            "            create_page('Test%s' % i, 'col_two.html', 'en', published=True)",
            "        for placeholder in Placeholder.objects.all():",
            "            add_plugin(placeholder, TextPlugin, 'en', body='<b>Test</b>')",
            "",
            "        user = self.get_superuser()",
            "        with self.login_user_context(user):",
            "            with self.assertNumQueries(FuzzyInt(18, 33)):",
            "                force_unicode(self.client.get('/en/admin/cms/page/'))",
            "",
            "    def test_smart_link_published_pages(self):",
            "        admin, staff_guy = self._get_guys()",
            "        page_url = '/en/admin/cms/page/published-pages/' # Not sure how to achieve this with reverse...",
            "",
            "        with self.login_user_context(staff_guy):",
            "            multi_title_page = create_page('main_title', 'col_two.html', 'en', published=True,",
            "                                           overwrite_url='overwritten_url',",
            "                                           menu_title='menu_title')",
            "",
            "            title = multi_title_page.get_title_obj()",
            "            title.page_title = 'page_title'",
            "            title.save()",
            "",
            "            multi_title_page.save()",
            "            publish_page(multi_title_page, admin, 'en')",
            "",
            "            # Non ajax call should return a 403 as this page shouldn't be accessed by anything else but ajax queries",
            "            self.assertEqual(403, self.client.get(page_url).status_code)",
            "",
            "            self.assertEqual(200,",
            "                             self.client.get(page_url, HTTP_X_REQUESTED_WITH='XMLHttpRequest').status_code",
            "            )",
            "",
            "            # Test that the query param is working as expected.",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'main_title'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'menu_title'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'overwritten_url'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "            self.assertEqual(1, len(json.loads(self.client.get(page_url, {'q':'page_title'},",
            "                                                    HTTP_X_REQUESTED_WITH='XMLHttpRequest').content.decode(\"utf-8\"))))",
            "",
            "",
            "class AdminPageEditContentSizeTests(AdminTestsBase):",
            "    \"\"\"",
            "    System user count influences the size of the page edit page,",
            "    but the users are only 2 times present on the page",
            "",
            "    The test relates to extra=0",
            "    at PagePermissionInlineAdminForm and ViewRestrictionInlineAdmin",
            "    \"\"\"",
            "",
            "    def test_editpage_contentsize(self):",
            "        \"\"\"",
            "        Expected a username only 2 times in the content, but a relationship",
            "        between usercount and pagesize",
            "        \"\"\"",
            "        with SettingsOverride(CMS_PERMISSION=True):",
            "            admin_user = self.get_superuser()",
            "            PAGE_NAME = 'TestPage'",
            "            USER_NAME = 'test_size_user_0'",
            "            current_site = Site.objects.get(pk=1)",
            "            page = create_page(PAGE_NAME, \"nav_playground.html\", \"en\", site=current_site, created_by=admin_user)",
            "            page.save()",
            "            self._page = page",
            "            with self.login_user_context(admin_user):",
            "                url = base.URL_CMS_PAGE_PERMISSION_CHANGE % self._page.pk",
            "                response = self.client.get(url)",
            "                self.assertEqual(response.status_code, 200)",
            "                old_response_size = len(response.content)",
            "                old_user_count = get_user_model().objects.count()",
            "                # create additionals user and reload the page",
            "                get_user_model().objects.create_user(username=USER_NAME, email=USER_NAME + '@django-cms.org',",
            "                                                     password=USER_NAME)",
            "                user_count = get_user_model().objects.count()",
            "                more_users_in_db = old_user_count < user_count",
            "                # we have more users",
            "                self.assertTrue(more_users_in_db, \"New users got NOT created\")",
            "                response = self.client.get(url)",
            "                new_response_size = len(response.content)",
            "                page_size_grown = old_response_size < new_response_size",
            "                # expect that the pagesize gets influenced by the useramount of the system",
            "                self.assertTrue(page_size_grown, \"Page size has not grown after user creation\")",
            "                # usernames are only 2 times in content",
            "                text = smart_str(response.content, response._charset)",
            "",
            "                foundcount = text.count(USER_NAME)",
            "                # 2 forms contain usernames as options",
            "                self.assertEqual(foundcount, 2,",
            "                                 \"Username %s appeared %s times in response.content, expected 2 times\" % (",
            "                                     USER_NAME, foundcount))"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "0",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "707": [
                "AdminTests",
                "test_change_publish_unpublish"
            ],
            "713": [
                "AdminTests",
                "test_change_publish_unpublish"
            ],
            "809": [
                "AdminTests",
                "test_revert_page_redirects"
            ]
        },
        "addLocation": []
    },
    "cms/tests/publisher.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 342,
                "afterPatchRowNumber": 342,
                "PatchRowcode": "         self.assertEqual(Page.objects.all().count(), 1)"
            },
            "1": {
                "beforePatchRowNumber": 343,
                "afterPatchRowNumber": 343,
                "PatchRowcode": "         superuser = self.get_superuser()"
            },
            "2": {
                "beforePatchRowNumber": 344,
                "afterPatchRowNumber": 344,
                "PatchRowcode": "         with self.login_user_context(superuser):"
            },
            "3": {
                "beforePatchRowNumber": 345,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            response = self.client.get(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 345,
                "PatchRowcode": "+            response = self.client.post(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))"
            },
            "5": {
                "beforePatchRowNumber": 346,
                "afterPatchRowNumber": 346,
                "PatchRowcode": "             self.assertEqual(response.status_code, 302)"
            },
            "6": {
                "beforePatchRowNumber": 347,
                "afterPatchRowNumber": 347,
                "PatchRowcode": "             self.assertEqual(response['Location'], \"http://testserver/en/?%s\" % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))"
            },
            "7": {
                "beforePatchRowNumber": 348,
                "afterPatchRowNumber": 348,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 381,
                "afterPatchRowNumber": 381,
                "PatchRowcode": "         page = self.create_page(\"test_admin\", published=False)"
            },
            "9": {
                "beforePatchRowNumber": 382,
                "afterPatchRowNumber": 382,
                "PatchRowcode": "         superuser = self.get_superuser()"
            },
            "10": {
                "beforePatchRowNumber": 383,
                "afterPatchRowNumber": 383,
                "PatchRowcode": "         with self.login_user_context(superuser):"
            },
            "11": {
                "beforePatchRowNumber": 384,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            response = self.client.get(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 384,
                "PatchRowcode": "+            response = self.client.post(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))"
            },
            "13": {
                "beforePatchRowNumber": 385,
                "afterPatchRowNumber": 385,
                "PatchRowcode": "             self.assertEqual(response.status_code, 302)"
            },
            "14": {
                "beforePatchRowNumber": 386,
                "afterPatchRowNumber": 386,
                "PatchRowcode": "         page = Page.objects.get(pk=page.pk)"
            },
            "15": {
                "beforePatchRowNumber": 387,
                "afterPatchRowNumber": 387,
                "PatchRowcode": " "
            },
            "16": {
                "beforePatchRowNumber": 396,
                "afterPatchRowNumber": 396,
                "PatchRowcode": "             ):"
            },
            "17": {
                "beforePatchRowNumber": 397,
                "afterPatchRowNumber": 397,
                "PatchRowcode": "             with self.login_user_context(superuser):"
            },
            "18": {
                "beforePatchRowNumber": 398,
                "afterPatchRowNumber": 398,
                "PatchRowcode": "                 with force_language('de'):"
            },
            "19": {
                "beforePatchRowNumber": 399,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    response = self.client.get(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 399,
                "PatchRowcode": "+                    response = self.client.post(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))"
            },
            "21": {
                "beforePatchRowNumber": 400,
                "afterPatchRowNumber": 400,
                "PatchRowcode": "         self.assertEqual(response.status_code, 302)"
            },
            "22": {
                "beforePatchRowNumber": 401,
                "afterPatchRowNumber": 401,
                "PatchRowcode": "         page = Page.objects.get(pk=page.pk)"
            },
            "23": {
                "beforePatchRowNumber": 402,
                "afterPatchRowNumber": 402,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from __future__ import with_statement",
            "from django.contrib.sites.models import Site",
            "from cms.utils.urlutils import admin_reverse",
            "",
            "from djangocms_text_ckeditor.models import Text",
            "from django.core.cache import cache",
            "from django.core.management.base import CommandError",
            "from django.core.management import call_command",
            "from django.core.urlresolvers import reverse",
            "",
            "from cms.api import create_page, add_plugin, create_title",
            "from cms.constants import PUBLISHER_STATE_PENDING, PUBLISHER_STATE_DEFAULT, PUBLISHER_STATE_DIRTY",
            "from cms.management.commands import publisher_publish",
            "from cms.models import CMSPlugin, Title",
            "from cms.models.pagemodel import Page",
            "from cms.plugin_pool import plugin_pool",
            "from cms.test_utils.testcases import SettingsOverrideTestCase as TestCase",
            "from cms.test_utils.util.context_managers import StdoutOverride, SettingsOverride",
            "from cms.test_utils.util.fuzzy_int import FuzzyInt",
            "from cms.utils.conf import get_cms_setting",
            "from cms.utils.i18n import force_language",
            "from cms.utils.compat.dj import get_user_model",
            "",
            "",
            "class PublisherCommandTests(TestCase):",
            "    \"\"\"",
            "    Tests for the publish command",
            "    \"\"\"",
            "",
            "    def test_command_line_should_raise_without_superuser(self):",
            "        with self.assertRaises(CommandError):",
            "            com = publisher_publish.Command()",
            "            com.handle_noargs()",
            "",
            "    def test_command_line_publishes_zero_pages_on_empty_db(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 0)",
            "        self.assertEqual(published_from_output, 0)",
            "",
            "    def test_command_line_ignores_draft_page(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=False)",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 0)",
            "        self.assertEqual(published_from_output, 0)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 0)",
            "",
            "    def test_command_line_publishes_draft_page(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=False)",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', include_unpublished=True)",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 1)",
            "",
            "    def test_command_line_publishes_selected_language(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        page = create_page(\"en title\", \"nav_playground.html\", \"en\")",
            "        title = create_title('de', 'de title', page)",
            "        title.published = True",
            "        title.save()",
            "        title = create_title('fr', 'fr title', page)",
            "        title.published = True",
            "        title.save()",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', language='de')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 1)",
            "        public = Page.objects.public()[0]",
            "        languages = sorted(public.title_set.values_list('language', flat=True))",
            "        self.assertEqual(languages, ['de'])",
            "",
            "    def test_command_line_publishes_selected_language_drafts(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        page = create_page(\"en title\", \"nav_playground.html\", \"en\")",
            "        title = create_title('de', 'de title', page)",
            "        title.published = False",
            "        title.save()",
            "        title = create_title('fr', 'fr title', page)",
            "        title.published = False",
            "        title.save()",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', language='de', include_unpublished=True)",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 1)",
            "        public = Page.objects.public()[0]",
            "        languages = sorted(public.title_set.values_list('language', flat=True))",
            "        self.assertEqual(languages, ['de'])",
            "",
            "    def test_table_name_patching(self):",
            "        \"\"\"",
            "        This tests the plugin models patching when publishing from the command line",
            "        \"\"\"",
            "        User = get_user_model()",
            "        User.objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=True)",
            "        draft = Page.objects.drafts()[0]",
            "        draft.reverse_id = 'a_test' # we have to change *something*",
            "        draft.save()",
            "        add_plugin(draft.placeholders.get(slot=u\"body\"),",
            "                   u\"TextPlugin\", u\"en\", body=\"Test content\")",
            "        draft.publish('en')",
            "        add_plugin(draft.placeholders.get(slot=u\"body\"),",
            "                   u\"TextPlugin\", u\"en\", body=\"Test content\")",
            "",
            "        # Manually undoing table name patching",
            "        Text._meta.db_table = 'djangocms_text_ckeditor_text'",
            "        plugin_pool.patched = False",
            "",
            "        with StdoutOverride():",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "        not_drafts = len(Page.objects.filter(publisher_is_draft=False))",
            "        drafts = len(Page.objects.filter(publisher_is_draft=True))",
            "        self.assertEqual(not_drafts, 1)",
            "        self.assertEqual(drafts, 1)",
            "",
            "    def test_command_line_publishes_one_page(self):",
            "        \"\"\"",
            "        Publisher always creates two Page objects for every CMS page,",
            "        one is_draft and one is_public.",
            "",
            "        The public version of the page can be either published or not.",
            "",
            "        This bit of code uses sometimes manager methods and sometimes manual",
            "        filters on purpose (this helps test the managers)",
            "        \"\"\"",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        # Now, let's create a page. That actually creates 2 Page objects",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=True)",
            "        draft = Page.objects.drafts()[0]",
            "        draft.reverse_id = 'a_test' # we have to change *something*",
            "        draft.save()",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "        # Sanity check the database (we should have one draft and one public)",
            "        not_drafts = len(Page.objects.filter(publisher_is_draft=False))",
            "        drafts = len(Page.objects.filter(publisher_is_draft=True))",
            "        self.assertEqual(not_drafts, 1)",
            "        self.assertEqual(drafts, 1)",
            "",
            "        # Now check that the non-draft has the attribute we set to the draft.",
            "        non_draft = Page.objects.public()[0]",
            "        self.assertEqual(non_draft.reverse_id, 'a_test')",
            "",
            "    def test_command_line_publish_multiple_languages(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        # Create a draft page with two published titles",
            "        page = create_page(u\"The page!\", \"nav_playground.html\", \"en\", published=False)",
            "        title = create_title('de', 'ja', page)",
            "        title.published = True",
            "        title.save()",
            "        title = create_title('fr', 'non', page)",
            "        title.published = True",
            "        title.save()",
            "",
            "        with StdoutOverride():",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "",
            "        public = Page.objects.public()[0]",
            "        languages = sorted(public.title_set.values_list('language', flat=True))",
            "        self.assertEqual(languages, ['de', 'fr'])",
            "",
            "    def test_command_line_publish_one_site(self):",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        siteA = Site.objects.create(domain='a.example.com', name='a.example.com')",
            "        siteB = Site.objects.create(domain='b.example.com', name='b.example.com')",
            "",
            "        #example.com",
            "        create_page(u\"example.com homepage\", \"nav_playground.html\", \"en\", published=True)",
            "        #a.example.com",
            "        create_page(u\"a.example.com homepage\", \"nav_playground.html\", \"de\", site=siteA, published=True)",
            "        #b.example.com",
            "        create_page(u\"b.example.com homepage\", \"nav_playground.html\", \"de\", site=siteB, published=True)",
            "        create_page(u\"b.example.com about\", \"nav_playground.html\", \"nl\", site=siteB, published=True)",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', site=siteB.id)",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 2)",
            "        self.assertEqual(published_from_output, 2)",
            "",
            "    def test_command_line_publish_multiple_languages_check_count(self):",
            "        \"\"\"",
            "        Publishing one page with multiple languages still counts",
            "        as one page. This test case checks whether it works",
            "        as expected.",
            "        \"\"\"",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        # Now, let's create a page with 2 languages.",
            "        page = create_page(\"en title\", \"nav_playground.html\", \"en\", published=True)",
            "        create_title(\"de\", \"de title\", page)",
            "        page.publish(\"de\")",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "    def tearDown(self):",
            "        plugin_pool.patched = False",
            "        plugin_pool.set_plugin_meta()",
            "",
            "",
            "class PublishingTests(TestCase):",
            "    def create_page(self, title=None, **kwargs):",
            "        return create_page(title or self._testMethodName,",
            "                           \"nav_playground.html\", \"en\", **kwargs)",
            "",
            "    def test_publish_home(self):",
            "        name = self._testMethodName",
            "        page = self.create_page(name, published=False)",
            "        self.assertFalse(page.publisher_public_id)",
            "        self.assertEqual(Page.objects.all().count(), 1)",
            "        superuser = self.get_superuser()",
            "        with self.login_user_context(superuser):",
            "            response = self.client.get(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'], \"http://testserver/en/?%s\" % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "",
            "    def test_publish_single(self):",
            "        name = self._testMethodName",
            "        page = self.create_page(name, published=False)",
            "        self.assertFalse(page.is_published('en'))",
            "",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published(\"en\")",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectDoesNotExist(public, title_set__title=name)",
            "        self.assertObjectDoesNotExist(published, title_set__title=name)",
            "",
            "        page.publish(\"en\")",
            "",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published(\"en\")",
            "",
            "        self.assertTrue(page.is_published('en'))",
            "        self.assertEqual(page.get_publisher_state(\"en\"), PUBLISHER_STATE_DEFAULT)",
            "        self.assertIsNotNone(page.publisher_public)",
            "        self.assertTrue(page.publisher_public_id)",
            "",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectExist(public, title_set__title=name)",
            "        self.assertObjectExist(published, title_set__title=name)",
            "",
            "        page = Page.objects.get(pk=page.pk)",
            "",
            "        self.assertEqual(page.get_publisher_state(\"en\"), 0)",
            "",
            "    def test_publish_admin(self):",
            "        page = self.create_page(\"test_admin\", published=False)",
            "        superuser = self.get_superuser()",
            "        with self.login_user_context(superuser):",
            "            response = self.client.get(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))",
            "            self.assertEqual(response.status_code, 302)",
            "        page = Page.objects.get(pk=page.pk)",
            "",
            "        self.assertEqual(page.get_publisher_state('en'), 0)",
            "",
            "    def test_publish_wrong_lang(self):",
            "        page = self.create_page(\"test_admin\", published=False)",
            "        superuser = self.get_superuser()",
            "        with SettingsOverride(",
            "                LANGUAGES=(('de', 'de'), ('en', 'en')),",
            "                CMS_LANGUAGES={1: [{'code': 'en', 'name': 'en', 'fallbacks': ['fr', 'de'], 'public': True}]}",
            "            ):",
            "            with self.login_user_context(superuser):",
            "                with force_language('de'):",
            "                    response = self.client.get(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))",
            "        self.assertEqual(response.status_code, 302)",
            "        page = Page.objects.get(pk=page.pk)",
            "",
            "    def test_publish_child_first(self):",
            "        parent = self.create_page('parent', published=False)",
            "        child = self.create_page('child', published=False, parent=parent)",
            "        parent = parent.reload()",
            "        self.assertFalse(parent.is_published('en'))",
            "        self.assertFalse(child.is_published('en'))",
            "",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published('en')",
            "",
            "        for name in ('parent', 'child'):",
            "            self.assertObjectExist(drafts, title_set__title=name)",
            "            self.assertObjectDoesNotExist(public, title_set__title=name)",
            "            self.assertObjectDoesNotExist(published, title_set__title=name)",
            "",
            "        child.publish(\"en\")",
            "        child = child.reload()",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        self.assertIsNone(child.publisher_public)",
            "",
            "        # Since we have no parent, the state is otherwise unchanged",
            "        for name in ('parent', 'child'):",
            "            self.assertObjectExist(drafts, title_set__title=name)",
            "            self.assertObjectDoesNotExist(public, title_set__title=name)",
            "            self.assertObjectDoesNotExist(published, title_set__title=name)",
            "        parent.publish(\"en\")",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published('en')",
            "        # Cascade publish for all pending descendants",
            "        for name in ('parent', 'child'):",
            "            self.assertObjectExist(drafts, title_set__title=name)",
            "            page = drafts.get(title_set__title=name)",
            "            self.assertTrue(page.is_published(\"en\"), name)",
            "            self.assertEqual(page.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT, name)",
            "            self.assertIsNotNone(page.publisher_public, name)",
            "            self.assertTrue(page.publisher_public.is_published('en'), name)",
            "",
            "            self.assertObjectExist(public, title_set__title=name)",
            "            self.assertObjectExist(published, title_set__title=name)",
            "",
            "    def test_simple_publisher(self):",
            "        \"\"\"",
            "        Creates the stuff needed for these tests.",
            "        Please keep this up-to-date (the docstring!)",
            "",
            "                A",
            "               / \\",
            "              B  C",
            "        \"\"\"",
            "        # Create a simple tree of 3 pages",
            "        pageA = create_page(\"Page A\", \"nav_playground.html\", \"en\",",
            "                            published=True)",
            "        pageB = create_page(\"Page B\", \"nav_playground.html\", \"en\", parent=pageA,",
            "                            published=True)",
            "        pageC = create_page(\"Page C\", \"nav_playground.html\", \"en\", parent=pageA,",
            "                            published=False)",
            "        # Assert A and B are published, C unpublished",
            "        self.assertTrue(pageA.publisher_public_id)",
            "        self.assertTrue(pageB.publisher_public_id)",
            "        self.assertTrue(not pageC.publisher_public_id)",
            "        self.assertEqual(len(Page.objects.public().published(\"en\")), 2)",
            "",
            "        # Let's publish C now.",
            "        pageC.publish(\"en\")",
            "",
            "        # Assert all are published",
            "        self.assertTrue(pageA.publisher_public_id)",
            "        self.assertTrue(pageB.publisher_public_id)",
            "        self.assertTrue(pageC.publisher_public_id)",
            "        self.assertEqual(len(Page.objects.public().published(\"en\")), 3)",
            "",
            "    def test_i18n_publishing(self):",
            "        page = self.create_page('parent', published=True)",
            "        self.assertEqual(Title.objects.all().count(), 2)",
            "        create_title(\"de\", \"vater\", page)",
            "        self.assertEqual(Title.objects.all().count(), 3)",
            "        self.assertEqual(Title.objects.filter(published=True).count(), 2)",
            "        page.publish('de')",
            "        self.assertEqual(Title.objects.all().count(), 4)",
            "        self.assertEqual(Title.objects.filter(published=True).count(), 4)",
            "",
            "",
            "    def test_publish_ordering(self):",
            "        page = self.create_page('parent', published=True)",
            "        pageA = self.create_page('pageA', parent=page, published=True)",
            "        pageC = self.create_page('pageC', parent=page, published=True)",
            "        pageB = self.create_page('pageB', parent=page, published=True)",
            "        page = page.reload()",
            "        pageB.move_page(pageA, 'right')",
            "        pageB.publish(\"en\")",
            "        # pageC needs reload since B has swapped places with it",
            "        pageC.reload().publish(\"en\")",
            "        pageA.publish('en')",
            "",
            "        drafts = Page.objects.drafts().order_by('tree_id', 'lft')",
            "        draft_titles = [(p.get_title('en'), p.lft, p.rght) for p in drafts]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], draft_titles)",
            "        public = Page.objects.public().order_by('tree_id', 'lft')",
            "        public_titles = [(p.get_title('en'), p.lft, p.rght) for p in public]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], public_titles)",
            "",
            "        page.publish('en')",
            "",
            "        drafts = Page.objects.drafts().order_by('tree_id', 'lft')",
            "        draft_titles = [(p.get_title('en'), p.lft, p.rght) for p in drafts]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], draft_titles)",
            "        public = Page.objects.public().order_by('tree_id', 'lft')",
            "        public_titles = [(p.get_title('en'), p.lft, p.rght) for p in public]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], public_titles)",
            "",
            "    def test_publish_ordering2(self):",
            "        page = self.create_page('parent', published=False)",
            "        pageA = self.create_page('pageA', published=False)",
            "        pageC = self.create_page('pageC', published=False, parent=pageA)",
            "        pageB = self.create_page('pageB', published=False, parent=pageA)",
            "        page = page.reload()",
            "        pageA.publish('en')",
            "        pageB.publish('en')",
            "        pageC.publish('en')",
            "        page.publish('en')",
            "",
            "        drafts = Page.objects.filter(publisher_is_draft=True).order_by('tree_id', 'lft')",
            "        publics = Page.objects.filter(publisher_is_draft=False).order_by('tree_id', 'lft')",
            "",
            "        x = 0",
            "        for draft in drafts:",
            "            self.assertEqual(draft.publisher_public_id, publics[x].pk)",
            "            x += 1",
            "",
            "",
            "    def test_unpublish_unpublish(self):",
            "        name = self._testMethodName",
            "        page = self.create_page(name, published=True)",
            "        drafts = Page.objects.drafts()",
            "        published = Page.objects.public().published(\"en\")",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectExist(published, title_set__title=name)",
            "",
            "        page.unpublish('en')",
            "        self.assertFalse(page.is_published('en'))",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectDoesNotExist(published, title_set__title=name)",
            "",
            "        page.publish('en')",
            "        self.assertTrue(page.publisher_public_id)",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectExist(published, title_set__title=name)",
            "",
            "    def test_delete_title_unpublish(self):",
            "        page = self.create_page('test', published=True)",
            "        sub_page = self.create_page('test2', published=True, parent=page)",
            "        self.assertTrue(sub_page.publisher_public.is_published('en'))",
            "        page.title_set.all().delete()",
            "        self.assertFalse(sub_page.publisher_public.is_published('en', force_reload=True))",
            "",
            "    def test_modify_child_while_pending(self):",
            "        home = self.create_page(\"Home\", published=True, in_navigation=True)",
            "        child = self.create_page(\"Child\", published=True, parent=home,",
            "                                 in_navigation=False)",
            "        home = home.reload()",
            "        home.unpublish('en')",
            "        self.assertEqual(Title.objects.count(), 4)",
            "        child = child.reload()",
            "        self.assertFalse(child.publisher_public.is_published('en'))",
            "        self.assertFalse(child.in_navigation)",
            "        self.assertFalse(child.publisher_public.in_navigation)",
            "",
            "        child.in_navigation = True",
            "        child.save()",
            "        child.publish('en')",
            "        child = self.reload(child)",
            "        self.assertEqual(Title.objects.count(), 4)",
            "",
            "        self.assertTrue(child.is_published('en'))",
            "        self.assertFalse(child.publisher_public.is_published('en'))",
            "        self.assertTrue(child.in_navigation)",
            "        self.assertTrue(child.publisher_public.in_navigation)",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "",
            "        home.publish('en')",
            "        child = self.reload(child)",
            "        self.assertTrue(child.is_published('en'))",
            "        self.assertTrue(child.publisher_public_id)",
            "        self.assertTrue(child.publisher_public.in_navigation)",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "",
            "    def test_republish_with_descendants(self):",
            "        home = self.create_page(\"Home\", published=True)",
            "        child = self.create_page(\"Child\", published=True, parent=home)",
            "        gc = self.create_page(\"GC\", published=True, parent=child)",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertTrue(gc.is_published('en'))",
            "        home = home.reload()",
            "        home.unpublish('en')",
            "        child = self.reload(child)",
            "        gc = self.reload(gc)",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertTrue(gc.is_published(\"en\"))",
            "        self.assertFalse(child.publisher_public.is_published(\"en\"))",
            "        self.assertFalse(gc.publisher_public.is_published('en'))",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        self.assertEqual(gc.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "",
            "        home.publish('en')",
            "        child = self.reload(child)",
            "        gc = self.reload(gc)",
            "",
            "        self.assertTrue(child.publisher_public_id)",
            "        self.assertTrue(gc.is_published('en'))",
            "        self.assertTrue(child.is_published('en'))",
            "        self.assertTrue(gc.publisher_public_id)",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "        self.assertEqual(gc.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "",
            "    def test_republish_with_dirty_children(self):",
            "        home = self.create_page(\"Home\", published=True)",
            "        dirty1 = self.create_page(\"Dirty1\", published=True, parent=home)",
            "        dirty2 = self.create_page(\"Dirty2\", published=True, parent=home)",
            "        home = self.reload(home)",
            "        dirty1 = self.reload(dirty1)",
            "        dirty2 = self.reload(dirty2)",
            "        dirty1.in_navigation = True",
            "        dirty1.save()",
            "        home.unpublish('en')",
            "        dirty2.in_navigation = True",
            "        dirty2.save()",
            "        dirty1 = self.reload(dirty1)",
            "        dirty2 = self.reload(dirty2)",
            "        self.assertTrue(dirty1.is_published)",
            "        self.assertTrue(dirty2.publisher_public_id)",
            "        self.assertEqual(dirty1.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "        self.assertEqual(dirty2.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "",
            "        home = self.reload(home)",
            "        with self.assertNumQueries(FuzzyInt(0, 100)):",
            "            home.publish('en')",
            "        dirty1 = self.reload(dirty1)",
            "        dirty2 = self.reload(dirty2)",
            "        self.assertTrue(dirty1.is_published(\"en\"))",
            "        self.assertTrue(dirty2.is_published(\"en\"))",
            "        self.assertTrue(dirty1.publisher_public.is_published(\"en\"))",
            "        self.assertTrue(dirty2.publisher_public.is_published(\"en\"))",
            "        self.assertEqual(dirty1.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "        self.assertEqual(dirty2.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "",
            "    def test_republish_with_unpublished_child(self):",
            "        \"\"\"",
            "        Unpub1 was never published, and unpub2 has been unpublished after the",
            "        fact. None of the grandchildren should become published.",
            "        \"\"\"",
            "        home = self.create_page(\"Home\", published=True)",
            "        unpub1 = self.create_page(\"Unpub1\", published=False, parent=home)",
            "        unpub2 = self.create_page(\"Unpub2\", published=True, parent=home)",
            "        gc1 = self.create_page(\"GC1\", published=True, parent=unpub1)",
            "        gc2 = self.create_page(\"GC2\", published=True, parent=unpub2)",
            "        self.assertFalse(gc1.publisher_public_id)",
            "        self.assertFalse(gc1.publisher_public_id)",
            "        self.assertTrue(gc1.is_published('en'))",
            "        self.assertTrue(gc2.is_published('en'))",
            "        home.unpublish('en')",
            "        unpub1 = self.reload(unpub1)",
            "        unpub2.unpublish('en')  # Just marks this as not published",
            "        for page in (unpub1, unpub2):",
            "            self.assertFalse(page.is_published('en'), page)",
            "            self.assertEqual(page.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "        self.assertIsNone(unpub1.publisher_public)",
            "        self.assertIsNotNone(unpub2.publisher_public)",
            "        self.assertFalse(unpub2.publisher_public.is_published('en'))",
            "",
            "        gc1 = self.reload(gc1)",
            "        gc2 = self.reload(gc2)",
            "        for page in (gc1, gc2):",
            "            self.assertTrue(page.is_published('en'))",
            "            self.assertEqual(page.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        self.assertIsNone(gc1.publisher_public)",
            "        self.assertIsNotNone(gc2.publisher_public)",
            "        self.assertFalse(gc2.publisher_public.is_published('en'))",
            "",
            "",
            "    def test_unpublish_with_descendants(self):",
            "        page = self.create_page(\"Page\", published=True)",
            "        child = self.create_page(\"Child\", parent=page, published=True)",
            "        self.create_page(\"Grandchild\", parent=child, published=True)",
            "        page = page.reload()",
            "        child.reload()",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published(\"en\")",
            "        self.assertEqual(published.count(), 3)",
            "        self.assertEqual(page.get_descendant_count(), 2)",
            "        base = reverse('pages-root')",
            "",
            "        for url in (base, base + 'child/', base + 'child/grandchild/'):",
            "            response = self.client.get(url)",
            "            self.assertEqual(response.status_code, 200, url)",
            "",
            "        for title in ('Page', 'Child', 'Grandchild'):",
            "            self.assertObjectExist(drafts, title_set__title=title)",
            "            self.assertObjectExist(public, title_set__title=title)",
            "            self.assertObjectExist(published, title_set__title=title)",
            "            item = drafts.get(title_set__title=title)",
            "            self.assertTrue(item.publisher_public_id)",
            "            self.assertEqual(item.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "",
            "        self.assertTrue(page.unpublish('en'), 'Unpublish was not successful')",
            "        self.assertFalse(page.is_published('en'))",
            "        cache.clear()",
            "        for url in (base, base + 'child/', base + 'child/grandchild/'):",
            "            response = self.client.get(url)",
            "            self.assertEqual(response.status_code, 404)",
            "",
            "        for title in ('Page', 'Child', 'Grandchild'):",
            "            self.assertObjectExist(drafts, title_set__title=title)",
            "            self.assertObjectExist(public, title_set__title=title)",
            "            self.assertObjectDoesNotExist(published, title_set__title=title)",
            "            item = drafts.get(title_set__title=title)",
            "            if title == 'Page':",
            "                self.assertFalse(item.is_published(\"en\"))",
            "                self.assertFalse(item.publisher_public.is_published(\"en\"))",
            "                # Not sure what the proper state of these are after unpublish",
            "                #self.assertEqual(page.publisher_state, PUBLISHER_STATE_DEFAULT)",
            "                self.assertTrue(page.is_dirty('en'))",
            "            else:",
            "                # The changes to the published subpages are simply that the",
            "                # published flag of the PUBLIC instance goes to false, and the",
            "                # publisher state is set to mark waiting for parent",
            "                self.assertTrue(item.is_published('en'), title)",
            "                self.assertFalse(item.publisher_public.is_published('en'), title)",
            "                self.assertEqual(item.get_publisher_state('en'), PUBLISHER_STATE_PENDING,",
            "                                 title)",
            "                self.assertTrue(item.is_dirty('en'), title)",
            "",
            "    def test_unpublish_with_dirty_descendants(self):",
            "        page = self.create_page(\"Page\", published=True)",
            "        child = self.create_page(\"Child\", parent=page, published=True)",
            "        gchild = self.create_page(\"Grandchild\", parent=child, published=True)",
            "        child.in_navigation = True",
            "        child.save()",
            "",
            "        self.assertTrue(child.is_dirty(\"en\"))",
            "        self.assertFalse(gchild.is_dirty('en'))",
            "        self.assertTrue(child.publisher_public.is_published('en'))",
            "        self.assertTrue(gchild.publisher_public.is_published('en'))",
            "",
            "        page.unpublish('en')",
            "        child = self.reload(child)",
            "        gchild = self.reload(gchild)",
            "        # Descendants become dirty after unpublish",
            "        self.assertTrue(child.is_dirty('en'))",
            "        self.assertTrue(gchild.is_dirty('en'))",
            "        # However, their public version is still removed no matter what",
            "        self.assertFalse(child.publisher_public.is_published('en'))",
            "        self.assertFalse(gchild.publisher_public.is_published('en'))",
            "",
            "    def test_prepublish_descendants(self):",
            "        page = self.create_page(\"Page\", published=True)",
            "        child = self.create_page(\"Child\", parent=page, published=False)",
            "        gchild2 = self.create_page(\"Grandchild2\", parent=child, published=False)",
            "        self.create_page(\"Grandchild3\", parent=child, published=False)",
            "        gchild = self.create_page(\"Grandchild\", published=True)",
            "        gchild.move_page(target=child, position='last-child')",
            "",
            "        gchild.publish('en')",
            "        self.assertFalse(child.is_published('en'))",
            "        self.assertTrue(gchild.is_published('en'))",
            "        self.assertEqual(gchild.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        child = child.reload()",
            "        child.publish('en')",
            "        gchild2 = gchild2.reload()",
            "        gchild2.publish('en')",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertTrue(gchild.is_published(\"en\"))",
            "        self.assertEqual(gchild.get_publisher_state('en', force_reload=True), PUBLISHER_STATE_DEFAULT)",
            "        gchild = gchild.reload()",
            "        gchild2 = gchild2.reload()",
            "        self.assertEqual(gchild.lft, gchild.publisher_public.lft)",
            "        self.assertEqual(gchild.rght, gchild.publisher_public.rght)",
            "",
            "",
            "",
            "    def test_republish_multiple_root(self):",
            "        # TODO: The paths do not match expected behaviour",
            "        home = self.create_page(\"Page\", published=True)",
            "        other = self.create_page(\"Another Page\", published=True)",
            "        child = self.create_page(\"Child\", published=True, parent=home)",
            "        child2 = self.create_page(\"Child\", published=True, parent=other)",
            "        self.assertTrue(Page.objects.filter(is_home=True).count(), 2)",
            "        self.assertTrue(home.is_home)",
            "",
            "        home = home.reload()",
            "        self.assertTrue(home.publisher_public.is_home)",
            "        root = reverse('pages-root')",
            "        self.assertEqual(home.get_absolute_url(), root)",
            "        self.assertEqual(home.get_public_object().get_absolute_url(), root)",
            "        self.assertEqual(child.get_absolute_url(), root + 'child/')",
            "        self.assertEqual(child.get_public_object().get_absolute_url(), root + 'child/')",
            "        self.assertEqual(other.get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(other.get_public_object().get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(child2.get_absolute_url(), root + 'another-page/child/')",
            "        self.assertEqual(child2.get_public_object().get_absolute_url(), root + 'another-page/child/')",
            "        home = self.reload(home)",
            "        home.unpublish('en')",
            "        home = self.reload(home)",
            "        other = self.reload(other)",
            "        child = self.reload(child)",
            "        child2 = self.reload(child2)",
            "        self.assertFalse(home.is_home)",
            "        self.assertFalse(home.publisher_public.is_home)",
            "        self.assertTrue(other.is_home)",
            "        self.assertTrue(other.publisher_public.is_home)",
            "",
            "        self.assertEqual(other.get_absolute_url(), root)",
            "        self.assertEqual(other.get_public_object().get_absolute_url(), root)",
            "        self.assertEqual(home.get_absolute_url(), root + 'page/')",
            "        self.assertEqual(home.get_public_object().get_absolute_url(), root + 'page/')",
            "",
            "        self.assertEqual(child.get_absolute_url(), root + 'page/child/')",
            "        self.assertEqual(child.get_public_object().get_absolute_url(), root + 'page/child/')",
            "        self.assertEqual(child2.get_absolute_url(), root + 'child/')",
            "        self.assertEqual(child2.get_public_object().get_absolute_url(), root + 'child/')",
            "        home.publish('en')",
            "        home = self.reload(home)",
            "        other = self.reload(other)",
            "        child = self.reload(child)",
            "        child2 = self.reload(child2)",
            "        self.assertTrue(home.is_home)",
            "        self.assertTrue(home.publisher_public.is_home)",
            "        self.assertEqual(home.get_absolute_url(), root)",
            "        self.assertEqual(home.get_public_object().get_absolute_url(), root)",
            "        self.assertEqual(child.get_absolute_url(), root + 'child/')",
            "        self.assertEqual(child.get_public_object().get_absolute_url(), root + 'child/')",
            "        self.assertEqual(other.get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(other.get_public_object().get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(child2.get_absolute_url(), root + 'another-page/child/')",
            "        self.assertEqual(child2.get_public_object().get_absolute_url(), root + 'another-page/child/')",
            "",
            "    def test_revert_contents(self):",
            "        user = self.get_superuser()",
            "        page = create_page(\"Page\", \"nav_playground.html\", \"en\", published=True,",
            "                           created_by=user)",
            "        placeholder = page.placeholders.get(slot=u\"body\")",
            "        deleted_plugin = add_plugin(placeholder, u\"TextPlugin\", u\"en\", body=\"Deleted content\")",
            "        text_plugin = add_plugin(placeholder, u\"TextPlugin\", u\"en\", body=\"Public content\")",
            "        page.publish('en')",
            "",
            "        # Modify and delete plugins",
            "        text_plugin.body = \"<p>Draft content</p>\"",
            "        text_plugin.save()",
            "        deleted_plugin.delete()",
            "        self.assertEqual(CMSPlugin.objects.count(), 3)",
            "",
            "        # Now let's revert and restore",
            "        page.revert('en')",
            "        self.assertEqual(page.get_publisher_state(\"en\"), PUBLISHER_STATE_DEFAULT)",
            "",
            "        self.assertEqual(CMSPlugin.objects.count(), 4)",
            "        plugins = CMSPlugin.objects.filter(placeholder__page=page)",
            "        self.assertEqual(plugins.count(), 2)",
            "",
            "        plugins = [plugin.get_plugin_instance()[0] for plugin in plugins]",
            "        self.assertEqual(plugins[0].body, \"Deleted content\")",
            "        self.assertEqual(plugins[1].body, \"Public content\")",
            "",
            "    def test_revert_move(self):",
            "        parent = create_page(\"Parent\", \"nav_playground.html\", \"en\", published=True)",
            "        parent_url = parent.get_absolute_url()",
            "        page = create_page(\"Page\", \"nav_playground.html\", \"en\", published=True,",
            "                           parent=parent)",
            "        other = create_page(\"Other\", \"nav_playground.html\", \"en\", published=True)",
            "        other_url = other.get_absolute_url()",
            "",
            "        child = create_page(\"Child\", \"nav_playground.html\", \"en\", published=True,",
            "                            parent=page)",
            "        parent = parent.reload()",
            "        page = page.reload()",
            "        self.assertEqual(page.get_absolute_url(), parent_url + \"page/\")",
            "        self.assertEqual(child.get_absolute_url(), parent_url + \"page/child/\")",
            "",
            "        # Now let's move it (and the child)",
            "        page.move_page(other)",
            "        page = self.reload(page)",
            "        child = self.reload(child)",
            "        self.assertEqual(page.get_absolute_url(), other_url + \"page/\")",
            "        self.assertEqual(child.get_absolute_url(), other_url + \"page/child/\")",
            "        # Public version changed the url as well",
            "        self.assertEqual(page.publisher_public.get_absolute_url(), other_url + \"page/\")",
            "        self.assertEqual(child.publisher_public.get_absolute_url(), other_url + \"page/child/\")",
            "",
            "    def test_publish_works_with_descendants(self):",
            "        \"\"\"",
            "        For help understanding what this tests for, see:",
            "        http://articles.sitepoint.com/print/hierarchical-data-database",
            "",
            "        Creates this published structure:",
            "                            home",
            "                          /      \\",
            "                       item1   item2",
            "                              /     \\",
            "                         subitem1 subitem2",
            "        \"\"\"",
            "        home_page = create_page(\"home\", \"nav_playground.html\", \"en\",",
            "                                published=True, in_navigation=False)",
            "",
            "        create_page(\"item1\", \"nav_playground.html\", \"en\", parent=home_page,",
            "                    published=True)",
            "        item2 = create_page(\"item2\", \"nav_playground.html\", \"en\", parent=home_page,",
            "                            published=True)",
            "",
            "        create_page(\"subitem1\", \"nav_playground.html\", \"en\", parent=item2,",
            "                    published=True)",
            "        create_page(\"subitem2\", \"nav_playground.html\", \"en\", parent=item2,",
            "                    published=True)",
            "        item2 = item2.reload()",
            "        not_drafts = list(Page.objects.filter(publisher_is_draft=False).order_by('lft'))",
            "        drafts = list(Page.objects.filter(publisher_is_draft=True).order_by('lft'))",
            "",
            "        self.assertEqual(len(not_drafts), 5)",
            "        self.assertEqual(len(drafts), 5)",
            "",
            "        for idx, draft in enumerate(drafts):",
            "            public = not_drafts[idx]",
            "            # Check that a node doesn't become a root node magically",
            "            self.assertEqual(bool(public.parent_id), bool(draft.parent_id))",
            "            if public.parent:",
            "                # Let's assert the MPTT tree is consistent",
            "                self.assertTrue(public.lft > public.parent.lft)",
            "                self.assertTrue(public.rght < public.parent.rght)",
            "                self.assertEqual(public.tree_id, public.parent.tree_id)",
            "                self.assertTrue(public.parent in public.get_ancestors())",
            "                self.assertTrue(public in public.parent.get_descendants())",
            "                self.assertTrue(public in public.parent.get_children())",
            "            if draft.parent:",
            "                # Same principle for the draft tree",
            "                self.assertTrue(draft.lft > draft.parent.lft)",
            "                self.assertTrue(draft.rght < draft.parent.rght)",
            "                self.assertEqual(draft.tree_id, draft.parent.tree_id)",
            "                self.assertTrue(draft.parent in draft.get_ancestors())",
            "                self.assertTrue(draft in draft.parent.get_descendants())",
            "                self.assertTrue(draft in draft.parent.get_children())",
            "",
            "        # Now call publish again. The structure should not change.",
            "        item2.publish('en')",
            "",
            "        not_drafts = list(Page.objects.filter(publisher_is_draft=False).order_by('lft'))",
            "        drafts = list(Page.objects.filter(publisher_is_draft=True).order_by('lft'))",
            "",
            "        self.assertEqual(len(not_drafts), 5)",
            "        self.assertEqual(len(drafts), 5)",
            "",
            "        for idx, draft in enumerate(drafts):",
            "            public = not_drafts[idx]",
            "            # Check that a node doesn't become a root node magically",
            "            self.assertEqual(bool(public.parent_id), bool(draft.parent_id))",
            "            if public.parent:",
            "                # Let's assert the MPTT tree is consistent",
            "                self.assertTrue(public.lft > public.parent.lft)",
            "                self.assertTrue(public.rght < public.parent.rght)",
            "                self.assertEqual(public.tree_id, public.parent.tree_id)",
            "                self.assertTrue(public.parent in public.get_ancestors())",
            "                self.assertTrue(public in public.parent.get_descendants())",
            "                self.assertTrue(public in public.parent.get_children())",
            "            if draft.parent:",
            "                # Same principle for the draft tree",
            "                self.assertTrue(draft.lft > draft.parent.lft)",
            "                self.assertTrue(draft.rght < draft.parent.rght)",
            "                self.assertEqual(draft.tree_id, draft.parent.tree_id)",
            "                self.assertTrue(draft.parent in draft.get_ancestors())",
            "                self.assertTrue(draft in draft.parent.get_descendants())",
            "                self.assertTrue(draft in draft.parent.get_children())"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from __future__ import with_statement",
            "from django.contrib.sites.models import Site",
            "from cms.utils.urlutils import admin_reverse",
            "",
            "from djangocms_text_ckeditor.models import Text",
            "from django.core.cache import cache",
            "from django.core.management.base import CommandError",
            "from django.core.management import call_command",
            "from django.core.urlresolvers import reverse",
            "",
            "from cms.api import create_page, add_plugin, create_title",
            "from cms.constants import PUBLISHER_STATE_PENDING, PUBLISHER_STATE_DEFAULT, PUBLISHER_STATE_DIRTY",
            "from cms.management.commands import publisher_publish",
            "from cms.models import CMSPlugin, Title",
            "from cms.models.pagemodel import Page",
            "from cms.plugin_pool import plugin_pool",
            "from cms.test_utils.testcases import SettingsOverrideTestCase as TestCase",
            "from cms.test_utils.util.context_managers import StdoutOverride, SettingsOverride",
            "from cms.test_utils.util.fuzzy_int import FuzzyInt",
            "from cms.utils.conf import get_cms_setting",
            "from cms.utils.i18n import force_language",
            "from cms.utils.compat.dj import get_user_model",
            "",
            "",
            "class PublisherCommandTests(TestCase):",
            "    \"\"\"",
            "    Tests for the publish command",
            "    \"\"\"",
            "",
            "    def test_command_line_should_raise_without_superuser(self):",
            "        with self.assertRaises(CommandError):",
            "            com = publisher_publish.Command()",
            "            com.handle_noargs()",
            "",
            "    def test_command_line_publishes_zero_pages_on_empty_db(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 0)",
            "        self.assertEqual(published_from_output, 0)",
            "",
            "    def test_command_line_ignores_draft_page(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=False)",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 0)",
            "        self.assertEqual(published_from_output, 0)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 0)",
            "",
            "    def test_command_line_publishes_draft_page(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=False)",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', include_unpublished=True)",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 1)",
            "",
            "    def test_command_line_publishes_selected_language(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        page = create_page(\"en title\", \"nav_playground.html\", \"en\")",
            "        title = create_title('de', 'de title', page)",
            "        title.published = True",
            "        title.save()",
            "        title = create_title('fr', 'fr title', page)",
            "        title.published = True",
            "        title.save()",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', language='de')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 1)",
            "        public = Page.objects.public()[0]",
            "        languages = sorted(public.title_set.values_list('language', flat=True))",
            "        self.assertEqual(languages, ['de'])",
            "",
            "    def test_command_line_publishes_selected_language_drafts(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        page = create_page(\"en title\", \"nav_playground.html\", \"en\")",
            "        title = create_title('de', 'de title', page)",
            "        title.published = False",
            "        title.save()",
            "        title = create_title('fr', 'fr title', page)",
            "        title.published = False",
            "        title.save()",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', language='de', include_unpublished=True)",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "        self.assertEqual(Page.objects.public().count(), 1)",
            "        public = Page.objects.public()[0]",
            "        languages = sorted(public.title_set.values_list('language', flat=True))",
            "        self.assertEqual(languages, ['de'])",
            "",
            "    def test_table_name_patching(self):",
            "        \"\"\"",
            "        This tests the plugin models patching when publishing from the command line",
            "        \"\"\"",
            "        User = get_user_model()",
            "        User.objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=True)",
            "        draft = Page.objects.drafts()[0]",
            "        draft.reverse_id = 'a_test' # we have to change *something*",
            "        draft.save()",
            "        add_plugin(draft.placeholders.get(slot=u\"body\"),",
            "                   u\"TextPlugin\", u\"en\", body=\"Test content\")",
            "        draft.publish('en')",
            "        add_plugin(draft.placeholders.get(slot=u\"body\"),",
            "                   u\"TextPlugin\", u\"en\", body=\"Test content\")",
            "",
            "        # Manually undoing table name patching",
            "        Text._meta.db_table = 'djangocms_text_ckeditor_text'",
            "        plugin_pool.patched = False",
            "",
            "        with StdoutOverride():",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "        not_drafts = len(Page.objects.filter(publisher_is_draft=False))",
            "        drafts = len(Page.objects.filter(publisher_is_draft=True))",
            "        self.assertEqual(not_drafts, 1)",
            "        self.assertEqual(drafts, 1)",
            "",
            "    def test_command_line_publishes_one_page(self):",
            "        \"\"\"",
            "        Publisher always creates two Page objects for every CMS page,",
            "        one is_draft and one is_public.",
            "",
            "        The public version of the page can be either published or not.",
            "",
            "        This bit of code uses sometimes manager methods and sometimes manual",
            "        filters on purpose (this helps test the managers)",
            "        \"\"\"",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        # Now, let's create a page. That actually creates 2 Page objects",
            "        create_page(\"The page!\", \"nav_playground.html\", \"en\", published=True)",
            "        draft = Page.objects.drafts()[0]",
            "        draft.reverse_id = 'a_test' # we have to change *something*",
            "        draft.save()",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "        # Sanity check the database (we should have one draft and one public)",
            "        not_drafts = len(Page.objects.filter(publisher_is_draft=False))",
            "        drafts = len(Page.objects.filter(publisher_is_draft=True))",
            "        self.assertEqual(not_drafts, 1)",
            "        self.assertEqual(drafts, 1)",
            "",
            "        # Now check that the non-draft has the attribute we set to the draft.",
            "        non_draft = Page.objects.public()[0]",
            "        self.assertEqual(non_draft.reverse_id, 'a_test')",
            "",
            "    def test_command_line_publish_multiple_languages(self):",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        # Create a draft page with two published titles",
            "        page = create_page(u\"The page!\", \"nav_playground.html\", \"en\", published=False)",
            "        title = create_title('de', 'ja', page)",
            "        title.published = True",
            "        title.save()",
            "        title = create_title('fr', 'non', page)",
            "        title.published = True",
            "        title.save()",
            "",
            "        with StdoutOverride():",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "",
            "        public = Page.objects.public()[0]",
            "        languages = sorted(public.title_set.values_list('language', flat=True))",
            "        self.assertEqual(languages, ['de', 'fr'])",
            "",
            "    def test_command_line_publish_one_site(self):",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        siteA = Site.objects.create(domain='a.example.com', name='a.example.com')",
            "        siteB = Site.objects.create(domain='b.example.com', name='b.example.com')",
            "",
            "        #example.com",
            "        create_page(u\"example.com homepage\", \"nav_playground.html\", \"en\", published=True)",
            "        #a.example.com",
            "        create_page(u\"a.example.com homepage\", \"nav_playground.html\", \"de\", site=siteA, published=True)",
            "        #b.example.com",
            "        create_page(u\"b.example.com homepage\", \"nav_playground.html\", \"de\", site=siteB, published=True)",
            "        create_page(u\"b.example.com about\", \"nav_playground.html\", \"nl\", site=siteB, published=True)",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish', site=siteB.id)",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 2)",
            "        self.assertEqual(published_from_output, 2)",
            "",
            "    def test_command_line_publish_multiple_languages_check_count(self):",
            "        \"\"\"",
            "        Publishing one page with multiple languages still counts",
            "        as one page. This test case checks whether it works",
            "        as expected.",
            "        \"\"\"",
            "        # we need to create a superuser (the db is empty)",
            "        get_user_model().objects.create_superuser('djangocms', 'cms@example.com', '123456')",
            "",
            "        # Now, let's create a page with 2 languages.",
            "        page = create_page(\"en title\", \"nav_playground.html\", \"en\", published=True)",
            "        create_title(\"de\", \"de title\", page)",
            "        page.publish(\"de\")",
            "",
            "        pages_from_output = 0",
            "        published_from_output = 0",
            "",
            "        with StdoutOverride() as buffer:",
            "            # Now we don't expect it to raise, but we need to redirect IO",
            "            call_command('publisher_publish')",
            "            lines = buffer.getvalue().split('\\n') #NB: readlines() doesn't work",
            "",
            "        for line in lines:",
            "            if 'Total' in line:",
            "                pages_from_output = int(line.split(':')[1])",
            "            elif 'Published' in line:",
            "                published_from_output = int(line.split(':')[1])",
            "",
            "        self.assertEqual(pages_from_output, 1)",
            "        self.assertEqual(published_from_output, 1)",
            "",
            "    def tearDown(self):",
            "        plugin_pool.patched = False",
            "        plugin_pool.set_plugin_meta()",
            "",
            "",
            "class PublishingTests(TestCase):",
            "    def create_page(self, title=None, **kwargs):",
            "        return create_page(title or self._testMethodName,",
            "                           \"nav_playground.html\", \"en\", **kwargs)",
            "",
            "    def test_publish_home(self):",
            "        name = self._testMethodName",
            "        page = self.create_page(name, published=False)",
            "        self.assertFalse(page.publisher_public_id)",
            "        self.assertEqual(Page.objects.all().count(), 1)",
            "        superuser = self.get_superuser()",
            "        with self.login_user_context(superuser):",
            "            response = self.client.post(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))",
            "            self.assertEqual(response.status_code, 302)",
            "            self.assertEqual(response['Location'], \"http://testserver/en/?%s\" % get_cms_setting('CMS_TOOLBAR_URL__EDIT_OFF'))",
            "",
            "    def test_publish_single(self):",
            "        name = self._testMethodName",
            "        page = self.create_page(name, published=False)",
            "        self.assertFalse(page.is_published('en'))",
            "",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published(\"en\")",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectDoesNotExist(public, title_set__title=name)",
            "        self.assertObjectDoesNotExist(published, title_set__title=name)",
            "",
            "        page.publish(\"en\")",
            "",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published(\"en\")",
            "",
            "        self.assertTrue(page.is_published('en'))",
            "        self.assertEqual(page.get_publisher_state(\"en\"), PUBLISHER_STATE_DEFAULT)",
            "        self.assertIsNotNone(page.publisher_public)",
            "        self.assertTrue(page.publisher_public_id)",
            "",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectExist(public, title_set__title=name)",
            "        self.assertObjectExist(published, title_set__title=name)",
            "",
            "        page = Page.objects.get(pk=page.pk)",
            "",
            "        self.assertEqual(page.get_publisher_state(\"en\"), 0)",
            "",
            "    def test_publish_admin(self):",
            "        page = self.create_page(\"test_admin\", published=False)",
            "        superuser = self.get_superuser()",
            "        with self.login_user_context(superuser):",
            "            response = self.client.post(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))",
            "            self.assertEqual(response.status_code, 302)",
            "        page = Page.objects.get(pk=page.pk)",
            "",
            "        self.assertEqual(page.get_publisher_state('en'), 0)",
            "",
            "    def test_publish_wrong_lang(self):",
            "        page = self.create_page(\"test_admin\", published=False)",
            "        superuser = self.get_superuser()",
            "        with SettingsOverride(",
            "                LANGUAGES=(('de', 'de'), ('en', 'en')),",
            "                CMS_LANGUAGES={1: [{'code': 'en', 'name': 'en', 'fallbacks': ['fr', 'de'], 'public': True}]}",
            "            ):",
            "            with self.login_user_context(superuser):",
            "                with force_language('de'):",
            "                    response = self.client.post(admin_reverse(\"cms_page_publish_page\", args=[page.pk, 'en']))",
            "        self.assertEqual(response.status_code, 302)",
            "        page = Page.objects.get(pk=page.pk)",
            "",
            "    def test_publish_child_first(self):",
            "        parent = self.create_page('parent', published=False)",
            "        child = self.create_page('child', published=False, parent=parent)",
            "        parent = parent.reload()",
            "        self.assertFalse(parent.is_published('en'))",
            "        self.assertFalse(child.is_published('en'))",
            "",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published('en')",
            "",
            "        for name in ('parent', 'child'):",
            "            self.assertObjectExist(drafts, title_set__title=name)",
            "            self.assertObjectDoesNotExist(public, title_set__title=name)",
            "            self.assertObjectDoesNotExist(published, title_set__title=name)",
            "",
            "        child.publish(\"en\")",
            "        child = child.reload()",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        self.assertIsNone(child.publisher_public)",
            "",
            "        # Since we have no parent, the state is otherwise unchanged",
            "        for name in ('parent', 'child'):",
            "            self.assertObjectExist(drafts, title_set__title=name)",
            "            self.assertObjectDoesNotExist(public, title_set__title=name)",
            "            self.assertObjectDoesNotExist(published, title_set__title=name)",
            "        parent.publish(\"en\")",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published('en')",
            "        # Cascade publish for all pending descendants",
            "        for name in ('parent', 'child'):",
            "            self.assertObjectExist(drafts, title_set__title=name)",
            "            page = drafts.get(title_set__title=name)",
            "            self.assertTrue(page.is_published(\"en\"), name)",
            "            self.assertEqual(page.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT, name)",
            "            self.assertIsNotNone(page.publisher_public, name)",
            "            self.assertTrue(page.publisher_public.is_published('en'), name)",
            "",
            "            self.assertObjectExist(public, title_set__title=name)",
            "            self.assertObjectExist(published, title_set__title=name)",
            "",
            "    def test_simple_publisher(self):",
            "        \"\"\"",
            "        Creates the stuff needed for these tests.",
            "        Please keep this up-to-date (the docstring!)",
            "",
            "                A",
            "               / \\",
            "              B  C",
            "        \"\"\"",
            "        # Create a simple tree of 3 pages",
            "        pageA = create_page(\"Page A\", \"nav_playground.html\", \"en\",",
            "                            published=True)",
            "        pageB = create_page(\"Page B\", \"nav_playground.html\", \"en\", parent=pageA,",
            "                            published=True)",
            "        pageC = create_page(\"Page C\", \"nav_playground.html\", \"en\", parent=pageA,",
            "                            published=False)",
            "        # Assert A and B are published, C unpublished",
            "        self.assertTrue(pageA.publisher_public_id)",
            "        self.assertTrue(pageB.publisher_public_id)",
            "        self.assertTrue(not pageC.publisher_public_id)",
            "        self.assertEqual(len(Page.objects.public().published(\"en\")), 2)",
            "",
            "        # Let's publish C now.",
            "        pageC.publish(\"en\")",
            "",
            "        # Assert all are published",
            "        self.assertTrue(pageA.publisher_public_id)",
            "        self.assertTrue(pageB.publisher_public_id)",
            "        self.assertTrue(pageC.publisher_public_id)",
            "        self.assertEqual(len(Page.objects.public().published(\"en\")), 3)",
            "",
            "    def test_i18n_publishing(self):",
            "        page = self.create_page('parent', published=True)",
            "        self.assertEqual(Title.objects.all().count(), 2)",
            "        create_title(\"de\", \"vater\", page)",
            "        self.assertEqual(Title.objects.all().count(), 3)",
            "        self.assertEqual(Title.objects.filter(published=True).count(), 2)",
            "        page.publish('de')",
            "        self.assertEqual(Title.objects.all().count(), 4)",
            "        self.assertEqual(Title.objects.filter(published=True).count(), 4)",
            "",
            "",
            "    def test_publish_ordering(self):",
            "        page = self.create_page('parent', published=True)",
            "        pageA = self.create_page('pageA', parent=page, published=True)",
            "        pageC = self.create_page('pageC', parent=page, published=True)",
            "        pageB = self.create_page('pageB', parent=page, published=True)",
            "        page = page.reload()",
            "        pageB.move_page(pageA, 'right')",
            "        pageB.publish(\"en\")",
            "        # pageC needs reload since B has swapped places with it",
            "        pageC.reload().publish(\"en\")",
            "        pageA.publish('en')",
            "",
            "        drafts = Page.objects.drafts().order_by('tree_id', 'lft')",
            "        draft_titles = [(p.get_title('en'), p.lft, p.rght) for p in drafts]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], draft_titles)",
            "        public = Page.objects.public().order_by('tree_id', 'lft')",
            "        public_titles = [(p.get_title('en'), p.lft, p.rght) for p in public]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], public_titles)",
            "",
            "        page.publish('en')",
            "",
            "        drafts = Page.objects.drafts().order_by('tree_id', 'lft')",
            "        draft_titles = [(p.get_title('en'), p.lft, p.rght) for p in drafts]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], draft_titles)",
            "        public = Page.objects.public().order_by('tree_id', 'lft')",
            "        public_titles = [(p.get_title('en'), p.lft, p.rght) for p in public]",
            "        self.assertEqual([('parent', 1, 8),",
            "                              ('pageA', 2, 3),",
            "                              ('pageB', 4, 5),",
            "                              ('pageC', 6, 7)], public_titles)",
            "",
            "    def test_publish_ordering2(self):",
            "        page = self.create_page('parent', published=False)",
            "        pageA = self.create_page('pageA', published=False)",
            "        pageC = self.create_page('pageC', published=False, parent=pageA)",
            "        pageB = self.create_page('pageB', published=False, parent=pageA)",
            "        page = page.reload()",
            "        pageA.publish('en')",
            "        pageB.publish('en')",
            "        pageC.publish('en')",
            "        page.publish('en')",
            "",
            "        drafts = Page.objects.filter(publisher_is_draft=True).order_by('tree_id', 'lft')",
            "        publics = Page.objects.filter(publisher_is_draft=False).order_by('tree_id', 'lft')",
            "",
            "        x = 0",
            "        for draft in drafts:",
            "            self.assertEqual(draft.publisher_public_id, publics[x].pk)",
            "            x += 1",
            "",
            "",
            "    def test_unpublish_unpublish(self):",
            "        name = self._testMethodName",
            "        page = self.create_page(name, published=True)",
            "        drafts = Page.objects.drafts()",
            "        published = Page.objects.public().published(\"en\")",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectExist(published, title_set__title=name)",
            "",
            "        page.unpublish('en')",
            "        self.assertFalse(page.is_published('en'))",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectDoesNotExist(published, title_set__title=name)",
            "",
            "        page.publish('en')",
            "        self.assertTrue(page.publisher_public_id)",
            "        self.assertObjectExist(drafts, title_set__title=name)",
            "        self.assertObjectExist(published, title_set__title=name)",
            "",
            "    def test_delete_title_unpublish(self):",
            "        page = self.create_page('test', published=True)",
            "        sub_page = self.create_page('test2', published=True, parent=page)",
            "        self.assertTrue(sub_page.publisher_public.is_published('en'))",
            "        page.title_set.all().delete()",
            "        self.assertFalse(sub_page.publisher_public.is_published('en', force_reload=True))",
            "",
            "    def test_modify_child_while_pending(self):",
            "        home = self.create_page(\"Home\", published=True, in_navigation=True)",
            "        child = self.create_page(\"Child\", published=True, parent=home,",
            "                                 in_navigation=False)",
            "        home = home.reload()",
            "        home.unpublish('en')",
            "        self.assertEqual(Title.objects.count(), 4)",
            "        child = child.reload()",
            "        self.assertFalse(child.publisher_public.is_published('en'))",
            "        self.assertFalse(child.in_navigation)",
            "        self.assertFalse(child.publisher_public.in_navigation)",
            "",
            "        child.in_navigation = True",
            "        child.save()",
            "        child.publish('en')",
            "        child = self.reload(child)",
            "        self.assertEqual(Title.objects.count(), 4)",
            "",
            "        self.assertTrue(child.is_published('en'))",
            "        self.assertFalse(child.publisher_public.is_published('en'))",
            "        self.assertTrue(child.in_navigation)",
            "        self.assertTrue(child.publisher_public.in_navigation)",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "",
            "        home.publish('en')",
            "        child = self.reload(child)",
            "        self.assertTrue(child.is_published('en'))",
            "        self.assertTrue(child.publisher_public_id)",
            "        self.assertTrue(child.publisher_public.in_navigation)",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "",
            "    def test_republish_with_descendants(self):",
            "        home = self.create_page(\"Home\", published=True)",
            "        child = self.create_page(\"Child\", published=True, parent=home)",
            "        gc = self.create_page(\"GC\", published=True, parent=child)",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertTrue(gc.is_published('en'))",
            "        home = home.reload()",
            "        home.unpublish('en')",
            "        child = self.reload(child)",
            "        gc = self.reload(gc)",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertTrue(gc.is_published(\"en\"))",
            "        self.assertFalse(child.publisher_public.is_published(\"en\"))",
            "        self.assertFalse(gc.publisher_public.is_published('en'))",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        self.assertEqual(gc.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "",
            "        home.publish('en')",
            "        child = self.reload(child)",
            "        gc = self.reload(gc)",
            "",
            "        self.assertTrue(child.publisher_public_id)",
            "        self.assertTrue(gc.is_published('en'))",
            "        self.assertTrue(child.is_published('en'))",
            "        self.assertTrue(gc.publisher_public_id)",
            "        self.assertEqual(child.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "        self.assertEqual(gc.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "",
            "    def test_republish_with_dirty_children(self):",
            "        home = self.create_page(\"Home\", published=True)",
            "        dirty1 = self.create_page(\"Dirty1\", published=True, parent=home)",
            "        dirty2 = self.create_page(\"Dirty2\", published=True, parent=home)",
            "        home = self.reload(home)",
            "        dirty1 = self.reload(dirty1)",
            "        dirty2 = self.reload(dirty2)",
            "        dirty1.in_navigation = True",
            "        dirty1.save()",
            "        home.unpublish('en')",
            "        dirty2.in_navigation = True",
            "        dirty2.save()",
            "        dirty1 = self.reload(dirty1)",
            "        dirty2 = self.reload(dirty2)",
            "        self.assertTrue(dirty1.is_published)",
            "        self.assertTrue(dirty2.publisher_public_id)",
            "        self.assertEqual(dirty1.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "        self.assertEqual(dirty2.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "",
            "        home = self.reload(home)",
            "        with self.assertNumQueries(FuzzyInt(0, 100)):",
            "            home.publish('en')",
            "        dirty1 = self.reload(dirty1)",
            "        dirty2 = self.reload(dirty2)",
            "        self.assertTrue(dirty1.is_published(\"en\"))",
            "        self.assertTrue(dirty2.is_published(\"en\"))",
            "        self.assertTrue(dirty1.publisher_public.is_published(\"en\"))",
            "        self.assertTrue(dirty2.publisher_public.is_published(\"en\"))",
            "        self.assertEqual(dirty1.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "        self.assertEqual(dirty2.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "",
            "    def test_republish_with_unpublished_child(self):",
            "        \"\"\"",
            "        Unpub1 was never published, and unpub2 has been unpublished after the",
            "        fact. None of the grandchildren should become published.",
            "        \"\"\"",
            "        home = self.create_page(\"Home\", published=True)",
            "        unpub1 = self.create_page(\"Unpub1\", published=False, parent=home)",
            "        unpub2 = self.create_page(\"Unpub2\", published=True, parent=home)",
            "        gc1 = self.create_page(\"GC1\", published=True, parent=unpub1)",
            "        gc2 = self.create_page(\"GC2\", published=True, parent=unpub2)",
            "        self.assertFalse(gc1.publisher_public_id)",
            "        self.assertFalse(gc1.publisher_public_id)",
            "        self.assertTrue(gc1.is_published('en'))",
            "        self.assertTrue(gc2.is_published('en'))",
            "        home.unpublish('en')",
            "        unpub1 = self.reload(unpub1)",
            "        unpub2.unpublish('en')  # Just marks this as not published",
            "        for page in (unpub1, unpub2):",
            "            self.assertFalse(page.is_published('en'), page)",
            "            self.assertEqual(page.get_publisher_state(\"en\"), PUBLISHER_STATE_DIRTY)",
            "        self.assertIsNone(unpub1.publisher_public)",
            "        self.assertIsNotNone(unpub2.publisher_public)",
            "        self.assertFalse(unpub2.publisher_public.is_published('en'))",
            "",
            "        gc1 = self.reload(gc1)",
            "        gc2 = self.reload(gc2)",
            "        for page in (gc1, gc2):",
            "            self.assertTrue(page.is_published('en'))",
            "            self.assertEqual(page.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        self.assertIsNone(gc1.publisher_public)",
            "        self.assertIsNotNone(gc2.publisher_public)",
            "        self.assertFalse(gc2.publisher_public.is_published('en'))",
            "",
            "",
            "    def test_unpublish_with_descendants(self):",
            "        page = self.create_page(\"Page\", published=True)",
            "        child = self.create_page(\"Child\", parent=page, published=True)",
            "        self.create_page(\"Grandchild\", parent=child, published=True)",
            "        page = page.reload()",
            "        child.reload()",
            "        drafts = Page.objects.drafts()",
            "        public = Page.objects.public()",
            "        published = Page.objects.public().published(\"en\")",
            "        self.assertEqual(published.count(), 3)",
            "        self.assertEqual(page.get_descendant_count(), 2)",
            "        base = reverse('pages-root')",
            "",
            "        for url in (base, base + 'child/', base + 'child/grandchild/'):",
            "            response = self.client.get(url)",
            "            self.assertEqual(response.status_code, 200, url)",
            "",
            "        for title in ('Page', 'Child', 'Grandchild'):",
            "            self.assertObjectExist(drafts, title_set__title=title)",
            "            self.assertObjectExist(public, title_set__title=title)",
            "            self.assertObjectExist(published, title_set__title=title)",
            "            item = drafts.get(title_set__title=title)",
            "            self.assertTrue(item.publisher_public_id)",
            "            self.assertEqual(item.get_publisher_state('en'), PUBLISHER_STATE_DEFAULT)",
            "",
            "        self.assertTrue(page.unpublish('en'), 'Unpublish was not successful')",
            "        self.assertFalse(page.is_published('en'))",
            "        cache.clear()",
            "        for url in (base, base + 'child/', base + 'child/grandchild/'):",
            "            response = self.client.get(url)",
            "            self.assertEqual(response.status_code, 404)",
            "",
            "        for title in ('Page', 'Child', 'Grandchild'):",
            "            self.assertObjectExist(drafts, title_set__title=title)",
            "            self.assertObjectExist(public, title_set__title=title)",
            "            self.assertObjectDoesNotExist(published, title_set__title=title)",
            "            item = drafts.get(title_set__title=title)",
            "            if title == 'Page':",
            "                self.assertFalse(item.is_published(\"en\"))",
            "                self.assertFalse(item.publisher_public.is_published(\"en\"))",
            "                # Not sure what the proper state of these are after unpublish",
            "                #self.assertEqual(page.publisher_state, PUBLISHER_STATE_DEFAULT)",
            "                self.assertTrue(page.is_dirty('en'))",
            "            else:",
            "                # The changes to the published subpages are simply that the",
            "                # published flag of the PUBLIC instance goes to false, and the",
            "                # publisher state is set to mark waiting for parent",
            "                self.assertTrue(item.is_published('en'), title)",
            "                self.assertFalse(item.publisher_public.is_published('en'), title)",
            "                self.assertEqual(item.get_publisher_state('en'), PUBLISHER_STATE_PENDING,",
            "                                 title)",
            "                self.assertTrue(item.is_dirty('en'), title)",
            "",
            "    def test_unpublish_with_dirty_descendants(self):",
            "        page = self.create_page(\"Page\", published=True)",
            "        child = self.create_page(\"Child\", parent=page, published=True)",
            "        gchild = self.create_page(\"Grandchild\", parent=child, published=True)",
            "        child.in_navigation = True",
            "        child.save()",
            "",
            "        self.assertTrue(child.is_dirty(\"en\"))",
            "        self.assertFalse(gchild.is_dirty('en'))",
            "        self.assertTrue(child.publisher_public.is_published('en'))",
            "        self.assertTrue(gchild.publisher_public.is_published('en'))",
            "",
            "        page.unpublish('en')",
            "        child = self.reload(child)",
            "        gchild = self.reload(gchild)",
            "        # Descendants become dirty after unpublish",
            "        self.assertTrue(child.is_dirty('en'))",
            "        self.assertTrue(gchild.is_dirty('en'))",
            "        # However, their public version is still removed no matter what",
            "        self.assertFalse(child.publisher_public.is_published('en'))",
            "        self.assertFalse(gchild.publisher_public.is_published('en'))",
            "",
            "    def test_prepublish_descendants(self):",
            "        page = self.create_page(\"Page\", published=True)",
            "        child = self.create_page(\"Child\", parent=page, published=False)",
            "        gchild2 = self.create_page(\"Grandchild2\", parent=child, published=False)",
            "        self.create_page(\"Grandchild3\", parent=child, published=False)",
            "        gchild = self.create_page(\"Grandchild\", published=True)",
            "        gchild.move_page(target=child, position='last-child')",
            "",
            "        gchild.publish('en')",
            "        self.assertFalse(child.is_published('en'))",
            "        self.assertTrue(gchild.is_published('en'))",
            "        self.assertEqual(gchild.get_publisher_state('en'), PUBLISHER_STATE_PENDING)",
            "        child = child.reload()",
            "        child.publish('en')",
            "        gchild2 = gchild2.reload()",
            "        gchild2.publish('en')",
            "        self.assertTrue(child.is_published(\"en\"))",
            "        self.assertTrue(gchild.is_published(\"en\"))",
            "        self.assertEqual(gchild.get_publisher_state('en', force_reload=True), PUBLISHER_STATE_DEFAULT)",
            "        gchild = gchild.reload()",
            "        gchild2 = gchild2.reload()",
            "        self.assertEqual(gchild.lft, gchild.publisher_public.lft)",
            "        self.assertEqual(gchild.rght, gchild.publisher_public.rght)",
            "",
            "",
            "",
            "    def test_republish_multiple_root(self):",
            "        # TODO: The paths do not match expected behaviour",
            "        home = self.create_page(\"Page\", published=True)",
            "        other = self.create_page(\"Another Page\", published=True)",
            "        child = self.create_page(\"Child\", published=True, parent=home)",
            "        child2 = self.create_page(\"Child\", published=True, parent=other)",
            "        self.assertTrue(Page.objects.filter(is_home=True).count(), 2)",
            "        self.assertTrue(home.is_home)",
            "",
            "        home = home.reload()",
            "        self.assertTrue(home.publisher_public.is_home)",
            "        root = reverse('pages-root')",
            "        self.assertEqual(home.get_absolute_url(), root)",
            "        self.assertEqual(home.get_public_object().get_absolute_url(), root)",
            "        self.assertEqual(child.get_absolute_url(), root + 'child/')",
            "        self.assertEqual(child.get_public_object().get_absolute_url(), root + 'child/')",
            "        self.assertEqual(other.get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(other.get_public_object().get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(child2.get_absolute_url(), root + 'another-page/child/')",
            "        self.assertEqual(child2.get_public_object().get_absolute_url(), root + 'another-page/child/')",
            "        home = self.reload(home)",
            "        home.unpublish('en')",
            "        home = self.reload(home)",
            "        other = self.reload(other)",
            "        child = self.reload(child)",
            "        child2 = self.reload(child2)",
            "        self.assertFalse(home.is_home)",
            "        self.assertFalse(home.publisher_public.is_home)",
            "        self.assertTrue(other.is_home)",
            "        self.assertTrue(other.publisher_public.is_home)",
            "",
            "        self.assertEqual(other.get_absolute_url(), root)",
            "        self.assertEqual(other.get_public_object().get_absolute_url(), root)",
            "        self.assertEqual(home.get_absolute_url(), root + 'page/')",
            "        self.assertEqual(home.get_public_object().get_absolute_url(), root + 'page/')",
            "",
            "        self.assertEqual(child.get_absolute_url(), root + 'page/child/')",
            "        self.assertEqual(child.get_public_object().get_absolute_url(), root + 'page/child/')",
            "        self.assertEqual(child2.get_absolute_url(), root + 'child/')",
            "        self.assertEqual(child2.get_public_object().get_absolute_url(), root + 'child/')",
            "        home.publish('en')",
            "        home = self.reload(home)",
            "        other = self.reload(other)",
            "        child = self.reload(child)",
            "        child2 = self.reload(child2)",
            "        self.assertTrue(home.is_home)",
            "        self.assertTrue(home.publisher_public.is_home)",
            "        self.assertEqual(home.get_absolute_url(), root)",
            "        self.assertEqual(home.get_public_object().get_absolute_url(), root)",
            "        self.assertEqual(child.get_absolute_url(), root + 'child/')",
            "        self.assertEqual(child.get_public_object().get_absolute_url(), root + 'child/')",
            "        self.assertEqual(other.get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(other.get_public_object().get_absolute_url(), root + 'another-page/')",
            "        self.assertEqual(child2.get_absolute_url(), root + 'another-page/child/')",
            "        self.assertEqual(child2.get_public_object().get_absolute_url(), root + 'another-page/child/')",
            "",
            "    def test_revert_contents(self):",
            "        user = self.get_superuser()",
            "        page = create_page(\"Page\", \"nav_playground.html\", \"en\", published=True,",
            "                           created_by=user)",
            "        placeholder = page.placeholders.get(slot=u\"body\")",
            "        deleted_plugin = add_plugin(placeholder, u\"TextPlugin\", u\"en\", body=\"Deleted content\")",
            "        text_plugin = add_plugin(placeholder, u\"TextPlugin\", u\"en\", body=\"Public content\")",
            "        page.publish('en')",
            "",
            "        # Modify and delete plugins",
            "        text_plugin.body = \"<p>Draft content</p>\"",
            "        text_plugin.save()",
            "        deleted_plugin.delete()",
            "        self.assertEqual(CMSPlugin.objects.count(), 3)",
            "",
            "        # Now let's revert and restore",
            "        page.revert('en')",
            "        self.assertEqual(page.get_publisher_state(\"en\"), PUBLISHER_STATE_DEFAULT)",
            "",
            "        self.assertEqual(CMSPlugin.objects.count(), 4)",
            "        plugins = CMSPlugin.objects.filter(placeholder__page=page)",
            "        self.assertEqual(plugins.count(), 2)",
            "",
            "        plugins = [plugin.get_plugin_instance()[0] for plugin in plugins]",
            "        self.assertEqual(plugins[0].body, \"Deleted content\")",
            "        self.assertEqual(plugins[1].body, \"Public content\")",
            "",
            "    def test_revert_move(self):",
            "        parent = create_page(\"Parent\", \"nav_playground.html\", \"en\", published=True)",
            "        parent_url = parent.get_absolute_url()",
            "        page = create_page(\"Page\", \"nav_playground.html\", \"en\", published=True,",
            "                           parent=parent)",
            "        other = create_page(\"Other\", \"nav_playground.html\", \"en\", published=True)",
            "        other_url = other.get_absolute_url()",
            "",
            "        child = create_page(\"Child\", \"nav_playground.html\", \"en\", published=True,",
            "                            parent=page)",
            "        parent = parent.reload()",
            "        page = page.reload()",
            "        self.assertEqual(page.get_absolute_url(), parent_url + \"page/\")",
            "        self.assertEqual(child.get_absolute_url(), parent_url + \"page/child/\")",
            "",
            "        # Now let's move it (and the child)",
            "        page.move_page(other)",
            "        page = self.reload(page)",
            "        child = self.reload(child)",
            "        self.assertEqual(page.get_absolute_url(), other_url + \"page/\")",
            "        self.assertEqual(child.get_absolute_url(), other_url + \"page/child/\")",
            "        # Public version changed the url as well",
            "        self.assertEqual(page.publisher_public.get_absolute_url(), other_url + \"page/\")",
            "        self.assertEqual(child.publisher_public.get_absolute_url(), other_url + \"page/child/\")",
            "",
            "    def test_publish_works_with_descendants(self):",
            "        \"\"\"",
            "        For help understanding what this tests for, see:",
            "        http://articles.sitepoint.com/print/hierarchical-data-database",
            "",
            "        Creates this published structure:",
            "                            home",
            "                          /      \\",
            "                       item1   item2",
            "                              /     \\",
            "                         subitem1 subitem2",
            "        \"\"\"",
            "        home_page = create_page(\"home\", \"nav_playground.html\", \"en\",",
            "                                published=True, in_navigation=False)",
            "",
            "        create_page(\"item1\", \"nav_playground.html\", \"en\", parent=home_page,",
            "                    published=True)",
            "        item2 = create_page(\"item2\", \"nav_playground.html\", \"en\", parent=home_page,",
            "                            published=True)",
            "",
            "        create_page(\"subitem1\", \"nav_playground.html\", \"en\", parent=item2,",
            "                    published=True)",
            "        create_page(\"subitem2\", \"nav_playground.html\", \"en\", parent=item2,",
            "                    published=True)",
            "        item2 = item2.reload()",
            "        not_drafts = list(Page.objects.filter(publisher_is_draft=False).order_by('lft'))",
            "        drafts = list(Page.objects.filter(publisher_is_draft=True).order_by('lft'))",
            "",
            "        self.assertEqual(len(not_drafts), 5)",
            "        self.assertEqual(len(drafts), 5)",
            "",
            "        for idx, draft in enumerate(drafts):",
            "            public = not_drafts[idx]",
            "            # Check that a node doesn't become a root node magically",
            "            self.assertEqual(bool(public.parent_id), bool(draft.parent_id))",
            "            if public.parent:",
            "                # Let's assert the MPTT tree is consistent",
            "                self.assertTrue(public.lft > public.parent.lft)",
            "                self.assertTrue(public.rght < public.parent.rght)",
            "                self.assertEqual(public.tree_id, public.parent.tree_id)",
            "                self.assertTrue(public.parent in public.get_ancestors())",
            "                self.assertTrue(public in public.parent.get_descendants())",
            "                self.assertTrue(public in public.parent.get_children())",
            "            if draft.parent:",
            "                # Same principle for the draft tree",
            "                self.assertTrue(draft.lft > draft.parent.lft)",
            "                self.assertTrue(draft.rght < draft.parent.rght)",
            "                self.assertEqual(draft.tree_id, draft.parent.tree_id)",
            "                self.assertTrue(draft.parent in draft.get_ancestors())",
            "                self.assertTrue(draft in draft.parent.get_descendants())",
            "                self.assertTrue(draft in draft.parent.get_children())",
            "",
            "        # Now call publish again. The structure should not change.",
            "        item2.publish('en')",
            "",
            "        not_drafts = list(Page.objects.filter(publisher_is_draft=False).order_by('lft'))",
            "        drafts = list(Page.objects.filter(publisher_is_draft=True).order_by('lft'))",
            "",
            "        self.assertEqual(len(not_drafts), 5)",
            "        self.assertEqual(len(drafts), 5)",
            "",
            "        for idx, draft in enumerate(drafts):",
            "            public = not_drafts[idx]",
            "            # Check that a node doesn't become a root node magically",
            "            self.assertEqual(bool(public.parent_id), bool(draft.parent_id))",
            "            if public.parent:",
            "                # Let's assert the MPTT tree is consistent",
            "                self.assertTrue(public.lft > public.parent.lft)",
            "                self.assertTrue(public.rght < public.parent.rght)",
            "                self.assertEqual(public.tree_id, public.parent.tree_id)",
            "                self.assertTrue(public.parent in public.get_ancestors())",
            "                self.assertTrue(public in public.parent.get_descendants())",
            "                self.assertTrue(public in public.parent.get_children())",
            "            if draft.parent:",
            "                # Same principle for the draft tree",
            "                self.assertTrue(draft.lft > draft.parent.lft)",
            "                self.assertTrue(draft.rght < draft.parent.rght)",
            "                self.assertEqual(draft.tree_id, draft.parent.tree_id)",
            "                self.assertTrue(draft.parent in draft.get_ancestors())",
            "                self.assertTrue(draft in draft.parent.get_descendants())",
            "                self.assertTrue(draft in draft.parent.get_children())"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "345": [
                "PublishingTests",
                "test_publish_home"
            ],
            "384": [
                "PublishingTests",
                "test_publish_admin"
            ],
            "399": [
                "PublishingTests",
                "test_publish_wrong_lang"
            ]
        },
        "addLocation": []
    },
    "cms/tests/reversion_tests.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 246,
                "afterPatchRowNumber": 246,
                "PatchRowcode": "                 self.assertEqual(Revision.objects.all().count(), 5)"
            },
            "1": {
                "beforePatchRowNumber": 247,
                "afterPatchRowNumber": 247,
                "PatchRowcode": "                 for x in range(10):"
            },
            "2": {
                "beforePatchRowNumber": 248,
                "afterPatchRowNumber": 248,
                "PatchRowcode": "                     publish_url = URL_CMS_PAGE + \"%s/en/publish/\" % page_pk"
            },
            "3": {
                "beforePatchRowNumber": 249,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-                    response = self.client.get(publish_url)"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 249,
                "PatchRowcode": "+                    response = self.client.post(publish_url)"
            },
            "5": {
                "beforePatchRowNumber": 250,
                "afterPatchRowNumber": 250,
                "PatchRowcode": "                     self.assertEqual(response.status_code, 302)"
            },
            "6": {
                "beforePatchRowNumber": 251,
                "afterPatchRowNumber": 251,
                "PatchRowcode": "                 self.assertEqual(Revision.objects.all().count(), 4)"
            },
            "7": {
                "beforePatchRowNumber": 252,
                "afterPatchRowNumber": 252,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from __future__ import with_statement",
            "import shutil",
            "from os.path import join",
            "from cms.utils.conf import get_cms_setting",
            "from cms.utils.urlutils import admin_reverse",
            "",
            "from djangocms_text_ckeditor.models import Text",
            "from django.conf import settings",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.core.files.uploadedfile import SimpleUploadedFile",
            "import reversion",
            "from reversion.models import Revision, Version",
            "",
            "from cms.models import Page, Title, Placeholder",
            "from cms.models.pluginmodel import CMSPlugin",
            "from cms.test_utils.project.fileapp.models import FileModel",
            "from cms.test_utils.testcases import CMSTestCase, TransactionCMSTestCase, URL_CMS_PAGE, URL_CMS_PAGE_CHANGE, URL_CMS_PAGE_ADD, \\",
            "    URL_CMS_PLUGIN_ADD, URL_CMS_PLUGIN_EDIT",
            "from cms.test_utils.util.context_managers import SettingsOverride",
            "",
            "if hasattr(reversion.models, 'VERSION_CHANGE'):",
            "    from reversion.models import VERSION_CHANGE",
            "",
            "",
            "class BasicReversionTestCase(CMSTestCase):",
            "    def setUp(self):        ",
            "        self.user = self._create_user(\"test\", True, True)",
            "",
            "    def test_number_revisions(self):",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Revision.objects.all().count(), 0)",
            "            self.page_data = self.get_new_page_data()",
            "",
            "            response = self.client.post(URL_CMS_PAGE_ADD, self.page_data)",
            "",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(Revision.objects.all().count(), 1)",
            "",
            "",
            "class ReversionTestCase(TransactionCMSTestCase):",
            "    def setUp(self):",
            "        u = self._create_user(\"test\", True, True)",
            "",
            "        with self.login_user_context(u):",
            "            # add a new text plugin",
            "            self.page_data = self.get_new_page_data()",
            "            response = self.client.post(URL_CMS_PAGE_ADD, self.page_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "            page = Page.objects.all()[0]",
            "            placeholderpk = page.placeholders.get(slot=\"body\").pk",
            "            plugin_data = {",
            "                'plugin_type': \"TextPlugin\",",
            "                'plugin_language': settings.LANGUAGES[0][0],",
            "                'placeholder_id': placeholderpk,",
            "                'plugin_parent': '',",
            "            }",
            "            response = self.client.post(URL_CMS_PLUGIN_ADD, plugin_data)",
            "            self.assertEqual(response.status_code, 200)",
            "            # now edit the plugin",
            "            edit_url = URL_CMS_PLUGIN_EDIT + response.content.decode('utf8').split(\"edit-plugin/\")[1].split(\"/\")[",
            "                0] + \"/\"",
            "            response = self.client.get(edit_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(edit_url, {\"body\": \"Hello World\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            txt = Text.objects.all()[0]",
            "            self.assertEqual(\"Hello World\", txt.body)",
            "            self.txt = txt",
            "            # change the content",
            "            response = self.client.post(edit_url, {\"body\": \"Bye Bye World\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            txt = Text.objects.all()[0]",
            "            self.assertEqual(\"Bye Bye World\", txt.body)",
            "            p_data = self.page_data.copy()",
            "            response = self.client.post(URL_CMS_PAGE_CHANGE % page.pk, p_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "            page.publish('en')",
            "",
            "        self.user = u",
            "",
            "    def test_revert(self):",
            "        \"\"\"",
            "        Test that you can revert a plugin",
            "        \"\"\"",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(Title.objects.all().count(), 2)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "            self.assertEqual(Revision.objects.all().count(), 5)",
            "",
            "            ctype = ContentType.objects.get_for_model(Page)",
            "            revision = Revision.objects.all()[2]",
            "            version = Version.objects.get(content_type=ctype, revision=revision)",
            "            page = Page.objects.all()[0]",
            "",
            "            history_url = URL_CMS_PAGE_CHANGE % (page.pk) + \"history/\"",
            "            response = self.client.get(history_url)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "            revert_url = history_url + \"%s/\" % version.pk",
            "            response = self.client.get(revert_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(\"%s?language=en&\" % revert_url, self.page_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE_CHANGE % page.pk)",
            "            # test for publisher_is_draft, published is set for both draft and",
            "            # published page",
            "            self.assertEqual(Page.objects.all()[0].publisher_is_draft, True)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "",
            "            # test that CMSPlugin subclasses are reverted",
            "            self.assertEqual(Text.objects.all().count(), 2)",
            "            self.assertEqual(Text.objects.get(pk=self.txt.pk).body, \"Hello World\")",
            "            self.assertEqual(Revision.objects.all().count(), 6)",
            "",
            "    def test_undo_redo(self):",
            "        \"\"\"",
            "        Test that you can revert a plugin",
            "        \"\"\"",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(Title.objects.all().count(), 2)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "            self.assertEqual(Revision.objects.all().count(), 5)",
            "            self.assertEqual(Placeholder.objects.count(), 5)",
            "",
            "            ctype = ContentType.objects.get_for_model(Page)",
            "            revision = Revision.objects.all()[2]",
            "            Version.objects.get(content_type=ctype, revision=revision)",
            "            page = Page.objects.all()[0]",
            "",
            "            undo_url = admin_reverse(\"cms_page_undo\", args=[page.pk])",
            "            response = self.client.post(undo_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            page = Page.objects.all()[0]",
            "            self.assertTrue(page.revision_id != 0)",
            "            rev = page.revision_id",
            "            redo_url = admin_reverse(\"cms_page_redo\", args=[page.pk])",
            "            response = self.client.post(redo_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            page = Page.objects.all()[0]",
            "            self.assertTrue(page.revision_id != rev)",
            "            txt = Text.objects.all()[0]",
            "            edit_url = URL_CMS_PLUGIN_EDIT + str(txt.pk) + \"/\"",
            "            response = self.client.post(edit_url, {\"body\": \"Hello World2\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            page = Page.objects.all()[0]",
            "            self.assertEqual(page.revision_id, 0)",
            "            self.assertEqual(2, CMSPlugin.objects.all().count())",
            "            placeholderpk = page.placeholders.filter(slot=\"body\")[0].pk",
            "            plugin_data = {",
            "                'plugin_type': \"TextPlugin\",",
            "                'plugin_language': settings.LANGUAGES[0][0],",
            "                'placeholder_id': placeholderpk,",
            "                'plugin_parent': '',",
            "            }",
            "            response = self.client.post(URL_CMS_PLUGIN_ADD, plugin_data)",
            "            self.assertEqual(response.status_code, 200)",
            "            # now edit the plugin",
            "            edit_url = URL_CMS_PLUGIN_EDIT + response.content.decode('utf8').split(\"edit-plugin/\")[1].split(\"/\")[",
            "                0] + \"/\"",
            "            response = self.client.get(edit_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(edit_url, {\"body\": \"Hello World\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(3, CMSPlugin.objects.all().count())",
            "            self.client.post(undo_url)",
            "            self.client.post(undo_url)",
            "            self.assertEqual(2, CMSPlugin.objects.all().count())",
            "            self.assertEqual(Placeholder.objects.count(), 5)",
            "",
            "    def test_undo_slug_collision(self):",
            "        data1 = self.get_new_page_data()",
            "        data2 = self.get_new_page_data()",
            "        data1['slug'] = 'page1'",
            "        data2['slug'] = 'page2'",
            "        with self.login_user_context(self.get_superuser()):",
            "            response = self.client.post(URL_CMS_PAGE_ADD, data1)",
            "            self.assertEqual(response.status_code, 302)",
            "            response = self.client.post(URL_CMS_PAGE_ADD, data2)",
            "            self.assertEqual(response.status_code, 302)",
            "            page1 = Page.objects.get(title_set__slug='page1')",
            "            page2 = Page.objects.get(title_set__slug='page2')",
            "            data1['slug'] = 'page3'",
            "            response = self.client.post(URL_CMS_PAGE_CHANGE % page1.pk, data1)",
            "            self.assertEqual(response.status_code, 302)",
            "            data2['slug'] = 'page1'",
            "            response = self.client.post(URL_CMS_PAGE_CHANGE % page2.pk, data2)",
            "            self.assertEqual(response.status_code, 302)",
            "",
            "            undo_url = admin_reverse(\"cms_page_undo\", args=[page1.pk])",
            "            response = self.client.post(undo_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(Title.objects.get(page=page1).slug, 'page3')",
            "            response = self.client.get(admin_reverse(\"cms_page_changelist\"))",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON'))",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.get('/en/page1/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON'))",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "    def test_recover(self):",
            "        \"\"\"",
            "        Test that you can recover a page",
            "        \"\"\"",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Revision.objects.all().count(), 5)",
            "            ctype = ContentType.objects.get_for_model(Page)",
            "            revision = Revision.objects.all()[4]",
            "            version = Version.objects.filter(content_type=ctype, revision=revision)[0]",
            "",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "            self.assertEqual(Text.objects.all().count(), 2)",
            "",
            "            page = Page.objects.all()[0]",
            "            page_pk = page.pk",
            "            page.delete()",
            "",
            "            self.assertEqual(Page.objects.all().count(), 0)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 0)",
            "            self.assertEqual(Text.objects.all().count(), 0)",
            "",
            "            recover_url = URL_CMS_PAGE + \"recover/\"",
            "            response = self.client.get(recover_url)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "            recover_url += \"%s/\" % version.pk",
            "            response = self.client.get(recover_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(recover_url, self.page_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE_CHANGE % page_pk)",
            "            self.assertEqual(Page.objects.all().count(), 1)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 1)",
            "",
            "            # test that CMSPlugin subclasses are recovered",
            "            self.assertEqual(Text.objects.all().count(), 1)",
            "",
            "    def test_publish_limits(self):",
            "        with self.login_user_context(self.user):",
            "            with SettingsOverride(CMS_MAX_PAGE_PUBLISH_REVERSIONS=2, CMS_MAX_PAGE_HISTORY_REVERSIONS=2):",
            "                page = Page.objects.all()[0]",
            "                page_pk = page.pk",
            "                self.assertEqual(Revision.objects.all().count(), 5)",
            "                for x in range(10):",
            "                    publish_url = URL_CMS_PAGE + \"%s/en/publish/\" % page_pk",
            "                    response = self.client.get(publish_url)",
            "                    self.assertEqual(response.status_code, 302)",
            "                self.assertEqual(Revision.objects.all().count(), 4)",
            "",
            "",
            "class ReversionFileFieldTests(CMSTestCase):",
            "    def tearDown(self):",
            "        shutil.rmtree(join(settings.MEDIA_ROOT, 'fileapp'))",
            "",
            "    def test_file_persistence(self):",
            "        content = b'content1'",
            "        with reversion.create_revision():",
            "            # add a file instance",
            "            file1 = FileModel()",
            "            file1.test_file.save('file1.txt', SimpleUploadedFile('file1.txt', content), False)",
            "            file1.save()",
            "            # manually add a revision because we use the explicit way",
            "            # django-cms uses too.",
            "            adapter = reversion.get_adapter(FileModel)",
            "            if hasattr(reversion.models, 'VERSION_CHANGE'):",
            "                reversion.revision_context_manager.add_to_context(",
            "                    reversion.default_revision_manager, file1,",
            "                    adapter.get_version_data(file1, VERSION_CHANGE))",
            "            else:",
            "                reversion.revision_context_manager.add_to_context(",
            "                    reversion.default_revision_manager, file1,",
            "                    adapter.get_version_data(file1))",
            "                # reload the instance from db",
            "        file2 = FileModel.objects.all()[0]",
            "        # delete the instance.",
            "        file2.delete()",
            "",
            "        # revert the old version",
            "        file_version = reversion.get_for_object(file1)[0]",
            "        file_version.revert()",
            "",
            "        # reload the reverted instance and check for its content",
            "        file1 = FileModel.objects.all()[0]",
            "        self.assertEqual(file1.test_file.file.read(), content)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "from __future__ import with_statement",
            "import shutil",
            "from os.path import join",
            "from cms.utils.conf import get_cms_setting",
            "from cms.utils.urlutils import admin_reverse",
            "",
            "from djangocms_text_ckeditor.models import Text",
            "from django.conf import settings",
            "from django.contrib.contenttypes.models import ContentType",
            "from django.core.files.uploadedfile import SimpleUploadedFile",
            "import reversion",
            "from reversion.models import Revision, Version",
            "",
            "from cms.models import Page, Title, Placeholder",
            "from cms.models.pluginmodel import CMSPlugin",
            "from cms.test_utils.project.fileapp.models import FileModel",
            "from cms.test_utils.testcases import CMSTestCase, TransactionCMSTestCase, URL_CMS_PAGE, URL_CMS_PAGE_CHANGE, URL_CMS_PAGE_ADD, \\",
            "    URL_CMS_PLUGIN_ADD, URL_CMS_PLUGIN_EDIT",
            "from cms.test_utils.util.context_managers import SettingsOverride",
            "",
            "if hasattr(reversion.models, 'VERSION_CHANGE'):",
            "    from reversion.models import VERSION_CHANGE",
            "",
            "",
            "class BasicReversionTestCase(CMSTestCase):",
            "    def setUp(self):        ",
            "        self.user = self._create_user(\"test\", True, True)",
            "",
            "    def test_number_revisions(self):",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Revision.objects.all().count(), 0)",
            "            self.page_data = self.get_new_page_data()",
            "",
            "            response = self.client.post(URL_CMS_PAGE_ADD, self.page_data)",
            "",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(Revision.objects.all().count(), 1)",
            "",
            "",
            "class ReversionTestCase(TransactionCMSTestCase):",
            "    def setUp(self):",
            "        u = self._create_user(\"test\", True, True)",
            "",
            "        with self.login_user_context(u):",
            "            # add a new text plugin",
            "            self.page_data = self.get_new_page_data()",
            "            response = self.client.post(URL_CMS_PAGE_ADD, self.page_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "",
            "            page = Page.objects.all()[0]",
            "            placeholderpk = page.placeholders.get(slot=\"body\").pk",
            "            plugin_data = {",
            "                'plugin_type': \"TextPlugin\",",
            "                'plugin_language': settings.LANGUAGES[0][0],",
            "                'placeholder_id': placeholderpk,",
            "                'plugin_parent': '',",
            "            }",
            "            response = self.client.post(URL_CMS_PLUGIN_ADD, plugin_data)",
            "            self.assertEqual(response.status_code, 200)",
            "            # now edit the plugin",
            "            edit_url = URL_CMS_PLUGIN_EDIT + response.content.decode('utf8').split(\"edit-plugin/\")[1].split(\"/\")[",
            "                0] + \"/\"",
            "            response = self.client.get(edit_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(edit_url, {\"body\": \"Hello World\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            txt = Text.objects.all()[0]",
            "            self.assertEqual(\"Hello World\", txt.body)",
            "            self.txt = txt",
            "            # change the content",
            "            response = self.client.post(edit_url, {\"body\": \"Bye Bye World\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            txt = Text.objects.all()[0]",
            "            self.assertEqual(\"Bye Bye World\", txt.body)",
            "            p_data = self.page_data.copy()",
            "            response = self.client.post(URL_CMS_PAGE_CHANGE % page.pk, p_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE)",
            "            page.publish('en')",
            "",
            "        self.user = u",
            "",
            "    def test_revert(self):",
            "        \"\"\"",
            "        Test that you can revert a plugin",
            "        \"\"\"",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(Title.objects.all().count(), 2)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "            self.assertEqual(Revision.objects.all().count(), 5)",
            "",
            "            ctype = ContentType.objects.get_for_model(Page)",
            "            revision = Revision.objects.all()[2]",
            "            version = Version.objects.get(content_type=ctype, revision=revision)",
            "            page = Page.objects.all()[0]",
            "",
            "            history_url = URL_CMS_PAGE_CHANGE % (page.pk) + \"history/\"",
            "            response = self.client.get(history_url)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "            revert_url = history_url + \"%s/\" % version.pk",
            "            response = self.client.get(revert_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(\"%s?language=en&\" % revert_url, self.page_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE_CHANGE % page.pk)",
            "            # test for publisher_is_draft, published is set for both draft and",
            "            # published page",
            "            self.assertEqual(Page.objects.all()[0].publisher_is_draft, True)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "",
            "            # test that CMSPlugin subclasses are reverted",
            "            self.assertEqual(Text.objects.all().count(), 2)",
            "            self.assertEqual(Text.objects.get(pk=self.txt.pk).body, \"Hello World\")",
            "            self.assertEqual(Revision.objects.all().count(), 6)",
            "",
            "    def test_undo_redo(self):",
            "        \"\"\"",
            "        Test that you can revert a plugin",
            "        \"\"\"",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(Title.objects.all().count(), 2)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "            self.assertEqual(Revision.objects.all().count(), 5)",
            "            self.assertEqual(Placeholder.objects.count(), 5)",
            "",
            "            ctype = ContentType.objects.get_for_model(Page)",
            "            revision = Revision.objects.all()[2]",
            "            Version.objects.get(content_type=ctype, revision=revision)",
            "            page = Page.objects.all()[0]",
            "",
            "            undo_url = admin_reverse(\"cms_page_undo\", args=[page.pk])",
            "            response = self.client.post(undo_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            page = Page.objects.all()[0]",
            "            self.assertTrue(page.revision_id != 0)",
            "            rev = page.revision_id",
            "            redo_url = admin_reverse(\"cms_page_redo\", args=[page.pk])",
            "            response = self.client.post(redo_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            page = Page.objects.all()[0]",
            "            self.assertTrue(page.revision_id != rev)",
            "            txt = Text.objects.all()[0]",
            "            edit_url = URL_CMS_PLUGIN_EDIT + str(txt.pk) + \"/\"",
            "            response = self.client.post(edit_url, {\"body\": \"Hello World2\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            page = Page.objects.all()[0]",
            "            self.assertEqual(page.revision_id, 0)",
            "            self.assertEqual(2, CMSPlugin.objects.all().count())",
            "            placeholderpk = page.placeholders.filter(slot=\"body\")[0].pk",
            "            plugin_data = {",
            "                'plugin_type': \"TextPlugin\",",
            "                'plugin_language': settings.LANGUAGES[0][0],",
            "                'placeholder_id': placeholderpk,",
            "                'plugin_parent': '',",
            "            }",
            "            response = self.client.post(URL_CMS_PLUGIN_ADD, plugin_data)",
            "            self.assertEqual(response.status_code, 200)",
            "            # now edit the plugin",
            "            edit_url = URL_CMS_PLUGIN_EDIT + response.content.decode('utf8').split(\"edit-plugin/\")[1].split(\"/\")[",
            "                0] + \"/\"",
            "            response = self.client.get(edit_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(edit_url, {\"body\": \"Hello World\"})",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(3, CMSPlugin.objects.all().count())",
            "            self.client.post(undo_url)",
            "            self.client.post(undo_url)",
            "            self.assertEqual(2, CMSPlugin.objects.all().count())",
            "            self.assertEqual(Placeholder.objects.count(), 5)",
            "",
            "    def test_undo_slug_collision(self):",
            "        data1 = self.get_new_page_data()",
            "        data2 = self.get_new_page_data()",
            "        data1['slug'] = 'page1'",
            "        data2['slug'] = 'page2'",
            "        with self.login_user_context(self.get_superuser()):",
            "            response = self.client.post(URL_CMS_PAGE_ADD, data1)",
            "            self.assertEqual(response.status_code, 302)",
            "            response = self.client.post(URL_CMS_PAGE_ADD, data2)",
            "            self.assertEqual(response.status_code, 302)",
            "            page1 = Page.objects.get(title_set__slug='page1')",
            "            page2 = Page.objects.get(title_set__slug='page2')",
            "            data1['slug'] = 'page3'",
            "            response = self.client.post(URL_CMS_PAGE_CHANGE % page1.pk, data1)",
            "            self.assertEqual(response.status_code, 302)",
            "            data2['slug'] = 'page1'",
            "            response = self.client.post(URL_CMS_PAGE_CHANGE % page2.pk, data2)",
            "            self.assertEqual(response.status_code, 302)",
            "",
            "            undo_url = admin_reverse(\"cms_page_undo\", args=[page1.pk])",
            "            response = self.client.post(undo_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            self.assertEqual(Title.objects.get(page=page1).slug, 'page3')",
            "            response = self.client.get(admin_reverse(\"cms_page_changelist\"))",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.get('/en/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON'))",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.get('/en/page1/?%s' % get_cms_setting('CMS_TOOLBAR_URL__EDIT_ON'))",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "    def test_recover(self):",
            "        \"\"\"",
            "        Test that you can recover a page",
            "        \"\"\"",
            "        with self.login_user_context(self.user):",
            "            self.assertEqual(Revision.objects.all().count(), 5)",
            "            ctype = ContentType.objects.get_for_model(Page)",
            "            revision = Revision.objects.all()[4]",
            "            version = Version.objects.filter(content_type=ctype, revision=revision)[0]",
            "",
            "            self.assertEqual(Page.objects.all().count(), 2)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 2)",
            "            self.assertEqual(Text.objects.all().count(), 2)",
            "",
            "            page = Page.objects.all()[0]",
            "            page_pk = page.pk",
            "            page.delete()",
            "",
            "            self.assertEqual(Page.objects.all().count(), 0)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 0)",
            "            self.assertEqual(Text.objects.all().count(), 0)",
            "",
            "            recover_url = URL_CMS_PAGE + \"recover/\"",
            "            response = self.client.get(recover_url)",
            "            self.assertEqual(response.status_code, 200)",
            "",
            "            recover_url += \"%s/\" % version.pk",
            "            response = self.client.get(recover_url)",
            "            self.assertEqual(response.status_code, 200)",
            "            response = self.client.post(recover_url, self.page_data)",
            "            self.assertRedirects(response, URL_CMS_PAGE_CHANGE % page_pk)",
            "            self.assertEqual(Page.objects.all().count(), 1)",
            "            self.assertEqual(CMSPlugin.objects.all().count(), 1)",
            "",
            "            # test that CMSPlugin subclasses are recovered",
            "            self.assertEqual(Text.objects.all().count(), 1)",
            "",
            "    def test_publish_limits(self):",
            "        with self.login_user_context(self.user):",
            "            with SettingsOverride(CMS_MAX_PAGE_PUBLISH_REVERSIONS=2, CMS_MAX_PAGE_HISTORY_REVERSIONS=2):",
            "                page = Page.objects.all()[0]",
            "                page_pk = page.pk",
            "                self.assertEqual(Revision.objects.all().count(), 5)",
            "                for x in range(10):",
            "                    publish_url = URL_CMS_PAGE + \"%s/en/publish/\" % page_pk",
            "                    response = self.client.post(publish_url)",
            "                    self.assertEqual(response.status_code, 302)",
            "                self.assertEqual(Revision.objects.all().count(), 4)",
            "",
            "",
            "class ReversionFileFieldTests(CMSTestCase):",
            "    def tearDown(self):",
            "        shutil.rmtree(join(settings.MEDIA_ROOT, 'fileapp'))",
            "",
            "    def test_file_persistence(self):",
            "        content = b'content1'",
            "        with reversion.create_revision():",
            "            # add a file instance",
            "            file1 = FileModel()",
            "            file1.test_file.save('file1.txt', SimpleUploadedFile('file1.txt', content), False)",
            "            file1.save()",
            "            # manually add a revision because we use the explicit way",
            "            # django-cms uses too.",
            "            adapter = reversion.get_adapter(FileModel)",
            "            if hasattr(reversion.models, 'VERSION_CHANGE'):",
            "                reversion.revision_context_manager.add_to_context(",
            "                    reversion.default_revision_manager, file1,",
            "                    adapter.get_version_data(file1, VERSION_CHANGE))",
            "            else:",
            "                reversion.revision_context_manager.add_to_context(",
            "                    reversion.default_revision_manager, file1,",
            "                    adapter.get_version_data(file1))",
            "                # reload the instance from db",
            "        file2 = FileModel.objects.all()[0]",
            "        # delete the instance.",
            "        file2.delete()",
            "",
            "        # revert the old version",
            "        file_version = reversion.get_for_object(file1)[0]",
            "        file_version.revert()",
            "",
            "        # reload the reverted instance and check for its content",
            "        file1 = FileModel.objects.all()[0]",
            "        self.assertEqual(file1.test_file.file.read(), content)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "249": [
                "ReversionTestCase",
                "test_publish_limits"
            ]
        },
        "addLocation": []
    }
}