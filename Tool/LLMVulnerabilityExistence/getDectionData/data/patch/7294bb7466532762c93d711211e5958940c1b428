{
    "rdiffweb/controller/tests/test_csrf.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 71,
                "afterPatchRowNumber": 71,
                "PatchRowcode": "         self.getPage('/', method='POST')"
            },
            "1": {
                "beforePatchRowNumber": 72,
                "afterPatchRowNumber": 72,
                "PatchRowcode": "         # Then the request is accepted with 200 OK"
            },
            "2": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 73,
                "PatchRowcode": "         self.assertStatus(200)"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 74,
                "PatchRowcode": "+"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 75,
                "PatchRowcode": "+    def test_clickjacking_defense(self):"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 76,
                "PatchRowcode": "+        # Given a POST request made to rdiffweb"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 77,
                "PatchRowcode": "+        # When the request is made without an origin"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 78,
                "PatchRowcode": "+        self.getPage('/')"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 79,
                "PatchRowcode": "+        # Then the request is accepted with 200 OK"
            },
            "9": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 80,
                "PatchRowcode": "+        self.assertStatus(200)"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 81,
                "PatchRowcode": "+        self.assertHeaderItemValue('X-Frame-Options', 'DENY')"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Oct 20, 2021",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "import rdiffweb.test",
            "",
            "",
            "class CsrfTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_samesite_lax(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with SameSite=Lax",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('SameSite=Lax', cookie)",
            "",
            "    def test_samesite_lax_without_session(self):",
            "        # Given not a client sending no cookie",
            "        self.cookies = None",
            "        # When a query is made to a static path (without session)",
            "        self.getPage('/static/blue.css')",
            "        # Then Set-Cookie is not defined.",
            "        self.assertNoHeader('Set-Cookie')",
            "",
            "    def test_get_with_wrong_origin(self):",
            "        # Given a GET request made to rdiffweb",
            "        # When the request is made using a different origin",
            "        self.getPage('/', headers=[('Origin', 'http://www.examples.com')])",
            "        # Then the response status it 200 OK.",
            "        self.assertStatus(200)",
            "",
            "    def test_post_with_wrong_origin(self):",
            "        # Given a POST request made to rdiffweb",
            "        # When the request is made using a different origin",
            "        self.getPage('/', headers=[('Origin', 'http://www.examples.com')], method='POST')",
            "        # Then the request is refused with 403 Forbiden",
            "        self.assertStatus(403)",
            "        self.assertInBody('Unexpected Origin header')",
            "",
            "    def test_post_with_valid_origin(self):",
            "        # Given a POST request made to rdiffweb",
            "        # When the request is made using a different origin",
            "        base = 'http://%s:%s' % (self.HOST, self.PORT)",
            "        self.getPage('/', headers=[('Origin', base)], method='POST')",
            "        # Then the request is accepted with 200 OK",
            "        self.assertStatus(200)",
            "",
            "    def test_post_without_origin(self):",
            "        # Given a POST request made to rdiffweb",
            "        # When the request is made without an origin",
            "        self.getPage('/', method='POST')",
            "        # Then the request is accepted with 200 OK",
            "        self.assertStatus(200)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Created on Oct 20, 2021",
            "",
            "@author: Patrik Dufresne",
            "\"\"\"",
            "import rdiffweb.test",
            "",
            "",
            "class CsrfTest(rdiffweb.test.WebCase):",
            "",
            "    login = True",
            "",
            "    def test_samesite_lax(self):",
            "        # Given a request made to rdiffweb",
            "        # When receiving the response",
            "        self.getPage('/')",
            "        # Then the header contains Set-Cookie with SameSite=Lax",
            "        cookie = self.assertHeader('Set-Cookie')",
            "        self.assertIn('SameSite=Lax', cookie)",
            "",
            "    def test_samesite_lax_without_session(self):",
            "        # Given not a client sending no cookie",
            "        self.cookies = None",
            "        # When a query is made to a static path (without session)",
            "        self.getPage('/static/blue.css')",
            "        # Then Set-Cookie is not defined.",
            "        self.assertNoHeader('Set-Cookie')",
            "",
            "    def test_get_with_wrong_origin(self):",
            "        # Given a GET request made to rdiffweb",
            "        # When the request is made using a different origin",
            "        self.getPage('/', headers=[('Origin', 'http://www.examples.com')])",
            "        # Then the response status it 200 OK.",
            "        self.assertStatus(200)",
            "",
            "    def test_post_with_wrong_origin(self):",
            "        # Given a POST request made to rdiffweb",
            "        # When the request is made using a different origin",
            "        self.getPage('/', headers=[('Origin', 'http://www.examples.com')], method='POST')",
            "        # Then the request is refused with 403 Forbiden",
            "        self.assertStatus(403)",
            "        self.assertInBody('Unexpected Origin header')",
            "",
            "    def test_post_with_valid_origin(self):",
            "        # Given a POST request made to rdiffweb",
            "        # When the request is made using a different origin",
            "        base = 'http://%s:%s' % (self.HOST, self.PORT)",
            "        self.getPage('/', headers=[('Origin', base)], method='POST')",
            "        # Then the request is accepted with 200 OK",
            "        self.assertStatus(200)",
            "",
            "    def test_post_without_origin(self):",
            "        # Given a POST request made to rdiffweb",
            "        # When the request is made without an origin",
            "        self.getPage('/', method='POST')",
            "        # Then the request is accepted with 200 OK",
            "        self.assertStatus(200)",
            "",
            "    def test_clickjacking_defense(self):",
            "        # Given a POST request made to rdiffweb",
            "        # When the request is made without an origin",
            "        self.getPage('/')",
            "        # Then the request is accepted with 200 OK",
            "        self.assertStatus(200)",
            "        self.assertHeaderItemValue('X-Frame-Options', 'DENY')"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "src.sentry.auth.helper",
            "rdiffweb.controller.tests.test_csrf.CsrfTest.self"
        ]
    },
    "rdiffweb/tools/security.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 36,
                "afterPatchRowNumber": 36,
                "PatchRowcode": "     \"\"\""
            },
            "1": {
                "beforePatchRowNumber": 37,
                "afterPatchRowNumber": 37,
                "PatchRowcode": "     This tool provide CSRF mitigation."
            },
            "2": {
                "beforePatchRowNumber": 38,
                "afterPatchRowNumber": 38,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": 39,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    First, by defining `SameSite=Lax` on the cookie"
            },
            "4": {
                "beforePatchRowNumber": 40,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    Second by validating the `Origin` and `Referer`."
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 39,
                "PatchRowcode": "+    * Define X-Frame-Options = DENY"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 40,
                "PatchRowcode": "+    * Define Cookies SameSite=Lax"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 41,
                "PatchRowcode": "+    * Validate `Origin` and `Referer` on POST, PUT, PATCH, DELETE"
            },
            "8": {
                "beforePatchRowNumber": 41,
                "afterPatchRowNumber": 42,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 42,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    Ref.: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html"
            },
            "10": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 43,
                "PatchRowcode": "+    Ref.:"
            },
            "11": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 44,
                "PatchRowcode": "+    https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 45,
                "PatchRowcode": "+    https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html"
            },
            "13": {
                "beforePatchRowNumber": 43,
                "afterPatchRowNumber": 46,
                "PatchRowcode": "     \"\"\""
            },
            "14": {
                "beforePatchRowNumber": 44,
                "afterPatchRowNumber": 47,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 45,
                "afterPatchRowNumber": 48,
                "PatchRowcode": "     def __init__(self):"
            },
            "16": {
                "beforePatchRowNumber": 48,
                "afterPatchRowNumber": 51,
                "PatchRowcode": "         self._priority = 71"
            },
            "17": {
                "beforePatchRowNumber": 49,
                "afterPatchRowNumber": 52,
                "PatchRowcode": " "
            },
            "18": {
                "beforePatchRowNumber": 50,
                "afterPatchRowNumber": 53,
                "PatchRowcode": "     def _setup(self):"
            },
            "19": {
                "beforePatchRowNumber": 51,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cherrypy.request.hooks.attach('before_finalize', self._set_same_site)"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 54,
                "PatchRowcode": "+        cherrypy.request.hooks.attach('before_finalize', self._set_headers)"
            },
            "21": {
                "beforePatchRowNumber": 52,
                "afterPatchRowNumber": 55,
                "PatchRowcode": "         return super()._setup()"
            },
            "22": {
                "beforePatchRowNumber": 53,
                "afterPatchRowNumber": 56,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 54,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-    def _set_same_site(self):"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 57,
                "PatchRowcode": "+    def _set_headers(self):"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 58,
                "PatchRowcode": "+        response = cherrypy.serving.response"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 59,
                "PatchRowcode": "+        # Define X-Frame-Options to avoid Clickjacking"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 60,
                "PatchRowcode": "+        response.headers['X-Frame-Options'] = 'DENY'"
            },
            "28": {
                "beforePatchRowNumber": 55,
                "afterPatchRowNumber": 61,
                "PatchRowcode": "         # Awaiting bug fix in cherrypy"
            },
            "29": {
                "beforePatchRowNumber": 56,
                "afterPatchRowNumber": 62,
                "PatchRowcode": "         # https://github.com/cherrypy/cherrypy/issues/1767"
            },
            "30": {
                "beforePatchRowNumber": 57,
                "afterPatchRowNumber": 63,
                "PatchRowcode": "         # Force SameSite to Lax"
            },
            "31": {
                "beforePatchRowNumber": 58,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-        cookie = cherrypy.serving.response.cookie.get('session_id', None)"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 64,
                "PatchRowcode": "+        cookie = response.cookie.get('session_id', None)"
            },
            "33": {
                "beforePatchRowNumber": 59,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "         if cookie:"
            },
            "34": {
                "beforePatchRowNumber": 60,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "             cookie['samesite'] = 'Lax'"
            },
            "35": {
                "beforePatchRowNumber": 61,
                "afterPatchRowNumber": 67,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import http.cookies",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy._cptools import HandlerTool",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "#",
            "# Patch Morsel prior to 3.8",
            "# Allow SameSite attribute to be define on the cookie.",
            "#",
            "if not http.cookies.Morsel().isReservedKey(\"samesite\"):",
            "    http.cookies.Morsel._reserved['samesite'] = 'SameSite'",
            "",
            "",
            "class CsrfAuth(HandlerTool):",
            "    \"\"\"",
            "    This tool provide CSRF mitigation.",
            "",
            "    First, by defining `SameSite=Lax` on the cookie",
            "    Second by validating the `Origin` and `Referer`.",
            "",
            "    Ref.: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html",
            "    \"\"\"",
            "",
            "    def __init__(self):",
            "        HandlerTool.__init__(self, self.run, name='csrf')",
            "        # Make sure to run before authform (priority 71)",
            "        self._priority = 71",
            "",
            "    def _setup(self):",
            "        cherrypy.request.hooks.attach('before_finalize', self._set_same_site)",
            "        return super()._setup()",
            "",
            "    def _set_same_site(self):",
            "        # Awaiting bug fix in cherrypy",
            "        # https://github.com/cherrypy/cherrypy/issues/1767",
            "        # Force SameSite to Lax",
            "        cookie = cherrypy.serving.response.cookie.get('session_id', None)",
            "        if cookie:",
            "            cookie['samesite'] = 'Lax'",
            "",
            "    def run(self):",
            "        if cherrypy.request.method in ['POST', 'PUT', 'PATCH', 'DELETE']:",
            "            # Check if Origin matches our target.",
            "            origin = cherrypy.request.headers.get('Origin', None)",
            "            if origin and not origin.startswith(cherrypy.request.base):",
            "                raise cherrypy.HTTPError(403, 'Unexpected Origin header')",
            "",
            "",
            "cherrypy.tools.csrf = CsrfAuth()"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "import http.cookies",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy._cptools import HandlerTool",
            "",
            "# Define the logger",
            "logger = logging.getLogger(__name__)",
            "",
            "#",
            "# Patch Morsel prior to 3.8",
            "# Allow SameSite attribute to be define on the cookie.",
            "#",
            "if not http.cookies.Morsel().isReservedKey(\"samesite\"):",
            "    http.cookies.Morsel._reserved['samesite'] = 'SameSite'",
            "",
            "",
            "class CsrfAuth(HandlerTool):",
            "    \"\"\"",
            "    This tool provide CSRF mitigation.",
            "",
            "    * Define X-Frame-Options = DENY",
            "    * Define Cookies SameSite=Lax",
            "    * Validate `Origin` and `Referer` on POST, PUT, PATCH, DELETE",
            "",
            "    Ref.:",
            "    https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html",
            "    https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html",
            "    \"\"\"",
            "",
            "    def __init__(self):",
            "        HandlerTool.__init__(self, self.run, name='csrf')",
            "        # Make sure to run before authform (priority 71)",
            "        self._priority = 71",
            "",
            "    def _setup(self):",
            "        cherrypy.request.hooks.attach('before_finalize', self._set_headers)",
            "        return super()._setup()",
            "",
            "    def _set_headers(self):",
            "        response = cherrypy.serving.response",
            "        # Define X-Frame-Options to avoid Clickjacking",
            "        response.headers['X-Frame-Options'] = 'DENY'",
            "        # Awaiting bug fix in cherrypy",
            "        # https://github.com/cherrypy/cherrypy/issues/1767",
            "        # Force SameSite to Lax",
            "        cookie = response.cookie.get('session_id', None)",
            "        if cookie:",
            "            cookie['samesite'] = 'Lax'",
            "",
            "    def run(self):",
            "        if cherrypy.request.method in ['POST', 'PUT', 'PATCH', 'DELETE']:",
            "            # Check if Origin matches our target.",
            "            origin = cherrypy.request.headers.get('Origin', None)",
            "            if origin and not origin.startswith(cherrypy.request.base):",
            "                raise cherrypy.HTTPError(403, 'Unexpected Origin header')",
            "",
            "",
            "cherrypy.tools.csrf = CsrfAuth()"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "2",
            "2",
            "2",
            "2",
            "2",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "39": [
                "CsrfAuth"
            ],
            "40": [
                "CsrfAuth"
            ],
            "42": [
                "CsrfAuth"
            ],
            "51": [
                "CsrfAuth",
                "_setup"
            ],
            "54": [
                "CsrfAuth",
                "_set_same_site"
            ],
            "58": [
                "CsrfAuth",
                "_set_same_site"
            ]
        },
        "addLocation": []
    }
}