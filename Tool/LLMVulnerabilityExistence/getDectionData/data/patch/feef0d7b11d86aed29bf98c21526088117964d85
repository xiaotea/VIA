{
    "rdiffweb/controller/page_pref_notification.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 134,
                "afterPatchRowNumber": 134,
                "PatchRowcode": " \r"
            },
            "1": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 135,
                "PatchRowcode": " class PagePrefNotification(Controller):\r"
            },
            "2": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 136,
                "PatchRowcode": "     @cherrypy.expose\r"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 137,
                "PatchRowcode": "+    @cherrypy.tools.ratelimit(methods=['POST'])\r"
            },
            "4": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 138,
                "PatchRowcode": "     def default(self, **kwargs):\r"
            },
            "5": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": 139,
                "PatchRowcode": "         # Process the parameters.\r"
            },
            "6": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 140,
                "PatchRowcode": "         report_form = ReportForm(obj=self.app.currentuser)\r"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2023 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\"\"\"\r",
            "Plugin used to send email to users when their repository is getting too old.\r",
            "User can control the notification period.\r",
            "\"\"\"\r",
            "\r",
            "\r",
            "import logging\r",
            "\r",
            "import cherrypy\r",
            "from wtforms.fields import HiddenField, RadioField, SelectField, SubmitField\r",
            "\r",
            "from rdiffweb.controller import Controller, flash\r",
            "from rdiffweb.controller.form import CherryForm\r",
            "from rdiffweb.tools.i18n import gettext_lazy as _\r",
            "\r",
            "logger = logging.getLogger(__name__)\r",
            "\r",
            "\r",
            "class MaxAgeField(SelectField):\r",
            "    def __init__(self, *args, **kwargs):\r",
            "        super().__init__(\r",
            "            *args,\r",
            "            choices=[\r",
            "                (0, _('Never')),\r",
            "                (1, _('1 day')),\r",
            "                (2, _('2 days')),\r",
            "                (3, _('3 days')),\r",
            "                (4, _('4 days')),\r",
            "                (5, _('5 days')),\r",
            "                (6, _('6 days')),\r",
            "                (7, _('1 week')),\r",
            "                (14, _('2 weeks')),\r",
            "                (21, _('3 weeks')),\r",
            "                (28, _('4 weeks')),\r",
            "                (31, _('1 month')),\r",
            "            ],\r",
            "            coerce=int,\r",
            "            **kwargs\r",
            "        )\r",
            "\r",
            "\r",
            "class ReportForm(CherryForm):\r",
            "    action = HiddenField(default=\"set_report_info\")\r",
            "    report_time_range = RadioField(\r",
            "        _('Send me a backup status report'),\r",
            "        choices=[\r",
            "            (0, _('Never')),\r",
            "            (1, _('Daily')),\r",
            "            (7, _('Weekly')),\r",
            "            (30, _('Monthly')),\r",
            "        ],\r",
            "        coerce=int,\r",
            "    )\r",
            "    set_report_info = SubmitField(_('Save changes'), render_kw={\"class\": \"pull-left mr-2\"})\r",
            "    send_report = SubmitField(_('Save and send report'), render_kw={\"class\": \"btn-secondary pull-left\"})\r",
            "\r",
            "    def is_submitted(self):\r",
            "        return self.action.data == 'set_report_info' and super().is_submitted()\r",
            "\r",
            "    def populate_obj(self, userobj):\r",
            "\r",
            "        # Simply push the time_range to user's data\r",
            "        try:\r",
            "            userobj.report_time_range = self.report_time_range.data\r",
            "            userobj.commit()\r",
            "            # Validate if a report could be sent\r",
            "            if self.send_report.data:\r",
            "                if not userobj.report_time_range:\r",
            "                    raise ValueError(_('You must select a time range and save changes before sending a report.'))\r",
            "                if not userobj.email:\r",
            "                    raise ValueError(_('Could not send report to user without configured email.'))\r",
            "                cherrypy.notification.send_report(userobj, force=True)\r",
            "                flash(_(\"Report sent successfully.\"), level='success')\r",
            "            else:\r",
            "                flash(_(\"Report settings updated successfully.\"), level='success')\r",
            "            return True\r",
            "        except Exception as e:\r",
            "            userobj.rollback()\r",
            "            logger.warning('fail to save report settings', exc_info=1)\r",
            "            flash(str(e), level='warning')\r",
            "            return False\r",
            "\r",
            "\r",
            "class NotificationForm(CherryForm):\r",
            "    action = HiddenField(default=\"set_notification_info\")\r",
            "\r",
            "    @classmethod\r",
            "    def create_form(cls, userobj):\r",
            "        # Create dynamic list of fields\r",
            "        data = {}\r",
            "        extends = {}\r",
            "        for repo in userobj.repo_objs:\r",
            "            extends[repo.display_name] = MaxAgeField(label=repo.display_name)\r",
            "            data[repo.display_name] = repo.maxage\r",
            "        extends['submit'] = SubmitField(label=_('Save changes'))\r",
            "        # Create class\r",
            "        sub_form = type('SubForm', (cls,), extends)\r",
            "        return sub_form(data=data)\r",
            "\r",
            "    def is_submitted(self):\r",
            "        return self.action.data == 'set_notification_info' and super().is_submitted()\r",
            "\r",
            "    def populate_obj(self, userobj):\r",
            "        try:\r",
            "            # Loop trough user repo and update max age.\r",
            "            for repo in userobj.repo_objs:\r",
            "                if repo.display_name in self:\r",
            "                    # Update the maxage\r",
            "                    repo.maxage = self[repo.display_name].data\r",
            "            userobj.commit()\r",
            "            flash(_(\"Notification settings updated successfully.\"), level='success')\r",
            "            return True\r",
            "        except Exception as e:\r",
            "            userobj.rollback()\r",
            "            flash(str(e), level='warning')\r",
            "            return False\r",
            "\r",
            "\r",
            "class PagePrefNotification(Controller):\r",
            "    @cherrypy.expose\r",
            "    def default(self, **kwargs):\r",
            "        # Process the parameters.\r",
            "        report_form = ReportForm(obj=self.app.currentuser)\r",
            "        notification_form = NotificationForm.create_form(self.app.currentuser)\r",
            "        if report_form.is_submitted():\r",
            "            if report_form.validate():\r",
            "                if report_form.populate_obj(self.app.currentuser):\r",
            "                    raise cherrypy.HTTPRedirect(\"\")\r",
            "            else:\r",
            "                flash(report_form.error_message, level='error')\r",
            "        elif notification_form.is_submitted():\r",
            "            if notification_form.validate():\r",
            "                if notification_form.populate_obj(self.app.currentuser):\r",
            "                    raise cherrypy.HTTPRedirect(\"\")\r",
            "            else:\r",
            "                flash(notification_form.error_message, level='error')\r",
            "        params = {\r",
            "            'email': self.app.currentuser.email,\r",
            "            'report_form': report_form,\r",
            "            'notification_form': notification_form,\r",
            "        }\r",
            "        return self._compile_template(\"prefs_notification.html\", **params)\r"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-\r",
            "# rdiffweb, A web interface to rdiff-backup repositories\r",
            "# Copyright (C) 2012-2023 rdiffweb contributors\r",
            "#\r",
            "# This program is free software: you can redistribute it and/or modify\r",
            "# it under the terms of the GNU General Public License as published by\r",
            "# the Free Software Foundation, either version 3 of the License, or\r",
            "# (at your option) any later version.\r",
            "#\r",
            "# This program is distributed in the hope that it will be useful,\r",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of\r",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r",
            "# GNU General Public License for more details.\r",
            "#\r",
            "# You should have received a copy of the GNU General Public License\r",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.\r",
            "\"\"\"\r",
            "Plugin used to send email to users when their repository is getting too old.\r",
            "User can control the notification period.\r",
            "\"\"\"\r",
            "\r",
            "\r",
            "import logging\r",
            "\r",
            "import cherrypy\r",
            "from wtforms.fields import HiddenField, RadioField, SelectField, SubmitField\r",
            "\r",
            "from rdiffweb.controller import Controller, flash\r",
            "from rdiffweb.controller.form import CherryForm\r",
            "from rdiffweb.tools.i18n import gettext_lazy as _\r",
            "\r",
            "logger = logging.getLogger(__name__)\r",
            "\r",
            "\r",
            "class MaxAgeField(SelectField):\r",
            "    def __init__(self, *args, **kwargs):\r",
            "        super().__init__(\r",
            "            *args,\r",
            "            choices=[\r",
            "                (0, _('Never')),\r",
            "                (1, _('1 day')),\r",
            "                (2, _('2 days')),\r",
            "                (3, _('3 days')),\r",
            "                (4, _('4 days')),\r",
            "                (5, _('5 days')),\r",
            "                (6, _('6 days')),\r",
            "                (7, _('1 week')),\r",
            "                (14, _('2 weeks')),\r",
            "                (21, _('3 weeks')),\r",
            "                (28, _('4 weeks')),\r",
            "                (31, _('1 month')),\r",
            "            ],\r",
            "            coerce=int,\r",
            "            **kwargs\r",
            "        )\r",
            "\r",
            "\r",
            "class ReportForm(CherryForm):\r",
            "    action = HiddenField(default=\"set_report_info\")\r",
            "    report_time_range = RadioField(\r",
            "        _('Send me a backup status report'),\r",
            "        choices=[\r",
            "            (0, _('Never')),\r",
            "            (1, _('Daily')),\r",
            "            (7, _('Weekly')),\r",
            "            (30, _('Monthly')),\r",
            "        ],\r",
            "        coerce=int,\r",
            "    )\r",
            "    set_report_info = SubmitField(_('Save changes'), render_kw={\"class\": \"pull-left mr-2\"})\r",
            "    send_report = SubmitField(_('Save and send report'), render_kw={\"class\": \"btn-secondary pull-left\"})\r",
            "\r",
            "    def is_submitted(self):\r",
            "        return self.action.data == 'set_report_info' and super().is_submitted()\r",
            "\r",
            "    def populate_obj(self, userobj):\r",
            "\r",
            "        # Simply push the time_range to user's data\r",
            "        try:\r",
            "            userobj.report_time_range = self.report_time_range.data\r",
            "            userobj.commit()\r",
            "            # Validate if a report could be sent\r",
            "            if self.send_report.data:\r",
            "                if not userobj.report_time_range:\r",
            "                    raise ValueError(_('You must select a time range and save changes before sending a report.'))\r",
            "                if not userobj.email:\r",
            "                    raise ValueError(_('Could not send report to user without configured email.'))\r",
            "                cherrypy.notification.send_report(userobj, force=True)\r",
            "                flash(_(\"Report sent successfully.\"), level='success')\r",
            "            else:\r",
            "                flash(_(\"Report settings updated successfully.\"), level='success')\r",
            "            return True\r",
            "        except Exception as e:\r",
            "            userobj.rollback()\r",
            "            logger.warning('fail to save report settings', exc_info=1)\r",
            "            flash(str(e), level='warning')\r",
            "            return False\r",
            "\r",
            "\r",
            "class NotificationForm(CherryForm):\r",
            "    action = HiddenField(default=\"set_notification_info\")\r",
            "\r",
            "    @classmethod\r",
            "    def create_form(cls, userobj):\r",
            "        # Create dynamic list of fields\r",
            "        data = {}\r",
            "        extends = {}\r",
            "        for repo in userobj.repo_objs:\r",
            "            extends[repo.display_name] = MaxAgeField(label=repo.display_name)\r",
            "            data[repo.display_name] = repo.maxage\r",
            "        extends['submit'] = SubmitField(label=_('Save changes'))\r",
            "        # Create class\r",
            "        sub_form = type('SubForm', (cls,), extends)\r",
            "        return sub_form(data=data)\r",
            "\r",
            "    def is_submitted(self):\r",
            "        return self.action.data == 'set_notification_info' and super().is_submitted()\r",
            "\r",
            "    def populate_obj(self, userobj):\r",
            "        try:\r",
            "            # Loop trough user repo and update max age.\r",
            "            for repo in userobj.repo_objs:\r",
            "                if repo.display_name in self:\r",
            "                    # Update the maxage\r",
            "                    repo.maxage = self[repo.display_name].data\r",
            "            userobj.commit()\r",
            "            flash(_(\"Notification settings updated successfully.\"), level='success')\r",
            "            return True\r",
            "        except Exception as e:\r",
            "            userobj.rollback()\r",
            "            flash(str(e), level='warning')\r",
            "            return False\r",
            "\r",
            "\r",
            "class PagePrefNotification(Controller):\r",
            "    @cherrypy.expose\r",
            "    @cherrypy.tools.ratelimit(methods=['POST'])\r",
            "    def default(self, **kwargs):\r",
            "        # Process the parameters.\r",
            "        report_form = ReportForm(obj=self.app.currentuser)\r",
            "        notification_form = NotificationForm.create_form(self.app.currentuser)\r",
            "        if report_form.is_submitted():\r",
            "            if report_form.validate():\r",
            "                if report_form.populate_obj(self.app.currentuser):\r",
            "                    raise cherrypy.HTTPRedirect(\"\")\r",
            "            else:\r",
            "                flash(report_form.error_message, level='error')\r",
            "        elif notification_form.is_submitted():\r",
            "            if notification_form.validate():\r",
            "                if notification_form.populate_obj(self.app.currentuser):\r",
            "                    raise cherrypy.HTTPRedirect(\"\")\r",
            "            else:\r",
            "                flash(notification_form.error_message, level='error')\r",
            "        params = {\r",
            "            'email': self.app.currentuser.email,\r",
            "            'report_form': report_form,\r",
            "            'notification_form': notification_form,\r",
            "        }\r",
            "        return self._compile_template(\"prefs_notification.html\", **params)\r"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "rdiffweb.controller.page_pref_notification.PagePrefNotification.self"
        ]
    }
}