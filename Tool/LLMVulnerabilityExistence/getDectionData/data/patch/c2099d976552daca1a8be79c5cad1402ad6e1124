{
    "vantage6-server/vantage6/server/resource/collaboration.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 502,
                "afterPatchRowNumber": 502,
                "PatchRowcode": "               type: integer"
            },
            "1": {
                "beforePatchRowNumber": 503,
                "afterPatchRowNumber": 503,
                "PatchRowcode": "             description: Collaboration id"
            },
            "2": {
                "beforePatchRowNumber": 504,
                "afterPatchRowNumber": 504,
                "PatchRowcode": "             required: true"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 505,
                "PatchRowcode": "+          - in: query"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 506,
                "PatchRowcode": "+            name: delete_dependents"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 507,
                "PatchRowcode": "+            schema:"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 508,
                "PatchRowcode": "+              type: boolean"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 509,
                "PatchRowcode": "+            description: If set to true, the collaboratio will be deleted along"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 510,
                "PatchRowcode": "+              with all its tasks and nodes (default=False)"
            },
            "9": {
                "beforePatchRowNumber": 505,
                "afterPatchRowNumber": 511,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 506,
                "afterPatchRowNumber": 512,
                "PatchRowcode": "         responses:"
            },
            "11": {
                "beforePatchRowNumber": 507,
                "afterPatchRowNumber": 513,
                "PatchRowcode": "           200:"
            },
            "12": {
                "beforePatchRowNumber": 527,
                "afterPatchRowNumber": 533,
                "PatchRowcode": "             return {'msg': 'You lack the permission to do that!'}, \\"
            },
            "13": {
                "beforePatchRowNumber": 528,
                "afterPatchRowNumber": 534,
                "PatchRowcode": "                 HTTPStatus.UNAUTHORIZED"
            },
            "14": {
                "beforePatchRowNumber": 529,
                "afterPatchRowNumber": 535,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 536,
                "PatchRowcode": "+        if collaboration.tasks or collaboration.nodes:"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 537,
                "PatchRowcode": "+            delete_dependents = request.args.get('delete_dependents', False)"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 538,
                "PatchRowcode": "+            if not delete_dependents:"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 539,
                "PatchRowcode": "+                return {"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 540,
                "PatchRowcode": "+                    \"msg\": f\"Collaboration id={id} has \""
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 541,
                "PatchRowcode": "+                    f\"{len(collaboration.tasks)} tasks and \""
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 542,
                "PatchRowcode": "+                    \"{len(collaboration.nodes)} nodes. Please delete them \""
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 543,
                "PatchRowcode": "+                    \"separately or set delete_dependents=True\""
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 544,
                "PatchRowcode": "+                }, HTTPStatus.BAD_REQUEST"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 545,
                "PatchRowcode": "+            else:"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 546,
                "PatchRowcode": "+                log.warn(f\"Deleting collaboration id={id} along with \""
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 547,
                "PatchRowcode": "+                         f\"{len(collaboration.tasks)} tasks and \""
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 548,
                "PatchRowcode": "+                         f\"{len(collaboration.nodes)} nodes\")"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 549,
                "PatchRowcode": "+                for task in collaboration.tasks:"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 550,
                "PatchRowcode": "+                    task.delete()"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 551,
                "PatchRowcode": "+                for node in collaboration.nodes:"
            },
            "31": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 552,
                "PatchRowcode": "+                    node.delete()"
            },
            "32": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 553,
                "PatchRowcode": "+"
            },
            "33": {
                "beforePatchRowNumber": 530,
                "afterPatchRowNumber": 554,
                "PatchRowcode": "         collaboration.delete()"
            },
            "34": {
                "beforePatchRowNumber": 531,
                "afterPatchRowNumber": 555,
                "PatchRowcode": "         return {\"msg\": f\"Collaboration id={id} successfully deleted\"}, \\"
            },
            "35": {
                "beforePatchRowNumber": 532,
                "afterPatchRowNumber": 556,
                "PatchRowcode": "             HTTPStatus.OK"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from flask import request, g",
            "from flask_restful import reqparse, Api",
            "from http import HTTPStatus",
            "",
            "from vantage6.server import db",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    Operation as P,",
            "    PermissionManager",
            ")",
            "from vantage6.server.resource.common._schema import (",
            "    CollaborationSchema,",
            "    TaskSchema,",
            "    OrganizationSchema,",
            "    NodeSchemaSimple",
            ")",
            "from vantage6.server.resource import (",
            "    with_user_or_node,",
            "    with_user,",
            "    only_for,",
            "    ServicesResources",
            ")",
            "",
            "",
            "module_name = __name__.split('.')[-1]",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the collaboration resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Collaborations,",
            "        path,",
            "        endpoint='collaboration_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Collaboration,",
            "        path + '/<int:id>',",
            "        endpoint='collaboration_with_id',",
            "        methods=('GET', 'PATCH', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        CollaborationOrganization,",
            "        path+'/<int:id>/organization',",
            "        endpoint='collaboration_with_id_organization',",
            "        methods=('GET', 'POST', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        CollaborationNode,",
            "        path+'/<int:id>/node',",
            "        endpoint='collaboration_with_id_node',",
            "        methods=('GET', 'POST', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        CollaborationTask,",
            "        path+'/<int:id>/task',",
            "        endpoint='collaboration_with_id_task',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# Schemas",
            "collaboration_schema = CollaborationSchema()",
            "tasks_schema = TaskSchema()",
            "org_schema = OrganizationSchema()",
            "node_schema = NodeSchemaSimple()",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "",
            "    add = permissions.appender(module_name)",
            "",
            "    add(scope=S.GLOBAL, operation=P.VIEW,",
            "        description=\"view any collaboration\")",
            "",
            "    add(scope=S.ORGANIZATION, operation=P.VIEW, assign_to_container=True,",
            "        assign_to_node=True,",
            "        description=\"view collaborations of your organization\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.EDIT,",
            "        description=\"edit any collaboration\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.CREATE,",
            "        description=\"create a new collaboration\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.DELETE,",
            "        description=\"delete a collaboration\")",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "class CollaborationBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Collaborations(CollaborationBase):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"Returns a list of collaborations",
            "        ---",
            "        description: >-",
            "          Returns a list of collaborations. Depending on your permission, all",
            "          collaborations are shown or only collaborations in which your",
            "          organization participates. See the table bellow.\\n\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rulename|Scope|Operation|Assigned to Node|Assigned to Container|",
            "          Description|\\n",
            "          | -- | -- | -- | -- | -- | -- |\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|All collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|Collaborations in which",
            "          your organization participates |\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: name",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: encrypted",
            "            schema:",
            "              type: boolean",
            "            description: Whether or not collaboration is encrypted",
            "          - in: query",
            "            name: organization_id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "",
            "        # obtain organization from authenticated",
            "        auth_org_id = self.obtain_organization_id()",
            "        q = g.session.query(db.Collaboration)",
            "        args = request.args",
            "",
            "        # filter by a field of this endpoint",
            "        if 'encrypted' in args:",
            "            q = q.filter(db.Collaboration.encrypted == args['encrypted'])",
            "        if 'name' in args:",
            "            q = q.filter(db.Collaboration.name.like(args['name']))",
            "",
            "        # find collaborations containing a specific organization",
            "        if 'organization_id' in args:",
            "            if not self.r.v_glo.can() and \\",
            "                    args['organization_id'] != str(auth_org_id):",
            "                return {",
            "                    'msg': 'You lack the permission to request collaborations '",
            "                    'for this organization!'",
            "                }, HTTPStatus.UNAUTHORIZED",
            "            elif self.r.v_glo.can():",
            "                q = q.join(db.Member).join(db.Organization)\\",
            "                    .filter(db.Organization.id == args['organization_id'])",
            "            # else: no filter if user can only view collaborations of own",
            "            # organization: the arg 'organization_id' is then superfluous",
            "",
            "        # filter based on permissions",
            "        if not self.r.v_glo.can():",
            "            if self.r.v_org.can():",
            "                q = q.join(db.Organization, db.Collaboration.organizations)\\",
            "                    .filter(db.Collaboration.organizations.any(id=auth_org_id))",
            "            else:",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate the results",
            "        try:",
            "            page = Pagination.from_query(q, request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # serialize models",
            "        return self.response(page, collaboration_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\" Create collaboration",
            "        ---",
            "        description: >-",
            "          Create a new collaboration between organizations.\\n\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to Node|Assigned to",
            "          Container|Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Create|\u274c|\u274c|Create collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Unique human readable name for collaboration",
            "                  organization_ids:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                      description: List of organization ids which form the",
            "                        collaboration",
            "                  encrypted:",
            "                    type: integer",
            "                    description: Boolean (0 or 1) to indicate if the",
            "                      collaboration uses encryption",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Collaboration name already exists",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument('name', type=str, required=True,",
            "                            help=\"This field cannot be left blank!\")",
            "        parser.add_argument('organization_ids', type=int, required=True,",
            "                            action='append')",
            "        parser.add_argument('encrypted', type=int, required=False)",
            "        data = parser.parse_args()",
            "",
            "        name = data[\"name\"]",
            "        if db.Collaboration.exists(\"name\", name):",
            "            return {\"msg\": f\"Collaboration name '{name}' already exists!\"}, \\",
            "                HTTPStatus.BAD_REQUEST",
            "",
            "        if not self.r.c_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        encrypted = True if data[\"encrypted\"] == 1 else False",
            "",
            "        collaboration = db.Collaboration(",
            "            name=name,",
            "            organizations=[",
            "                db.Organization.get(org_id)",
            "                for org_id in data['organization_ids']",
            "                if db.Organization.get(org_id)",
            "            ],",
            "            encrypted=encrypted",
            "        )",
            "",
            "        collaboration.save()",
            "        return collaboration_schema.dump(collaboration), HTTPStatus.OK",
            "",
            "",
            "class Collaboration(CollaborationBase):",
            "",
            "    @only_for(('user', 'node', 'container'))",
            "    def get(self, id):",
            "        \"\"\" Get collaboration",
            "        ---",
            "        description: >-",
            "          Returns the collaboration with the specified id.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rulename|Scope|Operation|Assigned to Node|Assigned to Container|",
            "          Description|\\n",
            "          | -- | -- | -- | -- | -- | -- |\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|All collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|Collaborations in which",
            "          your organization participates |\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Collaboration id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "",
            "        # check that collaboration exists, unlikely to happen without ID",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having id={id} not found\"},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # obtain the organization id of the authenticated",
            "        auth_org_id = self.obtain_organization_id()",
            "",
            "        # verify that the user/node organization is within the",
            "        # collaboration",
            "        ids = [org.id for org in collaboration.organizations]",
            "        if not self.r.v_glo.can():",
            "            if not (self.r.v_org.can() and auth_org_id in ids):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return collaboration_schema.dump(collaboration, many=False), \\",
            "            HTTPStatus.OK  # 200",
            "",
            "    @with_user",
            "    def patch(self, id):",
            "        \"\"\" Update collaboration",
            "        ---",
            "        description: >-",
            "          Updates the collaboration with the specified id.\\n\\n",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Update a collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Human readable label",
            "                  organization_ids:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: List of organization ids",
            "                  encrypted:",
            "                    type: boolean",
            "                    description: Whether collaboration is encrypted or not",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Collaboration name already exists",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "",
            "        # check if collaboration exists",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} \"",
            "                    \"can not be found\"}, HTTPStatus.NOT_FOUND  # 404",
            "",
            "        # verify permissions",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # only update fields that are provided",
            "        data = request.get_json()",
            "        if \"name\" in data:",
            "            name = data[\"name\"]",
            "            if collaboration.name != name and \\",
            "                    db.Collaboration.exists(\"name\", name):",
            "                return {",
            "                    \"msg\": f\"Collaboration name '{name}' already exists!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            collaboration.name = name",
            "        if \"organization_ids\" in data:",
            "            collaboration.organizations = [",
            "                db.Organization.get(org_id)",
            "                for org_id in data['organization_ids']",
            "                if db.Organization.get(org_id)",
            "            ]",
            "        if 'encrypted' in data:",
            "            collaboration.encrypted = data['encrypted']",
            "",
            "        collaboration.save()",
            "",
            "        return collaboration_schema.dump(collaboration, many=False), \\",
            "            HTTPStatus.OK  # 200",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\" Delete collaboration",
            "        ---",
            "        description: >-",
            "          Removes the collaboration from the database entirely.",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Delete|\u274c|\u274c|Remove collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration id={id} is not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # verify permissions",
            "        if not self.r.d_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        collaboration.delete()",
            "        return {\"msg\": f\"Collaboration id={id} successfully deleted\"}, \\",
            "            HTTPStatus.OK",
            "",
            "",
            "class CollaborationOrganization(ServicesResources):",
            "    \"\"\"Resource for /api/collaboration/<int:id>/organization.\"\"\"",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "    @only_for((\"node\", \"user\", \"container\"))",
            "    def get(self, id):",
            "        \"\"\" Returns organizations that participate in the collaboration",
            "        ---",
            "        description: >-",
            "          Returns a list of all organizations that belong to the specified",
            "          collaboration.",
            "",
            "          ### Permission Table\\n",
            "          |Rulename|Scope|Operation|Assigned to Node|Assigned to Container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|All collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|Collaborations",
            "          in which your organization participates|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "            200:",
            "                description: Ok",
            "            404:",
            "                description: Collaboration specified by id does not exists",
            "            401:",
            "                description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        col = db.Collaboration.get(id)",
            "        if not col:",
            "            return {'msg': f'collaboration (id={id}) can not be found'},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check permission",
            "        if not self.r.v_glo.can():",
            "            auth_org = self.obtain_auth_organization()",
            "            if not (self.r.v_org.can() and auth_org in col.organizations):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate organizations",
            "        page = Pagination.from_list(col.organizations, request)",
            "",
            "        # model serialization",
            "        return self.response(page, org_schema)",
            "",
            "    @with_user",
            "    def post(self, id):",
            "        \"\"\" Add organization to collaboration",
            "        ---",
            "        description: >-",
            "          Adds a single organization to an existing collaboration.\\n\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Add organization to a",
            "          collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: Organization id which needs to be added",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Specified collaboration or organization does not exist",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        # get collaboration to which te organization should be added",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # verify permissions",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # get the organization",
            "        data = request.get_json()",
            "        organization = db.Organization.get(data['id'])",
            "        if not organization:",
            "            return {\"msg\": f\"organization with id={id} is not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # append organization to the collaboration",
            "        collaboration.organizations.append(organization)",
            "        collaboration.save()",
            "        return org_schema.dump(collaboration.organizations, many=True), \\",
            "            HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\" Remove organization from collaboration",
            "        ---",
            "        description: >-",
            "          Removes a single organization from an existing collaboration.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Remove an organization from an",
            "          existing collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: Organization id which needs to be deleted",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Specified collaboration or organization does not exist",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        # get collaboration from which organization should be removed",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # get organization which should be deleted",
            "        data = request.get_json()",
            "        organization = db.Organization.get(data['id'])",
            "        if not organization:",
            "            return {\"msg\": f\"organization with id={id} is not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # delete organization and update",
            "        collaboration.organizations.remove(organization)",
            "        collaboration.save()",
            "        return org_schema.dump(collaboration.organizations, many=True), \\",
            "            HTTPStatus.OK",
            "",
            "",
            "class CollaborationNode(ServicesResources):",
            "    \"\"\"Resource for /api/collaboration/<int:id>/node.\"\"\"",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\" List nodes in collaboration.",
            "        ---",
            "        description: >-",
            "          Returns a list of node(s) which belong to the specified",
            "          collaboration.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|List nodes in a specified",
            "          collaboration|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|List nodes in a specified",
            "          collaboration|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        col = db.Collaboration.get(id)",
            "        if not col:",
            "            return {\"msg\": f\"collaboration id={id} can not be found\"},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check permission",
            "        if not self.r.v_glo.can():",
            "            auth_org = self.obtain_auth_organization()",
            "            if not (self.r.v_org.can() and auth_org in col.organizations):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate nodes",
            "        page = Pagination.from_list(col.nodes, request)",
            "",
            "        # model serialization",
            "        return self.response(page, node_schema)",
            "",
            "    @with_user",
            "    def post(self, id):",
            "        \"\"\" Add node to collaboration",
            "        ---",
            "        description: >-",
            "          Add node to an existing collaboration.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Create|\u274c|\u274c|Add node to collaboration|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: ID of node to be added",
            "",
            "        responses:",
            "          201:",
            "            description: Added node to collaboration",
            "          404:",
            "            description: Collaboration or node not found",
            "          400:",
            "            description: Node is already in collaboration",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        node = db.Node.get(data['id'])",
            "        if not node:",
            "            return {\"msg\": f\"node id={data['id']} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "        if node in collaboration.nodes:",
            "            return {\"msg\": f\"node id={data['id']} is already in collaboration \"",
            "                    f\"id={id}\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        collaboration.nodes.append(node)",
            "        collaboration.save()",
            "        return node_schema.dump(collaboration.nodes, many=True),\\",
            "            HTTPStatus.CREATED",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\" Remove node from collaboration",
            "        ---",
            "        description: >-",
            "          Removes a single node from an existing collaboration.",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Remove node from collaboration|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id from which the node is to be deleted.",
            "            required: true",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: Node id which needs to be deleted",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration or node not found",
            "          400:",
            "            description: Node is not part of the collaboration",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        node = db.Node.get(data['id'])",
            "        if not node:",
            "            return {\"msg\": f\"node id={id} not found\"}, HTTPStatus.NOT_FOUND",
            "        if node not in collaboration.nodes:",
            "            return {\"msg\": f\"node id={data['id']} is not part of \"",
            "                    f\"collaboration id={id}\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        collaboration.nodes.remove(node)",
            "        collaboration.save()",
            "        return {\"msg\": f\"node id={data['id']} removed from collaboration \"",
            "                f\"id={id}\"}, HTTPStatus.OK",
            "",
            "",
            "class CollaborationTask(ServicesResources):",
            "    \"\"\"Resource for /api/collaboration/<int:id>/task.\"\"\"",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, 'task')",
            "",
            "    @with_user_or_node",
            "    def get(self, id):",
            "        \"\"\"List tasks from collaboration",
            "        ---",
            "        description: >-",
            "            Returns a list of all tasks that belong to the collaboration.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Task|Global|View|\u274c|\u274c|View tasks of collaboration|\\n",
            "            |Task|Organization|View|\u2705|\u2705|View tasks only when your",
            "            organization participates in the collaboration|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Collaboration not found",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "",
            "        \"\"\"",
            "        col = db.Collaboration.get(id)",
            "        if not col:",
            "            return {\"msg\": f\"Collaboration id={id} can not be found\"},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # obtain auth's organization id",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        if not self.r.v_glo.can():",
            "            if not (self.r.v_org.can() and auth_org in col.organizations):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate tasks",
            "        page = Pagination.from_list(col.tasks, request)",
            "",
            "        # model serialization",
            "        return self.response(page, tasks_schema)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from flask import request, g",
            "from flask_restful import reqparse, Api",
            "from http import HTTPStatus",
            "",
            "from vantage6.server import db",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    Operation as P,",
            "    PermissionManager",
            ")",
            "from vantage6.server.resource.common._schema import (",
            "    CollaborationSchema,",
            "    TaskSchema,",
            "    OrganizationSchema,",
            "    NodeSchemaSimple",
            ")",
            "from vantage6.server.resource import (",
            "    with_user_or_node,",
            "    with_user,",
            "    only_for,",
            "    ServicesResources",
            ")",
            "",
            "",
            "module_name = __name__.split('.')[-1]",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the collaboration resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Collaborations,",
            "        path,",
            "        endpoint='collaboration_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Collaboration,",
            "        path + '/<int:id>',",
            "        endpoint='collaboration_with_id',",
            "        methods=('GET', 'PATCH', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        CollaborationOrganization,",
            "        path+'/<int:id>/organization',",
            "        endpoint='collaboration_with_id_organization',",
            "        methods=('GET', 'POST', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        CollaborationNode,",
            "        path+'/<int:id>/node',",
            "        endpoint='collaboration_with_id_node',",
            "        methods=('GET', 'POST', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        CollaborationTask,",
            "        path+'/<int:id>/task',",
            "        endpoint='collaboration_with_id_task',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# Schemas",
            "collaboration_schema = CollaborationSchema()",
            "tasks_schema = TaskSchema()",
            "org_schema = OrganizationSchema()",
            "node_schema = NodeSchemaSimple()",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "",
            "    add = permissions.appender(module_name)",
            "",
            "    add(scope=S.GLOBAL, operation=P.VIEW,",
            "        description=\"view any collaboration\")",
            "",
            "    add(scope=S.ORGANIZATION, operation=P.VIEW, assign_to_container=True,",
            "        assign_to_node=True,",
            "        description=\"view collaborations of your organization\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.EDIT,",
            "        description=\"edit any collaboration\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.CREATE,",
            "        description=\"create a new collaboration\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.DELETE,",
            "        description=\"delete a collaboration\")",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "class CollaborationBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Collaborations(CollaborationBase):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"Returns a list of collaborations",
            "        ---",
            "        description: >-",
            "          Returns a list of collaborations. Depending on your permission, all",
            "          collaborations are shown or only collaborations in which your",
            "          organization participates. See the table bellow.\\n\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rulename|Scope|Operation|Assigned to Node|Assigned to Container|",
            "          Description|\\n",
            "          | -- | -- | -- | -- | -- | -- |\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|All collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|Collaborations in which",
            "          your organization participates |\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: name",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: encrypted",
            "            schema:",
            "              type: boolean",
            "            description: Whether or not collaboration is encrypted",
            "          - in: query",
            "            name: organization_id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "",
            "        # obtain organization from authenticated",
            "        auth_org_id = self.obtain_organization_id()",
            "        q = g.session.query(db.Collaboration)",
            "        args = request.args",
            "",
            "        # filter by a field of this endpoint",
            "        if 'encrypted' in args:",
            "            q = q.filter(db.Collaboration.encrypted == args['encrypted'])",
            "        if 'name' in args:",
            "            q = q.filter(db.Collaboration.name.like(args['name']))",
            "",
            "        # find collaborations containing a specific organization",
            "        if 'organization_id' in args:",
            "            if not self.r.v_glo.can() and \\",
            "                    args['organization_id'] != str(auth_org_id):",
            "                return {",
            "                    'msg': 'You lack the permission to request collaborations '",
            "                    'for this organization!'",
            "                }, HTTPStatus.UNAUTHORIZED",
            "            elif self.r.v_glo.can():",
            "                q = q.join(db.Member).join(db.Organization)\\",
            "                    .filter(db.Organization.id == args['organization_id'])",
            "            # else: no filter if user can only view collaborations of own",
            "            # organization: the arg 'organization_id' is then superfluous",
            "",
            "        # filter based on permissions",
            "        if not self.r.v_glo.can():",
            "            if self.r.v_org.can():",
            "                q = q.join(db.Organization, db.Collaboration.organizations)\\",
            "                    .filter(db.Collaboration.organizations.any(id=auth_org_id))",
            "            else:",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate the results",
            "        try:",
            "            page = Pagination.from_query(q, request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # serialize models",
            "        return self.response(page, collaboration_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\" Create collaboration",
            "        ---",
            "        description: >-",
            "          Create a new collaboration between organizations.\\n\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to Node|Assigned to",
            "          Container|Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Create|\u274c|\u274c|Create collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Unique human readable name for collaboration",
            "                  organization_ids:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                      description: List of organization ids which form the",
            "                        collaboration",
            "                  encrypted:",
            "                    type: integer",
            "                    description: Boolean (0 or 1) to indicate if the",
            "                      collaboration uses encryption",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Collaboration name already exists",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument('name', type=str, required=True,",
            "                            help=\"This field cannot be left blank!\")",
            "        parser.add_argument('organization_ids', type=int, required=True,",
            "                            action='append')",
            "        parser.add_argument('encrypted', type=int, required=False)",
            "        data = parser.parse_args()",
            "",
            "        name = data[\"name\"]",
            "        if db.Collaboration.exists(\"name\", name):",
            "            return {\"msg\": f\"Collaboration name '{name}' already exists!\"}, \\",
            "                HTTPStatus.BAD_REQUEST",
            "",
            "        if not self.r.c_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        encrypted = True if data[\"encrypted\"] == 1 else False",
            "",
            "        collaboration = db.Collaboration(",
            "            name=name,",
            "            organizations=[",
            "                db.Organization.get(org_id)",
            "                for org_id in data['organization_ids']",
            "                if db.Organization.get(org_id)",
            "            ],",
            "            encrypted=encrypted",
            "        )",
            "",
            "        collaboration.save()",
            "        return collaboration_schema.dump(collaboration), HTTPStatus.OK",
            "",
            "",
            "class Collaboration(CollaborationBase):",
            "",
            "    @only_for(('user', 'node', 'container'))",
            "    def get(self, id):",
            "        \"\"\" Get collaboration",
            "        ---",
            "        description: >-",
            "          Returns the collaboration with the specified id.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rulename|Scope|Operation|Assigned to Node|Assigned to Container|",
            "          Description|\\n",
            "          | -- | -- | -- | -- | -- | -- |\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|All collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|Collaborations in which",
            "          your organization participates |\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Collaboration id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "",
            "        # check that collaboration exists, unlikely to happen without ID",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having id={id} not found\"},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # obtain the organization id of the authenticated",
            "        auth_org_id = self.obtain_organization_id()",
            "",
            "        # verify that the user/node organization is within the",
            "        # collaboration",
            "        ids = [org.id for org in collaboration.organizations]",
            "        if not self.r.v_glo.can():",
            "            if not (self.r.v_org.can() and auth_org_id in ids):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return collaboration_schema.dump(collaboration, many=False), \\",
            "            HTTPStatus.OK  # 200",
            "",
            "    @with_user",
            "    def patch(self, id):",
            "        \"\"\" Update collaboration",
            "        ---",
            "        description: >-",
            "          Updates the collaboration with the specified id.\\n\\n",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Update a collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Human readable label",
            "                  organization_ids:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: List of organization ids",
            "                  encrypted:",
            "                    type: boolean",
            "                    description: Whether collaboration is encrypted or not",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Collaboration name already exists",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "",
            "        # check if collaboration exists",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} \"",
            "                    \"can not be found\"}, HTTPStatus.NOT_FOUND  # 404",
            "",
            "        # verify permissions",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # only update fields that are provided",
            "        data = request.get_json()",
            "        if \"name\" in data:",
            "            name = data[\"name\"]",
            "            if collaboration.name != name and \\",
            "                    db.Collaboration.exists(\"name\", name):",
            "                return {",
            "                    \"msg\": f\"Collaboration name '{name}' already exists!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            collaboration.name = name",
            "        if \"organization_ids\" in data:",
            "            collaboration.organizations = [",
            "                db.Organization.get(org_id)",
            "                for org_id in data['organization_ids']",
            "                if db.Organization.get(org_id)",
            "            ]",
            "        if 'encrypted' in data:",
            "            collaboration.encrypted = data['encrypted']",
            "",
            "        collaboration.save()",
            "",
            "        return collaboration_schema.dump(collaboration, many=False), \\",
            "            HTTPStatus.OK  # 200",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\" Delete collaboration",
            "        ---",
            "        description: >-",
            "          Removes the collaboration from the database entirely.",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Delete|\u274c|\u274c|Remove collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "          - in: query",
            "            name: delete_dependents",
            "            schema:",
            "              type: boolean",
            "            description: If set to true, the collaboratio will be deleted along",
            "              with all its tasks and nodes (default=False)",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration with specified id is not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration id={id} is not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # verify permissions",
            "        if not self.r.d_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        if collaboration.tasks or collaboration.nodes:",
            "            delete_dependents = request.args.get('delete_dependents', False)",
            "            if not delete_dependents:",
            "                return {",
            "                    \"msg\": f\"Collaboration id={id} has \"",
            "                    f\"{len(collaboration.tasks)} tasks and \"",
            "                    \"{len(collaboration.nodes)} nodes. Please delete them \"",
            "                    \"separately or set delete_dependents=True\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            else:",
            "                log.warn(f\"Deleting collaboration id={id} along with \"",
            "                         f\"{len(collaboration.tasks)} tasks and \"",
            "                         f\"{len(collaboration.nodes)} nodes\")",
            "                for task in collaboration.tasks:",
            "                    task.delete()",
            "                for node in collaboration.nodes:",
            "                    node.delete()",
            "",
            "        collaboration.delete()",
            "        return {\"msg\": f\"Collaboration id={id} successfully deleted\"}, \\",
            "            HTTPStatus.OK",
            "",
            "",
            "class CollaborationOrganization(ServicesResources):",
            "    \"\"\"Resource for /api/collaboration/<int:id>/organization.\"\"\"",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "    @only_for((\"node\", \"user\", \"container\"))",
            "    def get(self, id):",
            "        \"\"\" Returns organizations that participate in the collaboration",
            "        ---",
            "        description: >-",
            "          Returns a list of all organizations that belong to the specified",
            "          collaboration.",
            "",
            "          ### Permission Table\\n",
            "          |Rulename|Scope|Operation|Assigned to Node|Assigned to Container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|All collaborations|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|Collaborations",
            "          in which your organization participates|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "            200:",
            "                description: Ok",
            "            404:",
            "                description: Collaboration specified by id does not exists",
            "            401:",
            "                description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        col = db.Collaboration.get(id)",
            "        if not col:",
            "            return {'msg': f'collaboration (id={id}) can not be found'},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check permission",
            "        if not self.r.v_glo.can():",
            "            auth_org = self.obtain_auth_organization()",
            "            if not (self.r.v_org.can() and auth_org in col.organizations):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate organizations",
            "        page = Pagination.from_list(col.organizations, request)",
            "",
            "        # model serialization",
            "        return self.response(page, org_schema)",
            "",
            "    @with_user",
            "    def post(self, id):",
            "        \"\"\" Add organization to collaboration",
            "        ---",
            "        description: >-",
            "          Adds a single organization to an existing collaboration.\\n\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Add organization to a",
            "          collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: Organization id which needs to be added",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Specified collaboration or organization does not exist",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        # get collaboration to which te organization should be added",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # verify permissions",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # get the organization",
            "        data = request.get_json()",
            "        organization = db.Organization.get(data['id'])",
            "        if not organization:",
            "            return {\"msg\": f\"organization with id={id} is not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # append organization to the collaboration",
            "        collaboration.organizations.append(organization)",
            "        collaboration.save()",
            "        return org_schema.dump(collaboration.organizations, many=True), \\",
            "            HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\" Remove organization from collaboration",
            "        ---",
            "        description: >-",
            "          Removes a single organization from an existing collaboration.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Remove an organization from an",
            "          existing collaboration|\\n\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: Organization id which needs to be deleted",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Specified collaboration or organization does not exist",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        # get collaboration from which organization should be removed",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # get organization which should be deleted",
            "        data = request.get_json()",
            "        organization = db.Organization.get(data['id'])",
            "        if not organization:",
            "            return {\"msg\": f\"organization with id={id} is not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # delete organization and update",
            "        collaboration.organizations.remove(organization)",
            "        collaboration.save()",
            "        return org_schema.dump(collaboration.organizations, many=True), \\",
            "            HTTPStatus.OK",
            "",
            "",
            "class CollaborationNode(ServicesResources):",
            "    \"\"\"Resource for /api/collaboration/<int:id>/node.\"\"\"",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\" List nodes in collaboration.",
            "        ---",
            "        description: >-",
            "          Returns a list of node(s) which belong to the specified",
            "          collaboration.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|View|\u274c|\u274c|List nodes in a specified",
            "          collaboration|\\n",
            "          |Collaboration|Organization|View|\u2705|\u2705|List nodes in a specified",
            "          collaboration|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        col = db.Collaboration.get(id)",
            "        if not col:",
            "            return {\"msg\": f\"collaboration id={id} can not be found\"},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check permission",
            "        if not self.r.v_glo.can():",
            "            auth_org = self.obtain_auth_organization()",
            "            if not (self.r.v_org.can() and auth_org in col.organizations):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate nodes",
            "        page = Pagination.from_list(col.nodes, request)",
            "",
            "        # model serialization",
            "        return self.response(page, node_schema)",
            "",
            "    @with_user",
            "    def post(self, id):",
            "        \"\"\" Add node to collaboration",
            "        ---",
            "        description: >-",
            "          Add node to an existing collaboration.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Create|\u274c|\u274c|Add node to collaboration|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: ID of node to be added",
            "",
            "        responses:",
            "          201:",
            "            description: Added node to collaboration",
            "          404:",
            "            description: Collaboration or node not found",
            "          400:",
            "            description: Node is already in collaboration",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        node = db.Node.get(data['id'])",
            "        if not node:",
            "            return {\"msg\": f\"node id={data['id']} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "        if node in collaboration.nodes:",
            "            return {\"msg\": f\"node id={data['id']} is already in collaboration \"",
            "                    f\"id={id}\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        collaboration.nodes.append(node)",
            "        collaboration.save()",
            "        return node_schema.dump(collaboration.nodes, many=True),\\",
            "            HTTPStatus.CREATED",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\" Remove node from collaboration",
            "        ---",
            "        description: >-",
            "          Removes a single node from an existing collaboration.",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Collaboration|Global|Edit|\u274c|\u274c|Remove node from collaboration|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id from which the node is to be deleted.",
            "            required: true",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  id:",
            "                    type: integer",
            "                    description: Node id which needs to be deleted",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Collaboration or node not found",
            "          400:",
            "            description: Node is not part of the collaboration",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Collaboration\"]",
            "        \"\"\"",
            "        collaboration = db.Collaboration.get(id)",
            "        if not collaboration:",
            "            return {\"msg\": f\"collaboration having collaboration_id={id} can \"",
            "                    \"not be found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.e_glo.can():",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        data = request.get_json()",
            "        node = db.Node.get(data['id'])",
            "        if not node:",
            "            return {\"msg\": f\"node id={id} not found\"}, HTTPStatus.NOT_FOUND",
            "        if node not in collaboration.nodes:",
            "            return {\"msg\": f\"node id={data['id']} is not part of \"",
            "                    f\"collaboration id={id}\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        collaboration.nodes.remove(node)",
            "        collaboration.save()",
            "        return {\"msg\": f\"node id={data['id']} removed from collaboration \"",
            "                f\"id={id}\"}, HTTPStatus.OK",
            "",
            "",
            "class CollaborationTask(ServicesResources):",
            "    \"\"\"Resource for /api/collaboration/<int:id>/task.\"\"\"",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, 'task')",
            "",
            "    @with_user_or_node",
            "    def get(self, id):",
            "        \"\"\"List tasks from collaboration",
            "        ---",
            "        description: >-",
            "            Returns a list of all tasks that belong to the collaboration.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Task|Global|View|\u274c|\u274c|View tasks of collaboration|\\n",
            "            |Task|Organization|View|\u2705|\u2705|View tasks only when your",
            "            organization participates in the collaboration|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Collaboration id",
            "            required: true",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Collaboration not found",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Collaboration\"]",
            "",
            "        \"\"\"",
            "        col = db.Collaboration.get(id)",
            "        if not col:",
            "            return {\"msg\": f\"Collaboration id={id} can not be found\"},\\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # obtain auth's organization id",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        if not self.r.v_glo.can():",
            "            if not (self.r.v_org.can() and auth_org in col.organizations):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate tasks",
            "        page = Pagination.from_list(col.tasks, request)",
            "",
            "        # model serialization",
            "        return self.response(page, tasks_schema)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "django.contrib.auth.forms.AdminPasswordChangeForm"
        ]
    },
    "vantage6-server/vantage6/server/resource/role.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 563,
                "afterPatchRowNumber": 563,
                "PatchRowcode": "               minimum: 1"
            },
            "1": {
                "beforePatchRowNumber": 564,
                "afterPatchRowNumber": 564,
                "PatchRowcode": "             description: Role id"
            },
            "2": {
                "beforePatchRowNumber": 565,
                "afterPatchRowNumber": 565,
                "PatchRowcode": "             required: true"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 566,
                "PatchRowcode": "+          - in: query"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 567,
                "PatchRowcode": "+            name: delete_dependents"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 568,
                "PatchRowcode": "+            schema:"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 569,
                "PatchRowcode": "+              type: boolean"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 570,
                "PatchRowcode": "+            description: If set to true, the role is deleted even though users"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 571,
                "PatchRowcode": "+               with this role may lose permissions (default=False)"
            },
            "9": {
                "beforePatchRowNumber": 566,
                "afterPatchRowNumber": 572,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 567,
                "afterPatchRowNumber": 573,
                "PatchRowcode": "         responses:"
            },
            "11": {
                "beforePatchRowNumber": 568,
                "afterPatchRowNumber": 574,
                "PatchRowcode": "           200:"
            },
            "12": {
                "beforePatchRowNumber": 590,
                "afterPatchRowNumber": 596,
                "PatchRowcode": "                 return {'msg': 'You can\\'t delete a role from another '"
            },
            "13": {
                "beforePatchRowNumber": 591,
                "afterPatchRowNumber": 597,
                "PatchRowcode": "                         'organization'}, HTTPStatus.UNAUTHORIZED"
            },
            "14": {
                "beforePatchRowNumber": 592,
                "afterPatchRowNumber": 598,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 599,
                "PatchRowcode": "+        # check if role is assigned to users"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 600,
                "PatchRowcode": "+        if role.users:"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 601,
                "PatchRowcode": "+            params = request.args"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 602,
                "PatchRowcode": "+            if not params.get('delete_dependents', False):"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 603,
                "PatchRowcode": "+                return {"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 604,
                "PatchRowcode": "+                    'msg': \"Role is assigned to users. Please remove the role \""
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 605,
                "PatchRowcode": "+                    \"from the users first, or set the 'delete_dependents' \""
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 606,
                "PatchRowcode": "+                    \"parameter to delete the role anyway.\""
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 607,
                "PatchRowcode": "+                }, HTTPStatus.BAD_REQUEST"
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 608,
                "PatchRowcode": "+            else:"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 609,
                "PatchRowcode": "+                log.warn(f\"Role {id} deleted even though it was assigned to \""
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 610,
                "PatchRowcode": "+                         \"users. This may result in missing permissions.\")"
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 611,
                "PatchRowcode": "+                # Note that the role is removed from the users automatically"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 612,
                "PatchRowcode": "+                # due to the relationship between the role and the user."
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 613,
                "PatchRowcode": "+"
            },
            "30": {
                "beforePatchRowNumber": 593,
                "afterPatchRowNumber": 614,
                "PatchRowcode": "         role.delete()"
            },
            "31": {
                "beforePatchRowNumber": 594,
                "afterPatchRowNumber": 615,
                "PatchRowcode": " "
            },
            "32": {
                "beforePatchRowNumber": 595,
                "afterPatchRowNumber": 616,
                "PatchRowcode": "         return {\"msg\": \"Role removed from the database.\"}, HTTPStatus.OK"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from http import HTTPStatus",
            "from flask.globals import request",
            "from flask import g",
            "from flask_restful import reqparse, Api",
            "from sqlalchemy import or_",
            "",
            "from vantage6.server import db",
            "from vantage6.server.resource import (",
            "    with_user,",
            "    ServicesResources",
            ")",
            "from vantage6.common import logger_name",
            "from vantage6.server.permission import (",
            "    PermissionManager",
            ")",
            "from vantage6.server.model.rule import Operation, Scope",
            "from vantage6.server.resource.common._schema import RoleSchema, RuleSchema",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.default_roles import DefaultRole",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the role resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Roles,",
            "        path,",
            "        endpoint='role_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Role,",
            "        path + '/<int:id>',",
            "        endpoint=\"role_with_id\",",
            "        methods=('GET', 'PATCH', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        RoleRules,",
            "        path + '/<int:id>/rule',",
            "        endpoint='role_rule_without_id',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        RoleRules,",
            "        path + '/<int:id>/rule/<int:rule_id>',",
            "        endpoint='role_rule_with_id',",
            "        methods=('DELETE', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "    add(scope=Scope.GLOBAL, operation=Operation.VIEW,",
            "        description=\"View any role\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.VIEW,",
            "        description=\"View the roles of your organization\")",
            "    add(scope=Scope.GLOBAL, operation=Operation.CREATE,",
            "        description=\"Create role for any organization\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.CREATE,",
            "        description=\"Create role for your organization\")",
            "    add(scope=Scope.GLOBAL, operation=Operation.EDIT,",
            "        description=\"Edit any role\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.EDIT,",
            "        description=\"Edit a role from your organization\")",
            "    add(scope=Scope.GLOBAL, operation=Operation.DELETE,",
            "        description=\"Delete any organization\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.DELETE,",
            "        description=\"Delete your organization\")",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Resources / API's",
            "# -----------------------------------------------------------------------------",
            "role_schema = RoleSchema()",
            "rule_schema = RuleSchema()",
            "",
            "",
            "class RoleBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Roles(RoleBase):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"Returns a list of roles",
            "        ---",
            "",
            "        description: >-",
            "            Returns a list of roles. Depending on your permission, you get all",
            "            the roles at the server or only the roles that belong to your",
            "            organization.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Role|Global|View|\u274c|\u274c|View all roles|\\n",
            "            |Role|Organization|View|\u274c|\u274c|View roles that are part of your",
            "            organization|\\n",
            "",
            "            Accesible to users.",
            "",
            "        parameters:",
            "            - in: query",
            "              name: name",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Name to match with a LIKE operator. \\n",
            "                * The percent sign (%) represents zero, one, or multiple",
            "                characters\\n",
            "                * underscore sign (_) represents one, single character",
            "            - in: query",
            "              name: description",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Description to match with a LIKE operator. \\n",
            "                * The percent sign (%) represents zero, one, or multiple",
            "                characters\\n",
            "                * underscore sign (_) represents one, single character",
            "            - in: query",
            "              name: organization_id",
            "              schema:",
            "                type: array",
            "                items:",
            "                  type: integer",
            "                  description: Organization id of which you want to get roles",
            "            - in: query",
            "              name: rule_id",
            "              schema:",
            "                type: integer",
            "              description: Get roles that this role id is part of",
            "            - in: query",
            "              name: user_id",
            "              schema:",
            "                type: integer",
            "              description: Get roles for this user id",
            "            - in: query",
            "              name: include_root",
            "              schema:",
            "                 type: boolean",
            "              description: Whether or not to include root role (default=False)",
            "            - in: query",
            "              name: page",
            "              schema:",
            "                type: integer",
            "              description: Page number for pagination (default=1)",
            "            - in: query",
            "              name: per_page",
            "              schema:",
            "                type: integer",
            "              description: Number of items per page (default=10)",
            "            - in: query",
            "              name: sort",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Sort by one or more fields, separated by a comma. Use a minus",
            "                sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        q = g.session.query(db.Role)",
            "",
            "        auth_org_id = self.obtain_organization_id()",
            "        args = request.args",
            "",
            "        # filter by organization ids (include root role if desired)",
            "        org_filters = args.getlist('organization_id')",
            "        if org_filters:",
            "            if 'include_root' in args and args['include_root']:",
            "                q = q.filter(or_(",
            "                    db.Role.organization_id.in_(org_filters),",
            "                    db.Role.organization_id == None",
            "                ))",
            "            else:",
            "                q = q.filter(db.Role.organization_id.in_(org_filters))",
            "",
            "        # filter by one or more names or descriptions",
            "        for param in ['name', 'description']:",
            "            filters = args.getlist(param)",
            "            if filters:",
            "                q = q.filter(or_(*[",
            "                    getattr(db.Role, param).like(f) for f in filters",
            "                ]))",
            "",
            "        # find roles containing a specific rule",
            "        if 'rule_id' in args:",
            "            q = q.join(db.role_rule_association).join(db.Rule)\\",
            "                 .filter(db.Rule.id == args['rule_id'])",
            "",
            "        if 'user_id' in args:",
            "            q = q.join(db.Permission).join(db.User)\\",
            "                 .filter(db.User.id == args['user_id'])",
            "",
            "        if not self.r.v_glo.can():",
            "            own_role_ids = [role.id for role in g.user.roles]",
            "            if self.r.v_org.can():",
            "                # allow user to view all roles of their organization and any",
            "                # other roles they may have themselves, or default roles from",
            "                # the root organization",
            "                q = q.filter(or_(",
            "                        db.Role.organization_id == auth_org_id,",
            "                        db.Role.id.in_(own_role_ids),",
            "                        db.Role.organization_id == None",
            "                    ))",
            "            else:",
            "                # allow users without permission to view only their own roles",
            "                q = q.filter(db.Role.id.in_(own_role_ids))",
            "",
            "        # paginate results",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        return self.response(page, role_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\"Creates a new role.",
            "        ---",
            "        description: >-",
            "          Create a new role. You can only assign rules that you own. You need",
            "          permission to create roles, and you can only assign roles to other",
            "          organizations if you have gobal permission.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Create|\u274c|\u274c|Create a role for any organization|\\n",
            "          |Role|Organization|Create|\u274c|\u274c|Create a role for your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Human readable name for collaboration",
            "                  description:",
            "                    type: string",
            "                    description: Human readable description of the role",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                      description: Rule id's to assign to role",
            "                  organization_id:",
            "                    type: integer",
            "                    description: Organization to which role is added. If you",
            "                      are root user and want to create a role that will be",
            "                      available to all organizations, leave this empty.",
            "",
            "        responses:",
            "          201:",
            "            description: Created",
            "          400:",
            "            description: Non-allowed role name",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Organization or rule was not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument(\"name\", type=str, required=True)",
            "        parser.add_argument(\"description\", type=str, required=True)",
            "        parser.add_argument(\"rules\", type=int, action='append', required=False)",
            "        parser.add_argument(\"organization_id\", type=int, required=False)",
            "        data = parser.parse_args()",
            "",
            "        # check if role name is allowed (i.e. not a default role name)",
            "        if 'name' in data and data['name'] in [role for role in DefaultRole]:",
            "            return {",
            "                \"msg\": f\"Cannot create role '{data['name']}' as it is a \"",
            "                       \"reserved role name.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "",
            "        # obtain the requested rules from the DB.",
            "        rules = []",
            "        if data['rules']:",
            "            for rule_id in data[\"rules\"]:",
            "                rule = db.Rule.get(rule_id)",
            "                if not rule:",
            "                    return {\"msg\": f\"Rule id={rule_id} not found.\"}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                rules.append(rule)",
            "",
            "        # And check that this used has the rules he is trying to assign",
            "        denied = self.permissions.check_user_rules(rules)",
            "        if denied:",
            "            return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        # set the organization id",
            "        organization_id = (",
            "            data['organization_id']",
            "            if data['organization_id'] else g.user.organization_id",
            "        )",
            "        # verify that the organization for which we create a role exists",
            "        if not db.Organization.get(organization_id):",
            "            return {'msg': f'organization \"{organization_id}\" does not '",
            "                    'exist!'}, HTTPStatus.NOT_FOUND",
            "",
            "        # check if user is allowed to create this role",
            "        if (not self.r.c_glo.can() and",
            "                organization_id != g.user.organization_id):",
            "            return {",
            "                'msg': 'You cannot create roles for other organizations!'",
            "            }, HTTPStatus.UNAUTHORIZED",
            "        elif not self.r.c_glo.can() and not self.r.c_org.can():",
            "            return {'msg': 'You lack the permission to create roles!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # create the actual role",
            "        role = db.Role(name=data[\"name\"], description=data[\"description\"],",
            "                       rules=rules, organization_id=organization_id)",
            "        role.save()",
            "",
            "        return role_schema.dump(role, many=False), HTTPStatus.CREATED",
            "",
            "",
            "class Role(RoleBase):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Get roles",
            "        ---",
            "        description: >-",
            "          Get role based on role identifier.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|View|\u274c|\u274c|View all roles|\\n",
            "          |Role|Organization|View|\u274c|\u274c|View roles that are part of your",
            "          organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Role id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "",
            "        if not role:",
            "            return {\"msg\": f\"Role with id={id} not found.\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check permissions. A user can always view their own roles",
            "        if not (self.r.v_glo.can() or role in g.user.roles):",
            "            if not (self.r.v_org.can()",
            "                    and role.organization == g.user.organization):",
            "                return {\"msg\": \"You do not have permission to view this.\"},\\",
            "                     HTTPStatus.UNAUTHORIZED",
            "",
            "        return role_schema.dump(role, many=False), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def patch(self, id):",
            "        \"\"\"Update role",
            "        ---",
            "        description: >-",
            "          Updates roles if the user has permission to do so.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Edit|\u274c|\u274c|Update any role|\\n",
            "          |Role|Organization|Edit|\u274c|\u274c|Update a role from your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Role id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Human readable name for collaboration",
            "                  description:",
            "                    type: string",
            "                    description: Human readable description of the role",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                      description: Rule id's to assign to role",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Non-allowed role name change",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Role id or rule id not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        data = request.get_json()",
            "",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {\"msg\": f\"Role with id={id} not found.\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check if role name is allowed (i.e. not a default role name)",
            "        if 'name' in data and data['name'] in [role for role in DefaultRole]:",
            "            return {",
            "                \"msg\": f\"Cannot change role name into '{data['name']}' as that\"",
            "                       \" is a reserved role name.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "        elif role.name in [role for role in DefaultRole]:",
            "            return {",
            "                \"msg\": f\"This role ('{role.name}') is a default role. Its name\"",
            "                       \" cannot be changed.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "",
            "        # check permission of the user",
            "        if not self.r.e_glo.can():",
            "            if not self.r.e_org.can():",
            "                return {'msg': 'You do not have permission to edit roles!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "            elif g.user.organization_id != role.organization.id:",
            "                return {'msg': 'You can\\'t edit roles from another '",
            "                        'organization'}, HTTPStatus.UNAUTHORIZED",
            "",
            "        # process patch",
            "        if 'name' in data:",
            "            role.name = data[\"name\"]",
            "        if 'description' in data:",
            "            role.description = data[\"description\"]",
            "        if 'rules' in data:",
            "            rules = []",
            "            for rule_id in data['rules']:",
            "                rule = db.Rule.get(rule_id)",
            "                if not rule:",
            "                    return {'msg': f'rule with id={rule_id} not found!'}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                rules.append(rule)",
            "            denied = self.permissions.check_user_rules(rules)",
            "            if denied:",
            "                return denied, HTTPStatus.UNAUTHORIZED",
            "            role.rules = rules",
            "        role.save()",
            "",
            "        return role_schema.dump(role, many=False), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\"Delete role",
            "        ---",
            "        description: >-",
            "          Delete role from an organization if user is allowed to delete the",
            "          role.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Delete|\u274c|\u274c|Delete any role|\\n",
            "          |Role|Organization|Delete|\u274c|\u274c|Delete a role in your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Role id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Role id not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {\"msg\": f\"Role with id={id} not found.\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            if not self.r.d_org.can():",
            "                return {'msg': 'You do not have permission to delete roles!'},\\",
            "                    HTTPStatus.UNAUTHORIZED",
            "            elif role.organization.id != g.user.organization.id:",
            "                return {'msg': 'You can\\'t delete a role from another '",
            "                        'organization'}, HTTPStatus.UNAUTHORIZED",
            "",
            "        role.delete()",
            "",
            "        return {\"msg\": \"Role removed from the database.\"}, HTTPStatus.OK",
            "",
            "",
            "class RoleRules(RoleBase):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Returns the rules for a specific role",
            "        ---",
            "        description: >-",
            "            View the rules that belong to a specific role.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Role|Global|View|\u274c|\u274c|View a role's rules|\\n",
            "            |Role|Organization|View|\u274c|\u274c|View a role's rules for roles in",
            "            your organization|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "            - in: path",
            "              name: id",
            "              schema:",
            "                type: integer",
            "              minimum: 1",
            "              description: Role id",
            "              required: true",
            "            - in: query",
            "              name: page",
            "              schema:",
            "                type: integer",
            "              description: Page number for pagination (default=1)",
            "            - in: query",
            "              name: per_page",
            "              schema:",
            "                type: integer",
            "              description: Number of items per page (default=10)",
            "            - in: query",
            "              name: sort",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Sort by one or more fields, separated by a comma. Use a minus",
            "                sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "            200:",
            "                description: Ok",
            "            404:",
            "                description: Node with specified id is not found",
            "            401:",
            "                description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "",
            "        if not role:",
            "            return {'msg': f'Role id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "",
            "        # obtain auth organization model",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        # check permission",
            "        if not self.r.v_glo.can():",
            "            if not (self.r.v_org.can() and auth_org == role.organization):",
            "                return {'msg': 'You lack permissions to do that'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate elements",
            "        page = Pagination.from_list(role.rules, request)",
            "",
            "        return self.response(page, rule_schema)",
            "",
            "    @with_user",
            "    def post(self, id, rule_id):",
            "        \"\"\"Add a rule to a role.",
            "        ---",
            "        description: >-",
            "          Add a rule to a role given that the role exists already and that the",
            "          user has the permission to do so.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Edit|\u274c|\u274c|Edit any role|\\n",
            "          |Role|Organization|Edit|\u274c|\u274c|Edit any role in your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Role id",
            "            required: tr",
            "          - in: path",
            "            name: rule_id",
            "            schema:",
            "              type: integer",
            "            description: Rule id to add to role",
            "            required: tr",
            "",
            "        responses:",
            "          201:",
            "            description: Added rule to role",
            "          404:",
            "            description: Rule or role not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {'msg': f'Role id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "        rule = db.Rule.get(rule_id)",
            "        if not rule:",
            "            return {'msg': f'Rule id={rule_id} not found!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check that this user can edit rules",
            "        if not self.r.e_glo.can():",
            "            if not (self.r.e_org.can() and",
            "                    g.user.organization == role.organization):",
            "                return {'msg': 'You lack permissions to do that'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # user needs to role to assign it",
            "        denied = self.permissions.check_user_rules([rule])",
            "        if denied:",
            "            return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        # We're good, lets add the rule",
            "        role.rules.append(rule)",
            "        role.save()",
            "",
            "        return rule_schema.dump(role.rules, many=True), HTTPStatus.CREATED",
            "",
            "    @with_user",
            "    def delete(self, id, rule_id):",
            "        \"\"\"Removes rule from role.",
            "        ---",
            "        description: >-",
            "          Removes a rule from a role given the user has permission and the rule",
            "          id exists.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Delete|\u274c|\u274c|Delete any role rule|\\n",
            "          |Role|Organization|Delete|\u274c|\u274c|Delete any role rule in your",
            "          organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Role id",
            "          - in: path",
            "            name: rule_id",
            "            schema:",
            "              type: integer",
            "            description: Rule id to delete from the role",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Role or rule id not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {'msg': f'Role id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "        rule = db.Rule.get(rule_id)",
            "        if not rule:",
            "            return {'msg': f'Rule id={rule_id} not found!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            if not (self.r.d_org.can() and",
            "                    g.user.organization == role.organization):",
            "                return {'msg': 'You lack permissions to do that'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # user needs to role to remove it",
            "        denied = self.permissions.check_user_rules([rule])",
            "        if denied:",
            "            return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        if not (rule in role.rules):",
            "            return {'msg': f'Rule id={rule_id} not found in Role={id}!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # Ok jumped all hoopes, remove it..",
            "        role.rules.remove(rule)",
            "",
            "        return rule_schema.dump(role.rules, many=True), HTTPStatus.OK"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "",
            "from http import HTTPStatus",
            "from flask.globals import request",
            "from flask import g",
            "from flask_restful import reqparse, Api",
            "from sqlalchemy import or_",
            "",
            "from vantage6.server import db",
            "from vantage6.server.resource import (",
            "    with_user,",
            "    ServicesResources",
            ")",
            "from vantage6.common import logger_name",
            "from vantage6.server.permission import (",
            "    PermissionManager",
            ")",
            "from vantage6.server.model.rule import Operation, Scope",
            "from vantage6.server.resource.common._schema import RoleSchema, RuleSchema",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.default_roles import DefaultRole",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the role resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Roles,",
            "        path,",
            "        endpoint='role_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Role,",
            "        path + '/<int:id>',",
            "        endpoint=\"role_with_id\",",
            "        methods=('GET', 'PATCH', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        RoleRules,",
            "        path + '/<int:id>/rule',",
            "        endpoint='role_rule_without_id',",
            "        methods=('GET',),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        RoleRules,",
            "        path + '/<int:id>/rule/<int:rule_id>',",
            "        endpoint='role_rule_with_id',",
            "        methods=('DELETE', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "    add(scope=Scope.GLOBAL, operation=Operation.VIEW,",
            "        description=\"View any role\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.VIEW,",
            "        description=\"View the roles of your organization\")",
            "    add(scope=Scope.GLOBAL, operation=Operation.CREATE,",
            "        description=\"Create role for any organization\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.CREATE,",
            "        description=\"Create role for your organization\")",
            "    add(scope=Scope.GLOBAL, operation=Operation.EDIT,",
            "        description=\"Edit any role\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.EDIT,",
            "        description=\"Edit a role from your organization\")",
            "    add(scope=Scope.GLOBAL, operation=Operation.DELETE,",
            "        description=\"Delete any organization\")",
            "    add(scope=Scope.ORGANIZATION, operation=Operation.DELETE,",
            "        description=\"Delete your organization\")",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Resources / API's",
            "# -----------------------------------------------------------------------------",
            "role_schema = RoleSchema()",
            "rule_schema = RuleSchema()",
            "",
            "",
            "class RoleBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Roles(RoleBase):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"Returns a list of roles",
            "        ---",
            "",
            "        description: >-",
            "            Returns a list of roles. Depending on your permission, you get all",
            "            the roles at the server or only the roles that belong to your",
            "            organization.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Role|Global|View|\u274c|\u274c|View all roles|\\n",
            "            |Role|Organization|View|\u274c|\u274c|View roles that are part of your",
            "            organization|\\n",
            "",
            "            Accesible to users.",
            "",
            "        parameters:",
            "            - in: query",
            "              name: name",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Name to match with a LIKE operator. \\n",
            "                * The percent sign (%) represents zero, one, or multiple",
            "                characters\\n",
            "                * underscore sign (_) represents one, single character",
            "            - in: query",
            "              name: description",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Description to match with a LIKE operator. \\n",
            "                * The percent sign (%) represents zero, one, or multiple",
            "                characters\\n",
            "                * underscore sign (_) represents one, single character",
            "            - in: query",
            "              name: organization_id",
            "              schema:",
            "                type: array",
            "                items:",
            "                  type: integer",
            "                  description: Organization id of which you want to get roles",
            "            - in: query",
            "              name: rule_id",
            "              schema:",
            "                type: integer",
            "              description: Get roles that this role id is part of",
            "            - in: query",
            "              name: user_id",
            "              schema:",
            "                type: integer",
            "              description: Get roles for this user id",
            "            - in: query",
            "              name: include_root",
            "              schema:",
            "                 type: boolean",
            "              description: Whether or not to include root role (default=False)",
            "            - in: query",
            "              name: page",
            "              schema:",
            "                type: integer",
            "              description: Page number for pagination (default=1)",
            "            - in: query",
            "              name: per_page",
            "              schema:",
            "                type: integer",
            "              description: Number of items per page (default=10)",
            "            - in: query",
            "              name: sort",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Sort by one or more fields, separated by a comma. Use a minus",
            "                sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          400:",
            "            description: Improper values for pagination or sorting parameters",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        q = g.session.query(db.Role)",
            "",
            "        auth_org_id = self.obtain_organization_id()",
            "        args = request.args",
            "",
            "        # filter by organization ids (include root role if desired)",
            "        org_filters = args.getlist('organization_id')",
            "        if org_filters:",
            "            if 'include_root' in args and args['include_root']:",
            "                q = q.filter(or_(",
            "                    db.Role.organization_id.in_(org_filters),",
            "                    db.Role.organization_id == None",
            "                ))",
            "            else:",
            "                q = q.filter(db.Role.organization_id.in_(org_filters))",
            "",
            "        # filter by one or more names or descriptions",
            "        for param in ['name', 'description']:",
            "            filters = args.getlist(param)",
            "            if filters:",
            "                q = q.filter(or_(*[",
            "                    getattr(db.Role, param).like(f) for f in filters",
            "                ]))",
            "",
            "        # find roles containing a specific rule",
            "        if 'rule_id' in args:",
            "            q = q.join(db.role_rule_association).join(db.Rule)\\",
            "                 .filter(db.Rule.id == args['rule_id'])",
            "",
            "        if 'user_id' in args:",
            "            q = q.join(db.Permission).join(db.User)\\",
            "                 .filter(db.User.id == args['user_id'])",
            "",
            "        if not self.r.v_glo.can():",
            "            own_role_ids = [role.id for role in g.user.roles]",
            "            if self.r.v_org.can():",
            "                # allow user to view all roles of their organization and any",
            "                # other roles they may have themselves, or default roles from",
            "                # the root organization",
            "                q = q.filter(or_(",
            "                        db.Role.organization_id == auth_org_id,",
            "                        db.Role.id.in_(own_role_ids),",
            "                        db.Role.organization_id == None",
            "                    ))",
            "            else:",
            "                # allow users without permission to view only their own roles",
            "                q = q.filter(db.Role.id.in_(own_role_ids))",
            "",
            "        # paginate results",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        return self.response(page, role_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\"Creates a new role.",
            "        ---",
            "        description: >-",
            "          Create a new role. You can only assign rules that you own. You need",
            "          permission to create roles, and you can only assign roles to other",
            "          organizations if you have gobal permission.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Create|\u274c|\u274c|Create a role for any organization|\\n",
            "          |Role|Organization|Create|\u274c|\u274c|Create a role for your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Human readable name for collaboration",
            "                  description:",
            "                    type: string",
            "                    description: Human readable description of the role",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                      description: Rule id's to assign to role",
            "                  organization_id:",
            "                    type: integer",
            "                    description: Organization to which role is added. If you",
            "                      are root user and want to create a role that will be",
            "                      available to all organizations, leave this empty.",
            "",
            "        responses:",
            "          201:",
            "            description: Created",
            "          400:",
            "            description: Non-allowed role name",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Organization or rule was not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument(\"name\", type=str, required=True)",
            "        parser.add_argument(\"description\", type=str, required=True)",
            "        parser.add_argument(\"rules\", type=int, action='append', required=False)",
            "        parser.add_argument(\"organization_id\", type=int, required=False)",
            "        data = parser.parse_args()",
            "",
            "        # check if role name is allowed (i.e. not a default role name)",
            "        if 'name' in data and data['name'] in [role for role in DefaultRole]:",
            "            return {",
            "                \"msg\": f\"Cannot create role '{data['name']}' as it is a \"",
            "                       \"reserved role name.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "",
            "        # obtain the requested rules from the DB.",
            "        rules = []",
            "        if data['rules']:",
            "            for rule_id in data[\"rules\"]:",
            "                rule = db.Rule.get(rule_id)",
            "                if not rule:",
            "                    return {\"msg\": f\"Rule id={rule_id} not found.\"}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                rules.append(rule)",
            "",
            "        # And check that this used has the rules he is trying to assign",
            "        denied = self.permissions.check_user_rules(rules)",
            "        if denied:",
            "            return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        # set the organization id",
            "        organization_id = (",
            "            data['organization_id']",
            "            if data['organization_id'] else g.user.organization_id",
            "        )",
            "        # verify that the organization for which we create a role exists",
            "        if not db.Organization.get(organization_id):",
            "            return {'msg': f'organization \"{organization_id}\" does not '",
            "                    'exist!'}, HTTPStatus.NOT_FOUND",
            "",
            "        # check if user is allowed to create this role",
            "        if (not self.r.c_glo.can() and",
            "                organization_id != g.user.organization_id):",
            "            return {",
            "                'msg': 'You cannot create roles for other organizations!'",
            "            }, HTTPStatus.UNAUTHORIZED",
            "        elif not self.r.c_glo.can() and not self.r.c_org.can():",
            "            return {'msg': 'You lack the permission to create roles!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # create the actual role",
            "        role = db.Role(name=data[\"name\"], description=data[\"description\"],",
            "                       rules=rules, organization_id=organization_id)",
            "        role.save()",
            "",
            "        return role_schema.dump(role, many=False), HTTPStatus.CREATED",
            "",
            "",
            "class Role(RoleBase):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Get roles",
            "        ---",
            "        description: >-",
            "          Get role based on role identifier.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|View|\u274c|\u274c|View all roles|\\n",
            "          |Role|Organization|View|\u274c|\u274c|View roles that are part of your",
            "          organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Role id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "",
            "        if not role:",
            "            return {\"msg\": f\"Role with id={id} not found.\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check permissions. A user can always view their own roles",
            "        if not (self.r.v_glo.can() or role in g.user.roles):",
            "            if not (self.r.v_org.can()",
            "                    and role.organization == g.user.organization):",
            "                return {\"msg\": \"You do not have permission to view this.\"},\\",
            "                     HTTPStatus.UNAUTHORIZED",
            "",
            "        return role_schema.dump(role, many=False), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def patch(self, id):",
            "        \"\"\"Update role",
            "        ---",
            "        description: >-",
            "          Updates roles if the user has permission to do so.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Edit|\u274c|\u274c|Update any role|\\n",
            "          |Role|Organization|Edit|\u274c|\u274c|Update a role from your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Role id",
            "            required: tr",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  name:",
            "                    type: string",
            "                    description: Human readable name for collaboration",
            "                  description:",
            "                    type: string",
            "                    description: Human readable description of the role",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                      description: Rule id's to assign to role",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Non-allowed role name change",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Role id or rule id not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        data = request.get_json()",
            "",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {\"msg\": f\"Role with id={id} not found.\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check if role name is allowed (i.e. not a default role name)",
            "        if 'name' in data and data['name'] in [role for role in DefaultRole]:",
            "            return {",
            "                \"msg\": f\"Cannot change role name into '{data['name']}' as that\"",
            "                       \" is a reserved role name.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "        elif role.name in [role for role in DefaultRole]:",
            "            return {",
            "                \"msg\": f\"This role ('{role.name}') is a default role. Its name\"",
            "                       \" cannot be changed.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "",
            "        # check permission of the user",
            "        if not self.r.e_glo.can():",
            "            if not self.r.e_org.can():",
            "                return {'msg': 'You do not have permission to edit roles!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "            elif g.user.organization_id != role.organization.id:",
            "                return {'msg': 'You can\\'t edit roles from another '",
            "                        'organization'}, HTTPStatus.UNAUTHORIZED",
            "",
            "        # process patch",
            "        if 'name' in data:",
            "            role.name = data[\"name\"]",
            "        if 'description' in data:",
            "            role.description = data[\"description\"]",
            "        if 'rules' in data:",
            "            rules = []",
            "            for rule_id in data['rules']:",
            "                rule = db.Rule.get(rule_id)",
            "                if not rule:",
            "                    return {'msg': f'rule with id={rule_id} not found!'}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                rules.append(rule)",
            "            denied = self.permissions.check_user_rules(rules)",
            "            if denied:",
            "                return denied, HTTPStatus.UNAUTHORIZED",
            "            role.rules = rules",
            "        role.save()",
            "",
            "        return role_schema.dump(role, many=False), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\"Delete role",
            "        ---",
            "        description: >-",
            "          Delete role from an organization if user is allowed to delete the",
            "          role.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Delete|\u274c|\u274c|Delete any role|\\n",
            "          |Role|Organization|Delete|\u274c|\u274c|Delete a role in your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "              minimum: 1",
            "            description: Role id",
            "            required: true",
            "          - in: query",
            "            name: delete_dependents",
            "            schema:",
            "              type: boolean",
            "            description: If set to true, the role is deleted even though users",
            "               with this role may lose permissions (default=False)",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Role id not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {\"msg\": f\"Role with id={id} not found.\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            if not self.r.d_org.can():",
            "                return {'msg': 'You do not have permission to delete roles!'},\\",
            "                    HTTPStatus.UNAUTHORIZED",
            "            elif role.organization.id != g.user.organization.id:",
            "                return {'msg': 'You can\\'t delete a role from another '",
            "                        'organization'}, HTTPStatus.UNAUTHORIZED",
            "",
            "        # check if role is assigned to users",
            "        if role.users:",
            "            params = request.args",
            "            if not params.get('delete_dependents', False):",
            "                return {",
            "                    'msg': \"Role is assigned to users. Please remove the role \"",
            "                    \"from the users first, or set the 'delete_dependents' \"",
            "                    \"parameter to delete the role anyway.\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            else:",
            "                log.warn(f\"Role {id} deleted even though it was assigned to \"",
            "                         \"users. This may result in missing permissions.\")",
            "                # Note that the role is removed from the users automatically",
            "                # due to the relationship between the role and the user.",
            "",
            "        role.delete()",
            "",
            "        return {\"msg\": \"Role removed from the database.\"}, HTTPStatus.OK",
            "",
            "",
            "class RoleRules(RoleBase):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Returns the rules for a specific role",
            "        ---",
            "        description: >-",
            "            View the rules that belong to a specific role.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |Role|Global|View|\u274c|\u274c|View a role's rules|\\n",
            "            |Role|Organization|View|\u274c|\u274c|View a role's rules for roles in",
            "            your organization|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "            - in: path",
            "              name: id",
            "              schema:",
            "                type: integer",
            "              minimum: 1",
            "              description: Role id",
            "              required: true",
            "            - in: query",
            "              name: page",
            "              schema:",
            "                type: integer",
            "              description: Page number for pagination (default=1)",
            "            - in: query",
            "              name: per_page",
            "              schema:",
            "                type: integer",
            "              description: Number of items per page (default=10)",
            "            - in: query",
            "              name: sort",
            "              schema:",
            "                type: string",
            "              description: >-",
            "                Sort by one or more fields, separated by a comma. Use a minus",
            "                sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "            200:",
            "                description: Ok",
            "            404:",
            "                description: Node with specified id is not found",
            "            401:",
            "                description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "",
            "        if not role:",
            "            return {'msg': f'Role id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "",
            "        # obtain auth organization model",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        # check permission",
            "        if not self.r.v_glo.can():",
            "            if not (self.r.v_org.can() and auth_org == role.organization):",
            "                return {'msg': 'You lack permissions to do that'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate elements",
            "        page = Pagination.from_list(role.rules, request)",
            "",
            "        return self.response(page, rule_schema)",
            "",
            "    @with_user",
            "    def post(self, id, rule_id):",
            "        \"\"\"Add a rule to a role.",
            "        ---",
            "        description: >-",
            "          Add a rule to a role given that the role exists already and that the",
            "          user has the permission to do so.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Edit|\u274c|\u274c|Edit any role|\\n",
            "          |Role|Organization|Edit|\u274c|\u274c|Edit any role in your organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Role id",
            "            required: tr",
            "          - in: path",
            "            name: rule_id",
            "            schema:",
            "              type: integer",
            "            description: Rule id to add to role",
            "            required: tr",
            "",
            "        responses:",
            "          201:",
            "            description: Added rule to role",
            "          404:",
            "            description: Rule or role not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {'msg': f'Role id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "        rule = db.Rule.get(rule_id)",
            "        if not rule:",
            "            return {'msg': f'Rule id={rule_id} not found!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # check that this user can edit rules",
            "        if not self.r.e_glo.can():",
            "            if not (self.r.e_org.can() and",
            "                    g.user.organization == role.organization):",
            "                return {'msg': 'You lack permissions to do that'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # user needs to role to assign it",
            "        denied = self.permissions.check_user_rules([rule])",
            "        if denied:",
            "            return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        # We're good, lets add the rule",
            "        role.rules.append(rule)",
            "        role.save()",
            "",
            "        return rule_schema.dump(role.rules, many=True), HTTPStatus.CREATED",
            "",
            "    @with_user",
            "    def delete(self, id, rule_id):",
            "        \"\"\"Removes rule from role.",
            "        ---",
            "        description: >-",
            "          Removes a rule from a role given the user has permission and the rule",
            "          id exists.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Role|Global|Delete|\u274c|\u274c|Delete any role rule|\\n",
            "          |Role|Organization|Delete|\u274c|\u274c|Delete any role rule in your",
            "          organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Role id",
            "          - in: path",
            "            name: rule_id",
            "            schema:",
            "              type: integer",
            "            description: Rule id to delete from the role",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Role or rule id not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        tags: [\"Role\"]",
            "        \"\"\"",
            "        role = db.Role.get(id)",
            "        if not role:",
            "            return {'msg': f'Role id={id} not found!'}, HTTPStatus.NOT_FOUND",
            "        rule = db.Rule.get(rule_id)",
            "        if not rule:",
            "            return {'msg': f'Rule id={rule_id} not found!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            if not (self.r.d_org.can() and",
            "                    g.user.organization == role.organization):",
            "                return {'msg': 'You lack permissions to do that'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # user needs to role to remove it",
            "        denied = self.permissions.check_user_rules([rule])",
            "        if denied:",
            "            return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        if not (rule in role.rules):",
            "            return {'msg': f'Rule id={rule_id} not found in Role={id}!'}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        # Ok jumped all hoopes, remove it..",
            "        role.rules.remove(rule)",
            "",
            "        return rule_schema.dump(role.rules, many=True), HTTPStatus.OK"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "django.contrib.auth.forms.AdminPasswordChangeForm"
        ]
    },
    "vantage6-server/vantage6/server/resource/task.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 728,
                "afterPatchRowNumber": 728,
                "PatchRowcode": "             log.info(f\" Removing run id={run.id}\")"
            },
            "1": {
                "beforePatchRowNumber": 729,
                "afterPatchRowNumber": 729,
                "PatchRowcode": "             run.delete()"
            },
            "2": {
                "beforePatchRowNumber": 730,
                "afterPatchRowNumber": 730,
                "PatchRowcode": " "
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 731,
                "PatchRowcode": "+        # delete child tasks"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 732,
                "PatchRowcode": "+        for child_task in task.children:"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 733,
                "PatchRowcode": "+            log.info(f\" Removing child task id={child_task.id}\")"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 734,
                "PatchRowcode": "+            child_task.delete()"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 735,
                "PatchRowcode": "+"
            },
            "8": {
                "beforePatchRowNumber": 731,
                "afterPatchRowNumber": 736,
                "PatchRowcode": "         # permissions ok, delete..."
            },
            "9": {
                "beforePatchRowNumber": 732,
                "afterPatchRowNumber": 737,
                "PatchRowcode": "         task.delete()"
            },
            "10": {
                "beforePatchRowNumber": 733,
                "afterPatchRowNumber": 738,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "import json",
            "",
            "from flask import g, request, url_for",
            "from flask_restful import Api",
            "from http import HTTPStatus",
            "from sqlalchemy import desc",
            "",
            "from vantage6.common.globals import STRING_ENCODING",
            "from vantage6.common.task_status import TaskStatus, has_task_finished",
            "from vantage6.server import db",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    PermissionManager,",
            "    Operation as P",
            ")",
            "from vantage6.server.resource import only_for, ServicesResources, with_user",
            "from vantage6.server.resource.common._schema import (",
            "    TaskSchema,",
            "    TaskIncludedSchema,",
            ")",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.resource.event import kill_task",
            "",
            "",
            "module_name = __name__.split('.')[-1]",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the task resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Tasks,",
            "        path,",
            "        endpoint='task_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Task,",
            "        path + '/<int:id>',",
            "        endpoint='task_with_id',",
            "        methods=('GET', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "",
            "    add(scope=S.GLOBAL, operation=P.VIEW,",
            "        description=\"view any task\")",
            "    add(scope=S.ORGANIZATION, operation=P.VIEW, assign_to_container=True,",
            "        assign_to_node=True, description=\"view tasks of your organization\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.CREATE, description=\"create a new task\")",
            "    add(scope=S.ORGANIZATION, operation=P.CREATE,",
            "        description=(",
            "            \"create a new task for collaborations in which your organization \"",
            "            \"participates with\"",
            "        ))",
            "",
            "    add(scope=S.GLOBAL, operation=P.DELETE,",
            "        description=\"delete a task\")",
            "    add(scope=S.ORGANIZATION, operation=P.DELETE,",
            "        description=(",
            "            \"delete a task from a collaboration in which your organization \"",
            "            \"participates with\"",
            "        ))",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "task_schema = TaskSchema()",
            "task_result_schema = TaskIncludedSchema()",
            "",
            "",
            "class TaskBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Tasks(TaskBase):",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self):",
            "        \"\"\"List tasks",
            "        ---",
            "        description: >-",
            "          Returns a list of tasks.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|View|\u274c|\u274c|View any task|\\n",
            "          |Task|Organization|View|\u2705|\u2705|View any task in your organization|",
            "          \\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: init_org_id",
            "            schema:",
            "              type: int",
            "            description: The organization id of the origin of the request",
            "          - in: query",
            "            name: init_user_id",
            "            schema:",
            "              type: int",
            "            description: The user id of the user that started the task",
            "          - in: query",
            "            name: collaboration_id",
            "            schema:",
            "              type: int",
            "            description: The collaboration id to which the task belongs",
            "          - in: query",
            "            name: is_user_created",
            "            schema:",
            "              type: int",
            "            description: >-",
            "              If larger than 0, returns tasks created by a user (top-level",
            "              tasks). If equal to 0, returns subtask created by an algorithm.",
            "              If not specified, both are returned.",
            "          - in: query",
            "            name: image",
            "            schema:",
            "              type: str",
            "            description: >-",
            "              (Docker) image name which is used in the task. Name to match",
            "              with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: parent_id",
            "            schema:",
            "              type: int",
            "            description: The id of the parent task",
            "          - in: query",
            "            name: job_id",
            "            schema:",
            "              type: int",
            "            description: The run id that belongs to the task",
            "          - in: query",
            "            name: name",
            "            schema:",
            "              type: str",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: description",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Description to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: database",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Database description to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: run_id",
            "            schema:",
            "              type: int",
            "            description: A run id that belongs to the task",
            "          - in: query",
            "            name: include",
            "            schema:",
            "              type: array",
            "              items:",
            "                type: string",
            "            description: Include 'results' to get task results.",
            "          - in: query",
            "            name: status",
            "            schema:",
            "              type: string",
            "            description: Filter by task status, e.g. 'active' for active",
            "              tasks, 'completed' for finished or 'crashed' for failed tasks.",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Non-allowed parameter values",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "        q = g.session.query(db.Task)",
            "        args = request.args",
            "",
            "        # obtain organization id",
            "        auth_org_id = self.obtain_organization_id()",
            "",
            "        # check permissions and apply filter if neccassary",
            "        if not self.r.v_glo.can():",
            "            if self.r.v_org.can():",
            "                q = q.join(db.Collaboration).join(db.Organization)\\",
            "                    .filter(db.Collaboration.organizations.any(id=auth_org_id))",
            "            else:",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # filter based on arguments",
            "        for param in ['init_org_id', 'init_user_id', 'collaboration_id',",
            "                      'parent_id', 'job_id']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.Task, param) == args[param])",
            "        for param in ['name', 'image', 'description', 'status']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.Task, param).like(args[param]))",
            "        if 'run_id' in args:",
            "            q = q.join(db.Run).filter(db.Run.id == args['run_id'])",
            "        if 'database' in args:",
            "            q = q.join(db.TaskDatabase)\\",
            "                 .filter(db.TaskDatabase.database == args['database'])",
            "        if 'is_user_created' in args:",
            "            try:",
            "                user_created = int(args['is_user_created'])",
            "                if user_created == 0:",
            "                    q = q.filter(db.Task.parent_id.isnot(None))",
            "                else:",
            "                    q = q.filter(db.Task.parent_id.is_(None))",
            "            except ValueError:",
            "                return {\"msg\": (",
            "                    \"Invalid value for 'is_user_created' provided: \"",
            "                    f\"'{args['is_user_created']}'. Should be an integer.\"",
            "                )}, HTTPStatus.BAD_REQUEST",
            "",
            "        q = q.order_by(desc(db.Task.id))",
            "        # paginate tasks",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # serialization schema",
            "        schema = task_result_schema if self.is_included('results') else\\",
            "            task_schema",
            "",
            "        return self.response(page, schema)",
            "",
            "    @only_for((\"user\", \"container\"))",
            "    def post(self):",
            "        \"\"\"Adds new computation task",
            "        ---",
            "        description: >-",
            "          Creates a new task within a collaboration. If no `organization_ids`",
            "          are given the task is send to all organizations within the",
            "          collaboration. The endpoint can be accessed by both a `User` and",
            "          `Container`.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|Create|\u274c|\u274c|Create a new task|\\n",
            "          |Task|Organization|Create|\u274c|\u2705|Create a new task for a specific",
            "          collaboration in which your organization participates|\\n",
            "",
            "          ## Accessed as `User`\\n",
            "          This endpoint is accessible to users. A new `job_id` is",
            "          created when a user creates a task. The user needs to be within an",
            "          organization that is part of the collaboration to which the task is",
            "          posted.\\n",
            "",
            "          ## Accessed as `Container`\\n",
            "          When this endpoint is accessed by an algorithm container, it is",
            "          considered to be a child-task of the container, and will get the",
            "          `job_id` from the initial task. Containers have limited permissions",
            "          to create tasks: they are only allowed to create tasks in the same",
            "          collaboration using the same image.\\n",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                $ref: '#/components/schemas/Task'",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Supplied organizations are not in the supplied",
            "              collaboration, or not all required nodes are registered, or you",
            "              are not in the collaboration yourself",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Collaboration with `collaboration_id` not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "        data = request.get_json()",
            "        collaboration_id = data.get('collaboration_id')",
            "        collaboration = db.Collaboration.get(collaboration_id)",
            "",
            "        if not collaboration:",
            "            return {\"msg\": f\"Collaboration id={collaboration_id} not found!\"},\\",
            "                   HTTPStatus.NOT_FOUND",
            "",
            "        organizations_json_list = data.get('organizations')",
            "        org_ids = [org.get(\"id\") for org in organizations_json_list]",
            "        db_ids = collaboration.get_organization_ids()",
            "",
            "        # Check that all organization ids are within the collaboration, this",
            "        # also ensures us that the organizations exist",
            "        if not set(org_ids).issubset(db_ids):",
            "            return {\"msg\": (",
            "                \"At least one of the supplied organizations in not within \"",
            "                \"the collaboration.\"",
            "            )}, HTTPStatus.BAD_REQUEST",
            "",
            "        # check if all the organizations have a registered node",
            "        nodes = g.session.query(db.Node)\\",
            "            .filter(db.Node.organization_id.in_(org_ids))\\",
            "            .filter(db.Node.collaboration_id == collaboration_id)\\",
            "            .all()",
            "        if len(nodes) < len(org_ids):",
            "            present_nodes = [node.organization_id for node in nodes]",
            "            missing = [str(id) for id in org_ids if id not in present_nodes]",
            "            return {\"msg\": (",
            "                \"Cannot create this task because there are no nodes registered\"",
            "                f\" for the following organization(s): {', '.join(missing)}.\"",
            "            )}, HTTPStatus.BAD_REQUEST",
            "        # check if any of the nodes that are offline shared their configuration",
            "        # info and if this prevents this user from creating this task",
            "        if g.user:",
            "            for node in nodes:",
            "                if self._node_doesnt_allow_user_task(node.config):",
            "                    return {\"msg\": (",
            "                        \"Cannot create this task because one of the nodes that\"",
            "                        \" you are trying to send this task to does not allow \"",
            "                        \"you to create tasks.\"",
            "                    )}, HTTPStatus.BAD_REQUEST",
            "",
            "        # figure out the initiating organization of the task",
            "        if g.user:",
            "            init_org = g.user.organization",
            "        else:  # g.container:",
            "            init_org = db.Node.get(g.container[\"node_id\"]).organization",
            "",
            "        # check if the initiating organization is part of the collaboration",
            "        if init_org not in collaboration.organizations:",
            "            return {",
            "                \"msg\": \"You can only create tasks for collaborations \"",
            "                       \"you are participating in!\"",
            "            }, HTTPStatus.UNAUTHORIZED",
            "",
            "        # Create the new task in the database",
            "        image = data.get('image', '')",
            "",
            "        # verify permissions",
            "        if g.user:",
            "            if not self.r.c_glo.can():",
            "                c_orgs = collaboration.organizations",
            "                if not (self.r.c_org.can() and g.user.organization in c_orgs):",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "",
            "        elif g.container:",
            "            # verify that the container has permissions to create the task",
            "            if not self.__verify_container_permissions(g.container, image,",
            "                                                       collaboration_id):",
            "                return {\"msg\": \"Container-token is not valid\"}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "",
            "        # permissions ok, create task record and TaskDatabase records",
            "        task = db.Task(collaboration=collaboration, name=data.get('name', ''),",
            "                       description=data.get('description', ''), image=image,",
            "                       init_org=init_org)",
            "",
            "        # create job_id. Users can only create top-level -tasks (they will not",
            "        # have sub-tasks). Therefore, always create a new job_id. Tasks created",
            "        # by containers are always sub-tasks",
            "        if g.user:",
            "            task.job_id = task.next_job_id()",
            "            task.init_user_id = g.user.id",
            "            log.debug(f\"New job_id {task.job_id}\")",
            "        elif g.container:",
            "            task.parent_id = g.container[\"task_id\"]",
            "            parent = db.Task.get(g.container[\"task_id\"])",
            "            task.job_id = parent.job_id",
            "            task.init_user_id = parent.init_user_id",
            "            log.debug(f\"Sub task from parent_id={task.parent_id}\")",
            "",
            "        # ok commit session...",
            "        task.save()",
            "",
            "        # save the databases that the task uses",
            "        databases = data.get('databases', ['default'])",
            "        if not isinstance(databases, list):",
            "            databases = [databases]",
            "        for database in databases:",
            "            db_record = db.TaskDatabase(task_id=task.id, database=database)",
            "            db_record.save()",
            "",
            "        # send socket event that task has been created",
            "        self.socketio.emit(",
            "            \"task_created\", {",
            "                \"task_id\": task.id,",
            "                \"job_id\": task.job_id,",
            "                \"collaboration_id\": collaboration_id,",
            "                \"init_org_id\": init_org.id,",
            "            }, room=f\"collaboration_{collaboration_id}\", namespace='/tasks'",
            "        )",
            "",
            "        # if the 'master'-flag is set to true the (master) task is executed on",
            "        # a node in the collaboration from the organization to which the user",
            "        # belongs. If also organization_ids are supplied, then these are",
            "        # ignored.",
            "        # TODO in this case the user *must* have a node attached to this",
            "        # collaboration",
            "        # TODO this does not make a lot of sense as the `organizations` input",
            "        # should only contain the organization where the master container",
            "        # shoudl run",
            "        assign_orgs = []",
            "        if data.get(\"master\", False) and g.user:",
            "            for org in organizations_json_list:",
            "                if org['id'] == g.user.organization_id:",
            "                    assign_orgs = [org]",
            "                    break",
            "            if not assign_orgs:",
            "                return {'msg': 'You\\'re trying to create a master task. '",
            "                        'However you do not have a node yourself in this '",
            "                        'collaboration!'}, HTTPStatus.BAD_REQUEST",
            "        else:",
            "            assign_orgs = organizations_json_list",
            "",
            "        # now we need to create runs for the nodes to fill. Each node",
            "        # receives their instructions from an algorithm run record, not from",
            "        # the task itself",
            "        log.debug(f\"Assigning task to {len(assign_orgs)} nodes.\")",
            "        for org in assign_orgs:",
            "            organization = db.Organization.get(org['id'])",
            "            log.debug(f\"Assigning task to '{organization.name}'.\")",
            "            input_ = org.get('input')",
            "            # FIXME: legacy input from the client, could be removed at some",
            "            # point",
            "            if isinstance(input_, dict):",
            "                input_ = json.dumps(input_).encode(STRING_ENCODING)",
            "            # Create run",
            "            run = db.Run(",
            "                task=task,",
            "                organization=organization,",
            "                input=input_,",
            "                status=TaskStatus.PENDING",
            "            )",
            "            run.save()",
            "",
            "        # notify nodes a new task available (only to online nodes), nodes that",
            "        # are offline will receive this task on sign in.",
            "        self.socketio.emit('new_task', task.id, namespace='/tasks',",
            "                           room=f'collaboration_{task.collaboration_id}')",
            "",
            "        # add some logging",
            "        log.info(f\"New task for collaboration '{task.collaboration.name}'\")",
            "        if g.user:",
            "            log.debug(f\" created by: '{g.user.username}'\")",
            "        else:",
            "            log.debug(f\" created by container on node_id=\"",
            "                      f\"{g.container['node_id']}\"",
            "                      f\" for (master) task_id={g.container['task_id']}\")",
            "",
            "        log.debug(f\" url: '{url_for('task_with_id', id=task.id)}'\")",
            "        log.debug(f\" name: '{task.name}'\")",
            "        log.debug(f\" image: '{task.image}'\")",
            "",
            "        return task_schema.dump(task, many=False), HTTPStatus.CREATED",
            "",
            "    @staticmethod",
            "    def __verify_container_permissions(container, image, collaboration_id):",
            "        \"\"\"Validates that the container is allowed to create the task.\"\"\"",
            "",
            "        # check that the image is allowed: algorithm containers can only",
            "        # create tasks with the same image",
            "        if not image.endswith(container[\"image\"]):",
            "            log.warning((f\"Container from node={container['node_id']} \"",
            "                        f\"attempts to post a task using illegal image!?\"))",
            "            log.warning(f\"  task image: {image}\")",
            "            log.warning(f\"  container image: {container['image']}\")",
            "            return False",
            "",
            "        # check master task is not completed yet",
            "        if has_task_finished(db.Task.get(container[\"task_id\"]).status):",
            "            log.warning(",
            "                f\"Container from node={container['node_id']} \"",
            "                f\"attempts to start sub-task for a completed \"",
            "                f\"task={container['task_id']}\"",
            "            )",
            "            return False",
            "",
            "        # check that node id is indeed part of the collaboration",
            "        if not container[\"collaboration_id\"] == collaboration_id:",
            "            log.warning(",
            "                f\"Container attempts to create a task outside \"",
            "                f\"collaboration_id={container['collaboration_id']} in \"",
            "                f\"collaboration_id={collaboration_id}!\"",
            "            )",
            "            return False",
            "",
            "        return True",
            "",
            "    @staticmethod",
            "    def _node_doesnt_allow_user_task(",
            "        node_configs: list[db.NodeConfig]",
            "    ) -> bool:",
            "        \"\"\"",
            "        Checks if the node allows user to create task.",
            "",
            "        Parameters",
            "        ----------",
            "        node_configs : list[db.NodeConfig]",
            "            List of node configurations.",
            "",
            "        Returns",
            "        -------",
            "        bool",
            "            True if the node doesn't allow the user to create task.",
            "        \"\"\"",
            "        has_limitations = False",
            "        for config_option in node_configs:",
            "            if config_option.key == \"allowed_users\":",
            "                has_limitations = True",
            "                # TODO expand when we allow also usernames, like orgs below",
            "                if g.user.id == int(config_option.value):",
            "                    return False",
            "            elif config_option.key == \"allowed_orgs\":",
            "                has_limitations = True",
            "                if config_option.value.isdigit():",
            "                    if g.user.organization_id == int(config_option.value):",
            "                        return False",
            "                else:",
            "                    org = db.Organization.get_by_name(config_option.value)",
            "                    if org and g.user.organization_id == org.id:",
            "                        return False",
            "        return has_limitations",
            "",
            "",
            "class Task(TaskBase):",
            "    \"\"\"Resource for /api/task\"\"\"",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self, id):",
            "        \"\"\"Get task",
            "        ---",
            "        description: >-",
            "          Returns the task specified by the id.",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|View|\u274c|\u274c|View any task|\\n",
            "          |Task|Organization|View|\u2705|\u2705|View any task in your organization|",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Task id",
            "            required: true",
            "          - in: query",
            "            name: include",
            "            schema:",
            "              type: string",
            "            description: Include 'results' to include the task's results.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Task not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "        task = db.Task.get(id)",
            "        if not task:",
            "            return {\"msg\": f\"task id={id} is not found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # determine the organization to which the auth belongs",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        # obtain schema",
            "        schema = task_result_schema if request.args.get('include') == \\",
            "            'results' else task_schema",
            "",
            "        # check permissions",
            "        if not self.r.v_glo.can():",
            "            org_ids = [org.id for org in task.collaboration.organizations]",
            "            if not (self.r.v_org.can() and auth_org.id in org_ids):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return schema.dump(task, many=False), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\"Remove task",
            "        ---",
            "        description: >-",
            "          Remove tasks and their runs.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|Delete|\u274c|\u274c|Delete a task|\\n",
            "          |Task|Organization|Delete|\u274c|\u274c|Delete a task from a collaboration",
            "          in which your organization participates|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Task id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Task not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "",
            "        task = db.Task.get(id)",
            "        if not task:",
            "            return {\"msg\": f\"task id={id} not found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # validate permissions",
            "        if not self.r.d_glo.can():",
            "            orgs = task.collaboration.organizations",
            "            if not (self.r.d_org.can() and g.user.organization in orgs):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # kill the task if it is still running",
            "        if not has_task_finished(task.status):",
            "            kill_task(task, self.socketio)",
            "",
            "        # retrieve runs that belong to this task",
            "        log.info(f'Removing task id={task.id}')",
            "        for run in task.runs:",
            "            log.info(f\" Removing run id={run.id}\")",
            "            run.delete()",
            "",
            "        # permissions ok, delete...",
            "        task.delete()",
            "",
            "        return {\"msg\": f\"task id={id} and its algorithm run data have been \"",
            "                       \"successfully deleted\"}, HTTPStatus.OK"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "import json",
            "",
            "from flask import g, request, url_for",
            "from flask_restful import Api",
            "from http import HTTPStatus",
            "from sqlalchemy import desc",
            "",
            "from vantage6.common.globals import STRING_ENCODING",
            "from vantage6.common.task_status import TaskStatus, has_task_finished",
            "from vantage6.server import db",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    PermissionManager,",
            "    Operation as P",
            ")",
            "from vantage6.server.resource import only_for, ServicesResources, with_user",
            "from vantage6.server.resource.common._schema import (",
            "    TaskSchema,",
            "    TaskIncludedSchema,",
            ")",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.resource.event import kill_task",
            "",
            "",
            "module_name = __name__.split('.')[-1]",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the task resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Tasks,",
            "        path,",
            "        endpoint='task_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        Task,",
            "        path + '/<int:id>',",
            "        endpoint='task_with_id',",
            "        methods=('GET', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# -----------------------------------------------------------------------------",
            "# Permissions",
            "# -----------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "",
            "    add(scope=S.GLOBAL, operation=P.VIEW,",
            "        description=\"view any task\")",
            "    add(scope=S.ORGANIZATION, operation=P.VIEW, assign_to_container=True,",
            "        assign_to_node=True, description=\"view tasks of your organization\")",
            "",
            "    add(scope=S.GLOBAL, operation=P.CREATE, description=\"create a new task\")",
            "    add(scope=S.ORGANIZATION, operation=P.CREATE,",
            "        description=(",
            "            \"create a new task for collaborations in which your organization \"",
            "            \"participates with\"",
            "        ))",
            "",
            "    add(scope=S.GLOBAL, operation=P.DELETE,",
            "        description=\"delete a task\")",
            "    add(scope=S.ORGANIZATION, operation=P.DELETE,",
            "        description=(",
            "            \"delete a task from a collaboration in which your organization \"",
            "            \"participates with\"",
            "        ))",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "task_schema = TaskSchema()",
            "task_result_schema = TaskIncludedSchema()",
            "",
            "",
            "class TaskBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Tasks(TaskBase):",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self):",
            "        \"\"\"List tasks",
            "        ---",
            "        description: >-",
            "          Returns a list of tasks.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|View|\u274c|\u274c|View any task|\\n",
            "          |Task|Organization|View|\u2705|\u2705|View any task in your organization|",
            "          \\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: init_org_id",
            "            schema:",
            "              type: int",
            "            description: The organization id of the origin of the request",
            "          - in: query",
            "            name: init_user_id",
            "            schema:",
            "              type: int",
            "            description: The user id of the user that started the task",
            "          - in: query",
            "            name: collaboration_id",
            "            schema:",
            "              type: int",
            "            description: The collaboration id to which the task belongs",
            "          - in: query",
            "            name: is_user_created",
            "            schema:",
            "              type: int",
            "            description: >-",
            "              If larger than 0, returns tasks created by a user (top-level",
            "              tasks). If equal to 0, returns subtask created by an algorithm.",
            "              If not specified, both are returned.",
            "          - in: query",
            "            name: image",
            "            schema:",
            "              type: str",
            "            description: >-",
            "              (Docker) image name which is used in the task. Name to match",
            "              with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: parent_id",
            "            schema:",
            "              type: int",
            "            description: The id of the parent task",
            "          - in: query",
            "            name: job_id",
            "            schema:",
            "              type: int",
            "            description: The run id that belongs to the task",
            "          - in: query",
            "            name: name",
            "            schema:",
            "              type: str",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: description",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Description to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: database",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Database description to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: run_id",
            "            schema:",
            "              type: int",
            "            description: A run id that belongs to the task",
            "          - in: query",
            "            name: include",
            "            schema:",
            "              type: array",
            "              items:",
            "                type: string",
            "            description: Include 'results' to get task results.",
            "          - in: query",
            "            name: status",
            "            schema:",
            "              type: string",
            "            description: Filter by task status, e.g. 'active' for active",
            "              tasks, 'completed' for finished or 'crashed' for failed tasks.",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Non-allowed parameter values",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "        q = g.session.query(db.Task)",
            "        args = request.args",
            "",
            "        # obtain organization id",
            "        auth_org_id = self.obtain_organization_id()",
            "",
            "        # check permissions and apply filter if neccassary",
            "        if not self.r.v_glo.can():",
            "            if self.r.v_org.can():",
            "                q = q.join(db.Collaboration).join(db.Organization)\\",
            "                    .filter(db.Collaboration.organizations.any(id=auth_org_id))",
            "            else:",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # filter based on arguments",
            "        for param in ['init_org_id', 'init_user_id', 'collaboration_id',",
            "                      'parent_id', 'job_id']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.Task, param) == args[param])",
            "        for param in ['name', 'image', 'description', 'status']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.Task, param).like(args[param]))",
            "        if 'run_id' in args:",
            "            q = q.join(db.Run).filter(db.Run.id == args['run_id'])",
            "        if 'database' in args:",
            "            q = q.join(db.TaskDatabase)\\",
            "                 .filter(db.TaskDatabase.database == args['database'])",
            "        if 'is_user_created' in args:",
            "            try:",
            "                user_created = int(args['is_user_created'])",
            "                if user_created == 0:",
            "                    q = q.filter(db.Task.parent_id.isnot(None))",
            "                else:",
            "                    q = q.filter(db.Task.parent_id.is_(None))",
            "            except ValueError:",
            "                return {\"msg\": (",
            "                    \"Invalid value for 'is_user_created' provided: \"",
            "                    f\"'{args['is_user_created']}'. Should be an integer.\"",
            "                )}, HTTPStatus.BAD_REQUEST",
            "",
            "        q = q.order_by(desc(db.Task.id))",
            "        # paginate tasks",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # serialization schema",
            "        schema = task_result_schema if self.is_included('results') else\\",
            "            task_schema",
            "",
            "        return self.response(page, schema)",
            "",
            "    @only_for((\"user\", \"container\"))",
            "    def post(self):",
            "        \"\"\"Adds new computation task",
            "        ---",
            "        description: >-",
            "          Creates a new task within a collaboration. If no `organization_ids`",
            "          are given the task is send to all organizations within the",
            "          collaboration. The endpoint can be accessed by both a `User` and",
            "          `Container`.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|Create|\u274c|\u274c|Create a new task|\\n",
            "          |Task|Organization|Create|\u274c|\u2705|Create a new task for a specific",
            "          collaboration in which your organization participates|\\n",
            "",
            "          ## Accessed as `User`\\n",
            "          This endpoint is accessible to users. A new `job_id` is",
            "          created when a user creates a task. The user needs to be within an",
            "          organization that is part of the collaboration to which the task is",
            "          posted.\\n",
            "",
            "          ## Accessed as `Container`\\n",
            "          When this endpoint is accessed by an algorithm container, it is",
            "          considered to be a child-task of the container, and will get the",
            "          `job_id` from the initial task. Containers have limited permissions",
            "          to create tasks: they are only allowed to create tasks in the same",
            "          collaboration using the same image.\\n",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                $ref: '#/components/schemas/Task'",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: Supplied organizations are not in the supplied",
            "              collaboration, or not all required nodes are registered, or you",
            "              are not in the collaboration yourself",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Collaboration with `collaboration_id` not found",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "        data = request.get_json()",
            "        collaboration_id = data.get('collaboration_id')",
            "        collaboration = db.Collaboration.get(collaboration_id)",
            "",
            "        if not collaboration:",
            "            return {\"msg\": f\"Collaboration id={collaboration_id} not found!\"},\\",
            "                   HTTPStatus.NOT_FOUND",
            "",
            "        organizations_json_list = data.get('organizations')",
            "        org_ids = [org.get(\"id\") for org in organizations_json_list]",
            "        db_ids = collaboration.get_organization_ids()",
            "",
            "        # Check that all organization ids are within the collaboration, this",
            "        # also ensures us that the organizations exist",
            "        if not set(org_ids).issubset(db_ids):",
            "            return {\"msg\": (",
            "                \"At least one of the supplied organizations in not within \"",
            "                \"the collaboration.\"",
            "            )}, HTTPStatus.BAD_REQUEST",
            "",
            "        # check if all the organizations have a registered node",
            "        nodes = g.session.query(db.Node)\\",
            "            .filter(db.Node.organization_id.in_(org_ids))\\",
            "            .filter(db.Node.collaboration_id == collaboration_id)\\",
            "            .all()",
            "        if len(nodes) < len(org_ids):",
            "            present_nodes = [node.organization_id for node in nodes]",
            "            missing = [str(id) for id in org_ids if id not in present_nodes]",
            "            return {\"msg\": (",
            "                \"Cannot create this task because there are no nodes registered\"",
            "                f\" for the following organization(s): {', '.join(missing)}.\"",
            "            )}, HTTPStatus.BAD_REQUEST",
            "        # check if any of the nodes that are offline shared their configuration",
            "        # info and if this prevents this user from creating this task",
            "        if g.user:",
            "            for node in nodes:",
            "                if self._node_doesnt_allow_user_task(node.config):",
            "                    return {\"msg\": (",
            "                        \"Cannot create this task because one of the nodes that\"",
            "                        \" you are trying to send this task to does not allow \"",
            "                        \"you to create tasks.\"",
            "                    )}, HTTPStatus.BAD_REQUEST",
            "",
            "        # figure out the initiating organization of the task",
            "        if g.user:",
            "            init_org = g.user.organization",
            "        else:  # g.container:",
            "            init_org = db.Node.get(g.container[\"node_id\"]).organization",
            "",
            "        # check if the initiating organization is part of the collaboration",
            "        if init_org not in collaboration.organizations:",
            "            return {",
            "                \"msg\": \"You can only create tasks for collaborations \"",
            "                       \"you are participating in!\"",
            "            }, HTTPStatus.UNAUTHORIZED",
            "",
            "        # Create the new task in the database",
            "        image = data.get('image', '')",
            "",
            "        # verify permissions",
            "        if g.user:",
            "            if not self.r.c_glo.can():",
            "                c_orgs = collaboration.organizations",
            "                if not (self.r.c_org.can() and g.user.organization in c_orgs):",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "",
            "        elif g.container:",
            "            # verify that the container has permissions to create the task",
            "            if not self.__verify_container_permissions(g.container, image,",
            "                                                       collaboration_id):",
            "                return {\"msg\": \"Container-token is not valid\"}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "",
            "        # permissions ok, create task record and TaskDatabase records",
            "        task = db.Task(collaboration=collaboration, name=data.get('name', ''),",
            "                       description=data.get('description', ''), image=image,",
            "                       init_org=init_org)",
            "",
            "        # create job_id. Users can only create top-level -tasks (they will not",
            "        # have sub-tasks). Therefore, always create a new job_id. Tasks created",
            "        # by containers are always sub-tasks",
            "        if g.user:",
            "            task.job_id = task.next_job_id()",
            "            task.init_user_id = g.user.id",
            "            log.debug(f\"New job_id {task.job_id}\")",
            "        elif g.container:",
            "            task.parent_id = g.container[\"task_id\"]",
            "            parent = db.Task.get(g.container[\"task_id\"])",
            "            task.job_id = parent.job_id",
            "            task.init_user_id = parent.init_user_id",
            "            log.debug(f\"Sub task from parent_id={task.parent_id}\")",
            "",
            "        # ok commit session...",
            "        task.save()",
            "",
            "        # save the databases that the task uses",
            "        databases = data.get('databases', ['default'])",
            "        if not isinstance(databases, list):",
            "            databases = [databases]",
            "        for database in databases:",
            "            db_record = db.TaskDatabase(task_id=task.id, database=database)",
            "            db_record.save()",
            "",
            "        # send socket event that task has been created",
            "        self.socketio.emit(",
            "            \"task_created\", {",
            "                \"task_id\": task.id,",
            "                \"job_id\": task.job_id,",
            "                \"collaboration_id\": collaboration_id,",
            "                \"init_org_id\": init_org.id,",
            "            }, room=f\"collaboration_{collaboration_id}\", namespace='/tasks'",
            "        )",
            "",
            "        # if the 'master'-flag is set to true the (master) task is executed on",
            "        # a node in the collaboration from the organization to which the user",
            "        # belongs. If also organization_ids are supplied, then these are",
            "        # ignored.",
            "        # TODO in this case the user *must* have a node attached to this",
            "        # collaboration",
            "        # TODO this does not make a lot of sense as the `organizations` input",
            "        # should only contain the organization where the master container",
            "        # shoudl run",
            "        assign_orgs = []",
            "        if data.get(\"master\", False) and g.user:",
            "            for org in organizations_json_list:",
            "                if org['id'] == g.user.organization_id:",
            "                    assign_orgs = [org]",
            "                    break",
            "            if not assign_orgs:",
            "                return {'msg': 'You\\'re trying to create a master task. '",
            "                        'However you do not have a node yourself in this '",
            "                        'collaboration!'}, HTTPStatus.BAD_REQUEST",
            "        else:",
            "            assign_orgs = organizations_json_list",
            "",
            "        # now we need to create runs for the nodes to fill. Each node",
            "        # receives their instructions from an algorithm run record, not from",
            "        # the task itself",
            "        log.debug(f\"Assigning task to {len(assign_orgs)} nodes.\")",
            "        for org in assign_orgs:",
            "            organization = db.Organization.get(org['id'])",
            "            log.debug(f\"Assigning task to '{organization.name}'.\")",
            "            input_ = org.get('input')",
            "            # FIXME: legacy input from the client, could be removed at some",
            "            # point",
            "            if isinstance(input_, dict):",
            "                input_ = json.dumps(input_).encode(STRING_ENCODING)",
            "            # Create run",
            "            run = db.Run(",
            "                task=task,",
            "                organization=organization,",
            "                input=input_,",
            "                status=TaskStatus.PENDING",
            "            )",
            "            run.save()",
            "",
            "        # notify nodes a new task available (only to online nodes), nodes that",
            "        # are offline will receive this task on sign in.",
            "        self.socketio.emit('new_task', task.id, namespace='/tasks',",
            "                           room=f'collaboration_{task.collaboration_id}')",
            "",
            "        # add some logging",
            "        log.info(f\"New task for collaboration '{task.collaboration.name}'\")",
            "        if g.user:",
            "            log.debug(f\" created by: '{g.user.username}'\")",
            "        else:",
            "            log.debug(f\" created by container on node_id=\"",
            "                      f\"{g.container['node_id']}\"",
            "                      f\" for (master) task_id={g.container['task_id']}\")",
            "",
            "        log.debug(f\" url: '{url_for('task_with_id', id=task.id)}'\")",
            "        log.debug(f\" name: '{task.name}'\")",
            "        log.debug(f\" image: '{task.image}'\")",
            "",
            "        return task_schema.dump(task, many=False), HTTPStatus.CREATED",
            "",
            "    @staticmethod",
            "    def __verify_container_permissions(container, image, collaboration_id):",
            "        \"\"\"Validates that the container is allowed to create the task.\"\"\"",
            "",
            "        # check that the image is allowed: algorithm containers can only",
            "        # create tasks with the same image",
            "        if not image.endswith(container[\"image\"]):",
            "            log.warning((f\"Container from node={container['node_id']} \"",
            "                        f\"attempts to post a task using illegal image!?\"))",
            "            log.warning(f\"  task image: {image}\")",
            "            log.warning(f\"  container image: {container['image']}\")",
            "            return False",
            "",
            "        # check master task is not completed yet",
            "        if has_task_finished(db.Task.get(container[\"task_id\"]).status):",
            "            log.warning(",
            "                f\"Container from node={container['node_id']} \"",
            "                f\"attempts to start sub-task for a completed \"",
            "                f\"task={container['task_id']}\"",
            "            )",
            "            return False",
            "",
            "        # check that node id is indeed part of the collaboration",
            "        if not container[\"collaboration_id\"] == collaboration_id:",
            "            log.warning(",
            "                f\"Container attempts to create a task outside \"",
            "                f\"collaboration_id={container['collaboration_id']} in \"",
            "                f\"collaboration_id={collaboration_id}!\"",
            "            )",
            "            return False",
            "",
            "        return True",
            "",
            "    @staticmethod",
            "    def _node_doesnt_allow_user_task(",
            "        node_configs: list[db.NodeConfig]",
            "    ) -> bool:",
            "        \"\"\"",
            "        Checks if the node allows user to create task.",
            "",
            "        Parameters",
            "        ----------",
            "        node_configs : list[db.NodeConfig]",
            "            List of node configurations.",
            "",
            "        Returns",
            "        -------",
            "        bool",
            "            True if the node doesn't allow the user to create task.",
            "        \"\"\"",
            "        has_limitations = False",
            "        for config_option in node_configs:",
            "            if config_option.key == \"allowed_users\":",
            "                has_limitations = True",
            "                # TODO expand when we allow also usernames, like orgs below",
            "                if g.user.id == int(config_option.value):",
            "                    return False",
            "            elif config_option.key == \"allowed_orgs\":",
            "                has_limitations = True",
            "                if config_option.value.isdigit():",
            "                    if g.user.organization_id == int(config_option.value):",
            "                        return False",
            "                else:",
            "                    org = db.Organization.get_by_name(config_option.value)",
            "                    if org and g.user.organization_id == org.id:",
            "                        return False",
            "        return has_limitations",
            "",
            "",
            "class Task(TaskBase):",
            "    \"\"\"Resource for /api/task\"\"\"",
            "",
            "    @only_for((\"user\", \"node\", \"container\"))",
            "    def get(self, id):",
            "        \"\"\"Get task",
            "        ---",
            "        description: >-",
            "          Returns the task specified by the id.",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|View|\u274c|\u274c|View any task|\\n",
            "          |Task|Organization|View|\u2705|\u2705|View any task in your organization|",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Task id",
            "            required: true",
            "          - in: query",
            "            name: include",
            "            schema:",
            "              type: string",
            "            description: Include 'results' to include the task's results.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Task not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "        task = db.Task.get(id)",
            "        if not task:",
            "            return {\"msg\": f\"task id={id} is not found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # determine the organization to which the auth belongs",
            "        auth_org = self.obtain_auth_organization()",
            "",
            "        # obtain schema",
            "        schema = task_result_schema if request.args.get('include') == \\",
            "            'results' else task_schema",
            "",
            "        # check permissions",
            "        if not self.r.v_glo.can():",
            "            org_ids = [org.id for org in task.collaboration.organizations]",
            "            if not (self.r.v_org.can() and auth_org.id in org_ids):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        return schema.dump(task, many=False), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\"Remove task",
            "        ---",
            "        description: >-",
            "          Remove tasks and their runs.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |Task|Global|Delete|\u274c|\u274c|Delete a task|\\n",
            "          |Task|Organization|Delete|\u274c|\u274c|Delete a task from a collaboration",
            "          in which your organization participates|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: Task id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: Task not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"Task\"]",
            "        \"\"\"",
            "",
            "        task = db.Task.get(id)",
            "        if not task:",
            "            return {\"msg\": f\"task id={id} not found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        # validate permissions",
            "        if not self.r.d_glo.can():",
            "            orgs = task.collaboration.organizations",
            "            if not (self.r.d_org.can() and g.user.organization in orgs):",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # kill the task if it is still running",
            "        if not has_task_finished(task.status):",
            "            kill_task(task, self.socketio)",
            "",
            "        # retrieve runs that belong to this task",
            "        log.info(f'Removing task id={task.id}')",
            "        for run in task.runs:",
            "            log.info(f\" Removing run id={run.id}\")",
            "            run.delete()",
            "",
            "        # delete child tasks",
            "        for child_task in task.children:",
            "            log.info(f\" Removing child task id={child_task.id}\")",
            "            child_task.delete()",
            "",
            "        # permissions ok, delete...",
            "        task.delete()",
            "",
            "        return {\"msg\": f\"task id={id} and its algorithm run data have been \"",
            "                       \"successfully deleted\"}, HTTPStatus.OK"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "django.contrib.auth.forms.AdminPasswordChangeForm"
        ]
    },
    "vantage6-server/vantage6/server/resource/user.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 722,
                "afterPatchRowNumber": 722,
                "PatchRowcode": "               type: integer"
            },
            "1": {
                "beforePatchRowNumber": 723,
                "afterPatchRowNumber": 723,
                "PatchRowcode": "             description: User id"
            },
            "2": {
                "beforePatchRowNumber": 724,
                "afterPatchRowNumber": 724,
                "PatchRowcode": "             required: true"
            },
            "3": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 725,
                "PatchRowcode": "+         - in: query"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 726,
                "PatchRowcode": "+            name: delete_dependents"
            },
            "5": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 727,
                "PatchRowcode": "+            schema:"
            },
            "6": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 728,
                "PatchRowcode": "+              type: boolean"
            },
            "7": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 729,
                "PatchRowcode": "+            description: If set to true, the user will be deleted along with"
            },
            "8": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 730,
                "PatchRowcode": "+              all tasks they created (default=False)"
            },
            "9": {
                "beforePatchRowNumber": 725,
                "afterPatchRowNumber": 731,
                "PatchRowcode": " "
            },
            "10": {
                "beforePatchRowNumber": 726,
                "afterPatchRowNumber": 732,
                "PatchRowcode": "         responses:"
            },
            "11": {
                "beforePatchRowNumber": 727,
                "afterPatchRowNumber": 733,
                "PatchRowcode": "           200:"
            },
            "12": {
                "beforePatchRowNumber": 748,
                "afterPatchRowNumber": 754,
                "PatchRowcode": "                     return {'msg': 'You lack the permission to do that!'}, \\"
            },
            "13": {
                "beforePatchRowNumber": 749,
                "afterPatchRowNumber": 755,
                "PatchRowcode": "                         HTTPStatus.UNAUTHORIZED"
            },
            "14": {
                "beforePatchRowNumber": 750,
                "afterPatchRowNumber": 756,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 757,
                "PatchRowcode": "+        # check if user created any tasks"
            },
            "16": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 758,
                "PatchRowcode": "+        if user.created_tasks:"
            },
            "17": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 759,
                "PatchRowcode": "+            params = request.args"
            },
            "18": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 760,
                "PatchRowcode": "+            if not params.get('delete_dependents', False):"
            },
            "19": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 761,
                "PatchRowcode": "+                return {"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 762,
                "PatchRowcode": "+                    \"msg\": f\"User has created {len(user.created_tasks)} tasks.\""
            },
            "21": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 763,
                "PatchRowcode": "+                    \" Please delete those first, or set the \""
            },
            "22": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 764,
                "PatchRowcode": "+                    \"`delete_dependents` parameter to true to delete them \""
            },
            "23": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 765,
                "PatchRowcode": "+                    \"automatically together with this user.\""
            },
            "24": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 766,
                "PatchRowcode": "+                }, HTTPStatus.BAD_REQUEST"
            },
            "25": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 767,
                "PatchRowcode": "+            else:"
            },
            "26": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 768,
                "PatchRowcode": "+                log.warn(f\"Deleting {len(user.created_tasks)} tasks created by\""
            },
            "27": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 769,
                "PatchRowcode": "+                         f\" user id={id}\")"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 770,
                "PatchRowcode": "+                for task in user.created_tasks:"
            },
            "29": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 771,
                "PatchRowcode": "+                    task.delete()"
            },
            "30": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 772,
                "PatchRowcode": "+"
            },
            "31": {
                "beforePatchRowNumber": 751,
                "afterPatchRowNumber": 773,
                "PatchRowcode": "         user.delete()"
            },
            "32": {
                "beforePatchRowNumber": 752,
                "afterPatchRowNumber": 774,
                "PatchRowcode": "         log.info(f\"user id={id} is removed from the database\")"
            },
            "33": {
                "beforePatchRowNumber": 753,
                "afterPatchRowNumber": 775,
                "PatchRowcode": "         return {\"msg\": f\"user id={id} is removed from the database\"}, \\"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "import sqlalchemy.exc",
            "",
            "from http import HTTPStatus",
            "from flask import g, request",
            "from flask_restful import reqparse, Api",
            "",
            "from vantage6.common import logger_name",
            "from vantage6.server import db",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    Operation as P,",
            "    PermissionManager",
            ")",
            "from vantage6.server.resource import (",
            "    with_user,",
            "    ServicesResources",
            ")",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.resource.common._schema import UserSchema",
            "",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the user resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Users,",
            "        path,",
            "        endpoint='user_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        User,",
            "        path + '/<int:id>',",
            "        endpoint='user_with_id',",
            "        methods=('GET', 'PATCH', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Permissions",
            "# ------------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "    add(S.GLOBAL, P.VIEW,",
            "        description='View any user')",
            "    add(S.ORGANIZATION, P.VIEW,",
            "        description='View users from your organization')",
            "    add(S.GLOBAL, P.CREATE,",
            "        description='Create a new user for any organization')",
            "    add(S.ORGANIZATION, P.CREATE,",
            "        description='Create a new user for your organization')",
            "    add(S.GLOBAL, P.EDIT,",
            "        description='Edit any user')",
            "    add(S.ORGANIZATION, P.EDIT,",
            "        description='Edit users from your organization')",
            "    add(S.OWN, P.EDIT,",
            "        description='Edit your own info')",
            "    add(S.GLOBAL, P.DELETE,",
            "        description='Delete any user')",
            "    add(S.ORGANIZATION, P.DELETE,",
            "        description='Delete users from your organization')",
            "    add(S.OWN, P.DELETE,",
            "        description='Delete your own account')",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "user_schema = UserSchema()",
            "",
            "",
            "class UserBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Users(UserBase):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"List users",
            "        ---",
            "        description: >-",
            "            Returns a list of users that you are allowed to see.",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |User|Global|View|\u274c|\u274c|View any user details|\\n",
            "            |User|Organization|View|\u274c|\u274c|View users from your organization|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: username",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: organization_id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "          - in: query",
            "            name: firstname",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: lastname",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: email",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Email to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: role_id",
            "            schema:",
            "              type: integer",
            "            description: Role that is assigned to user",
            "          - in: query",
            "            name: rule_id",
            "            schema:",
            "              type: integer",
            "            description: Rule that is assigned to user",
            "          - in: query",
            "            name: last_seen_from",
            "            schema:",
            "              type: date (yyyy-mm-dd)",
            "            description: Show only users seen since this date",
            "          - in: query",
            "            name: last_seen_till",
            "            schema:",
            "              type: date (yyyy-mm-dd)",
            "            description: Show only users last seen before this date",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        args = request.args",
            "        q = g.session.query(db.User)",
            "",
            "        # filter by any field of this endpoint",
            "        for param in ['username', 'firstname', 'lastname', 'email']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.User, param).like(args[param]))",
            "        if 'organization_id' in args:",
            "            q = q.filter(db.User.organization_id == args['organization_id'])",
            "        if 'last_seen_till' in args:",
            "            q = q.filter(db.User.last_seen <= args['last_seen_till'])",
            "        if 'last_seen_from' in args:",
            "            q = q.filter(db.User.last_seen >= args['last_seen_from'])",
            "",
            "        # find users with a particulare role or rule assigned",
            "        if 'role_id' in args:",
            "            q = q.join(db.Permission).join(db.Role)\\",
            "                 .filter(db.Role.id == args['role_id'])",
            "        if 'rule_id' in args:",
            "            q = q.join(db.UserPermission).join(db.Rule)\\",
            "                 .filter(db.Rule.id == args['rule_id'])",
            "",
            "        # check permissions and apply filter if neccessary",
            "        if not self.r.v_glo.can():",
            "            if self.r.v_org.can():",
            "                q = q.filter(db.User.organization_id == g.user.organization_id)",
            "            else:",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate results",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # model serialization",
            "        return self.response(page, user_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\"Create user",
            "        ---",
            "        description: >-",
            "          Creates new user from the request data to the users organization.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |User|Global|Create|\u274c|\u274c|Create a new user|\\n",
            "          |User|Organization|Create|\u274c|\u274c|Create a new user as part of your",
            "          organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  username:",
            "                    type: string",
            "                    description: Unique username",
            "                  firstname:",
            "                    type: string",
            "                    description: First name",
            "                  lastname:",
            "                    type: string",
            "                    description: Last name",
            "                  password:",
            "                    type: string",
            "                    description: Password",
            "                  organization_id:",
            "                    type: integer",
            "                    description: Organization id to which user is assigned",
            "                  roles:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: User's roles",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: Extra rules for the user on top of the roles",
            "                  email:",
            "                    type: string",
            "                    description: Email address",
            "",
            "        responses:",
            "          201:",
            "            description: Ok",
            "          400:",
            "            description: Username or email already exists",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Organization id does not exist",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument(\"username\", type=str, required=True)",
            "        parser.add_argument(\"firstname\", type=str, required=True)",
            "        parser.add_argument(\"lastname\", type=str, required=True)",
            "        # TODO password should be send to the email, rather than setting it",
            "        parser.add_argument(\"password\", type=str, required=True)",
            "        parser.add_argument(\"email\", type=str, required=True)",
            "        parser.add_argument(\"organization_id\", type=int, required=False,",
            "                            help=\"This is only used if you're root\")",
            "        parser.add_argument(\"roles\", type=int, action=\"append\", required=False)",
            "        parser.add_argument(\"rules\", type=int, action=\"append\", required=False)",
            "        data = parser.parse_args()",
            "",
            "        # check unique constraints",
            "        if db.User.username_exists(data[\"username\"]):",
            "            return {\"msg\": \"username already exists.\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        if db.User.exists(\"email\", data[\"email\"]):",
            "            return {\"msg\": \"email already exists.\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        # check if the organization has been provided, if this is the case the",
            "        # user needs global permissions in case it is not their own",
            "        organization_id = g.user.organization_id",
            "        if data['organization_id']:",
            "            if data['organization_id'] != organization_id:",
            "                if self.r.c_glo.can():",
            "                    # check if organization exists",
            "                    org = db.Organization.get(data['organization_id'])",
            "                    if not org:",
            "                        return {'msg': \"Organization does not exist.\"}, \\",
            "                            HTTPStatus.NOT_FOUND",
            "                else:  # not-root user cant create users for other organization",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "            organization_id = data['organization_id']",
            "",
            "        # check that user is allowed to create users",
            "        if not (self.r.c_glo.can() or self.r.c_org.can()):",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # process the required roles. It is only possible to assign roles with",
            "        # rules that you already have permission to. This way we ensure you can",
            "        # never extend your power on your own.",
            "        potential_roles = data.get(\"roles\")",
            "        roles = []",
            "        if potential_roles:",
            "            for role in potential_roles:",
            "                role_ = db.Role.get(role)",
            "                if role_:",
            "                    denied = self.permissions.check_user_rules(role_.rules)",
            "                    if denied:",
            "                        return denied, HTTPStatus.UNAUTHORIZED",
            "                    roles.append(role_)",
            "",
            "                    # validate that the assigned role is either a general role",
            "                    # or a role pertaining to that organization",
            "                    if (role_.organization and",
            "                            role_.organization.id != organization_id):",
            "                        return {'msg': (",
            "                            \"You can't assign that role as the role belongs to\"",
            "                            \" a different organization than the user.\"",
            "                        )}, HTTPStatus.UNAUTHORIZED",
            "",
            "        # You can only assign rules that you already have to others.",
            "        potential_rules = data[\"rules\"]",
            "        rules = []",
            "        if potential_rules:",
            "            rules = [db.Rule.get(rule) for rule in potential_rules",
            "                     if db.Rule.get(rule)]",
            "            denied = self.permissions.check_user_rules(rules)",
            "            if denied:",
            "                return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        # Ok, looks like we got most of the security hazards out of the way",
            "        user = db.User(",
            "            username=data[\"username\"],",
            "            firstname=data[\"firstname\"],",
            "            lastname=data[\"lastname\"],",
            "            roles=roles,",
            "            rules=rules,",
            "            organization_id=organization_id,",
            "            email=data[\"email\"],",
            "            password=data[\"password\"]",
            "        )",
            "",
            "        # check if the password meets password criteria",
            "        msg = user.set_password(data[\"password\"])",
            "        if msg:",
            "            return {\"msg\": msg}, HTTPStatus.BAD_REQUEST",
            "",
            "        user.save()",
            "",
            "        return user_schema.dump(user), HTTPStatus.CREATED",
            "",
            "",
            "class User(UserBase):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Get user",
            "        ---",
            "        description: >-",
            "            Returns the user specified by the id.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |-- |--|--|--|--|--|\\n",
            "            |User|Global|View|\u274c|\u274c|View any user details|\\n",
            "            |User|Organization|View|\u274c|\u274c|View users from your",
            "            organization|\\n",
            "            |User|Organization|Own|\u274c|\u274c|View details about your own user|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "            - in: path",
            "              name: id",
            "              schema:",
            "                type: integer",
            "              description: User id",
            "              required: true",
            "",
            "        responses:",
            "            200:",
            "                description: Ok",
            "            404:",
            "                description: User not found",
            "            401:",
            "                description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        user = db.User.get(id)",
            "        if not user:",
            "            return {\"msg\": f\"user id={id} is not found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        same_user = g.user.id == user.id",
            "        same_org = g.user.organization.id == user.organization_id",
            "",
            "        # allow user to be returned if:",
            "        # 1. auth can see all users",
            "        # 2. auth can see organization users and user is within organization",
            "        # 3. auth is requesting own user details",
            "        if (",
            "            self.r.v_glo.can() or",
            "            (self.r.v_org.can() and same_org) or",
            "            same_user",
            "        ):",
            "            return user_schema.dump(user, many=False), HTTPStatus.OK",
            "        else:",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "    @with_user",
            "    def patch(self, id):",
            "        \"\"\"Update user",
            "        ---",
            "        description: >-",
            "          Update user information.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |User|Global|Edit|\u274c|\u274c|Edit any user|\\n",
            "          |User|Organization|Edit|\u274c|\u274c|Edit any user in your organization|\\n",
            "          |User|Own|Edit|\u274c|\u274c|Edit your own user account|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  username:",
            "                    type: string",
            "                    description: Unique username",
            "                  firstname:",
            "                    type: string",
            "                    description: First name",
            "                  lastname:",
            "                    type: string",
            "                    description: Last name",
            "                  email:",
            "                    type: string",
            "                    description: Email address",
            "                  roles:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: User's roles",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: Extra rules for the user on top of the roles",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: User id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: User cannot be updated to contents of request body,",
            "              e.g. due to duplicate email address.",
            "          404:",
            "            description: User not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        user = db.User.get(id)",
            "",
            "        if not user:",
            "            return {\"msg\": f\"user id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.e_glo.can():",
            "            if not (self.r.e_org.can() and user.organization ==",
            "                    g.user.organization):",
            "                if not (self.r.e_own.can() and user == g.user):",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument(\"username\", type=str, required=False)",
            "        parser.add_argument(\"firstname\", type=str, required=False)",
            "        parser.add_argument(\"lastname\", type=str, required=False)",
            "        parser.add_argument(\"email\", type=str, required=False)",
            "        data = parser.parse_args()",
            "",
            "        # check if user defined a password, which is deprecated",
            "        # FIXME BvB 22-06-29: with time, this check may be removed. Now it is",
            "        # here for backwards compatibility (if people have scripts using this,",
            "        # this makes them aware something changed)",
            "        request_json = request.get_json()",
            "        if request_json.get(\"password\"):",
            "            return {\"msg\": \"You cannot change your password here!\"}, \\",
            "                HTTPStatus.BAD_REQUEST",
            "",
            "        if data[\"username\"] is not None:",
            "            if data[\"username\"] == '':",
            "                return {",
            "                    \"msg\": \"Empty username is not allowed!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            elif user.username != data[\"username\"]:",
            "                if db.User.exists(\"username\", data[\"username\"]):",
            "                    return {",
            "                        \"msg\": \"User with that username already exists\"",
            "                    }, HTTPStatus.BAD_REQUEST",
            "                elif user.id != g.user.id:",
            "                    return {",
            "                        \"msg\": \"You cannot change the username of another user\"",
            "                    }, HTTPStatus.BAD_REQUEST",
            "            user.username = data[\"username\"]",
            "        if data[\"firstname\"] is not None:",
            "            user.firstname = data[\"firstname\"]",
            "        if data[\"lastname\"] is not None:",
            "            user.lastname = data[\"lastname\"]",
            "        if data[\"email\"] is not None:",
            "            if data[\"email\"] == '':",
            "                return {",
            "                    \"msg\": \"Empty email is not allowed!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            elif (user.email != data[\"email\"] and",
            "                    db.User.exists(\"email\", data[\"email\"])):",
            "                return {",
            "                    \"msg\": \"User with that email already exists.\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            user.email = data[\"email\"]",
            "",
            "        # request parser is awefull with lists",
            "        json_data = request.get_json()",
            "        if 'roles' in json_data:",
            "            # validate that these roles exist",
            "            roles = []",
            "            for role_id in json_data['roles']:",
            "                role = db.Role.get(role_id)",
            "                if not role:",
            "                    return {'msg': f'Role={role_id} can not be found!'}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                roles.append(role)",
            "",
            "            # validate that user is not changing their own roles",
            "            if user == g.user:",
            "                return {'msg': \"You can't changes your own roles!\"}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user can assign these",
            "            for role in roles:",
            "                denied = self.permissions.check_user_rules(role.rules)",
            "                if denied:",
            "                    return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "                # validate that the assigned role is either a general role or a",
            "                # role pertaining to that organization",
            "                if (role.organization and",
            "                        role.organization.id != user.organization_id):",
            "                    return {'msg': (",
            "                        \"You can't assign that role to that user as the role \"",
            "                        \"belongs to a different organization than the user \"",
            "                    )}, HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user is not deleting roles they cannot assign",
            "            # e.g. an organization admin is not allowed to delete a root role",
            "            deleted_roles = [r for r in user.roles if r not in roles]",
            "            for role in deleted_roles:",
            "                denied = self.permissions.check_user_rules(role.rules)",
            "                if denied:",
            "                    return {\"msg\": (",
            "                        f\"You are trying to delete the role {role.name} from \"",
            "                        \"this user but that is not allowed because they have \"",
            "                        f\"permissions you don't have: {denied['msg']} (and \"",
            "                        \"they do!)\"",
            "                    )}, HTTPStatus.UNAUTHORIZED",
            "",
            "            user.roles = roles",
            "",
            "        if 'rules' in json_data:",
            "            # validate that these rules exist",
            "            rules = []",
            "            for rule_id in json_data['rules']:",
            "                rule = db.Rule.get(rule_id)",
            "                if not rule:",
            "                    return {'msg': f'Rule={rule_id} can not be found!'}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                rules.append(rule)",
            "",
            "            # validate that user is not changing their own rules",
            "            if user == g.user:",
            "                return {'msg': \"You can't changes your own rules!\"}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user can assign these",
            "            denied = self.permissions.check_user_rules(rules)",
            "            if denied:",
            "                return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user is not deleting rules they do not have",
            "            # themselves",
            "            deleted_rules = [r for r in user.rules if r not in rules]",
            "            denied = self.permissions.check_user_rules(deleted_rules)",
            "            if denied:",
            "                return {\"msg\": (",
            "                    f\"{denied['msg']}. You can't delete permissions for \"",
            "                    \"another user that you don't have yourself!\"",
            "                )}, HTTPStatus.UNAUTHORIZED",
            "",
            "            user.rules = rules",
            "",
            "        try:",
            "            user.save()",
            "        except sqlalchemy.exc.IntegrityError as e:",
            "            log.error(e)",
            "            user.session.rollback()",
            "            return {",
            "                \"msg\": \"User could not be updated with those parameters.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "            # TODO BvB 2021-08-27 return msg that user was not updated?",
            "",
            "        return user_schema.dump(user), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\"Remove user.",
            "        ---",
            "        description: >-",
            "          Delete a user account permanently.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |User|Global|Delete|\u274c|\u274c|Delete any user|\\n",
            "          |User|Organization|Delete|\u274c|\u274c|Delete users from your",
            "          organization|\\n",
            "          |User|Own|Delete|\u274c|\u274c|Delete your own account|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: User id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: User not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        user = db.User.get(id)",
            "        if not user:",
            "            return {\"msg\": f\"user id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            if not (self.r.d_org.can() and user.organization ==",
            "                    g.user.organization):",
            "                if not (self.r.d_own.can() and user == g.user):",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "",
            "        user.delete()",
            "        log.info(f\"user id={id} is removed from the database\")",
            "        return {\"msg\": f\"user id={id} is removed from the database\"}, \\",
            "            HTTPStatus.OK"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "import logging",
            "import sqlalchemy.exc",
            "",
            "from http import HTTPStatus",
            "from flask import g, request",
            "from flask_restful import reqparse, Api",
            "",
            "from vantage6.common import logger_name",
            "from vantage6.server import db",
            "from vantage6.server.permission import (",
            "    Scope as S,",
            "    Operation as P,",
            "    PermissionManager",
            ")",
            "from vantage6.server.resource import (",
            "    with_user,",
            "    ServicesResources",
            ")",
            "from vantage6.server.resource.common.pagination import Pagination",
            "from vantage6.server.resource.common._schema import UserSchema",
            "",
            "",
            "module_name = logger_name(__name__)",
            "log = logging.getLogger(module_name)",
            "",
            "",
            "def setup(api: Api, api_base: str, services: dict) -> None:",
            "    \"\"\"",
            "    Setup the user resource.",
            "",
            "    Parameters",
            "    ----------",
            "    api : Api",
            "        Flask restful api instance",
            "    api_base : str",
            "        Base url of the api",
            "    services : dict",
            "        Dictionary with services required for the resource endpoints",
            "    \"\"\"",
            "    path = \"/\".join([api_base, module_name])",
            "    log.info(f'Setting up \"{path}\" and subdirectories')",
            "",
            "    api.add_resource(",
            "        Users,",
            "        path,",
            "        endpoint='user_without_id',",
            "        methods=('GET', 'POST'),",
            "        resource_class_kwargs=services",
            "    )",
            "    api.add_resource(",
            "        User,",
            "        path + '/<int:id>',",
            "        endpoint='user_with_id',",
            "        methods=('GET', 'PATCH', 'DELETE'),",
            "        resource_class_kwargs=services",
            "    )",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Permissions",
            "# ------------------------------------------------------------------------------",
            "def permissions(permissions: PermissionManager) -> None:",
            "    \"\"\"",
            "    Define the permissions for this resource.",
            "",
            "    Parameters",
            "    ----------",
            "    permissions : PermissionManager",
            "        Permission manager instance to which permissions are added",
            "    \"\"\"",
            "    add = permissions.appender(module_name)",
            "    add(S.GLOBAL, P.VIEW,",
            "        description='View any user')",
            "    add(S.ORGANIZATION, P.VIEW,",
            "        description='View users from your organization')",
            "    add(S.GLOBAL, P.CREATE,",
            "        description='Create a new user for any organization')",
            "    add(S.ORGANIZATION, P.CREATE,",
            "        description='Create a new user for your organization')",
            "    add(S.GLOBAL, P.EDIT,",
            "        description='Edit any user')",
            "    add(S.ORGANIZATION, P.EDIT,",
            "        description='Edit users from your organization')",
            "    add(S.OWN, P.EDIT,",
            "        description='Edit your own info')",
            "    add(S.GLOBAL, P.DELETE,",
            "        description='Delete any user')",
            "    add(S.ORGANIZATION, P.DELETE,",
            "        description='Delete users from your organization')",
            "    add(S.OWN, P.DELETE,",
            "        description='Delete your own account')",
            "",
            "",
            "# ------------------------------------------------------------------------------",
            "# Resources / API's",
            "# ------------------------------------------------------------------------------",
            "user_schema = UserSchema()",
            "",
            "",
            "class UserBase(ServicesResources):",
            "",
            "    def __init__(self, socketio, mail, api, permissions, config):",
            "        super().__init__(socketio, mail, api, permissions, config)",
            "        self.r = getattr(self.permissions, module_name)",
            "",
            "",
            "class Users(UserBase):",
            "",
            "    @with_user",
            "    def get(self):",
            "        \"\"\"List users",
            "        ---",
            "        description: >-",
            "            Returns a list of users that you are allowed to see.",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |--|--|--|--|--|--|\\n",
            "            |User|Global|View|\u274c|\u274c|View any user details|\\n",
            "            |User|Organization|View|\u274c|\u274c|View users from your organization|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "          - in: query",
            "            name: username",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: organization_id",
            "            schema:",
            "              type: integer",
            "            description: Organization id",
            "          - in: query",
            "            name: firstname",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: lastname",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Name to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: email",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Email to match with a LIKE operator. \\n",
            "              * The percent sign (%) represents zero, one, or multiple",
            "              characters\\n",
            "              * underscore sign (_) represents one, single character",
            "          - in: query",
            "            name: role_id",
            "            schema:",
            "              type: integer",
            "            description: Role that is assigned to user",
            "          - in: query",
            "            name: rule_id",
            "            schema:",
            "              type: integer",
            "            description: Rule that is assigned to user",
            "          - in: query",
            "            name: last_seen_from",
            "            schema:",
            "              type: date (yyyy-mm-dd)",
            "            description: Show only users seen since this date",
            "          - in: query",
            "            name: last_seen_till",
            "            schema:",
            "              type: date (yyyy-mm-dd)",
            "            description: Show only users last seen before this date",
            "          - in: query",
            "            name: page",
            "            schema:",
            "              type: integer",
            "            description: Page number for pagination (default=1)",
            "          - in: query",
            "            name: per_page",
            "            schema:",
            "              type: integer",
            "            description: Number of items per page (default=10)",
            "          - in: query",
            "            name: sort",
            "            schema:",
            "              type: string",
            "            description: >-",
            "              Sort by one or more fields, separated by a comma. Use a minus",
            "              sign (-) in front of the field to sort in descending order.",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        args = request.args",
            "        q = g.session.query(db.User)",
            "",
            "        # filter by any field of this endpoint",
            "        for param in ['username', 'firstname', 'lastname', 'email']:",
            "            if param in args:",
            "                q = q.filter(getattr(db.User, param).like(args[param]))",
            "        if 'organization_id' in args:",
            "            q = q.filter(db.User.organization_id == args['organization_id'])",
            "        if 'last_seen_till' in args:",
            "            q = q.filter(db.User.last_seen <= args['last_seen_till'])",
            "        if 'last_seen_from' in args:",
            "            q = q.filter(db.User.last_seen >= args['last_seen_from'])",
            "",
            "        # find users with a particulare role or rule assigned",
            "        if 'role_id' in args:",
            "            q = q.join(db.Permission).join(db.Role)\\",
            "                 .filter(db.Role.id == args['role_id'])",
            "        if 'rule_id' in args:",
            "            q = q.join(db.UserPermission).join(db.Rule)\\",
            "                 .filter(db.Rule.id == args['rule_id'])",
            "",
            "        # check permissions and apply filter if neccessary",
            "        if not self.r.v_glo.can():",
            "            if self.r.v_org.can():",
            "                q = q.filter(db.User.organization_id == g.user.organization_id)",
            "            else:",
            "                return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "        # paginate results",
            "        try:",
            "            page = Pagination.from_query(query=q, request=request)",
            "        except ValueError as e:",
            "            return {'msg': str(e)}, HTTPStatus.BAD_REQUEST",
            "",
            "        # model serialization",
            "        return self.response(page, user_schema)",
            "",
            "    @with_user",
            "    def post(self):",
            "        \"\"\"Create user",
            "        ---",
            "        description: >-",
            "          Creates new user from the request data to the users organization.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |User|Global|Create|\u274c|\u274c|Create a new user|\\n",
            "          |User|Organization|Create|\u274c|\u274c|Create a new user as part of your",
            "          organization|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  username:",
            "                    type: string",
            "                    description: Unique username",
            "                  firstname:",
            "                    type: string",
            "                    description: First name",
            "                  lastname:",
            "                    type: string",
            "                    description: Last name",
            "                  password:",
            "                    type: string",
            "                    description: Password",
            "                  organization_id:",
            "                    type: integer",
            "                    description: Organization id to which user is assigned",
            "                  roles:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: User's roles",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: Extra rules for the user on top of the roles",
            "                  email:",
            "                    type: string",
            "                    description: Email address",
            "",
            "        responses:",
            "          201:",
            "            description: Ok",
            "          400:",
            "            description: Username or email already exists",
            "          401:",
            "            description: Unauthorized",
            "          404:",
            "            description: Organization id does not exist",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument(\"username\", type=str, required=True)",
            "        parser.add_argument(\"firstname\", type=str, required=True)",
            "        parser.add_argument(\"lastname\", type=str, required=True)",
            "        # TODO password should be send to the email, rather than setting it",
            "        parser.add_argument(\"password\", type=str, required=True)",
            "        parser.add_argument(\"email\", type=str, required=True)",
            "        parser.add_argument(\"organization_id\", type=int, required=False,",
            "                            help=\"This is only used if you're root\")",
            "        parser.add_argument(\"roles\", type=int, action=\"append\", required=False)",
            "        parser.add_argument(\"rules\", type=int, action=\"append\", required=False)",
            "        data = parser.parse_args()",
            "",
            "        # check unique constraints",
            "        if db.User.username_exists(data[\"username\"]):",
            "            return {\"msg\": \"username already exists.\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        if db.User.exists(\"email\", data[\"email\"]):",
            "            return {\"msg\": \"email already exists.\"}, HTTPStatus.BAD_REQUEST",
            "",
            "        # check if the organization has been provided, if this is the case the",
            "        # user needs global permissions in case it is not their own",
            "        organization_id = g.user.organization_id",
            "        if data['organization_id']:",
            "            if data['organization_id'] != organization_id:",
            "                if self.r.c_glo.can():",
            "                    # check if organization exists",
            "                    org = db.Organization.get(data['organization_id'])",
            "                    if not org:",
            "                        return {'msg': \"Organization does not exist.\"}, \\",
            "                            HTTPStatus.NOT_FOUND",
            "                else:  # not-root user cant create users for other organization",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "            organization_id = data['organization_id']",
            "",
            "        # check that user is allowed to create users",
            "        if not (self.r.c_glo.can() or self.r.c_org.can()):",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                HTTPStatus.UNAUTHORIZED",
            "",
            "        # process the required roles. It is only possible to assign roles with",
            "        # rules that you already have permission to. This way we ensure you can",
            "        # never extend your power on your own.",
            "        potential_roles = data.get(\"roles\")",
            "        roles = []",
            "        if potential_roles:",
            "            for role in potential_roles:",
            "                role_ = db.Role.get(role)",
            "                if role_:",
            "                    denied = self.permissions.check_user_rules(role_.rules)",
            "                    if denied:",
            "                        return denied, HTTPStatus.UNAUTHORIZED",
            "                    roles.append(role_)",
            "",
            "                    # validate that the assigned role is either a general role",
            "                    # or a role pertaining to that organization",
            "                    if (role_.organization and",
            "                            role_.organization.id != organization_id):",
            "                        return {'msg': (",
            "                            \"You can't assign that role as the role belongs to\"",
            "                            \" a different organization than the user.\"",
            "                        )}, HTTPStatus.UNAUTHORIZED",
            "",
            "        # You can only assign rules that you already have to others.",
            "        potential_rules = data[\"rules\"]",
            "        rules = []",
            "        if potential_rules:",
            "            rules = [db.Rule.get(rule) for rule in potential_rules",
            "                     if db.Rule.get(rule)]",
            "            denied = self.permissions.check_user_rules(rules)",
            "            if denied:",
            "                return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "        # Ok, looks like we got most of the security hazards out of the way",
            "        user = db.User(",
            "            username=data[\"username\"],",
            "            firstname=data[\"firstname\"],",
            "            lastname=data[\"lastname\"],",
            "            roles=roles,",
            "            rules=rules,",
            "            organization_id=organization_id,",
            "            email=data[\"email\"],",
            "            password=data[\"password\"]",
            "        )",
            "",
            "        # check if the password meets password criteria",
            "        msg = user.set_password(data[\"password\"])",
            "        if msg:",
            "            return {\"msg\": msg}, HTTPStatus.BAD_REQUEST",
            "",
            "        user.save()",
            "",
            "        return user_schema.dump(user), HTTPStatus.CREATED",
            "",
            "",
            "class User(UserBase):",
            "",
            "    @with_user",
            "    def get(self, id):",
            "        \"\"\"Get user",
            "        ---",
            "        description: >-",
            "            Returns the user specified by the id.\\n",
            "",
            "            ### Permission Table\\n",
            "            |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "            Description|\\n",
            "            |-- |--|--|--|--|--|\\n",
            "            |User|Global|View|\u274c|\u274c|View any user details|\\n",
            "            |User|Organization|View|\u274c|\u274c|View users from your",
            "            organization|\\n",
            "            |User|Organization|Own|\u274c|\u274c|View details about your own user|\\n",
            "",
            "            Accessible to users.",
            "",
            "        parameters:",
            "            - in: path",
            "              name: id",
            "              schema:",
            "                type: integer",
            "              description: User id",
            "              required: true",
            "",
            "        responses:",
            "            200:",
            "                description: Ok",
            "            404:",
            "                description: User not found",
            "            401:",
            "                description: Unauthorized",
            "",
            "        security:",
            "            - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        user = db.User.get(id)",
            "        if not user:",
            "            return {\"msg\": f\"user id={id} is not found\"}, HTTPStatus.NOT_FOUND",
            "",
            "        same_user = g.user.id == user.id",
            "        same_org = g.user.organization.id == user.organization_id",
            "",
            "        # allow user to be returned if:",
            "        # 1. auth can see all users",
            "        # 2. auth can see organization users and user is within organization",
            "        # 3. auth is requesting own user details",
            "        if (",
            "            self.r.v_glo.can() or",
            "            (self.r.v_org.can() and same_org) or",
            "            same_user",
            "        ):",
            "            return user_schema.dump(user, many=False), HTTPStatus.OK",
            "        else:",
            "            return {'msg': 'You lack the permission to do that!'}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "    @with_user",
            "    def patch(self, id):",
            "        \"\"\"Update user",
            "        ---",
            "        description: >-",
            "          Update user information.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |User|Global|Edit|\u274c|\u274c|Edit any user|\\n",
            "          |User|Organization|Edit|\u274c|\u274c|Edit any user in your organization|\\n",
            "          |User|Own|Edit|\u274c|\u274c|Edit your own user account|\\n",
            "",
            "          Accessible to users.",
            "",
            "        requestBody:",
            "          content:",
            "            application/json:",
            "              schema:",
            "                properties:",
            "                  username:",
            "                    type: string",
            "                    description: Unique username",
            "                  firstname:",
            "                    type: string",
            "                    description: First name",
            "                  lastname:",
            "                    type: string",
            "                    description: Last name",
            "                  email:",
            "                    type: string",
            "                    description: Email address",
            "                  roles:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: User's roles",
            "                  rules:",
            "                    type: array",
            "                    items:",
            "                      type: integer",
            "                    description: Extra rules for the user on top of the roles",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: User id",
            "            required: true",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          400:",
            "            description: User cannot be updated to contents of request body,",
            "              e.g. due to duplicate email address.",
            "          404:",
            "            description: User not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        user = db.User.get(id)",
            "",
            "        if not user:",
            "            return {\"msg\": f\"user id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.e_glo.can():",
            "            if not (self.r.e_org.can() and user.organization ==",
            "                    g.user.organization):",
            "                if not (self.r.e_own.can() and user == g.user):",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "",
            "        parser = reqparse.RequestParser()",
            "        parser.add_argument(\"username\", type=str, required=False)",
            "        parser.add_argument(\"firstname\", type=str, required=False)",
            "        parser.add_argument(\"lastname\", type=str, required=False)",
            "        parser.add_argument(\"email\", type=str, required=False)",
            "        data = parser.parse_args()",
            "",
            "        # check if user defined a password, which is deprecated",
            "        # FIXME BvB 22-06-29: with time, this check may be removed. Now it is",
            "        # here for backwards compatibility (if people have scripts using this,",
            "        # this makes them aware something changed)",
            "        request_json = request.get_json()",
            "        if request_json.get(\"password\"):",
            "            return {\"msg\": \"You cannot change your password here!\"}, \\",
            "                HTTPStatus.BAD_REQUEST",
            "",
            "        if data[\"username\"] is not None:",
            "            if data[\"username\"] == '':",
            "                return {",
            "                    \"msg\": \"Empty username is not allowed!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            elif user.username != data[\"username\"]:",
            "                if db.User.exists(\"username\", data[\"username\"]):",
            "                    return {",
            "                        \"msg\": \"User with that username already exists\"",
            "                    }, HTTPStatus.BAD_REQUEST",
            "                elif user.id != g.user.id:",
            "                    return {",
            "                        \"msg\": \"You cannot change the username of another user\"",
            "                    }, HTTPStatus.BAD_REQUEST",
            "            user.username = data[\"username\"]",
            "        if data[\"firstname\"] is not None:",
            "            user.firstname = data[\"firstname\"]",
            "        if data[\"lastname\"] is not None:",
            "            user.lastname = data[\"lastname\"]",
            "        if data[\"email\"] is not None:",
            "            if data[\"email\"] == '':",
            "                return {",
            "                    \"msg\": \"Empty email is not allowed!\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            elif (user.email != data[\"email\"] and",
            "                    db.User.exists(\"email\", data[\"email\"])):",
            "                return {",
            "                    \"msg\": \"User with that email already exists.\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            user.email = data[\"email\"]",
            "",
            "        # request parser is awefull with lists",
            "        json_data = request.get_json()",
            "        if 'roles' in json_data:",
            "            # validate that these roles exist",
            "            roles = []",
            "            for role_id in json_data['roles']:",
            "                role = db.Role.get(role_id)",
            "                if not role:",
            "                    return {'msg': f'Role={role_id} can not be found!'}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                roles.append(role)",
            "",
            "            # validate that user is not changing their own roles",
            "            if user == g.user:",
            "                return {'msg': \"You can't changes your own roles!\"}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user can assign these",
            "            for role in roles:",
            "                denied = self.permissions.check_user_rules(role.rules)",
            "                if denied:",
            "                    return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "                # validate that the assigned role is either a general role or a",
            "                # role pertaining to that organization",
            "                if (role.organization and",
            "                        role.organization.id != user.organization_id):",
            "                    return {'msg': (",
            "                        \"You can't assign that role to that user as the role \"",
            "                        \"belongs to a different organization than the user \"",
            "                    )}, HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user is not deleting roles they cannot assign",
            "            # e.g. an organization admin is not allowed to delete a root role",
            "            deleted_roles = [r for r in user.roles if r not in roles]",
            "            for role in deleted_roles:",
            "                denied = self.permissions.check_user_rules(role.rules)",
            "                if denied:",
            "                    return {\"msg\": (",
            "                        f\"You are trying to delete the role {role.name} from \"",
            "                        \"this user but that is not allowed because they have \"",
            "                        f\"permissions you don't have: {denied['msg']} (and \"",
            "                        \"they do!)\"",
            "                    )}, HTTPStatus.UNAUTHORIZED",
            "",
            "            user.roles = roles",
            "",
            "        if 'rules' in json_data:",
            "            # validate that these rules exist",
            "            rules = []",
            "            for rule_id in json_data['rules']:",
            "                rule = db.Rule.get(rule_id)",
            "                if not rule:",
            "                    return {'msg': f'Rule={rule_id} can not be found!'}, \\",
            "                        HTTPStatus.NOT_FOUND",
            "                rules.append(rule)",
            "",
            "            # validate that user is not changing their own rules",
            "            if user == g.user:",
            "                return {'msg': \"You can't changes your own rules!\"}, \\",
            "                    HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user can assign these",
            "            denied = self.permissions.check_user_rules(rules)",
            "            if denied:",
            "                return denied, HTTPStatus.UNAUTHORIZED",
            "",
            "            # validate that user is not deleting rules they do not have",
            "            # themselves",
            "            deleted_rules = [r for r in user.rules if r not in rules]",
            "            denied = self.permissions.check_user_rules(deleted_rules)",
            "            if denied:",
            "                return {\"msg\": (",
            "                    f\"{denied['msg']}. You can't delete permissions for \"",
            "                    \"another user that you don't have yourself!\"",
            "                )}, HTTPStatus.UNAUTHORIZED",
            "",
            "            user.rules = rules",
            "",
            "        try:",
            "            user.save()",
            "        except sqlalchemy.exc.IntegrityError as e:",
            "            log.error(e)",
            "            user.session.rollback()",
            "            return {",
            "                \"msg\": \"User could not be updated with those parameters.\"",
            "            }, HTTPStatus.BAD_REQUEST",
            "            # TODO BvB 2021-08-27 return msg that user was not updated?",
            "",
            "        return user_schema.dump(user), HTTPStatus.OK",
            "",
            "    @with_user",
            "    def delete(self, id):",
            "        \"\"\"Remove user.",
            "        ---",
            "        description: >-",
            "          Delete a user account permanently.\\n",
            "",
            "          ### Permission Table\\n",
            "          |Rule name|Scope|Operation|Assigned to node|Assigned to container|",
            "          Description|\\n",
            "          |--|--|--|--|--|--|\\n",
            "          |User|Global|Delete|\u274c|\u274c|Delete any user|\\n",
            "          |User|Organization|Delete|\u274c|\u274c|Delete users from your",
            "          organization|\\n",
            "          |User|Own|Delete|\u274c|\u274c|Delete your own account|\\n",
            "",
            "          Accessible to users.",
            "",
            "        parameters:",
            "          - in: path",
            "            name: id",
            "            schema:",
            "              type: integer",
            "            description: User id",
            "            required: true",
            "         - in: query",
            "            name: delete_dependents",
            "            schema:",
            "              type: boolean",
            "            description: If set to true, the user will be deleted along with",
            "              all tasks they created (default=False)",
            "",
            "        responses:",
            "          200:",
            "            description: Ok",
            "          404:",
            "            description: User not found",
            "          401:",
            "            description: Unauthorized",
            "",
            "        security:",
            "          - bearerAuth: []",
            "",
            "        tags: [\"User\"]",
            "        \"\"\"",
            "        user = db.User.get(id)",
            "        if not user:",
            "            return {\"msg\": f\"user id={id} not found\"}, \\",
            "                HTTPStatus.NOT_FOUND",
            "",
            "        if not self.r.d_glo.can():",
            "            if not (self.r.d_org.can() and user.organization ==",
            "                    g.user.organization):",
            "                if not (self.r.d_own.can() and user == g.user):",
            "                    return {'msg': 'You lack the permission to do that!'}, \\",
            "                        HTTPStatus.UNAUTHORIZED",
            "",
            "        # check if user created any tasks",
            "        if user.created_tasks:",
            "            params = request.args",
            "            if not params.get('delete_dependents', False):",
            "                return {",
            "                    \"msg\": f\"User has created {len(user.created_tasks)} tasks.\"",
            "                    \" Please delete those first, or set the \"",
            "                    \"`delete_dependents` parameter to true to delete them \"",
            "                    \"automatically together with this user.\"",
            "                }, HTTPStatus.BAD_REQUEST",
            "            else:",
            "                log.warn(f\"Deleting {len(user.created_tasks)} tasks created by\"",
            "                         f\" user id={id}\")",
            "                for task in user.created_tasks:",
            "                    task.delete()",
            "",
            "        user.delete()",
            "        log.info(f\"user id={id} is removed from the database\")",
            "        return {\"msg\": f\"user id={id} is removed from the database\"}, \\",
            "            HTTPStatus.OK"
        ],
        "action": [
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "-1",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {},
        "addLocation": [
            "django.contrib.auth.forms.AdminPasswordChangeForm"
        ]
    }
}