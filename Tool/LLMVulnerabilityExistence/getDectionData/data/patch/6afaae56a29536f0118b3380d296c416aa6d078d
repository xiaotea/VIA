{
    "rdiffweb/core/notification.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 73,
                "afterPatchRowNumber": 73,
                "PatchRowcode": " "
            },
            "1": {
                "beforePatchRowNumber": 74,
                "afterPatchRowNumber": 74,
                "PatchRowcode": "         # Send a mail notification"
            },
            "2": {
                "beforePatchRowNumber": 75,
                "afterPatchRowNumber": 75,
                "PatchRowcode": "         body = self.app.templates.compile_template("
            },
            "3": {
                "beforePatchRowNumber": 76,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"access_token_added.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'name': name}"
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 76,
                "PatchRowcode": "+            \"email_access_token_added.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'name': name}"
            },
            "5": {
                "beforePatchRowNumber": 77,
                "afterPatchRowNumber": 77,
                "PatchRowcode": "         )"
            },
            "6": {
                "beforePatchRowNumber": 78,
                "afterPatchRowNumber": 78,
                "PatchRowcode": "         self.bus.publish('queue_mail', to=userobj.email, subject=_(\"A new access token has been created\"), message=body)"
            },
            "7": {
                "beforePatchRowNumber": 79,
                "afterPatchRowNumber": 79,
                "PatchRowcode": " "
            },
            "8": {
                "beforePatchRowNumber": 118,
                "afterPatchRowNumber": 118,
                "PatchRowcode": " "
            },
            "9": {
                "beforePatchRowNumber": 119,
                "afterPatchRowNumber": 119,
                "PatchRowcode": "         # If the email attributes was changed, send a mail notification."
            },
            "10": {
                "beforePatchRowNumber": 120,
                "afterPatchRowNumber": 120,
                "PatchRowcode": "         body = self.app.templates.compile_template("
            },
            "11": {
                "beforePatchRowNumber": 121,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            \"password_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}"
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 121,
                "PatchRowcode": "+            \"email_password_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}"
            },
            "13": {
                "beforePatchRowNumber": 122,
                "afterPatchRowNumber": 122,
                "PatchRowcode": "         )"
            },
            "14": {
                "beforePatchRowNumber": 123,
                "afterPatchRowNumber": 123,
                "PatchRowcode": "         self.bus.publish('queue_mail', to=userobj.email, subject=_(\"Password changed\"), message=body)"
            },
            "15": {
                "beforePatchRowNumber": 124,
                "afterPatchRowNumber": 124,
                "PatchRowcode": " "
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugin used to send email to users when their repository is getting too old.",
            "User can control the notification period.",
            "\"\"\"",
            "",
            "import datetime",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy.process.plugins import SimplePlugin",
            "",
            "from rdiffweb.core import librdiff",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class NotificationPlugin(SimplePlugin):",
            "    \"\"\"",
            "    Send email notification when a repository get too old (without a backup).",
            "    \"\"\"",
            "",
            "    execution_time = '23:00'",
            "",
            "    send_changed = False",
            "",
            "    def start(self):",
            "        self.bus.log('Start Notification plugin')",
            "        self.bus.publish('schedule_job', self.execution_time, self.notification_job)",
            "        self.bus.subscribe('access_token_added', self.access_token_added)",
            "        self.bus.subscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.subscribe('user_password_changed', self.user_password_changed)",
            "",
            "    start.priority = 55",
            "",
            "    def stop(self):",
            "        self.bus.log('Stop Notification plugin')",
            "        self.bus.publish('unschedule_job', self.notification_job)",
            "        self.bus.unsubscribe('access_token_added', self.access_token_added)",
            "        self.bus.unsubscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.unsubscribe('user_password_changed', self.user_password_changed)",
            "",
            "    stop.priority = 45",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.tree.apps['']",
            "",
            "    def access_token_added(self, userobj, name):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # Send a mail notification",
            "        body = self.app.templates.compile_template(",
            "            \"access_token_added.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'name': name}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"A new access token has been created\"), message=body)",
            "",
            "    def user_attr_changed(self, userobj, attrs={}):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        # Leave if the mail was not changed.",
            "        if 'email' in attrs:",
            "            old_email = attrs['email'][0]",
            "            if not old_email:",
            "                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "                return",
            "            # If the email attributes was changed, send a mail notification.",
            "            subject = _(\"Email address changed\")",
            "            body = self.app.templates.compile_template(",
            "                \"email_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "            )",
            "            self.bus.publish('queue_mail', to=old_email, subject=str(subject), message=body)",
            "",
            "        if 'mfa' in attrs:",
            "            if not userobj.email:",
            "                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "                return",
            "            subject = (",
            "                _(\"Two-Factor Authentication turned off\")",
            "                if userobj.mfa == UserObject.DISABLED_MFA",
            "                else _(\"Two-Factor Authentication turned on\")",
            "            )",
            "            body = self.app.templates.compile_template(",
            "                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "            )",
            "            self.bus.publish('queue_mail', to=userobj.email, subject=str(subject), message=body)",
            "",
            "    def user_password_changed(self, userobj):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # If the email attributes was changed, send a mail notification.",
            "        body = self.app.templates.compile_template(",
            "            \"password_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"Password changed\"), message=body)",
            "",
            "    def notification_job(self):",
            "        \"\"\"",
            "        Loop trough all the user repository and send notifications.",
            "        \"\"\"",
            "",
            "        now = librdiff.RdiffTime()",
            "",
            "        def _user_repos():",
            "            \"\"\"Return a generator trought user repos to be notified.\"\"\"",
            "            for user in UserObject.query.all():",
            "                # Check if user has email.",
            "                if not user.email:",
            "                    continue",
            "                # Identify old repo for current user.",
            "                old_repos = []",
            "                for repo in user.repo_objs:",
            "                    # Check if repo has age configured (in days)",
            "                    maxage = repo.maxage",
            "                    if not maxage or maxage <= 0:",
            "                        continue",
            "                    # Check repo age.",
            "                    if repo.last_backup_date is None or repo.last_backup_date < (now - datetime.timedelta(days=maxage)):",
            "                        old_repos.append(repo)",
            "                # Return an item only if user had old repo",
            "                if old_repos:",
            "                    yield user, old_repos",
            "",
            "        # For each candidate, send mail.",
            "        for user, repos in _user_repos():",
            "            parms = {'user': user, 'repos': repos}",
            "            body = self.app.templates.compile_template(\"email_notification.html\", **parms)",
            "            cherrypy.engine.publish('queue_mail', to=user.email, subject=_(\"Notification\"), message=body)",
            "",
            "",
            "cherrypy.notification = NotificationPlugin(cherrypy.engine)",
            "cherrypy.notification.subscribe()",
            "",
            "cherrypy.config.namespaces['notification'] = lambda key, value: setattr(cherrypy.notification, key, value)"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "\"\"\"",
            "Plugin used to send email to users when their repository is getting too old.",
            "User can control the notification period.",
            "\"\"\"",
            "",
            "import datetime",
            "import logging",
            "",
            "import cherrypy",
            "from cherrypy.process.plugins import SimplePlugin",
            "",
            "from rdiffweb.core import librdiff",
            "from rdiffweb.core.model import UserObject",
            "from rdiffweb.tools.i18n import ugettext as _",
            "",
            "logger = logging.getLogger(__name__)",
            "",
            "",
            "class NotificationPlugin(SimplePlugin):",
            "    \"\"\"",
            "    Send email notification when a repository get too old (without a backup).",
            "    \"\"\"",
            "",
            "    execution_time = '23:00'",
            "",
            "    send_changed = False",
            "",
            "    def start(self):",
            "        self.bus.log('Start Notification plugin')",
            "        self.bus.publish('schedule_job', self.execution_time, self.notification_job)",
            "        self.bus.subscribe('access_token_added', self.access_token_added)",
            "        self.bus.subscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.subscribe('user_password_changed', self.user_password_changed)",
            "",
            "    start.priority = 55",
            "",
            "    def stop(self):",
            "        self.bus.log('Stop Notification plugin')",
            "        self.bus.publish('unschedule_job', self.notification_job)",
            "        self.bus.unsubscribe('access_token_added', self.access_token_added)",
            "        self.bus.unsubscribe('user_attr_changed', self.user_attr_changed)",
            "        self.bus.unsubscribe('user_password_changed', self.user_password_changed)",
            "",
            "    stop.priority = 45",
            "",
            "    @property",
            "    def app(self):",
            "        return cherrypy.tree.apps['']",
            "",
            "    def access_token_added(self, userobj, name):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # Send a mail notification",
            "        body = self.app.templates.compile_template(",
            "            \"email_access_token_added.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj, 'name': name}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"A new access token has been created\"), message=body)",
            "",
            "    def user_attr_changed(self, userobj, attrs={}):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        # Leave if the mail was not changed.",
            "        if 'email' in attrs:",
            "            old_email = attrs['email'][0]",
            "            if not old_email:",
            "                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "                return",
            "            # If the email attributes was changed, send a mail notification.",
            "            subject = _(\"Email address changed\")",
            "            body = self.app.templates.compile_template(",
            "                \"email_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "            )",
            "            self.bus.publish('queue_mail', to=old_email, subject=str(subject), message=body)",
            "",
            "        if 'mfa' in attrs:",
            "            if not userobj.email:",
            "                logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "                return",
            "            subject = (",
            "                _(\"Two-Factor Authentication turned off\")",
            "                if userobj.mfa == UserObject.DISABLED_MFA",
            "                else _(\"Two-Factor Authentication turned on\")",
            "            )",
            "            body = self.app.templates.compile_template(",
            "                \"email_mfa.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "            )",
            "            self.bus.publish('queue_mail', to=userobj.email, subject=str(subject), message=body)",
            "",
            "    def user_password_changed(self, userobj):",
            "        if not self.send_changed:",
            "            return",
            "",
            "        if not userobj.email:",
            "            logger.info(\"can't sent mail to user [%s] without an email\", userobj.username)",
            "            return",
            "",
            "        # If the email attributes was changed, send a mail notification.",
            "        body = self.app.templates.compile_template(",
            "            \"email_password_changed.html\", **{\"header_name\": self.app.cfg.header_name, 'user': userobj}",
            "        )",
            "        self.bus.publish('queue_mail', to=userobj.email, subject=_(\"Password changed\"), message=body)",
            "",
            "    def notification_job(self):",
            "        \"\"\"",
            "        Loop trough all the user repository and send notifications.",
            "        \"\"\"",
            "",
            "        now = librdiff.RdiffTime()",
            "",
            "        def _user_repos():",
            "            \"\"\"Return a generator trought user repos to be notified.\"\"\"",
            "            for user in UserObject.query.all():",
            "                # Check if user has email.",
            "                if not user.email:",
            "                    continue",
            "                # Identify old repo for current user.",
            "                old_repos = []",
            "                for repo in user.repo_objs:",
            "                    # Check if repo has age configured (in days)",
            "                    maxage = repo.maxage",
            "                    if not maxage or maxage <= 0:",
            "                        continue",
            "                    # Check repo age.",
            "                    if repo.last_backup_date is None or repo.last_backup_date < (now - datetime.timedelta(days=maxage)):",
            "                        old_repos.append(repo)",
            "                # Return an item only if user had old repo",
            "                if old_repos:",
            "                    yield user, old_repos",
            "",
            "        # For each candidate, send mail.",
            "        for user, repos in _user_repos():",
            "            parms = {'user': user, 'repos': repos}",
            "            body = self.app.templates.compile_template(\"email_notification.html\", **parms)",
            "            cherrypy.engine.publish('queue_mail', to=user.email, subject=_(\"Notification\"), message=body)",
            "",
            "",
            "cherrypy.notification = NotificationPlugin(cherrypy.engine)",
            "cherrypy.notification.subscribe()",
            "",
            "cherrypy.config.namespaces['notification'] = lambda key, value: setattr(cherrypy.notification, key, value)"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0"
        ],
        "dele_reviseLocation": {
            "76": [
                "NotificationPlugin",
                "access_token_added"
            ],
            "121": [
                "NotificationPlugin",
                "user_password_changed"
            ]
        },
        "addLocation": []
    },
    "rdiffweb/core/tests/test_notification.py": {
        "Patch": {
            "0": {
                "beforePatchRowNumber": 64,
                "afterPatchRowNumber": 64,
                "PatchRowcode": "         self.listener.queue_email.assert_called_once_with("
            },
            "1": {
                "beforePatchRowNumber": 65,
                "afterPatchRowNumber": 65,
                "PatchRowcode": "             to='test@test.com',"
            },
            "2": {
                "beforePatchRowNumber": 66,
                "afterPatchRowNumber": 66,
                "PatchRowcode": "             subject='Notification',"
            },
            "3": {
                "beforePatchRowNumber": 67,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>testcases</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\","
            },
            "4": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 67,
                "PatchRowcode": "+            message=\"<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      \\n        <li>\\n          <a>testcases</a>\\n        </li>\\n      \\n    </ul>\\n    <p>If you don't want to be notify about this. You need to review your user preferences.</p>\\n  </body>\\n</html>\","
            },
            "5": {
                "beforePatchRowNumber": 68,
                "afterPatchRowNumber": 68,
                "PatchRowcode": "         )"
            },
            "6": {
                "beforePatchRowNumber": 69,
                "afterPatchRowNumber": 69,
                "PatchRowcode": " "
            },
            "7": {
                "beforePatchRowNumber": 70,
                "afterPatchRowNumber": 70,
                "PatchRowcode": "     def test_notification_job_undefined_last_backup_date(self):"
            },
            "8": {
                "beforePatchRowNumber": 85,
                "afterPatchRowNumber": 85,
                "PatchRowcode": "         self.listener.queue_email.assert_called_once_with("
            },
            "9": {
                "beforePatchRowNumber": 86,
                "afterPatchRowNumber": 86,
                "PatchRowcode": "             to='test@test.com',"
            },
            "10": {
                "beforePatchRowNumber": 87,
                "afterPatchRowNumber": 87,
                "PatchRowcode": "             subject='Notification',"
            },
            "11": {
                "beforePatchRowNumber": 88,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>broker-repo</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\","
            },
            "12": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 88,
                "PatchRowcode": "+            message=\"<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      \\n        <li>\\n          <a>broker-repo</a>\\n        </li>\\n      \\n    </ul>\\n    <p>If you don't want to be notify about this. You need to review your user preferences.</p>\\n  </body>\\n</html>\","
            },
            "13": {
                "beforePatchRowNumber": 89,
                "afterPatchRowNumber": 89,
                "PatchRowcode": "         )"
            },
            "14": {
                "beforePatchRowNumber": 90,
                "afterPatchRowNumber": 90,
                "PatchRowcode": " "
            },
            "15": {
                "beforePatchRowNumber": 91,
                "afterPatchRowNumber": 91,
                "PatchRowcode": "     def test_notification_job_without_notification(self):"
            },
            "16": {
                "beforePatchRowNumber": 135,
                "afterPatchRowNumber": 135,
                "PatchRowcode": "         self.listener.queue_email.assert_called_once_with("
            },
            "17": {
                "beforePatchRowNumber": 136,
                "afterPatchRowNumber": 136,
                "PatchRowcode": "             to='original_email@test.com',"
            },
            "18": {
                "beforePatchRowNumber": 137,
                "afterPatchRowNumber": 137,
                "PatchRowcode": "             subject='Email address changed',"
            },
            "19": {
                "beforePatchRowNumber": 138,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the email address associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',"
            },
            "20": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 138,
                "PatchRowcode": "+            message='<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>\\n      <a>You recently changed the email address associated with your Rdiffweb account.</a>\\n    </p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',"
            },
            "21": {
                "beforePatchRowNumber": 139,
                "afterPatchRowNumber": 139,
                "PatchRowcode": "         )"
            },
            "22": {
                "beforePatchRowNumber": 140,
                "afterPatchRowNumber": 140,
                "PatchRowcode": " "
            },
            "23": {
                "beforePatchRowNumber": 141,
                "afterPatchRowNumber": 141,
                "PatchRowcode": "     def test_email_updated_with_same_value(self):"
            },
            "24": {
                "beforePatchRowNumber": 167,
                "afterPatchRowNumber": 167,
                "PatchRowcode": "         self.listener.queue_email.assert_called_once_with("
            },
            "25": {
                "beforePatchRowNumber": 168,
                "afterPatchRowNumber": 168,
                "PatchRowcode": "             to='password_change@test.com',"
            },
            "26": {
                "beforePatchRowNumber": 169,
                "afterPatchRowNumber": 169,
                "PatchRowcode": "             subject='Password changed',"
            },
            "27": {
                "beforePatchRowNumber": 170,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',"
            },
            "28": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 170,
                "PatchRowcode": "+            message='<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',"
            },
            "29": {
                "beforePatchRowNumber": 171,
                "afterPatchRowNumber": 171,
                "PatchRowcode": "         )"
            },
            "30": {
                "beforePatchRowNumber": 172,
                "afterPatchRowNumber": 172,
                "PatchRowcode": " "
            },
            "31": {
                "beforePatchRowNumber": 173,
                "afterPatchRowNumber": 173,
                "PatchRowcode": "     def test_password_change_with_same_value(self):"
            },
            "32": {
                "beforePatchRowNumber": 186,
                "afterPatchRowNumber": 186,
                "PatchRowcode": "         self.listener.queue_email.assert_called_once_with("
            },
            "33": {
                "beforePatchRowNumber": 187,
                "afterPatchRowNumber": 187,
                "PatchRowcode": "             to='password_change@test.com',"
            },
            "34": {
                "beforePatchRowNumber": 188,
                "afterPatchRowNumber": 188,
                "PatchRowcode": "             subject='Password changed',"
            },
            "35": {
                "beforePatchRowNumber": 189,
                "afterPatchRowNumber": "",
                "PatchRowcode": "-            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',"
            },
            "36": {
                "beforePatchRowNumber": "",
                "afterPatchRowNumber": 189,
                "PatchRowcode": "+            message='<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',"
            },
            "37": {
                "beforePatchRowNumber": 190,
                "afterPatchRowNumber": 190,
                "PatchRowcode": "         )"
            }
        },
        "frontPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "\"\"\"",
            "Created on Feb 13, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.core.notification",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class NotificationJobTest(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_check_schedule(self):",
            "        # Given the application is started",
            "        # Then remove_older job should be schedule",
            "        self.assertEqual(1, len([job for job in cherrypy.scheduler.list_jobs() if job.name == 'notification_job']))",
            "",
            "    def test_notification_job(self):",
            "        \"\"\"",
            "        Run the notification and check if mails are sent",
            "        \"\"\"",
            "        # Given a user with an email address and a repository with a maxage",
            "        # Set user config",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.commit()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = 1",
            "        repo.commit()",
            "        # When running notification_job",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then an email is queue for this user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>testcases</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_undefined_last_backup_date(self):",
            "        # Given a valid user with a repository configured for notification",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add().commit()",
            "        # Given a repo with last_backup_date None",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == 'broker-repo').first()",
            "        repo.maxage = 1",
            "        repo.add().commit()",
            "        self.assertIsNone(repo.last_backup_date)",
            "",
            "        # When Notification job is running",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then a notification is sent to the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      <li>broker-repo</li>\\n    </ul>\\n    <p>\\n      If you don't want to be notify about this. You need to review your\\n      user preferences.\\n    </p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_without_notification(self):",
            "        # Given a valid user with a repository configured without notification (-1)",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add().commit()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = -1",
            "        repo.add().commit()",
            "",
            "        # Call notification.",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Expect it to be called.",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "",
            "class NotificationPluginTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'email-send-changed-notification': True,",
            "    }",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_email_changed(self):",
            "        # Given a user with an email address",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'original_email@test.com'",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'email_changed@test.com'",
            "        user.add().commit()",
            "",
            "        # Then a email is queue to notify the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='original_email@test.com',",
            "            subject='Email address changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the email address associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_email_updated_with_same_value(self):",
            "        # Given a user with an email",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'email_changed@test.com'",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email with the same value",
            "        user.email = 'email_changed@test.com'",
            "        user.add().commit()",
            "",
            "        # Then no email are sent to the user",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "    def test_password_change_notification(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password",
            "        user.set_password('new_password')",
            "        user.add().commit()",
            "",
            "        # Then a email is send to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_password_change_with_same_value(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        user.set_password('new_password')",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password with the same value",
            "        user.set_password('new_password')",
            "        user.add().commit()",
            "",
            "        # Then an email is sent to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    Hey admin,\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )"
        ],
        "afterPatchFile": [
            "# -*- coding: utf-8 -*-",
            "# rdiffweb, A web interface to rdiff-backup repositories",
            "# Copyright (C) 2012-2021 rdiffweb contributors",
            "#",
            "# This program is free software: you can redistribute it and/or modify",
            "# it under the terms of the GNU General Public License as published by",
            "# the Free Software Foundation, either version 3 of the License, or",
            "# (at your option) any later version.",
            "#",
            "# This program is distributed in the hope that it will be useful,",
            "# but WITHOUT ANY WARRANTY; without even the implied warranty of",
            "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
            "# GNU General Public License for more details.",
            "#",
            "# You should have received a copy of the GNU General Public License",
            "# along with this program.  If not, see <http://www.gnu.org/licenses/>.",
            "",
            "",
            "\"\"\"",
            "Created on Feb 13, 2016",
            "",
            "@author: Patrik Dufresne <patrik@ikus-soft.com>",
            "\"\"\"",
            "from unittest.mock import MagicMock",
            "",
            "import cherrypy",
            "",
            "import rdiffweb.core.notification",
            "import rdiffweb.test",
            "from rdiffweb.core.model import RepoObject, UserObject",
            "",
            "",
            "class NotificationJobTest(rdiffweb.test.WebCase):",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_check_schedule(self):",
            "        # Given the application is started",
            "        # Then remove_older job should be schedule",
            "        self.assertEqual(1, len([job for job in cherrypy.scheduler.list_jobs() if job.name == 'notification_job']))",
            "",
            "    def test_notification_job(self):",
            "        \"\"\"",
            "        Run the notification and check if mails are sent",
            "        \"\"\"",
            "        # Given a user with an email address and a repository with a maxage",
            "        # Set user config",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.commit()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = 1",
            "        repo.commit()",
            "        # When running notification_job",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then an email is queue for this user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      \\n        <li>\\n          <a>testcases</a>\\n        </li>\\n      \\n    </ul>\\n    <p>If you don't want to be notify about this. You need to review your user preferences.</p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_undefined_last_backup_date(self):",
            "        # Given a valid user with a repository configured for notification",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add().commit()",
            "        # Given a repo with last_backup_date None",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == 'broker-repo').first()",
            "        repo.maxage = 1",
            "        repo.add().commit()",
            "        self.assertIsNone(repo.last_backup_date)",
            "",
            "        # When Notification job is running",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Then a notification is sent to the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='test@test.com',",
            "            subject='Notification',",
            "            message=\"<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>\\n      You are receiving this email to notify you about your backups. The\\n      following repositories are inactive for some time. We invite you to have a look\\n      at your last backup schedule.\\n    </p>\\n    <ul>\\n      \\n        <li>\\n          <a>broker-repo</a>\\n        </li>\\n      \\n    </ul>\\n    <p>If you don't want to be notify about this. You need to review your user preferences.</p>\\n  </body>\\n</html>\",",
            "        )",
            "",
            "    def test_notification_job_without_notification(self):",
            "        # Given a valid user with a repository configured without notification (-1)",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'test@test.com'",
            "        user.add().commit()",
            "        repo = RepoObject.query.filter(RepoObject.user == user, RepoObject.repopath == self.REPO).first()",
            "        repo.maxage = -1",
            "        repo.add().commit()",
            "",
            "        # Call notification.",
            "        cherrypy.notification.notification_job()",
            "",
            "        # Expect it to be called.",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "",
            "class NotificationPluginTest(rdiffweb.test.WebCase):",
            "",
            "    default_config = {",
            "        'email-send-changed-notification': True,",
            "    }",
            "",
            "    def setUp(self):",
            "        self.listener = MagicMock()",
            "        cherrypy.engine.subscribe('queue_mail', self.listener.queue_email, priority=50)",
            "        return super().setUp()",
            "",
            "    def tearDown(self):",
            "        cherrypy.engine.unsubscribe('queue_mail', self.listener.queue_email)",
            "        return super().tearDown()",
            "",
            "    def test_email_changed(self):",
            "        # Given a user with an email address",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'original_email@test.com'",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'email_changed@test.com'",
            "        user.add().commit()",
            "",
            "        # Then a email is queue to notify the user.",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='original_email@test.com',",
            "            subject='Email address changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>\\n      <a>You recently changed the email address associated with your Rdiffweb account.</a>\\n    </p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_email_updated_with_same_value(self):",
            "        # Given a user with an email",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'email_changed@test.com'",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user's email with the same value",
            "        user.email = 'email_changed@test.com'",
            "        user.add().commit()",
            "",
            "        # Then no email are sent to the user",
            "        self.listener.queue_email.assert_not_called()",
            "",
            "    def test_password_change_notification(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password",
            "        user.set_password('new_password')",
            "        user.add().commit()",
            "",
            "        # Then a email is send to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )",
            "",
            "    def test_password_change_with_same_value(self):",
            "        # Given a user with a email.",
            "        user = UserObject.get_user(self.USERNAME)",
            "        user.email = 'password_change@test.com'",
            "        user.set_password('new_password')",
            "        user.add().commit()",
            "        self.listener.queue_email.reset_mock()",
            "",
            "        # When updating the user password with the same value",
            "        user.set_password('new_password')",
            "        user.add().commit()",
            "",
            "        # Then an email is sent to the user",
            "        self.listener.queue_email.assert_called_once_with(",
            "            to='password_change@test.com',",
            "            subject='Password changed',",
            "            message='<html>\\n  <head></head>\\n  <body>\\n    <p>\\n      <a>Hey admin,</a>\\n    </p>\\n    <p>You recently changed the password associated with your Rdiffweb account.</p>\\n    <p>\\n      If you did not make this change and believe your account has been compromised, please contact your administrator.\\n    </p>\\n  </body>\\n</html>',",
            "        )"
        ],
        "action": [
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0",
            "0",
            "0",
            "0",
            "0",
            "0",
            "2",
            "2",
            "0"
        ],
        "dele_reviseLocation": {
            "67": [
                "NotificationJobTest",
                "test_notification_job"
            ],
            "88": [
                "NotificationJobTest",
                "test_notification_job_undefined_last_backup_date"
            ],
            "138": [
                "NotificationPluginTest",
                "test_email_changed"
            ],
            "170": [
                "NotificationPluginTest",
                "test_password_change_notification"
            ],
            "189": [
                "NotificationPluginTest",
                "test_password_change_with_same_value"
            ]
        },
        "addLocation": []
    }
}